 what's going on youtube this is ipsec we're doing heist from hack the box which was marked as a easy box i think you'd be bumped up to a medium mainly because it either requires a really strong foundation or some legacy knowledge for instance it doesn't really guide you down the path to do a red brute forcing attack to enumerate local users on the box and if you search around for that type of attack and don't know the name of it you can get overshadowed by the heaps of attacks about active directory like just running git ad user bloodhound etc it's really hard to find blog posts on the lesser-known and packet tools like lookupsids.pi so unless you're new to do red brute forcing it's hard to use google to go down that path additionally dumping the memory from firefox isn't that straightforward when you want to use like procdump64.exe and it doesn't exist on the box so you have to know to download a tool upload the tool and then run it a lot of the steps just aren't intuitive to run i think in this box but that being said i really like the box and all the password spraying it's super realistic and a fun box and i think a great one to learn from so let's just jump in as always we begin with and maps or dash sc for default scripts sv enumerate versions oh a output off formats in the nmap directory and call it highest and then the ip address which is 10 10 10 149 can take some time to run so i've already ran it looking at the results we have just three ports open the first one being http on port 80. it's banner tells us it's microsoft iis it's telling us that the is version is 10.0 which is windows 10 or 2016. if you didn't know that you could just go over to google and search iis versions and then go down to the microsoft link and this will tell us that like version 1.0 would be windows nt 351 sp1 or 7.0 is 2008 75 2008 r2 or 8.0 is 2012. it looks like this page hasn't been updated since 2017 so 10.0 isn't here but they skipped nine because i believe like regular expressions because you used to have like windows 98 or 95 so if they did nine there may be just a regular expression that hits 95.98 so they just skip that all together to go to 10. i think that makes sense if not think about it a little more or google why they skipped nine there's a bunch of reasons anyways let's get back to this we have the http cookie flags and php session id is being sent which is a bit unique because this means that the windows web server is running php generally it runs like asp or something um going down a little further we have the http title telling us that login.php was requested so combining this file name with this cookie and it being microsoft kind of says this is most likely a windows server running php unless there's a big deception campaign and one of those things is just a flat out lie generally doesn't happen next thing we have is msrpc running on port 135 then we have microsoft ds question mark because nmap can't 100 verify this is smb running on 445. so i'm guessing like anonymous or null authentication is disabled so it can't really identify this port we have a clock skew of 51 minutes so either my machine or the server is way off in time then this smb2 security mode says message signings enabled but not required and in order to exploit this you need multiple machines because it's something called an ntlm relay where you relay authentication packet since this is hack the box and it's only a single machine we can probably ignore that so let's go over and just check out the website because that has the largest attack surface so going back to firefox and going to 10 10 10 149 we get this login page so i'm just going to try like admin admin and it wants us to enter an email address and we don't even know the host name of this box yet if anonymous authentication was enabled for smb it would probably run some smb scripts to tell us the host name of the box if ssl was then the ssl certificate would tell us the first name but now those are so we don't even know the host name is heist so don't have an email can't really do anything but there is this login as guest button so clicking that brings us to what looks like a help desk page we see the user hazard is saying he's experiencing problems with the cisco router here's part of the configuration the previous admin left us i'm new here and don't know how to fix it so if we look at this configuration we can see it is indeed a cisco config and we have two type seven passwords and type seven or just um think of it like extra encoded maybe that's it maybe it actually is xor but there's a secret key that cisco has that de-obfuscates this and reveals the password because it's not real encryption and well if there is a key uh if you do reversible encryption it will be broken one day so we'll just google cisco type 7 decrypt and see if we find a python file maybe we can do like python github i always hate running like the websites that decrypt it for you because they may configure in a way that you send them the password and i always hate sending websites my password so when possible i run it locally if i can think while typing so we're here we have the script if we do python cisco t7 and then specify i think dash decrypt for this one dash d and then the string so going back here type 7 decrypt this config file that should have worked let's see e or let's see there we go so if you do dash e p it's going to encrypt the password if you just do dash p it'll decrypt and dash d is default so if you do dash d dash p it's still going to do it so we have one password it's super password so i'm going to do them passwords.txt and i'm just going to copy this password so copy this paste it and then let's go and do the other one so going back here go to this attachment next one paste and see 408 408 023 023 that is what i copied it is just a relatively good password i don't even think that's a keyboard walk so random password there then the next one we have is five which is a md5 sum so i'm going to bring this over to the kraken so ssh kraken and then we'll just go into the hashcat directory cd hashes i'm not hashes oh yeah it is hashes ignore me sometimes uh vi we'll call this heist cisco dash md5 paste it and then dot slash cat dash dash example hashes grip for dollar one oh man there's a lot of these let's see okay only one so the reason why i'm doing this is because cisco is a little bit weird i know with like asas and it's a different um md5 crypt so with this it looks like it's fine if we search for uh asa uh cisco grep dash i cisco okay so let's do dash a three so cisco's asa is going to be i believe this is the um password hash and then colon username so it's a little bit unique with asas but for i guess routers it's straight md5 crypt so let's just go back here md5 crypt is 500 so dot slash cat dash m 500 hashes heist cisco md5 and then opt word list rock you so just throw this real quick it shouldn't take too long at all and there we go it's already done and we get the password stealth one agent so we can just exit this exit and then paste this password so we have three passwords we don't have any emails and we don't have any usernames so these passwords don't really do us too good looking at this we have enable secret we get the username of router and potential username of admin that looks like a default one but we'll do users.txt router admin and then if we go back to the recent issues we have a user called hazard so we can use him and he is asking the help desk to create an account for him on the windows server so chances are that is true i can't tell if support admin is the username or admin is the username or admin as a group here so i don't know what this one is but we have a few passwords and a few users so what i generally like doing here is using crack map exec and this will enumerate all the credentials we have so do dash u and then specify either a username or a file in this case we have a few users so i'm specifying a file and then dash p same exact thing for passwords then we do shares because i want the shares module and then 10 10 10 149 and the reason why i specify the shares module is because upon a successful login it's going to tell us or enumerate all the shares we have write access to and if we see write access to either admin vol or cval it's these two then we can follow up with the ps exec because that means we're local admin most likely in this case we don't have that access so we can't gain it generally in windows the way unprivileged user may have lateral movement is through windows remoting like a winrm that's port 5985 5986 it's not on the nmap default 1000 so you miss it if you don't do like dashp dash and nmap but i'm just going to test for it and the way i normally test for it is metasploit so msfdb run and the reason why i like doing it through msfdb other than just jumping straight to like a program like evo dash when rm is because this is more like scriptable and it also has a handy feature called the creds so it'll save things so if we just do use auxiliary scanner winram actually we're doing creds let's do exactly what we did in impact so scanner smb smb login and then we're going to show options and i think i want set dash g because that's global let's do help set g okay we want set g so set g i think maybe set dash g is the same so two ways to do it i'm just gonna do set g use underscore file users.txt and then set g pass file this is going to be passwords.txt and then set g or host 10 10 10 149 i'm going to do run and what the global did is when i switch metasploit scripts it's going to save those variables hopefully so we don't have to retype them all so it's running and failed a lot but we got a success with hazard and stealth one agent just like crack map exec i do creds and now save that in the database for me so i don't have to worry about logging what is successful it saved the host the origin service uh username password everything so it comes in really handy so if now we do use scanner auxiliary scanner winrm and we want winram login we do show options because we use the set g we have users.txt and password.txt already here our host is already set it's using port 5985 and we can just do run and see if we get a shell and we got nothing so at this case we're kind of at a dead end and whenever i get to a dead end i go back into the enumeration phase what can i enumerate more well we got a login to smb there weren't any shares it was just admin ipc and c so um i'm going to go over to impact it so whenever i want to find in packet i do locate bs exact dot pi because i can't remember this path to save my life and we go user share doc python three dash and packet and then examples i do a ls and look at what things are here one of the things we can do is look up sid so if we do python 3 look up sid a valid user so hazard stealth 1 agent at 10 10 10 149 it's going to do something called a rid brute force or a sid brick force and we'll go over this manually right after this finishes but it's going to get us a bunch more usernames so we got hazard support chase and json and i don't know why i said json it jason not json but we got a few more accounts so let's do dash and then after this we'll go over exactly what this just did so if we do vi users so support chase and jason support chase and that was my email my apologies if that sound came through but support chase and json json so let's go over exactly what a uh red brute force is to do that we're going to connect to the rpc port so rpc client dash u hazard percent stealth one agent for some reason it does percent between username password but 10 10 10 149 and i'm just curious if this uses port 139 or smb so that's what i'm doing here just a tcp dump because i'm not positive top my head so we run this and it looks like it's going over smb we search for 139 i guess the very one of the first packets is 139 not even the first so in windows my mind it's always smb when you do these type of things so if you hit tab you get a bunch of um functions you can do the one we want is look up names and i'm just going to specify the default name for anything which is administrator and it's going to give us the sid for that account i think that's called stands for the security identifier essentially i think it's always going to be like s15 s means sid one is um just the version and microsoft never changed the version so it's always s1 i think it's normally gonna be five it may not always be five forget what these two are but how i generally think of it is this is the domain oh wait this is the domain and this is the user so the last one i always think of is the user id and everything before that is just domain to me so it's not technically correct because i think it's only uh this that is unique to the domain but in my mind i only got two so the default user for windows the uh you may hear it called the rid 500 account is administrator administrator is always going to be 500. so if we do look up names guest you'll see that is 501 that's the second account in windows if you do look up sids and see what the third account's going to be so we can just copy the sid and brute force the next one up we gotta put a space after sids we'll see this account is called default account so that's essentially how brute forcing works the very first user is generally 1000 but we have a valid username which is hazard so we can look at what his is his is a thousand eight so we can just go on from there so we do the lookup sids instead of 503 we can do 1008 we get hazard 1009 we get support 1010 unknown 11 12 chase 13 jason 14 15 16 and you can just go on to see how many accounts you can get but that's all this red brute force is so when it says a max number it's asking for what the max number you want to be here is so we've got a few more usernames so what we're going to do is go back into metasploit and we're going to use the smb exec so smb login and then just do run because we updated a user.txt file with the new usernames so we just do this and we'll see if we get anything new it's now doing the hazard user and we get another user chase so what i'm going to do is switch back to winrm and to speed this up i'm just going to create validusers.txt and i'm going to do chase actually we're going to have to do that we can just do show options and then set user name chase and run so we get a valid login with winrm and it's going to go on and do the username file next we can just control c to stop that but we see the winrm told us that chase can log in so we now have a low priv shell so to log into winrm i'm going to just use a program called evilwinrm and the reason why i'm not logging it because i did creds and it's already logged it and we even got the winner m logged it says it's http because it just doesn't know that's when rm but yeah that's how it logs winner m and metasploit so let's do github so github evil dash winrm and we can just copy this cd opt get clone cd evonrm it's a ruby file so ruby evonrm and we can't install something so i'm just going to do bundle install i didn't work let's just cat the gem file and then gem install win rm winram dash fs colorize and string il so we're just going to install all the dependencies this is the same as like pip install for python so we got them all now we can do ruby evowinrm.rb and we can see how to use this so dash u dash p and i p easy enough so ruby or dash i for ip so u it was chase i think dash p uh let's go grab his password so ruby evil winner m you chase p that i'm going to put this in single quotes because we have a backslash and a asterisk so who knows how that's going to get interpreted so doing it in single quotes makes sure it gets interpreted how we want it 10 10 10 149 and let's get a login shell if we're lucky there we go and we see we're in the documents folder we can do gci for get child items it's just powershell way of doing the dir you could also do ls there's a hundred ways to list directories i do gci but i'm going to get out of the documents directory and we'll do gci dash recurse so i go into every directory and then i'm going to do a period and then pipe this and do select full name and that's just going to list all the files so we got links downloads uh nothing really other than user.txt and to do dot text so if i go to desktop we can do i think gc forget content on to do dot text there we go you can also do the shell way of type earthwork stuff to do keep checking the issues list fix the router config there's nothing really here so i'm going to go up to directories do a dir we got other users so hazard has a directory we do hazard do a dir we get a permission denied so nothing really there if we were in like um cobbler or something we could potentially like make a token for this user and try switching to him and then going into that directory but with just this evil winrm i don't think we can do that easily so let's think of another way um there was a web server so let's enumerate the files there so inet pub cdw if you're confused what cobbler is it's just a c2 framework and net i'm sure if you go to ipsec.rocks you can find various things on it so cd dub dub dub root do a dir we get a permission denied so we can't list files in here if we go back to firefox and look at the files issues.php so if we do gc issues.php we can get the file so we can read what this is there's also a login.php and i'm just looking at the source to see if there's anything we missed so we got cookie for admin and guest nothing really there we type login.php let's see we get login usernames admin and hash sha256 request login password is equal to this shot 256 hash so we get a shot 256 hash we go to like hashes.org and search for it to see if it's a known thing we could also send this into hashcat but i don't think i'm going to crack this one so and i just okay it's not case sensitive but hashes.org doesn't know it so i'm just going to move on and the reason why i was trying to get axes in this directory is because maybe there's a config file that has another password or if i can write to a file then i can escalate to this user and potentially do [Music] like rotten potato or something or juicy potato so i want to get to that iis user is what i'm doing here so we echo test to test to see if we can write here we can't um there is also this attachments directory so if i do cd attachments we can do gci here and we see there is config.txt this is that cisco router that we started out at if we type to uh echo test to test we can't write here so this is probably going to be a dead end and we can't write to [Music] like login.php or anything so we don't have any right access in this directory so we can't drop a shell script and then execute it to gain access i also didn't see any vulnerabilities in the php code we looked at so that's a bust if we do gci at the root we could go into like program files and do gci and at this point we realize firefox is installed that's not a normal thing so we could go and check if it's running with git dash process and then look at all the processes on this box a lot of svc hosts holy crap and we see a few firefox processes so the first one is 46.56 so that would be the one i go for but probably want to enumerate all these if we don't see anything so vim uh ffped dot txt paste okay uh that's where i was okay so in order to dump that process we need to use um assist internal tool called proctum and you could do it with powershell you could do it a hundred ways a bunch of ways to dump processes on windows i like doing sys internals because it's a microsoft sign binary which means it generally works and doesn't serve as many flags so zip so we go here and download the suite its license prohibits redistribution it wants you to download from microsoft's website so i don't think it's bundled in cali or anything uh we can exit metasplay at this point uh guys we should have probably used metasploit to get a winram shell potentially i wonder if it has that option i've never really done it um we can move downloads uh what is it what it download as says internal suite here maker sysinternals and then unzip the suite and we got everything so at this point we can upload it so let's go to users we are chase we'll go in documents and we can upload root hdb boxes heist sysinternals and proc dump 64.exe and this will take a little bit to upload and once it's uploaded we can dump the process there we go so dot slash procdump64.exe it wants us to accept the eula we can do it through the command line be aware that this creates a registry entry on the box so if they've never used says internals before there's a forensic artifact there and if you're curious always monitor your boxes for that registry entry to see when people using cis internals we want to do the dash m a flag to write a full dump file so we'll do dot slash proc procddump64.exe dash ma and cat ffpid we'll do 4656 first and notice we didn't have to do the except yola flag if we do proc dump 64.exe h it works because that registry entry set but if we do dir we see it created that file firefox whatever dot dump and we can just download this so download paste it'll probably take even longer to download because the dump file is much bigger than proc dump 64. so i'm just going to pause the video while this downloads so this has been going on quite some time probably almost 10 minutes and it's still not done so i'm just going to see if the information i seek is here so it's saving to opt evil when rm do a ls we can see that dumb file is there and the reason why i knew that is because we cd to that directory before running this program we can see the dumps 054901.dmp going here and same thing so what i'm going to do is just string the firefox binary and we're not binary but um process and just dump its memory if we grep for like http oh we get a lot so that is a lot so maybe grep for password and we get still quite a bit so let's do less and go down where it is so i just type slash password did i type that there we go so now it's going to highlight and right at the very top we can see log in username admin at support.htb and login is equal to this so we could test this off real quick by going to 10 10 10 49 see my session is dead so admin at what is it support.htb and then paste the password and we get logged in as that user there's no additional features but we got the username of admin we already had that saved in user.txt but we don't have the default account which is administrator that's the red 500 account so we can go back do we still have metasploit open we closed it when we did ps exec so what we'll do is crack map exec because it's just going to be quicker so crack map exec dash u users p passwords dash dash shares 10 10 10 149 and we'll see if we get any valid logins and it's not looking like it let's see did i paste that password correctly i think i did so oh crack map exact by default stops after the very first login i forget the flag let's just do msfdb run and we'll do the winrm module so winrm set user file users.txt if i just do pass file or host i'm just hitting ctrl r and it has recursive history so run we'll see if we get any new hits i don't think it's doing the new password uh v passwords.txt it was not i think i just entered it and used it.text that would definitely help so we do this and we get a login success as administrator so what we can do is a winrm as him but we could probably do a um ps exec if he has access over cball or um admin ball so craft map exec do this now that we have the um password and password.text and logged in it's telling us pwned let's see if it gets the shares and only says pound when you have a shell and we have read write to admin and see so we should be able to do ps exec u administrator and then ten tent or i think it's just ps exact that's not my path let's go locate ps exact dot pi cd here and then python 3 ps exec administrator at 10 10 10 149 and then paste this password requesting share found writable uploading opening creating and we should get the shell very soon there we go if we go cd backslash users administrator dire a little slow probably should have done the powershell module but cd desktop dir root.text it's 32 bytes so there you have it um pretty sure we can read this i'll actually test it to make sure there's no like um encrypted file system with cypher we do a type there we go does read it so that's the flag hope you guys enjoyed the box take care and i will see you all next week