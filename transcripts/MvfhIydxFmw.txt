 what's going on youtube this is episode be going over power scene which is a script i had written on a twitch stream not too long ago essentially it's just a way to tell windows event log specifically sysmon and it prints out the information that elastic or splunk would be able to search upon and i really like doing this for analyzing malware because number one it gives me all the information in real time and number two it removes the dependency of having elastic splunk or something to search the event log because if you've ever used event viewer it is god awful at just doing manual analysis so um with that being said let's just jump in so if you go to my github repo and go to powerseam you can download this powershell script which i had created live on twitch you can click here if you want to watch me create it but essentially it's going to tail the event log and give you nice formatted output of everything and generally i use this i run malware and i use this output to create iocs and i know a lot of the fields it may like you may want to combine them but i kind of avoid that so for example right here we could combine current directory and command line to just have like the full list however this isn't how splunk or elastic or any log aggregator you get would handle it so i do have them split up exactly as the log does so when i create an ioc based off of the script it is compatible with any seam but we're not going to get into seams in this video maybe in a future video but this is the type of output we'll be getting from programs but before we can get this output we have to install sysmon i'm sure if you go to my channel there's a video on it but i'm gonna do it because it's so super simple just google like sysmod microsoft download sysmon open the zip go into your windows folder specifically system32 although it doesn't matter um but system 32 is the best location for it because if you put it in sequel and windows maybe you can do some type of dll hijacking or some type of attack against it but now that we have sysmon downloaded we have to get a config file and my favorite one lately has been off of floyd roth's github page you just go to his repositories type sysmon whoops type sysmod here go to sysmon config and we can save this page so let's download this and just like before we want to copy it into sql and windows system 32 so if i do users downloads copy this into this folder we can install it by going to command running it as administrator and if you don't know what i just did right there i held ctrl and shift to run as administrator you could also right click and do it but i'm a huge fan of keyboard shortcuts so now that i'm in this folder or in this window we can just type sysmon64.exe dash i for install specify the config and then dash accept yola so we don't have a little prompt telling us we need to accept the eula and there we have sysmont is installed so now we just have to monitor it and we'll get into that yola because i can do something interesting here real quick so let's go into power seam now that sysmont is installed we can close all these windows and we have power seams so before we explain it let's just run it and show it i'm going to press f5 i'm going to open up a command prompt type cmd and we see a process created here command prompt by me a bunch of information about it we could do who am i and within a second we get that information about it but let's go open up a new window and we see i did a bunch of dns queries a registry was created process created so much has happened here but i'm going to google ps exec we're going to download ps exec from microsoft and you're going to see everything in the background that's happening on my computer adfs streams were created because i downloaded things from the internet if you don't know it creates this alternate data stream when you download from the internet so other applications know this program came from the internet uh where is ps exec ps service probably easy if i type there we go so all i'm going to do is we're going to copy this okay i bet that out.exe is something malicious so now we have it created i'm gonna stop this and then we're going to go to the registry create because oh we can explain exactly how this is working this is a good time too so this script was inspired by a course i took a few years ago when i took it it was silent break security but they got acquired by netspy it's their ds ops one course i want to say ds stands for darkstar but i kind of rewrote what i remembered from it on stream so start things off we grab this purse event and this is just a powershell snippet to convert an event log into something that is easier to work with from a programming language because the event log i don't know if you've ever looked at a windows event log but if we go to the sysmon one microsoft windows sysmon like this thing not easy to search and when you get here there's so many fields like you got these down here this message here like it's not the easiest to work with we can see this dns entry um my computer query wpad which is the windows proxy so edge was like asking the network hey are there any proxy servers probably should disable that but this is just a vm so um this just lets us parse the event then we have write alert and if you wanted to like combine all this stuff to be on one line or change the output this is where you do it in that right alert field um log name this is going to be microsoft windows sysmon and it should go where the provider is so if i wanted to be a better coder i would do that there's no reason that was there twice other than just me creating this as i talked but we create the index and the index is just the record id of the latest entry because that's what max one is like this get when event is getting the very last event log in sysmon and then recording the record id then we go into a loop and one second later it checks the new end it checks the index again calling it new index and if here if it was like event id or record id 600 and here is that 600 it would do nothing because there's been no new events but if index is 600 and new index is 605 it's going to grab the last five events because that's what it's doing right here so for every event sysmon has ids so id 1 is process create id 2 file creation time change id 3 network connection id 5 process ended 6 driver loaded and we could add more stuff in here i just haven't done it by the time creating this video one day i will six driver loaded seven dll loaded by process eight remote thread created nine raw disk access 10 inter process access 11 file created 12 13 and 14 is registry and i want to set break point here so i'm going to go to this line and press f9 uh we can do it on set as well and i'll do it on renamed i don't think renames gonna hit but now we'll actually hit these event breakpoints we have adfs this is the alternate data streams we talked about sysmon configuration change pipe created pipe connected and a lot of c2s do use pipes a lot we'll explain that a little bit later uh 19 to 21 wmi 22 dns so if you want to put more information here like the process and where it was talking to you'd press f9 wait for a dns query and do what we're about to do uh 23 file deleted 24 clipboard event monitor 25 process tamper and 26 file delete logged i don't know off the top my head the difference between 26 and 23. i want to say 23 uses a lot more like disk space than 26 but uh don't quote me on that go read the sysmont log so right now we have event breakpoint set at the registry so i'm going to run this and we see it created a file because i saved before i ran but let's go to ps tools i'm going to take ps exec we're going to copy it over into downloads and then we can see it created adfs records for that um we could have set a breakpoint there to see it but let's not do it in a system prompt let's go to our users cd downloads i'm going to let the logs kind of chill once i change directories okay i'm going to run ps exec so we should see a process create there it is and then when i click this agree we're going to see it break because yep there we go hit breakpoint on this agree so where registry set if i do evt we can see or let's do select star we can see everything we could get from this so we probably want target object and we can see it's creating h key current user hkey user the sid of my user software assist internal ps exec euler accepted so we could just put this so let's see i'm going to copy this line over here just so i don't have to do as much typing uh let's i guess stop and registry set cannot edit scripts while debug is running to edit script stop the debugger debugger stop okay there we go and now we just go up here and we want to take where was it uh stop scrolling target object copy put this here and now we added the target object into this log so the next time a yola is added it will tell us we probably also want the image and the pid so we have the image here there we go and then i guess i can call this image instead of process um let's see image this is internal id i guess i'm gonna do pid there we go so i'm going to disable the breakpoints hit f9 on these outputs we're going to run this script again saving it and now i'm going to run a different cis internal tool let's just copy ps file we can save that into downloads and i do ps file64.exe accept it and we get the process create process there we go registry set so pid11048 created this registry key so that is how you'd go and edit this if you want to see the registry keys we can go to reg edit um current user microsoft win software it was then microsoft says internals where is that explorer creation time changed oh is it software assist internals right here and we can see there's yellow acceptance here so if you are ever on a computer and want to know if cis internal tools were ever ran on the system this is a good spot to check so um the next thing i want to do i'm going to enable my av which is going to be scary on this vm because this is my like development vm and um av may start deleting things but we have it on and i just want it to show something so let's set my password for this user because i don't exactly remember it so net user user uh password1 exclamation point we should do this from an elevated prompt net user user password1 okay so i just set this password we can see all the logs of me doing it on this left and the ip is 58.16 so i'm going to run the assistant on the impacted version of ps exec user at 192.168.58.16. password1 and we don't get it because av stopped it and i just wanted to highlight one small thing so av is stopping this version of ps exec but i'm going to go over here drag a window from my host computer you can see my users now ipsec i'm going to do ps exec the microsoft version so backslash 192.168.58.16 uh we need probably dash u user cmd uh not login let's change this to a interactive login and we see i am now on the system with ps exact so a lot of threat actors won't use the impact one they'll switch to the windows one because um microsoft doesn't flag it as a virus and how it works under the hood is very different so we can see it's doing process create these inner process accesses um registry set because ps exec copies a file and then creates a service through i want to say dcom or maybe wmi creates a service and then uses this service remotely to start that executable so we can see the here file create ps exec or ps exe svc here we're creating the service and then my vm froze that was weird okay it's back and then doing inner process access with this to get data i'm guessing um let's switch over to the other version so i'm going to exit this and we should see the process terminated and here regis reset we're probably deleting the key but let's disable av and see how impact it works so let's do ps exec again password one exclamation point and i'm just going to type who am i go back here and we have let's see instead of all this in a process we have a bunch of pipes so process create registry file create so this is probably the start of it so we got this file create random eight characters.exe creating the service a bit different i am z y i think it's always imcy or maybe it's a different random four character uh probably different random four character and then it does this process create and then the weird pipe create command and the pipe it uses is rem com communication and i mean the regular ps exec wasn't using pipe so this is another thing and just rem com itself is a ps exact thing so a bunch of pipe stuff the parent command line is also going to be cmd the other difference if you noticed when i did the ps exec on windows it didn't auto elevate me the system it kept my normal user if i added the dash s flag it could have put me a system but one of the other quirks differences of the two ps execs so while they may look the same give you the same access under the hood those two ps execs operate completely differently and that's what i wanted to show so let's go to the next piece so let's go back over to parrot and i'm going to open cobalt strike so let's create a beacon in the stupidest way possible i'm just going to do web drive by scripted file we'll call this something let's see listener it's going to be https launch and this is all with like a default profile so you can customize cobalt strike to do a bunch of things differently but this is just going to be stock i'm going to do it on my elevated prompt we ran it we should see a bunch of things so here's the process create the powershell uh created a powershell script powershell.exe and we also have this network connection um 80 this is when it downloaded and 443 is my beacon doing um the um callbacks combo strike defaults to 30 seconds let's change this really quickly to two seconds and then every time this calls back and i just missed it we will see a new network connection event so this can become very noisy because we did it every two seconds and i want to see something if i go interactive does it just spam request or does it do an http long pull a pull or a long poll i think it's a long poll not poll but uh the long poll uh it creates the http request and the server doesn't close it until it has data for the client so that's the difference between the two so i just told it to become interactive and is it going to um who am i a shell what is it it's say get uid or get privs okay yeah now it's completely interactive let's see if it's just spamming me process create yeah it's just spamming away at network connection so it's not doing long polling it's just going to completely spam um let's change that to two and we'll still probably see it's spam that's why you should never do like super low things and the other benefit to the script is we know network connection um there's nothing really here we can flag so let's go up here event id what was network connection three i'm just going to comment out this write alert start the script again and now we no longer see those events so if i ran shell who am i we can see exactly how cobalt strike does this um let's see so this is me saving so here we have process create who am i just from sql and windows system32cmd.exe c who am i now this one is suspicious because if i just did a command prompt and did who am i it's not going to do that slash c so you could code the um application if you're doing c2 development to look more like this one like they launch cmd and then type something but um the slash c flag is definitely an indicator that's coming from a program and not a human not indication that there's a compromise just one of those good things to know right when you start looking at logs let's do something a bit more interesting we can do log on passwords the good old mimikats thing right so the other thing we do when we do mimikats let's see um we create gp update this was talking about a sacrificial process so this is creating a thing here we go here's the process create so gp update it's creating the sacrificial process and then setting the standard um [Music] out to be this pipe by default it's post x for post exploitation i would guess so it's creating this pipe sending gp updates standard out to be that and it does i think this inner process is it doing a virtual alec to allocate the mimikat's executable inside the gp update process we can see right here the call trace the unknown it doing that right there seeing unknown in call trace isn't immediately suspicious a lot of programs especially like obfuscators or virtualization technologies would do it i think even warbird which i think is microsoft's activation checks does it so you see this on normal system so it's not something you should be like i'm going to check all my systems for unknown and call trace oh my god we're compromised no not like that at all but it is useful for like building timelines when you suspect malicious things so um if i suspected that something was happening i would definitely look for unknowns in the call trace because it could be it doing this thing where it's hollowing out the process putting many cats there to execute and doing through a pipe um it could also be like freshly calls assist whisper to do direct sys calls um a lot of bad things will also put unknown in your call trace so that is something to keep a look on but we see it doing the pipe and then our cobalt strike process connects the pipe so we can get the output gp update this is i believe um mimikatz being called let's see is this unknown 1bd it is a different address oh no this is um mimikatz itself so whoops where am i no there we go so gp update this is mimikatz um it is actually um granting itself access to elsas with 1010 so it's giving itself the ability to observe elsa's memory if you go into my mimikatz video if you just go to like ipsec.rocks and type mimikatz i believe um i go into exactly like what that 1010 is um advanced windows log in this is a good video for that but um i think this is going to conclude the video i wanted to keep it somewhat short and just show off this tool and how you can create iocs maybe in the future we will um expand upon this and um actually make it go to splunk or something so we can create a legitimate ioc and i think when i did that pwd command it didn't create a single flag that was just checking um i haven't got the data back either oh no i did current directory so let's do it again let's do it like a few times because this ah i don't know if that else is this let's see let's do it again real quick but not all commands will get logged so in a second i don't see it going here so when someone used cobalt strike in this profile if they did the pwt command we now know that we're blind to it it wouldn't go to a logs because the way it's doing just isn't logged and that makes sense because you don't want to log everything because if you logged everything everything would be finding a needle in a haystack you want to shrink that haystack as much as you can so hope you guys enjoyed the video let me know what you want in the comments down below take care and i will see you all next time