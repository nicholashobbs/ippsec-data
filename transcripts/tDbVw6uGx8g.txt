 what's going on youtube this is ipsec i'm doing nest from hack the box and i really like this box because it shows the value of enumeration throughout this whole video i don't think we throw a single exploit we may decompile a binary to pull out a secret from it but we're not actually using any exploits which is pretty cool you'll find out that 445 is open and then you pretty much start what feels like an endless loop of enumerating the file share finding some type of secret or good information then going back to the enumeration phase and what you find isn't always a password for instance one of the parts you find a notepad plus plus config file that shows the history of all the files open that contains a hidden folder that if you try to access that folder you can but if you didn't know the exact folder path there's no way for you to get to it so the whole box is a lot of fun and the final step involves you decompiling a net binary to decrypt a config file so just a bunch of just good enumeration with all that being said let's just jump in as always we're going to start off the nmap however we have to put a pseudo on this mad map and i'm not exactly sure why but if we don't if we just try nmap101010178 it's going to tell us the host is offline however if we try it with last week's box which is also a windows box both this one and last week is windows it will actually do the nmap scan if we do a pseudo i'm just going to add a v so we can see the open port as it finds it we can see it indeed works so not exactly sure why that's going on actually wait one second nope don't know why i was thinking maybe like 80 or 443 was open because if you look at nmap's host discovery and i got firefox stuff up from the last video i guess but if we do nmap host discovery we can look at what order it does and it was right there on google it's going to send an icmp echo request a tcp syn packet on 443 and the tcp ack packet on port 80. so all three of those didn't respond here but they did respond here i'm guessing maybe it's a firewall rule let's check wireshark out real quick so let's go on time zero and we can do nmap 10 10 10 178 see what's happening here um i know the font is small is this easy to change appearance uh font and colors here we go let's go to 14 that should be fine enough so we can see since four packets we don't get anything back because the source is all 10 10 14 2 and the destination's all that so we can see there's the ack packet on 80. uh send packet i think on 443 but doesn't get anything if we also doesn't send the icmp so i wonder if it needs root privilege to do icmp but let's do it on 10 10 10 169 and i'm just going oh wow that went instantly but going up here it was the first four packets so it looks like it does two so it tries 80 twice and 443 twice probably for some type of retry but we go here 10 10 14 2 10 10 10 169 and we get a reset so this is telling us hey the port is not open so i'm guessing on this box the firewall is configured to drop unknown packets so it doesn't respond with anything on the last week's box it was configured to reject unknown uh packets which meant it sent this reset flag so that's probably the difference i'm going to clear this real quick and let's do sudo on this i can kill it because it found it but i just want to see yes it does when doing sudo um it sends a icmp so i'm guessing maybe nmap is doing like a raw packet to do this it's not actually using like the ping binary it's just doing some type of raw packet send to craft this icmp packet have to kind of look in the source to see exactly why that is but i guess if you're not a root user and you want to end map something your best result is probably going to be using pseudo so we can finally begin with doing a good old sudo nmap sc for default scripts sv enumerate versions oh a output all formats put in the nmap directory and call it nest and then the ip address which is 10 10 10 178 can take some time so i've already ran it looking at the results we have just one port open and that is 445 which is smb we can see some scripts run nothing really too interesting clock skewed 90 seconds uh message signings enabled but not required and we get the date so nothing too interesting there but i am going to run a pseudo and map dash p dash to do all ports dash o a would do nmap nest dash all ports 10 10 10 178 and let that one run while we go poke smb so the very first thing i generally always do is run crack map exec against it so crack map exec smb 10 10 10 178 and that's just because i like the output that crack map exec gives without any information without like use names and whatnot so it's telling us the hostname is hdb-nest domain name is http.nest doesn't mean this is a domain join box if this domain name was different than the name that would probably mean it's domain joined but the default domain on a box is either work group or just its own host name signing is false and smb version one is false um we can try like dash dash pass paul to see if we can pull the password policy without specifying anything but i don't think we can other things we can do is like smb client to list the shares so smb client dash l that's a capital l on 10 10 10 178 and i'll just hit enter for a password and we get all the shares on the server admin c are default along with this ipc so the unique ones are data secure and users and i always like using multiple tools to see what the difference is so we're going to do the trifecta here and switch it up to smb map and dash capital h for hostname and 101010178 we see we don't get any response but we got a response here it's a little bit odd let's just try specifying a use name username that doesn't exist and let's see what happens working on it and we get some results so i'm guessing if you don't specify a username it's doing something weird and if you do it just works crack map exact didn't have anything for the password policy but this also does have a dash dash shares module so if we run that we see it failed enumerating so let's try the same exact thing that we did with smb map we can do dash u and just put a user that doesn't exist let this run and we don't get anything i think with crack map exec you need to have a password as well so let's try that and it works so i think this is just doing anonymous authentication if you don't specify it it tries a null authentication and then null is blocked but anonymous i think may be open maybe i'm wrong i don't know exactly why this behavior is but hey it's windows and sometimes weird things happen uh both smb map and crack map exec tell us we have read privileges over the data and users share so we can do um smb client and then the ip address and the share i probably did resolute ip there it was 178 not 68 and we can list everything here i don't like using smb client that much i'd rather just mount it to my host os so i can um use a bunch of bash commands like find and things just makes it more familiar so i'm going to look at my mount we have a data and user folder created so i'm going to do sudo mount dash t cifs and um if you didn't have those you can just do make the mount user and you'll need to do sudo um those directories are empty if we just do find slash mnt you can see everything's empty so sudo mount dash t cifs and then 10 10 10 178 users and mount users and it says we need the um helper program so we don't have cifs utils installed here so i'm going to do sudo apt install cifs this is cifs i forget what it stands for but it's how i mount smb remotely on linux so i'm going to install cifs-utils and once this is installed we'll rerun the command and mount that share just hit enter and it's mounted and we can also do mount data to mount the data so now if i go into slash mount we have data and all the things here and what we can do is a find command and i like doing dash last to see all the permissions of things and dash type f because i just want to show files and we can see all the files in this we do have two things shared maintenance maintenance alerts.txt and i don't think that type f worked actually weird it is windows so weird things happen um oh it's already got a backslash to escape the space so i don't want to put it in quotes and we cap this and we see there is currently no scheduled maintenance work so this file doesn't really have anything let's go take a look at the shared templates hr welcome email.txt copy this and we can cat i need to put a period first and it looks like we have a username as temp user and the password as welcome 2019 so let us go look at the user directory and we can see there is a temp user here there's also a few users c smith l frost or thompson so what i want to do is try all these so let's go and create users.lst and put that's the password c smith l dot frost r dot thompson and temp user and now we're going to do crack map exec smb 10 10 10 178 um dash u users.list dash p welcome 2019. we're going to see if any of these users have that password and l frost does crack map exec h i want to look at um not stopping right away set timeout oh come on let's see crack map exec don't stop on success maybe we'll get lucky flag to continue on success let's see just merge with 248 come on add dash dash continue on success let's try this success success so we got three users with this password l frost r thompson and temp user so what i'm going to do is make dirt mount l dot frost we need to do sudo r.thomson and temp user i'm also going to do c dot smith because eventually we may want to go into his directory we just don't have his credentials yet so now we can go and mount this so sudo mount dash t cifs dash o this can be extended options username equals l.frost password equals welcome 2019 and then we can do 10 10 10 178 users slash mount l dot frost so cd mount l frost find dot to see what's in here uh mission 9 to read l frost's directory so it's weird but i guess it's fine i'm just looking at this we can see it's mounted username is l frost so okay let's try this pseudomount and it was r dot thompson i think next equals r dot thompson and i'm going to put the wrong password here i want to make sure it oops it fails mount uh thompson huh so it'll mount with invalid username but weird let's unmount this real quick and instead of doing what we are let's do smb map dash u r dot and one of these are invalid usernames like these aren't local users on the box but that's by what's happening um let's go where am i take a step back um users.list please subscribe you really exist i don't know what's going on let's try this crack map exec smb 10 10 10 178 dash u users.list p welcome 2019 continue on success i'm sure there's a shorthand for that flag so something weird is going on here uh pseudo and that works as well okay well that is annoying but i guess we can keep trying so let's do that dash oh so sm uh mount uh yeah mount dash t cifs o username equals temp user password equals welcome 2019 so we're just using exactly what it says instead of doing a password spray because i'm guessing those users don't exist on the system and that's why it's working but we'll find out once we root this box and look 10 10 10 178 slash was it users and mount temp user mount dash t cifs sudo cd mount temp user now let's try going into his directory and this one works we have new text document that is empty so let's try um i guess smb map dash u temp user it's not cate sensitive but i guess ocd welcome 2019 10 10 10 178 and we can get out of that window what else does this user have access to so we now have access to the secure so sudo mount mount secure sudo maker sudo mount dash t cifs dash o username equals temp user password equals welcome 2019 10 10 10 178 secure with a dollar mount secure let's go into this directory and just do find dot to see what's here and it looks like we have permission denied going in everything so we have the data mounted and let's see what we have what i'm going to do is find dot and then direct it to hdb nest and we'll call this um dir data anon dot text and then we're going to remount this directory as the other user and do the same exact thing to see if there's any new files so let's do sudo umount data and we can change this path to be data and now we have mounted the data drive as our user i'm going to do find i'm going to pipe it over to oh we'll do ls t what was it htb nest and we'll call this dir temp user data or is it dir data temp user and t is just going to write it to a text file as it outputs it but i'm guessing it's going to do it after this find command finishes but right away we get a lot more files so it looks like this user has read access to the it directory so i was going to compare the two files side by side to see any new files but this time it's pretty obvious we go into the it so let's go into it and i guess um i'm just going to find dot and we'll start looking at files so let's see adobe we less this file oh let's see this is utf-16 what if we can cat icon oh shoot is it dash t ascii dash f utf 16 l e let's see icons from utf-16 le to ascii so windows formats everything utf-16 so dash f dash t so i probably had these backwards yep so utf-16le utf-16le well i thought this would work doesn't look like it from d maybe utf-8 there we go so now we can read the file so windows does everything in 16 little endian and linux likes utf-8 if we xxd the file it may make more sense so you can see it's using two bytes for every character and we only want to do one so if we go back up to do this icon xxd you can see it gets rid of that so dash f is from ts2 for some reason before i was thinking dash t as target probably because i was like in metasploit a few days ago and that's what t meant but yeah t is two and f is from so keep that in mind when every cat files that was a lot of work and we didn't really get anything out of that so i'm going to copy this icon command we can cat configs adobe stirrer and pipe it there and wonder what this does okay we can view everything and doesn't look like anything really is interesting in this adobe directory so let's try configs notepad plus plus so configs notepad plus plus does not like that icon command that's just cat star and there we go so this one's not in utf-16 little endian it's annoying how to deal with this but it is what it is um looking at this we can see one of the notepad plus plus files has a history and we can see this secure so httpsecureitcarltemp.txt so it looks like maybe the user c smith was editing this file let's do that find command again i'm guessing that was maybe the shortcuts or a config probably config yeah the history so notepad plus plus was used to open a few files so let's take a look at this it file so itcarltempt.txt so let's do cd mount secure and remember this one had these three files so cat i t carl temp.text and new follow directory so if we do lsit curl we do get a directory listing here but if we do lsit we do not so we have permission to the call directory but we don't have permission to list the contents of it so we can go cdit carl find dot to list files docs ip mmc and we get a bunch of i guess source code so let's look at ip.text nothing there mmc.text and just different mmc snap-ins but there is that vb project directory so let's do uh cp vb projects to hdb nest and i'm just going to do smb because i think is there any yeah that's fine uh we probably need dash r and dasher is going to do recursive as folders and based upon that name and looking at all the files in this find command one thing is sticking out we did have a ru thing this ru scanner or uconfig.xml that was after notepad plus plus and you can see ru scanner is the source code of something so let's look at this file before we go digging through that source so cat this uh oh it's not escape so let's put it in quotes because the path has a space so cat this and we get the username c smith some base64 and i'm guessing this is probably going to be encrypted so if we probably put this config into our use scanner it'll probably output the decrypted contents so what i'm going to do is copy this file so cp and we'll do heb nest smb and just copy it right there so let's go cd hdb nest go into smb and i'm going to start up an smb server so in packet smb server dash smb to support dash user uh we'll do ipsec and dash password please subscribe this will be called i guess we'll just call the file share nest and the path to the shared nest is going to be our current working directory uh permission denied let's just do sudo double exclamation point which is going to run the last command and now we have our server up the only thing we have to do is find out our ip address so if config e0 and our ip is 209 so i'm going to go over to command l and do 172 16 10 209 and we called the share nest is it going to mount okay password our username was ipsec password is please subscribe type or something p-l-e-n please subscribe type in something please i can p-l-e-a-s-e s-u-b-s-r-i-b-e there we go so if we look in production this folder is empty but if we look in wip that's where this file is so i'm going to copy it here and i'm also going to copy this ru config in this directory and i'm going to open with visual studio 2019 once this loads we can take a look at the source code to figure out how we want to uh decrypt this or if it even has a decryption method but most likely it does i know it does because i've done this box before so let's go and look at this so we got a few things this config file you can see a few things doesn't really do much we got saved to file load from file um module one this one main is so i'm going to stick a break point right here so when we run this we can break here and see where all these variables are look at sso integration we have nothing look at utils and we have like decrypt string encrypt string encrypt what not so go back to module one it's going to load the config file are you underscore config.xml which we have here and then it's going to load everything and decrypt the password for us so i'm going to click start and it's going to run and we crashed oh cannot find file it's looking for ru config and bin debug so let's copy this into bin debug start it back up and now we have it broken right here and if we step once we'll get it because right now we have the test variable but it hasn't been assigned because we're on this line so i'm going to step into uh step over maybe no which is oh i stepped into it and it went to this decrypt string so get out of this or on this return you can see the decrypted output is this so let's go back here um finger bin debug edit we'll just paste it so if you did the step over right away it would be down at the bottom but we got it step into means you're gonna go into the next function step over means you step over that function you return after it essentially um let me copy that file out of the config and then i will show you what i mean so you're in smb cd or cp let's do whip are you are you scanner bin debug what i guess we can i think it's going to air if i leave that there so let's return the config to normal start it again so last time i did step into and it went into the decryption routine i'm going to step over it and now it's at end sub so we stepped into and it stepped into this we can look at the password and it is right here oh no test which is an object click the down arrow and we can see the password right there so again let's start this again step into and we'll look at what function we're returning it'll be decrypt string so step into yes you can see we stepped into decrypt string and you just step over each thing else now it's running this decrypt command and that's where we were last time so let's go back here can i create a text file i don't think i can yeah i can't edit paste and let's see i have it here that's funny when i tried creating it said it couldn't create it and then created it anyways something weird is happening with this impact but i have the password here let's try it with c smith since that was the username so crack map exec smb 10 10 10 178 dash u c smith dash p that password we do have it coming back but it doesn't say pwned so um we are not admin yet so let's do credentials dot text c dot smith paste this and the last one was temp user and welcome 2019 i think it's taking a while to save the text file oh something's going on in my box but seems fine right this second so how was i doing this mount it's probably all these smb mounts i have going on that's slowing me down let's stop the impact server i wonder if my vpn went down mount let's just unmount everything so for i in find slash mount do sudo umount dash f hi so this should go through that mountain directory and unmount everything but man is that going slow ping 10 10 10 178 i was going through all files i should have done like a um max depth option but it didn't mount everything pseudo view mount mount hello.frost and that may be it okay now everything's unmounted and everything's going a little bit smoother so the next thing we wanted to do was mount something with c smith so sudo mount dash t cifs o username equals c dot smith password equals that 10 10 10 178 slash users and then we wanted uh mount c dot smith so let's go into his directory lsla go into c smith and we can see user.txt and a folder hqk reporting so we can go here lsla and we have a config backup.xml so let's copy this see what it is port 4386 and it's going in sequel and program files hqk all queries so we got this weird port if we go back to our nmap less less and map nest all ports that port is open so when we mapped everything we did find that one port so nc 10 10 14 10 10 10 168 178 sorry about that uh 4386 we get hqk reporting service and let's do ncat oh not found sudo apt install ncat i just want to try the difference to see if ncat behaves differently than nc i know um nc doesn't send a the same like line break as ncat and telnet do so let's replace that with ncat and do help we get nothing we do telnet help and we get something so let's see exactly what went on here because that's unique so pseudo wireshark and do ton xero i'm going to type help enter and we can follow tcp stream we'll send it and let's do hex dump we can see help 0d 0a so let's quit out of this quit and do nc real quick type help enter and let's look at what this sends so it sends h e l p 0 d 0 a going to wireshark uh do we have a tcp stream 1 to go to the next one so zero this was tonet one's probably netcat i just checked two and three to make sure they didn't exist so since we only have two tcp streams i'm pretty confident that this is netcats so let's do the follow stream again and we can do hex dump and we just sent 0a we did not send 0d so if we man ascii and we look at what zero d is that is the backslash r and zero a is going to be newline so tonet sends backslash r backslash n on enter and it looks like um netcat only sends backslash n or maybe i had it reversed but that is the difference and that is why i always like using multiple tools when i play around with things because everything has very slight different behaviors and that small slight difference um can make all the difference so 178 and was it 4386 so we can look we can do list and um set dir let's go upper directory list so list looks like it is going to be an ls command set der sets the directory so if we set it for like c colon backslash first set der c colon backslash list we can then do that so let's try setter users list set der administrator can access so this application is not running as administrator it's probably running as service hqk and also looking in the users directory uh we only see temp user we don't see like c smith we don't see all those other users so those may not exist for the options list set der dot dot list set der service hqk this just looks like to be the services user so what other things can we do run query invalid database debug and it wants a password so we don't really have much more we can do here it looks like so let's keep poking around the um user so was it mount c smith i think that's where we were let's go in his directory back in this hqk reporting we have this debug mode passwords.txt but its file size is zero so if we cut this i forgot the beginning single quote it's nothing if we look at this directory we can see there is a exe file in this 80 integration modules thing so let's go and grab this so we can cp this to hdb nest smb and then i want to look at this debug mode password thing some more and the downside to doing mounting like i am we don't have permission to see like ntfs extended attributes and things because we're on linux we're not on ntfs we don't have that ability the easiest way to do this would just be go on windows mounted and do like a dir a but we're going to do this from linux with smb client dash u uh see smith 10 10 10 178 users and we got to get his password we saved her already and credentials uh smb was it credentials.txt put this on my clipboard go into uh c smith hqk reporting and we can look at extended attributes in smb client with the all info command so debug mode password dot txt and this shows a hidden alternate data stream ads stream as password so we can just do get and then specify debug mode password dot txt and then colon password [Music] debug mode password.txt dir get and you do this in single quotes it's not liking something opening local file where am i oh i am in the mount and touch test i don't have permission to write here so let's do hdb uh nest that's what it was copy paste i've probably done lcd to change the local uh directory c smith cd cd hqk reporting get debug mode password dot txt password there we go we have downloaded it so if i cat debug mode password password we have this so now what we can do would be um was it tonet debug this and says use help to view additional commands and now we have the service command and the session command and also the show query command so if we do cd dot dot uh set dir dot dot to go up one directory list and do show query i think if i specify three does it do three there's the third item and we can get a config file and we see debug password set here is that the config file show query one what's this do over the size limit no so query three it looks like it just kicks me out so let's go again uh list set dir let's go up one again list and we can go into the ldap directory i believe set dir held app or set dir held app list and we can get this ldap.com so show query2 we must be in debug mode so let's go up and grab the debug password copy debug show query2 and we can copy this config and when i did this the original time i had right away opened up this exe file in a decompiler and did that however i didn't want to jump back and forth between my cali and windows 50 times doing this video so that's why it may seem like i'm taking a leap and finding this information right away it's just i want to save some time [Music] so again if we go back like last time we can see this is encrypted so echo dash n base64-d gets junk so let's go over to commando and i think if we refresh this hopefully it refreshes and it pulls new files close this oh uh we didn't start impacting it back up so cd smb we're there and packet start the server i know you can access it now don't lie to me it was nest right pseudo nest it's listening there we go so if we do copy this exe to a desktop and copy ldap.conf because we will need that and open this up in a tool called dnspy this is a good.net decompiler and if you search ipsec.rocks we've used this tool once before and probably use it to more extent in the other video so i definitely recommend that i just went to file open we open up the ldap and we can poke around it so we got main module ldap search and ldap if you want to you can click up here file export to project so we can export this to like ldap select folder export it and then if we went to the ldap folder we could open this up in visual studio and we can also edit it straight in this tool so let's go and look at it so looking at cr dot cs looks like we have something returning encrypted so this looks like the encryption module just based upon that ldap.css looks like this can query ldap to return usernames for something search settings setting the domain the port username whatnot main module and we can see void main so this is where it starts it's going to try if command line or accounts is not equal to 1 say invalid number of arguments then it's going to look for the very first argument command line rx0 this is going to be the config file because if we don't do it it says please specify config file that's also looking for this hq kdb import.exe if that doesn't exist it's saying please ensure the optional database module is installed and then it begins reading the text file and then right here it looks like it is going to decrypt the password so i want to set a breakpoint right here and let's delete a bunch of lines so we can delete this whole if then block and then we want to say command line args this is going to be was it ldap.com was that the file name yes it was so let's try starting this and see what happens uh we got build errors bunch of errors so maybe it didn't like how we exported this so what i'm going to do close out of here and we'll try editing it in dnspy now that we have an idea of what exactly goes on so i'm going to right click and do edit class and we will just try printing the password so we have console.writeline here we can do dot right line uh the password is and then console.write line ldap dot pass the reason why i added the password is is just so when we run this if we don't see this print statement we know we're not running the edited version um if this is a blank variable then it wouldn't write a line and we may not know if this is the right thing so hit compile uh 73 use of unassigned local variable enumerator let's just try deleting hey it compiled so let's see is there a save we do file save all so before we do save all let's try running it and then we'll do save all so cmd uh cd desktop see can i make this font bigger quickly properties font size 24. there we go so let's do hqkldap odap.com uh please ensure the database module is installed ah that wanted something what is that file main module this so echo i'm just creating that file so now if i do a dir that file does exist so we run this command again and we see it's performing ldap query it did not say the password is so now let's do file save all we probably just do file save module okay run it again and voila we have the password is and it outputs it so let's go back into our file share and we can edit credentials to be well we don't know this administrator yet but chances are this is the admin password so we can put that there and i say chances are it's admin password because we don't have any other users left really so cat credentials so let's do crack map exec smb 10 10 10 178 dash u administrator dash p the password and see what happens we see pound so we can try ps exact dot pi administrator at 10 10 10 178 paste the password in and now we have a shell on the box as nd authority systems so we can go into users administrator desktop and get root.text the one question i had earlier what user installed in the box and we only have administrator c smith and service hqk so that will be why um that user share if we do ls mount user or let's just do csmith which is mounted a user and we have all these directories why if we try any of these passwords it authenticates us but they don't have any other privilege because they're not an actual user as to why crack map exec reports successful logon if you give it any invalid username i actually have no idea but yup that is the box hope you guys enjoyed it take care and we'll see you all next week