 what's going on YouTube this is ipsec and this video is going to be setting up the latest version of elastic which is eight on an Ubuntu box now I know you can just use like detection Labs or there's even Cloud appliances to spin up elastic but I really don't like those just TurnKey Solutions because you don't understand how everything works and a lot of them have just insecure defaults so when you just do every step manually you understand how it works and you go oh maybe we should enable SSL or um and not expose elastic to everything and set up log stash or things like that so definitely like setting things up from the ground up and elastic we're going to do a few components elastic if you don't know is the database Cabana is going to be the web interface to the database and then we're going to do three different Integrations Fleet Management this is going to be able to manage all the agents the agents we install on our windows boxes and that configures things like having the windows boxes Send logs to the elastic database and the Fleet Management just automates that process so if you make a change it automatically pushes the configuration to all your agents so you don't have to keep pushing updates one at a time so it's super nice the second thing is going to be the endpoint security this is just going to have a bunch of just detections like ransomware just when bad things happen it just goes to a certain spot in elastic for you to look at so it's really handy and then the last piece we're going to do is just collect Windows logging so like Powershell command sysmon things those all go in and we can search around we're not going to spend a lot of time um playing with iocs and stuff it's pretty much going to be a video setting it up so let's just jump in so the first step is to get into whatever box we want to install it on I have just a vanilla install of a minimized edition of Ubuntu 222 like it doesn't even have the paint command things like that so the first step is to install elastic so I'm going to Google um install elastic stack Ubuntu and surprisingly enough I like the digital ocean guide more than the elastic guide because it's like one page I wanted to like Jump Around the downside is they are installing elastic seven and I want to install eight because I just want the latest and greatest so um it's easy enough to modify uh the first step is adding the gpg key to a box so we just run this one command and we don't have to modify it or anything this next command we're gonna have to modify because it's running the 7.x and we just want to change that to an eight so let's just change this to 8.x and then this other one 8.x as well and now when we do a pseudo apt update we should see us talking to elastic and it shouldn't error out so that looks good uh we just want now to do a elastic install and during the install it's actually going to give us a piece of information that is critical and that is the first user if we didn't get it um it will be in the user share elastic bin directory there's like an elastic Dash password Dash reset so you could always reset the password if um you lost it and have root access to the host so I wonder if I can show you while that installs so sh elastico one user share elasticsearch bin and we have a few of these um there should be a reset right here so you would just run this and specify the elastic user so um I think this one elastic search users you could actually create a new user but I digress so let's go look up and it's going to give us a few key pieces of information so the first one is going to be the password that it created so let's just put this in notes.elastic.txt paste this and then we can cut it so the built-in user password is this when we install a cabana we're going to need to create this enrollment token and here it's telling us we can reset the password if we wanted to with this but let's just move on with the instructions so right here they're telling us to change the network.host to be localhost so if I did a sudo V Etsy elastic elastic what's the gml file um elasticsearch.yaml it's telling us to change this to be localhost and that would mean elasticsearch binds on 127.001 Port 9200 the default is right there now that is good information because you never want to allow elasticsearch to be accessible to unauthorized users however we're going to install Fleet and stuff on separate boxes so we have to have elasticsearch listening on a routable interface so I'm going to ignore that change and the reason why I like installing Fleet and things on separate boxes is Fleet is a service and elastic that keeps your agents up to date and that's what you install on all your windows boxes to configure their log forwarding back to you so you want to be able to manage those from elastic because you don't have to log into every box to do like minor changes so we don't want all those boxes to have a connection all the way back to elasticsearch box because that means if they get compromised then a whole elastic database is at threat and workstations move around if they have laptops they may go into a Starbucks or they may get lost right so we want to install Fleet on a box isolated so if that gets compromised all that the workstation can talk to is Fleet there's no way it can talk to the database there's less information it can get so um elasticsearch is installed I believe we have localhost and the next steps it has us do is enable and um start elasticsearch so we do pseudo system CTL start elasticsearch it may take like 30 to 45 seconds to start up it is I believe a Java application so they always take a while to stir it I'm just going to open up a second session so we can also while that goes do a pseudo system CTL enable elasticsearch and this is just going to make it stirred up on boot and then once this is there it's going to have us do a curl and this is going to fail because the default for elasticsearch 8 at least is SSL so we do this curl and we just see we get empty reply from server we can do this Dash V and we see nothing however let me just go to root so we can look at this log VAR log elasticsearch elasticsearch.log we can see it's complaining that someone connected to Port 9200 um via HTTP not https so let's go back to our curl um girl Dash X get HTTP localhost 9200 so empty reply let's add a dash K to ignore certificates change that to https and now it's complaining that we're missing authentication so let's go back to our notes to copy this password and then change or curl to be the elastic user that's the default first user put the password then an at and now we can see the health is let's see I guess it doesn't say green or up but because we got this Json everything is good so our elastic database is up so now we can go move on to installing Cabana Cabana is going to be the user interface to elastic we could do everything that we can view in Cabana via just curl commands but that's just like specifying a manual API and it's a pain in the butt so we want to have a nice pretty web interface to interact with elastic and pull data out of it so that is going to be Cabana so we just do this install and after Cabana installs we're going to have to configure it so I keep exiting this terminal pane I probably shouldn't keep doing that because now we want to go into the user share elasticsearch bin and the one command it gave us this elasticsearch create enrollment token we're going to need it for kibana so let's run this uh permission denied we'll do oh we got a root session right here we can create the enrollment token and before we start kibana we have to give it this enrollment token and what this is doing is just configuring the authentication between kibana and elasticsearch so let's do sudo user share Cabana bin then Cabana Dash setup and it should ask us for the enrollment token once the jvm starts up we paste it in and it's going to configure it and tell us we can run it now I don't want to run it just like Ben Cabana I'm just going to run it from systemctl so systemctl start Cabana and then we're going to enable it and this takes a while to run it defaults to Port 5601 and we can see it's not listening yet um let's see watch Dash N1 give it a few seconds we'll give it 10 seconds to see if it starts up if not I'll do a status on it and see what the holdup is there we have it running and it binds to a local host now generally people recommend putting engine X in front of kibana I think this started from like the days when like Cabana didn't used to have any authentication now it does uh but also I don't think it has like built-in SSL and things like that it's always best to put web services behind a proper web server like Apache or nginx so I'm installing nginx right now with the sudo apt install engine X and we're just going to do a proxy pass I'm not going to bother giving it an SSL certificate I trust that you can do that I would highly recommend putting everything behind SSL because SSL all the things but for the sake of this video to keep it brief we won't bother with that and we just go into the SSL configuration and do proxy pass HTTP 127001 Port 5601 and end that with the semicolon so what that is doing is going to say we edited the default so anything that hits engine X on Port 80 is going to get past a localhost 5601 that's all we did so systemctl restart nginx and let's enable it as well so now if I go to 10 to 50 0 10 which is the IP of elastic o1 we have an interface so we can log in with elastic and then the password is going to be elastics password so we go back to copy this one and then we can paste in the password may take a second to load and then when it loads it's going to tell us what or it's going to ask us what Integrations we want to install so let's add Integrations and the first one I always install is going to be Fleet because this is what manages all of our agents so I'm going to add a fleet server and we're just going to call this Fleet server one that's fine I'm going to leave all these defaults you could change these if you want you'll see where like agent policy one things are referenced in this video but let's just save and continue it does take a little bit of time for this to um install and we do have a second box so I'm going to now SSH to fleet01 and this is a completely different box this IP address ends n.20 where the other one ended in dot 10. now I need to copy a SSL certificate over to the fleet box but I'll do that when it asks um let's add elastic agent to our host and now it wants us to add a fleet server so Fleet server host I'm just going to do https fleet01 Port 8220 and you should use a proper DNS name um we don't have DNS in my lab so we're not going to do it because we don't every host we're going to have to um spec actually we can do an IP address let's just do 10 250 0 20. that way we want to bother editing the host file on a Windows box later okay so we can generate the policy and then the next step will be installing Fleet on a centralized toast Fleet server policy created and we want to run these commands and because we're using self-signed certificates we want to copy a certificate out of this so all of elastic certificates are in user share elasticsearch and then oh no Etsy elasticsearch then certs so these are where all of elastic certificates are stored you should replace these with the certificates of like let's encrypt or something like that I trust you can Google like elasticsearch let's encrypt certificate but I'm not going to do that so I'm going to copy the ca over to this fleet01 box so maker Dash p user local Etsy SSL search elastic uh we have to do that with sudo and the reason why I'm putting in use a local Etsy is because slash Etsy apt my package manager modifies files there I don't want it ever removing the certificate uh so I'm putting in use a local which is generally how Linux things works anyways the name of the certificate I want is httpca.cert so let's download this so sudo curl 10 to 50 0 10 4 8 000 httpca Dash o this and I'll call it the same thing okay so now we can install the fleet server so I'm going to copy this command paste it in and then I'm going to specify oh shoot or maybe we won't go to install um I was trying to add two flags to this so I'm hoping it still lets me yep it does so what we want to add is Fleet server esca for elasticsearch CA user local Etsy SL certs elastic HTTP cert and then I add the dash dash insecure because I'm doing self-signed certificates and this will install so all we did there because that probably got confusing um I have a file t on my home drive all we did was add two more lines so we did complete server esca is equal to user local Etsy SL so it's elastic httpca.cert I want to say that was and then insecure so all we did was add those two flags um elastic agent has been successfully installed so now if I scroll down we see Fleet server has been connected so if I click continue to enrolling agents it's going to ask us if we want to create an agent policy we do and let's see default namespace collect logs I think we just leave everything default right yeah so let's great policy and let's see this is not the most like pretty interface when I'm zoomed in uh policy has been created with this name that's fine I guess so here's what I wanted the um elastic agent stuff so let's see I'm gonna go over to a Windows box and we want to install this so I'm going to open up Powershell and when I do Powershell I'm doing Ctrl shift enter to go into an administrative session um there we go and then let's just paste edit paste paste did not work let's copy this again copy go back to remote desktop paste there we go and then it shouldn't send the very last line we'll want to look at this uh what expand archive did not like that command let's see the IR expand it looks like it added a period for some reason so let's just run that destination path period then we can CD into it and we'll want to run the very bottom command so CD elastic agent and what was the command oh just install oh crap we're on Standalone we do not want that let's see because if we're Standalone then it doesn't manage it for us I'm going to create agent policy 2 for this great policy I'm guessing I clicked something when I shouldn't have because I was talking there we go so now we go to Windows it's the same exact commands except this install now has a URL and an enrollment token so this is the one we definitely want I am glad I caught that so CLS we'll paste this in and then I'm also going to add dash dash insecure because it is self-signed certificates so now it's saying it's going to be installed we say yes that is fine and it should say elastic agent has been successfully installed so now when we go back here we see it is installed and it's not getting data yet but it may take a few seconds so I'm just going to close this out and let us look at this so if we go to security um let's see back to Integrations nope that's not what I want there are so many options in elastic let's see I don't think it's security dashboards security manage I guess we can manage the rules um first let us add another integration so one of the main ones the main reason people install elastic is for the endpoint and Cloud security which just creates a bunch of alerts the actual agent will monitor for security events so we're going to add this and then the integration name let's see existing policy we'll do agent policy two and the integration name I'm just going to call this endpoint security and then save and continue actually before I save nope we don't see it yet so let's just add this and we can see agent policy 2 has one agent enrolled with that already so this may take a few minutes and what it's also going to do let's see if we can see it in real time because we applied it to the policy that's on this computer it's automatically going to install the elastic agent here there we go we just saw endpoint pop up because it's installing the elastic endpoint agent that is what Fleet does it's like a C2 of goodness right C2 being like command and control server but this is installing all the agents we want to make keeping them configured so we don't have to go be like oh um we want to install win log beats now to get event log so we go to every single box and install win log beats and then make a small configuration change then go to Every box and do that no we don't have to do that because Fleet manages that for us right so we have endpoint Security in and we see my host and it's healthy so that's looking good now with endpoint security we do have to create rules um so let's go to security manage go to rules and it's going to tell us something bad it's going to say your encryption key is not created for the API and that's going to prevent us from downloading all of the rules from elastic so let's go and add our API key so I'm going to go back to my elastic search box and go to user share Cabana bin and then we're going to do Cabana encryption keys and this is going to generate them we have to tell it to generate and we have our encryption keys right here so I'm going to copy this V Etsy Cabana cabana.yaml go to the bottom and paste those lines in and then we do a system CTL restart Cabana and the next time we hit this page um this warning won't be there and we're going to have something to import rules I believe right now it just says manage rules if we click that well Cabana is down so won't do anything there we gotta wait for Port 5601 to open back up uh right now it's just saying bad gateway because nginx is configured to go to it and 5601 wasn't there so nginx just complained um oh I'm hoping that's just because Cabana is just now starting refresh loading elastic there we go so let's log in and we need the password again so go back to our notes copy paste login and then we'll go back to the security rules page so click here for the menu security manage rules and now we have a bunch of new buttons I'm going to load the elastic pre-built rules timelines whatever and it's going to give us a bunch of rules come on it's now downloading it's taking its time but it is worth it come on load the rules and here we go we have a bunch of things so we got like elastic end game rules PS exec um if I just click select all and I'm going to let's see I clicked select all and then click bulk action next to it and enable so now every single rule is going to be enabled some of them require machine learning so those won't be enabled but um most things will and this so whenever we use PS exec now alerts gonna be popped in a dashboard to say hey PS exec was used right um if we didn't want that we could just disable it um some of these rules require Integrations to be installed and we don't have those so they won't be working you may want to like search for Windows and then enable rules this way so you only enable the windows rules but I didn't know if I'd hit PS exec doing this so that's why I did all the rules um so that should be good let us now add another integration so let's do management Integrations and now we want to add login so I'm going to search all my Integrations for Windows going to collect logs uh 47 rules fail to enable that is fine I don't care about that let's enable this oh wait what ingredient I click on sometimes I shouldn't talk and do things at the same time yeah windows so this is by default going to collect things like sysmon logs Powershell logs things like that every log that we want on a Windows box um it's going to grab them so yep that's good uh the agent policy we're going to do existing specify agent policy 2. and then save and continue save and deploy change and it's going to take a second but if we go back to our elastic thing it's probably going to install something else and we should be able to get to all of our logs from this so I just want to check my elastic agent log to see if it's complaining about anything go to the latest one here and we'll just open it with Notepad come on it's definitely thinking just want to open you try this again there we go open with it's taking a sweet time again I guess maybe only gave this computer one CPU and while it's installing new rules it just goes incredibly slow um so let's see do we have any errors here generally the first time you install something I like just looking at the logs to make sure nothing's yelling at me silently and this looks fine I don't see anything sticking out uh SSL verification disabled that's fine we're doing a self-signed certificates not even using host names so I think we are good let's look at what our elastic agent emo looks like so this is going to be the config for the elastic agent Fleet enable true and that looks I guess good I was expecting to see something else there like I don't know where the output is configured in this look at this yaml file see how this is okay so this is Fleet how it's accessing where it talks to then I think we're going to have an issue in this one so let's go to the log of this guy so the elastic endpoint log is this it so let's go to the bottom let's see is it airing at all uh error certificate problem so right here we do have an SSL Error so I think something is broken in this which is a little bit of a pain to fix we could verif kind of verify that if we go to discover and then look at this let's see if I create data View I only have one index pattern so yeah right now it doesn't look like we're getting any log data when we go here and just look at our logs we should be seeing results we're not and what I think happened is if we go to this elastic endpoint config we see up here for a fleet we told it SSL don't verify down here the output is elasticsearch this is a big No-No I believe um maybe in a future video I'll move this over to use log stash because we don't want to agent talking directly to elasticsearch I'm not exactly sure what this API key gets you but if it lets you query the data in elasticsearch that'd be really bad because if anyone compromises the host that has this log installed then not they can talk back to elasticsearch additionally then maybe we'll get data out of it and like if you can ever access a company's logging data chances are you can turn the whole Enterprise the most common one is someone typing a password in the username field and they could just query show me all the user failures on this network find the ones that don't look like usernames find valid passwords and prone it that way right so this should be log stash which is just a forwarder so a log would write to log stash and then log stash would write to elastic so a host would never be able to ask it for data because log stash is just a forwarder right um so be wary right now of How It's configured here so let us go back into this and what we want to do is go to let's see I think Fleet then settings the output we want to edit this and oh we can't shoot we can't because this thing is locked it says this output is managed outside of Fleet and that is a cabana setting I believe so let's do V Etsy Cabana Cabana Dot yaml and right here we want to change is there a true yeah is default I'm going to change this to false and this next one is default monitoring to false and then we can restart kibana we're gonna have to log in again but when we come back to this page we won't see this lock here which means we'll be able to edit this default output and add a SSL verification mode To None I believe um and then then once we do that we'll start seeing data so I'm going to pause the video for like 30 seconds because it's going to take a second for elastics to start back up well maybe I won't maybe it's up right now Cabana server is not ready I bet if I refresh it again it will be and I don't get the break I wanted but that's okay let's just copy this password refresh come on elastic oh sweet I didn't even have to log in again um we don't see the lock key on this output so I can edit this and let's see we want to edit the host so https uh 10 250 0 10 is my elastic I'm sure we could configure logs Dash here if we had that set up but I do not so it's SSO dot verification mode is it moods or mood let's sell verification mode elastic Cabana let's see what that is uh I think it's mood verification mode and we want to set it to none think like this save and apply settings we'll update three agent policies and two agents yes we want it to do that so now if I go back to this host and we look at elastic endpoint let's see if it's already done it how fast is this uh hasn't done it yet let's see 855 maybe my time update in the background yeah so now we have verification mode none and I think if we go now to the logs or start seeing things so let's go back to analytics discover and look at all that data we are getting so now our agents are able to talk to us if we click create data view we can see all the indexes so an index is going to be like a table um there's going to be an index for a sysmon and that's the one I'm going to look at so cismon operational default I'm going to put that here and I'm just going to call this um cessman and we'll save it so now I can click here click sysmon and see the sysmon logs so I'm going to refresh the page because it's been a couple hours I had to leave mid recording so we're going to update the data we see here and we're going to do some light poking around this video isn't going to be one on exactly how to use elastic um I'm actually haven't used this version before I just started today actually before recording so um I do want to poke out a bit more before I go too in depth but let's say we want to look at some specific sysmon event IDs right so if I just Google sysmon event ID we'll probably pull something up right so um we can see a list of all of them here and let's look at I guess let's try to vet ID one process creation real quick so in this if I click search Fields I'm going to type ID and we're going to look for event ID let's see maybe if I do event ID here we go and if I add this I can see all the sysmon event IDs that it's recorded and I'm just going to click plus and we can see them here so in my filter I'm going to do event ID is equal to 1. and it added that win log dot for me so now we have our table only showing us event id1 I'm just going to um click on one of these if I click on this little toggle it's going to show me everything in this log entry right and the main thing I want to look at is the process that gets created it looks like there's four rows on this and message is going to show me the whole table so this is going to be everything we want um let's see we probably want to get original file name command line so let's see um can I just add it here original file name if I click Plus did that add it maybe I click I think it added it I just think I can't see it so I think I got original file name let's do a hostname like this and current directory we can add process working directory and see what this looks like right so now we can see everything here we can get rid of event id1 because we know what it is we can move host over to the left because that makes more sense and we can see it's starting up Ms Edge task Notepad and the working directory and if we wanted to like filter everything we could uh let's see click here filter out this working directory and now we see everything that wasn't in that working directory so we can just play around with all the processes poking around looking for Badness right um let's see I think DNS is a fun one to look at so let's see let's look at DNS I'm guessing that's event ID 22. so let's go back here event ID 22 and we don't have anything so I'm going to go back to my Windows host let's open up Edge and do some DNS request so let's go to ipsec.rocks and we have my website so you can just do searches for any videos here if we want to look at more assist money things we can do this power steam is a good video for learning system on Advanced Windows logging this is like the updated version of that this one goes into Helk which was a modified old version of elastic by cyber war dog but now I would honestly use elastic eight because it has the security agent the fleet it's just so much better and I don't know if elk has been updated to do the latest so now that we did that let's refresh and we still don't have any event ID 22s that is concerning I wonder if um it's just not being logged let's see let's open up our logging Event Viewer and let's go to Windows no application then Microsoft whatever this is such a horrible GUI that's so slow come on just pull up the log um let's do something suspicious iax new object net.web client download string ipsec dot rocks we'll just do this right it's gonna error out but maybe we'll see that we still see event log is thinking demo Gods right refresh let's see let's not do last 15 minutes 15 days hey we have some DNS requests um right now our table is filtered with like the old thing we're looking at so let's clear this and then we can go and look at a message to see exactly what this one looks like so I like just clicking here finding where the message is and then just viewing this you could look through every field but I generally find this easy so query name hey hipsec.rocks I'm guessing my time is incorrect on my box so it was like last 15 minutes and I'm guessing one of the time stamps is wrong so no matter what the event was it was going over 15 minutes ago because um that box has never been to ipsec.rocks that was the first time and there's the Powershell that we're doing with so let's look at um user image so let's add user ID or name still username it's probably win log user name also let's see will do query maybe it's question name maybe that's how they filtered it then what is it process name so now if we look at this we can see administrator queried ipsec.rocks this one from Edge this one from Powershell so this definitely seems suspicious right and we're just looking at all the DNS requests so I find this pretty cool um we got wpad here so it's looking for the proxy This Is Us installing the agent us going out to artifacts.security of dialastic so a lot of good information here um and if you don't want to go hunting because we added all those events before if we go to the security then we go to alerts and we can see what type of alerts there are um I enabled RDP we have some startup things this is probably installing the agent so we could expand this and see exactly what this is um Edge did something on the current version run I don't know what that is um you find this stuff a lot like you find a lot of weird things that just happen um Edge did something else to that current version run that got triggered as an alert but um like you'll see like notepad talk to lsas and you may think that's weird but it may just be querying um like for printers and things like that so this is RDP enabled via the registry so um we can like acknowledge these I believe whereas acknowledge uh manage rules it's one of these analyze event more actions investigate I've never really used this piece of it this piece is new um shoot let's go back there one of the other cool things if you like pretty pictures is if we click analyze this event um it draws a graph for us so we can see like all the MS Edge processes how long they were in things this one I don't know exactly what it's doing let's do something on this box real quick so we're here let's go to Defender let's disable it and see if this creates an event so let's do virus and threat manage settings disable real-time protection everything else is pretty much disabled so let's see if elastic now complains that [Music] um real-time detection is disabled so let's go back to security alerts oh come on maybe like click here my brow VM is going slow doesn't want to click alerts security alerts go here okay we're back at that page awesome and it's had enough time where it definitely should pick up on us disabling AV see today two minutes ago this week I'm guessing it has not picked it up yet that's weird updated eight seconds ago ah if we click the three dots we can Mark as acknowledged and that hides it refresh this I'm only assuming it will pick up when we disable real-time detection but maybe it does not safe findings we don't have if we look at dashboards we haven't created any dashboards yet that'll probably be for a future video but I think I am running near the end of this video um there's nothing else I really want to show hope you guys enjoyed it set up elastic on your own and there will be future videos um if you subscribe to my channel as a monetary subscription I'm going to create a post and you can tell me which type of video you want to see next if we want to go like run Havoc or Havoc I forget how to pronounce that and like build threat detections for it see what's detected or we can go um secure elastic bit more with win log beats um it's really up to you guys what you want me to show off so hope you guys enjoy the video take care and I will see you all next time