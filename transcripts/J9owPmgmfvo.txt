 what's going on youtube this is ipsec and this video is going to be showing you how to set up sysmon to block unwanted files from being created on your computer you can block them based upon file names so if it's like a pdf.exe you can block specific directories you can even block specific programs from having the ability to create files on your computer it's a really powerful thing and cis mod i guess is turning into an edr i guess technically but the major downside is without elastic or splunk a lot of these alerts are really hard to act upon because you just don't know about them so this video is going to show you how to set up schedule tasks with event filters so you can get alerts and slack when files get blocked by sysmon and the major benefit to this outside of the file getting blocked is you now have cis mod on your system and i think that's one of the biggest mistakes i see a lot of companies make is without centralized logging they don't install sysmon because they don't see value in it but if there ever is an incident i want that local system to have cis mon because it's going to help me in analyzing exactly what happened so much so hopefully you guys enjoy this video let's jump in before we start playing with task scheduler we have to actually install sysmon and configure it to block some things so i'm just going to go to mic source page download sysmon and then i'm going to copy it into system32 so we can copy and then go to system 32 and just paste it and then the next thing is we have to get a rule file and i always like going to floyd roth's um page for this go to assist my export block which has a bunch of rules to block files and we can download it and save this so let's do file new paste this in save and i'm going to go see colon windows system 32 and we'll do sysmon config block dot xml and if you want to look at this rule it's super easy to understand you just look at the image block section and we can see we're blocking um writing to these directories looks like um music pictures videos and contacts maybe we want to remove these because we don't want to block people from writing into pictures a lot of screenshots go there often um so if we wanted to we could remove that rule i'll leave it in we can see we're also blocking extensions like pdf.exe doc.exe uh blocking known bad files that um hide sysmon and then file hashes of a bunch of programs like mimikatz petite protem rogue potato this is blocking it looks like office programs from dropping executables so stopping like fishing attachments things like that so there's a lot of really good rules here and if you just deployed this on your network without doing any type of notification system you'll probably get a lot of angry users because chances are there's going to be some of these rules that you wanted to remove like maybe writing into pictures for instance and maybe i have misinterpreting that but i don't think so so now that we have that saved we just open up a command prompt and then go into windows system32 and we can say sysmond i and then the sysmon config block and it says mon64 so now we accept the license and sysmon has been installed so if i go to event viewer we can see sysmon probably saying a lot of things and it's in windows logs application and services and then i think microsoft after this then sysmon microsoft windows cessman and here is the log so we can see the process create rule and things like that um so what we want to do is test this block out so i'm going to go powershell and i believe i have a web server up so i'm going to go curl 192 168 58 230 i think it's just a box on my network that has something running so we'll do ipsec.pdf.exe and try to write it to c colon users administrator downloads ipsec pdf.exe so we're trying to write this file if i do a dir in my downloads folder we see it doesn't exist and we didn't get any type of error message and if i refresh we see it's been blocked so now what we want to do is get alerted anytime this is triggered and if you've watched my canary token video on um the task scheduling piece this should be relatively easy so we're going to create a new task and we're going to call it file block and i'm going to change the user to system and just run with highest privilege and i'm going to create a new trigger and we'll do on an event custom new event filter and every time you click these things it takes a few seconds it's really annoying how slow this is i'm not sure why it is that way and then before i go to xml i like always selecting the log i want to do because how log paths are determined is a bit weird so it's just easier to do it this way let the gui do as much work as it can you also don't make typos when you just click things which is always a plus so we have sysmon operational checked and then if i click xml here we can see what it does so i'm going to edit query manually and we're going to change this and i'm going to put what is it star then i think data event id is equal to 27 and the reason why i choose 27 is that is this event id so we're going to save this and then under actions whenever i test something i always just do command prompt and send a message so c colon windows system32 cmd.exe and then we'll do slash c message administrator that's the user i'm on and it's gonna say woot so i should have done please subscribe but oh well um so we have that event i'm going to run this curl command again and if we did it correctly it would say something but it did not so i'm guessing we did not do it correctly so let's go back to our custom event filter edit event filter and now let's look at the event and go over to details xml view and oh event id is under system and i put it um i guess under data which it's not at all so let's do system event id 27 so this one will get triggered i know i probably should not have said that because i jinxed myself of course i did has not been ran so let's check this out again go back to the triggers and it's going to be something silly if we edit event filter and wait for this to load and it wouldn't be so painful if that was actually a quick process so star system event id i wonder if this is case sensitive let's try this okay run it and there we go so it was case sensitive that is one of the more silly things and this next piece i think is an undocumented thing of these tasks because if you look at the properties there's no good way to get arguments and how i figured out to do this is um exporting the actual event i don't know what just happened i clicked export and my task says what the computer is not on my side today so right click export and we're going to go to desktop i'm going to call it file block and i'm going to delete this because we've exported it and we actually have to edit this file manually to add some secret sauce in it so edit with notepad plus plus and right after where subscription ends we're adding a new field called value queries and we can do a slash value queries as well to add that field and then we're going to do value name is equal to and then what the variable we want is so i'm going to go back to my event log and we probably want to get um probably the username so user is going to be the first one so value name user and then event event data slash data that's just going to get us into the data portion of the event log and then we do at name is equal to user as well and then we kill this value like that and we're going to do that for all the fields we want so let's go back here we wanted the user we want image and target file name probably so image image and then target file name and i'm just going to check my casing on that real quick images capital t and f are capital so i think that is all we do here we could make this pretty by tabbing this but that's not needed and then we can go back to task scheduler and import this task and import file block and if you look at everything in here the value queries isn't going to show up anywhere it's just one of those hidden things it's super bizarre but now we can specify variables and it's dollar then parentheses so we have user um tried to save target file name on what was the last variable we had uh let's check this out image target file name so it's not on it's from and this was image so let's save this okay and now we'll rerun our thing and we see administrator tried to save ipsec pdf exe from this so now we have a complete event hook where we actually get variables so here we can actually start importing this into our slack cook so it goes to the channel and you can do this with like canary tokens you can do it with everything you want um slack has the benefit of when it's created you can then reply to it and everyone can see it in real time so that's why we're going to put it into slack but i am going to cheat a little bit here and use the pre-built web hook from my slack video so we're going to pass in a few variables we're going to pass in username i'm just going to call it u for short and that's just gonna be args i wanna say zero maybe it's one um we'll find out and then after username we have the file name so i'll just do args one and then the last one is image so args2 so username we can replace this with u and then backtick n we have file name and that's going to be fn backtick n and uh process is going to be i like that and i think that all works fine see i'm trying to think there's anything i'm missing here um rest method oh automated alert we want this to be um file save blocked there we go and now i'm going to go over to cyber chef cyber chef actually before we do that we can test this out so before creating it on the event i'm going to do file save as and we'll just test this webhook is there on all files or is all there we go send message.ps1 okay and if i go into my home documents send message ps1 and we're gonna say ipsec please subscribe okay and we have a new web hook and let's see hostname username file name and process so everything looks great here so next step is cyber chef because we want to incur this in base64 just so we don't have to worry about escaping any quotes and things like that so um [Music] powershell always does utf-16 little endian when it does base64 so first we want to encode the text there and then just say to base64 where is that this is going slow for me okay and then we can copy this whole thing in and we have our base 64 here so as long as this isn't too long like we don't hit any like size requirement in this one field i think everything's going to go perfectly right so it's a joke if you've watched my videos you know nothing ever works the first time so c call in windows i think powershell is in system32 then like windows powershell v1 powershell.exe and i think no profile and enc and oh this is going to be tough actually because we're exiting the program and the arguments since we're base64 encoding it won't work but i have a crazy idea that may actually work so we have to replace how we handle these arguments because we just don't have access to arg zero one and two so let's do param if i can type and then parameter mandatory and then the first one is going to be a string and we'll call this please sub and we're only going to pass one string in because we don't want to terminate based upon space because there's a lot of paths that have spaces in them specifically program files so i'm just going to pass one long string and we're gonna split that upon a character um i'm gonna say it'll be split upon the at sign because i don't think that's used all that much so we say these three variables is equal to please sub and then dash split at and we'll see if this works so we have to copy this and i'm going to go back to cyber chef paste it in and i think i'm on like a trojanized version of cyber chef it's supposed to be gchq so i wonder if that's why this is going so slow but we have this long base64 string so now what i want to do is say slash c and we're going to put the parameters so we did user then what was the second parameter of file name so this would be target file name and then the final one is going to be image and we want to echo this and then we pipe it over to powershell no profile encoded command so maybe this is going to work probably not the first time let's change this over to bcmd and we're going to do a crazy argument so okay okay and then we can go back to the curl and well we got a message but there's nothing in it so something did not work here let's see so cmd let's copy this i should disable the line wrapping here see we echo user at target file name that looks good i wonder if the no profile is removing [Music] our environment so let's try removing the nop for no profile and just passing straight in enc for encoded command and then run this again and still nothing so it's not the no profile what else could it be we should try just running this on command prompt to see if it has any errors so cmd slash c uh we have two slash c's there we go and we have a few the term user is undefined um let's just do get rid of the special characters there we go and passing this in we can see it's not getting anything so it's within our powershell code so param i'm gonna try two things first i'm going to remove the spaces there i don't think that's it but i'm also going to put the variable please sub in the message first and then i want to copy this and let's rebase 64 and code it copy and i'm going to paste it here and i guess we can just try it straight with the event and hope the best click ok do the curl hopefully we get a message wait a second it worked but that shouldn't have worked with the please subscribe at first i am so baffled right now um i have no idea why the first please subscribe did not come through so this is the command we're running user at yep that's good let's go to the real cyber chef see where is it i guess i should use google for this because here's the real link i think it's because i'm on bing that that other link is going first but we want to go from base64 and then decode and we want to decode utf-16 little endian and this is what i had before okay i'm getting even more confused so let's copy this i'm going to close that out completely actions edit copy okay now we just go back to cyber chef and let's get rid of the non-base64 so yeah this is what our string is so i guess i screwed up on a clipboard when i was doing the full please sub because like the message am i just blind no message doesn't have that so let's copy this again just to make sure when you guys do it you have good code so here's this we're going to paste this in and now we want to uh sorry about that that was my phone encode encode text utf-16 little endian and then base64 encode it okay actions edit powershell we have no profile as well okay okay it's saved run it and watch it not have any arguments nope it works so i'm guessing when it came with no arguments uh the task did not fully save yet but now we can see whenever something gets blocked we get alerted in slack so the last piece of this video is going to be doing pretty much the same exact thing but deploying it through group policy so it goes on to all of your computers and this is going to be a pretty annoying task because we got to do pretty much everything over again i'm going to copy this and there's probably a way to export and then import this event inside of a group policy object i'm not exactly sure how to do that so i normally just recreate the event inside of group policy but i definitely want to make sure i copy everything important out of this so let's go into notepad plus plus paste this whoops i meant to delete that line there we go so open up gpmc and then i'm going to let's see let's create a new gpo and i call this schedule task i guess and then edit and we go to user preferences control panel settings schedule tasks new and we're going to do a scheduled task at least windows 7. if you do the other one you don't have all these advanced options so let's change the user group to system and then run the highest privilege whether the user is logged in or not the name this is going to be notify upon blocked processes okay the triggers new on an event and custom event filter come on it's not the quickest thing i feel like the group policy one goes even slower come on okay and we can go to xml edit manually paste that in and we need an action go to new and we want to start a program cmd.exe and we want to run this whole thing apply and then now we have to go and edit the xml file so that's going to be in sysvol sysvol of your domain controller so my domain is called hyrule so i can do that sysvol and then it's under policies i'm going to sort by modify to get to the newest one and then user preferences schedule task and we can edit this schedule task and we have to find where we want to so it's right after subscriptions and i'm going to copy it from our working copy so let's edit this file as well and we want to copy value queries after subscription save this and now hopefully our schedule task is going to be deployed so let's go back here delete this one and we will run a gp update slash force it's updating the policy it should appear right here computer has been now it's doing the user and i don't think we got it uh oh so that normally means probably bad xml or maybe it didn't save because i didn't close it fully l let's edit this if we go to preferences control panel we're schedule tasks so i think we have it run gp update again okay schedule tasks and oh it is here notify on blonde block process i'm just blind so we run it and we should get a message there we go that is good and then if i refresh this we're gonna see it's this one that ran so last run time has been ran so hope you guys enjoyed that video take care and i will see you all next time