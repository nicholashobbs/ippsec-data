 what's going on youtube this is ipsec we're doing delivery from hack the box which is an easy machine i created so obviously i'm gonna be biased here and say it's amazing the box starts off with a logic flaw that involves two applications matter most which is just like slack it's an instant messaging application and then a help desk the organization set up their madame server to allow anyone with a company email address access to their chat because they assume only employees have emails the downside to this is the help desk actually gives anyone who creates a ticket a company email address because the help desk supports emailing the help desk to update your ticket so you can combine these two things to register for an account on matamos and gain access to some sensitive conversations and then the private there's a cracking challenge which we'll get into so let's jump in as always we're going to start off with the end map so sudo and map dash sc for default scripts sv and new rate versions oh a output all formats put it in the nmap directory but first that directory has to exist then name it delivery the ip address of 101010222 and i'm going to add the dashb flag so it shows me open ports as it finds it next i'm going to do a sleep 300 to sleep for five minutes and we do a full nmap scan so sudo and map dash p dash o a all ports and map delivery dash all ports 10 10 10 2 2 2 and it looks like the first nmap already finished so we don't have to queue up the second end and i'll do the dash v flag here as well so let's take a look at the results so less nmap delivery dot nmap and the reason why i just do the script scan first is because it generally shows me everything i want i cue up the full port scan because if there's a hidden tcp port i still want to see it but it can take more time to run so that's why i always wait till after this is done the reason why i don't do two nmaps at once is just because you can send a lot of data and miss things so the results of this shows me it's a debian box probably debian 10 based upon this ssh banner then we also have http on port 80 running engine x and the title page just says welcome so let's go take a look over at the webpage so 101010222 and we get just the welcome page that says delivery the best place to get all your email related support for an account check out our help desk and then there's also a contact us so going to the help desk we see its hostname is helpdesk.delivery.htb so i'm going to go in my host file so sudo vi etsy host and we're going to add that so 101010222 delivery.htv so now when we click this link it actually goes somewhere i forgot helpdesk.delivery.htb now when we click the link it actually goes somewhere there also is a contact us page so let's take a look at this for unregistered users please use the help desk and get in touch with your team once you have a at delivery.hdb email address you'll have access to our madamo server and the matamura server is delivery.hdb colon8065 so we click there and we don't go anywhere because we don't have that delivery.http because i got rid of that so let's add delivery.htb and then refresh the page and we can see a matamura server once it loads and this is just like slack it's an online chat application it has its own client and whatnot so it's telling us we should have a delivery.htb email so i'm going to put this on the back burner and we're going to check out this help desk system it is running os ticket and we see the copyright is 2021 its photo also tells us the host name of delivery i don't see a way to enumerate version so i'm going to go os ticket github and see if there's any quick wins on enumerating what version of os ticket this is to see maybe there's some type of um exploit so i'm just gonna grab this readme and we'll see if readme.md exists on this box and that was not what i wanted is it lowercase readme is capital dot md file not found so let's see i'm just going to try file.php to make sure we're in the right location so if i go file.php unknown or invalid file so it looks like we're good it just doesn't have the md files there is a web.config so we can try this the main reason i'm trying it is because it didn't have the php like suffix so the web server won't try to execute code so let's go out of here let's go downloads web.config and see if it gives any information about the version i don't see it so this may be a dead end so let's go take a look at it and if we run into more like um issues we can always look at the version we can also or we can always like enumerate the version better but we can also run search played against it to see if even knowing the version would help so we do have a lot of exploits for this i'm just going to go to exploit db because i think this may tell me like the dates search point isn't showing the dates i wonder if there's a option search point dash h do we have date case strict title uh let's see show results and json format i'm gonna oh dash v for reverse if i add dash v dash v here i do not know what verbose is about this i wonder if json output if that will show anything okay we have date let's do uh jq period there we go now we have the date i'm going to search for like 20 202 uh 2020 and 2021 so we do have some 2021 exploits so knowing the version would definitely potentially help uh server side request forgery authenticated xss ticket cues cross-site scripting um save search so this again is authenticated so a bunch of stuff there um knowing the version may help to know if it is vulnerable to that but we can also maybe just open a new ticket and just use this application for the email we don't really care what we put so do please subscribe at does not exist dot com just a fake email username we can do ipsec phone number uh 555-867-5309 uh let's just do a help desk topic contact us test ticket and we could try putting a link here so a equals href http 10 10 10 actually uh we have a link button here insert link let's just use the website's functionality for us so 10 14 2 test click me so there we go we have a link here and i always like just putting links to see if people click them uh sometimes they do sometimes they don't so i'm going to do sudo nc 80. so now if someone clicks this link my netcat will tell me and we just do the capture so a9d04 create ticket and we see the ticket has been created the id is eight nine four five one two six if we want to add more information to the ticket just email this and this is what's key a lot of help desk systems actually have this functionality where you can reply to the ticket and email to update it and you got to pay attention to what type of domain that gives you because it gives you the same domain as the corporation now you can potentially just bypass any verification that they just require you to have a corporate email because now we have a corporate email so if i go to check ticket status it's going to oh what did i put for the email address uh please subscribe at does not exist dot com i think i hope i forgot about that piece we can put the ticket number view the ticket so now we have this so if we emailed uh the ticket id at delivery.htb information should go here so i'm going to copy this email and we're gonna go to the madame server and create an account so what is my email address it is this my name ipsec my password would be password1 uh p at sswod one exclamation point create account so it says please verify your email address so it's accepted we can refresh the ticket and we see an email registration successful please activate your email by going to this url so we can copy this and then paste it and now we have just validated we have a delivery.hdb email address which allows us to log into madame erst and i've seen this vulnerability quite often in like organizations especially once like curved hit and a lot of people are working from home trying to find like remote work scenarios creating accounts for everyone was a tedious process or a lot just depended on if they had an email it was good so we can get access to this matter most and we see a message from root developers please update the theme to os ticket before we go live so the help desk is not live credentials to the server is mail deliver and you've got mail also please create a program to help us stop reusing the same password everywhere especially those that are variant of please subscribe bang it may not be in rocky.txt which is a common word list but if any hacker manages to get her hashes they can use hashgat rules to create a variation of all common words and passwords so this is a pretty good hint at what we'll do in a bit but we can go to this um box so we can try to log in and we see no one clicked the link so i'll just control c this we can ssh mail deliver at 10 10 10 2 2 2 and then we copy you've got mail i think i copy the space there i'm gonna hit backspace there we go so yeah i had a space that's why you heard two keys hit so we're on this box now if we go to user.txt we can get the flag but the hint says please subscribe may not be in rock you if a hacker manages to get this they can easily crack all password phrases so the very first thing i do is look at past wd to find out what other users are on this box i'm going to do grep dash v and we can say um we don't want anything with false i don't need that bracket uh backslash pipe is how you do an or and grep so no login we also don't want and we see let's see just four accounts we have mattermost mail deliverer sync and root we're this mailed over account so we may want to go into mattermost and we could use hashcat to build a variation of this word list so there are two ways to root the box you could skip the going into the database to get a hash by doing this so we're going to go here and we'll use hashcat to make a word list so let's do v pw put please subscribe there so hash cat then dash dash std out i believe pw dash r for rule file then user share hash hashcat rolls sixty-four dot rule and that's going to make 64 entries of this password so we can just output this to a file now so we'll call this uh pw list maybe i don't know what else to name it and if you're curious how this rule file works it's somewhat cool so we can go over it really quick so bless this rule file and if you want to know more about hashgat definitely recommend the hack the box academy i've helped create that course i think ben did it with me but it's a really good course so we can let's look at what it created so pw list so if we look at hash cat rules colon means do nothing so it just did nothing here r is a magical one to reverse the password so you can see it took that and reversed it u is going to uppercase the whole password t 0 means toggle 0 so it's going to change the casing on the zeroth letter which is the very first one if that was t1 it would leave this a capital and then capitalize the l then we can do see it's doing a simple number append so dollar means do something to the end so we go to the end of the line and adding zero one two three five six seven eight nine and then it's doing it again with two digits so you can see how that works so hashcat rules are super simple um this is going to append e to the end append s to the end because some maybe your password is password and you want the password of passwords i don't know um this is going to overwrite so this is delete one character this little bracket i bet if i google we can pull up a how to on this real quick so again delete one append a so it deleted exclamation point append today delete two append s so it's just doing common things like that uh if we do hash cat rule file syntax maybe uh let's see uh rule based attack is it going to explain everything yeah so this is all the functions and how to do it so definitely recommend reading this or again if you don't want to just read the man pages go to hack the box academy which gives you more interactive learning but now that we have this pw list the question is how we use it we could just use hydra and brute force ssh but sometimes ssh doesn't allow root to log in actually in most cases root doesn't log in via passwords so if we look at etsy ssh sshd config permit root login is no so we can't log into this box with ssh and i want to brute force both accounts of um mattermost sync and root well sync i don't really care about because that's not a interactive shell but i want to brute force matter most and root so we got this password list the next thing is to use a program called su crack so su crack github to download it and what this is going to do is just brute force with the program su so let's go to op and get clone uh let's see i already have it so let's rm-rf s-u-crack uh get clone cd su-crack dot slash configure and it will allow us to um you may have to do like a i think auto reconfig f-i i believe if that configure doesn't work to um do something but if configured doesn't work i recommend that auto reconfig command and if that doesn't work google whatever error you get but now we can just do make and it's going to make su crack if we go into source we have su crack here so i'm going to go back make dub dub dub and we're going to copy pw list to dub dub dub and then copy up su crack source su crack to dub dub dub now we can host both of these so python dash m http dot server port 8000 and then let's just make dirt.work actually let's try doing this from dev i say gem for opsec reasons the reason why i like this directory so much is it's non-persistent this is um ram disk so if the server reboots uh the files you drop here are gone so you don't have to worry about cleaning up after your tracks as much if you just created this dot work directory in the home um if you just forgot to delete it the file would exist until someone deletes it and that's just not good so wget 10 10 14 2 4 8 000 su crack and then we want to do pwlist and then let's ch mod plus x sucrac dot slash su crack and we can see we can execute it every now and then um dev shm mainly on like i think red hat and centers boxes will be mounted no exec here if we grab no exec is anything mounted here uh let's clear that out so these directories have no exec which means i can't drop a binary and run it says proc def pts these aren't really even directories you can drop files to so don't really matter to me so let's do su crack dash h and we can see it wants let's see s-u-crack some options user root password list so i'm going to try that real quick su crack root pw list let's see what happens with no thing uh no such file or directory let's do dash rl okay let's read all these options in the example so let's look at what dash a is let's see dash a options dash l is rules dash u is user word list should go at the end i wonder if i do dev shm pw list f open no such file or directory su crack dash a dash w20-s10 you root dash rl so this is rules afl afld pw list okay so rl works i wonder what l is what is l l is rules if i just do dash r okay there we go so this works and we can see the password for root is please subscribe exclamation point 21. i should probably look up the syntax for su crack but i don't know every tool i just know like i don't well i don't know how to use every tool i certainly don't know every tool there but yeah so that is one way to do this box the other way is using hash cat so if we look at matter most so i guess matamos is probably installed in opt because that's where most applications are so we go up mattermost look for the config probably in a directory called config and we can look at config.json so i'm going to do cat config.json jq period oh i don't have jq here so i'm just gonna do less and we go through this uh we have an api secret so this could be good this is a gift cat api secret so probably talking to a server that has embedded gifs so not too interesting if we wanted to upset people we could just erase that keys and then maybe their giphy won't work but we have this sql setting so we have a user called mmuser and a password called crack that mattermost admin pw and it's going to port 3306. of course the driver says mysql so we know this is a mysql box so i'm going to copy this password and then i'm just going to try s su-mattermost to see what is here put the password in and it does not work so we can also mysql dash u mattermost p put the password access denied for user matamos at localhost i'm going to try putting the database of matamost and i think we need the dash capital d flag maybe see crack the admin pw i wonder if it was an exclamation point let's see shift exclamation point so let's go back into config.json uh crack so there is oh user is mm user i was typing madame host so if i was taking notes uh i probably would not have made that mistake so always the benefit of taking notes but we can do this paste and we get in so show databases uh show database show databases it helps if i can type and we can use mattermost and then show tables and maybe the users table is good but if i just select star from users um it gives me all the information but that may be a bit too much so i always like doing describe first to show me all the tables within it and then i can select what i want so i probably want the id the username and password from users and i may want like mfa secret if they are doing two factor because if i steal all these secrets then i can just bypass 2fa but we have this and let's see id okay username username root and here's the password it is a b crypt password however um the hint says to crack this password and our word list isn't too big right if we look at it wc-l pw list it's only 77 characters uh 77 wait why is it 77 weird i assumed it would be 64 because we ran best 64 on it which should be 64 rules but okay whatever so it's v hash to prove the hashing doesn't take too long i'm going to do an rvm so i'm going to look at example hashes less decrypt and we're going to paste this hash on mode 3200 so m 3200 uh the password or the hash and then we could do pw list but we also could just do pw and then dash r for rules user share um cat roles best 64. so generally with hashcat i don't just output a bunch of word lists because the benefit of rules is when you get into large files let's say this word list was one gig if i wanted to use this best 64 rule which made this 76 lines now that one gig file turns into like 76 gigs not fun so that's the benefit of rules and oh i already have this in let's move hash cat uh yeah let's just delete that whole directory or we can do podfile there we go it was telling me it had already cracked so when i was making the box i guess i just left that in i don't use hash cap from my vm much but you can see it cracked it so quick because again the roll file is just small um i like this piece of the box i know it got a lot of hate but my thought process with adding this is i run hashcat probably a hundred times anytime i do a password audit because i will constantly run hashcat and then go into that rule file i just deleted so i'll cat hashcat pot file um all dash f print two and then grab this to a new crack and then run hash cat yet again against this and every time i get a new crack it goes into the pod file i run it again run again run it again and you'd be surprised how many more hits you'd get if you just do a best 64 crack against an active directory database and then take what cracked submit against best 64 again and then again and you'd be surprised how long of a chain you go until it stops giving you new cracks so that was what this whole piece of the box was supposed to teach you is using hashcat rule files so yeah hope you enjoyed the box before we go i can go into i guess kind of how the box works um let's do su dash and please subscribe whoops please subscribe xmh.21 i probably typoed that so i'm just going to um cat cat new crack and we'll copy and paste sq so what we can do is look at this pi smtp and mail.sh there's also note.text which talks about it and gives you a blog post of what this whole attack was based upon how i learned about it so if you just go to this medium link or google how i hacked 100 companies through the help desk it talks about exactly what we did in this box so let's look at mail.essays to see what this is um all this is doing is starting the pi smtp server so i'm guessing if i look at my cron tab uh let's see cat etsy crontab yeah um it's constantly making sure this mail.sh is running and then if i look at mail.sh it says if i don't exist run it so really bad way to just make sure this service is running i probably should have created like a systemd service or something but i'm too lazy so i just did it this way because it was a quick win now this smtp server if you noticed in one of the boxes i forget what one we used a python smtp server to retrieve mail and that's exactly what i'm doing here i learned about that python library from that box and i'm just getting mail and then going into the database and mainly doing that update mail doesn't actually work on this box because it's a closed environment this was just a good way to get that working and get the ticket information in there so if you want to look at a fun script i had writing there's this one but yeah that'll be it hope you guys enjoyed the video take care and i will see you all next week