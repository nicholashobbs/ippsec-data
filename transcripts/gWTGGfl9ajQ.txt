 what's going on youtube this is ipsec be doing time lapse from hack the box which is a fun straightforward easy windows machine that doesn't have a web server it starts out with finding a zip file on an open file share that you have to crack and then reveals a pfx file which is a certificate and the pkcs 12 format essentially it's just multiple certificates bundled together that windows likes to do this is used for authentication so you can use it with evonrm however you have to separate the certificate and the keys so you use openssl to do that and you can log into the box looking at the powershell history file the ps read line you can find a different password that you log in and discover this user is a member of the lapse group which is a play on the name time lapse because it has laps there that's the local admin password solution that randomizes the local admin password every certain number of days so you read the password off the um ldap attribute and you can log in as administrator so with that being said let's just jump in as always i'm going to start off with the nmap so dash sc for default scripts sv enumerate versions oh a output all formats put in the nmap directory and call it time lapse and then the ip address of 1010 11.152 this can take some time to run so i've already ran it looking at the results we have looks like 11 ports open the first one being dns on port 53. then we have kerberos on port 88 and this is looking like a um windows domain controller because it's microsoft windows kerberos we have the server time if we go down to the ldap which would be 389 we can see its hostname is timelapse.htb so i'm going to add that in my host file so sudo vi etsy host and then we can add timelapse.htb into it actually we have to put the ip address of 1010 11.152 and then save that then we have port 445 open and a bunch of other like domain controller reports so the first thing i'm going to check is port 445 to get the hostname of the box so i'm just going to run crack map exec and then smb 1010 11.152 and this should tell us the hostname which is timelapse.hdb but the name is dc01 so we could go back into a host file so like this and then put whoops that was page down um dc01 and dco1.timelapse.htb just so we have all the potential names for this box so the next thing i'm going to do is try a dash dash users flag to see if we can dump a list of all the users on the box and we can also try like dash jazz shares uh i think we do both of them actually does that work error enumerating shares so nothing there we can try i want to say this does a null authentication just putting blank for the username to see if we authenticate that way or maybe it is a period let's see what that does let's blank out both username and password um i know authentication with like crack map exec can be a little bit wonky when you test all the things that's why i always like running multiple tools so i could also do like smb client dash capital l to list shares then 10 10 11 152 and then just hit enter when asked for a password and we can see the shares so there's probably a way to do this in crack map exec but when one thing fails always move to the next tool i like double checking everything make sure two tools have the same result just because you can miss things otherwise so let's do um a slash slash shares because this is a unique one i know the c-vol and admin vol these um require authentication shares is non-default so it's a good starting point if we go an ls there we can see two directories so i can ls dev i think we have to do a slash maybe star even nope just slash and there is a win rm backup so i'm gonna do a git dev and then winrm backup.zip maybe it's a backslash we need we can always just cd into the directory if we have trouble and then we can do ls on help desk as well and we see laps and i believe these are all standard microsoft documentation things so i'm not going to um well i guess we can download them if we just cd help desk we could and make sure they are standard lapse things but i am guessing they are and then get the last one okay and let's see interesting when i download and put the directory in the directory appears here um but see if we run exif tool on one of these documents let's try the operation guide we see an msip label i don't know exactly what that is i'm looking for some type of username so we could exit tool star.x i user or maybe name to see if we get anything we don't get any usernames from this um another thing i like to do to identify if it's a unique binary or not we can do laps x64.msi and md5sum and then go over to virustotal or something so let's do firefox and then go over to virustotal.com go to the search feature paste the md5 sum and we can see the file is distributed by microsoft it was last seen eight days ago if we go over into the details we can see it was first seen over a year ago so chances are um it's not related to this box especially because it does tell us it's distributed by microsoft so let's keep going on and take a look at the zip so if i unzip the dev winrm it's asking for a password so let's put this over on the kraken it's just a box i have because i hate cracking in a vm especially when i'm recording so scp that over to the kraken and then sshn and we can move the file into [Music] um actually we don't have to move it we just can go into where i have john the ripper installed and there is a zip to john i believe grab zip2 there we go dot slash zip to john and then put the file here so root i'm going to call this when backup dot hash and then try to crack it so john the file name and then dash dash word list is equal to opt word list rock u dot text uh do i not have that is it word list it's word list and then we can run show to see what the password was or actually it told us right here supreme legacy so let's go and unzip the file so unzip dev put the password of supreme legacy and it now has a pfx file which is like a um group of certificates so let's view the information in this pfx file so we run open sl pkcs12 dash n for input the file name which is legacy dev auth.pfx and just based upon the name having auth in it i'm going to guess is some type of authentication certificate um my first thought would be some type of web authentication certificate but there is no website involved with this box at least that we found so i'm gonna guess it's for like powershell remoting or something like that and then ask for a password so i'm gonna type the same thing in which was supreme legacy and we get an error message so i'm gonna copy this over to the kraken so we can try cracking it because i'm guessing the password is just wrong so we scp the file over go back to john and then there is a pfx to john so we can just grab legacy auth and then i'm going to direct it to the file of um legacyoffbfx.hash and then we can try cracking it so dot slash john legacy dot hash and then dash dash word list is equal to opt word list rock u dot text and we'll see if it cracks this certificate and it looks like it's not instant so i'm going to pause the video and we'll just resume when it's done um i'm going to run the time command so you know how long it takes so we'll come back when this is finished and it took about 22 seconds and we get the password of thug legacy so i'm going to attempt to view this certificate again so open sl pkcs 12 in legacy dev auth info type thug legacy and i'm just going to put this on my clipboard so i don't have to type it 100 times and we see it is a microsoft software key storage provider we can input the password again and extracts the certificate and private key so both the private key and certificate are in this so i'm just going to use openssl to extract them we could have probably just copy and pasted it but whenever dealing with certificates white spaces and things like that how like each line is terminated can screw it up so i always like um just extracting it manually with the commands so the first one we want to run is dash no certs extract the key and we do nodes as well and if i look at key dot pem we can see exactly what it looks like kind of near the top of that last file and the certificate uh we just want to get rid of the nodes and instead of no certs we put no keys paste in the password and i did something stupid so rerun the key.pam because i overwrote the file with that one command if we look at key dot cert we can see what that one looks like so it's kind of the combined output of the info command so now we should be able to do evil winrm potentially if we do dash h let's see there is a c option and a dash k option to authenticate with keys so the one thing we don't know is if this box is listening on winner imports if we look at nmap uh it doesn't have 5985 or 5986 which is the winrm ports but those aren't on the top 1000 ports so i'm just going to run an nmap to check for those so 59 85 to 59 86 10 10 11 152 i'm going to add the dash v flag so it shows me open ports as it finds it we can see 59.85 is filtered this is the non-ssl port for winrm we can see that by just wsman and 5986 which is the ssl option so when we run evo winrm we're definitely going to want to specify ssl so if we do the dash h again we see there's a dash capital s or dash dash ssl so let's do evil winner m dash s dash i 10 10 11 152 i don't know if we need this or the host name um if this doesn't work then i try the host name next dash c this is the public key so key dot cert and then dash k this is gonna be the private key key dot pem and let's see if we log in i'm not sure if we need nope we don't need the username which is legacy so now we have a shell in the box uh it doesn't look like there's anything in the documents directory if we go up a directory we can do like gci i think dash force will show hidden files and see if there's anything here don't see anything if we go into desktop we see a user.text now when i did this box i ran um win piece and saw the output here but i'm not going to run win ps just because it'll probably kill like five to six minutes when instead this is a file you shouldn't generally be checking it is the ps readline file which is where a lot of powershell output will go and it's located in the app data directory then underneath of that it is microsoft windows powershell let's see cd microsoft app data um i think it's roaming then microsoft windows powershell ps read line and i believe these directories underneath app data roaming i think is part of like roaming profiles this one will get copied when you log on to multiple computers and a domain local is going to be local to that computer so if i was in a domain and i logged on a computer and this ps3 line thing was enabled and i went to a different computer this console host history would follow my user to the new computer so i think that's how the app data directory works don't quote me on that but um i believe so and then in this there is this console host history file and if we view it we can see who am i ipconfig.all running a netstat command and then putting a password in so right here they're creating a password object and then create a credential and the user is svc deploy and the password is this e3r thing so if we let's see i guess we can go back to crack map exec right so let's exit out of the kraken we can do crack map exec smb 1010 11 152 dash u svc dash p put in the password and it's authenticated but it doesn't say pwned so we can't get a shell through smb um if i try winrm i'm sure we can log in with this so we'll see what this one says it's trying https right now i believe it is it's taking its time but we can exit evo1rm and try swapping out with dash u svc deploy dash p put in that password let's just see if it authenticates faster than winram looks like it does i'm guessing for some reason winner m just hung up on it not being able to reach port 5985 i'm not positive there uh we see uh let's see connection timed out it's not telling me the port here um but it says http connection pool not https connection pool and 5985 so yes it's timing out because it can't talk to port 5986 it's kind of funny because it says it starts off with that i'm guessing it tries to talk to both i'm not sure exactly but um here we have a shell and if we go into the desktop here if we do gci-force see anything we don't we can check the app data again so app data roaming microsoft windows powershell ps read line let's see okay powershell there is no powershell directory so the same thing doesn't work here um it is active directory so i'm going to try running bloodhound real quick so um i always like just downloading the latest so let's go to firefox and then go to google and this google sharp collection github go to this repo and then we look for sharphound to tell us what file it's in looks like the third one which is dot net 4.7 so grab sharp pound and see if we can find anything with this so download save file let's make dir dub dub dub go there cp download sharppound.exe and we could load this onto our evil winner m profile but i always have trouble when i do that it doesn't always work so i'm just going to download it to the box so curl 10 10 14 8 port 8000 sharphelm.exe showpound.exe and let's do python 3 m http server and it is downloading see if we can execute it and not get a net error it's thinking about it i wonder if it's just running now i thought we'd have to specify a collection parameter with like dash c uh looks like windows defender is blocking it so um we could do the next best option and just run sharp pound from um python so bloodhound.pi ingestor on github and grab this file i probably had this in my op directory but oh well bloodhound.pie and let's see we probably just do user at domain let's see dash c all svc deploy at timelapse.hdb that is not it so let's see dash c dc for host um this is going to be timelapse.hdb d timelapse.htb we can do dc01 is there a dns server option let's see collection method so we got u and p see deploy dash p that's not the password see do we have it in this window nope right here paste it and it is querying the dns server locally on my machine we have to tell it where the dns server is dns tcp timeout see oh dash ns name server there it is so dash ns 10 10 11 152 so now this should give me bloodhound output and dns operation timed out let's try dns tcp see if this works nslookup server10101152 timelapse.htb i am not sure why it is timing out sudo v etsy resolve dot com name server 10 10 11 152 put it in here then we can get rid of these options and dns operation timed out yet again so i'm not sure exactly what's going on here but we can just do some manual enumeration i guess so let's do a net user svc deploy to see who we are and we're in the labs reader group so the lapse reader group can read lapse passwords it's local administration policy for server maybe what does lap stand for um lapse acronym local administrator password solution i was not even close but um it randomizes the local administrative password on all the machines so you can't do like past the hass type things however it stores it in active directory and only members of lap's reader can read the password and the password is in the i think like mc-mcs-adm-pwd i believe a property of a computer but we can just do get 80 computer star and then dash property star and let's see is it going to force me to pick a computer here i know we can do get 80 computer um to get this i think it's running i think i need another star here to get all computers let's see evil when rm what's up another connection let's see what am i there's the shell enabled here's the command so let's log in again get 80 computer star cannot find an object with a identity i just run get 80 computer i wonder if something's funky with like dns on this box let's see laps get 80 computer get password see how does this run get 80 computer filter that's near what i was doing okay i don't know maybe the filter object sped it up because that's command i had ran before but oh well we have this we can look for pwd bad password count and right now we have it we have the expiration time in like a windows epoch format and then a password so it was created 8 19 2022 and oh no um let's see we want to look for the password last set for this guy so pwd adm is that a password so this is when the password was probably set 10 23 as long as that's the right box and this is the password for the local administrator on the box so the red 500. and i'm just going to exit that if we do net user it's probably going to be administrator because that user is there i was seeing if they renamed the administrator user doesn't look like they did so we can do you administrator and we could probably do this through ps exec as well but in this password and we have logged on so we could gci-force uh where's the flag see gci trx desktop there we go it's under the trx users but yeah that is the box if you wanted to you could also get the laps password through in packet so if we go back to google we can do laps.pi i don't even think it uses um in packet actually um there's a python script uh no it just uses ldap so if we copy this script v lapse dot pi set paste and then run it let's see python3 labs.pi dash i username and password uh what okay i guess i screwed something up there python3 um let's do dash u okay grab this dash p we show the password here as well paste uh dash d time lapse.hdb unrecognized argument i let's remove it and here we have the script running and we get the password as well so even if you don't have command line access they still have credentials to an account in the lab shooter group you could pull the password because again it's just in ldap so hope you guys enjoy the video take care and i'll see you all next week