 hey guys what's going on this is epic and we're going to changed up a little bit and do a non CTF problem but it's still gonna feel like a CTF problem because what we're doing is very CTF like and that is analyzing a malicious Word document the main difference between this and a CTF is we have to be safe because this will infect us and do bad things so the main thing to do is make sure you have a snapshot just before you start and then I always like having a machine between the infected or the analyst machine in the Internet in this case I'm using a Ubuntu machine that I have configured as a router so it's going from Windows to my Ubuntu router to the Internet and what that's going to allow me to do is do a TCP dump on the shared interface which will be ENS 38 and will do - as a 0 so we capture an entire packet and write to capture that pcap so now anything my Windows machine sends out to the Internet is going to be captured additionally this Linux machine provides a buffer between any potential machine on my home network so those machines don't get effect infected and either so always smart to have a machine between your potentially infected machine so now we have this Word document before you open this up and start looking at it I'm going to try to extract the macro and see what it does so I'm gonna run bash on Windows which is amazing it has some bugs it's normally easier to do things straight on Linux but I don't have to copy back and forth between machines which is a godsend so that's why I'm using bash on Windows so we do desktop and then the tool we're going to use is oh le VBA and I'm just gonna feed it the Word document and it's going to extract what I want is the macro so we see a subroutine of a random name stress with muv and that does a bunch of a few skated junk and then down here we see the sub auto open back to this and n sub so I'm going to direct this to macro txt and going into this we're going to have to see what these lines do my guess would be this active document built-in properties comments is pulling the documents from the word document so one tool that does a great job at pulling metadata from almost anything is exist tool so I'm gonna run exist tool on that document and we do see a bunch of garbage up here in the comment section so what we're going to do is pipe that to exist our text and then open this up in notepad plus plus then delete everything that is not comment and then save this as comments dot txt so the next thing we have to do is figure out how the program uses this big chunk of string so the easiest way is to go back to this document or the macro and we're going to see exactly what it does so this right and left the left goes from the end of the string back twelve thousand and eight hundred and eighty-three characters and that's where it sets the marker and then it goes to the right a hundred and seventy seven characters so I'll show this line in Python and then we'll skip over because I'm not going to write a script that analyzes everything because there's the easier way to do this so go into Python and we have f equals open comments dot text and we want to read one line and we'll strip any character at the end we'll see if that works print F so there we go we have the comment inter string so what we want to do is if we do print F and then negative 2 and colon and this what this is going to do is print the last two characters so this is simulating that left function c5n and if we want to print right one we just do it like that I forgot the colon that's what the colon goes and now we assimilated left to right one so if that was left 10 right 5 we see 5 v 9 9 V which is right here so that's how that works so the very first function is left 1 2 8 8 3 and then right 177 and that is what the very first variable will equal but we can just scroll down to see kind of what happens we see it doing a bunch of that weird stuff and then at the very end we do see it combining variables so right here we have WB v VK whatever this is is equal to all these and this is that very first variable so we have ad you and qaf we go up to the top we see a tu and then qaf so this variable equals all these up here and then it's also combining it with this variable and then it's going to do this VBA shell to execute this so once it D Appa rubs out all the strings at once from up here it's gonna run this in VBA shell so that's how the macro works and instead of writing something that goes through and curves out everything we can do something a bit easier so close out of everything and we're going to have to make sure a virus scanner is disabled because I don't want this deleting the document and then getting into that so is it okay virus scan is off and we're gonna open the malicious document but before we do that I'm gonna open up proc Mon and this will just allow me to see what word is doing so I'm gonna go create a filter for process name word yep and I'm going to undo registry file system Network and I only want this show process and thread activity then we do auto scroll and to give you a reason why I did that we can enable them real quick and then we'll just open up word and not the macro and you can see how noisy process monitor is maybe it didn't do anything filter process name pal I want like contains and you can see everything that word did one dope ined so this is very noisy so uncheck these so we don't see them and it kind of just makes it a bit more bearable because all we want to do is see if this ever execute like PowerShell or command prompt rels desktop transaction and before I get into this I just remembered one small thing I want to get into is if we look at this comments I don't really see any string of characters that is going to be dangerous and by dangerous I mean when you set a variable it is possible to get code execution so we set y equals to 1 and we echo I we just get that but if we set I is equal to like this I actually executed code and ran that Who am I string so I glanced over the comments and don't see it being really possible for them to do that based upon the characters in here and even they did I just revert my machine anyways so go back here and we don't want to click that just yet because we don't want to infect ourselves we want to go to view macros view macros and edit and what we're going to do is press ctrl-g to open up this immediate window and take out this VB ADOT shell and just put debug dot print and then we're going to save this and we'll close this out and enable content go back into macros view macros edit and we can see the string so it was going to execute CMD slash V set and this junk and we can go back to process monitor and I don't see cmd.exe here so they're not execute we successfully avoided that so what I'm going to do is copy this string go back into a notepad because we have two now on base64 this we need to be all one line and we can save this to the desktop and PowerShell encoded text so open up bash again you can see I always close windows I really wish I had T MUX here and I may actually be able to do T mocks at install team ox so you know I have to install T MUX team walks I can that is awesome so I didn't even know team Oakes had worked here CD desktop dir oh I wanted to base64 dash D and what did I name this powershell encoded so there we go we have PowerShell so will do direct this to powershell decoded text and when we cat power shout decoded text we get this string so we're going to throw this back up into notepad plus plus and I just like that because it does this highlighting so if I highlight this I see that's closing that so what I'm gonna do is you'll live this and just do right host and hope it doesn't execute and again if it does execute revert so if we paste this in Anna and we actually get the code so this is going to be the PowerShell code that is running so this all in one line so we can read this and then we can do edit please find what semicolon and extended backslash n place all so here we see it's setting a W script up net web client new object stream sending a few URLs and now it is creating a name for the file here's where it's going to save so it's saving this file into temp and then it's going to go to each of these URLs download the file and execute the file so what we could do is just go out to this domain and download the file see does this download it does T dot exe and then we can just go to like virustotal and see if they know what that file is so desktop no it's under downloads blood and skin and it's definitely malware many of them said it's this Emmert it and that's why I labeled it Emmett 8 question mark so see next thing we can do is close out of all this closer to that don't really need that I forget what this was before I saved it because I actually want to execute this so we'll go to desktop macro with shell VBA shell so let's see if this works so file save and just on the left close that close that progress so we're going to run this and see if a process monitor catches that cmd.exe run and there we go we do see cmd.exe was created so we can change a filter we can probably just include this filter remove this one apply oh I don't want path so we want process name is equal to cmd.exe and we can kind of see what it's doing and we see it create PowerShell so we can change a filter again process name contains PowerShell and we kind of get an idea of what it's doing and one of these it creates a file NCC bit and that's what I'm looking for I'm not sure so filter just get released process names and see what's going on on my computer so here's that random numbers that we saw earlier dot exe does this say words located at C colon uses EPS a cap date at local temp so if we go here we should see that file 3 1 5 we don't so this cleans itself up that file is not there we go down a little more and we see NC BB i TS and this is the actual malware it downloaded so we had the word document which used a macro to drop a file which then use PowerShell to execute the file it dropped to download an executable which executable would then go download another file and that file was NCC bits exe and this is the real malware so if we turn on antivirus on it probably will almost immediately get detected let's see skin history I always forget how to turn there we go that's what turned on is and or by clean that up momentarily close clues Clues found threats so windows defended doing its job there what we can do now go back to a Linux machine and then open up Wireshark and open up the captures pcap and kind of see what's going on here to see if it was going over clear text or not so we know it's going over HTTP at some point and we see one get requests right here it's actually doing to see oh that's not related to this so if we do that let you both that should show both so yeah this is just OSC peak whereas I think but here we go the east side karate calm trying to grab it for a for not found that it's going to go to this and download this file if we get rid of the stream see if we can figure out where that's going TCP this may be the NC bits right here let's see not sure but this work becomes a big hunting game and in future videos we'll go through bro and things like that to see if it helps us near this type of stuff down if we do file export objects HTTP we can see what files it sees if it does see the NC bits and it doesn't look like it does so that's not transferred over HTTP so the goal of this video was just to analyze that malware the office document so you could see how to do if you skate it and hopefully that worked and if you enjoyed this I guess subscribe or let me know and we'll continue down this rabbit hole of figuring out exactly what this malware does the next video probably would be doing either dynamic analysis or static analysis to find out what that random executable does the one that's not antsy bits it's the one that downloads that file is it downloading it or is it just moving itself and dropping it I don't know maybe it's just moving itself that may be more likely since I don't see anything in the network stream but I hope you guys enjoy take care and I'll see you next time