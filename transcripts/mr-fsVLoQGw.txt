 what's going on youtube this is ipsec i'm doing cascade from hack the box which was a unique and fun box because it didn't have any web server exploitation at all it starts off just doing a bunch of ldap and smb enumeration to find out there's a set of credentials in ldap that you can use in smb to get a bunch of files off of the server and one of those files has some credentials in it and then it goes into doing some dot net reversing to reverse how a application decrypts a password out of a database you get that password to let you into active directory and it doesn't have any kerber roasting involved or any like bloodhound uses to find aad privasc the main reason for active directory is because you gotta crawl its recycle bin to extract a user that was deleted so with all that being said let's just jump in as always we're going to run an nmap so dash sc for default scripts sv enumerate versions oh a output all formats pin the nmap directory and call it cascade and then the ip address which is 10 10 10 182 can take some time to run so i've already ran it looking at the results and we have a bunch of ports so the very first one is dns on port 53 then we have kerberos on port 88 and just the combination of dns and kerberos and then looking at like um 445 which is smb we know this is probably going to be an active directory server it's also telling us with this ldap script saying it's microsoft windows active directory ldap and giving us the domain cascade.local so i'm going to go put this in my host file so sudo vi etsy hosts and then we can add 10 10 10 182 cascade.local and i'm going to do cascade both the fully qualified domain name and the partial domain name or whatever that's called or hostname so looking at this we see a bunch of high number rpc ports but i don't see any web server or anything so let's just go cherry tree and do control n to create a node call it cascade and then notes and let's see what do we want to enumerate um i'm not going to bother enumerating dns we've done that in a few videos let's see smb and ldap smb we can get like user names um and brute force and we can also get like groups ldap we can get user names uh other info i don't know exactly but those are pretty much the two services we can look up and this can also give file shares so let's start off with just doing some smb enumeration i'm gonna do our fbc client dash u 10 10 10 182 log in and we're going to try testing i think if this is anonymous authentication allowed uh let's do what is it a new domain users and we get a list of a bunch of usernames awesome so i'm going to copy this and then we can put this in a note file so v users um i'm actually going to do temp and then we'll copy it to users so let's do cat temp uh awk dash f print one like that we want two and then awk dash f the other one print one there we go so this can be users.lst and we can remove temp and we can run like query display info whoops and see if there's anything in like a description field and it doesn't really look like there is so the next thing we want to do is probably enumerate uh file shares so i'm going to do crack map exec smb 10 10 10 182 shares and we'll see what we have uh i guess it wants a username so we'll do null authentication nothing with user nothing with password nothing there and i'm also going to do smb client dash capital l 10 10 10 182 just try a different tool to see if it provides different results because things access services differently so it doesn't look like we can enumerate file shares so let's start up a brute force and then we'll move over to enumerating um ldap so i'm just gonna do vi passwords we'll put password april uh i don't know why i did that winter summer autumn spring and july because that's the current month let's see can we get when this box was created or when a username was created rpc client dash u 10 10 10 182 num dom users query dis info i wish i had taught autocomplete there i was seeing if it would tell us when an account was created i'm guessing if we query the individual user it may i think that's just query yeah query user and then we give it the rid of a guy um let's do the arc service account whoops paste that and we can see the last login time is actually today but the password last set was january 2020. we can check a few of these and we see the um steve smith account was not logged on no such user there so i'm going to put this in notes arc svc logged on recently which is a little unique but in the password i'm going to do stuff around winter i guess because that's when this box was active and you should always try like themes with your password and when you know when the password is set you may be able to guess the theme like if a password was set within the last two months i may add like covet 19 or corona to the password because that's an event that's going on right now so you may get people setting passwords like that so just do that and then if we wanted to we can mutate this password list so we can do hash cat dash dash force uh passwords dash r user share i think cashcat rules best64.rule std out uh if i can spell hash cat really spelling is half the battle um t vt so we got a bunch of passwords so i'm going to do sort dash ut to passwords so now we have a pretty big password list that we can use with crack map exec while we enumerate so crack map exec smb uh 10 10 10 182 dash u users.list dash p passwords and before i run this i'm going to see if we can get lucky and um what is it i forget what the lockout command is crack map exec dash h grap uh dash dash pass pile that's what it is uh copy dash dash pass paul does if we can get the password policy before running some type of cracking you should always enumerate the password policy and make sure that it doesn't automatically lock out so let's see minimum password length is five so we could try passes with five characters account lockout threshold none so we know our brute force is going to be safe so we can just run that and then while we have that going let's go play with ldap so ldap search dash x h 10 10 10 182 uh is it forget what the query is let's open up firefox and just search this real quick uh is it dash capital h for host name in ldap naming context uh lowercase h i think let's see ldap search naming contacts and this is going to give us the um domain information we don't need this because ldap automatically runs this we're not ldap um nmap automatically runs this for us but it's nice to do uh dash space that's what i'm missing there we go so this tells us what the actual domain is so with that we can do dash s sub dash b for the query and then dump ldap and we got a lot of information you can see like this is a group called factory here's the backup service account up here but the best way to analyze this is do some fancy machine learning and by that i just mean counting um duplicates so let's just put this to temp and then if we cap temp we get all the output i'm going to awk to grab the very first event and then we're going to sort and then unique dash c and then we just do sort dash n to sort by number and we want all the anomalies like if something says something constantly i don't care about it but just these ones i care about and one thing sticks out right away we have cascade legacy pwd and if you want to get rid of that like base64 we can always just grep for a colon and these attributes are also bit odd i'm guessing this goes to some type of domain policy but if we go near where the um multiple hits were when created this is something that's on pretty much every object in active directory so that's why we see it so i want to look at the what was it it was a legacy password this this is definitely unique so we called this file temp so let's just less temp search for cascade legacy pwd and it looks like we have ryan thompson and the cascade legacy password here so let's do here ryan thompson like that and his account name it's probably sam account name where is it that password count log off same account name r thompson okay so this looks like base 64 just because it's ending with an equals so let's try undoing the base 64 real quick basic d4 dash d and he gets ryan five eva so i'm guessing maybe it was ryan forever but the password policy made him change at one so he incremented the four to five and be my guess but let's just try this crack map exec smb 10 10 10 182 dash u r thompson dash p the password and we get a login however it doesn't say pwned so we can't use smb exactly or something we can try winrm and we can also do crack map exec smb 1010 10 182 the same exact thing i guess i should have just copy and paste the whole command but we can use shares now to see what shares are on this box come on and we can see there is a data share the print share so both those would probably stand out to me i don't care about like admin because i don't have read permission net logon i don't really care about sysvol i guess we could look at potentially group policy information but these are created by active directory itself these are unique and unique things i like looking at so let's do dash m spider underscore plus and this is probably one of my favorite changes to crack map exec lately um pip 3 install pi link if i have to do that with sudo ah we'll try it without it's already there uh let's see sudo apt install crack map exec already the latest that doesn't look like the latest version i know the latest version is 5.1 just off the top of my head so i'm going to go pull it and we're going to hope we don't brick or cali github so let's um cd slash opt get clone and you should probably install it using like pip end and all those type of things but i'm really bad when it comes to just installing applications and i always just install it in my current space like i'm doing now so you should start up like a virtual m to install it or do this in docker or something but because this is just a ctf machine and i want the latest version now i'm installing it this way normally doesn't screw things up uh let's see we just did that so python3 sept up pi install uh well what is this this is because i copied something from hack the box's pen box let's see sudo okay and i think when you install it through get it's called cme not crack map exec so we'll have two versions of it that's still a 502 this one doesn't even run under sudo pip install dasher requirements.txt to make sure these libraries are for root again probably the worst way we could install this but it still doesn't work come on let's see new package or directory oh pie studio pip three there we go is that still pointed at python 2 which pip pip don't know how to check see me three eight third party pseudo cme let's see make this sudo okay it just wanted that directory there uh cme 51l okay uh let's hope this works dash capital m spider plus and we'll see if this does it awesome so what this is doing is um crawling this and calling every share we have access to and then giving us json output we could have used like um smb map we've done that in the past we could mount it to a disk and do it that way i just wanted to show the latest feature in crack map exec which i really like using once it finishes running we'll have it so i'm just going to copy the output file it log to and then we can put it here so this will be our thompson spider smb and we can see a pretty good list of everything i'm going to use jq to view this file just because i want to maybe there we go because it'll give us coloring but it tells us the file name and then modification dates um yeah so looking through this probably want to look over the email recycling bin a dc diag vnc install registry this is interesting so copy put this in and one of the weird things is this is an s myth we are a thompson so for some reason we can go in someone else's folder um map data drive this is probably going to be interesting so that's on net login uh shoot let's just copy this whole thing copy this wall that's group policy stuff so there's enough here for me to actually want to um mount this so i'm going to do make the mount data already exist is anything in here no so let's do sudo mount dash t cifs dash u oh no dash o for options user equals uh thompson password equals where is his password i'm just cycling through with aunt period to go through previous arguments and let's just go grab it again do we have this still no go here grab the password echo dash n base64-d ryan five ever copy paste and then we want to mount it to uh we gotta specify the mount so 10 10 10 182 slash data slash mount data uh what suit amount t user password oh i have t thompson her thompson okay and then the other one we wanted to mount was nat logon right yep uh pseudo and we'll do this one i don't think it had a dollar maybe at a dollar at the end no so this lets us view the two drive maps so looking at this i don't see a password here so we're gonna look at the other one every now and then when you see like um scripts that auto mount things it gives you a password oddly enough we got that cask audit i don't recognize seeing that maybe i just missed it because we didn't have read access over it but audit is definitely a unique directory so i'm going to make the mount audit and we're going to try mounting that get permission denied so let's go into the other share so we created data and we can do find dot dash name or just find dot python done dash type f and cd mount data i'm going to cat the email first i'm just doing it in a different pane so when i run this cat command it doesn't make me scroll up to get back to all the files so let's see this email let's just bless it let's see if anyone that missed yesterday's meeting main points are below uh ben missed the meeting so maybe there's a like he didn't update his password or something we should probably look at ben's account uh be using a temporary account to perform all tasks related to network migration username is temp admin password is the same as the normal admin account so let's paste that there this account will be deleted at the end of 2018 once the migration is complete so this is an old email and that's why we didn't see the username temp admin and like the rpc information because they deleted the account so let's go look at a different email or a different thing 80 recycle bin and we have to put this in quotes because there is a space in this path so let's see running as user cascade arc service moving objects to recycle bin so we have it deleted the account in 2018 so verify that temp admin did get deleted and we can look at the registry entry now dc diag i'm not really i mean we can look at it but dz diags dc diag it's not going to really have that much interesting information i think it's just the standard domain controller diagnostic tool it may have like the main trust information in it potentially but that's only if you have multiple domain controllers that would become relevant uh this is probably utf-16 formatted wonder vi will just automatically handle it yep so this is a tight vnc and we have a password that's jordan x so let's grab i password on this pass oh because it's probably formatted weird if we cut it now we can grab dash i pass what we'll just grab it so let's go to cyber chef and we can convert this from hex to plain text maybe there we go that was two let's see from hex and the output looks to be gargled up so this does not look like it is plain text so what i'm going to do is google type vnc uh was it registry password because there's a registry file password and decrypt and it looks like we got something here they're using metasploit dropping into the i forget what irb stands for but the shell we can just execute straight ruby vnc passwd dot pi try this oh god that is a lot of dependencies i'm just gonna do this uh msf thing because to decrypt a password this is a lot of files and i don't know exactly what that's doing so it looks like type vnc's uh decryption function uses a fixed key which is this and that is used to decrypt i believe so let's see and what i mean by that is vnc pretty much xors the um hex with a static key and because the static key is known we can just do that x or ourselves and get the password sort of grabbed it while i had it okay that password here msf console and i guess we can do msf db start is it sudo start i forget that command i'm just gonna do msf console um it's been a while to actually open up metasploit there's a command and matter split to start it i'm sure if you watched previous videos why i use it i do it but yeah so let's just kind of follow these instructions so we can do iob to interact with this mode and then fixed key is equal to that and i don't know why they do this okay require oh they're giving the output so they just yeah when i did fix key this it undid the hex and put this so that's all that did so now we can decrypt and what's going to be 6b six cf2a4b6e five a c a zero f and we get steve too so i'm going to do go up here i'm going to kill the brute force and instead of doing a password file i'm just going to do steve 2 and we probably have to change this to cme now because we did a bunch of python dependency stuff and we get a hit on s dot smith so we can try dash u s dot smith and change from smb mode to winrm i always like testing both smb and windows remoting we can also do another spider plus so paste this smb m spider plus to see if he has access to any different files and looks like we can log in with this account so evil winrm dash i 10 10 10 182 u s smith dash p st 333be2 copy we should do grads um thompson was it like r-y-a-n-5 eva maybe that was it but you should always log treads as you get them so on this box we can do like a who am i slash all to see what we have accessible to us let's see group names looks like we are in the audit share group also in it let's do net user thompson slash domain and we can see he's also in the it group but we'd look at our account this probably say audit or something i'm not sure if this shows all groups yeah so we can see audit share and remote management use this is why we can use winrm but because we're in the audit share group we should probably look at the spyder plus output as this user and see if he has anything in that audit file or audit folder so i'm going to copy this to i delete the old one weird smb s smith audit vsmb smith audit we can do jq actually so let's see we do have this audit directory and we have cask audit.exe so maybe cascade audit and then back in this data directory it looks like we have the same things i don't see anything else net logon don't see anything else sysvol i'm not going to bother looking at so let's look at the audit to do that i guess we should we could either try to find where it is on the drive uh maybe there's an audit directory maybe shares audit and we could do it this way and download but might as well just use um smb to copy everything over because we're going to want to probably reverse engineer this dll and exe so let's do sudo mount dash t cifs dash o user equals s smith password equals that 10 10 10 182 audit slash mount audit mount audit and we can run file taskaudit.exe to see exactly what this is and we see it's a net assembly there is a db directory so let's just take a look at this but chances are i'm going to want to switch to windows to analyze this file audit.db sqlite3 dot dump let's just see what's in the database uh ldap park service and this credential so this is probably why the ark service account has logged on the box today and it looks like this is probably encrypted because that's may not be a password although password length was set to five so it's not stupid to try it again so uh crack map exec smb 10 10 10 182 dash u arc svc dash p put the password in and we can see deleted user audit deleting things but can't log in so we should analyze this executable to see how it um decrypts that and if we look at runaudit.bat this says you can just execute kaskar.exe with the argument of where the database is so i'm going to do sudo and packet smb server smb2 support and then i think it's the share name so i'm just going to call this please subscribe and then the working directory of where i am now i want to do ifconfig e0 to get my ip address 209 and i'm going to switch over to a windows box and access the share and access the share whoops like that and we can create a folder called cascade this is going a little slow ctrl c to copy open paste then we can open up dnspy and file open doesn't look like everything's copied yet there we go we got cask crypto.dll since there's crypto in the name that's kind of where i want to start so let's look at the casc the crypto function and let's see encrypt string and then we got two things the plain text and the key so we're going to use aes set the block size to 128 here's a static iv here's the key and then we're using cbc mode so we can either just um write a aes function to decrypt this or we can go modify the code and just print it out so if you don't want to write anything because you're lazy like me you'll probably just open up the executable and find exactly where it calls that crypto command i'm going to guess in the main see decrypt string so the crypto module decrypt string and that's pasting the encrypted string this is probably getting it from ldap and then the key so cascade key 654321 so what we can do is set a breakpoint um i think it's just f9 there's probably one of those right-clicked options but to set a breakpoint go to start and then the argument probably we want to put the database so i'm in this cascade folder i'm going to copy the database here i'm assuming my uh path is just going to be the current working directory which is the cascade folder so now i'm going to do audit.db click ok and once it runs hopefully it hits a breakpoint and we can just step over or hit f10 and we can see the password here so we can just copy the value and it's welcome friend and that's got a few null bytes afterwards but that's probably just because of the block size and at wanting to end and something that's divisible by eight maybe so let's do echo dash n wc-c uh 13 and it had three null bytes at the end so just going into uh even block size so i'm guessing welcome friend is going to be the password for the ark service account so cme smb 101010 182 dash u arc svc dash p welcome friend and it looks like we can get in so let's go back to the creds our arc svc welcome friend and it doesn't say pwned so i'm guessing we could probably use when rm to go in uh let's just do yep we can so i'm going to get out of that user paste this password arc svc and i type in the password come on there we go so we do who am i slash all see all the privileges what we have and looking at the groups we're in the 80 recycle bin group so you can also have done net user arc svc to see this ad recycle bin and this group probably has the ability to query deleted items so let's do powershell query deleted items get dash recoverable items can we just run that not the name so let's see get 80 object do we have get 80 object i'm guessing we do so let's see delete objects equals user property stir sure let's run this except what to make a few edits so cn deleted objects this will be cascade local i hate these spaces okay let's see syntax error object class equals user oh looking at these quotes those are bad quotes they're angled there we go and we have two things we got temp admin here so let's see we got to find a way to get that auto size maybe cn equals temp admin that not found okay let's just see what happens if we get rid of this format table command oh that's better so now we're getting all the output so we have two deleted objects uh cask ws1 i'm guessing this is workstation one it's created january 9th and doesn't really look like anything too interesting uh we got the second one temp admin and it's got cascade legacy password here as well so if we copy this uh echo dash n base64 dash d we have bacterial noodles and if you looked at the email it did say that temp admin was the same password as the normal admin account so we don't know what the normal admin account is i'm sure if we did our pc client or looked at users.list we could guess which one the normal admin account is maybe not um yeah maybe util cme dash u uses dot list dash p but that s b 10 10 10 182 i wonder if that's not in the enum dom users yeah so we don't have the account yet so we could probably do net user administrator to see if that's an account it is i don't know why our pc client didn't have that dash you 10 10 10 182 noom dom users i knew i pretty much for the password uh cascade guest yeah we don't have administrator is it 0x500 i'm not sure exactly why that's not there but we don't have an account called administrator which is default on windows so let's just try that password administrator with that and we get paired finally with smb so we can probably just do ps exec administrator 10 10 10 182 and put this password in and looks like we have a shell in the box as system am i slash all so we could just go and grab that file so that'll be the box hope you guys enjoyed it take care and i will see you all next week