 what's going on YouTube this is if second we doing lightweight from axe to box and I'd really like this box because number one it's straightforward and number two it incorporated a lot of things we've seen in previous boxes namely the white puffy box with LDAP stuff and then waldo with linux capabilities which come into play on the first and third hop the first top tcp dump has a capability to allow all users to sniff the traffic and you can sniff a password off the loopback adapter the third hop open SSL has the capability to do anything so essentially it's a set UID binary unfortunately you can't use it to get a reverse shell but you can use it to read and write files which then of course you can get route from that so with all that being said let's just jump in as always the first step we do is add map with - SC for default scripts SV enumerate versions Oh a I'll put all formats Pawnee and map directory and call it lightweight and then the IP address which is 10 10 10 119 can take some time to run so I've already ran it look at the results we see just three ports rope and we have SSH on port 22 HTTP on port 80 and that's Apache version 2 4 6 and is running CentOS or santosh I don't know how to pronounce it and then finally we have LDAP on port 389 and this is exposing its common name which is lightweight htb we can figure out what version of centers this is by just searching for this apache version and I'm going to replace centers with Red Hat because Red Hat is essentially the paid version of centers and paid things have much better support than the free alternative so whenever ever centers problem I google for Red Hat so we see Red Hat Enterprise Linux 7 is based upon Apache version 2 4 6 and then if this was a CentOS 6 box I would assume we'd be seeing apache 2 - 1 5 so we know this box is relatively up-to-date so let's just take a look at what the web page has and then we'll also take a look at LDAP but before we do anything the LDAP results did give us the hostname of the box so let us just add into a host file in case that becomes critical so we do 10 10 10 119 and lightweight htb and then just lightweight so now a boss can resolve to either war so let's open up a web browser and go to 10 10 10 119 and then also lightweight HDB to make sure these pages are the same it looks like they are and we have something called slender and then we have a github link it looks like up there so we can see what this is a responsive and lightweight slider for modern browsers so this looks like it's just the source code to this and we don't really see any pages if we refresh the page right away we do see three pages but it eventually goes away so refresh look at what these are and then let us run go Buster the important thing to note is we know the page does have PHP files as we see the three extensions are PHP so I'm going to go over to go Buster do - you we're going to put the URL we'll do - w-4 word list user share word list - Buster um actually let's change it up let's not do dirt Buster let's use cyclist and then we can do discovery web content and is there any PHP we have PHP fuzz text let's take a look at what this file is real quick I'm just looking for like PHP file names and it looks like I don't want that so let's do CD user share cyclist discovery web content OS grab - I PHP and I'm going to do common PHP file names so let's do less on this file we see it's already appending the dot PHP extension for us so I'm going to do CD - to go to my previous working directory I'm going to do go Buster - you HTTP 1010 10 119 user share cyclist discovery web content common PHP file names and I forgot to do dash W and then we'll just let this run so we see index dot PHP user dot PHP info dot PHP reset dot PHP I don't know if we found reset dot PHP here we just have these three so we can also add reset dot PHP and see what happens so reset and we're not getting a response and it looks like a go Buster stop getting a response as well it so my guess is we've probably activated some type of like denial of service protection as the web server is now blocking us so if we try to curl 10 10 10 119 we can't get to it port 80 is rejecting the connection even if we run an map - P 80 10 10 10 119 we do see it is filtered which means the web browser is no longer sending us any packets back it's not even sending us a reset which is indication that iptables has blocked us so while we'll block let's see if port 389 which is LDAP is open it is so it looks like a block is only on port 80 so let us just do some enumeration of LDAP and see if by the time we've done this it unblocks are at port 80 so let's check for anonymous authentication with LDAP search - X - H 10 10 10 119 and it looks like this does return fine we just see result 32 no such object because in order to enumerate LDAP you need to know what the root DSC is which is essentially the root domain of LDAP we go into a lot of this in the Y puffy video so I'm not going to go over it again if you want to you can watch that where we Wireshark a and map script that does this and then analyze how it works so we're just going to know that we need to specify the search scope basse the other options would be like one sub and children but base is the one we want and then we want to get the naming context which will show us the route DSC and we see that is DC for distinguished I don't know what DC stands with but anyways DC lightweight DC htb so now we can search this LDAP branch or whatever it's called so we can do - B and then put this in quotes and now we dump the LDAP so going over to the top we have information about the domain the manager we have the people oh you and then we have LDAP user 1 and then a password we have LDAP user 2 and a password it's a shadow account so this is telling me probably going to be something along the lines of a local login so I'm just going to copy this split my pain v hashes paste go up here and copy that second line of that paste let's go to a new line get this next one I'm sure there's a better way to copy this but I am lazy and this doesn't take too long I need be here so I can copy paste copy paste and now let's keep going down that is LDAP user 2 and LDAP ode up user 2 is that and we also have LDAP user 1 and 2 yet again this is POSIX group not calling it shadow so it's a slightly different user object and then we have these passwords as the same so I'm only going to copy at once and that is the end of the command so let's put this line here as well and we see everything is beginning with the same e 2 and why X and this looks like it is going to be basics t4 because of the character set we just see numbers and digits and some end with equals so I'm going to do base64 - D hashes and it looks like it is indeed base64 I wonder if we can put a line break in this no we can't so let's just cat hashes and then we'll base 60 on base 64 at one at a time so copy this base 64 - D that's not the command echo - n the hash pipe it - base64 - D and we see this hash is crypt then dollar six dollar 3q whatever another dollar and a password so this looks like is going to be I think that's sha-512 encoded for local Linux or whatever so let's copy this next one but before we do that let's send this into the file called hashes dot shadow will do echo - n base the hash base64 - D it looks like it's the same so send that over to hashes shadow and let's do the final one so echo - n base64 - D and we just get cryptex so we don't really have anything so let's go into hashes don't shadow and mainly put a line here because it did not do it for us and then we want to delete this crypt thing because shadow passwords only begin with that algorithm so I think that's six characters it's seven miscounted there we go I just hit 7x to do a remove character seven times so we can save this file and I'm going to send this over to the Kraken and start cracking this and then we can check if the web page is available so let's do SSH Kraken and then V hashes wait we have to go into the hash cat directory and then V hashes lightweight dot I'll call the shadow paste it run hash cat with example - hashes which prints out all the hashes and then search $4 $6 and we see that is sha-512 tripped that is mode 1800 so we can just do dot slash hash cat - mode 1800 the hash file which is hashes wait wait shadow and I'm just gonna do opt weird list rock you dot text and this probably won't complete because sha-512 us actually take quite a while to crack so I'm just gonna make sure that starts and then we'll go and poke at the webpage there we go hash cut has started and you can see even with my 410 80s oh it's only gonna take six minutes so a bit quicker and then I had expected so I'll run through rock you and then see what else we can do but let's go and enumerate the webpage while that works and I'm going to rename this window to Kraken so or maybe rename that pain whatever it's called so let's go back to Firefox and check if we're still blocked so 10 10 10 1 19 doesn't look like we are so let's go take a look at what info status and user is I had already opened them up so we can't do any automated brute-forcing so let's just read these contents so let's see as part of SDLC which i have no idea what that is probably a company name we do have a thing mentioning the server is protected against some kind of threats for instance brute-forcing you try to brute force you may be the end for up to 5 minutes so if we had read this we want to know not to go Buster it list of banned IPS is on here which is the statuses page if you like to get into the box then go to the user page so I'm going to check the user page and it tells us the server lets you SSH in your IP 10 10 14 3 is automatically added the user ID and password with a minute of your first HTTP request we recommend that you change your password once you log in so let's try SSH into this box with our IP address SSH 10 10 14 3 at 10 10 10 1 19 and wait for the SSH to give us an authentication prompt and then we'll put our IP address again for the password and it lets us log right in it tells us to change a password but hey we're lazy I'm not gonna worry about doing that we do it LS we don't really see anything oh SLA don't see anything and the cat Etsy passwd to see if we have local users in the box or it's doing some type of LDAP authentication and we do have local users on the box something interesting is there's also a account for one 27001 if I go CD home one 27001 we get permission denied but I'm gonna guess his passwords also the IP address so I'm gonna check that out with an su to switch users to him and we forgot to specify the username so 0 0 1 1 27001 as the password we get it as him and his home directory is the same exact thing there is a dot config directory so let's check that out and I think that was in our directory as well and we do LS there is a B or T I'm gonna file against that to see what it is it is a directory os LA and now we are empty so I'm just gonna do find - type F which will find all files and I think also show hidden files and we don't really see anything so there is a last notification and cache if we file against that it is ASCII text we can cat it and it looks like it's probably an epoch timestamp so we can run that find command against a current IP address so find - type F and it's the same exact thing as one 27001 so I'm at a complete loss right now and when I'm at a complete loss I do a bunch of reek so what's run linen oom so opt when a noon and the one important thing that I change in linen oom is I said thorough equals the one at the beginning because there's a bunch of thorough checks that are helpful so I always like setting that there so I'm going to copy when opt Linda noon when a new message to my current directory and I don't want to make a dub dub dub and we can move linen oom in there go in dub dub dub and then Python simple HTTP server port 80 and we can curl ten ten fourteen three then Lynne a new man Sh pipe it over to bash and let this run it has now finished so let's go to the very top of a command by searching a terminal history for Lynn a Noom and then we can search down for bracket - bracket to go to each header we can see thorough tests were enabled colonel information it looks like this may have been compiled around the time of the box release so I'm not going to worry too much about this we do see centers version seven so we are correct when we guessed it based upon the Apache version hostname lightweight htb users groups users that have previously logged into the system route odep user - so we didn't walk in with these that is definitely interesting so something to keep in mind this looks like it is also from maybe tests in the box because it's Friday November 16th and then this one of course is us and this is of course us which is today so we can see who else has logged on right now no one users of the box we looked at that looks like we have some ATM users not concerned a passwd we've looked at that permissions on home directories it doesn't look like anything is relaxed we have the owner of the directory has readwrite X Q groups and everyone doesn't have anything so looking at word readable files nothing interesting environment variables not too interesting selinux is enabled and in enforcing mood so that is interesting going through these nothing there cron jobs looking through it looks like everything is default so nothing to see there cron jobs last executed nothing to see system D timers we see something past 33 minutes ago and it's got 23 hours until the next check so nothing there the network and IP information the address is network adapters ENS 33 and lo4 loopback ARP history we don't really see anything there so we know there's no like docker containers or anything where boxes that talk to this name servers quad 8 which is the I think Google listening TCP we have four four three three eight nine I'm 111 and 80 I don't think we saw 443 open so it looks like iptables is definitely on the box we may want to do like ipv6 and see if we can hit it hit this box over ipv6 and potentially get to a different web server we can also potentially enumerate the Apache config as a low pro user to see if any virtual host exists UDP 806 port 806 that is interesting I don't know offhand what program is listing on that running processes T is currently running so that may be related to the web server I'm not sure exactly what that is T takes standard out and directs it to a file we keep going down sudo Apache Apache modules that would have seen the Apache module installed on Crimestoppers useful file locations can we add read write files su ID files it looks like everything is normal I don't see anything I don't really recognize good files don't really see anything I don't recognize fouls with POSIX capabilities and we have TCP dump running and let's just these extended permissions let us run TCP dump as root which means we can capture some packets so that is definitely good to know if we had pseudo access to TCP dump we could have just went to gtfo bins and searched for TCP dump and being able to execute commands but since this is using Linux capabilities and is restricting us to cat net admin and cat net raw we can't execute commands as root because TCP dump doesn't get that permission as root if you want to know more about these extended capabilities check out the water machine because I think there's the first time we've done it but we have TCP dump so let us start some captures so I'm going to rename this pane to SSH and then create a new pane to do our packet captures with so now let's do SSH or username which is 10 10 14 3 and the IP address of the server which is 10 10 10 1:19 I'm gonna run TCP dump - I yen s 33 was the network device - you this is gonna prevent it from doing a bunch of buffers if we wanted to we can do man TCP dump and then look for - capital u and you can see exactly what it does it'll cause the output to be packed buffered so the output is written to stand it out at the end of each packet instead of each line so that's just gonna help us a little bit there then we can do - s0 to capture everything there's no limit on the size forget what the default is but I think it may be the headers then we're gonna do - W - and there's gonna write it - stand it out so the handy thing with this is we don't have to create any files on the box we can just do everything and command had not found TCP dump I'm gonna call lies cuz I know TCP dumps there so let's just do which TCP dump and use the full path which is user s bin so let's do that and see if this one works but as I was saying this will let's do a TCP dump without actually touching the disk of the server and once we prove that we can do that we're gonna direct it to a file on our box so my password in and we can see we're doing a TCP dump and holy cow it's a lot of information we've got one critical piece which is not port 22 so we don't capture our ssh traffic so let's do that and now direct this to a file we'll call it network i will call it lightweight dot e NS 33 cap and we'll just have to enter the password which is the same as our user name 10 10 14 3 and we see it is listening on e NS 33 so if we split the and do y - K - K just means it's going to start it immediately and then we can do lightweight ENS 33 cap that will open up wireshark what is oh oh this isn't a well I've captured so we don't need to SK so - case for live captures we can see I guess nothing is there yet so let's send some data to it so I'm going to send it to the info page the Status page and the user page so now let's do Wireshark yet again and we see data so the thing I'm mainly looking for is what the server does because we know this actually creates a user via LDAP or does something so that's the traffic I'm trying to see is the server actually doing that and I don't see that all I see is the actual us requesting pages we can follow each thing and the TCP stream and see yes this is indeed or a box so I'm going to close out of Wireshark and we're going to keep that one caption running and start another one so ten ten fourteen three at ten ten ten 1:19 and we'll do the same exact thing except instead of E and s 33 we're gonna do ello for the loop back and then instead of writing to a file let's show Wireshark - K - I for the file and we're going to specify - which means standard in so - I is interface for Wireshark not file so the interface is standard in so we are on loopback sniffing we can put a password and we see we are indeed listening where I sure didn't show anything but if I do a paying localhost on the box we can see indeed that like magic it appears over in Wireshark so let's go refresh all the pages yet again and see if we see anything and if we don't then I'm going to try this reset dot PHP but without knowing what reset dot PHP does I don't want to just blindly execute it because it may kill a bunch of sessions change our user names etc which would also destroy the Wireshark so always be cognizant of exactly what scripts you are running and now we're shook showed us a bunch of information and it shows the source 10 10 10 119 the destination the same IP 10 10 10 119 did a bunch of LDAP requests so I'm gonna do follow TCP stream we can see odep user to its group as people DC is lightweight HT be authenticated with 8 bc whatever so if you did not know that you can also drill down and map to see exactly how that's formatted so clicking the down arrow a bunch of time we see the user odep user - authentication simple and then the passwords so I'm going to copy and I think I want to copy the value so let's go back over to terminal do SQ - LDAP user - and paste the password and we'll see if it lets us in authentication failure of - 0 and ends with - so I don't know why - 0 is in my clipboard but I'm just gonna copy up - - because this is what why sharks saying that 0 is not there so maybe I goofed up somewhere so let's copy that do that su again login and we have one failed login attempt but we are odep user - so we do have a backup dot 7-zip so I'm going to see if I can netcat it over my box net cats not on this box so we could try SE peeing it so we could just do like SCP LDAP user to backup dot 7z I think it was the hostname 10 10 10 but yeah 10 10 10 119 and then the file backup dot 7z copy to a current working directory and I need a specify LDAP user to paste the password in and let's see permission denied what do I have my clipboard LDAP user - I wonder if this user just can't log in over SSH so instead of doing SCP let us just transfer it over something other than netcat so we can do cat backup 7z and direct it to the file dev TCP 10 10 14 3 port what do 9001 because you got to be over 9000 to be cool so let's just make adder files and we will do net cat LV NP 9001 and direct this to backup dot 7z so I'm going to run this command and it sends us the file so this is a 7-zip file so we'll do 7z X backup 7z and at once a password I'm just gonna try password and it fails to decrypt it there are a bunch of files in this so if we try to do zip to John on backup it fails so I'm gonna do locate what was it 7z - John and we do have a perl script and I'm gonna run this against it but before I do I'm gonna do history grep I think lzma and you have to run this command I don't think this package is on Kali by default so if this 7z - john dot PL file gives you an error try installing this package so we'll run this against backup doc 7z and get a giant hash so I'm going to copy this to my clipboard by entering edit mode and then just highlighting everything enter and now I can go back into my Kraken and we see it did not successfully crack any of the sha-512 hashes so let's do hashes backup 7z I would do lightweight dot backup or lightweight 7z at the file name and then paste so we got the hash here hash cat generally doesn't like the something : like user name colon that so I'm just gonna start off straight with the hash and then we will run dot slash hash cat example hashes and then search backwards for a 7z and we can see the format is that mode 11600 so let's run - cat - m 11600 the file or the hashes file which is hashes lightweight 7z and then we'll do the rocky word list now that - cat is stirred in we can do status and see just how slow cracking 7-zip can be and that sha-512 crypt that you saw took six minutes says it's going to take my computer 32 minutes I think the passwords near the top of the list so it shouldn't really take that long but gives you an idea just the strength of this encryption algorithm versus the shadow file 7-zip encryption is relatively decent and we see that hash cat has just cracked it and the password was delete so if we scroll up we can see right here delete is the password so let's go back to a shell on a box it is in files and we can do 7z X back 7z type delete for the password and it did not air this time and we have the password to all the files so let's look at reset PHP and I'm actually use vim so I have the syntax highlighting and we see a reset request has been accepted for the account please we have to admit it your account will be deleted and added again and let's see it's grabbing server dot remote address to do a file put contents so that looks just fine we could potentially look at exactly how this address gets created if it's affected by like the host header and if it's affected by the host header maybe we could delete and riad root but I don't think that'll be the case so let us look at the next file let's look at status dot PHP and we can see user name LDAP user one and it's got a password so we don't know I would app user ones password until now so this is a new account so let's grant password from status so we can easily copy it and then try logging in with LDAP user one so let's go back to SSH and do su - whoops I wanted su - OH - user one paste the password and we get walled in looking at this directory we have captured pcap Oh Deb TLS PHP open SSL and TCP gnome so let's do get cap on star and we can see TCP dump has the same exact capabilities as the other one but open SSL just has equal TP so to understand capabilities we can do man capabilities and then you could read this whole man page I'm gonna cheat and search for empty capability maybe it's not in this one let's do man capabilities on my box if I could type capabilities and then search for empty capability we could see what happens it says note that one can assigned empty capability sets to a program file and thus it is possible to create a set user ID root program that changes effective and saved set user ID for a process and executes that program to zero essentially this is a long way to say that if you have EP which stands for let's see if we can pull it up real quick it stands for effective and permission I believe but if you have a blank one as in let's see where's my window where sha-2 if you have a blank one which means it doesn't have any permissions tied to it it is all permissions not none so we have all permissions with this capabilities module to do whatever we want so let's go back to GTFO bins and look at open ssl so we'll do open ssl and there's a reverse shell file upload download write read seward or set UID or sudo let's look at reverse shell and sudo so sudo it looks like it's doing let's see calling bash over here and then i don't know exactly what it's doing so you know SC which open SL no foul right oh I honestly haven't done this and not sure what it's doing so looking at the reverse shell we can see the reason why this one won't work is because open SSL probably won't execute then Sh if the execution was within an argument then we probably could but since it's not it won't work and I'm gonna stare at this again real quick so let's see only attack a box run this communication between attacker and that bead cryptid Ice Age which open that cell I don't think this will work without sudo yeah this is doing the same thing as the previous one so 99.9% sure that won't work let's just do file reads which is a bit easier now old file equals file to read open s cell and code or ENC I don't know any NCS dance but I think encode input file L file so we're not going to set the variable we're just gonna do it manually so to verify let us do open SSL and C n let see shadow because we can't read shadow unless we root and this probably has to be lowercase and we get a permission error and the reason why is because we look at which open SSL we are running out of been open SSL if we do get cap on then open SSL we don't have any extended capabilities so we have to do the previous command with dot slash to run out of the one in our home directory and now we can read the shadow file so let us see if we can read the sudoers file we can't but we can do let's see sudo errs and let's see wheel all so let's copy this to su doors OS la we can see that we own it because again when you do things like this this is not taking the file permissions as this command it takes it as your current user so now we can do VI su doors and edit this file so let us do instead of wheel all we can do LDAP user one actually let's do because I don't remember that password I know how to get it and let's just do 10 10 14 300 and then exit that and we can do open SSL and we want to do file right so let's see how to do this echo data and then opens l and l l file so we can probably just cat the file and then specify it with - out so we can do cat dot slash new doors pipe it over here instead of - in will do - out and we can do - in to read it again to make sure we made the change we did so let us go to a SSH session a new one SSH 10 10 14 3 at 10 10 10 1 19 and the password again is going to be 10 10 14 3 and then we can do sudo - L and we have an error so we accidentally screwed up a config so let's go back here the su doors and let's see what do we do how do we specify a username oh we have root right at the top so let's whoops 1 - hi yank this with y put with P and I'm just gonna do LDAP user user 1 and we'll try this one so write save and then let's cap this again write it and let's just do sudo - L and the password that is in the backup file so let's do cat stats grant pass we can grab this go up here paste and now it worked so I'm going to test something real quick cuz I'm not sure why the last one failed I thought that was corrects index 10 10 14 3 so let's see if I indeed screwed something up so write that file go back to this SSH sudo - L syntax ER near line 94 so not sure exactly what's going on there so let's edit this file again line 94 is indeed this line maybe it doesn't like periods in a username or something weird like that but we can now do sudo su and we our root at lightweight and do LS la and confirm WCC root text yes we can read it so that is the Box hope you guys enjoyed it take care and I will see you all next week