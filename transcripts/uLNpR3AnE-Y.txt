 what's going on YouTube the Zips I'm going to in sama from hack the box which is just a Windows box with a web server and Active Directory installed on it we've done plenty of 80 in the past the videos that come to mind a real active sizzle and forest the thing that really sets this one apart is you can't just use our PC client or LDAP to dump all the users on the box instead we can kind of do a boolean logic to check if a user exists through Kerberos pre authentication essentially you give it a username if the Kerberos responds with pre authentication required you know that user exists on the box so we're gonna go through the website of the box pull a bunch of names off the site and then use a bit of them magic to convert those names into possible user names pass it into a tool called curb route to find some valid user names and then with those usernames pass it to some impacted scripts to do some AAS rep roasting to get a password hash of an account pass it to hash cat crack it login to the box and then once you log into the box professing is simply running bloodhound and wind peas combining the two outputs and you can DC sync so it probably sounds a lot more complicated it is so let's just jump in and as always we want to start off and maps or - IC for default scripts as V enumerate versions okay I'll put all formats put in the end map directory and we have to create it create the end map directory and then we can call it sauna 10 10 10 175 I always want to run and map with sudo and then I'm going to add a dash V flag so we can see open ports as it finds it we see 80 is open which is going to be a web server 53 DNS a bunch of like SMB or a PC ports I don't know exactly what 3268 is don't know what 593 I think 636 is encrypted LDAP we see Kerberos down here so based upon and staying for four or five which is SMB so we know there's a Windows box 53 DNS and 88 Kerberos I'm guessing this is a Windows domain controller so the very first thing I want to do is probably enumerate for four or five and then we'll move on to port 80 so let's do crack map exact SMB 10 10 10 175 to see everything about this some host we see the host name is going to be sauna the domain name is Igor testicle - Bank local signing is set to true and SMB v1 is disabled so let's do - - shares to see if we can enumerate any shares and we get a status user session to lead in we can try a blank username password to see if this gets around that sometimes it does sometimes it doesn't and we see access denied cell we can't we could try other tools like SMB Matt I think it's - I 10 10 10 175 - you - t - H run this and we don't really get anything so good go and try a bunch of SMB tools but if track map exact and SMB map don't get anything generally move on we can try our PC client 10 10 10 175 and we can't connect let's just do a blank user it's - capital W and then I think it's a new Dom users to see if we can get a username dump we get access denied so can't really do anything with this the one thing I want to do is start creating notes so let's do ctrl n to create a new node call it sauna control-shift-n for child node call it notes and then I'm going to copy the domain egotistical - Bank local and we'll paste that in here and we can go check out the web server 10 10 10 dot 175 so looks like a standard page I'm gonna press control U and we're gonna see if we can identify what like CMS or how this is built if we saw like WordPress or Drupal stuff we know to run those type of scanners but I don't really see any of that the next thing we could probably do is try to guess the extension so probably index.html we got that we could try PHP not found ASP aspx so it looks like it's HTML files if we did have this in burp suite we could probably just have crawl it and then identify files that way so let's turn intercept off refresh the page go over to a target and then we could just look at files this way and could also maybe possibly scan scan spent so long as I use the new version of groups we don't mean to launch a crawl but go through and see if we see any extensions but everything is just HTML so click on the pages see if we have anything unique just looking for ways we can interact with this so there is this newsletter here so we can put our email address so I do like oh my god is that so the color is white on white for some reason so we're just gonna put please subscribe at Epps a Crocs highlight it so you can see it click subscribe and HTTP verb used to not allowed so let's go to proxy intercept I'm guessing this was a post request and maybe post just isn't allowed so send we get method not allowed this is verb it's like get post head options there's a few of those verbs so let's change the request method to a get request and doesn't look like anything happened so I'm looking at the paid bytes at the bottom so 3 1 2 2 3 just making sure that doesn't change and let's get rid of this email so 3 1 2 2 3 3 1 2 2 3 so I don't have to read this whole thing I can guess the page is probably the same so doing that just did nothing so we can just move on from that let's see let's go all the way up click around blogs close could have something useful single dot HTML are these all the same yes it is so this is definitely some type of static website so this looks like different post clicking on these post we go to the same single dot PHP page so at this point I'm assuming this is just a static page and we have to just get some type of valuable information off this we could run cool which is like going to gather a word list based upon the webpage I bet if we just do anything here it's going to go to invalid verb invalid verb cell nothing there so good run cool and grab information off this but if we had a password list we don't really know an account yet so let's see if we can find user names on a page so maybe the about Us page and we have users so let's copy this go over to Cherrytree control-shift-n users paste it doesn't want to paste so let's Windows key L to put down the left oh god it pasted all the images and everything but windows key alt left they put it on the left I did windows key right here to put on the right and it'll just make it quick you copy and paste so let's just copy the user names this way Oh God control a delete paste copy paste copy paste copy paste so now we have a list of potential users we have to convert this into use name formats that Windows generally uses so let's do this uses dot txt and we could also try searching LDAP because Active Directory does expose LDAP so we could do LDAP search - X - H 10 10 10 175 we have to get the naming context or - a space naming context and we want this string we can do - B and query LDAP manually and if we're lucky we could potentially get user names but it looks like we don't have that permission if we had if it was allowed for anonymous LDAP down here you'd see a bunch more information for like Sugar Smith which is a user I believe we'd see something like this right here what is this this is DN let's just grep - I for Sam because the username and active directory is like a SAM account name but we don't get that so this doesn't really tell us the username format Howard apps not giving us anything so going back to that users txt file we could create a Python script to transform this into a bunch of potential user names but whenever you do like a CTF or you under a time constraint you don't always want to script and sometimes it's handy just to know how to use the tools you have so I'm gonna use a them math grill so we're gonna start the macro off by doing cue a and that means record this macro and is going to be on a so I'm going to start this macro off with YY to yank the line and I want to change this into probably three other things so I'm gonna do a 3p to put the line I just yanked three times so we can see if we're good Smith is now got four I'm gonna hit home just so my cursor is always gonna be at the beginning slash space then s period escape so that fix that one spot and get the down arrow home key again right one dw4 delete word go down one hit the HOME key right one d-w-i for insert period to put a dot there hit the down key hit the home escape to exit insert mode and cue to exit recording mode so now when I do at a it replays all those keys I just did to them and then we have four more lines so I can do four at a to repeat it four times and now we have a really nice user list of everything we saw so WQ to exit and I'm going to go grab a tool called um curb root which 0 xdf pointed out to me because this does a Cobra spree authentication attack against it ad and this can help us identify valid users so essentially when you attempt to authenticate to an ad server via Kerberos if you have a valid user name it's going to say hey please continue with pre authentication if you don't have a valid user name it doesn't do that and that's how this attack essentially works and then you can also do route forcing passwords with this and the cool thing about it it's not going to create event code 4624 it's going to create a Kerberos failure thing which by default is not so it's a good way to brute-force accounts with potentially just not being seen it does increase the failed login if they have that locked out you can lock accounts without with this it's not bypass to that it's just a way to do a password spray without creating that event code 4624 but when I can do a password spray with it we're going to use it to enumerate valid user names so I'm just going to download it you could clone it and build it yourself if you wanted to and I'm going to copy that into my directory chmod plus X and I'm just going to rename it because I don't want that when X amd64 but when we execute it we can see all the modes what you want to do user anoon so we do user a new mesh H and see the flags so use a name word list is going to be users text but before we give it the word list let's tell it where the domain controller is so - - dc-10 1010 175 - d which is the domain egotistical bank dot local and then now we can do user dot text and we don't find a single one so let's go into user dot text and let's create something that we know exists like and use a card administrator we could also do guest because these are default windows accounts so we should get always get hits with these accounts so we can see a curb root script does work because we validate an administrator at egotistical bank dot local exists so let's see if we want to do any more permutations on the name and right now I'm noticing that there's a space at the end of every line the dollar sign just means end of line the space means well it's a space so let's do : % s space dollar sign and that's going to search for anything that has a space and then end of line do another slash so replace it with nothing and G to make it global so now we removed the trailing space from all the lines let's go and run this again and we get two valid users administrator and F Smith so let's go to users and we can say administrator F Smith so we know those to a valid and at this point I'm gonna check the impacted scripts what we can do with user names and to find my location in bakit I always just do locate PS exact PI because I never can remember this example directory but I highly recommend if you don't know all these scripts go through each of them and just like add exact - H less and read this description to find out exactly what they do because there's two scripts that is super valuable it's get NP user which is going to be the AES rep roast or some people call it Kerberos thing but this is the a s rep one and it queries the target domain for users that do not require Kerberos pre authentication set and it can export their ticket granting ticket for cracking and another good one is get user SPN I think this one's set if it's stored password reversible format I'm not exactly sure what that one is but definitely take a look at all the impacted scripts there's definitely really good ones there but this is the one we want to use probably so let's do target so this will be egotistical Bank dot local slash administrator and the next one will do is F Smith and let's see do we get anything it's taking a while so I'm just going to do two egotistical Bank political slash F Smith and it doesn't look like it's working oh we probably should at this point add the domain to our DNS so sudo VI Etsy host 10-10-10 175 egotistical bank we can call there also sauna and sauna egotistical bank so now we say we cannot authenticate to administrator can't do TGT user administrator doesn't have that set so now let's try F Smith and we can get the PG T and we can crack this because the encryption key or signing key for this is going to be the user's password so let's go over to a crack and machine and you can just use hash cat on your desktop I wouldn't recommend using hash code in a VM ever just because cracking is generally a CPU a GPU intensive process so doing it in a VM where you are constrained generally doesn't work out well so VI let's do hashes slash sonna paste that we could do dot slash hash cat - - example hashes grep for what was it can be I will just grab for a s rep and look for 23 a s rep so we have it here it's only one format so I can do less a s rep let me see mode 18-200 so let's do dot slash hash cat - M 18-200 and the word list which is going the hash file which can be hashes sama and then the word list we want to use first I always use opt for list rocky text and we'll see if we get any hits we got one crack looking at it the password is the strokes 23 so let's go here creds or was it f Smith The Strokes 23 so now let's see what we can use with this so I'm going to do crack map exec SMB 10-10-10 175 - u F Smith - P The Strokes 23 and we can see it is valid but it doesn't have pwned to it so we can't just PS exec into it I'm gonna do - - shares to see if there's any shares we want to go enumerate this should tell us if we have write access to anything and just list them in general I guess okay I was gonna say that looks like it's taking a while we do have a printer that's money we can print money oh we can't print money but can copy this notes paste that Oh such Boyd Rico some reason I remembered being yeah local Prive esque with this where does the state search Boyd - X 2019 let's go back to this page let's do it w get on this image exists tool on about that HTML so about that HTML was created February 10th which is probably around the time this box was created and the RICO probe asked we saw was a 2019 CBE I'm just going to local prevx put a note for that cuz that is definitely interesting we still don't have a way to get shell in the box so let's go and try win RM for windows remote and this will tell us if we can get on the box come on sometimes it takes a while to run let's see and it shows that we can indeed get on the box so evil win RM I think we give it - I for IP 10 10 10 175 - you four user F Smith beef password The Strokes 23 and here we are so let's go and run win peas so let's go LS opt privilege escalation script awesome sweet when T's when pzx see it's under think wind peas again bin release Wendy's exe let's just copy that to a current directory and then we can upload win peas dot exe to upload this power to the box and now we can run it so dot slash win peas exe and let that run and while that runs I'm going to go check out Rico risk so let's see opponents and printer setup so maybe we should run this command so it's abusing a create file and there's a proof-of-concept so we should probably try this let's see copy this and evil win RM let's get a second shell to this so we can run that I cackles command to see if the vulnerable driver is on this box now is not the command I want to run still not let's do control shift insert there we go oh can I find the path CD backslash program data dir I don't think it exists should have a reco driver and we don't so don't know what that's doing there could just be a something the creator I think egotistical wanted to do and then decided not to so let's just move on and notes we can say the directory does not exist does not exist so let's go take a look and everything let's just go to the very top there we go see what it shows so we got powershell 2.0 so he could probably evade any type of logging if there was by just going to that lapse is not installed w digest not enabled so far nothing is sticking out no AV UAC and we have Auto logon credentials with SVC load manager and this password so let's go create creds SVC loan manager put this password and I'm just going to go quickly saying if I see anything like and read highlight yellow font because that would mean definitely should look at that and we don't see anything so let's do net user SVC underscore loan MGR / domain this will tell us like what groups it's in and what it is so it's in remote management user and it's just a domain user we can try our account which is F Smith same thing we can do net user slash domain and there is a H Smith account so let's just look at what H Smith is a member of just the main users doesn't have that remote management so even we had his password can't really do anything this password expires or it's already expired let's Jack loan manager how is that configured password expires never so let's go and run bloodhound and I don't think I've ran bloodhound since I switched to parent so the reason why I'm going bloodhound is because it is Active Directory so ya gonna install bloodhound first with sudo apt install bloodhound yes and then we're going to get search Google github bloodhound to quickly go to the bloodhound page because this is the best place I found to download the ingest errs if you don't want to compile it yourself so we can download show pound ax C and doesn't look like we want to download one if I can just copy the link W get met so we downloaded file shut pound come on Tim was lagging a little bit is a executable so we can go back to a shell upload sharp pound dot exe and then while that we can launch bloodhound but I need to run this well but I don't have to run this one with sudo near 4j we're gonna have to start so sudo neo4j console let this start and then we have to change the password in bolt so let's go here and then username the default password is also near 4j so let's just put the password of please sub and now when we go to bloodhound put the password please sub we should be able to login there we go bloodhounds kind of picky sometimes when you type it doesn't try to reconnect and if it doesn't get a valid connection don't know what you click that log on button if you ever forget the neo4j password I believe you just delete the a file in here let's see LS comp data databases let's see preset near fridge a password near fridge a star I guess I can just follow those there's normally a file I'd normally just deleted and I can't find that file but password is please sub I'm sure the next video I'm going to have to find a way to reset the password because almost likely forget it so we uploaded to uh pound we can execute show a pound and this will create a zip I'd use the these collection methods group sessions trust ACL so let's do download this file then we need to go places home to open up a file browser go to sauna and then we can just drag and drop on the bloodhound we can see it is now processing and the first thing I always like doing is marking my users that I have as owned so I just searched for SVC learn Merck user has owned and we want to mark F Smith as owned as well and we can you see click here queries short of pass from principles and let's just check each one this is just showing we can PS remote to the DC not doing anything else so let's check the F Smith principle same exact thing find all domain admins only administrator shortest path let's see Enterprise admins we're not in that group administrators not in that group and this user so nothing here helps principles with DC sync rights Oh God let's weird graph but let's go over this administrator nothing this is the box itself we got this one SVC loan manager so we can click on the edge right click help and says the user SBC loan manager has the DS replication get changes all privileged on the domain individually the edge doesn't grant the ability to perform perform the attack however in conjunction with this right they can perform it and if you look at that second one get changes that is most likely that right come on sometimes it's hard to click on the edges but abuse info if we want to run mini cats on the box we could but impact it has a DC sync tool as well so we can just run that tool so let's go first create a new pane you don't need this pain anymore so we can do secrets dump PI egotistical Bank local /sv see loan MGR 10 10 10 175 and let's copy the password so whoops we don't want that yet essentially how secrets dump works it's just secret dump and then a username and then at the target so egotistical - Bank local that's domain SBC loan manager that's the user at 10 10 10 175 which is the domain controller paste the password in and we can see it doing a DC sync and essentially what this attack is is it's saying hey domain controller I'm another domain controller in order to join the domain we need to sync passwords so send me all the hashes and stuff so that's essentially what DC sync is and that lets us get the administrator hash and we can probably use this to do a pass the hash attack so we can do crack map exec - you an administrator - P or I think - capital H for hash so let's try this first ten ten ten one seventy-five come on and we can see it says pwned whenever it says pwned we should be able to do PS exact so let's do the same thing let's just go to a secret stump command erase that and do PS exec PI and change it to be administrator I've got PI twice paste the hash Oh I copied pound let's copy this validate that's my clipboard Ronit the exact pi - h let's see is there a special thing for a hash - hashes try this question shares so the format for - hashes is let's see land man hash ntlm hash and this is actually like that aad 3b thing that's let's see this which is the land man hash of nothing Windows doesn't really use this anymore and it's not part of the authentication you can either authenticate with land man which is disabled nowadays or ntlm and since the tool is asking for both since it's not going to use land man I just always have the habit of pasting the ntlm twice so with this we can now go to CD backslash users administrator I can type desktop and get the root dot txt so that'll be the box I hope you guys enjoyed it take care and I'll see you all next week