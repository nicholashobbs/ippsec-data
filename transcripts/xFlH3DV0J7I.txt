 what's going on YouTube this is ipsec and this video is pretty much just gonna highlight a feature of canarytokens.com and that is to create some registry entries to monitor when certain commands are in and send an email now the best way to do this is not with Canary tokens it's with like installing sysmon to monitor commands sending all that to a centralized log instance like elastic or Splunk and doing all the monitoring there because it gives you so much more this is for the budget people that don't have that setup don't have any infrastructure or budget or things like that and just want a quick and dirty way to monitor when commands like here Ami VSS admin wmic Annette Iran to do things so with that being said let's just jump in so here we are on a freshly created domain I haven't really made any changes to it you could just go watch my first Canary tokens video where I show you how to create a honey account inside of active directory to detect password spraying and curb roasting if you haven't watched that video you definitely should because I talk about how to use URL tokens DNS tokens for unintended things and maybe I guess unintended is a bad word because these are open-ended tokens so you can use them however you seem fit this video is going to be a lot less complex because they have a token that does exactly what we want and that is monitoring uh for suspicious Windows commands so I'm just going to do this sensitive command token and it can specify an email address for it to go to and then a reminder for when the token is triggered and I'll just say subscribe to ipsat because if you do subscribe to my channel it helps me a lot but the net last piece is just specifying the command we want to monitor so I'm going to do who am i.exe and click create my token and all we have to do is double click the registry file it gives us and it will monitor it for us however uh I like looking at exactly what it's going to do so let's open it up and see it creates three different registry keys the first one is going to be under image file execution options and it is the Who Am i.exe and the actual key name is global flag and the d word is 200 which I think resolves to 512. it's not really that important all that does is enable silent process exit for that process of who am I and what that enables us to do is create a monitor process for it so whenever it's ran we can also run a different program and this one's going to be cmd.exe C slash start slash Min powershell.exe so it's starting a command prompt that's minimized and then starting Powershell trying to hide the window and then running this command so the first thing it's going to do is stripped out I guess Bad characters and a username because this is using DNS tokens so it wants to make sure the um I guess username is under 64 characters and it doesn't have invalid characters for a domain the next thing it's going to do is the computer name and the username is setting it to you and then the computer name is sending it to C and after we set both of those variables it's going to run resolve DNS name and then do the computer name DOT UN dot the username dot CMD and then this is going to be our Canary token so this is how Canary tokens knows who it belongs to and who they should be emailing and that is it so if you want to know more about this exact process um they do have a really good blog post on this the sense of command token so much offense in my defense and it's a really good post and I really like the phrase like so much offense in my defense because the first time hearing about um the whole silent process exit this whole piece was in this blog post like four to five years ago where it's saying persistence using Global flags and image file execution it's pretty much the same exact thing except um instead of just executing a program to call back to a domain so we know that program was ran this is just a persistence technique right so I really like showing the Synergy between red team techniques and blue team techniques and how they can feed off of each other so Butler's blog posts are worth reading but enough of the describing let's just run this and see what happens so double clicking this clicking run and yeah I want to continue what can go wrong and then I'm going to look at my email there's nothing here we should be running CMD now and then do who am I and this is another thing we can see a window did pop up when I typed that we should get a email any minute now there it is saying that the command was ran and because this is using DNS tokens you can't really take this Source IP seriously but we see username administrator executed who am I on this host so the next thing I want to do is I'm going to do who am I slash priv I want to see if it actually gets the uh private piece of the token I don't think it does I'd be amazed if it does but this is showing more about um so much offense in my defense because who am I you may think that's a benign Command right but it's one of those commands no real domain use is going to run because they logged into the system as themselves so they know who they are the people that run who am I are going to be the people that are attacking the system and I wonder if when we run who am I do I have to have that exe slash priv because I didn't get an email let's see I'm waiting for it so I wonder if we put arguments in it doesn't actually go that wouldn't be great we're definitely resolving the DNS but I'm not getting any email there we go Canary token was triggered so I'm going to run who am I slash priv and then wait like a minute well the command prompt came so I'm guessing this is some built-in spam detection I'm sending too many emails and Canary token doesn't want to send me five emails for the same thing so I'm guessing there's some type of rate limiting in and it'll only send one email every minute maybe I don't know so we'll come back to that I'm pretty sure arguments work and we also don't have to put dot Exe on this command because we see that second box popping up when we type this command but again um where what I was saying before I'm not sure if I finished my train of thought is attackers will run who am I after they get on system to make sure they are who they think they are sometimes when they run like impact it's PS exec they don't know if their system or the user that they type credentials to so you run who am I or when they exploit a web server they do who am I slash priv to see if they have the SCM personate privilege that may enable them to run like a potato style exploit so this is one of those good commands to run and one of the important things for blue teams to understand the red team process because if you just asked a random blue team that has no offensive knowledge he won't know why who am I is a significant command but that's enough of that rant let's run this again because any rate limit should be over so let's give it five there we go we have the command and it just says who am I was in we don't get any extra details so maybe at the end of the video we will use a web token and get extra detail from this that sounds like a fun thing to do um but this is still very manual for installing if I had like 50 computers I want to install this on I'm not going to have a fun time double clicking this registry thing every time so let's chain this up and we'll go back to canarytokens.com so let's create a new token so we get a new DNS name and if we didn't do this it wouldn't be the end of the world if we just reuse the old um token however our email would be saying we got um who am I was in and not net so that would get confusing so I'm going to say thanks for subscribing if you didn't subscribe you definitely should now unless I'm a liar so let's create this token download the file and we'll come back to that file in a minute because we want to install this in group policy so it goes to all of our computers so I'm going to right click on a domain create a GPO call it Canary token and then let us edit this and go to user preferences Windows settings registry create a new registry item and we're going to select where who am I is so we can just edit it and change it to net because that'll be the quickest thing so hkey local machine software Microsoft Windows NT current version then the image file execution who am I and double click Global flag and we change this to just be Network who am I is click apply and now we got it there so let's repeat that for the other two keys so local machines software Microsoft Windows NT current version silent process exit who am I and you can't highlight multiple unfortunately so you have to do this twice let's start with reporting mode because we have to edit less and change who am I to net click apply and then new registry item and this will be the last one for this key software Microsoft Windows NT current version silent process exit and the monitor process and what we want to do is well first change this to be net and then update the command to be our new Canary token right so let's put that there open a new one go to the latest copy paste the new domain highlight and replace the command apply and now the group policy is created however um it's going to take a little bit of time for it to be populated on our machine I can refresh you can hear me you can see it nothing's happening if I do GP update slash Force it'll Force the group policy to update now and we can see net.exe magically got created additionally if we go to um instead of Silent process exit the image file execution options and look for net it is here as well so everything looks to be good let's check our email we have nothing so I'm going to do um net group local admins is it or net local admins or we're getting emails we do net user we get a list of all the users so um that is how you can deploy it through group policy if I click this we can see DNS uh net.exe was created so let's take this now to the next step and try doing a web token with this and um extracting extra information to see if we can oh we won't actually be able to get the arguments because this isn't going into um event log shoot so I think if we want to show that piece we'll probably have to use like sysmon or something like that and set up uh a scheduled task uh so sorry for teasing that early in the video I wasn't thinking I was thinking somehow we could pull the arguments for this command but we're dealing with um it just attaching on a program and not an actual event log so there's no way to actually get the um commands actually I just had a thought um if our process is running before the other process exits which I think it is because the purpose of this is like debugging the process we may be able to pull the um the process list and grab it that way so the easiest way to get arguments I know in Powershell is gwmi win32 process and we select command line right this should give us the um full command line of all running programs so we want to do where name is equal to net like this and it's going to give us nothing but I also will want to join all um well if I just run this let's do it against command cmd.exe first I wonder if I can do Dash like CMD star there we go so instead of Select we want to select ex expanded property because we don't want this little header and then if we have multiple things running so I'm going to start another CMD we'll want them on one line just to make it easier for us and I'm sure there's going to be ways we can optimize doing this but this will be a live thing I'm just experimenting as we go for the video um I probably want to put this in parentheses then I should be able to do a dash join let's see select expanded property command line like that is it just test drawing yep there we go so this will get us the processes that we want so our name is like we'll do net if I do V it's empty because we don't have any process running that is actually a good thing so you may want to do a name equals net.exe but for this ah yeah we'll do name equals net.exe it is cmd.exe right yes okay so now if we copy this let's just save it so we don't lose this we're going to want create a new Canary token so let's go here Canary tokens and this time I'm going to do web bug root at ipsec.rocks please sub s okay so we have this token so contact forms contact.php I'll do value is equal to V paste this semicolon okay so now let's go to our registry command uh let's go to the silent process exit net.exe and we will let's see actually I'm going to copy this paste so CMD start Min Powershell window command and then they do quotes like that and we'll have to escape we'll either Escape or change the ones on join we'll just change this there we go so if we replace our value with that I wonder what's going to happen when I run net users it ran hopefully this says the web token and we get that value we can just go to manage this token for the easy way and it has not been triggered do I have the right token on my clipboard where is that curl oh shoot um we did not put the curl in so we executed it but we do need to curl there we go monitor process paste so now let's run net users refresh has been triggered once and that's the memo I don't know where the value is not here um normally the value is let's just uh put it at the user agent that'd be the easiest thing to do so get rid of this and what if this value has to be specific things I thought we could just Jam any value in there but for some reason that did not work but user age is not important to us so we can just replace that and paste net users and it's also possible the value is blank and like it just didn't send right so let us go back to this token refresh we have two hits and the user agent is cmd.exe.net so let's fix that gwmi process net.exe third time is the charm right net users refresh this page there we go the user agent is blank so it does not look like this works unless we screwed something up but I'm guessing this is running after the process exits which sucks my great idea did not pan out V command well since we left it at cmd.exe we know it does run so we'll do like just in case it wasn't net.exe maybe the name was just net right so we can just do this since we know that works change the value net users okay refresh come on user agent it is not there so I'm not exactly sure how we can use this to extract the arguments because it's not ringing it to the event log which also means it's not um saved anywhere and since we're running this and the um Powershell process isn't pulling it up I'm not sure so that'll be the video hope you guys enjoyed the little extra tidbit even though it didn't work maybe you have an idea how to get that to work so take care guys and I'll see you all next week or next time I don't want to do another video