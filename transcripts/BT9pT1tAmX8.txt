 what's going on youtube this is ipsec and this video is gonna be about combining canary tokens with active directory honeypot accounts so whenever someone tries to perform a password spray against your domain against all administrators you'll get an email because they'll try to log into your honeypot account or even better we're going to set it up in a way where it's kerberostable so if someone ever tries to extract the tickets so they can try to crack it you'll get an email before they can open up hashcat and we're going to do all of this with the little known feature of schedule tasks that can be created to fire upon a specific event log entry so it's a very low maintenance thing to do and i wouldn't do it on a large company because large companies should have like splunk elastic or some other centralized logging that you can put some type of alert in there this is more targeted towards the small companies that don't want to do a lot of logging they don't want any overhead because honeypots themselves are a great way to detect people without high false positives so with that being said let's just jump in so here we have just a normal windows domain um before we get into actually creating a honey account and event filter let's talk about canary tokens for a couple minutes because that's going to be the heart of this video now you can run your own canary token service but when you do chances are it's going to crash and you won't know it and because the way i use honey pots i don't get constant like notifications hopefully if i'm not lucky it's once a year if that these things are really never supposed to be triggered so when you don't get those alerts constantly you never know if the service is working or not and you'll just forget about it right so when you use someone else's infrastructure it helps guarantee it's going to be working for those things that don't notify you that much um i just use the free option on canary tokens because it does everything i need i think there is a paid version that gives you more types of tokens in addition it gives it probably a way to better manage the tokens but really you can hack away with the web token and dns token to do anything you want um for instance like the sensitive command token this is going to create a registry file that makes a computer perform a dns request when a certain command is ran like we can type who mi.exe and whenever who am i is ran it will send a dns request and we'll get a notification via email now the special thing about this token is they also um add in data to the dns request i think it's like base 32 encoded so it will like say what username and what computer the command came from um but you can hack away with the web token this just gives you a url if you put parameters on that url you can add things to the alert so in the instance of this which is a honey account the login failure would trigger it and we could also append data like the computer it came from because that's in the event log but um i'm not going to do that because it's going to be extra complexity to actually parse the event in addition i don't like my domain controllers being on the internet to begin with so i just do dns tokens so let's see how this works we add an email and then we just add a reminder when this one was triggered so i'm going to call this honey account and we create the token we get the dns name and we can see i don't have an email if i do a ns lookup paste in the canary token we get a response and we should have an email right now that just says it was triggered the downside to dns tokens is the source ip is not going to be the ip that triggered it just because how dns works so this is going to be a dns server's ip not my personal ip so um that's about all we need to know from honey tokens so we just copy this put in a notepad and it will become relevant in a little bit so the next thing is we need to open up tasks as scheduler and see exactly how this operates and i normally don't start off in task scheduler because it's just a pain to use you'll see what i mean in a minute but we put a computer in i'm doing it on the domain controller we can create a task call it something so honey account monitor we want to run whether the user is logged in or not and because we monitor the event log we need run with highest privilege and then the trigger this is where the magic comes in because most people when they think of schedule task they think it's like chronic goes on a schedule but you can do it upon many events like task creations but what we want is on an event and now if we just did basic i mean it doesn't really give us that much information i can't imagine much of a use case for this if we do custom we can do a new event filter and it's going to give us a gui that's over complicated and doesn't give us a lot of customizations it takes a while once you click new event filter for it to do something we can see it's not responding now i don't know why this is the slowest process ever but um it is man it is still waiting it only doesn't take this long there we go so this isn't that great i mean we could select sources so this is a bit better than before because we have like keywords and things like that but this isn't like um we gotta do security event let's say 4625 which i think is account login failure we can do the keyword a failure but the user this isn't going to be the actual user of like the login request so this doesn't help us we want to do xml and edit the query manually and this is very very intimidating right let's just paste this query in so we can look at it i guess we can make this bigger um it's all like i think xpath syntax and if you just look at this it's easy to give up quickly but let's open up event viewer real quick so i don't know why i cancelled that but oh well so let's go to event viewer and we can connect to dc01 uh where did that go there we go security and let's create a login failure we got a lot of login requests right but let's create a login failure so run as slash user um administrator at hyrule which is my domain cmd put in a bad password refresh this we should have got a failure wonder if failures aren't logged by default account was logged off that's bizarre put in a bad password huh see did not expect this uh gpmc let's create a um thing to make sure this is logged default domain controller domain controller policy let's edit you window settings security [Music] then local policies i think audit login events success and failure account i think it's just account so we do powershell so we can invoke command computer name dc01 script block gp update slash force and that should tell our domain controller to pull the new policy that hopefully is auditing account logon events takes a minute to run maybe longer than a minute there we go run as user administrator at hyrule ipsec rocks cmd password is incorrect and i guess we got a kerberos account failure so there is that i bet if we did event viewer on localhost this would be where the 4624 is um let's open up another one windows logs security so whenever we create a honey token thing we have to monitor probably two events we want 47.71 for failure in kerberos and also this one which is the 4625 if i'm saying 40 24 that's um account success or login success so we want to create an event filter for this so i'm going to click on details because this lets us go to the xml view which makes our syntax much easier to write um so let's see i'm going to erase this because that's not like useful and all we do is put a star and then the very first parameter so we want event id first right so the first parameter is going to be system i can't highlight but you see me clicking so let's do system then just the event id and that was uh 4771 i want to say let's double check event log event id 4771 so i think this is correct the only thing i don't know is if we have to put this in parentheses or not but essentially every field in xml we're just going down with brackets i guess so once you do it enough it somewhat makes sense so the thing i like about the event viewer is we can just create a custom view and test this out before going to the schedule task thing so we paste this in uh we'll call it like honey account and we get the one login failure so now we know if we created this it would work well it would notify us on every single login failure so we'd probably get spammed and this honeypot thing wouldn't work that well we want to create it upon a certain user now so let's create a user let's do net user slash domain slash add we'll call it minnow and do a super complex password like that long in the 14 characters sure uh password policy really some capital some symbols some numbers so now we have an account called minna added so if we go back to our query we're going to create a new line and then do the bracket and this one's no longer under the system the field we want is under event data like we don't need this system here we want data and we got another field data so we'll do event data because that's the first field then data is equal to um let's just start out with administrator because mine doesn't have any login failures yet and if we copy this actually we forgot the and because these are two boolean things so we join up with the and go back to event log let's filter this paste we still just have one now the issue is going to be if we chose a generic user and this exists anywhere in the log because we don't have it filtering upon like target username and administrator we could fix that up i think if we did let's see event data data like that so now we're going inside of the data fields and we do at name is equal to target user name like that and then because we're already in data when we escape out of this bracket we just do equals administrator i think i think that's valid we'll see and this is one of the gotchas if you google it it's going to say and it's going to do like an and data equals administrator but that is the wrong way to do this so let's go in here filter like this whoops that was wrong data get rid of data there we go paste and we have it so let's go to notepad get rid of this so the last thing i want to do is just make sure we are really filtering upon target username because again every example i saw online did this and data is equal and what that did is make sure that this field exists and then if anything was called data or administrator so this is what we want and if we did target sid which is another field that exists we're not but the field exists but our username is not going to be there right so let's filter paste we get nothing and let's see can i find event log monitoring or xml windows is it going to come up right away xml data i just want to show you the one post i don't know event log filter this i think they talk about doing let's see data i can't find it it's not worth it but um if we did target sid like this and data equals administrator this query is going to come back because target sid is in the event it's just not valid to administrator right yeah so target sid's value is actually this so it's just making sure the target said exist and one of the fields has administrator um so if you ever go to google make sure you do it this way if you want to be as specific as possible right so we get this let's just make sure the target user name make sure this is good that was a long tangent over something that probably didn't need to but that's what happens when you do this live right so that's valid we just want to change it to be midna now so let's filter change this from administrator to minnow which is going to be our honey account and we don't get any hits because it doesn't have any failures yet so let's go back to our run as command do midna put in a password refresh this and we have it so there's one last thing i want to do before we go into the event is monitor both 46 25 i think it is and the this one so let's go back into notepad fix this and let's do a or here system event id is equal to 4624 like that i think we put this in parentheses that makes sense so let's see what happens here filter paste awesome so i bet if i opened up a local event viewer so let's open up event viewer again and paste it we'll also see the login failure so custom views honey account filter like this and we get it so we got two things in the account name that was failed is midna from the account administrator and these are 4624s so we know our filter picks up both 46 24 and 47.71 so we can go back to the schedule task and now we can create the task and we'll call that honey account again we want to run whether users logged in or not with highest privilege new on an event custom new event filter wait for this to come it takes a while xml edit paste we need an action so new start a program uh let's do nslookup and then go back to our notepad we have the canary and paste this in and then we have to put our password in and now we have this task so task has not been ran we're going to do administrator first put in a bad password task has not been ran which is good we want to make sure we don't send false positives now i can do midna the honeypot account and task is running task has been completed we go back here and we just got an email with a new trigger so everything is working now um there are a few other things we can do to make this more like um appealing to an attacker right so the first is if we go active directory users and computers we can make him a member of administrator so member of domain administrators um administrators there we go that'll be fine so now we'll be able to administer the domain the other thing i like doing which can tip off an attacker is setting the login hours for honeypot accounts so if we do a run as we do this it's just username password is incorrect now i never want my honeypot to get like abused so we can deny all logins but when you do this now the error message on an invalid password is also account restriction so it kind of tips off the attacker that a honeypot may exist but i still like doing this because even though an attacker knows a honeypot exists they may avoid it they're going to slow down their operation tremendously because they start second-guessing themselves a lot so you want them to know these type of honey pots and deception technology does exist because it's going to make them slow down the other thing that we could do is make it so this account is kerberostable and then if they ever request a ticket to send us an email so to do that we go into command prompt and do set spn dash a to add it the user is going to be midna and the host name i will do dc01.hyrule.ipsec dot rocks the domain name and then the port um it's me so i'm going to do port 9001 the username this gets applied to is minna so now it's going to create that spn so now if i go over into um my attack box we can do a was it get user spn and then i think it's domain so um what is it hyrule ipsec rocks and then slash the username for login i think this is it yep so here we can see the ticket exist if we do dash request or lowercase or actually get the ticket now there's going to be no logs of this happening at first because this isn't logged by default to my knowledge so we'll find out real quick and i'm going to find out a lazy way so let's go back to the event viewer on the dc i'm going to filter the custom view i'm going to take out this event code data and then i'm also going to take out this so we're just looking at any field that contains midna so let's see oh did it get created this may be it uh 4768 or 69. i believe this is it so i think it did get logged 47.69 is that now default let's do it a few times so if at first it doesn't have well if first you succeed try try and try again to make sure it's valid i guess so there's two so now we have a few requests so do we have multiple we do so anytime this kerberos thing is happening now we're getting a notification and this one is service name so if i wanted to to go well first we can say or system id i bet we could have done it here or event id equals 4624 or event id is equal to so this is probably the better way to do multiple event codes uh four seven six nine and target username is equal to minnow and this is where we can do the or or yeah we'll go super specific i don't know what way is better so we can say or the data field let's see this is service name service name is equal to midna so i think this query is exactly what we want so honey account filter paste and there we have it so now whenever a kerberos operation happens we'll get notified well we don't not yet we have to create this or edit our task so properties triggers custom event filter edit this is such a painful thing to do every time there's one last gotcha after we do this is the domain control logs i don't believe get replicated immediately well i don't think they ever get replicated so like this login failure may only appear on the main controller that the computer went to so we will want to export the event and then add this to all other domain controllers we can probably do it through group policy or you can just open up task scheduler connect to the dc's if you don't have that many remember if you're a big organization with like 20 dc's you should be using splunk elastic or some type of log management and doing an alert that way if you only have like two dc's i mean it's not that big of a pain to go import tasks click honey account and then we'll probably have to take the password again and now we have the account honey account task on this computer as well so if we ever try to use that midna account we should get emailed so we have another canary token probably me failing to log in but i'm going to do this again so p at my password which was password1 but look back here and immediately we have an email from our honey account someone retrieving that um ticket so hope you guys have enjoyed this video take care and i will see you all next time